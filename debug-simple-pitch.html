<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔧 Simple Pitch Training Debug</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
        }
        .log {
            background: #001100;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            color: #f00;
        }
        .warning {
            color: #fa0;
        }
        .info {
            color: #0ff;
        }
        .success {
            color: #0f0;
        }
        button {
            background: #333;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <h1>🔧 Simple Pitch Training Debug Console</h1>
    
    <div>
        <button onclick="testMicrophoneManager()">🎤 Test MicrophoneManager</button>
        <button onclick="testPitchDetector()">🎵 Test PitchDetector</button>
        <button onclick="testNoiseReduction()">🔊 Test NoiseReduction</button>
        <button onclick="clearLogs()">🧹 Clear Logs</button>
    </div>
    
    <div id="logs" class="log"></div>
    
    <script>
        // ログ出力システム
        const logDiv = document.getElementById('logs');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            const div = document.createElement('div');
            div.className = type;
            div.textContent = logEntry;
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // 元のコンソールにも出力
            if (type === 'error') {
                originalError(message);
            } else if (type === 'warning') {
                originalWarn(message);
            } else {
                originalLog(message);
            }
        }
        
        // コンソールをハイジャック
        console.log = (...args) => addLog(args.join(' '), 'info');
        console.error = (...args) => addLog(args.join(' '), 'error');
        console.warn = (...args) => addLog(args.join(' '), 'warning');
        
        function clearLogs() {
            logDiv.innerHTML = '';
        }
        
        // テスト関数
        async function testMicrophoneManager() {
            addLog('🎤 MicrophoneManager テスト開始', 'info');
            
            try {
                // MicrophoneManagerクラスの存在確認
                if (typeof MicrophoneManager === 'undefined') {
                    addLog('❌ MicrophoneManager クラスが見つかりません', 'error');
                    return;
                }
                
                const mic = new MicrophoneManager();
                addLog('✅ MicrophoneManager インスタンス作成完了', 'success');
                
                // 初期状態確認
                addLog(`🔍 noiseReduction.enabled: ${mic.noiseReduction.enabled}`, 'info');
                addLog(`🔍 isActive: ${mic.isActive}`, 'info');
                
                // マイク許可をリクエスト
                addLog('📞 マイク許可リクエスト開始', 'info');
                await mic.requestAccess();
                addLog('✅ マイク許可完了', 'success');
                
                // フィルター状態確認
                addLog(`🔍 highPassFilter: ${!!mic.noiseReduction.highPassFilter}`, 'info');
                addLog(`🔍 lowPassFilter: ${!!mic.noiseReduction.lowPassFilter}`, 'info');
                addLog(`🔍 notchFilter: ${!!mic.noiseReduction.notchFilter}`, 'info');
                addLog(`🔍 gainNode: ${!!mic.noiseReduction.gainNode}`, 'info');
                
                // AudioContext状態確認
                addLog(`🔍 audioContext.state: ${mic.audioContext.state}`, 'info');
                addLog(`🔍 audioContext.sampleRate: ${mic.audioContext.sampleRate}`, 'info');
                
                // 停止
                setTimeout(() => {
                    mic.stop();
                    addLog('🛑 マイク停止完了', 'info');
                }, 3000);
                
            } catch (error) {
                addLog(`❌ MicrophoneManager テストエラー: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
        
        async function testPitchDetector() {
            addLog('🎵 PitchDetector テスト開始', 'info');
            
            try {
                if (typeof PitchDetectionManager === 'undefined') {
                    addLog('❌ PitchDetectionManager クラスが見つかりません', 'error');
                    return;
                }
                
                const detector = new PitchDetectionManager();
                addLog('✅ PitchDetectionManager インスタンス作成完了', 'success');
                
                // AudioContext作成
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                addLog('✅ AudioContext作成完了', 'success');
                
                // 初期化
                await detector.initialize(audioContext);
                addLog('✅ PitchDetector 初期化完了', 'success');
                
                // テスト用ダミーデータ
                const testData = new Float32Array(2048);
                for (let i = 0; i < testData.length; i++) {
                    testData[i] = Math.sin(2 * Math.PI * 440 * i / 48000) * 0.5;
                }
                
                const pitch = detector.detectPitch(testData);
                addLog(`🎯 テスト音程検出結果: ${pitch ? pitch.toFixed(2) + 'Hz' : 'null'}`, 'info');
                
                audioContext.close();
                
            } catch (error) {
                addLog(`❌ PitchDetector テストエラー: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
        
        async function testNoiseReduction() {
            addLog('🔊 NoiseReduction テスト開始', 'info');
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                addLog('✅ AudioContext作成完了', 'success');
                
                // ノイズリダクションフィルター手動作成
                const highPassFilter = audioContext.createBiquadFilter();
                highPassFilter.type = 'highpass';
                highPassFilter.frequency.setValueAtTime(80, audioContext.currentTime);
                highPassFilter.Q.setValueAtTime(0.7, audioContext.currentTime);
                addLog('✅ HighPassFilter作成完了', 'success');
                
                const lowPassFilter = audioContext.createBiquadFilter();
                lowPassFilter.type = 'lowpass';
                lowPassFilter.frequency.setValueAtTime(2000, audioContext.currentTime);
                lowPassFilter.Q.setValueAtTime(0.7, audioContext.currentTime);
                addLog('✅ LowPassFilter作成完了', 'success');
                
                const notchFilter = audioContext.createBiquadFilter();
                notchFilter.type = 'notch';
                notchFilter.frequency.setValueAtTime(60, audioContext.currentTime);
                notchFilter.Q.setValueAtTime(30, audioContext.currentTime);
                addLog('✅ NotchFilter作成完了', 'success');
                
                const gainNode = audioContext.createGain();
                gainNode.gain.setValueAtTime(1.2, audioContext.currentTime);
                addLog('✅ GainNode作成完了', 'success');
                
                // アナライザー作成
                const analyzer = audioContext.createAnalyser();
                analyzer.fftSize = 2048;
                analyzer.smoothingTimeConstant = 0.3;
                addLog('✅ Analyzer作成完了', 'success');
                
                // フィルターチェーン接続テスト
                const oscillator = audioContext.createOscillator();
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                
                // チェーン接続
                oscillator.connect(highPassFilter);
                highPassFilter.connect(lowPassFilter);
                lowPassFilter.connect(notchFilter);
                notchFilter.connect(gainNode);
                gainNode.connect(analyzer);
                analyzer.connect(audioContext.destination);
                
                addLog('✅ フィルターチェーン接続完了', 'success');
                
                // 短時間テスト音再生
                oscillator.start();
                setTimeout(() => {
                    oscillator.stop();
                    addLog('🔊 テスト音再生完了', 'info');
                }, 500);
                
                setTimeout(() => {
                    audioContext.close();
                    addLog('🛑 AudioContext終了', 'info');
                }, 1000);
                
            } catch (error) {
                addLog(`❌ NoiseReduction テストエラー: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
        
        // 自動でライブラリを読み込み
        async function loadLibraries() {
            addLog('📚 ライブラリ読み込み開始', 'info');
            
            try {
                // Tone.js読み込み
                const toneScript = document.createElement('script');
                toneScript.src = 'tone.js';
                document.head.appendChild(toneScript);
                
                await new Promise((resolve, reject) => {
                    toneScript.onload = resolve;
                    toneScript.onerror = reject;
                });
                addLog('✅ Tone.js読み込み完了', 'success');
                
                // Pitchy読み込み
                const { PitchDetector } = await import("https://esm.sh/pitchy@4");
                window.PitchDetector = PitchDetector;
                addLog('✅ Pitchy読み込み完了', 'success');
                
                // メインスクリプト読み込み
                const mainScript = document.createElement('script');
                mainScript.src = 'simple-pitch-training.js';
                document.head.appendChild(mainScript);
                
                await new Promise((resolve, reject) => {
                    mainScript.onload = resolve;
                    mainScript.onerror = reject;
                });
                addLog('✅ simple-pitch-training.js読み込み完了', 'success');
                
            } catch (error) {
                addLog(`❌ ライブラリ読み込みエラー: ${error.message}`, 'error');
            }
        }
        
        // 初期化
        document.addEventListener('DOMContentLoaded', loadLibraries);
    </script>
</body>
</html>