# 相対音感トレーニングアプリ - マイク機能仕様書

**版数**: v1.0  
**作成日**: 2025-07-13  
**対象ブランチ**: mode-selection-interface  

---

## 1. 概要

相対音感トレーニングアプリにおけるマイク機能の動作仕様。音声入力による周波数検出とリアルタイム状態表示を提供する。

## 2. マイク状態管理

### 2.1 状態定義
| 状態 | 値 | 説明 | アイコン表示 |
|------|-----|------|-------------|
| OFF | `'off'` | マイク停止状態 | なし（非表示） |
| ON | `'on'` | マイク動作中・待機状態 | 🎙️ |
| 録音中 | `'recording'` | 音声検知中 | 🎙️ |
| 一時停止 | `'paused'` | 基音再生中の一時停止 | 🎙️ |

### 2.2 管理プロパティ
- **変数名**: `this.microphoneState`
- **初期値**: `'off'`
- **更新タイミング**: 各マイク制御メソッド実行時

## 3. 状態表示仕様

### 3.1 表示位置・形式
- **配置**: 周波数表示の右側
- **形式**: `[周波数] Hz[間隔][アイコン]`
- **例**: `262 Hz    🎙️`

### 3.2 スタイル仕様
| 項目 | PC版 | モバイル版 |
|------|------|-----------|
| アイコン間隔 | `margin-left: 15px` | `margin-left: 15px` |
| アイコンサイズ | `font-size: 0.8em` | `font-size: 0.8em` |
| 表示方法 | `innerHTML` | `innerHTML` |

## 4. 状態遷移フロー

### 4.1 アプリケーション起動
```
初期状態 → microphoneState = 'off'
表示: --- Hz
```

### 4.2 トレーニング開始
```
スタートボタン押下
├─ initMicrophone() → microphoneState = 'on'
├─ 基音再生開始 → pauseMicrophone() → microphoneState = 'paused'
├─ 基音再生完了 → resumeMicrophone() → microphoneState = 'on'
└─ 音声検知時 → microphoneState = 'recording' (動的更新)
```

### 4.3 トレーニング完了
```
全音程完了 → stopMicrophone() → microphoneState = 'off'
表示: --- Hz
```

### 4.4 再開始操作
```
「もう一回」「次の音」ボタン押下
├─ stopMicrophone() → microphoneState = 'off'
├─ 表示: --- Hz
└─ 新セッション開始は手動スタートボタンから
```

## 5. 技術実装

### 5.1 主要メソッド
| メソッド名 | 機能 | 状態更新 | 備考 |
|-----------|------|----------|------|
| `initMicrophone()` | マイク初期化 | `→ 'on'` | getUserMedia実行 |
| `pauseMicrophone()` | 一時停止 | `→ 'paused'` | ストリーム保持 |
| `resumeMicrophone()` | 再開 | `→ 'on'` | 検出ループ再開 |
| `stopMicrophone()` | 完全停止 | `→ 'off'` | リソース解放+表示更新 |

### 5.2 状態表示更新
| 更新タイミング | 方法 | トリガー |
|---------------|------|----------|
| リアルタイム | 検出ループ内で動的更新 | `frequency > 0 && volume > 1` |
| 強制更新 | `updateFrequencyDisplay(0, 0)` | `stopMicrophone()`実行時 |

### 5.3 アイコン制御
```javascript
getMicrophoneStateIcon() {
    switch (this.microphoneState) {
        case 'off': return '';           // 非表示
        case 'on':
        case 'recording':
        case 'paused': return '🎙️';     // 同一アイコン
        default: return '';
    }
}
```

## 6. ノイズリダクション仕様

### 6.1 フィルタリング
| フィルター | 種類 | 設定値 | 用途 |
|-----------|------|--------|------|
| ハイパス | `highpass` | 80Hz以下カット | エアコン・ファンノイズ除去 |
| ローパス | `lowpass` | 2kHz以上カット | 高周波ノイズ除去 |
| ノッチ | `notch` | 60Hz除去 | 電源ノイズ除去 |

### 6.2 音声判定
- **音量閾値**: `volume > 1`
- **周波数範囲**: 検出された周波数 > 0
- **判定条件**: `frequency > 0 && volume > 1`

## 7. 修正履歴

### 7.1 v1.0での主要修正
| 問題 | 修正内容 | コミット |
|------|----------|----------|
| 再開始時マイク残存 | `directRestart()`でマイク完全停止追加 | 942ca6d |
| アイコン表示残存 | `stopMicrophone()`で表示強制更新追加 | 942ca6d |
| HTML間隔問題 | スペースからCSS `margin-left`に変更 | 0163a62 |

### 7.2 既知の制限事項
- 古いブラウザでの🎙️アイコン表示対応（Unicode 7.0以降必須）
- マイクアクセス拒否時のエラーハンドリング
- バックグラウンド時の自動停止機能（未実装）

## 8. テスト仕様

### 8.1 基本動作テスト
- [ ] アプリ起動時: マイクOFF状態、アイコン非表示
- [ ] スタート押下: マイクON、アイコン表示
- [ ] 音声検知: 録音状態への遷移
- [ ] 再開始ボタン: マイクOFF、アイコン非表示

### 8.2 表示テスト
- [ ] PC版: 適切な間隔とサイズでアイコン表示
- [ ] モバイル版: 同様の表示品質
- [ ] 4桁周波数: 改行なしで正常表示

---

**文書管理**
- 最終更新: 2025-07-13
- 更新者: Claude Code
- レビュー: 必要時更新