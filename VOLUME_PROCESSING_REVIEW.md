# 音量処理レビュー・修正方針文書

## 📋 文書概要

**作成日**: 2025-07-21  
**対象**: Step 2 プラットフォーム適応型音量処理のレビュー結果  
**目的**: 音量処理の課題分析と今後の修正方針策定

---

## 🔍 Step 2 レビュー結果

### 実装内容（Step 2で行った修正）
```typescript
// プラットフォーム適応型音量処理
const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
const volumeConfig = {
  divisor: isIOS ? 2.0 : 4.0,           // iPhone: 小さい除数、PC: 大きい除数
  noiseThreshold: isIOS ? 8 : 15        // iPhone: 低閾値、PC: 高閾値
};
```

### 発見された問題
1. **PCでノイズがほぼない環境でも20-30%表示**
2. **iPhone環境でも同様の問題発生**
3. **ノイズリダクション機能が期待通りに機能していない**

### 重要な課題認識
- **横棒グラフ描画ロジック**と**ノイズリダクション機能**の分離が必要
- 現在の実装では両者が混在し、問題の根本原因が不明確

---

## 🔧 音量処理の課題分析

### 現在の音量処理フロー
```
音声入力 → RMS計算 → スケーリング(除数) → ノイズ閾値適用 → 表示
```

### 問題点の詳細分析

#### 1. 横棒グラフ描画ロジックの問題
- **現象**: 無音環境でも20-30%の表示
- **推定原因**: 
  - 除数設定が適切でない可能性
  - 基本音量計算（RMS）に問題がある可能性
  - スムージング処理による底上げ

#### 2. ノイズリダクション機能の問題
- **現象**: 閾値設定が機能していない
- **推定原因**:
  - 閾値適用のタイミングが不適切
  - 閾値判定後の処理に問題
  - プラットフォーム別閾値が実環境に合っていない

#### 3. 機能分離の必要性
- **表示用音量**: ユーザーが見るグラフの値（0-100%）
- **判定用音量**: トレーニングボタン活性化の判定
- **ノイズフロア**: 環境ノイズの除去

---

## 🎯 修正方針

### Phase 1: 軽微な修正の完了（優先実施）
1. **Step 3**: iPhone ピアノ音量増強
   - `volume: 0 → 3dB`
   - `velocity: 0.7 → 0.9`
   - **影響範囲**: 限定的、テスト容易

2. **Step 4**: UI改善
   - ボタン文言変更
   - 動的メッセージ削除
   - **影響範囲**: 視覚的のみ

### Phase 2: 音量処理の根本見直し（Phase 1完了後）

#### Step 2-1: 機能分離の実装
```typescript
// 分離後の構造案
interface VolumeProcessing {
  // 表示用: グラフに表示する音量（常に表示）
  displayVolume: number;      // 0-100%
  
  // 判定用: ボタン活性化に使用する音量（ノイズフロア適用済み）
  effectiveVolume: number;    // 0-100%（ノイズ以下は0）
  
  // デバッグ用: 生の音量データ
  rawVolume: number;          // フィルタリング前の値
}
```

#### Step 2-2: 段階的な調整とテスト
1. **表示ロジックの調整**: グラフ表示の正確性確保
2. **ノイズ閾値の再調整**: 実環境での測定に基づく
3. **プラットフォーム別最適化**: 実測データに基づく微調整

#### Step 2-3: 検証項目
- **PC無音環境**: 表示0%、判定無効
- **PC通常発声**: 表示60%以上、判定有効
- **iPhone無音環境**: 表示0%、判定無効
- **iPhone通常発声**: 表示60%以上、判定有効

---

## 📊 実装スケジュール

### 即座実施（Phase 1）
- ✅ Step 1: 調査記録作成（完了）
- 🔄 Step 3: iPhone ピアノ音量増強
- 🔄 Step 4: UI改善

### 詳細分析後実施（Phase 2）
- 🔄 Step 2-1: 音量処理機能分離
- 🔄 Step 2-2: 段階的調整・テスト
- 🔄 Step 2-3: 最終検証

---

## 🚨 重要な注意事項

### 1. 段階的修正の厳守
- Phase 1完了後にPhase 2に着手
- Step 2の修正は複雑なため、他の修正完了後に集中して実施

### 2. テスト環境の考慮
- PC環境（ノイズ特性）とiPhone環境（感度特性）の違い
- 実環境でのテストが重要

### 3. 機能分離の重要性
- 表示機能と判定機能を明確に分離
- デバッグ機能の充実化

---

## 📝 参考資料

- `VOLUME_LEVEL_INVESTIGATION.md`: 初期調査結果
- `src/hooks/useMicrophoneManager.ts`: 現在の実装
- `src/app/test/pitchy-clean/page.tsx`: 参考実装

---

**作成者**: Claude Code Assistant  
**更新予定**: Phase 2実施時に詳細分析結果を追記

この文書は音量処理問題の解決過程を記録し、段階的修正の指針とします。