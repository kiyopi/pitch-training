# 相対音感トレーニングアプリ - アプリケーション仕様書

**バージョン**: 1.1.0  
**作成日**: 2025-08-06  
**更新日**: 2025-08-07  
**用途**: アプリ概要・画面遷移・機能仕様（実装言語非依存）

**v1.1.0 更新内容**:
- モバイル・PC両対応のUIレイアウト設計
- 統合進行バー + タイミングガイドシステム
- 基音ボタン → 進行バー → ドレミガイドの連携仕様

---

## 🚨 最重要設計原則

### 🔒 相対音感トレーニングの根幹原則
**トレーニング中の基音音程表記は完全禁止**

#### なぜこの原則が最重要なのか
相対音感とは「基準音に対する他の音の相対的な関係を認識する能力」です。  
もし基音の音程名（C3, D4等）や周波数を表示してしまうと、ユーザーは絶対音感に依存してしまい、相対音感の向上に繋がりません。

#### 絶対禁止項目（トレーニング画面）
- ❌ 基音の音名表示（C3, D4, E♭3 等）
- ❌ 基音の周波数表示（261.63 Hz 等）
- ❌ 検出音程の音名表示（「現在: C4」等）
- ❌ 検出音程の周波数表示
- ❌ 音程差の表示（「基音より+5¢」等）
- ❌ 「正解」「不正解」のリアルタイム表示

#### 許可される表示（トレーニング画面）
- ✅ 「基音」ラベルのみ
- ✅ 相対音程（ドレミファソラシド）
- ✅ 音量レベルメーター
- ✅ 進行状況（●○○○○○○○）
- ✅ セッション番号

#### 例外：マイクテストページのみ
**マイクテストページは調整目的のため例外**
- ✅ 周波数表示 OK（マイク調整用）
- ✅ 音名表示 OK（発声確認用）
- ✅ 「ドを発声してください」指示 OK

---

## 1. アプリケーション概要

### 1.1 アプリの目的
**相対音感トレーニングアプリ**は、音楽学習者が相対音感（基準音に対する音程の関係を聞き分ける能力）を効果的に鍛えるためのWebアプリケーションです。

### 1.2 主な特徴
- 🎵 **基音からの相対音程トレーニング**: ランダムな基音を基準に8音階を歌う練習
- 🎤 **リアルタイム音程検出**: マイクで歌声を検出し、正確性を即座に判定
- 📊 **詳細な評価システム**: 音程の正確さを分析し、改善点を提示
- 🔄 **3つのトレーニングモード**: 初級から上級まで段階的な学習

### 1.3 対象ユーザー
- 音楽を学習している初級〜中級者
- カラオケや合唱で音程を正確に取りたい方
- 相対音感を身に付けたい音楽愛好家

---

## 2. 画面構成と遷移フロー

### 2.1 画面遷移図
```
┌─────────────────┐
│  ホームページ   │
│  (モード選択)   │
└────────┬────────┘
         │
    ┌────┴────┐
    ↓         ↓
┌───────────────────────┐
│   マイクテストページ   │
│  (マイク許可・確認)    │
└───────────┬───────────┘
            │
     ┌──────┼──────┐
     ↓      ↓      ↓
┌─────────┐┌─────────┐┌─────────┐
│ランダム │ │ 連続    │ │12音階   │
│基音     │ │チャレ   │ │モード   │
│モード   │ │ンジ     │ │         │
└─────────┘└─────────┘└─────────┘
```

### 2.2 各画面の詳細

#### 2.2.1 ホームページ
**URL**: `/`

**画面要素**:
- アプリタイトル「相対音感トレーニング」
- 3つのモード選択カード
  - 🎲 ランダム基音モード（初級）
  - 🔄 連続チャレンジモード（中級）
  - 🎹 12音階モード（上級）
- 各モードの説明文
- 「始める」ボタン

**機能**:
- モード選択後、マイクテストページへ遷移
- 選択したモード情報を次画面へ引き継ぎ

#### 2.2.2 マイクテストページ（トレーニング前準備）
**URL**: `/microphone-test`

**画面の役割**:
単なるマイク確認ではなく、**トレーニング前の重要な準備段階**として機能します。
ユーザーの声の特性を把握し、最適なトレーニング環境を整えます。

**画面要素**:
- 「トレーニング前の準備」タイトル
- マイク許可ボタン
- リアルタイム周波数表示エリア
- 音量レベルメーター（視覚的フィードバック）
- 音量調整ガイド（適切な音量範囲の表示）
- 「ドを発声してください」の指示文
- 音域確認表示（検出された音域）
- トレーニング開始ボタン（準備完了後に有効化）

**準備機能の詳細**:
1. **発声練習**
   - ドの音を安定して出せるか確認
   - 声の安定性をチェック

2. **音域確認**
   - ユーザーの快適な音域を検出
   - 高音・低音の限界を把握
   - トレーニングに適した基音選択の参考データ収集

3. **マイク感度調整**
   - 周囲の雑音レベル確認
   - 最適な音量レベルの設定
   - ノイズフィルターの調整

4. **音量調整**
   - 声が小さすぎず、大きすぎない適切なレベルに調整
   - 視覚的なフィードバックで最適範囲を提示

**なぜこの準備が必要か**:
- **トレーニングの精度向上**: 事前に声の特性を把握することで、より正確な判定が可能
- **音域に合わせた基音選択**: ユーザーが無理なく歌える範囲で基音を提供
- **快適な練習環境の確立**: 適切な音量設定により、長時間の練習でも疲れにくい

**画面遷移の流れ**:
```
1. マイク許可ボタンクリック
   ↓
2. ブラウザのマイク許可ダイアログ
   ↓
3. 許可後、リアルタイム表示開始
   ↓
4. 音量調整ガイダンスに従って調整
   ↓
5. ドを発声して音域確認
   ↓
6. 準備完了でボタン有効化
   ↓
7. トレーニング開始ボタンクリック
   ↓
8. 選択したモードのページへ遷移
```

---

## 3. トレーニングモード仕様

### 3.1 ランダム基音モード（初級）
**URL**: `/training/random`

#### モードの目的と特徴
- **対象**: 相対音感トレーニング初心者
- **目的**: カラオケなどで音程を合わせて歌えるようになる
- **学習効果**: 歌唱力向上、コミュニケーション能力の向上

#### なぜランダム基音なのか
相対音感を鍛えるためには、**基音の規則性から音を推測できないようにする**必要があります。
もしユーザーが何の音が出るか予測できてしまうと、それは絶対音感のトレーニングになってしまいます。

#### モバイル版UIレイアウト（縦積み配置）
```
┌─────────────────────────────────┐
│         セッション 1/1          │
├─────────────────────────────────┤
│           🎵 基音               │ ← 1. 基音エリア
│       [🔊 基音スタート]         │
├─────────────────────────────────┤
│ 基音再生(2.0秒) │休憩│🎯開始     │ ← 2. 統合進行バー
│ ████████▒▒▒▒▒▒▒█▒█            │    区間別タイミング表示
│ ↑現在位置      ↑ ↑             │    🎯がガイド開始ポイント
│               0.5秒 ガイド開始   │
├─────────────────────────────────┤
│    ┌─────────────────────┐      │ ← 3. ドレミガイド
│    │ ○○○○○○○○           │      │    進行バーと連携
│    │ ドレミファソラシド     │      │
│    └─────────────────────┘      │
├─────────────────────────────────┤
│           音量確認              │
│    ▒▒▒▒████▒▒▒▒ 60%           │ ← 音量のみ表示
│    「適切な音量です」            │    周波数・音名は非表示
└─────────────────────────────────┘
```

#### PC版UIレイアウト（横並び配置）
```
┌─────────────────────────────────────────────────┐
│ セッション 1/8 | 連続チャレンジモード | [ホーム] │
├─────────────────────────────────────────────────┤
│                                                 │
│ ┌─基音エリア─┐    ┌─統合ガイドエリア────────┐ │
│ │           │    │                          │ │
│ │  🎵 基音  │    │基音再生(2.0秒)│休憩│🎯開始│ │ ← 進行バー
│ │           │    │████████▒▒▒▒▒▒█▒█        │ │
│ │ [🔊スタート]│    │↑現在位置    ↑ ↑        │ │
│ │           │    │           0.5秒 開始     │ │
│ │           │    │                          │ │
│ │           │    │ ○○○○○○○○              │ │ ← ドレミガイド
│ │           │    │ ドレミファソラシド        │ │    進行バーと一体化
│ │           │    │                          │ │
│ └───────────┘    └──────────────────────────┘ │
├─────────────────────────────────────────────────┤
│                   音量確認                      │
│             ▒▒▒▒████▒▒▒▒ 60%                 │
└─────────────────────────────────────────────────┘
```

#### タイミングガイドの動作フロー

**Phase 1: 基音ボタン押下**
```
進行バー: ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒🎯▒▒▒▒ (待機状態)
ドレミ:   ○○○○○○○○ (グレー)
ボタン:   [🔊 基音スタート] (青・押せる状態)
```

**Phase 2: 基音再生中（例：1.2秒経過）**
```
進行バー: █████▒▒▒▒▒▒▒▒▒▒▒🎯▒▒▒▒ (60%進行)
         ↑現在位置      ↑開始ポイント
ドレミ:   ⏳⏳⏳⏳⏳⏳⏳⏳ (待機アニメーション)
ボタン:   [🔊 再生中...] (グレー・無効)
```

**Phase 3: 🎯ポイント到達→エフェクト+ガイド開始**
```
進行バー: ████████████████🌟✨✨✨ (エフェクト発生)
                      到達！
ドレミ:   🎯○○○○○○○ (1番目ハイライト+ガイド開始)
ボタン:   [🔊 基音を再度聞く] (青・再度聞ける)
```

**Phase 4: ガイド進行中（レの段階）**
```
進行バー: ██████████████████████▒▒ (ガイド用進行継続)
ドレミ:   ●🎯○○○○○○ (ド完了、レ進行中)
         完了 現在
```

**重要な設計思想**:
- ✅ **時間経過の予測可能性**: 🎯マーカーで開始時点が常に見える
- ✅ **統合UI**: 進行バーとドレミガイドが一体的に連携
- ✅ **相対音感原則**: 基音の音名・周波数は一切表示しない
- ✅ **タッチ操作**: 進行バー上のタッチで時間ジャンプ可能

#### トレーニングフロー
1. **基音再生**
   - システムがC3オクターブの8音からランダムに基音を選択
   - 「基音を聞く」ボタンで2.5秒間再生
   - **重要**: 選択された基音の音名は一切表示しない

2. **ガイドアニメーション**
   - 8つの円が横に並び、現在歌うべき音階を表示
   - ドから順番に自動的に進行
   - 各音階3秒程度のペース
   - **自分のペースで基音を聴き返せる**

3. **連続歌唱**
   - ユーザーは基音を「ド」として連続的に歌う
   - 基音からの相対音程: ド→レ→ミ→ファ→ソ→ラ→シ→ド

4. **リアルタイム判定**
   - 各音階の正解/不正解を自動判定
   - 正解: ±50セント以内
   - 判定結果を●○で表示

5. **結果表示**
   - 8音階の正解数（例: 6/8正解）
   - 各音階の精度グラフ
   - 総合評価（S, A, B, C級）
   - 次のモード選択の参考指標

#### 初級者向けの特徴
- **集中時間**: 1セッションのみで短時間
- **基音の数**: C3オクターブの8音（半音なし）
- **ペース**: 自分のペースで基音を何度でも聴ける
- **難易度**: 最も基本的な音階のみ

#### 操作ボタン
- 「基音を聞く」: 基音の再生（何度でも可能）
- 「もう一度」: 同じ基音で再挑戦
- 「新しい基音で開始」: 別の基音で新規セッション

### 3.2 連続チャレンジモード（中級）
**URL**: `/training/continuous`

#### モードの目的と特徴
- **対象**: 初級モードで基礎を習得した中級者
- **目的**: 自分の音域で半音も含めた音を聞き分けられるようになる
- **学習効果**: 瞬間的だけでなく一定時間内でも音を合わせ続ける能力の向上

#### なぜ8セッション連続なのか
**オクターブを一つの基準**とし、その音域で連続して練習することで、基音に対する反応速度と精度の向上を図ります。休憩なしで連続することで、集中力を維持しながら相対音感を鍛えます。

#### 画面構成の違い
- セッション表示が「1/8」〜「8/8」に変化
- 「連続チャレンジ開始」ボタンでスタート
- セッション間は自動進行（休憩なし）
- 基音の聴き直しは各セッション開始時のみ

#### 8セッション連続フロー
```
セッション1: 基音(音名非表示) → 8音階歌唱 → 自動採点 → 2秒待機
    ↓
セッション2: 基音(音名非表示) → 8音階歌唱 → 自動採点 → 2秒待機
    ↓
   ...（クロマチック12音から選択）
    ↓
セッション8: 基音(音名非表示) → 8音階歌唱 → 自動採点 → 総合評価
```

**重要**: 連続モードでは1セッションごとの評価表示を行わず、8セッション完了後の総合評価のみを表示します

#### 中級者向けの特徴
- **集中時間**: 8セッション連続（約10分間）
- **基音の数**: クロマチックの12音（半音を含む）
- **ペース**: 自動進行で一定のリズムを保つ
- **難易度**: 半音を含む全音階に対応

#### ランダムモードとの違い
- **連続性**: 8セッション休憩なしで実施
- **基音の種類**: 半音を含む12音から選択
- **ペース管理**: システムが自動的に進行
- **集中力**: より長時間の集中力が必要

#### 総合評価画面
- 8セッションの統計情報
  - 総合正解率（例: 85%）
  - 各セッションの成績一覧
  - 音階別の正解率グラフ（弱点の可視化）
  - 改善提案（苦手な音程の指摘）
- 「もう一度8セッション」ボタン
- 「上級モードに挑戦」ボタン（スコアが良い場合）
- 「ホームに戻る」ボタン

### 3.3 12音階モード（上級）※未実装
**URL**: `/training/chromatic`

#### モードの目的と特徴
- **対象**: 中級モードを習得した上級者
- **目的**: ユーザーの音域内ですべての音に対して完璧な相対音感を持てるようになる
- **学習効果**: クロマチック（半音階）の相対的な音感の差を正確に判断して発声できる能力

#### なぜ半音階すべてを使うのか
音楽の世界では12の半音がすべての基礎となります。これらすべてに対して相対音感を持つことで、どんな調性の楽曲でも正確に歌えるようになります。

#### 上り・下りの練習の目的
音の相対的な差を**上りと下りの両方向**で練習することにより、音程の変化をより深く理解し、相対音感をより効率的に学べます。

#### 12セッション連続フロー
```
上りフェーズ（12セッション）:
セッション1: 基音C3 → 8音階上昇 → 自動採点
セッション2: 基音C#3 → 8音階上昇 → 自動採点
...（半音ずつ上昇）
セッション12: 基音B3 → 8音階上昇 → 自動採点

下りフェーズ（12セッション）:
セッション13: 基音B3 → 8音階下降 → 自動採点
セッション14: 基音Bb3 → 8音階下降 → 自動採点
...（半音ずつ下降）
セッション24: 基音C3 → 8音階下降 → 総合評価
```

#### 上級者向けの特徴
- **集中時間**: 24セッション連続（約30分間）
- **基音の数**: クロマチックの12音すべて
- **練習方向**: 上昇と下降の両方
- **判定基準**: より厳密（±30セント以内）
- **プロレベル**: 音楽のプロを目指す人向け

#### 総合評価画面
- 24セッションの詳細統計
  - 上りフェーズの成績
  - 下りフェーズの成績
  - 各基音での正解率
  - 音程別の精度分析
- プロレベル判定（S級取得で「プロレベル認定」）
- 弱点の詳細分析と練習提案

---

## 4. 共通UI要素

### 4.1 ヘッダー
- アプリロゴ・タイトル
- 現在のページ名
- ホームへ戻るリンク

### 4.2 統合UIコンポーネント設計

#### 基音エリア（モバイル・PC共通）
- 基音ラベル（🎵「基音」表示のみ）
- スタートボタン（状態に応じて表示変化）
  - 待機時: [🔊 基音スタート]
  - 再生中: [🔊 再生中...]
  - 完了後: [🔊 基音を再度聞く]
- **禁止**: 音名・周波数の表示

#### 統合進行ガイド（進行バー + ドレミガイド）
- **進行バー仕様**:
  - 3区間分割: 基音再生(2秒) | 休憩(0.5秒) | 開始
  - 🎯マーカー: ガイド開始ポイントを明示
  - タッチ操作: バー上タッチで時間ジャンプ
  - エフェクト: 🎯到達時に🌟✨エフェクト

- **ドレミガイド仕様**:
  - 8音階表示: ドレミファソラシド
  - 状態表示: ○(待機) → 🎯(現在) → ●(完了)
  - 進行バーと同期: 🎯到達と同時にガイド開始

#### レスポンシブ対応
- **モバイル（縦積み）**: 基音エリア → 統合ガイド → 音量確認
- **PC（横並び）**: 基音エリア | 統合ガイド

### 4.3 音量確認セクション（相対音感原則適用）
- 音量レベルメーター（視覚的バー）
- 音量状態メッセージ（「適切です」「もう少し大きく」等）
- **禁止**: 周波数・音名・音程差の表示
- **マイクテストページは例外**: 調整目的で周波数・音名表示可能

### 4.4 進行状況表示
- 8音階の進行状況（●○○○○○○○）
- 現在の音階指示
- アニメーション効果

### 4.5 結果表示セクション
- 正解数/総数
- 精度グラフ
- 評価ランク（S〜C）
- 詳細分析（オプション）

---

## 5. 音楽理論基礎

### 5.1 相対音感とは
基準となる音（基音）に対して、他の音の高さの関係を認識する能力。
絶対音感と異なり、基準音があれば正確な音程を取ることができる。

### 5.2 相対音程の関係（開発者向け内部仕様）
```
相対音感における音程関係:
ド (基音) - 0セント
レ (基音+2半音) - +200セント
ミ (基音+4半音) - +400セント
ファ(基音+5半音) - +500セント
ソ (基音+7半音) - +700セント
ラ (基音+9半音) - +900セント
シ (基音+11半音) - +1100セント
ド (基音+12半音) - +1200セント

※どの基音が選ばれても相対関係は同じ
※ユーザーには基音の音名・周波数は一切表示しない
```

### 5.3 音程の精度（セント）
- 1オクターブ = 1200セント
- 半音 = 100セント
- ±10セント以内: プロレベルの精度
- ±25セント以内: 良好な精度
- ±50セント以内: 合格ライン

---

## 6. データ保存仕様

### 6.1 セッション進捗
- 現在のセッション番号（連続モード）
- 使用済み基音リスト
- 各セッションの結果

### 6.2 統計情報
- 総練習回数
- 平均正解率
- 音階別の成功率
- 最高記録

### 6.3 設定情報
- 音量設定
- 表示設定
- ユーザープリファレンス

---

## 7. エラー処理とメッセージ

### 7.1 マイク関連
- **許可拒否**: 「マイクの使用が拒否されました。ブラウザの設定から許可してください。」
- **マイク未接続**: 「マイクが検出されません。接続を確認してください。」
- **マイク使用中**: 「他のアプリがマイクを使用中です。」

### 7.2 音程検出関連
- **音量不足**: 「もう少し大きな声で歌ってください。」
- **雑音過多**: 「周囲の雑音が多いようです。静かな環境でお試しください。」
- **検出不能**: 「音程を検出できません。マイクの位置を調整してください。」

### 7.3 システム関連
- **非対応ブラウザ**: 「お使いのブラウザは音声機能に対応していません。」
- **ネットワークエラー**: 「接続エラーが発生しました。」

---

## 8. 技術実装仕様

### 8.1 統合進行ガイドの実装

#### CSS設計指針
```css
/* モバイル縦積みレイアウト */
@media (max-width: 768px) {
  .layout-container {
    flex-direction: column;
  }
  .base-note-section { order: 1; }
  .integrated-guide { order: 2; }
  .volume-section { order: 3; }
}

/* PC横並びレイアウト */
@media (min-width: 769px) {
  .layout-container {
    display: flex;
    gap: 30px;
  }
  .base-note-section { flex: 0 0 200px; }
  .integrated-guide { flex: 1; min-width: 400px; }
}
```

#### JavaScript連携仕様
```javascript
// 基音ボタン押下時の統合制御
function startBaseNote() {
  // 1. ボタン状態変更
  baseButton.setState('playing');
  
  // 2. 統合ガイドの反応
  integratedGuide.startProgressBar();
  integratedGuide.showWaitingAnimation();
  
  // 3. 🎯ポイント到達時の自動連携
  progressBar.onReachStartPoint(() => {
    integratedGuide.triggerStartEffect();
    integratedGuide.startDoremiGuide();
  });
}
```

### 8.2 進行バーの視覚設計

#### 色分け仕様
- 基音再生エリア: 青系 #2196F3
- 休憩エリア: 黄系 #FFC107
- 開始エリア: 緑系 #4CAF50
- 🎯マーカー: オレンジ #FF6B35 + 光エフェクト

#### アニメーション仕様
- 進行中: 左から右へスムーズな塗りつぶし
- 🎯到達: 🌟✨エフェクトで0.8秒間
- ドレミガイド連携: 🎯エフェクトと同時にハイライト開始

### 8.3 相対音感原則の技術的実装

#### 禁止データの非表示実装
```javascript
// ❌ 絶対禁止のコード例
const baseNote = 'C3';
const frequency = 261.63;
display(`基音: ${baseNote} (${frequency} Hz)`); // 絶対禁止

// ✅ 正しい実装例
const baseNoteFreq = getRandomBaseFrequency(); // 内部処理のみ
display('🎵 基音'); // 表示は「基音」のみ

// ✅ 相対音程のみ表示
const currentStep = 0; // ド=0, レ=1, ミ=2...
const scaleNames = ['ド', 'レ', 'ミ', 'ファ', 'ソ', 'ラ', 'シ', 'ド'];
display(`現在: ${scaleNames[currentStep]} を歌ってください`);
```

---

## 9. 将来の拡張予定

### 8.1 機能拡張
- 練習履歴の長期保存
- カスタム音階練習
- グループ練習機能
- AI による個別アドバイス

### 8.2 プラットフォーム拡張
- モバイルアプリ版
- オフライン対応
- 多言語対応

### 8.3 コンテンツ拡張
- 楽曲での練習モード
- 和音聴音トレーニング
- リズムトレーニング

---

**この仕様書は、相対音感トレーニングアプリの画面構成と基本動作を定義したものです。**
**実装言語やフレームワークに依存せず、アプリケーションの振る舞いを明確に示しています。**