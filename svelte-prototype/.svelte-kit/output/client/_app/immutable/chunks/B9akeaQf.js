var Xe=Object.defineProperty;var Ye=(a,e,t)=>e in a?Xe(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var Q=(a,e,t)=>Ye(a,typeof e!="symbol"?e+"":e,t);import{S as Ie,i as Ne,s as Ee,n as We,d as F,J as H,y as x,b as ue,c as A,e as D,f as V,h as Z,j as z,k as O,I as Ze,K as Oe,C as He,m as Pe,o as ke,a as pe,D as Ve,g as be,G as Me,E as Be,t as Ae,F as Re,R as $e,M as et}from"./BaJCk71S.js";import"./IHki7fMi.js";import{C as tt}from"./GM6xVcAP.js";function st(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}function L(a){if(this.size=a|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=a<<1;for(var e=new Array(this.size*2),t=0;t<e.length;t+=2){const l=Math.PI*t/this.size;e[t]=Math.cos(l),e[t+1]=-Math.sin(l)}this.table=e;for(var r=0,s=1;this.size>s;s<<=1)r++;this._width=r%2===0?r-1:r,this._bitrev=new Array(1<<this._width);for(var n=0;n<this._bitrev.length;n++){this._bitrev[n]=0;for(var o=0;o<this._width;o+=2){var i=this._width-o-2;this._bitrev[n]|=(n>>>o&3)<<i}}this._out=null,this._data=null,this._inv=0}var rt=L;L.prototype.fromComplexArray=function(e,t){for(var r=t||new Array(e.length>>>1),s=0;s<e.length;s+=2)r[s>>>1]=e[s];return r};L.prototype.createComplexArray=function(){const e=new Array(this._csize);for(var t=0;t<e.length;t++)e[t]=0;return e};L.prototype.toComplexArray=function(e,t){for(var r=t||this.createComplexArray(),s=0;s<r.length;s+=2)r[s]=e[s>>>1],r[s+1]=0;return r};L.prototype.completeSpectrum=function(e){for(var t=this._csize,r=t>>>1,s=2;s<r;s+=2)e[t-s]=e[s],e[t-s+1]=-e[s+1]};L.prototype.transform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._transform4(),this._out=null,this._data=null};L.prototype.realTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._realTransform4(),this._out=null,this._data=null};L.prototype.inverseTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=1,this._transform4();for(var r=0;r<e.length;r++)e[r]/=this.size;this._out=null,this._data=null};L.prototype._transform4=function(){var e=this._out,t=this._csize,r=this._width,s=1<<r,n=t/s<<1,o,i,l=this._bitrev;if(n===4)for(o=0,i=0;o<t;o+=n,i++){const d=l[i];this._singleTransform2(o,d,s)}else for(o=0,i=0;o<t;o+=n,i++){const d=l[i];this._singleTransform4(o,d,s)}var c=this._inv?-1:1,f=this.table;for(s>>=2;s>=2;s>>=2){n=t/s<<1;var h=n>>>2;for(o=0;o<t;o+=n)for(var m=o+h,v=o,u=0;v<m;v+=2,u+=s){const d=v,_=d+h,y=_+h,p=y+h,S=e[d],M=e[d+1],w=e[_],T=e[_+1],C=e[y],P=e[y+1],R=e[p],q=e[p+1],K=S,k=M,U=f[u],J=c*f[u+1],$=w*U-T*J,X=w*J+T*U,ee=f[2*u],te=c*f[2*u+1],Y=C*ee-P*te,se=C*te+P*ee,ne=f[3*u],ae=c*f[3*u+1],oe=R*ne-q*ae,re=R*ae+q*ne,ie=K+Y,g=k+se,b=K-Y,I=k-se,B=$+oe,E=X+re,j=c*($-oe),le=c*(X-re),ce=ie+B,de=g+E,fe=ie-B,W=g-E,he=b+le,me=I-j,ge=b-le,N=I+j;e[d]=ce,e[d+1]=de,e[_]=he,e[_+1]=me,e[y]=fe,e[y+1]=W,e[p]=ge,e[p+1]=N}}};L.prototype._singleTransform2=function(e,t,r){const s=this._out,n=this._data,o=n[t],i=n[t+1],l=n[t+r],c=n[t+r+1],f=o+l,h=i+c,m=o-l,v=i-c;s[e]=f,s[e+1]=h,s[e+2]=m,s[e+3]=v};L.prototype._singleTransform4=function(e,t,r){const s=this._out,n=this._data,o=this._inv?-1:1,i=r*2,l=r*3,c=n[t],f=n[t+1],h=n[t+r],m=n[t+r+1],v=n[t+i],u=n[t+i+1],d=n[t+l],_=n[t+l+1],y=c+v,p=f+u,S=c-v,M=f-u,w=h+d,T=m+_,C=o*(h-d),P=o*(m-_),R=y+w,q=p+T,K=S+P,k=M-C,U=y-w,J=p-T,$=S-P,X=M+C;s[e]=R,s[e+1]=q,s[e+2]=K,s[e+3]=k,s[e+4]=U,s[e+5]=J,s[e+6]=$,s[e+7]=X};L.prototype._realTransform4=function(){var e=this._out,t=this._csize,r=this._width,s=1<<r,n=t/s<<1,o,i,l=this._bitrev;if(n===4)for(o=0,i=0;o<t;o+=n,i++){const De=l[i];this._singleRealTransform2(o,De>>>1,s>>>1)}else for(o=0,i=0;o<t;o+=n,i++){const De=l[i];this._singleRealTransform4(o,De>>>1,s>>>1)}var c=this._inv?-1:1,f=this.table;for(s>>=2;s>=2;s>>=2){n=t/s<<1;var h=n>>>1,m=h>>>1,v=m>>>1;for(o=0;o<t;o+=n)for(var u=0,d=0;u<=v;u+=2,d+=s){var _=o+u,y=_+m,p=y+m,S=p+m,M=e[_],w=e[_+1],T=e[y],C=e[y+1],P=e[p],R=e[p+1],q=e[S],K=e[S+1],k=M,U=w,J=f[d],$=c*f[d+1],X=T*J-C*$,ee=T*$+C*J,te=f[2*d],Y=c*f[2*d+1],se=P*te-R*Y,ne=P*Y+R*te,ae=f[3*d],oe=c*f[3*d+1],re=q*ae-K*oe,ie=q*oe+K*ae,g=k+se,b=U+ne,I=k-se,B=U-ne,E=X+re,j=ee+ie,le=c*(X-re),ce=c*(ee-ie),de=g+E,fe=b+j,W=I+ce,he=B-le;if(e[_]=de,e[_+1]=fe,e[y]=W,e[y+1]=he,u===0){var me=g-E,ge=b-j;e[p]=me,e[p+1]=ge;continue}if(u!==v){var N=I,G=-B,xe=g,Fe=-b,Te=-c*ce,ve=-c*le,Ce=-c*j,Qe=-c*E,Ke=N+Te,Ue=G+ve,Je=xe+Qe,je=Fe-Ce,qe=o+m-u,Le=o+h-u;e[qe]=Ke,e[qe+1]=Ue,e[Le]=Je,e[Le+1]=je}}}};L.prototype._singleRealTransform2=function(e,t,r){const s=this._out,n=this._data,o=n[t],i=n[t+r],l=o+i,c=o-i;s[e]=l,s[e+1]=0,s[e+2]=c,s[e+3]=0};L.prototype._singleRealTransform4=function(e,t,r){const s=this._out,n=this._data,o=this._inv?-1:1,i=r*2,l=r*3,c=n[t],f=n[t+r],h=n[t+i],m=n[t+l],v=c+h,u=c-h,d=f+m,_=o*(f-m),y=v+d,p=u,S=-_,M=v-d,w=u,T=_;s[e]=y,s[e+1]=0,s[e+2]=p,s[e+3]=S,s[e+4]=M,s[e+5]=0,s[e+6]=w,s[e+7]=T};const nt=st(rt);class ye{constructor(e,t){Q(this,"_inputLength");Q(this,"_fft");Q(this,"_bufferSupplier");Q(this,"_paddedInputBuffer");Q(this,"_transformBuffer");Q(this,"_inverseBuffer");if(e<1)throw new Error("Input length must be at least one");this._inputLength=e,this._fft=new nt(it(2*e)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(e){return new ye(e,t=>new Float32Array(t))}static forFloat64Array(e){return new ye(e,t=>new Float64Array(t))}static forNumberArray(e){return new ye(e,t=>Array(t))}get inputLength(){return this._inputLength}autocorrelate(e,t=this._bufferSupplier(e.length)){if(e.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${e.length}`);for(let s=0;s<e.length;s++)this._paddedInputBuffer[s]=e[s];for(let s=e.length;s<this._paddedInputBuffer.length;s++)this._paddedInputBuffer[s]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const r=this._transformBuffer;for(let s=0;s<r.length;s+=2)r[s]=r[s]*r[s]+r[s+1]*r[s+1],r[s+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let s=0;s<e.length;s++)t[s]=this._inverseBuffer[2*s];return t}}function at(a){const e=[];let t=!1,r=-1/0,s=-1;for(let n=1;n<a.length-1;n++)a[n-1]<=0&&a[n]>0?(t=!0,s=n,r=a[n]):a[n-1]>0&&a[n]<=0?(t=!1,s!==-1&&e.push(s)):t&&a[n]>r&&(r=a[n],s=n);return e}function ot(a,e){const[t,r,s]=[a-1,a,a+1],[n,o,i]=[e[t],e[r],e[s]],l=n/2-o+i/2,c=-(n/2)*(r+s)+o*(t+s)-i/2*(t+r),f=n*r*s/2-o*t*s+i*t*r/2,h=-c/(2*l),m=l*h*h+c*h+f;return[h,m]}class _e{constructor(e,t){Q(this,"_autocorrelator");Q(this,"_nsdfBuffer");Q(this,"_clarityThreshold",.9);Q(this,"_minVolumeAbsolute",0);Q(this,"_maxInputAmplitude",1);this._autocorrelator=new ye(e,t),this._nsdfBuffer=t(e)}static forFloat32Array(e){return new _e(e,t=>new Float32Array(t))}static forFloat64Array(e){return new _e(e,t=>new Float64Array(t))}static forNumberArray(e){return new _e(e,t=>Array(t))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(e){if(!Number.isFinite(e)||e<=0||e>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=e}set minVolumeAbsolute(e){if(!Number.isFinite(e)||e<0||e>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=e}set minVolumeDecibels(e){if(!Number.isFinite(e)||e>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(e/10)}set maxInputAmplitude(e){if(!Number.isFinite(e)||e<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=e}findPitch(e,t){if(this._belowMinimumVolume(e))return[0,0];this._nsdf(e);const r=at(this._nsdfBuffer);if(r.length===0)return[0,0];const s=Math.max(...r.map(l=>this._nsdfBuffer[l])),n=r.find(l=>this._nsdfBuffer[l]>=this._clarityThreshold*s),[o,i]=ot(n,this._nsdfBuffer);return[t/o,Math.min(i,1)]}_belowMinimumVolume(e){if(this._minVolumeAbsolute===0)return!1;let t=0;for(let r=0;r<e.length;r++)t+=e[r]**2;return Math.sqrt(t/e.length)<this._minVolumeAbsolute}_nsdf(e){this._autocorrelator.autocorrelate(e,this._nsdfBuffer);let t=2*this._nsdfBuffer[0],r;for(r=0;r<this._nsdfBuffer.length&&t>0;r++)this._nsdfBuffer[r]=2*this._nsdfBuffer[r]/t,t-=e[r]**2+e[e.length-r-1]**2;for(;r<this._nsdfBuffer.length;r++)this._nsdfBuffer[r]=0}}function it(a){return a--,a|=a>>1,a|=a>>2,a|=a>>4,a|=a>>8,a|=a>>16,a++,a}function lt(a){let e,t,r,s,n,o;return{c(){e=z("div"),t=z("div"),r=z("div"),s=O(),n=z("div"),this.h()},l(i){e=D(i,"DIV",{class:!0});var l=V(e);t=D(l,"DIV",{class:!0,style:!0});var c=V(t);r=D(c,"DIV",{class:!0,style:!0}),V(r).forEach(F),c.forEach(F),s=Z(l),n=D(l,"DIV",{class:!0,style:!0}),V(n).forEach(F),l.forEach(F),this.h()},h(){x(r,"class","volume-bar-fill"),H(r,"position","absolute"),H(r,"top","0"),H(r,"left","0"),H(r,"height","100%"),x(t,"class","volume-bar-bg"),H(t,"height",a[1]),H(t,"border-radius","9999px"),H(t,"background-color","#e2e8f0"),H(t,"position","relative"),H(t,"overflow","hidden"),x(n,"class","threshold-indicator svelte-13z7ppf"),H(n,"position","absolute"),H(n,"top","0"),H(n,"left",a[0]+"%"),H(n,"width","2px"),H(n,"height",a[1]),H(n,"background-color","#64748b"),H(n,"border-radius","1px"),x(e,"class",o="volume-bar-container "+a[2]+" svelte-13z7ppf")},m(i,l){ue(i,e,l),A(e,t),A(t,r),a[5](r),A(e,s),A(e,n)},p(i,[l]){l&2&&H(t,"height",i[1]),l&1&&H(n,"left",i[0]+"%"),l&2&&H(n,"height",i[1]),l&4&&o!==(o="volume-bar-container "+i[2]+" svelte-13z7ppf")&&x(e,"class",o)},i:We,o:We,d(i){i&&F(e),a[5](null)}}}function ct(a,e,t){let{volume:r=0}=e,{threshold:s=30}=e,{height:n="12px"}=e,{className:o=""}=e,i;function l(h){return h<s?`rgba(37, 99, 235, ${Math.max(.2,h/s*.8)})`:"#2563eb"}function c(h){if(i){const m=Math.max(0,Math.min(100,h)),v=l(m);t(3,i.style.width=`${m}%`,i),t(3,i.style.backgroundColor=v,i)}}Ze(()=>{i&&(t(3,i.style.width="0%",i),t(3,i.style.backgroundColor="#2563eb",i),t(3,i.style.height=n,i),t(3,i.style.borderRadius="9999px",i),t(3,i.style.transition="width 0.2s ease-out, background-color 0.2s ease-out",i))});function f(h){Oe[h?"unshift":"push"](()=>{i=h,t(3,i)})}return a.$$set=h=>{"volume"in h&&t(4,r=h.volume),"threshold"in h&&t(0,s=h.threshold),"height"in h&&t(1,n=h.height),"className"in h&&t(2,o=h.className)},a.$$.update=()=>{a.$$.dirty&16&&c(r)},[s,n,o,i,r,f]}class Ge extends Ie{constructor(e){super(),Ne(this,e,ct,lt,Ee,{volume:4,threshold:0,height:1,className:2})}}class ut{constructor(){this.audioContext=null,this.mediaStream=null,this.sourceNode=null,this.analysers=new Map,this.filters=new Map,this.refCount=0,this.initPromise=null,this.isInitialized=!1,this.lastError=null}async initialize(){var e,t,r;if(this.initPromise)return this.initPromise;if(this.isInitialized&&this.audioContext&&this.mediaStream){const s=this.checkMediaStreamHealth();if(s.healthy)return this.refCount++,{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode};console.warn("⚠️ [AudioManager] MediaStream不健康検出 - 強制再初期化:",s.reason),console.log("🔄 [AudioManager] 不健康なMediaStream詳細:",{mediaStreamActive:(e=this.mediaStream)==null?void 0:e.active,trackCount:(t=this.mediaStream)==null?void 0:t.getTracks().length,trackStates:(r=this.mediaStream)==null?void 0:r.getTracks().map(n=>({kind:n.kind,readyState:n.readyState,enabled:n.enabled,muted:n.muted}))}),this._cleanup(),this.isInitialized=!1,this.refCount=0,await new Promise(n=>setTimeout(n,100)),console.log("🔄 [AudioManager] クリーンアップ完了 - 再初期化開始")}this.initPromise=this._doInitialize();try{const s=await this.initPromise;return this.initPromise=null,s}catch(s){throw this.initPromise=null,s}}async _doInitialize(){try{if(console.log("🎤 [AudioManager] 初期化開始"),this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),console.log("✅ [AudioManager] AudioContext作成完了")),this.audioContext.state==="suspended"&&(await this.audioContext.resume(),console.log("✅ [AudioManager] AudioContext再開完了")),!this.mediaStream){const e={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,sampleRate:44100,channelCount:1,sampleSize:16,latency:.1,volume:1,deviceId:{ideal:"default"}}};console.log("🎤 [AudioManager] Safari対応設定でMediaStream取得中:",e),this.mediaStream=await navigator.mediaDevices.getUserMedia(e),console.log("✅ [AudioManager] MediaStream取得完了")}if(!this.sourceNode){this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),console.log("✅ [AudioManager] SourceNode作成完了");const e=this.mediaStream.getTracks();console.log("🎤 [AudioManager] MediaStream tracks:",e.map(t=>({kind:t.kind,label:t.label,enabled:t.enabled,readyState:t.readyState,muted:t.muted})))}return this.isInitialized=!0,this.refCount++,this.lastError=null,console.log(`🎤 [AudioManager] 初期化完了 (参照カウント: ${this.refCount})`),{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode}}catch(e){throw console.error("❌ [AudioManager] 初期化エラー:",e),this.lastError=e,this.isInitialized=!1,this._cleanup(),e}}createAnalyser(e,t={}){if(!this.isInitialized||!this.audioContext||!this.sourceNode)throw new Error("AudioManager not initialized. Call initialize() first.");this.removeAnalyser(e);const{fftSize:r=2048,smoothingTimeConstant:s=.8,minDecibels:n=-90,maxDecibels:o=-10,useFilters:i=!0}=t,l=this.audioContext.createAnalyser();if(l.fftSize=Math.min(r,2048),l.smoothingTimeConstant=Math.max(s,.7),l.minDecibels=Math.max(n,-80),l.maxDecibels=Math.min(o,-10),this.sourceNode,i){const c=this._createFilterChain();this.filters.set(e,c),this.sourceNode.connect(c.highpass),c.highpass.connect(c.lowpass),c.lowpass.connect(c.notch),c.notch.connect(l),console.log(`🔧 [AudioManager] フィルター付きAnalyser作成: ${e}`)}else this.sourceNode.connect(l),console.log(`🔧 [AudioManager] 生信号Analyser作成: ${e}`);return this.analysers.set(e,l),l}_createFilterChain(){const e=this.audioContext.createBiquadFilter();e.type="highpass",e.frequency.setValueAtTime(80,this.audioContext.currentTime),e.Q.setValueAtTime(.7,this.audioContext.currentTime);const t=this.audioContext.createBiquadFilter();t.type="lowpass",t.frequency.setValueAtTime(800,this.audioContext.currentTime),t.Q.setValueAtTime(.7,this.audioContext.currentTime);const r=this.audioContext.createBiquadFilter();return r.type="notch",r.frequency.setValueAtTime(60,this.audioContext.currentTime),r.Q.setValueAtTime(10,this.audioContext.currentTime),{highpass:e,lowpass:t,notch:r}}removeAnalyser(e){if(this.analysers.has(e)&&(this.analysers.get(e).disconnect(),this.analysers.delete(e),console.log(`🗑️ [AudioManager] Analyser削除: ${e}`)),this.filters.has(e)){const t=this.filters.get(e);t.highpass.disconnect(),t.lowpass.disconnect(),t.notch.disconnect(),this.filters.delete(e),console.log(`🗑️ [AudioManager] フィルターチェーン削除: ${e}`)}}release(e=[]){e.forEach(t=>this.removeAnalyser(t)),this.refCount=Math.max(0,this.refCount-1),console.log(`📉 [AudioManager] 参照カウント減算: ${this.refCount}`),this.refCount<=0&&(console.log("🧹 [AudioManager] 全リソースクリーンアップ開始"),this._cleanup())}forceCleanup(){console.log("🚨 [AudioManager] 強制クリーンアップ実行"),this._cleanup()}_cleanup(){console.log("🧹 [AudioManager] クリーンアップ開始");for(const e of this.analysers.keys())this.removeAnalyser(e);if(this.mediaStream){const e=this.mediaStream.getTracks();console.log(`🛑 [AudioManager] MediaStream停止中: ${e.length} tracks`),e.forEach((t,r)=>{try{t.readyState!=="ended"?(t.stop(),console.log(`🛑 [AudioManager] Track ${r} 停止完了`)):console.log(`⚠️ [AudioManager] Track ${r} 既に終了済み`)}catch(s){console.warn(`⚠️ [AudioManager] Track ${r} 停止エラー:`,s)}}),this.mediaStream=null}if(this.audioContext&&this.audioContext.state!=="closed"){try{this.audioContext.close(),console.log("🛑 [AudioManager] AudioContext閉鎖完了")}catch(e){console.warn("⚠️ [AudioManager] AudioContext閉鎖エラー:",e)}this.audioContext=null}this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.isInitialized=!1,this.refCount=0,this.initPromise=null,console.log("✅ [AudioManager] クリーンアップ完了")}getStatus(){var e,t;return{isInitialized:this.isInitialized,refCount:this.refCount,audioContextState:((e=this.audioContext)==null?void 0:e.state)||"none",mediaStreamActive:((t=this.mediaStream)==null?void 0:t.active)||!1,activeAnalysers:Array.from(this.analysers.keys()),activeFilters:Array.from(this.filters.keys()),lastError:this.lastError}}checkMediaStreamHealth(){if(!this.mediaStream)return{healthy:!1,reason:"MediaStream not initialized"};if(!this.mediaStream.active)return{healthy:!1,reason:"MediaStream inactive"};const e=this.mediaStream.getTracks();if(e.length===0)return{healthy:!1,reason:"No tracks available"};const t=e.find(r=>r.kind==="audio");return t?t.readyState==="ended"?{healthy:!1,reason:"Audio track ended"}:t.enabled?t.muted?{healthy:!1,reason:"Audio track muted"}:this.mediaStream.active&&t.readyState!=="live"?{healthy:!1,reason:"Track state inconsistent with MediaStream"}:{healthy:!0,track:t}:{healthy:!1,reason:"Audio track disabled"}:{healthy:!1,reason:"No audio track found"}}}const Se=new ut;class ht{constructor(e={}){this.vocalRangeMin=e.vocalRangeMin||130.81,this.vocalRangeMax=e.vocalRangeMax||1046.5,this.stabilityThreshold=e.stabilityThreshold||.1,this.evaluationWeights={vocalRange:e.vocalRangeWeight||.4,continuity:e.continuityWeight||.4,musical:e.musicalWeight||.2},this.fundamentalCandidates=e.fundamentalCandidates||[1,.5,.333,.25,2],this.harmonicHistory=[],this.previousFrequency=0,this.maxHistoryLength=5,this.debugMode=!1,this.currentContext={}}correctHarmonic(e,t=!1){if(!e||e<=0)return 0;const s=this.fundamentalCandidates.map(i=>({frequency:e*i,ratio:i})).map(i=>{const l=this.evaluateFundamental(i.frequency);return{...i,...l}}),n=s.reduce((i,l)=>l.totalScore>i.totalScore?l:i),o=this.stabilizeFrequency(n.frequency);return(t||this.debugMode)&&this.logHarmonicCorrection(e,s,n,o,this.currentContext),this.previousFrequency=o,o}logHarmonicCorrection(e,t,r,s,n={}){console.group(`🔧 [HarmonicCorrection] ${e.toFixed(1)}Hz → ${s.toFixed(1)}Hz`);const o=this.frequencyToNote(e),i=this.frequencyToNote(s);console.log(`📝 音程変換: ${o} → ${i}`);const l=this.getCorrectionType(r.ratio);if(console.log(`🎯 補正タイプ: ${l}`),n.baseFrequency&&n.currentScale&&n.targetFrequency){console.log("🎵 音階コンテキスト:"),console.log(`   基音: ${n.baseFrequency.toFixed(1)}Hz (${this.frequencyToNote(n.baseFrequency)})`),console.log(`   現在の音階: ${n.currentScale}`),console.log(`   目標周波数: ${n.targetFrequency.toFixed(1)}Hz (${this.frequencyToNote(n.targetFrequency)})`);const f=s-n.targetFrequency,h=1200*Math.log2(s/n.targetFrequency);console.log(`   目標との差: ${f>0?"+":""}${f.toFixed(1)}Hz (${h>0?"+":""}${h.toFixed(0)}セント)`);const m=Math.abs(h)<=50?"🎯 高精度":Math.abs(h)<=100?"✅ 良好":Math.abs(h)<=200?"⚠️ 要改善":"❌ 不正確";console.log(`   精度評価: ${m} (${Math.abs(h).toFixed(0)}セント差)`)}console.table(t.map(f=>({倍率:`${f.ratio.toFixed(3)}x`,周波数:`${f.frequency.toFixed(1)}Hz`,音名:this.frequencyToNote(f.frequency),音域:f.vocalRangeScore.toFixed(2),連続性:f.continuityScore.toFixed(2),音楽性:f.musicalScore.toFixed(2),総合:f.totalScore.toFixed(3),選択:f===r?"✅":""})));const c=Math.abs(s-r.frequency);c>.5&&console.log(`🔄 安定化: ${r.frequency.toFixed(1)}Hz → ${s.toFixed(1)}Hz (${c.toFixed(1)}Hz調整)`),console.groupEnd()}getCorrectionType(e){return Math.abs(e-1)<.01?"補正なし（基音）":Math.abs(e-.5)<.01?"2倍音補正（1オクターブ下）":Math.abs(e-.333)<.01?"3倍音補正（1オクターブ+5度下）":Math.abs(e-.25)<.01?"4倍音補正（2オクターブ下）":Math.abs(e-2)<.01?"オクターブ上補正":`カスタム補正（${e.toFixed(3)}x）`}frequencyToNote(e){if(!e||e<=0)return"---";const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],s=Math.round(12*Math.log2(e/440)),n=(s+9+120)%12,o=Math.floor((s+9)/12)+4;return t[n]+o}evaluateFundamental(e){const r=e>=this.vocalRangeMin&&e<=this.vocalRangeMax?1:0,s=this.previousFrequency>0?1-Math.min(Math.abs(e-this.previousFrequency)/this.previousFrequency,1):.5,n=this.calculateMusicalScore(e),o=r*this.evaluationWeights.vocalRange+s*this.evaluationWeights.continuity+n*this.evaluationWeights.musical;return{vocalRangeScore:r,continuityScore:s,musicalScore:n,totalScore:o}}calculateMusicalScore(e){const r=Math.log2(e/261.63)*12,s=Math.round(r),n=Math.abs(r-s);return Math.max(0,1-n/.5)}stabilizeFrequency(e){if(!e||e<=0)return 0;if(this.harmonicHistory.push(e),this.harmonicHistory.length>this.maxHistoryLength&&this.harmonicHistory.shift(),this.harmonicHistory.length<2)return e;const t=[...this.harmonicHistory].sort((o,i)=>o-i),r=t[Math.floor(t.length/2)],s=r*this.stabilityThreshold;return Math.abs(e-r)>s?r+Math.sign(e-r)*s:e}resetHistory(){this.harmonicHistory=[],this.previousFrequency=0}updateConfig(e){Object.assign(this,e),console.log("⚙️ [HarmonicCorrection] 設定更新:",e)}enableDebugLogging(){this.debugMode=!0,console.log("🔍 [HarmonicCorrection] デバッグログ有効化 - 次回の補正から詳細ログを出力します"),console.log("無効化するには: harmonicCorrection.disableDebugLogging()")}disableDebugLogging(){this.debugMode=!1,console.log("🔍 [HarmonicCorrection] デバッグログ無効化")}setScaleContext(e){this.currentContext={baseFrequency:e.baseFrequency,currentScale:e.currentScale,targetFrequency:e.targetFrequency}}clearContext(){this.currentContext={}}getStatus(){return{vocalRangeMin:this.vocalRangeMin,vocalRangeMax:this.vocalRangeMax,stabilityThreshold:this.stabilityThreshold,evaluationWeights:this.evaluationWeights,historyLength:this.harmonicHistory.length,previousFrequency:this.previousFrequency,recentHistory:this.harmonicHistory.slice(-3)}}}const we=new ht;function dt(a){let e,t,r,s,n=(a[2]>0?Math.round(a[2]):"---")+"",o,i,l,c="Hz",f,h,m="|",v,u,d,_,y,p,S;return y=new Ge({props:{volume:a[2]>0?a[1]:0,className:"volume-bar"}}),{c(){e=z("div"),t=z("div"),r=z("div"),s=z("span"),o=Ae(n),i=O(),l=z("span"),l.textContent=c,f=O(),h=z("span"),h.textContent=m,v=O(),u=z("span"),d=Ae(a[3]),_=O(),Re(y.$$.fragment),this.h()},l(M){e=D(M,"DIV",{class:!0});var w=V(e);t=D(w,"DIV",{class:!0});var T=V(t);r=D(T,"DIV",{class:!0});var C=V(r);s=D(C,"SPAN",{class:!0});var P=V(s);o=be(P,n),P.forEach(F),i=Z(C),l=D(C,"SPAN",{class:!0,"data-svelte-h":!0}),Me(l)!=="svelte-5uyilv"&&(l.textContent=c),f=Z(C),h=D(C,"SPAN",{class:!0,"data-svelte-h":!0}),Me(h)!=="svelte-1dytxz4"&&(h.textContent=m),v=Z(C),u=D(C,"SPAN",{class:!0});var R=V(u);d=be(R,a[3]),R.forEach(F),C.forEach(F),_=Z(T),Be(y.$$.fragment,T),T.forEach(F),w.forEach(F),this.h()},h(){x(s,"class","detected-frequency svelte-vc1bho"),x(l,"class","hz-suffix svelte-vc1bho"),x(h,"class","divider svelte-vc1bho"),x(u,"class","detected-note svelte-vc1bho"),x(r,"class","detection-card svelte-vc1bho"),x(t,"class","detection-display svelte-vc1bho"),x(e,"class",p="pitch-detector "+a[0]+" svelte-vc1bho")},m(M,w){ue(M,e,w),A(e,t),A(t,r),A(r,s),A(s,o),A(r,i),A(r,l),A(r,f),A(r,h),A(r,v),A(r,u),A(u,d),A(t,_),Ve(y,t,null),S=!0},p(M,w){(!S||w[0]&4)&&n!==(n=(M[2]>0?Math.round(M[2]):"---")+"")&&pe(o,n),(!S||w[0]&8)&&pe(d,M[3]);const T={};w[0]&6&&(T.volume=M[2]>0?M[1]:0),y.$set(T),(!S||w[0]&1&&p!==(p="pitch-detector "+M[0]+" svelte-vc1bho"))&&x(e,"class",p)},i(M){S||(ke(y.$$.fragment,M),S=!0)},o(M){Pe(y.$$.fragment,M),S=!1},d(M){M&&F(e),He(y)}}}function ze(a){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(a<=0)return"ーー";const r=Math.round(12*Math.log2(a/440)),s=(r+9+120)%12,n=Math.floor((r+9)/12)+4;return e[s]+n}function ft(a,e,t){const r=$e();let{isActive:s=!1}=e,{className:n=""}=e,{debugMode:o=!1}=e,{trainingPhase:i=""}=e,l="uninitialized",c=null,f=!1,h=null,m=null,v=null,u=null,d=null,_=null,y=null,p=!1,S=[],M=new Map,w=0,T=0,C=0,P="ーー",R=0,q=[],K=0,k=null,U="",J=0;function $(){w=0,t(1,T=0),t(2,C=0),t(3,P="ーー"),R=0,K=0,q=[],we.resetHistory(),U="",J=0,o&&console.log("🔄 [PitchDetector] Display state reset")}function X(){if(!o)return;const g=new Date().toLocaleTimeString(),b={timestamp:g,componentState:l,isActive:s,isDetecting:p,isInitialized:f,mediaStreamActive:m?m.active:null,mediaStreamTracks:m?m.getTracks().length:0,trackStates:m?m.getTracks().map(E=>({kind:E.kind,enabled:E.enabled,readyState:E.readyState,muted:E.muted})):[],audioContextState:h?h.state:null,hasAnalyser:!!u,currentVolume:w,currentFrequency:C};console.log(`🎤 [PitchDetector] ${g}:`,b);let I=!0,B=[];m&&!m.active&&(console.warn("⚠️ [PitchDetector] MediaStream is inactive!",m),I=!1,B.push("MediaStream inactive")),h&&h.state==="suspended"&&(console.warn("⚠️ [PitchDetector] AudioContext is suspended!",h),I=!1,B.push("AudioContext suspended")),m&&m.getTracks().forEach((E,j)=>{E.readyState==="ended"&&(console.error(`❌ [PitchDetector] Track ${j} has ended!`,E),I=!1,B.push(`Track ${j} ended`))}),r("microphoneHealthChange",{healthy:I,errors:B,details:b})}async function ee(){try{t(15,l="initializing"),c=null,console.log("🎙️ [PitchDetector] AudioManager経由で初期化開始");const g=await Se.initialize();h=g.audioContext,m=g.mediaStream,v=g.sourceNode,console.log("✅ [PitchDetector] AudioManager リソース取得完了");const b=`pitch-detector-filtered-${Date.now()}`;t(16,u=Se.createAnalyser(b,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!0})),S.push(b);const I=`pitch-detector-raw-${Date.now()}`;d=Se.createAnalyser(I,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!1}),S.push(I),console.log("✅ [PitchDetector] Analyser作成完了:",S),_=_e.forFloat32Array(u.fftSize),t(15,l="ready"),f=!0,r("stateChange",{state:l}),ie(),console.log("✅ [PitchDetector] 初期化完了")}catch(g){throw console.error("❌ [PitchDetector] 初期化エラー:",g),t(15,l="error"),c=g,f=!1,r("error",{error:g,context:"initialization"}),g}}function te(){if(l!=="ready"){const g=new Error(`Cannot start detection: component state is ${l}`);return r("error",{error:g,context:"start-detection"}),!1}if(!u||!_||!h){const g=new Error("Required components not available");return t(15,l="error"),r("error",{error:g,context:"start-detection"}),!1}return t(15,l="detecting"),t(17,p=!0),r("stateChange",{state:l}),se(),!0}function Y(){t(17,p=!1),y&&(cancelAnimationFrame(y),y=null),l==="detecting"&&f&&(t(15,l="ready"),r("stateChange",{state:l}))}function se(){if(!p||!u||!d||!_)return;const g=u.fftSize,b=new Float32Array(g),I=new Float32Array(d.fftSize);u.getFloatTimeDomainData(b),d.getFloatTimeDomainData(I);let B=0;for(let N=0;N<g;N++)B+=Math.abs(b[N]);const E=Math.sqrt(B/g),j=Math.log10(E+.001)*50+100,le=Math.max(0,Math.min(100,j));let ce=0;for(let N=0;N<I.length;N++)ce+=Math.abs(I[N]);const de=Math.sqrt(ce/I.length),fe=Math.log10(de+.001)*50+100;t(1,T=Math.max(0,Math.min(100,fe))),q.push(le),q.length>5&&q.shift(),K=q.reduce((N,G)=>N+G,0)/q.length,w=K;const[W,he]=_.findPitch(b,h.sampleRate),me=W>=65&&W<=1200;if(W&&he>.6&&w>10&&me){const N=we.correctHarmonic(W);if(N!==W&&Math.abs(N-W)>5&&i==="guiding"){const G=W/N,xe=G>1.8&&G<2.2?"2x":G>2.8&&G<3.2?"3x":G>3.8&&G<4.2?"4x":G>.45&&G<.55?"1/2x":"other",Fe=ze(W),Te=ze(N),ve=`🔧 [Harmonic] ${W.toFixed(0)}Hz(${Fe}) → ${N.toFixed(0)}Hz(${Te}) [${xe}補正]`,Ce=Date.now();ve!==U&&Ce-J>500&&(console.log(ve),U=ve,J=Ce)}t(2,C=Math.round(N)),t(3,P=ze(C)),R=he}else C===0&&we.resetHistory(),t(2,C=0),t(3,P="ーー"),R=0;const ge=C>0?T:0;r("pitchUpdate",{frequency:C,note:P,volume:w,rawVolume:ge,clarity:R}),y=requestAnimationFrame(se)}function ne(){return f&&l==="ready"}function ae(){return{componentState:l,isInitialized:f,isDetecting:p,lastError:c,hasRequiredComponents:!!(u&&_&&h&&m)}}async function oe(){console.log("🔄 [PitchDetector] 再初期化開始"),re(),await new Promise(g=>setTimeout(g,100)),await ee(),console.log("✅ [PitchDetector] 再初期化完了")}function re(){console.log("🧹 [PitchDetector] クリーンアップ開始"),Y(),M.size>0&&(M.forEach((g,b)=>{b.removeEventListener("ended",g.endedHandler),b.removeEventListener("mute",g.muteHandler),b.removeEventListener("unmute",g.unmuteHandler)}),M.clear(),console.log("🔄 [PitchDetector] MediaStreamイベントリスナー削除")),S.length>0&&(Se.release(S),console.log("📤 [PitchDetector] AudioManagerにAnalyser解放通知:",S),S=[]),t(15,l="uninitialized"),f=!1,c=null,h=null,m=null,v=null,t(16,u=null),d=null,_=null,q=[],we.resetHistory(),console.log("✅ [PitchDetector] クリーンアップ完了")}function ie(){if(!m)return;const g=m.getTracks();g.forEach(b=>{const I=()=>{console.error("🚨 [PitchDetector] MediaStreamTrack終了検出:",b.kind),t(15,l="error"),c=new Error(`MediaStreamTrack (${b.kind}) ended`),r("error",{error:c,reason:"mediastream_ended",recovery:"restart_required"}),p&&Y()},B=()=>{console.warn("⚠️ [PitchDetector] MediaStreamTrack muted:",b.kind),r("warning",{reason:"track_muted",track:b.kind})},E=()=>{console.log("✅ [PitchDetector] MediaStreamTrack unmuted:",b.kind),r("info",{reason:"track_unmuted",track:b.kind})};b.addEventListener("ended",I),b.addEventListener("mute",B),b.addEventListener("unmute",E),M.set(b,{endedHandler:I,muteHandler:B,unmuteHandler:E})}),console.log("🔍 [PitchDetector] MediaStream監視開始:",g.length+" tracks")}return et(()=>{k&&(clearInterval(k),t(18,k=null)),console.log("🔄 [PitchDetector] onDestroy - AudioManagerリソースは保持")}),a.$$set=g=>{"isActive"in g&&t(4,s=g.isActive),"className"in g&&t(0,n=g.className),"debugMode"in g&&t(5,o=g.debugMode),"trainingPhase"in g&&t(6,i=g.trainingPhase)},a.$$.update=()=>{a.$$.dirty[0]&262176&&(o&&!k?(console.log("🔍 [PitchDetector] Debug mode enabled - starting status monitoring"),t(18,k=setInterval(X,3e3)),X()):!o&&k&&(console.log("🔍 [PitchDetector] Debug mode disabled - stopping status monitoring"),clearInterval(k),t(18,k=null))),a.$$.dirty[0]&229392&&(s&&l==="ready"&&u&&!p?te():!s&&p&&Y())},[n,T,C,P,s,o,i,$,ee,te,Y,ne,ae,oe,re,l,u,p,k]}class Ct extends Ie{constructor(e){super(),Ne(this,e,ft,dt,Ee,{isActive:4,className:0,debugMode:5,trainingPhase:6,resetDisplayState:7,initialize:8,startDetection:9,stopDetection:10,getIsInitialized:11,getState:12,reinitialize:13,cleanup:14},null,[-1,-1])}get resetDisplayState(){return this.$$.ctx[7]}get initialize(){return this.$$.ctx[8]}get startDetection(){return this.$$.ctx[9]}get stopDetection(){return this.$$.ctx[10]}get getIsInitialized(){return this.$$.ctx[11]}get getState(){return this.$$.ctx[12]}get reinitialize(){return this.$$.ctx[13]}get cleanup(){return this.$$.ctx[14]}}function mt(a){let e,t,r=(a[0]>0?Math.round(a[0]):"---")+"",s,n,o,i="Hz",l,c,f="|",h,m,v;return{c(){e=z("div"),t=z("span"),s=Ae(r),n=O(),o=z("span"),o.textContent=i,l=O(),c=z("span"),c.textContent=f,h=O(),m=z("span"),v=Ae(a[1]),this.h()},l(u){e=D(u,"DIV",{class:!0});var d=V(e);t=D(d,"SPAN",{class:!0});var _=V(t);s=be(_,r),_.forEach(F),n=Z(d),o=D(d,"SPAN",{class:!0,"data-svelte-h":!0}),Me(o)!=="svelte-5uyilv"&&(o.textContent=i),l=Z(d),c=D(d,"SPAN",{class:!0,"data-svelte-h":!0}),Me(c)!=="svelte-1dytxz4"&&(c.textContent=f),h=Z(d),m=D(d,"SPAN",{class:!0});var y=V(m);v=be(y,a[1]),y.forEach(F),d.forEach(F),this.h()},h(){x(t,"class","detected-frequency svelte-1datf0r"),x(o,"class","hz-suffix svelte-1datf0r"),x(c,"class","divider svelte-1datf0r"),x(m,"class","detected-note svelte-1datf0r"),x(e,"class","detection-values svelte-1datf0r")},m(u,d){ue(u,e,d),A(e,t),A(t,s),A(e,n),A(e,o),A(e,l),A(e,c),A(e,h),A(e,m),A(m,v)},p(u,d){d&1&&r!==(r=(u[0]>0?Math.round(u[0]):"---")+"")&&pe(s,r),d&2&&pe(v,u[1])},d(u){u&&F(e)}}}function gt(a){let e,t;return{c(){e=z("span"),t=Ae(a[4]),this.h()},l(r){e=D(r,"SPAN",{class:!0});var s=V(e);t=be(s,a[4]),s.forEach(F),this.h()},h(){x(e,"class","muted-message svelte-1datf0r")},m(r,s){ue(r,e,s),A(e,t)},p(r,s){s&16&&pe(t,r[4])},d(r){r&&F(e)}}}function vt(a){let e,t='<h3 class="section-title svelte-1datf0r">🎙️ リアルタイム音程検出</h3>',r,s,n,o,i,l,c,f;function h(u,d){return u[3]?gt:mt}let m=h(a),v=m(a);return c=new Ge({props:{volume:!a[3]&&a[0]>0?a[2]:0,className:"volume-bar"}}),{c(){e=z("div"),e.innerHTML=t,r=O(),s=z("div"),n=z("div"),o=z("div"),i=z("div"),v.c(),l=O(),Re(c.$$.fragment),this.h()},l(u){e=D(u,"DIV",{class:!0,"data-svelte-h":!0}),Me(e)!=="svelte-10ekeq9"&&(e.innerHTML=t),r=Z(u),s=D(u,"DIV",{class:!0});var d=V(s);n=D(d,"DIV",{class:!0});var _=V(n);o=D(_,"DIV",{class:!0});var y=V(o);i=D(y,"DIV",{class:!0});var p=V(i);v.l(p),p.forEach(F),l=Z(y),Be(c.$$.fragment,y),y.forEach(F),_.forEach(F),d.forEach(F),this.h()},h(){x(e,"class","card-header svelte-1datf0r"),x(i,"class","detection-card svelte-1datf0r"),x(o,"class","detection-display svelte-1datf0r"),x(n,"class","pitch-detector svelte-1datf0r"),x(s,"class","card-content svelte-1datf0r")},m(u,d){ue(u,e,d),ue(u,r,d),ue(u,s,d),A(s,n),A(n,o),A(o,i),v.m(i,null),A(o,l),Ve(c,o,null),f=!0},p(u,d){m===(m=h(u))&&v?v.p(u,d):(v.d(1),v=m(u),v&&(v.c(),v.m(i,null)));const _={};d&13&&(_.volume=!u[3]&&u[0]>0?u[2]:0),c.$set(_)},i(u){f||(ke(c.$$.fragment,u),f=!0)},o(u){Pe(c.$$.fragment,u),f=!1},d(u){u&&(F(e),F(r),F(s)),v.d(),He(c)}}}function yt(a){let e,t;return e=new tt({props:{class:"main-card "+a[5],$$slots:{default:[vt]},$$scope:{ctx:a}}}),{c(){Re(e.$$.fragment)},l(r){Be(e.$$.fragment,r)},m(r,s){Ve(e,r,s),t=!0},p(r,[s]){const n={};s&32&&(n.class="main-card "+r[5]),s&95&&(n.$$scope={dirty:s,ctx:r}),e.$set(n)},i(r){t||(ke(e.$$.fragment,r),t=!0)},o(r){Pe(e.$$.fragment,r),t=!1},d(r){He(e,r)}}}function _t(a,e,t){let{frequency:r=0}=e,{note:s="ーー"}=e,{volume:n=0}=e,{isMuted:o=!1}=e,{muteMessage:i="待機中..."}=e,{className:l=""}=e;return a.$$set=c=>{"frequency"in c&&t(0,r=c.frequency),"note"in c&&t(1,s=c.note),"volume"in c&&t(2,n=c.volume),"isMuted"in c&&t(3,o=c.isMuted),"muteMessage"in c&&t(4,i=c.muteMessage),"className"in c&&t(5,l=c.className)},[r,s,n,o,i,l]}class St extends Ie{constructor(e){super(),Ne(this,e,_t,yt,Ee,{frequency:0,note:1,volume:2,isMuted:3,muteMessage:4,className:5})}}export{St as P,Ct as a,Se as b,we as h};
