var vt=Object.defineProperty;var yt=(r,e,t)=>e in r?vt(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var X=(r,e,t)=>yt(r,typeof e!="symbol"?e+"":e,t);import{S as Ge,i as We,s as Ue,d as le,n as tt,a as Qe,D as He,b as P,G as B,z as S,f as we,g as D,h as E,j as F,k as R,m as te,o as I,p as ne,F as wt,a0 as nt,K as st,q as Ke,r as Je,u as Xe,e as xe,w as Ye,l as Te,A as Ee,x as Ze,t as Fe,y as Oe}from"./DCAP7zA6.js";import{g as bt}from"./D0QH3NT1.js";import"./BgYJxd2z.js";import{C as rt}from"./BC444ZyH.js";function _t(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function Q(r){if(this.size=r|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=r<<1;for(var e=new Array(this.size*2),t=0;t<e.length;t+=2){const u=Math.PI*t/this.size;e[t]=Math.cos(u),e[t+1]=-Math.sin(u)}this.table=e;for(var o=0,n=1;this.size>n;n<<=1)o++;this._width=o%2===0?o-1:o,this._bitrev=new Array(1<<this._width);for(var s=0;s<this._bitrev.length;s++){this._bitrev[s]=0;for(var i=0;i<this._width;i+=2){var h=this._width-i-2;this._bitrev[s]|=(s>>>i&3)<<h}}this._out=null,this._data=null,this._inv=0}var pt=Q;Q.prototype.fromComplexArray=function(e,t){for(var o=t||new Array(e.length>>>1),n=0;n<e.length;n+=2)o[n>>>1]=e[n];return o};Q.prototype.createComplexArray=function(){const e=new Array(this._csize);for(var t=0;t<e.length;t++)e[t]=0;return e};Q.prototype.toComplexArray=function(e,t){for(var o=t||this.createComplexArray(),n=0;n<o.length;n+=2)o[n]=e[n>>>1],o[n+1]=0;return o};Q.prototype.completeSpectrum=function(e){for(var t=this._csize,o=t>>>1,n=2;n<o;n+=2)e[t-n]=e[n],e[t-n+1]=-e[n+1]};Q.prototype.transform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._transform4(),this._out=null,this._data=null};Q.prototype.realTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._realTransform4(),this._out=null,this._data=null};Q.prototype.inverseTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=1,this._transform4();for(var o=0;o<e.length;o++)e[o]/=this.size;this._out=null,this._data=null};Q.prototype._transform4=function(){var e=this._out,t=this._csize,o=this._width,n=1<<o,s=t/n<<1,i,h,u=this._bitrev;if(s===4)for(i=0,h=0;i<t;i+=s,h++){const v=u[h];this._singleTransform2(i,v,n)}else for(i=0,h=0;i<t;i+=s,h++){const v=u[h];this._singleTransform4(i,v,n)}var c=this._inv?-1:1,f=this.table;for(n>>=2;n>=2;n>>=2){s=t/n<<1;var g=s>>>2;for(i=0;i<t;i+=s)for(var m=i+g,b=i,l=0;b<m;b+=2,l+=n){const v=b,y=v+g,d=y+g,w=d+g,p=e[v],N=e[v+1],M=e[y],_=e[y+1],A=e[d],x=e[d+1],T=e[w],z=e[w+1],k=p,W=N,J=f[l],q=c*f[l+1],Z=M*J-_*q,K=M*q+_*J,L=f[2*l],ue=c*f[2*l+1],se=A*L-x*ue,oe=A*ue+x*L,re=f[3*l],O=c*f[3*l+1],ie=T*re-z*O,he=T*O+z*re,de=k+se,ae=W+oe,$=k-se,me=W-oe,ge=Z+ie,a=K+he,C=c*(Z-ie),V=c*(K-he),G=de+ge,j=ae+a,fe=de-ge,Ce=ae-a,be=$+V,De=me-C,Ae=$-V,ee=me+C;e[v]=G,e[v+1]=j,e[y]=be,e[y+1]=De,e[d]=fe,e[d+1]=Ce,e[w]=Ae,e[w+1]=ee}}};Q.prototype._singleTransform2=function(e,t,o){const n=this._out,s=this._data,i=s[t],h=s[t+1],u=s[t+o],c=s[t+o+1],f=i+u,g=h+c,m=i-u,b=h-c;n[e]=f,n[e+1]=g,n[e+2]=m,n[e+3]=b};Q.prototype._singleTransform4=function(e,t,o){const n=this._out,s=this._data,i=this._inv?-1:1,h=o*2,u=o*3,c=s[t],f=s[t+1],g=s[t+o],m=s[t+o+1],b=s[t+h],l=s[t+h+1],v=s[t+u],y=s[t+u+1],d=c+b,w=f+l,p=c-b,N=f-l,M=g+v,_=m+y,A=i*(g-v),x=i*(m-y),T=d+M,z=w+_,k=p+x,W=N-A,J=d-M,q=w-_,Z=p-x,K=N+A;n[e]=T,n[e+1]=z,n[e+2]=k,n[e+3]=W,n[e+4]=J,n[e+5]=q,n[e+6]=Z,n[e+7]=K};Q.prototype._realTransform4=function(){var e=this._out,t=this._csize,o=this._width,n=1<<o,s=t/n<<1,i,h,u=this._bitrev;if(s===4)for(i=0,h=0;i<t;i+=s,h++){const ke=u[h];this._singleRealTransform2(i,ke>>>1,n>>>1)}else for(i=0,h=0;i<t;i+=s,h++){const ke=u[h];this._singleRealTransform4(i,ke>>>1,n>>>1)}var c=this._inv?-1:1,f=this.table;for(n>>=2;n>=2;n>>=2){s=t/n<<1;var g=s>>>1,m=g>>>1,b=m>>>1;for(i=0;i<t;i+=s)for(var l=0,v=0;l<=b;l+=2,v+=n){var y=i+l,d=y+m,w=d+m,p=w+m,N=e[y],M=e[y+1],_=e[d],A=e[d+1],x=e[w],T=e[w+1],z=e[p],k=e[p+1],W=N,J=M,q=f[v],Z=c*f[v+1],K=_*q-A*Z,L=_*Z+A*q,ue=f[2*v],se=c*f[2*v+1],oe=x*ue-T*se,re=x*se+T*ue,O=f[3*v],ie=c*f[3*v+1],he=z*O-k*ie,de=z*ie+k*O,ae=W+oe,$=J+re,me=W-oe,ge=J-re,a=K+he,C=L+de,V=c*(K-he),G=c*(L-de),j=ae+a,fe=$+C,Ce=me+G,be=ge-V;if(e[y]=j,e[y+1]=fe,e[d]=Ce,e[d+1]=be,l===0){var De=ae-a,Ae=$-C;e[w]=De,e[w+1]=Ae;continue}if(l!==b){var ee=me,Ie=-ge,Be=ae,ze=-$,U=-c*G,Pe=-c*V,ut=-c*C,ht=-c*a,dt=ee+U,mt=Ie+Pe,ft=Be+ht,gt=ze-ut,$e=i+m-l,et=i+g-l;e[$e]=dt,e[$e+1]=mt,e[et]=ft,e[et+1]=gt}}}};Q.prototype._singleRealTransform2=function(e,t,o){const n=this._out,s=this._data,i=s[t],h=s[t+o],u=i+h,c=i-h;n[e]=u,n[e+1]=0,n[e+2]=c,n[e+3]=0};Q.prototype._singleRealTransform4=function(e,t,o){const n=this._out,s=this._data,i=this._inv?-1:1,h=o*2,u=o*3,c=s[t],f=s[t+o],g=s[t+h],m=s[t+u],b=c+g,l=c-g,v=f+m,y=i*(f-m),d=b+v,w=l,p=-y,N=b-v,M=l,_=y;n[e]=d,n[e+1]=0,n[e+2]=w,n[e+3]=p,n[e+4]=N,n[e+5]=0,n[e+6]=M,n[e+7]=_};const Mt=_t(pt);class Se{constructor(e,t){X(this,"_inputLength");X(this,"_fft");X(this,"_bufferSupplier");X(this,"_paddedInputBuffer");X(this,"_transformBuffer");X(this,"_inverseBuffer");if(e<1)throw new Error("Input length must be at least one");this._inputLength=e,this._fft=new Mt(At(2*e)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(e){return new Se(e,t=>new Float32Array(t))}static forFloat64Array(e){return new Se(e,t=>new Float64Array(t))}static forNumberArray(e){return new Se(e,t=>Array(t))}get inputLength(){return this._inputLength}autocorrelate(e,t=this._bufferSupplier(e.length)){if(e.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${e.length}`);for(let n=0;n<e.length;n++)this._paddedInputBuffer[n]=e[n];for(let n=e.length;n<this._paddedInputBuffer.length;n++)this._paddedInputBuffer[n]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const o=this._transformBuffer;for(let n=0;n<o.length;n+=2)o[n]=o[n]*o[n]+o[n+1]*o[n+1],o[n+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let n=0;n<e.length;n++)t[n]=this._inverseBuffer[2*n];return t}}function Ct(r){const e=[];let t=!1,o=-1/0,n=-1;for(let s=1;s<r.length-1;s++)r[s-1]<=0&&r[s]>0?(t=!0,n=s,o=r[s]):r[s-1]>0&&r[s]<=0?(t=!1,n!==-1&&e.push(n)):t&&r[s]>o&&(o=r[s],n=s);return e}function Dt(r,e){const[t,o,n]=[r-1,r,r+1],[s,i,h]=[e[t],e[o],e[n]],u=s/2-i+h/2,c=-(s/2)*(o+n)+i*(t+n)-h/2*(t+o),f=s*o*n/2-i*t*n+h*t*o/2,g=-c/(2*u),m=u*g*g+c*g+f;return[g,m]}class Me{constructor(e,t){X(this,"_autocorrelator");X(this,"_nsdfBuffer");X(this,"_clarityThreshold",.9);X(this,"_minVolumeAbsolute",0);X(this,"_maxInputAmplitude",1);this._autocorrelator=new Se(e,t),this._nsdfBuffer=t(e)}static forFloat32Array(e){return new Me(e,t=>new Float32Array(t))}static forFloat64Array(e){return new Me(e,t=>new Float64Array(t))}static forNumberArray(e){return new Me(e,t=>Array(t))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(e){if(!Number.isFinite(e)||e<=0||e>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=e}set minVolumeAbsolute(e){if(!Number.isFinite(e)||e<0||e>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=e}set minVolumeDecibels(e){if(!Number.isFinite(e)||e>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(e/10)}set maxInputAmplitude(e){if(!Number.isFinite(e)||e<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=e}findPitch(e,t){if(this._belowMinimumVolume(e))return[0,0];this._nsdf(e);const o=Ct(this._nsdfBuffer);if(o.length===0)return[0,0];const n=Math.max(...o.map(u=>this._nsdfBuffer[u])),s=o.find(u=>this._nsdfBuffer[u]>=this._clarityThreshold*n),[i,h]=Dt(s,this._nsdfBuffer);return[t/i,Math.min(h,1)]}_belowMinimumVolume(e){if(this._minVolumeAbsolute===0)return!1;let t=0;for(let o=0;o<e.length;o++)t+=e[o]**2;return Math.sqrt(t/e.length)<this._minVolumeAbsolute}_nsdf(e){this._autocorrelator.autocorrelate(e,this._nsdfBuffer);let t=2*this._nsdfBuffer[0],o;for(o=0;o<this._nsdfBuffer.length&&t>0;o++)this._nsdfBuffer[o]=2*this._nsdfBuffer[o]/t,t-=e[o]**2+e[e.length-o-1]**2;for(;o<this._nsdfBuffer.length;o++)this._nsdfBuffer[o]=0}}function At(r){return r--,r|=r>>1,r|=r>>2,r|=r>>4,r|=r>>8,r|=r>>16,r++,r}const Ne="src/lib/components/VolumeBar.svelte";function Re(r){let e,t,o,n,s,i;const h={c:function(){e=I("div"),t=I("div"),o=I("div"),n=ne(),s=I("div"),this.h()},l:function(c){e=F(c,"DIV",{class:!0});var f=R(e);t=F(f,"DIV",{class:!0,style:!0});var g=R(t);o=F(g,"DIV",{class:!0,style:!0}),R(o).forEach(P),g.forEach(P),n=te(f),s=F(f,"DIV",{class:!0,style:!0}),R(s).forEach(P),f.forEach(P),this.h()},h:function(){S(o,"class","volume-bar-fill"),B(o,"position","absolute"),B(o,"top","0"),B(o,"left","0"),B(o,"height","100%"),E(o,Ne,51,4,1464),S(t,"class","volume-bar-bg"),B(t,"height",r[1]),B(t,"border-radius","9999px"),B(t,"background-color","#e2e8f0"),B(t,"position","relative"),B(t,"overflow","hidden"),E(t,Ne,50,2,1318),S(s,"class","threshold-indicator svelte-13z7ppf"),B(s,"position","absolute"),B(s,"top","0"),B(s,"left",r[0]+"%"),B(s,"width","2px"),B(s,"height",r[1]),B(s,"background-color","#64748b"),B(s,"border-radius","1px"),E(s,Ne,59,2,1643),S(e,"class",i="volume-bar-container "+r[2]+" svelte-13z7ppf"),E(e,Ne,49,0,1269)},m:function(c,f){we(c,e,f),D(e,t),D(t,o),r[5](o),D(e,n),D(e,s)},p:function(c,[f]){f&2&&B(t,"height",c[1]),f&1&&B(s,"left",c[0]+"%"),f&2&&B(s,"height",c[1]),f&4&&i!==(i="volume-bar-container "+c[2]+" svelte-13z7ppf")&&S(e,"class",i)},i:tt,o:tt,d:function(c){c&&P(e),r[5](null)}};return le("SvelteRegisterBlock",{block:h,id:Re.name,type:"component",source:"",ctx:r}),h}function Pt(r,e,t){let{$$slots:o={},$$scope:n}=e;Qe("VolumeBar",o,[]);let{volume:s=0}=e,{threshold:i=30}=e,{height:h="12px"}=e,{className:u=""}=e,c;function f(l){return l<i?`rgba(37, 99, 235, ${Math.max(.2,l/i*.8)})`:"#2563eb"}function g(l){if(c){const v=Math.max(0,Math.min(100,l)),y=f(v);t(3,c.style.width=`${v}%`,c),t(3,c.style.backgroundColor=y,c)}}He(()=>{c&&(t(3,c.style.width="0%",c),t(3,c.style.backgroundColor="#2563eb",c),t(3,c.style.height=h,c),t(3,c.style.borderRadius="9999px",c),t(3,c.style.transition="width 0.2s ease-out, background-color 0.2s ease-out",c))});const m=["volume","threshold","height","className"];Object.keys(e).forEach(l=>{!~m.indexOf(l)&&l.slice(0,2)!=="$$"&&l!=="slot"&&console.warn(`<VolumeBar> was created with unknown prop '${l}'`)});function b(l){wt[l?"unshift":"push"](()=>{c=l,t(3,c)})}return r.$$set=l=>{"volume"in l&&t(4,s=l.volume),"threshold"in l&&t(0,i=l.threshold),"height"in l&&t(1,h=l.height),"className"in l&&t(2,u=l.className)},r.$capture_state=()=>({onMount:He,volume:s,threshold:i,height:h,className:u,barElement:c,getVolumeColor:f,updateVolumeBar:g}),r.$inject_state=l=>{"volume"in l&&t(4,s=l.volume),"threshold"in l&&t(0,i=l.threshold),"height"in l&&t(1,h=l.height),"className"in l&&t(2,u=l.className),"barElement"in l&&t(3,c=l.barElement)},e&&"$$inject"in e&&r.$inject_state(e.$$inject),r.$$.update=()=>{r.$$.dirty&16&&g(s)},[i,h,u,c,s,b]}class Ve extends Ge{constructor(e){super(e),We(this,e,Pt,Re,Ue,{volume:4,threshold:0,height:1,className:2}),le("SvelteRegisterComponent",{component:this,tagName:"VolumeBar",options:e,id:Re.name})}get volume(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set volume(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get threshold(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set threshold(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get height(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set height(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}class St{constructor(){this.audioContext=null,this.mediaStream=null,this.sourceNode=null,this.analysers=new Map,this.filters=new Map,this.refCount=0,this.initPromise=null,this.isInitialized=!1,this.lastError=null}async initialize(){var e,t,o;if(this.initPromise)return this.initPromise;if(this.isInitialized&&this.audioContext&&this.mediaStream){const n=this.checkMediaStreamHealth();if(n.healthy)return this.refCount++,{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode};console.warn("⚠️ [AudioManager] MediaStream不健康検出 - 強制再初期化:",n.reason),console.log("🔄 [AudioManager] 不健康なMediaStream詳細:",{mediaStreamActive:(e=this.mediaStream)==null?void 0:e.active,trackCount:(t=this.mediaStream)==null?void 0:t.getTracks().length,trackStates:(o=this.mediaStream)==null?void 0:o.getTracks().map(s=>({kind:s.kind,readyState:s.readyState,enabled:s.enabled,muted:s.muted}))}),this._cleanup(),this.isInitialized=!1,this.refCount=0,await new Promise(s=>setTimeout(s,100)),console.log("🔄 [AudioManager] クリーンアップ完了 - 再初期化開始")}this.initPromise=this._doInitialize();try{const n=await this.initPromise;return this.initPromise=null,n}catch(n){throw this.initPromise=null,n}}async _doInitialize(){try{if(console.log("🎤 [AudioManager] 初期化開始"),this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),console.log("✅ [AudioManager] AudioContext作成完了")),this.audioContext.state==="suspended"&&(await this.audioContext.resume(),console.log("✅ [AudioManager] AudioContext再開完了")),!this.mediaStream){const e={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,sampleRate:44100,channelCount:1,sampleSize:16,latency:.1,volume:1,deviceId:{ideal:"default"}}};console.log("🎤 [AudioManager] Safari対応設定でMediaStream取得中:",e),this.mediaStream=await navigator.mediaDevices.getUserMedia(e),console.log("✅ [AudioManager] MediaStream取得完了")}if(!this.sourceNode){this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),console.log("✅ [AudioManager] SourceNode作成完了");const e=this.mediaStream.getTracks();console.log("🎤 [AudioManager] MediaStream tracks:",e.map(t=>({kind:t.kind,label:t.label,enabled:t.enabled,readyState:t.readyState,muted:t.muted})))}return this.isInitialized=!0,this.refCount++,this.lastError=null,console.log(`🎤 [AudioManager] 初期化完了 (参照カウント: ${this.refCount})`),{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode}}catch(e){throw console.error("❌ [AudioManager] 初期化エラー:",e),this.lastError=e,this.isInitialized=!1,this._cleanup(),e}}createAnalyser(e,t={}){if(!this.isInitialized||!this.audioContext||!this.sourceNode)throw new Error("AudioManager not initialized. Call initialize() first.");this.removeAnalyser(e);const{fftSize:o=2048,smoothingTimeConstant:n=.8,minDecibels:s=-90,maxDecibels:i=-10,useFilters:h=!0}=t,u=this.audioContext.createAnalyser();if(u.fftSize=Math.min(o,2048),u.smoothingTimeConstant=Math.max(n,.7),u.minDecibels=Math.max(s,-80),u.maxDecibels=Math.min(i,-10),this.sourceNode,h){const c=this._createFilterChain();this.filters.set(e,c),this.sourceNode.connect(c.highpass),c.highpass.connect(c.lowpass),c.lowpass.connect(c.notch),c.notch.connect(u),console.log(`🔧 [AudioManager] フィルター付きAnalyser作成: ${e}`)}else this.sourceNode.connect(u),console.log(`🔧 [AudioManager] 生信号Analyser作成: ${e}`);return this.analysers.set(e,u),u}_createFilterChain(){const e=this.audioContext.createBiquadFilter();e.type="highpass",e.frequency.setValueAtTime(80,this.audioContext.currentTime),e.Q.setValueAtTime(.7,this.audioContext.currentTime);const t=this.audioContext.createBiquadFilter();t.type="lowpass",t.frequency.setValueAtTime(800,this.audioContext.currentTime),t.Q.setValueAtTime(.7,this.audioContext.currentTime);const o=this.audioContext.createBiquadFilter();return o.type="notch",o.frequency.setValueAtTime(60,this.audioContext.currentTime),o.Q.setValueAtTime(10,this.audioContext.currentTime),{highpass:e,lowpass:t,notch:o}}removeAnalyser(e){if(this.analysers.has(e)&&(this.analysers.get(e).disconnect(),this.analysers.delete(e),console.log(`🗑️ [AudioManager] Analyser削除: ${e}`)),this.filters.has(e)){const t=this.filters.get(e);t.highpass.disconnect(),t.lowpass.disconnect(),t.notch.disconnect(),this.filters.delete(e),console.log(`🗑️ [AudioManager] フィルターチェーン削除: ${e}`)}}release(e=[]){e.forEach(t=>this.removeAnalyser(t)),this.refCount=Math.max(0,this.refCount-1),console.log(`📉 [AudioManager] 参照カウント減算: ${this.refCount}`),this.refCount<=0&&(console.log("🧹 [AudioManager] 全リソースクリーンアップ開始"),this._cleanup())}forceCleanup(){console.log("🚨 [AudioManager] 強制クリーンアップ実行"),this._cleanup()}_cleanup(){console.log("🧹 [AudioManager] クリーンアップ開始");for(const e of this.analysers.keys())this.removeAnalyser(e);if(this.mediaStream){const e=this.mediaStream.getTracks();console.log(`🛑 [AudioManager] MediaStream停止中: ${e.length} tracks`),e.forEach((t,o)=>{try{t.readyState!=="ended"?(t.stop(),console.log(`🛑 [AudioManager] Track ${o} 停止完了`)):console.log(`⚠️ [AudioManager] Track ${o} 既に終了済み`)}catch(n){console.warn(`⚠️ [AudioManager] Track ${o} 停止エラー:`,n)}}),this.mediaStream=null}if(this.audioContext&&this.audioContext.state!=="closed"){try{this.audioContext.close(),console.log("🛑 [AudioManager] AudioContext閉鎖完了")}catch(e){console.warn("⚠️ [AudioManager] AudioContext閉鎖エラー:",e)}this.audioContext=null}this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.isInitialized=!1,this.refCount=0,this.initPromise=null,console.log("✅ [AudioManager] クリーンアップ完了")}getStatus(){var e,t;return{isInitialized:this.isInitialized,refCount:this.refCount,audioContextState:((e=this.audioContext)==null?void 0:e.state)||"none",mediaStreamActive:((t=this.mediaStream)==null?void 0:t.active)||!1,activeAnalysers:Array.from(this.analysers.keys()),activeFilters:Array.from(this.filters.keys()),lastError:this.lastError}}checkMediaStreamHealth(){if(!this.mediaStream)return{healthy:!1,reason:"MediaStream not initialized"};if(!this.mediaStream.active)return{healthy:!1,reason:"MediaStream inactive"};const e=this.mediaStream.getTracks();if(e.length===0)return{healthy:!1,reason:"No tracks available"};const t=e.find(o=>o.kind==="audio");return t?t.readyState==="ended"?{healthy:!1,reason:"Audio track ended"}:t.enabled?t.muted?{healthy:!1,reason:"Audio track muted"}:this.mediaStream.active&&t.readyState!=="live"?{healthy:!1,reason:"Track state inconsistent with MediaStream"}:{healthy:!0,track:t}:{healthy:!1,reason:"Audio track disabled"}:{healthy:!1,reason:"No audio track found"}}}const _e=new St;typeof window<"u"&&(window.audioManager=_e);class xt{constructor(e={}){this.vocalRangeMin=e.vocalRangeMin||130.81,this.vocalRangeMax=e.vocalRangeMax||1046.5,this.stabilityThreshold=e.stabilityThreshold||.3,this.evaluationWeights={vocalRange:e.vocalRangeWeight||.4,continuity:e.continuityWeight||.4,musical:e.musicalWeight||.2},this.fundamentalCandidates=e.fundamentalCandidates||[1,.5,.333,2],this.harmonicHistory=[],this.previousFrequency=0,this.maxHistoryLength=5,this.debugMode=!1,this.volumeThreshold=e.volumeThreshold||.02,this.currentContext={}}correctHarmonic(e,t=1,o=!1){if(!e||e<=0)return 0;const n=t>=this.volumeThreshold,i=this.fundamentalCandidates.map(c=>({frequency:e*c,ratio:c})).map(c=>{const f=this.evaluateFundamental(c.frequency);return{...c,...f}}),h=i.reduce((c,f)=>f.totalScore>c.totalScore?f:c),u=this.stabilizeFrequency(h.frequency,n);return(o||this.debugMode)&&this.logHarmonicCorrection(e,i,h,u,this.currentContext,t,n),n&&(this.previousFrequency=u),u}logHarmonicCorrection(e,t,o,n,s={},i=1,h=!0){}getCorrectionType(e){return Math.abs(e-1)<.01?"補正なし（基音）":Math.abs(e-.5)<.01?"2倍音補正（1オクターブ下）":Math.abs(e-.333)<.01?"3倍音補正（1オクターブ+5度下）":Math.abs(e-.25)<.01?"4倍音補正（2オクターブ下）":Math.abs(e-2)<.01?"オクターブ上補正":`カスタム補正（${e.toFixed(3)}x）`}frequencyToNote(e){if(!e||e<=0)return"---";const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=Math.round(12*Math.log2(e/440)),s=(n+9+120)%12,i=Math.floor((n+9)/12)+4;return t[s]+i}evaluateFundamental(e){const o=e>=this.vocalRangeMin&&e<=this.vocalRangeMax?1:0,n=this.previousFrequency>0?1-Math.min(Math.abs(e-this.previousFrequency)/this.previousFrequency,1):.5,s=this.calculateMusicalScore(e),i=o*this.evaluationWeights.vocalRange+n*this.evaluationWeights.continuity+s*this.evaluationWeights.musical;return{vocalRangeScore:o,continuityScore:n,musicalScore:s,totalScore:i}}calculateMusicalScore(e){const o=Math.log2(e/261.63)*12,n=Math.round(o),s=Math.abs(o-n);return Math.max(0,1-s/.5)}stabilizeFrequency(e,t=!0){if(!e||e<=0)return 0;if(t&&this.harmonicHistory.push(e),this.harmonicHistory.length>this.maxHistoryLength&&this.harmonicHistory.shift(),this.harmonicHistory.length<2)return e;const o=[...this.harmonicHistory].sort((h,u)=>h-u),n=o[Math.floor(o.length/2)],s=n*this.stabilityThreshold;return Math.abs(e-n)>s?n+Math.sign(e-n)*s:e}resetHistory(){this.harmonicHistory=[],this.previousFrequency=0}updateConfig(e){Object.assign(this,e),console.log("⚙️ [HarmonicCorrection] 設定更新:",e)}enableDebugLogging(){this.debugMode=!0,console.log("🔍 [HarmonicCorrection] デバッグログ有効化 - 次回の補正から詳細ログを出力します"),console.log("無効化するには: harmonicCorrection.disableDebugLogging()")}disableDebugLogging(){this.debugMode=!1,console.log("🔍 [HarmonicCorrection] デバッグログ無効化")}setScaleContext(e){this.currentContext={baseFrequency:e.baseFrequency,currentScale:e.currentScale,targetFrequency:e.targetFrequency}}clearContext(){this.currentContext={}}getStatus(){return{vocalRangeMin:this.vocalRangeMin,vocalRangeMax:this.vocalRangeMax,stabilityThreshold:this.stabilityThreshold,evaluationWeights:this.evaluationWeights,historyLength:this.harmonicHistory.length,previousFrequency:this.previousFrequency,recentHistory:this.harmonicHistory.slice(-3)}}}const pe=new xt;typeof window<"u"&&(window.harmonicCorrection=pe);const it=(()=>{if(typeof window<"u"){const e=new URLSearchParams(window.location.search).get("debug");if(e)return e}return"info"})(),ce={error:0,warn:1,info:2,debug:3},ve=ce[it]??ce.info,qe={error:(r,...e)=>{ve>=ce.error&&console.error(`❌ ${r}`,...e)},warn:(r,...e)=>{ve>=ce.warn&&console.warn(`⚠️ ${r}`,...e)},info:(r,...e)=>{ve>=ce.info&&console.log(`ℹ️ ${r}`,...e)},debug:(r,...e)=>{ve>=ce.debug&&console.log(`🔍 ${r}`,...e)},realtime:(()=>{let r=0;const e=1e3;return(t,...o)=>{if(ve>=ce.debug){const n=Date.now();n-r>=e&&(console.log(`📊 ${t}`,...o),r=n)}}})(),scoring:(r,...e)=>{ve>=ce.info&&console.log(`🎯 ${r}`,...e)},audio:(r,...e)=>{ve>=ce.info&&console.log(`🎤 ${r}`,...e)}};typeof import.meta<"u"&&qe.info(`Debug Level: ${it} (Change with ?debug=level)`);const{Error:H,console:Tt}=bt,ye="src/lib/components/PitchDetector.svelte";function Le(r){let e,t,o,n,s=(r[2]>0?Math.round(r[2]):"---")+"",i,h,u,c="Hz",f,g,m="|",b,l,v,y,d,w,p;d=new Ve({props:{volume:r[2]>0?r[1]:0,className:"volume-bar"},$$inline:!0});const N={c:function(){e=I("div"),t=I("div"),o=I("div"),n=I("span"),i=Fe(s),h=ne(),u=I("span"),u.textContent=c,f=ne(),g=I("span"),g.textContent=m,b=ne(),l=I("span"),v=Fe(r[3]),y=ne(),Oe(d.$$.fragment),this.h()},l:function(_){e=F(_,"DIV",{class:!0});var A=R(e);t=F(A,"DIV",{class:!0});var x=R(t);o=F(x,"DIV",{class:!0});var T=R(o);n=F(T,"SPAN",{class:!0});var z=R(n);i=Te(z,s),z.forEach(P),h=te(T),u=F(T,"SPAN",{class:!0,"data-svelte-h":!0}),Ee(u)!=="svelte-5uyilv"&&(u.textContent=c),f=te(T),g=F(T,"SPAN",{class:!0,"data-svelte-h":!0}),Ee(g)!=="svelte-1dytxz4"&&(g.textContent=m),b=te(T),l=F(T,"SPAN",{class:!0});var k=R(l);v=Te(k,r[3]),k.forEach(P),T.forEach(P),y=te(x),Ze(d.$$.fragment,x),x.forEach(P),A.forEach(P),this.h()},h:function(){S(n,"class","detected-frequency svelte-vc1bho"),E(n,ye,528,6,15447),S(u,"class","hz-suffix svelte-vc1bho"),E(u,ye,529,6,15555),S(g,"class","divider svelte-vc1bho"),E(g,ye,530,6,15595),S(l,"class","detected-note svelte-vc1bho"),E(l,ye,531,6,15632),S(o,"class","detection-card svelte-vc1bho"),E(o,ye,527,4,15412),S(t,"class","detection-display svelte-vc1bho"),E(t,ye,526,2,15376),S(e,"class",w="pitch-detector "+r[0]+" svelte-vc1bho"),E(e,ye,525,0,15333)},m:function(_,A){we(_,e,A),D(e,t),D(t,o),D(o,n),D(n,i),D(o,h),D(o,u),D(o,f),D(o,g),D(o,b),D(o,l),D(l,v),D(t,y),Ye(d,t,null),p=!0},p:function(_,A){(!p||A[0]&4)&&s!==(s=(_[2]>0?Math.round(_[2]):"---")+"")&&xe(i,s),(!p||A[0]&8)&&xe(v,_[3]);const x={};A[0]&6&&(x.volume=_[2]>0?_[1]:0),d.$set(x),(!p||A[0]&1&&w!==(w="pitch-detector "+_[0]+" svelte-vc1bho"))&&S(e,"class",w)},i:function(_){p||(Xe(d.$$.fragment,_),p=!0)},o:function(_){Je(d.$$.fragment,_),p=!1},d:function(_){_&&P(e),Ke(d)}};return le("SvelteRegisterBlock",{block:N,id:Le.name,type:"component",source:"",ctx:r}),N}function ot(r){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(r<=0)return"ーー";const o=Math.round(12*Math.log2(r/440)),n=(o+9+120)%12,s=Math.floor((o+9)/12)+4;return e[n]+s}function Et(r,e,t){let{$$slots:o={},$$scope:n}=e;Qe("PitchDetector",o,[]);const s=nt();let{isActive:i=!1}=e,{className:h=""}=e,{debugMode:u=!1}=e,{trainingPhase:c=""}=e,{disableHarmonicCorrection:f=!1}=e,g="uninitialized",m=null,b=!1,l=null,v=null,y=null,d=null,w=null,p=null,N=null,M=!1,_=[],A=new Map,x=0,T=0,z=0,k="ーー",W=0,J=[],q=[],Z=0,K=0,L=null;function ue(){x=0,t(1,T=0),t(2,z=0),t(3,k="ーー"),W=0,Z=0,K=0,J=[],q=[],pe.resetHistory(),u&&console.log("🔄 [PitchDetector] Display state reset")}function se(){if(!u)return;const a=new Date().toLocaleTimeString(),C={timestamp:a,componentState:g,isActive:i,isDetecting:M,isInitialized:b,mediaStreamActive:v?v.active:null,mediaStreamTracks:v?v.getTracks().length:0,trackStates:v?v.getTracks().map(j=>({kind:j.kind,enabled:j.enabled,readyState:j.readyState,muted:j.muted})):[],audioContextState:l?l.state:null,hasAnalyser:!!d,currentVolume:x,currentFrequency:z};qe.realtime(`[PitchDetector] ${a}:`,C);let V=!0,G=[];v&&!v.active&&(console.warn("⚠️ [PitchDetector] MediaStream is inactive!",v),V=!1,G.push("MediaStream inactive")),l&&l.state==="suspended"&&(console.warn("⚠️ [PitchDetector] AudioContext is suspended!",l),V=!1,G.push("AudioContext suspended")),v&&v.getTracks().forEach((j,fe)=>{j.readyState==="ended"&&(console.error(`❌ [PitchDetector] Track ${fe} has ended!`,j),V=!1,G.push(`Track ${fe} ended`))}),s("microphoneHealthChange",{healthy:V,errors:G,details:C})}async function oe(){try{t(16,g="initializing"),m=null,console.log("🎙️ [PitchDetector] AudioManager経由で初期化開始");const a=await _e.initialize();l=a.audioContext,v=a.mediaStream,y=a.sourceNode,console.log("✅ [PitchDetector] AudioManager リソース取得完了");const C=`pitch-detector-filtered-${Date.now()}`;t(17,d=_e.createAnalyser(C,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!0})),_.push(C);const V=`pitch-detector-raw-${Date.now()}`;w=_e.createAnalyser(V,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!1}),_.push(V),console.log("✅ [PitchDetector] Analyser作成完了:",_),p=Me.forFloat32Array(d.fftSize),t(16,g="ready"),b=!0,s("stateChange",{state:g}),me(),console.log("✅ [PitchDetector] 初期化完了")}catch(a){throw console.error("❌ [PitchDetector] 初期化エラー:",a),t(16,g="error"),m=a,b=!1,s("error",{error:a,context:"initialization"}),a}}function re(){if(g!=="ready"){const a=new Error(`Cannot start detection: component state is ${g}`);return s("error",{error:a,context:"start-detection"}),!1}if(!d||!p||!l){const a=new Error("Required components not available");return t(16,g="error"),s("error",{error:a,context:"start-detection"}),!1}return t(16,g="detecting"),t(18,M=!0),s("stateChange",{state:g}),ie(),!0}function O(){t(18,M=!1),N&&(cancelAnimationFrame(N),N=null),g==="detecting"&&b&&(t(16,g="ready"),s("stateChange",{state:g}))}function ie(){if(!M||!d||!w||!p)return;const a=d.fftSize,C=new Float32Array(a),V=new Float32Array(w.fftSize);d.getFloatTimeDomainData(C),w.getFloatTimeDomainData(V);let G=0;for(let U=0;U<a;U++)G+=Math.abs(C[U]);const j=Math.sqrt(G/a),fe=Math.log10(j+.001)*50+100,Ce=Math.max(0,Math.min(100,fe));let be=0;for(let U=0;U<V.length;U++)be+=Math.abs(V[U]);const De=Math.sqrt(be/V.length),Ae=Math.log10(De+.001)*50+100;t(1,T=Math.max(0,Math.min(100,Ae))),q.push(Ce),q.length>5&&q.shift(),K=q.reduce((U,Pe)=>U+Pe,0)/q.length,x=K;const[ee,Ie]=p.findPitch(C,l.sampleRate),Be=ee>=65&&ee<=1200;if(ee&&Ie>.8&&x>30&&Be){let U=ee;if(f)u&&console.log("🔧 [PitchDetector] ハーモニック補正無効化中 - 生値使用:",ee);else{const Pe=Math.min(x/100,1);U=pe.correctHarmonic(ee,Pe)}t(2,z=Math.round(U)),t(3,k=ot(z)),W=Ie}else z===0&&pe.resetHistory(),t(2,z=0),t(3,k="ーー"),W=0;const ze=z>0?T:0;s("pitchUpdate",{frequency:z,note:k,volume:ze,rawVolume:ze,clarity:W}),N=requestAnimationFrame(ie)}function he(){return b&&g==="ready"}function de(){return{componentState:g,isInitialized:b,isDetecting:M,lastError:m,hasRequiredComponents:!!(d&&p&&l&&v)}}async function ae(){console.log("🔄 [PitchDetector] 再初期化開始"),$(),await new Promise(a=>setTimeout(a,100)),await oe(),console.log("✅ [PitchDetector] 再初期化完了")}function $(){console.log("🧹 [PitchDetector] クリーンアップ開始"),O(),A.size>0&&(A.forEach((a,C)=>{C.removeEventListener("ended",a.endedHandler),C.removeEventListener("mute",a.muteHandler),C.removeEventListener("unmute",a.unmuteHandler)}),A.clear(),console.log("🔄 [PitchDetector] MediaStreamイベントリスナー削除")),_.length>0&&(_e.release(_),console.log("📤 [PitchDetector] AudioManagerにAnalyser解放通知:",_),_=[]),t(16,g="uninitialized"),b=!1,m=null,l=null,v=null,y=null,t(17,d=null),w=null,p=null,J=[],q=[],pe.resetHistory(),console.log("✅ [PitchDetector] クリーンアップ完了")}function me(){if(!v)return;const a=v.getTracks();a.forEach(C=>{const V=()=>{console.error("🚨 [PitchDetector] MediaStreamTrack終了検出:",C.kind),t(16,g="error"),m=new Error(`MediaStreamTrack (${C.kind}) ended`),s("error",{error:m,reason:"mediastream_ended",recovery:"restart_required"}),M&&O()},G=()=>{console.warn("⚠️ [PitchDetector] MediaStreamTrack muted:",C.kind),s("warning",{reason:"track_muted",track:C.kind})},j=()=>{console.log("✅ [PitchDetector] MediaStreamTrack unmuted:",C.kind),s("info",{reason:"track_unmuted",track:C.kind})};C.addEventListener("ended",V),C.addEventListener("mute",G),C.addEventListener("unmute",j),A.set(C,{endedHandler:V,muteHandler:G,unmuteHandler:j})}),console.log("🔍 [PitchDetector] MediaStream監視開始:",a.length+" tracks")}st(()=>{L&&(clearInterval(L),t(19,L=null)),console.log("🔄 [PitchDetector] onDestroy - AudioManagerリソースは保持")});const ge=["isActive","className","debugMode","trainingPhase","disableHarmonicCorrection"];return Object.keys(e).forEach(a=>{!~ge.indexOf(a)&&a.slice(0,2)!=="$$"&&a!=="slot"&&Tt.warn(`<PitchDetector> was created with unknown prop '${a}'`)}),r.$$set=a=>{"isActive"in a&&t(4,i=a.isActive),"className"in a&&t(0,h=a.className),"debugMode"in a&&t(5,u=a.debugMode),"trainingPhase"in a&&t(6,c=a.trainingPhase),"disableHarmonicCorrection"in a&&t(7,f=a.disableHarmonicCorrection)},r.$capture_state=()=>({onMount:He,onDestroy:st,createEventDispatcher:nt,PitchDetector:Me,VolumeBar:Ve,audioManager:_e,harmonicCorrection:pe,logger:qe,dispatch:s,isActive:i,className:h,debugMode:u,trainingPhase:c,disableHarmonicCorrection:f,componentState:g,lastError:m,isInitialized:b,audioContext:l,mediaStream:v,sourceNode:y,analyser:d,rawAnalyser:w,pitchDetector:p,animationFrame:N,isDetecting:M,analyserIds:_,mediaStreamListeners:A,currentVolume:x,rawVolume:T,currentFrequency:z,detectedNote:k,pitchClarity:W,frequencyHistory:J,volumeHistory:q,stableFrequency:Z,stableVolume:K,debugInterval:L,resetDisplayState:ue,checkMicrophoneStatus:se,initialize:oe,startDetection:re,stopDetection:O,detectPitch:ie,frequencyToNote:ot,getIsInitialized:he,getState:de,reinitialize:ae,cleanup:$,setupMediaStreamMonitoring:me}),r.$inject_state=a=>{"isActive"in a&&t(4,i=a.isActive),"className"in a&&t(0,h=a.className),"debugMode"in a&&t(5,u=a.debugMode),"trainingPhase"in a&&t(6,c=a.trainingPhase),"disableHarmonicCorrection"in a&&t(7,f=a.disableHarmonicCorrection),"componentState"in a&&t(16,g=a.componentState),"lastError"in a&&(m=a.lastError),"isInitialized"in a&&(b=a.isInitialized),"audioContext"in a&&(l=a.audioContext),"mediaStream"in a&&(v=a.mediaStream),"sourceNode"in a&&(y=a.sourceNode),"analyser"in a&&t(17,d=a.analyser),"rawAnalyser"in a&&(w=a.rawAnalyser),"pitchDetector"in a&&(p=a.pitchDetector),"animationFrame"in a&&(N=a.animationFrame),"isDetecting"in a&&t(18,M=a.isDetecting),"analyserIds"in a&&(_=a.analyserIds),"mediaStreamListeners"in a&&(A=a.mediaStreamListeners),"currentVolume"in a&&(x=a.currentVolume),"rawVolume"in a&&t(1,T=a.rawVolume),"currentFrequency"in a&&t(2,z=a.currentFrequency),"detectedNote"in a&&t(3,k=a.detectedNote),"pitchClarity"in a&&(W=a.pitchClarity),"frequencyHistory"in a&&(J=a.frequencyHistory),"volumeHistory"in a&&(q=a.volumeHistory),"stableFrequency"in a&&(Z=a.stableFrequency),"stableVolume"in a&&(K=a.stableVolume),"debugInterval"in a&&t(19,L=a.debugInterval)},e&&"$$inject"in e&&r.$inject_state(e.$$inject),r.$$.update=()=>{r.$$.dirty[0]&524320&&(u&&!L?(console.log("🔍 [PitchDetector] Debug mode enabled - starting status monitoring"),t(19,L=setInterval(se,3e3)),se()):!u&&L&&(console.log("🔍 [PitchDetector] Debug mode disabled - stopping status monitoring"),clearInterval(L),t(19,L=null))),r.$$.dirty[0]&458768&&(i&&g==="ready"&&d&&!M?re():!i&&M&&O())},[h,T,z,k,i,u,c,f,ue,oe,re,O,he,de,ae,$,g,d,M,L]}class kt extends Ge{constructor(e){super(e),We(this,e,Et,Le,Ue,{isActive:4,className:0,debugMode:5,trainingPhase:6,disableHarmonicCorrection:7,resetDisplayState:8,initialize:9,startDetection:10,stopDetection:11,getIsInitialized:12,getState:13,reinitialize:14,cleanup:15},null,[-1,-1]),le("SvelteRegisterComponent",{component:this,tagName:"PitchDetector_1",options:e,id:Le.name})}get isActive(){throw new H("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set isActive(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new H("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get debugMode(){throw new H("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set debugMode(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get trainingPhase(){throw new H("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set trainingPhase(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get disableHarmonicCorrection(){throw new H("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set disableHarmonicCorrection(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get resetDisplayState(){return this.$$.ctx[8]}set resetDisplayState(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get initialize(){return this.$$.ctx[9]}set initialize(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get startDetection(){return this.$$.ctx[10]}set startDetection(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get stopDetection(){return this.$$.ctx[11]}set stopDetection(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get getIsInitialized(){return this.$$.ctx[12]}set getIsInitialized(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get getState(){return this.$$.ctx[13]}set getState(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get reinitialize(){return this.$$.ctx[14]}set reinitialize(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get cleanup(){return this.$$.ctx[15]}set cleanup(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}const Y="src/lib/components/PitchDetectionDisplay.svelte";function at(r){let e,t,o=(r[0]>0?Math.round(r[0]):"---")+"",n,s,i,h="Hz",u,c,f="|",g,m,b;const l={c:function(){e=I("div"),t=I("span"),n=Fe(o),s=ne(),i=I("span"),i.textContent=h,u=ne(),c=I("span"),c.textContent=f,g=ne(),m=I("span"),b=Fe(r[1]),this.h()},l:function(y){e=F(y,"DIV",{class:!0});var d=R(e);t=F(d,"SPAN",{class:!0});var w=R(t);n=Te(w,o),w.forEach(P),s=te(d),i=F(d,"SPAN",{class:!0,"data-svelte-h":!0}),Ee(i)!=="svelte-5uyilv"&&(i.textContent=h),u=te(d),c=F(d,"SPAN",{class:!0,"data-svelte-h":!0}),Ee(c)!=="svelte-1dytxz4"&&(c.textContent=f),g=te(d),m=F(d,"SPAN",{class:!0});var p=R(m);b=Te(p,r[1]),p.forEach(P),d.forEach(P),this.h()},h:function(){S(t,"class","detected-frequency svelte-1datf0r"),E(t,Y,25,14,712),S(i,"class","hz-suffix svelte-1datf0r"),E(i,Y,26,14,814),S(c,"class","divider svelte-1datf0r"),E(c,Y,27,14,862),S(m,"class","detected-note svelte-1datf0r"),E(m,Y,28,14,907),S(e,"class","detection-values svelte-1datf0r"),E(e,Y,24,12,667)},m:function(y,d){we(y,e,d),D(e,t),D(t,n),D(e,s),D(e,i),D(e,u),D(e,c),D(e,g),D(e,m),D(m,b)},p:function(y,d){d&1&&o!==(o=(y[0]>0?Math.round(y[0]):"---")+"")&&xe(n,o),d&2&&xe(b,y[1])},d:function(y){y&&P(e)}};return le("SvelteRegisterBlock",{block:l,id:at.name,type:"else",source:"(24:10) {:else}",ctx:r}),l}function ct(r){let e,t;const o={c:function(){e=I("span"),t=Fe(r[4]),this.h()},l:function(s){e=F(s,"SPAN",{class:!0});var i=R(e);t=Te(i,r[4]),i.forEach(P),this.h()},h:function(){S(e,"class","muted-message svelte-1datf0r"),E(e,Y,22,12,588)},m:function(s,i){we(s,e,i),D(e,t)},p:function(s,i){i&16&&xe(t,s[4])},d:function(s){s&&P(e)}};return le("SvelteRegisterBlock",{block:o,id:ct.name,type:"if",source:"(22:10) {#if isMuted}",ctx:r}),o}function lt(r){let e,t,o="🎙️ リアルタイム音程検出",n,s,i,h,u,c,f,g;function m(y,d){return y[3]?ct:at}let b=m(r),l=b(r);f=new Ve({props:{volume:!r[3]&&r[0]>0?r[2]:0,className:"volume-bar"},$$inline:!0});const v={c:function(){e=I("div"),t=I("h3"),t.textContent=o,n=ne(),s=I("div"),i=I("div"),h=I("div"),u=I("div"),l.c(),c=ne(),Oe(f.$$.fragment),this.h()},l:function(d){e=F(d,"DIV",{class:!0});var w=R(e);t=F(w,"H3",{class:!0,"data-svelte-h":!0}),Ee(t)!=="svelte-1bj87i9"&&(t.textContent=o),w.forEach(P),n=te(d),s=F(d,"DIV",{class:!0});var p=R(s);i=F(p,"DIV",{class:!0});var N=R(i);h=F(N,"DIV",{class:!0});var M=R(h);u=F(M,"DIV",{class:!0});var _=R(u);l.l(_),_.forEach(P),c=te(M),Ze(f.$$.fragment,M),M.forEach(P),N.forEach(P),p.forEach(P),this.h()},h:function(){S(t,"class","section-title svelte-1datf0r"),E(t,Y,15,4,360),S(e,"class","card-header svelte-1datf0r"),E(e,Y,14,2,330),S(u,"class","detection-card svelte-1datf0r"),E(u,Y,20,8,523),S(h,"class","detection-display svelte-1datf0r"),E(h,Y,19,6,483),S(i,"class","pitch-detector svelte-1datf0r"),E(i,Y,18,4,448),S(s,"class","card-content svelte-1datf0r"),E(s,Y,17,2,417)},m:function(d,w){we(d,e,w),D(e,t),we(d,n,w),we(d,s,w),D(s,i),D(i,h),D(h,u),l.m(u,null),D(h,c),Ye(f,h,null),g=!0},p:function(d,w){b===(b=m(d))&&l?l.p(d,w):(l.d(1),l=b(d),l&&(l.c(),l.m(u,null)));const p={};w&13&&(p.volume=!d[3]&&d[0]>0?d[2]:0),f.$set(p)},i:function(d){g||(Xe(f.$$.fragment,d),g=!0)},o:function(d){Je(f.$$.fragment,d),g=!1},d:function(d){d&&(P(e),P(n),P(s)),l.d(),Ke(f)}};return le("SvelteRegisterBlock",{block:v,id:lt.name,type:"slot",source:'(14:0) <Card class=\\"main-card {className}\\">',ctx:r}),v}function je(r){let e,t;e=new rt({props:{class:"main-card "+r[5],$$slots:{default:[lt]},$$scope:{ctx:r}},$$inline:!0});const o={c:function(){Oe(e.$$.fragment)},l:function(s){Ze(e.$$.fragment,s)},m:function(s,i){Ye(e,s,i),t=!0},p:function(s,[i]){const h={};i&32&&(h.class="main-card "+s[5]),i&95&&(h.$$scope={dirty:i,ctx:s}),e.$set(h)},i:function(s){t||(Xe(e.$$.fragment,s),t=!0)},o:function(s){Je(e.$$.fragment,s),t=!1},d:function(s){Ke(e,s)}};return le("SvelteRegisterBlock",{block:o,id:je.name,type:"component",source:"",ctx:r}),o}function Ft(r,e,t){let{$$slots:o={},$$scope:n}=e;Qe("PitchDetectionDisplay",o,[]);let{frequency:s=0}=e,{note:i="ーー"}=e,{volume:h=0}=e,{isMuted:u=!1}=e,{muteMessage:c="待機中..."}=e,{className:f=""}=e;const g=["frequency","note","volume","isMuted","muteMessage","className"];return Object.keys(e).forEach(m=>{!~g.indexOf(m)&&m.slice(0,2)!=="$$"&&m!=="slot"&&console.warn(`<PitchDetectionDisplay> was created with unknown prop '${m}'`)}),r.$$set=m=>{"frequency"in m&&t(0,s=m.frequency),"note"in m&&t(1,i=m.note),"volume"in m&&t(2,h=m.volume),"isMuted"in m&&t(3,u=m.isMuted),"muteMessage"in m&&t(4,c=m.muteMessage),"className"in m&&t(5,f=m.className)},r.$capture_state=()=>({Card:rt,VolumeBar:Ve,frequency:s,note:i,volume:h,isMuted:u,muteMessage:c,className:f}),r.$inject_state=m=>{"frequency"in m&&t(0,s=m.frequency),"note"in m&&t(1,i=m.note),"volume"in m&&t(2,h=m.volume),"isMuted"in m&&t(3,u=m.isMuted),"muteMessage"in m&&t(4,c=m.muteMessage),"className"in m&&t(5,f=m.className)},e&&"$$inject"in e&&r.$inject_state(e.$$inject),[s,i,h,u,c,f]}class Ht extends Ge{constructor(e){super(e),We(this,e,Ft,je,Ue,{frequency:0,note:1,volume:2,isMuted:3,muteMessage:4,className:5}),le("SvelteRegisterComponent",{component:this,tagName:"PitchDetectionDisplay",options:e,id:je.name})}get frequency(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set frequency(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get note(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set note(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get volume(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set volume(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get isMuted(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set isMuted(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get muteMessage(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set muteMessage(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}export{Ht as P,Ve as V,_e as a,kt as b,pe as h,qe as l};
