var je=Object.defineProperty;var Xe=(o,e,t)=>e in o?je(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var W=(o,e,t)=>Xe(o,typeof e!="symbol"?e+"":e,t);import{S as Se,i as we,s as xe,n as He,d as x,J as E,y as w,b as le,c as A,e as D,f as V,h as j,j as z,k as X,I as Ye,K as Ze,C as Fe,m as Te,o as De,a as ge,D as ze,g as ve,G as ye,E as Ie,t as _e,F as Ne,R as Oe,M as $e}from"./BaJCk71S.js";import"./IHki7fMi.js";import{C as et}from"./GM6xVcAP.js";function tt(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}function q(o){if(this.size=o|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=o<<1;for(var e=new Array(this.size*2),t=0;t<e.length;t+=2){const c=Math.PI*t/this.size;e[t]=Math.cos(c),e[t+1]=-Math.sin(c)}this.table=e;for(var r=0,s=1;this.size>s;s<<=1)r++;this._width=r%2===0?r-1:r,this._bitrev=new Array(1<<this._width);for(var n=0;n<this._bitrev.length;n++){this._bitrev[n]=0;for(var i=0;i<this._width;i+=2){var a=this._width-i-2;this._bitrev[n]|=(n>>>i&3)<<a}}this._out=null,this._data=null,this._inv=0}var st=q;q.prototype.fromComplexArray=function(e,t){for(var r=t||new Array(e.length>>>1),s=0;s<e.length;s+=2)r[s>>>1]=e[s];return r};q.prototype.createComplexArray=function(){const e=new Array(this._csize);for(var t=0;t<e.length;t++)e[t]=0;return e};q.prototype.toComplexArray=function(e,t){for(var r=t||this.createComplexArray(),s=0;s<r.length;s+=2)r[s]=e[s>>>1],r[s+1]=0;return r};q.prototype.completeSpectrum=function(e){for(var t=this._csize,r=t>>>1,s=2;s<r;s+=2)e[t-s]=e[s],e[t-s+1]=-e[s+1]};q.prototype.transform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._transform4(),this._out=null,this._data=null};q.prototype.realTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._realTransform4(),this._out=null,this._data=null};q.prototype.inverseTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=1,this._transform4();for(var r=0;r<e.length;r++)e[r]/=this.size;this._out=null,this._data=null};q.prototype._transform4=function(){var e=this._out,t=this._csize,r=this._width,s=1<<r,n=t/s<<1,i,a,c=this._bitrev;if(n===4)for(i=0,a=0;i<t;i+=n,a++){const f=c[a];this._singleTransform2(i,f,s)}else for(i=0,a=0;i<t;i+=n,a++){const f=c[a];this._singleTransform4(i,f,s)}var l=this._inv?-1:1,d=this.table;for(s>>=2;s>=2;s>>=2){n=t/s<<1;var u=n>>>2;for(i=0;i<t;i+=n)for(var v=i+u,m=i,h=0;m<v;m+=2,h+=s){const f=m,_=f+u,g=_+u,p=g+u,T=e[f],b=e[f+1],S=e[_],C=e[_+1],F=e[g],B=e[g+1],k=e[p],G=e[p+1],H=T,Y=b,Q=d[h],K=l*d[h+1],U=S*Q-C*K,L=S*K+C*Q,$=d[2*h],se=l*d[2*h+1],re=F*$-B*se,ne=F*se+B*$,ee=d[3*h],ae=l*d[3*h+1],y=k*ee-G*ae,M=k*ae+G*ee,I=H+re,P=Y+ne,N=H-re,J=Y-ne,oe=U+y,Z=L+M,te=l*(U-y),ie=l*(L-M),O=I+oe,ce=P+Z,ue=I-oe,he=P-Z,R=N+ie,de=J-te,Me=N-ie,Ae=J+te;e[f]=O,e[f+1]=ce,e[_]=R,e[_+1]=de,e[g]=ue,e[g+1]=he,e[p]=Me,e[p+1]=Ae}}};q.prototype._singleTransform2=function(e,t,r){const s=this._out,n=this._data,i=n[t],a=n[t+1],c=n[t+r],l=n[t+r+1],d=i+c,u=a+l,v=i-c,m=a-l;s[e]=d,s[e+1]=u,s[e+2]=v,s[e+3]=m};q.prototype._singleTransform4=function(e,t,r){const s=this._out,n=this._data,i=this._inv?-1:1,a=r*2,c=r*3,l=n[t],d=n[t+1],u=n[t+r],v=n[t+r+1],m=n[t+a],h=n[t+a+1],f=n[t+c],_=n[t+c+1],g=l+m,p=d+h,T=l-m,b=d-h,S=u+f,C=v+_,F=i*(u-f),B=i*(v-_),k=g+S,G=p+C,H=T+B,Y=b-F,Q=g-S,K=p-C,U=T-B,L=b+F;s[e]=k,s[e+1]=G,s[e+2]=H,s[e+3]=Y,s[e+4]=Q,s[e+5]=K,s[e+6]=U,s[e+7]=L};q.prototype._realTransform4=function(){var e=this._out,t=this._csize,r=this._width,s=1<<r,n=t/s<<1,i,a,c=this._bitrev;if(n===4)for(i=0,a=0;i<t;i+=n,a++){const Ce=c[a];this._singleRealTransform2(i,Ce>>>1,s>>>1)}else for(i=0,a=0;i<t;i+=n,a++){const Ce=c[a];this._singleRealTransform4(i,Ce>>>1,s>>>1)}var l=this._inv?-1:1,d=this.table;for(s>>=2;s>=2;s>>=2){n=t/s<<1;var u=n>>>1,v=u>>>1,m=v>>>1;for(i=0;i<t;i+=n)for(var h=0,f=0;h<=m;h+=2,f+=s){var _=i+h,g=_+v,p=g+v,T=p+v,b=e[_],S=e[_+1],C=e[g],F=e[g+1],B=e[p],k=e[p+1],G=e[T],H=e[T+1],Y=b,Q=S,K=d[f],U=l*d[f+1],L=C*K-F*U,$=C*U+F*K,se=d[2*f],re=l*d[2*f+1],ne=B*se-k*re,ee=B*re+k*se,ae=d[3*f],y=l*d[3*f+1],M=G*ae-H*y,I=G*y+H*ae,P=Y+ne,N=Q+ee,J=Y-ne,oe=Q-ee,Z=L+M,te=$+I,ie=l*(L-M),O=l*($-I),ce=P+Z,ue=N+te,he=J+O,R=oe-ie;if(e[_]=ce,e[_+1]=ue,e[g]=he,e[g+1]=R,h===0){var de=P-Z,Me=N-te;e[p]=de,e[p+1]=Me;continue}if(h!==m){var Ae=J,Ve=-oe,Be=P,Re=-N,qe=-l*O,Le=-l*ie,We=-l*te,Ge=-l*Z,Qe=Ae+qe,Ke=Ve+Le,Ue=Be+Ge,Je=Re-We,Ee=i+v-h,ke=i+u-h;e[Ee]=Qe,e[Ee+1]=Ke,e[ke]=Ue,e[ke+1]=Je}}}};q.prototype._singleRealTransform2=function(e,t,r){const s=this._out,n=this._data,i=n[t],a=n[t+r],c=i+a,l=i-a;s[e]=c,s[e+1]=0,s[e+2]=l,s[e+3]=0};q.prototype._singleRealTransform4=function(e,t,r){const s=this._out,n=this._data,i=this._inv?-1:1,a=r*2,c=r*3,l=n[t],d=n[t+r],u=n[t+a],v=n[t+c],m=l+u,h=l-u,f=d+v,_=i*(d-v),g=m+f,p=h,T=-_,b=m-f,S=h,C=_;s[e]=g,s[e+1]=0,s[e+2]=p,s[e+3]=T,s[e+4]=b,s[e+5]=0,s[e+6]=S,s[e+7]=C};const rt=tt(st);class fe{constructor(e,t){W(this,"_inputLength");W(this,"_fft");W(this,"_bufferSupplier");W(this,"_paddedInputBuffer");W(this,"_transformBuffer");W(this,"_inverseBuffer");if(e<1)throw new Error("Input length must be at least one");this._inputLength=e,this._fft=new rt(ot(2*e)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(e){return new fe(e,t=>new Float32Array(t))}static forFloat64Array(e){return new fe(e,t=>new Float64Array(t))}static forNumberArray(e){return new fe(e,t=>Array(t))}get inputLength(){return this._inputLength}autocorrelate(e,t=this._bufferSupplier(e.length)){if(e.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${e.length}`);for(let s=0;s<e.length;s++)this._paddedInputBuffer[s]=e[s];for(let s=e.length;s<this._paddedInputBuffer.length;s++)this._paddedInputBuffer[s]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const r=this._transformBuffer;for(let s=0;s<r.length;s+=2)r[s]=r[s]*r[s]+r[s+1]*r[s+1],r[s+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let s=0;s<e.length;s++)t[s]=this._inverseBuffer[2*s];return t}}function nt(o){const e=[];let t=!1,r=-1/0,s=-1;for(let n=1;n<o.length-1;n++)o[n-1]<=0&&o[n]>0?(t=!0,s=n,r=o[n]):o[n-1]>0&&o[n]<=0?(t=!1,s!==-1&&e.push(s)):t&&o[n]>r&&(r=o[n],s=n);return e}function at(o,e){const[t,r,s]=[o-1,o,o+1],[n,i,a]=[e[t],e[r],e[s]],c=n/2-i+a/2,l=-(n/2)*(r+s)+i*(t+s)-a/2*(t+r),d=n*r*s/2-i*t*s+a*t*r/2,u=-l/(2*c),v=c*u*u+l*u+d;return[u,v]}class me{constructor(e,t){W(this,"_autocorrelator");W(this,"_nsdfBuffer");W(this,"_clarityThreshold",.9);W(this,"_minVolumeAbsolute",0);W(this,"_maxInputAmplitude",1);this._autocorrelator=new fe(e,t),this._nsdfBuffer=t(e)}static forFloat32Array(e){return new me(e,t=>new Float32Array(t))}static forFloat64Array(e){return new me(e,t=>new Float64Array(t))}static forNumberArray(e){return new me(e,t=>Array(t))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(e){if(!Number.isFinite(e)||e<=0||e>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=e}set minVolumeAbsolute(e){if(!Number.isFinite(e)||e<0||e>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=e}set minVolumeDecibels(e){if(!Number.isFinite(e)||e>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(e/10)}set maxInputAmplitude(e){if(!Number.isFinite(e)||e<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=e}findPitch(e,t){if(this._belowMinimumVolume(e))return[0,0];this._nsdf(e);const r=nt(this._nsdfBuffer);if(r.length===0)return[0,0];const s=Math.max(...r.map(c=>this._nsdfBuffer[c])),n=r.find(c=>this._nsdfBuffer[c]>=this._clarityThreshold*s),[i,a]=at(n,this._nsdfBuffer);return[t/i,Math.min(a,1)]}_belowMinimumVolume(e){if(this._minVolumeAbsolute===0)return!1;let t=0;for(let r=0;r<e.length;r++)t+=e[r]**2;return Math.sqrt(t/e.length)<this._minVolumeAbsolute}_nsdf(e){this._autocorrelator.autocorrelate(e,this._nsdfBuffer);let t=2*this._nsdfBuffer[0],r;for(r=0;r<this._nsdfBuffer.length&&t>0;r++)this._nsdfBuffer[r]=2*this._nsdfBuffer[r]/t,t-=e[r]**2+e[e.length-r-1]**2;for(;r<this._nsdfBuffer.length;r++)this._nsdfBuffer[r]=0}}function ot(o){return o--,o|=o>>1,o|=o>>2,o|=o>>4,o|=o>>8,o|=o>>16,o++,o}function it(o){let e,t,r,s,n,i;return{c(){e=z("div"),t=z("div"),r=z("div"),s=X(),n=z("div"),this.h()},l(a){e=D(a,"DIV",{class:!0});var c=V(e);t=D(c,"DIV",{class:!0,style:!0});var l=V(t);r=D(l,"DIV",{class:!0,style:!0}),V(r).forEach(x),l.forEach(x),s=j(c),n=D(c,"DIV",{class:!0,style:!0}),V(n).forEach(x),c.forEach(x),this.h()},h(){w(r,"class","volume-bar-fill"),E(r,"position","absolute"),E(r,"top","0"),E(r,"left","0"),E(r,"height","100%"),w(t,"class","volume-bar-bg"),E(t,"height",o[1]),E(t,"border-radius","9999px"),E(t,"background-color","#e2e8f0"),E(t,"position","relative"),E(t,"overflow","hidden"),w(n,"class","threshold-indicator svelte-13z7ppf"),E(n,"position","absolute"),E(n,"top","0"),E(n,"left",o[0]+"%"),E(n,"width","2px"),E(n,"height",o[1]),E(n,"background-color","#64748b"),E(n,"border-radius","1px"),w(e,"class",i="volume-bar-container "+o[2]+" svelte-13z7ppf")},m(a,c){le(a,e,c),A(e,t),A(t,r),o[5](r),A(e,s),A(e,n)},p(a,[c]){c&2&&E(t,"height",a[1]),c&1&&E(n,"left",a[0]+"%"),c&2&&E(n,"height",a[1]),c&4&&i!==(i="volume-bar-container "+a[2]+" svelte-13z7ppf")&&w(e,"class",i)},i:He,o:He,d(a){a&&x(e),o[5](null)}}}function lt(o,e,t){let{volume:r=0}=e,{threshold:s=30}=e,{height:n="12px"}=e,{className:i=""}=e,a;function c(u){return u<s?`rgba(37, 99, 235, ${Math.max(.2,u/s*.8)})`:"#2563eb"}function l(u){if(a){const v=Math.max(0,Math.min(100,u)),m=c(v);t(3,a.style.width=`${v}%`,a),t(3,a.style.backgroundColor=m,a)}}Ye(()=>{a&&(t(3,a.style.width="0%",a),t(3,a.style.backgroundColor="#2563eb",a),t(3,a.style.height=n,a),t(3,a.style.borderRadius="9999px",a),t(3,a.style.transition="width 0.2s ease-out, background-color 0.2s ease-out",a))});function d(u){Ze[u?"unshift":"push"](()=>{a=u,t(3,a)})}return o.$$set=u=>{"volume"in u&&t(4,r=u.volume),"threshold"in u&&t(0,s=u.threshold),"height"in u&&t(1,n=u.height),"className"in u&&t(2,i=u.className)},o.$$.update=()=>{o.$$.dirty&16&&l(r)},[s,n,i,a,r,d]}class Pe extends Se{constructor(e){super(),we(this,e,lt,it,xe,{volume:4,threshold:0,height:1,className:2})}}class ct{constructor(){this.audioContext=null,this.mediaStream=null,this.sourceNode=null,this.analysers=new Map,this.filters=new Map,this.refCount=0,this.initPromise=null,this.isInitialized=!1,this.lastError=null}async initialize(){var e,t,r;if(this.initPromise)return this.initPromise;if(this.isInitialized&&this.audioContext&&this.mediaStream){const s=this.checkMediaStreamHealth();if(s.healthy)return this.refCount++,{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode};console.warn("⚠️ [AudioManager] MediaStream不健康検出 - 強制再初期化:",s.reason),console.log("🔄 [AudioManager] 不健康なMediaStream詳細:",{mediaStreamActive:(e=this.mediaStream)==null?void 0:e.active,trackCount:(t=this.mediaStream)==null?void 0:t.getTracks().length,trackStates:(r=this.mediaStream)==null?void 0:r.getTracks().map(n=>({kind:n.kind,readyState:n.readyState,enabled:n.enabled,muted:n.muted}))}),this._cleanup(),this.isInitialized=!1,this.refCount=0,await new Promise(n=>setTimeout(n,100)),console.log("🔄 [AudioManager] クリーンアップ完了 - 再初期化開始")}this.initPromise=this._doInitialize();try{const s=await this.initPromise;return this.initPromise=null,s}catch(s){throw this.initPromise=null,s}}async _doInitialize(){try{if(console.log("🎤 [AudioManager] 初期化開始"),this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),console.log("✅ [AudioManager] AudioContext作成完了")),this.audioContext.state==="suspended"&&(await this.audioContext.resume(),console.log("✅ [AudioManager] AudioContext再開完了")),!this.mediaStream){const e={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,sampleRate:44100,channelCount:1,sampleSize:16,latency:.1,volume:1,deviceId:{ideal:"default"}}};console.log("🎤 [AudioManager] Safari対応設定でMediaStream取得中:",e),this.mediaStream=await navigator.mediaDevices.getUserMedia(e),console.log("✅ [AudioManager] MediaStream取得完了")}if(!this.sourceNode){this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),console.log("✅ [AudioManager] SourceNode作成完了");const e=this.mediaStream.getTracks();console.log("🎤 [AudioManager] MediaStream tracks:",e.map(t=>({kind:t.kind,label:t.label,enabled:t.enabled,readyState:t.readyState,muted:t.muted})))}return this.isInitialized=!0,this.refCount++,this.lastError=null,console.log(`🎤 [AudioManager] 初期化完了 (参照カウント: ${this.refCount})`),{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode}}catch(e){throw console.error("❌ [AudioManager] 初期化エラー:",e),this.lastError=e,this.isInitialized=!1,this._cleanup(),e}}createAnalyser(e,t={}){if(!this.isInitialized||!this.audioContext||!this.sourceNode)throw new Error("AudioManager not initialized. Call initialize() first.");this.removeAnalyser(e);const{fftSize:r=2048,smoothingTimeConstant:s=.8,minDecibels:n=-90,maxDecibels:i=-10,useFilters:a=!0}=t,c=this.audioContext.createAnalyser();if(c.fftSize=Math.min(r,2048),c.smoothingTimeConstant=Math.max(s,.7),c.minDecibels=Math.max(n,-80),c.maxDecibels=Math.min(i,-10),this.sourceNode,a){const l=this._createFilterChain();this.filters.set(e,l),this.sourceNode.connect(l.highpass),l.highpass.connect(l.lowpass),l.lowpass.connect(l.notch),l.notch.connect(c),console.log(`🔧 [AudioManager] フィルター付きAnalyser作成: ${e}`)}else this.sourceNode.connect(c),console.log(`🔧 [AudioManager] 生信号Analyser作成: ${e}`);return this.analysers.set(e,c),c}_createFilterChain(){const e=this.audioContext.createBiquadFilter();e.type="highpass",e.frequency.setValueAtTime(80,this.audioContext.currentTime),e.Q.setValueAtTime(.7,this.audioContext.currentTime);const t=this.audioContext.createBiquadFilter();t.type="lowpass",t.frequency.setValueAtTime(800,this.audioContext.currentTime),t.Q.setValueAtTime(.7,this.audioContext.currentTime);const r=this.audioContext.createBiquadFilter();return r.type="notch",r.frequency.setValueAtTime(60,this.audioContext.currentTime),r.Q.setValueAtTime(10,this.audioContext.currentTime),{highpass:e,lowpass:t,notch:r}}removeAnalyser(e){if(this.analysers.has(e)&&(this.analysers.get(e).disconnect(),this.analysers.delete(e),console.log(`🗑️ [AudioManager] Analyser削除: ${e}`)),this.filters.has(e)){const t=this.filters.get(e);t.highpass.disconnect(),t.lowpass.disconnect(),t.notch.disconnect(),this.filters.delete(e),console.log(`🗑️ [AudioManager] フィルターチェーン削除: ${e}`)}}release(e=[]){e.forEach(t=>this.removeAnalyser(t)),this.refCount=Math.max(0,this.refCount-1),console.log(`📉 [AudioManager] 参照カウント減算: ${this.refCount}`),this.refCount<=0&&(console.log("🧹 [AudioManager] 全リソースクリーンアップ開始"),this._cleanup())}forceCleanup(){console.log("🚨 [AudioManager] 強制クリーンアップ実行"),this._cleanup()}_cleanup(){console.log("🧹 [AudioManager] クリーンアップ開始");for(const e of this.analysers.keys())this.removeAnalyser(e);if(this.mediaStream){const e=this.mediaStream.getTracks();console.log(`🛑 [AudioManager] MediaStream停止中: ${e.length} tracks`),e.forEach((t,r)=>{try{t.readyState!=="ended"?(t.stop(),console.log(`🛑 [AudioManager] Track ${r} 停止完了`)):console.log(`⚠️ [AudioManager] Track ${r} 既に終了済み`)}catch(s){console.warn(`⚠️ [AudioManager] Track ${r} 停止エラー:`,s)}}),this.mediaStream=null}if(this.audioContext&&this.audioContext.state!=="closed"){try{this.audioContext.close(),console.log("🛑 [AudioManager] AudioContext閉鎖完了")}catch(e){console.warn("⚠️ [AudioManager] AudioContext閉鎖エラー:",e)}this.audioContext=null}this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.isInitialized=!1,this.refCount=0,this.initPromise=null,console.log("✅ [AudioManager] クリーンアップ完了")}getStatus(){var e,t;return{isInitialized:this.isInitialized,refCount:this.refCount,audioContextState:((e=this.audioContext)==null?void 0:e.state)||"none",mediaStreamActive:((t=this.mediaStream)==null?void 0:t.active)||!1,activeAnalysers:Array.from(this.analysers.keys()),activeFilters:Array.from(this.filters.keys()),lastError:this.lastError}}checkMediaStreamHealth(){if(!this.mediaStream)return{healthy:!1,reason:"MediaStream not initialized"};if(!this.mediaStream.active)return{healthy:!1,reason:"MediaStream inactive"};const e=this.mediaStream.getTracks();if(e.length===0)return{healthy:!1,reason:"No tracks available"};const t=e.find(r=>r.kind==="audio");return t?t.readyState==="ended"?{healthy:!1,reason:"Audio track ended"}:t.enabled?t.muted?{healthy:!1,reason:"Audio track muted"}:this.mediaStream.active&&t.readyState!=="live"?{healthy:!1,reason:"Track state inconsistent with MediaStream"}:{healthy:!0,track:t}:{healthy:!1,reason:"Audio track disabled"}:{healthy:!1,reason:"No audio track found"}}}const pe=new ct;class ut{constructor(e={}){this.vocalRangeMin=e.vocalRangeMin||130.81,this.vocalRangeMax=e.vocalRangeMax||1046.5,this.stabilityThreshold=e.stabilityThreshold||.1,this.evaluationWeights={vocalRange:e.vocalRangeWeight||.4,continuity:e.continuityWeight||.4,musical:e.musicalWeight||.2},this.fundamentalCandidates=e.fundamentalCandidates||[1,.5,.333,.25,2],this.harmonicHistory=[],this.previousFrequency=0,this.maxHistoryLength=5,this.debugMode=!0,this.currentContext={},console.log("🔧 [HarmonicCorrection] 統一倍音補正システム初期化完了")}correctHarmonic(e,t=!1){if(!e||e<=0)return 0;const s=this.fundamentalCandidates.map(a=>({frequency:e*a,ratio:a})).map(a=>{const c=this.evaluateFundamental(a.frequency);return{...a,...c}}),n=s.reduce((a,c)=>c.totalScore>a.totalScore?c:a),i=this.stabilizeFrequency(n.frequency);return(t||this.debugMode)&&this.logHarmonicCorrection(e,s,n,i,this.currentContext),this.previousFrequency=i,i}logHarmonicCorrection(e,t,r,s,n={}){console.group(`🔧 [HarmonicCorrection] ${e.toFixed(1)}Hz → ${s.toFixed(1)}Hz`);const i=this.frequencyToNote(e),a=this.frequencyToNote(s);console.log(`📝 音程変換: ${i} → ${a}`);const c=this.getCorrectionType(r.ratio);if(console.log(`🎯 補正タイプ: ${c}`),n.baseFrequency&&n.currentScale&&n.targetFrequency){console.log("🎵 音階コンテキスト:"),console.log(`   基音: ${n.baseFrequency.toFixed(1)}Hz (${this.frequencyToNote(n.baseFrequency)})`),console.log(`   現在の音階: ${n.currentScale}`),console.log(`   目標周波数: ${n.targetFrequency.toFixed(1)}Hz (${this.frequencyToNote(n.targetFrequency)})`);const d=s-n.targetFrequency,u=1200*Math.log2(s/n.targetFrequency);console.log(`   目標との差: ${d>0?"+":""}${d.toFixed(1)}Hz (${u>0?"+":""}${u.toFixed(0)}セント)`);const v=Math.abs(u)<=50?"🎯 高精度":Math.abs(u)<=100?"✅ 良好":Math.abs(u)<=200?"⚠️ 要改善":"❌ 不正確";console.log(`   精度評価: ${v} (${Math.abs(u).toFixed(0)}セント差)`)}console.table(t.map(d=>({倍率:`${d.ratio.toFixed(3)}x`,周波数:`${d.frequency.toFixed(1)}Hz`,音名:this.frequencyToNote(d.frequency),音域:d.vocalRangeScore.toFixed(2),連続性:d.continuityScore.toFixed(2),音楽性:d.musicalScore.toFixed(2),総合:d.totalScore.toFixed(3),選択:d===r?"✅":""})));const l=Math.abs(s-r.frequency);l>.5&&console.log(`🔄 安定化: ${r.frequency.toFixed(1)}Hz → ${s.toFixed(1)}Hz (${l.toFixed(1)}Hz調整)`),console.groupEnd()}getCorrectionType(e){return Math.abs(e-1)<.01?"補正なし（基音）":Math.abs(e-.5)<.01?"2倍音補正（1オクターブ下）":Math.abs(e-.333)<.01?"3倍音補正（1オクターブ+5度下）":Math.abs(e-.25)<.01?"4倍音補正（2オクターブ下）":Math.abs(e-2)<.01?"オクターブ上補正":`カスタム補正（${e.toFixed(3)}x）`}frequencyToNote(e){if(!e||e<=0)return"---";const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],s=Math.round(12*Math.log2(e/440)),n=(s+9+120)%12,i=Math.floor((s+9)/12)+4;return t[n]+i}evaluateFundamental(e){const r=e>=this.vocalRangeMin&&e<=this.vocalRangeMax?1:0,s=this.previousFrequency>0?1-Math.min(Math.abs(e-this.previousFrequency)/this.previousFrequency,1):.5,n=this.calculateMusicalScore(e),i=r*this.evaluationWeights.vocalRange+s*this.evaluationWeights.continuity+n*this.evaluationWeights.musical;return{vocalRangeScore:r,continuityScore:s,musicalScore:n,totalScore:i}}calculateMusicalScore(e){const r=Math.log2(e/261.63)*12,s=Math.round(r),n=Math.abs(r-s);return Math.max(0,1-n/.5)}stabilizeFrequency(e){if(!e||e<=0)return 0;if(this.harmonicHistory.push(e),this.harmonicHistory.length>this.maxHistoryLength&&this.harmonicHistory.shift(),this.harmonicHistory.length<2)return e;const t=[...this.harmonicHistory].sort((i,a)=>i-a),r=t[Math.floor(t.length/2)],s=r*this.stabilityThreshold;return Math.abs(e-r)>s?r+Math.sign(e-r)*s:e}resetHistory(){this.harmonicHistory=[],this.previousFrequency=0}updateConfig(e){Object.assign(this,e),console.log("⚙️ [HarmonicCorrection] 設定更新:",e)}enableDebugLogging(){this.debugMode=!0,console.log("🔍 [HarmonicCorrection] デバッグログ有効化 - 次回の補正から詳細ログを出力します"),console.log("無効化するには: harmonicCorrection.disableDebugLogging()")}disableDebugLogging(){this.debugMode=!1,console.log("🔍 [HarmonicCorrection] デバッグログ無効化")}setScaleContext(e){this.currentContext={baseFrequency:e.baseFrequency,currentScale:e.currentScale,targetFrequency:e.targetFrequency}}clearContext(){this.currentContext={}}getStatus(){return{vocalRangeMin:this.vocalRangeMin,vocalRangeMax:this.vocalRangeMax,stabilityThreshold:this.stabilityThreshold,evaluationWeights:this.evaluationWeights,historyLength:this.harmonicHistory.length,previousFrequency:this.previousFrequency,recentHistory:this.harmonicHistory.slice(-3)}}}const be=new ut;function ht(o){let e,t,r,s,n=(o[2]>0?Math.round(o[2]):"---")+"",i,a,c,l="Hz",d,u,v="|",m,h,f,_,g,p,T;return g=new Pe({props:{volume:o[2]>0?o[1]:0,className:"volume-bar"}}),{c(){e=z("div"),t=z("div"),r=z("div"),s=z("span"),i=_e(n),a=X(),c=z("span"),c.textContent=l,d=X(),u=z("span"),u.textContent=v,m=X(),h=z("span"),f=_e(o[3]),_=X(),Ne(g.$$.fragment),this.h()},l(b){e=D(b,"DIV",{class:!0});var S=V(e);t=D(S,"DIV",{class:!0});var C=V(t);r=D(C,"DIV",{class:!0});var F=V(r);s=D(F,"SPAN",{class:!0});var B=V(s);i=ve(B,n),B.forEach(x),a=j(F),c=D(F,"SPAN",{class:!0,"data-svelte-h":!0}),ye(c)!=="svelte-5uyilv"&&(c.textContent=l),d=j(F),u=D(F,"SPAN",{class:!0,"data-svelte-h":!0}),ye(u)!=="svelte-1dytxz4"&&(u.textContent=v),m=j(F),h=D(F,"SPAN",{class:!0});var k=V(h);f=ve(k,o[3]),k.forEach(x),F.forEach(x),_=j(C),Ie(g.$$.fragment,C),C.forEach(x),S.forEach(x),this.h()},h(){w(s,"class","detected-frequency svelte-vc1bho"),w(c,"class","hz-suffix svelte-vc1bho"),w(u,"class","divider svelte-vc1bho"),w(h,"class","detected-note svelte-vc1bho"),w(r,"class","detection-card svelte-vc1bho"),w(t,"class","detection-display svelte-vc1bho"),w(e,"class",p="pitch-detector "+o[0]+" svelte-vc1bho")},m(b,S){le(b,e,S),A(e,t),A(t,r),A(r,s),A(s,i),A(r,a),A(r,c),A(r,d),A(r,u),A(r,m),A(r,h),A(h,f),A(t,_),ze(g,t,null),T=!0},p(b,S){(!T||S[0]&4)&&n!==(n=(b[2]>0?Math.round(b[2]):"---")+"")&&ge(i,n),(!T||S[0]&8)&&ge(f,b[3]);const C={};S[0]&6&&(C.volume=b[2]>0?b[1]:0),g.$set(C),(!T||S[0]&1&&p!==(p="pitch-detector "+b[0]+" svelte-vc1bho"))&&w(e,"class",p)},i(b){T||(De(g.$$.fragment,b),T=!0)},o(b){Te(g.$$.fragment,b),T=!1},d(b){b&&x(e),Fe(g)}}}function dt(o){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(o<=0)return"ーー";const r=Math.round(12*Math.log2(o/440)),s=(r+9+120)%12,n=Math.floor((r+9)/12)+4;return e[s]+n}function ft(o,e,t){const r=Oe();let{isActive:s=!1}=e,{className:n=""}=e,{debugMode:i=!1}=e,a="uninitialized",c=null,l=!1,d=null,u=null,v=null,m=null,h=null,f=null,_=null,g=!1,p=[],T=new Map,b=0,S=0,C=0,F="ーー",B=0,k=[],G=0,H=null;function Y(){b=0,t(1,S=0),t(2,C=0),t(3,F="ーー"),B=0,G=0,k=[],be.resetHistory(),i&&console.log("🔄 [PitchDetector] Display state reset")}function Q(){if(!i)return;const y=new Date().toLocaleTimeString(),M={timestamp:y,componentState:a,isActive:s,isDetecting:g,isInitialized:l,mediaStreamActive:u?u.active:null,mediaStreamTracks:u?u.getTracks().length:0,trackStates:u?u.getTracks().map(N=>({kind:N.kind,enabled:N.enabled,readyState:N.readyState,muted:N.muted})):[],audioContextState:d?d.state:null,hasAnalyser:!!m,currentVolume:b,currentFrequency:C};console.log(`🎤 [PitchDetector] ${y}:`,M);let I=!0,P=[];u&&!u.active&&(console.warn("⚠️ [PitchDetector] MediaStream is inactive!",u),I=!1,P.push("MediaStream inactive")),d&&d.state==="suspended"&&(console.warn("⚠️ [PitchDetector] AudioContext is suspended!",d),I=!1,P.push("AudioContext suspended")),u&&u.getTracks().forEach((N,J)=>{N.readyState==="ended"&&(console.error(`❌ [PitchDetector] Track ${J} has ended!`,N),I=!1,P.push(`Track ${J} ended`))}),r("microphoneHealthChange",{healthy:I,errors:P,details:M})}async function K(){try{t(14,a="initializing"),c=null,console.log("🎙️ [PitchDetector] AudioManager経由で初期化開始");const y=await pe.initialize();d=y.audioContext,u=y.mediaStream,v=y.sourceNode,console.log("✅ [PitchDetector] AudioManager リソース取得完了");const M=`pitch-detector-filtered-${Date.now()}`;t(15,m=pe.createAnalyser(M,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!0})),p.push(M);const I=`pitch-detector-raw-${Date.now()}`;h=pe.createAnalyser(I,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!1}),p.push(I),console.log("✅ [PitchDetector] Analyser作成完了:",p),f=me.forFloat32Array(m.fftSize),t(14,a="ready"),l=!0,r("stateChange",{state:a}),ae(),console.log("✅ [PitchDetector] 初期化完了")}catch(y){throw console.error("❌ [PitchDetector] 初期化エラー:",y),t(14,a="error"),c=y,l=!1,r("error",{error:y,context:"initialization"}),y}}function U(){if(a!=="ready"){const y=new Error(`Cannot start detection: component state is ${a}`);return r("error",{error:y,context:"start-detection"}),!1}if(!m||!f||!d){const y=new Error("Required components not available");return t(14,a="error"),r("error",{error:y,context:"start-detection"}),!1}return t(14,a="detecting"),t(16,g=!0),r("stateChange",{state:a}),$(),!0}function L(){t(16,g=!1),_&&(cancelAnimationFrame(_),_=null),a==="detecting"&&l&&(t(14,a="ready"),r("stateChange",{state:a}))}function $(){if(!g||!m||!h||!f)return;const y=m.fftSize,M=new Float32Array(y),I=new Float32Array(h.fftSize);m.getFloatTimeDomainData(M),h.getFloatTimeDomainData(I);let P=0;for(let R=0;R<y;R++)P+=Math.abs(M[R]);const N=Math.sqrt(P/y),J=Math.log10(N+.001)*50+100,oe=Math.max(0,Math.min(100,J));let Z=0;for(let R=0;R<I.length;R++)Z+=Math.abs(I[R]);const te=Math.sqrt(Z/I.length),ie=Math.log10(te+.001)*50+100;t(1,S=Math.max(0,Math.min(100,ie))),k.push(oe),k.length>5&&k.shift(),G=k.reduce((R,de)=>R+de,0)/k.length,b=G;const[O,ce]=f.findPitch(M,d.sampleRate),ue=O>=65&&O<=1200;if(O&&ce>.6&&b>10&&ue){const R=be.correctHarmonic(O);t(2,C=Math.round(R)),t(3,F=dt(C)),B=ce}else C===0&&be.resetHistory(),t(2,C=0),t(3,F="ーー"),B=0;const he=C>0?S:0;r("pitchUpdate",{frequency:C,note:F,volume:b,rawVolume:he,clarity:B}),_=requestAnimationFrame($)}function se(){return l&&a==="ready"}function re(){return{componentState:a,isInitialized:l,isDetecting:g,lastError:c,hasRequiredComponents:!!(m&&f&&d&&u)}}async function ne(){console.log("🔄 [PitchDetector] 再初期化開始"),ee(),await new Promise(y=>setTimeout(y,100)),await K(),console.log("✅ [PitchDetector] 再初期化完了")}function ee(){console.log("🧹 [PitchDetector] クリーンアップ開始"),L(),T.size>0&&(T.forEach((y,M)=>{M.removeEventListener("ended",y.endedHandler),M.removeEventListener("mute",y.muteHandler),M.removeEventListener("unmute",y.unmuteHandler)}),T.clear(),console.log("🔄 [PitchDetector] MediaStreamイベントリスナー削除")),p.length>0&&(pe.release(p),console.log("📤 [PitchDetector] AudioManagerにAnalyser解放通知:",p),p=[]),t(14,a="uninitialized"),l=!1,c=null,d=null,u=null,v=null,t(15,m=null),h=null,f=null,k=[],be.resetHistory(),console.log("✅ [PitchDetector] クリーンアップ完了")}function ae(){if(!u)return;const y=u.getTracks();y.forEach(M=>{const I=()=>{console.error("🚨 [PitchDetector] MediaStreamTrack終了検出:",M.kind),t(14,a="error"),c=new Error(`MediaStreamTrack (${M.kind}) ended`),r("error",{error:c,reason:"mediastream_ended",recovery:"restart_required"}),g&&L()},P=()=>{console.warn("⚠️ [PitchDetector] MediaStreamTrack muted:",M.kind),r("warning",{reason:"track_muted",track:M.kind})},N=()=>{console.log("✅ [PitchDetector] MediaStreamTrack unmuted:",M.kind),r("info",{reason:"track_unmuted",track:M.kind})};M.addEventListener("ended",I),M.addEventListener("mute",P),M.addEventListener("unmute",N),T.set(M,{endedHandler:I,muteHandler:P,unmuteHandler:N})}),console.log("🔍 [PitchDetector] MediaStream監視開始:",y.length+" tracks")}return $e(()=>{H&&(clearInterval(H),t(17,H=null)),console.log("🔄 [PitchDetector] onDestroy - AudioManagerリソースは保持")}),o.$$set=y=>{"isActive"in y&&t(4,s=y.isActive),"className"in y&&t(0,n=y.className),"debugMode"in y&&t(5,i=y.debugMode)},o.$$.update=()=>{o.$$.dirty[0]&131104&&(i&&!H?(console.log("🔍 [PitchDetector] Debug mode enabled - starting status monitoring"),t(17,H=setInterval(Q,3e3)),Q()):!i&&H&&(console.log("🔍 [PitchDetector] Debug mode disabled - stopping status monitoring"),clearInterval(H),t(17,H=null))),o.$$.dirty[0]&114704&&(s&&a==="ready"&&m&&!g?U():!s&&g&&L())},[n,S,C,F,s,i,Y,K,U,L,se,re,ne,ee,a,m,g,H]}class Ct extends Se{constructor(e){super(),we(this,e,ft,ht,xe,{isActive:4,className:0,debugMode:5,resetDisplayState:6,initialize:7,startDetection:8,stopDetection:9,getIsInitialized:10,getState:11,reinitialize:12,cleanup:13},null,[-1,-1])}get resetDisplayState(){return this.$$.ctx[6]}get initialize(){return this.$$.ctx[7]}get startDetection(){return this.$$.ctx[8]}get stopDetection(){return this.$$.ctx[9]}get getIsInitialized(){return this.$$.ctx[10]}get getState(){return this.$$.ctx[11]}get reinitialize(){return this.$$.ctx[12]}get cleanup(){return this.$$.ctx[13]}}function mt(o){let e,t,r=(o[0]>0?Math.round(o[0]):"---")+"",s,n,i,a="Hz",c,l,d="|",u,v,m;return{c(){e=z("div"),t=z("span"),s=_e(r),n=X(),i=z("span"),i.textContent=a,c=X(),l=z("span"),l.textContent=d,u=X(),v=z("span"),m=_e(o[1]),this.h()},l(h){e=D(h,"DIV",{class:!0});var f=V(e);t=D(f,"SPAN",{class:!0});var _=V(t);s=ve(_,r),_.forEach(x),n=j(f),i=D(f,"SPAN",{class:!0,"data-svelte-h":!0}),ye(i)!=="svelte-5uyilv"&&(i.textContent=a),c=j(f),l=D(f,"SPAN",{class:!0,"data-svelte-h":!0}),ye(l)!=="svelte-1dytxz4"&&(l.textContent=d),u=j(f),v=D(f,"SPAN",{class:!0});var g=V(v);m=ve(g,o[1]),g.forEach(x),f.forEach(x),this.h()},h(){w(t,"class","detected-frequency svelte-1datf0r"),w(i,"class","hz-suffix svelte-1datf0r"),w(l,"class","divider svelte-1datf0r"),w(v,"class","detected-note svelte-1datf0r"),w(e,"class","detection-values svelte-1datf0r")},m(h,f){le(h,e,f),A(e,t),A(t,s),A(e,n),A(e,i),A(e,c),A(e,l),A(e,u),A(e,v),A(v,m)},p(h,f){f&1&&r!==(r=(h[0]>0?Math.round(h[0]):"---")+"")&&ge(s,r),f&2&&ge(m,h[1])},d(h){h&&x(e)}}}function gt(o){let e,t;return{c(){e=z("span"),t=_e(o[4]),this.h()},l(r){e=D(r,"SPAN",{class:!0});var s=V(e);t=ve(s,o[4]),s.forEach(x),this.h()},h(){w(e,"class","muted-message svelte-1datf0r")},m(r,s){le(r,e,s),A(e,t)},p(r,s){s&16&&ge(t,r[4])},d(r){r&&x(e)}}}function vt(o){let e,t='<h3 class="section-title svelte-1datf0r">🎙️ リアルタイム音程検出</h3>',r,s,n,i,a,c,l,d;function u(h,f){return h[3]?gt:mt}let v=u(o),m=v(o);return l=new Pe({props:{volume:!o[3]&&o[0]>0?o[2]:0,className:"volume-bar"}}),{c(){e=z("div"),e.innerHTML=t,r=X(),s=z("div"),n=z("div"),i=z("div"),a=z("div"),m.c(),c=X(),Ne(l.$$.fragment),this.h()},l(h){e=D(h,"DIV",{class:!0,"data-svelte-h":!0}),ye(e)!=="svelte-10ekeq9"&&(e.innerHTML=t),r=j(h),s=D(h,"DIV",{class:!0});var f=V(s);n=D(f,"DIV",{class:!0});var _=V(n);i=D(_,"DIV",{class:!0});var g=V(i);a=D(g,"DIV",{class:!0});var p=V(a);m.l(p),p.forEach(x),c=j(g),Ie(l.$$.fragment,g),g.forEach(x),_.forEach(x),f.forEach(x),this.h()},h(){w(e,"class","card-header svelte-1datf0r"),w(a,"class","detection-card svelte-1datf0r"),w(i,"class","detection-display svelte-1datf0r"),w(n,"class","pitch-detector svelte-1datf0r"),w(s,"class","card-content svelte-1datf0r")},m(h,f){le(h,e,f),le(h,r,f),le(h,s,f),A(s,n),A(n,i),A(i,a),m.m(a,null),A(i,c),ze(l,i,null),d=!0},p(h,f){v===(v=u(h))&&m?m.p(h,f):(m.d(1),m=v(h),m&&(m.c(),m.m(a,null)));const _={};f&13&&(_.volume=!h[3]&&h[0]>0?h[2]:0),l.$set(_)},i(h){d||(De(l.$$.fragment,h),d=!0)},o(h){Te(l.$$.fragment,h),d=!1},d(h){h&&(x(e),x(r),x(s)),m.d(),Fe(l)}}}function yt(o){let e,t;return e=new et({props:{class:"main-card "+o[5],$$slots:{default:[vt]},$$scope:{ctx:o}}}),{c(){Ne(e.$$.fragment)},l(r){Ie(e.$$.fragment,r)},m(r,s){ze(e,r,s),t=!0},p(r,[s]){const n={};s&32&&(n.class="main-card "+r[5]),s&95&&(n.$$scope={dirty:s,ctx:r}),e.$set(n)},i(r){t||(De(e.$$.fragment,r),t=!0)},o(r){Te(e.$$.fragment,r),t=!1},d(r){Fe(e,r)}}}function _t(o,e,t){let{frequency:r=0}=e,{note:s="ーー"}=e,{volume:n=0}=e,{isMuted:i=!1}=e,{muteMessage:a="待機中..."}=e,{className:c=""}=e;return o.$$set=l=>{"frequency"in l&&t(0,r=l.frequency),"note"in l&&t(1,s=l.note),"volume"in l&&t(2,n=l.volume),"isMuted"in l&&t(3,i=l.isMuted),"muteMessage"in l&&t(4,a=l.muteMessage),"className"in l&&t(5,c=l.className)},[r,s,n,i,a,c]}class St extends Se{constructor(e){super(),we(this,e,_t,yt,xe,{frequency:0,note:1,volume:2,isMuted:3,muteMessage:4,className:5})}}export{St as P,Ct as a,pe as b,be as h};
