var Ye=Object.defineProperty;var Ze=(r,e,t)=>e in r?Ye(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var W=(r,e,t)=>Ze(r,typeof e!="symbol"?e+"":e,t);import{S as xe,i as Te,s as Fe,n as ke,d as T,K as N,y as x,b as he,c as M,e as z,f as V,h as Y,j as I,k as Z,M as Oe,Q as $e,C as De,m as ze,o as Ie,a as be,D as Pe,g as pe,G as Me,E as Ne,t as Ae,F as Ee,U as et,J as tt}from"./BJp-dNlk.js";import"./IHki7fMi.js";import{C as st}from"./DZHPMXgl.js";function nt(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function L(r){if(this.size=r|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=r<<1;for(var e=new Array(this.size*2),t=0;t<e.length;t+=2){const c=Math.PI*t/this.size;e[t]=Math.cos(c),e[t+1]=-Math.sin(c)}this.table=e;for(var n=0,s=1;this.size>s;s<<=1)n++;this._width=n%2===0?n-1:n,this._bitrev=new Array(1<<this._width);for(var o=0;o<this._bitrev.length;o++){this._bitrev[o]=0;for(var i=0;i<this._width;i+=2){var l=this._width-i-2;this._bitrev[o]|=(o>>>i&3)<<l}}this._out=null,this._data=null,this._inv=0}var ot=L;L.prototype.fromComplexArray=function(e,t){for(var n=t||new Array(e.length>>>1),s=0;s<e.length;s+=2)n[s>>>1]=e[s];return n};L.prototype.createComplexArray=function(){const e=new Array(this._csize);for(var t=0;t<e.length;t++)e[t]=0;return e};L.prototype.toComplexArray=function(e,t){for(var n=t||this.createComplexArray(),s=0;s<n.length;s+=2)n[s]=e[s>>>1],n[s+1]=0;return n};L.prototype.completeSpectrum=function(e){for(var t=this._csize,n=t>>>1,s=2;s<n;s+=2)e[t-s]=e[s],e[t-s+1]=-e[s+1]};L.prototype.transform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._transform4(),this._out=null,this._data=null};L.prototype.realTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._realTransform4(),this._out=null,this._data=null};L.prototype.inverseTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=1,this._transform4();for(var n=0;n<e.length;n++)e[n]/=this.size;this._out=null,this._data=null};L.prototype._transform4=function(){var e=this._out,t=this._csize,n=this._width,s=1<<n,o=t/s<<1,i,l,c=this._bitrev;if(o===4)for(i=0,l=0;i<t;i+=o,l++){const h=c[l];this._singleTransform2(i,h,s)}else for(i=0,l=0;i<t;i+=o,l++){const h=c[l];this._singleTransform4(i,h,s)}var a=this._inv?-1:1,m=this.table;for(s>>=2;s>=2;s>>=2){o=t/s<<1;var d=o>>>2;for(i=0;i<t;i+=o)for(var g=i+d,f=i,u=0;f<g;f+=2,u+=s){const h=f,_=h+d,y=_+d,A=y+d,C=e[h],b=e[h+1],S=e[_],w=e[_+1],F=e[y],P=e[y+1],k=e[A],G=e[A+1],q=C,U=b,H=m[u],O=a*m[u+1],K=S*H-w*O,J=S*O+w*H,ee=m[2*u],j=a*m[2*u+1],te=F*ee-P*j,re=F*j+P*ee,ie=m[3*u],ae=a*m[3*u+1],se=k*ie-G*ae,le=k*ae+G*ie,v=q+te,p=U+re,D=q-te,B=U-re,E=K+se,Q=J+le,ne=a*(K-se),oe=a*(J-le),de=v+E,ge=p+Q,X=v-E,fe=p-Q,ve=D+oe,me=B-ne,R=D-oe,ce=B+ne;e[h]=de,e[h+1]=ge,e[_]=ve,e[_+1]=me,e[y]=X,e[y+1]=fe,e[A]=R,e[A+1]=ce}}};L.prototype._singleTransform2=function(e,t,n){const s=this._out,o=this._data,i=o[t],l=o[t+1],c=o[t+n],a=o[t+n+1],m=i+c,d=l+a,g=i-c,f=l-a;s[e]=m,s[e+1]=d,s[e+2]=g,s[e+3]=f};L.prototype._singleTransform4=function(e,t,n){const s=this._out,o=this._data,i=this._inv?-1:1,l=n*2,c=n*3,a=o[t],m=o[t+1],d=o[t+n],g=o[t+n+1],f=o[t+l],u=o[t+l+1],h=o[t+c],_=o[t+c+1],y=a+f,A=m+u,C=a-f,b=m-u,S=d+h,w=g+_,F=i*(d-h),P=i*(g-_),k=y+S,G=A+w,q=C+P,U=b-F,H=y-S,O=A-w,K=C-P,J=b+F;s[e]=k,s[e+1]=G,s[e+2]=q,s[e+3]=U,s[e+4]=H,s[e+5]=O,s[e+6]=K,s[e+7]=J};L.prototype._realTransform4=function(){var e=this._out,t=this._csize,n=this._width,s=1<<n,o=t/s<<1,i,l,c=this._bitrev;if(o===4)for(i=0,l=0;i<t;i+=o,l++){const we=c[l];this._singleRealTransform2(i,we>>>1,s>>>1)}else for(i=0,l=0;i<t;i+=o,l++){const we=c[l];this._singleRealTransform4(i,we>>>1,s>>>1)}var a=this._inv?-1:1,m=this.table;for(s>>=2;s>=2;s>>=2){o=t/s<<1;var d=o>>>1,g=d>>>1,f=g>>>1;for(i=0;i<t;i+=o)for(var u=0,h=0;u<=f;u+=2,h+=s){var _=i+u,y=_+g,A=y+g,C=A+g,b=e[_],S=e[_+1],w=e[y],F=e[y+1],P=e[A],k=e[A+1],G=e[C],q=e[C+1],U=b,H=S,O=m[h],K=a*m[h+1],J=w*O-F*K,ee=w*K+F*O,j=m[2*h],te=a*m[2*h+1],re=P*j-k*te,ie=P*te+k*j,ae=m[3*h],se=a*m[3*h+1],le=G*ae-q*se,v=G*se+q*ae,p=U+re,D=H+ie,B=U-re,E=H-ie,Q=J+le,ne=ee+v,oe=a*(J-le),de=a*(ee-v),ge=p+Q,X=D+ne,fe=B+de,ve=E-oe;if(e[_]=ge,e[_+1]=X,e[y]=fe,e[y+1]=ve,u===0){var me=p-Q,R=D-ne;e[A]=me,e[A+1]=R;continue}if(u!==f){var ce=B,Re=-E,qe=p,Le=-D,Ge=-a*de,We=-a*oe,Ue=-a*ne,Qe=-a*Q,Ke=ce+Ge,Je=Re+We,je=qe+Qe,Xe=Le-Ue,He=i+g-u,Ve=i+d-u;e[He]=Ke,e[He+1]=Je,e[Ve]=je,e[Ve+1]=Xe}}}};L.prototype._singleRealTransform2=function(e,t,n){const s=this._out,o=this._data,i=o[t],l=o[t+n],c=i+l,a=i-l;s[e]=c,s[e+1]=0,s[e+2]=a,s[e+3]=0};L.prototype._singleRealTransform4=function(e,t,n){const s=this._out,o=this._data,i=this._inv?-1:1,l=n*2,c=n*3,a=o[t],m=o[t+n],d=o[t+l],g=o[t+c],f=a+d,u=a-d,h=m+g,_=i*(m-g),y=f+h,A=u,C=-_,b=f-h,S=u,w=_;s[e]=y,s[e+1]=0,s[e+2]=A,s[e+3]=C,s[e+4]=b,s[e+5]=0,s[e+6]=S,s[e+7]=w};const rt=nt(ot);class ye{constructor(e,t){W(this,"_inputLength");W(this,"_fft");W(this,"_bufferSupplier");W(this,"_paddedInputBuffer");W(this,"_transformBuffer");W(this,"_inverseBuffer");if(e<1)throw new Error("Input length must be at least one");this._inputLength=e,this._fft=new rt(lt(2*e)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(e){return new ye(e,t=>new Float32Array(t))}static forFloat64Array(e){return new ye(e,t=>new Float64Array(t))}static forNumberArray(e){return new ye(e,t=>Array(t))}get inputLength(){return this._inputLength}autocorrelate(e,t=this._bufferSupplier(e.length)){if(e.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${e.length}`);for(let s=0;s<e.length;s++)this._paddedInputBuffer[s]=e[s];for(let s=e.length;s<this._paddedInputBuffer.length;s++)this._paddedInputBuffer[s]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const n=this._transformBuffer;for(let s=0;s<n.length;s+=2)n[s]=n[s]*n[s]+n[s+1]*n[s+1],n[s+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let s=0;s<e.length;s++)t[s]=this._inverseBuffer[2*s];return t}}function it(r){const e=[];let t=!1,n=-1/0,s=-1;for(let o=1;o<r.length-1;o++)r[o-1]<=0&&r[o]>0?(t=!0,s=o,n=r[o]):r[o-1]>0&&r[o]<=0?(t=!1,s!==-1&&e.push(s)):t&&r[o]>n&&(n=r[o],s=o);return e}function at(r,e){const[t,n,s]=[r-1,r,r+1],[o,i,l]=[e[t],e[n],e[s]],c=o/2-i+l/2,a=-(o/2)*(n+s)+i*(t+s)-l/2*(t+n),m=o*n*s/2-i*t*s+l*t*n/2,d=-a/(2*c),g=c*d*d+a*d+m;return[d,g]}class _e{constructor(e,t){W(this,"_autocorrelator");W(this,"_nsdfBuffer");W(this,"_clarityThreshold",.9);W(this,"_minVolumeAbsolute",0);W(this,"_maxInputAmplitude",1);this._autocorrelator=new ye(e,t),this._nsdfBuffer=t(e)}static forFloat32Array(e){return new _e(e,t=>new Float32Array(t))}static forFloat64Array(e){return new _e(e,t=>new Float64Array(t))}static forNumberArray(e){return new _e(e,t=>Array(t))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(e){if(!Number.isFinite(e)||e<=0||e>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=e}set minVolumeAbsolute(e){if(!Number.isFinite(e)||e<0||e>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=e}set minVolumeDecibels(e){if(!Number.isFinite(e)||e>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(e/10)}set maxInputAmplitude(e){if(!Number.isFinite(e)||e<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=e}findPitch(e,t){if(this._belowMinimumVolume(e))return[0,0];this._nsdf(e);const n=it(this._nsdfBuffer);if(n.length===0)return[0,0];const s=Math.max(...n.map(c=>this._nsdfBuffer[c])),o=n.find(c=>this._nsdfBuffer[c]>=this._clarityThreshold*s),[i,l]=at(o,this._nsdfBuffer);return[t/i,Math.min(l,1)]}_belowMinimumVolume(e){if(this._minVolumeAbsolute===0)return!1;let t=0;for(let n=0;n<e.length;n++)t+=e[n]**2;return Math.sqrt(t/e.length)<this._minVolumeAbsolute}_nsdf(e){this._autocorrelator.autocorrelate(e,this._nsdfBuffer);let t=2*this._nsdfBuffer[0],n;for(n=0;n<this._nsdfBuffer.length&&t>0;n++)this._nsdfBuffer[n]=2*this._nsdfBuffer[n]/t,t-=e[n]**2+e[e.length-n-1]**2;for(;n<this._nsdfBuffer.length;n++)this._nsdfBuffer[n]=0}}function lt(r){return r--,r|=r>>1,r|=r>>2,r|=r>>4,r|=r>>8,r|=r>>16,r++,r}function ct(r){let e,t,n,s,o,i;return{c(){e=I("div"),t=I("div"),n=I("div"),s=Z(),o=I("div"),this.h()},l(l){e=z(l,"DIV",{class:!0});var c=V(e);t=z(c,"DIV",{class:!0,style:!0});var a=V(t);n=z(a,"DIV",{class:!0,style:!0}),V(n).forEach(T),a.forEach(T),s=Y(c),o=z(c,"DIV",{class:!0,style:!0}),V(o).forEach(T),c.forEach(T),this.h()},h(){x(n,"class","volume-bar-fill"),N(n,"position","absolute"),N(n,"top","0"),N(n,"left","0"),N(n,"height","100%"),x(t,"class","volume-bar-bg"),N(t,"height",r[1]),N(t,"border-radius","9999px"),N(t,"background-color","#e2e8f0"),N(t,"position","relative"),N(t,"overflow","hidden"),x(o,"class","threshold-indicator svelte-13z7ppf"),N(o,"position","absolute"),N(o,"top","0"),N(o,"left",r[0]+"%"),N(o,"width","2px"),N(o,"height",r[1]),N(o,"background-color","#64748b"),N(o,"border-radius","1px"),x(e,"class",i="volume-bar-container "+r[2]+" svelte-13z7ppf")},m(l,c){he(l,e,c),M(e,t),M(t,n),r[5](n),M(e,s),M(e,o)},p(l,[c]){c&2&&N(t,"height",l[1]),c&1&&N(o,"left",l[0]+"%"),c&2&&N(o,"height",l[1]),c&4&&i!==(i="volume-bar-container "+l[2]+" svelte-13z7ppf")&&x(e,"class",i)},i:ke,o:ke,d(l){l&&T(e),r[5](null)}}}function ut(r,e,t){let{volume:n=0}=e,{threshold:s=30}=e,{height:o="12px"}=e,{className:i=""}=e,l;function c(d){return d<s?`rgba(37, 99, 235, ${Math.max(.2,d/s*.8)})`:"#2563eb"}function a(d){if(l){const g=Math.max(0,Math.min(100,d)),f=c(g);t(3,l.style.width=`${g}%`,l),t(3,l.style.backgroundColor=f,l)}}Oe(()=>{l&&(t(3,l.style.width="0%",l),t(3,l.style.backgroundColor="#2563eb",l),t(3,l.style.height=o,l),t(3,l.style.borderRadius="9999px",l),t(3,l.style.transition="width 0.2s ease-out, background-color 0.2s ease-out",l))});function m(d){$e[d?"unshift":"push"](()=>{l=d,t(3,l)})}return r.$$set=d=>{"volume"in d&&t(4,n=d.volume),"threshold"in d&&t(0,s=d.threshold),"height"in d&&t(1,o=d.height),"className"in d&&t(2,i=d.className)},r.$$.update=()=>{r.$$.dirty&16&&a(n)},[s,o,i,l,n,m]}class Be extends xe{constructor(e){super(),Te(this,e,ut,ct,Fe,{volume:4,threshold:0,height:1,className:2})}}class ht{constructor(){this.audioContext=null,this.mediaStream=null,this.sourceNode=null,this.gainNode=null,this.analysers=new Map,this.filters=new Map,this.refCount=0,this.initPromise=null,this.isInitialized=!1,this.lastError=null,this.currentSensitivity=this._getDefaultSensitivity()}_getDefaultSensitivity(){const e=/iPhone/.test(navigator.userAgent),t=/iPad/.test(navigator.userAgent),n=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document;return t||n?(console.log("ğŸ”§ [AudioManager] iPadæ¤œå‡º - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ„Ÿåº¦5.0xè¨­å®š"),5):e?(console.log("ğŸ”§ [AudioManager] iPhoneæ¤œå‡º - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ„Ÿåº¦3.0xè¨­å®š"),3):(console.log("ğŸ”§ [AudioManager] PCæ¤œå‡º - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ„Ÿåº¦1.0xè¨­å®š"),1)}async initialize(){var e,t,n;if(this.initPromise)return this.initPromise;if(this.isInitialized&&this.audioContext&&this.mediaStream){const s=this.checkMediaStreamHealth();if(s.healthy)return this.refCount++,{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode};console.warn("âš ï¸ [AudioManager] MediaStreamä¸å¥åº·æ¤œå‡º - å¼·åˆ¶å†åˆæœŸåŒ–:",s.reason),console.log("ğŸ”„ [AudioManager] ä¸å¥åº·ãªMediaStreamè©³ç´°:",{mediaStreamActive:(e=this.mediaStream)==null?void 0:e.active,trackCount:(t=this.mediaStream)==null?void 0:t.getTracks().length,trackStates:(n=this.mediaStream)==null?void 0:n.getTracks().map(o=>({kind:o.kind,readyState:o.readyState,enabled:o.enabled,muted:o.muted}))}),this._cleanup(),this.isInitialized=!1,this.refCount=0,await new Promise(o=>setTimeout(o,100)),console.log("ğŸ”„ [AudioManager] ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº† - å†åˆæœŸåŒ–é–‹å§‹")}this.initPromise=this._doInitialize();try{const s=await this.initPromise;return this.initPromise=null,s}catch(s){throw this.initPromise=null,s}}async _doInitialize(){try{if(console.log("ğŸ¤ [AudioManager] åˆæœŸåŒ–é–‹å§‹"),this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),console.log("âœ… [AudioManager] AudioContextä½œæˆå®Œäº†")),this.audioContext.state==="suspended"&&(await this.audioContext.resume(),console.log("âœ… [AudioManager] AudioContextå†é–‹å®Œäº†")),!this.mediaStream){const e=/iPhone/.test(navigator.userAgent),t=/iPad/.test(navigator.userAgent),n=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document,s=e||t||n;console.log(`ğŸ” [AudioManager] ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º: ${t||n?"iPad":e?"iPhone":"ãã®ä»–"}`,navigator.userAgent),console.log(`ğŸ” [AudioManager] ã‚¿ãƒƒãƒã‚µãƒãƒ¼ãƒˆ: ${"ontouchend"in document}`);const i={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,...s&&{googAutoGainControl:!1,googNoiseSuppression:!1,googEchoCancellation:!1,googHighpassFilter:!1,googTypingNoiseDetection:!1,googBeamforming:!1,mozAutoGainControl:!1,mozNoiseSuppression:!1},sampleRate:44100,channelCount:1,sampleSize:16,latency:.1,volume:1,deviceId:{ideal:"default"}}};console.log("ğŸ¤ [AudioManager] Safariå¯¾å¿œè¨­å®šã§MediaStreamå–å¾—ä¸­:",i),this.mediaStream=await navigator.mediaDevices.getUserMedia(i),console.log("âœ… [AudioManager] MediaStreamå–å¾—å®Œäº†")}if(!this.sourceNode){this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),console.log("âœ… [AudioManager] SourceNodeä½œæˆå®Œäº†");const e=this.mediaStream.getTracks();console.log("ğŸ¤ [AudioManager] MediaStream tracks:",e.map(t=>({kind:t.kind,label:t.label,enabled:t.enabled,readyState:t.readyState,muted:t.muted})))}return this.gainNode||(this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=this.currentSensitivity,this.sourceNode.connect(this.gainNode),console.log(`âœ… [AudioManager] GainNodeä½œæˆå®Œäº† (æ„Ÿåº¦: ${this.currentSensitivity}x)`)),this.isInitialized=!0,this.refCount++,this.lastError=null,console.log(`ğŸ¤ [AudioManager] åˆæœŸåŒ–å®Œäº† (å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆ: ${this.refCount})`),{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode}}catch(e){throw console.error("âŒ [AudioManager] åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:",e),this.lastError=e,this.isInitialized=!1,this._cleanup(),e}}createAnalyser(e,t={}){if(!this.isInitialized||!this.audioContext||!this.sourceNode)throw new Error("AudioManager not initialized. Call initialize() first.");this.removeAnalyser(e);const{fftSize:n=2048,smoothingTimeConstant:s=.8,minDecibels:o=-90,maxDecibels:i=-10,useFilters:l=!0}=t,c=this.audioContext.createAnalyser();c.fftSize=Math.min(n,2048),c.smoothingTimeConstant=Math.max(s,.7),c.minDecibels=Math.max(o,-80),c.maxDecibels=Math.min(i,-10);let a=this.gainNode||this.sourceNode;if(l){const m=this._createFilterChain();this.filters.set(e,m),a.connect(m.highpass),m.highpass.connect(m.lowpass),m.lowpass.connect(m.notch),m.notch.connect(c),console.log(`ğŸ”§ [AudioManager] ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä»˜ãAnalyserä½œæˆ: ${e}`)}else a.connect(c),console.log(`ğŸ”§ [AudioManager] ç”Ÿä¿¡å·Analyserä½œæˆ: ${e}`);return this.analysers.set(e,c),c}_createFilterChain(){const e=this.audioContext.createBiquadFilter();e.type="highpass",e.frequency.setValueAtTime(80,this.audioContext.currentTime),e.Q.setValueAtTime(.7,this.audioContext.currentTime);const t=this.audioContext.createBiquadFilter();t.type="lowpass",t.frequency.setValueAtTime(800,this.audioContext.currentTime),t.Q.setValueAtTime(.7,this.audioContext.currentTime);const n=this.audioContext.createBiquadFilter();return n.type="notch",n.frequency.setValueAtTime(60,this.audioContext.currentTime),n.Q.setValueAtTime(10,this.audioContext.currentTime),{highpass:e,lowpass:t,notch:n}}removeAnalyser(e){if(this.analysers.has(e)&&(this.analysers.get(e).disconnect(),this.analysers.delete(e),console.log(`ğŸ—‘ï¸ [AudioManager] Analyserå‰Šé™¤: ${e}`)),this.filters.has(e)){const t=this.filters.get(e);t.highpass.disconnect(),t.lowpass.disconnect(),t.notch.disconnect(),this.filters.delete(e),console.log(`ğŸ—‘ï¸ [AudioManager] ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒã‚§ãƒ¼ãƒ³å‰Šé™¤: ${e}`)}}setSensitivity(e){const t=Math.max(.1,Math.min(10,e));this.gainNode?(this.gainNode.gain.value=t,this.currentSensitivity=t,console.log(`ğŸ¤ [AudioManager] ãƒã‚¤ã‚¯æ„Ÿåº¦æ›´æ–°: ${t.toFixed(1)}x`)):(this.currentSensitivity=t,console.log(`ğŸ¤ [AudioManager] ãƒã‚¤ã‚¯æ„Ÿåº¦è¨­å®šï¼ˆåˆæœŸåŒ–å¾…ã¡ï¼‰: ${t.toFixed(1)}x`))}getSensitivity(){return this.currentSensitivity}getPlatformSpecs(){const e=/iPhone/.test(navigator.userAgent),t=/iPad/.test(navigator.userAgent),n=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document,s=e||t||n;return{divisor:s?4:6,gainCompensation:s?1.5:1,noiseThreshold:s?12:15,smoothingFactor:.2,deviceType:t||n?"iPad":e?"iPhone":"PC",isIOS:s}}release(e=[]){e.forEach(t=>this.removeAnalyser(t)),this.refCount=Math.max(0,this.refCount-1),console.log(`ğŸ“‰ [AudioManager] å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆæ¸›ç®—: ${this.refCount}`),this.refCount<=0&&(console.log("ğŸ§¹ [AudioManager] å…¨ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹"),this._cleanup())}forceCleanup(){console.log("ğŸš¨ [AudioManager] å¼·åˆ¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œ"),this._cleanup()}_cleanup(){console.log("ğŸ§¹ [AudioManager] ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹");for(const e of this.analysers.keys())this.removeAnalyser(e);if(this.mediaStream){const e=this.mediaStream.getTracks();console.log(`ğŸ›‘ [AudioManager] MediaStreamåœæ­¢ä¸­: ${e.length} tracks`),e.forEach((t,n)=>{try{t.readyState!=="ended"?(t.stop(),console.log(`ğŸ›‘ [AudioManager] Track ${n} åœæ­¢å®Œäº†`)):console.log(`âš ï¸ [AudioManager] Track ${n} æ—¢ã«çµ‚äº†æ¸ˆã¿`)}catch(s){console.warn(`âš ï¸ [AudioManager] Track ${n} åœæ­¢ã‚¨ãƒ©ãƒ¼:`,s)}}),this.mediaStream=null}if(this.audioContext&&this.audioContext.state!=="closed"){try{this.audioContext.close(),console.log("ğŸ›‘ [AudioManager] AudioContexté–‰é–å®Œäº†")}catch(e){console.warn("âš ï¸ [AudioManager] AudioContexté–‰é–ã‚¨ãƒ©ãƒ¼:",e)}this.audioContext=null}this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.isInitialized=!1,this.refCount=0,this.initPromise=null,this.currentSensitivity=this._getDefaultSensitivity(),console.log("âœ… [AudioManager] ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†")}getStatus(){var e,t;return{isInitialized:this.isInitialized,refCount:this.refCount,audioContextState:((e=this.audioContext)==null?void 0:e.state)||"none",mediaStreamActive:((t=this.mediaStream)==null?void 0:t.active)||!1,activeAnalysers:Array.from(this.analysers.keys()),activeFilters:Array.from(this.filters.keys()),lastError:this.lastError}}checkMediaStreamHealth(){if(!this.mediaStream)return{healthy:!1,reason:"MediaStream not initialized"};if(!this.mediaStream.active)return{healthy:!1,reason:"MediaStream inactive"};const e=this.mediaStream.getTracks();if(e.length===0)return{healthy:!1,reason:"No tracks available"};const t=e.find(n=>n.kind==="audio");return t?t.readyState==="ended"?{healthy:!1,reason:"Audio track ended"}:t.enabled?t.muted?{healthy:!1,reason:"Audio track muted"}:this.mediaStream.active&&t.readyState!=="live"?{healthy:!1,reason:"Track state inconsistent with MediaStream"}:{healthy:!0,track:t}:{healthy:!1,reason:"Audio track disabled"}:{healthy:!1,reason:"No audio track found"}}}const Ce=new ht;class dt{constructor(e={}){this.vocalRangeMin=e.vocalRangeMin||130.81,this.vocalRangeMax=e.vocalRangeMax||1046.5,this.stabilityThreshold=e.stabilityThreshold||.3,this.evaluationWeights={vocalRange:e.vocalRangeWeight||.4,continuity:e.continuityWeight||.4,musical:e.musicalWeight||.2},this.fundamentalCandidates=e.fundamentalCandidates||[1,.5,.333,2],this.harmonicHistory=[],this.previousFrequency=0,this.maxHistoryLength=5,this.debugMode=!1,this.volumeThreshold=e.volumeThreshold||.02,this.currentContext={}}correctHarmonic(e,t=1,n=!1){if(!e||e<=0)return 0;const s=t>=this.volumeThreshold,i=this.fundamentalCandidates.map(a=>({frequency:e*a,ratio:a})).map(a=>{const m=this.evaluateFundamental(a.frequency);return{...a,...m}}),l=i.reduce((a,m)=>m.totalScore>a.totalScore?m:a),c=this.stabilizeFrequency(l.frequency,s);return(n||this.debugMode)&&this.logHarmonicCorrection(e,i,l,c,this.currentContext,t,s),s&&(this.previousFrequency=c),c}logHarmonicCorrection(e,t,n,s,o={},i=1,l=!0){console.group(`ğŸ”§ [HarmonicCorrection] ${e.toFixed(1)}Hz â†’ ${s.toFixed(1)}Hz`),console.log(`ğŸ”Š éŸ³é‡: ${(i*100).toFixed(1)}% (é–¾å€¤: ${(this.volumeThreshold*100).toFixed(1)}%) ${l?"âœ… æœ‰åŠ¹":"âŒ ãƒã‚¤ã‚ºé™¤å¤–"}`);const c=this.frequencyToNote(e),a=this.frequencyToNote(s);console.log(`ğŸ“ éŸ³ç¨‹å¤‰æ›: ${c} â†’ ${a}`);const m=this.getCorrectionType(n.ratio);if(console.log(`ğŸ¯ è£œæ­£ã‚¿ã‚¤ãƒ—: ${m}`),o.baseFrequency&&o.currentScale&&o.targetFrequency){console.log("ğŸµ éŸ³éšã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ:"),console.log(`   åŸºéŸ³: ${o.baseFrequency.toFixed(1)}Hz (${this.frequencyToNote(o.baseFrequency)})`),console.log(`   ç¾åœ¨ã®éŸ³éš: ${o.currentScale}`),console.log(`   ç›®æ¨™å‘¨æ³¢æ•°: ${o.targetFrequency.toFixed(1)}Hz (${this.frequencyToNote(o.targetFrequency)})`);const g=s-o.targetFrequency,f=1200*Math.log2(s/o.targetFrequency);console.log(`   ç›®æ¨™ã¨ã®å·®: ${g>0?"+":""}${g.toFixed(1)}Hz (${f>0?"+":""}${f.toFixed(0)}ã‚»ãƒ³ãƒˆ)`);const u=Math.abs(f)<=50?"ğŸ¯ é«˜ç²¾åº¦":Math.abs(f)<=100?"âœ… è‰¯å¥½":Math.abs(f)<=200?"âš ï¸ è¦æ”¹å–„":"âŒ ä¸æ­£ç¢º";console.log(`   ç²¾åº¦è©•ä¾¡: ${u} (${Math.abs(f).toFixed(0)}ã‚»ãƒ³ãƒˆå·®)`)}console.table(t.map(g=>({å€ç‡:`${g.ratio.toFixed(3)}x`,å‘¨æ³¢æ•°:`${g.frequency.toFixed(1)}Hz`,éŸ³å:this.frequencyToNote(g.frequency),éŸ³åŸŸ:g.vocalRangeScore.toFixed(2),é€£ç¶šæ€§:g.continuityScore.toFixed(2),éŸ³æ¥½æ€§:g.musicalScore.toFixed(2),ç·åˆ:g.totalScore.toFixed(3),é¸æŠ:g===n?"âœ…":""})));const d=Math.abs(s-n.frequency);d>.5&&console.log(`ğŸ”„ å®‰å®šåŒ–: ${n.frequency.toFixed(1)}Hz â†’ ${s.toFixed(1)}Hz (${d.toFixed(1)}Hzèª¿æ•´)`),console.groupEnd()}getCorrectionType(e){return Math.abs(e-1)<.01?"è£œæ­£ãªã—ï¼ˆåŸºéŸ³ï¼‰":Math.abs(e-.5)<.01?"2å€éŸ³è£œæ­£ï¼ˆ1ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸‹ï¼‰":Math.abs(e-.333)<.01?"3å€éŸ³è£œæ­£ï¼ˆ1ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–+5åº¦ä¸‹ï¼‰":Math.abs(e-.25)<.01?"4å€éŸ³è£œæ­£ï¼ˆ2ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸‹ï¼‰":Math.abs(e-2)<.01?"ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸Šè£œæ­£":`ã‚«ã‚¹ã‚¿ãƒ è£œæ­£ï¼ˆ${e.toFixed(3)}xï¼‰`}frequencyToNote(e){if(!e||e<=0)return"---";const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],s=Math.round(12*Math.log2(e/440)),o=(s+9+120)%12,i=Math.floor((s+9)/12)+4;return t[o]+i}evaluateFundamental(e){const n=e>=this.vocalRangeMin&&e<=this.vocalRangeMax?1:0,s=this.previousFrequency>0?1-Math.min(Math.abs(e-this.previousFrequency)/this.previousFrequency,1):.5,o=this.calculateMusicalScore(e),i=n*this.evaluationWeights.vocalRange+s*this.evaluationWeights.continuity+o*this.evaluationWeights.musical;return{vocalRangeScore:n,continuityScore:s,musicalScore:o,totalScore:i}}calculateMusicalScore(e){const n=Math.log2(e/261.63)*12,s=Math.round(n),o=Math.abs(n-s);return Math.max(0,1-o/.5)}stabilizeFrequency(e,t=!0){if(!e||e<=0)return 0;if(t&&this.harmonicHistory.push(e),this.harmonicHistory.length>this.maxHistoryLength&&this.harmonicHistory.shift(),this.harmonicHistory.length<2)return e;const n=[...this.harmonicHistory].sort((l,c)=>l-c),s=n[Math.floor(n.length/2)],o=s*this.stabilityThreshold;return Math.abs(e-s)>o?s+Math.sign(e-s)*o:e}resetHistory(){this.harmonicHistory=[],this.previousFrequency=0}updateConfig(e){Object.assign(this,e),console.log("âš™ï¸ [HarmonicCorrection] è¨­å®šæ›´æ–°:",e)}enableDebugLogging(){this.debugMode=!0,console.log("ğŸ” [HarmonicCorrection] ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°æœ‰åŠ¹åŒ– - æ¬¡å›ã®è£œæ­£ã‹ã‚‰è©³ç´°ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¾ã™"),console.log("ç„¡åŠ¹åŒ–ã™ã‚‹ã«ã¯: harmonicCorrection.disableDebugLogging()")}disableDebugLogging(){this.debugMode=!1,console.log("ğŸ” [HarmonicCorrection] ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ç„¡åŠ¹åŒ–")}setScaleContext(e){this.currentContext={baseFrequency:e.baseFrequency,currentScale:e.currentScale,targetFrequency:e.targetFrequency}}clearContext(){this.currentContext={}}getStatus(){return{vocalRangeMin:this.vocalRangeMin,vocalRangeMax:this.vocalRangeMax,stabilityThreshold:this.stabilityThreshold,evaluationWeights:this.evaluationWeights,historyLength:this.harmonicHistory.length,previousFrequency:this.previousFrequency,recentHistory:this.harmonicHistory.slice(-3)}}}const Se=new dt,ft=(()=>{if(typeof import.meta<"u")return"error";if(typeof window<"u"){const e=new URLSearchParams(window.location.search).get("debug");if(e)return e}return"info"})(),$={error:0,warn:1,info:2,debug:3},ue=$[ft]??$.info,mt={error:(r,...e)=>{ue>=$.error&&console.error(`âŒ ${r}`,...e)},warn:(r,...e)=>{ue>=$.warn&&console.warn(`âš ï¸ ${r}`,...e)},info:(r,...e)=>{ue>=$.info&&console.log(`â„¹ï¸ ${r}`,...e)},debug:(r,...e)=>{ue>=$.debug&&console.log(`ğŸ” ${r}`,...e)},realtime:(()=>{let r=0;const e=1e3;return(t,...n)=>{if(ue>=$.debug){const s=Date.now();s-r>=e&&(console.log(`ğŸ“Š ${t}`,...n),r=s)}}})(),scoring:(r,...e)=>{ue>=$.info&&console.log(`ğŸ¯ ${r}`,...e)},audio:(r,...e)=>{ue>=$.info&&console.log(`ğŸ¤ ${r}`,...e)}};function gt(r){let e,t,n,s,o=(r[2]>0?Math.round(r[2]):"---")+"",i,l,c,a="Hz",m,d,g="|",f,u,h,_,y,A,C;return y=new Be({props:{volume:r[2]>0?r[1]:0,className:"volume-bar"}}),{c(){e=I("div"),t=I("div"),n=I("div"),s=I("span"),i=Ae(o),l=Z(),c=I("span"),c.textContent=a,m=Z(),d=I("span"),d.textContent=g,f=Z(),u=I("span"),h=Ae(r[3]),_=Z(),Ee(y.$$.fragment),this.h()},l(b){e=z(b,"DIV",{class:!0});var S=V(e);t=z(S,"DIV",{class:!0});var w=V(t);n=z(w,"DIV",{class:!0});var F=V(n);s=z(F,"SPAN",{class:!0});var P=V(s);i=pe(P,o),P.forEach(T),l=Y(F),c=z(F,"SPAN",{class:!0,"data-svelte-h":!0}),Me(c)!=="svelte-5uyilv"&&(c.textContent=a),m=Y(F),d=z(F,"SPAN",{class:!0,"data-svelte-h":!0}),Me(d)!=="svelte-1dytxz4"&&(d.textContent=g),f=Y(F),u=z(F,"SPAN",{class:!0});var k=V(u);h=pe(k,r[3]),k.forEach(T),F.forEach(T),_=Y(w),Ne(y.$$.fragment,w),w.forEach(T),S.forEach(T),this.h()},h(){x(s,"class","detected-frequency svelte-vc1bho"),x(c,"class","hz-suffix svelte-vc1bho"),x(d,"class","divider svelte-vc1bho"),x(u,"class","detected-note svelte-vc1bho"),x(n,"class","detection-card svelte-vc1bho"),x(t,"class","detection-display svelte-vc1bho"),x(e,"class",A="pitch-detector "+r[0]+" svelte-vc1bho")},m(b,S){he(b,e,S),M(e,t),M(t,n),M(n,s),M(s,i),M(n,l),M(n,c),M(n,m),M(n,d),M(n,f),M(n,u),M(u,h),M(t,_),Pe(y,t,null),C=!0},p(b,S){(!C||S[0]&4)&&o!==(o=(b[2]>0?Math.round(b[2]):"---")+"")&&be(i,o),(!C||S[0]&8)&&be(h,b[3]);const w={};S[0]&6&&(w.volume=b[2]>0?b[1]:0),y.$set(w),(!C||S[0]&1&&A!==(A="pitch-detector "+b[0]+" svelte-vc1bho"))&&x(e,"class",A)},i(b){C||(Ie(y.$$.fragment,b),C=!0)},o(b){ze(y.$$.fragment,b),C=!1},d(b){b&&T(e),De(y)}}}function vt(r){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(r<=0)return"ãƒ¼ãƒ¼";const n=Math.round(12*Math.log2(r/440)),s=(n+9+120)%12,o=Math.floor((n+9)/12)+4;return e[s]+o}function yt(r,e,t){const n=et();let{isActive:s=!1}=e,{className:o=""}=e,{debugMode:i=!1}=e,{trainingPhase:l=""}=e,{disableHarmonicCorrection:c=!1}=e,a="uninitialized",m=null,d=!1,g=null,f=null,u=null,h=null,_=null,y=null,A=null,C=!1,b=[],S=new Map,w=0,F=0,P=0,k="ãƒ¼ãƒ¼",G=0,q=[],U=0,H=null;function O(){w=0,t(1,F=0),t(2,P=0),t(3,k="ãƒ¼ãƒ¼"),G=0,U=0,q=[],Se.resetHistory(),i&&console.log("ğŸ”„ [PitchDetector] Display state reset")}function K(){if(!i)return;const v=new Date().toLocaleTimeString(),p={timestamp:v,componentState:a,isActive:s,isDetecting:C,isInitialized:d,mediaStreamActive:f?f.active:null,mediaStreamTracks:f?f.getTracks().length:0,trackStates:f?f.getTracks().map(E=>({kind:E.kind,enabled:E.enabled,readyState:E.readyState,muted:E.muted})):[],audioContextState:g?g.state:null,hasAnalyser:!!h,currentVolume:w,currentFrequency:P};mt.realtime(`[PitchDetector] ${v}:`,p);let D=!0,B=[];f&&!f.active&&(console.warn("âš ï¸ [PitchDetector] MediaStream is inactive!",f),D=!1,B.push("MediaStream inactive")),g&&g.state==="suspended"&&(console.warn("âš ï¸ [PitchDetector] AudioContext is suspended!",g),D=!1,B.push("AudioContext suspended")),f&&f.getTracks().forEach((E,Q)=>{E.readyState==="ended"&&(console.error(`âŒ [PitchDetector] Track ${Q} has ended!`,E),D=!1,B.push(`Track ${Q} ended`))}),n("microphoneHealthChange",{healthy:D,errors:B,details:p})}async function J(){try{t(16,a="initializing"),m=null,console.log("ğŸ™ï¸ [PitchDetector] AudioManagerçµŒç”±ã§åˆæœŸåŒ–é–‹å§‹");const v=await Ce.initialize();g=v.audioContext,f=v.mediaStream,u=v.sourceNode,console.log("âœ… [PitchDetector] AudioManager ãƒªã‚½ãƒ¼ã‚¹å–å¾—å®Œäº†");const p=`pitch-detector-filtered-${Date.now()}`;t(17,h=Ce.createAnalyser(p,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!0})),b.push(p);const D=`pitch-detector-raw-${Date.now()}`;_=Ce.createAnalyser(D,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!1}),b.push(D),console.log("âœ… [PitchDetector] Analyserä½œæˆå®Œäº†:",b),y=_e.forFloat32Array(h.fftSize),t(16,a="ready"),d=!0,n("stateChange",{state:a}),le(),console.log("âœ… [PitchDetector] åˆæœŸåŒ–å®Œäº†")}catch(v){throw console.error("âŒ [PitchDetector] åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:",v),t(16,a="error"),m=v,d=!1,n("error",{error:v,context:"initialization"}),v}}function ee(){if(a!=="ready"){const v=new Error(`Cannot start detection: component state is ${a}`);return n("error",{error:v,context:"start-detection"}),!1}if(!h||!y||!g){const v=new Error("Required components not available");return t(16,a="error"),n("error",{error:v,context:"start-detection"}),!1}return t(16,a="detecting"),t(18,C=!0),n("stateChange",{state:a}),te(),!0}function j(){t(18,C=!1),A&&(cancelAnimationFrame(A),A=null),a==="detecting"&&d&&(t(16,a="ready"),n("stateChange",{state:a}))}function te(){if(!C||!h||!_||!y)return;const v=h.fftSize,p=new Float32Array(v),D=new Float32Array(_.fftSize);h.getFloatTimeDomainData(p),_.getFloatTimeDomainData(D);let B=0;for(let R=0;R<v;R++)B+=Math.abs(p[R]);const E=Math.sqrt(B/v),Q=Math.log10(E+.001)*50+100,ne=Math.max(0,Math.min(100,Q));let oe=0;for(let R=0;R<D.length;R++)oe+=Math.abs(D[R]);const de=Math.sqrt(oe/D.length),ge=Math.log10(de+.001)*50+100;t(1,F=Math.max(0,Math.min(100,ge))),q.push(ne),q.length>5&&q.shift(),U=q.reduce((R,ce)=>R+ce,0)/q.length,w=U;const[X,fe]=y.findPitch(p,g.sampleRate),ve=X>=65&&X<=1200;if(X&&fe>.8&&w>30&&ve){let R=X;if(c)i&&console.log("ğŸ”§ [PitchDetector] ãƒãƒ¼ãƒ¢ãƒ‹ãƒƒã‚¯è£œæ­£ç„¡åŠ¹åŒ–ä¸­ - ç”Ÿå€¤ä½¿ç”¨:",X);else{const ce=Math.min(w/100,1);R=Se.correctHarmonic(X,ce)}t(2,P=Math.round(R)),t(3,k=vt(P)),G=fe}else P===0&&Se.resetHistory(),t(2,P=0),t(3,k="ãƒ¼ãƒ¼"),G=0;const me=P>0?F:0;n("pitchUpdate",{frequency:P,note:k,volume:me,rawVolume:me,clarity:G}),A=requestAnimationFrame(te)}function re(){return d&&a==="ready"}function ie(){return{componentState:a,isInitialized:d,isDetecting:C,lastError:m,hasRequiredComponents:!!(h&&y&&g&&f)}}async function ae(){console.log("ğŸ”„ [PitchDetector] å†åˆæœŸåŒ–é–‹å§‹"),se(),await new Promise(v=>setTimeout(v,100)),await J(),console.log("âœ… [PitchDetector] å†åˆæœŸåŒ–å®Œäº†")}function se(){console.log("ğŸ§¹ [PitchDetector] ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹"),j(),S.size>0&&(S.forEach((v,p)=>{p.removeEventListener("ended",v.endedHandler),p.removeEventListener("mute",v.muteHandler),p.removeEventListener("unmute",v.unmuteHandler)}),S.clear(),console.log("ğŸ”„ [PitchDetector] MediaStreamã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼å‰Šé™¤")),b.length>0&&(Ce.release(b),console.log("ğŸ“¤ [PitchDetector] AudioManagerã«Analyserè§£æ”¾é€šçŸ¥:",b),b=[]),t(16,a="uninitialized"),d=!1,m=null,g=null,f=null,u=null,t(17,h=null),_=null,y=null,q=[],Se.resetHistory(),console.log("âœ… [PitchDetector] ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†")}function le(){if(!f)return;const v=f.getTracks();v.forEach(p=>{const D=()=>{console.error("ğŸš¨ [PitchDetector] MediaStreamTrackçµ‚äº†æ¤œå‡º:",p.kind),t(16,a="error"),m=new Error(`MediaStreamTrack (${p.kind}) ended`),n("error",{error:m,reason:"mediastream_ended",recovery:"restart_required"}),C&&j()},B=()=>{console.warn("âš ï¸ [PitchDetector] MediaStreamTrack muted:",p.kind),n("warning",{reason:"track_muted",track:p.kind})},E=()=>{console.log("âœ… [PitchDetector] MediaStreamTrack unmuted:",p.kind),n("info",{reason:"track_unmuted",track:p.kind})};p.addEventListener("ended",D),p.addEventListener("mute",B),p.addEventListener("unmute",E),S.set(p,{endedHandler:D,muteHandler:B,unmuteHandler:E})}),console.log("ğŸ” [PitchDetector] MediaStreamç›£è¦–é–‹å§‹:",v.length+" tracks")}return tt(()=>{H&&(clearInterval(H),t(19,H=null)),console.log("ğŸ”„ [PitchDetector] onDestroy - AudioManagerãƒªã‚½ãƒ¼ã‚¹ã¯ä¿æŒ")}),r.$$set=v=>{"isActive"in v&&t(4,s=v.isActive),"className"in v&&t(0,o=v.className),"debugMode"in v&&t(5,i=v.debugMode),"trainingPhase"in v&&t(6,l=v.trainingPhase),"disableHarmonicCorrection"in v&&t(7,c=v.disableHarmonicCorrection)},r.$$.update=()=>{r.$$.dirty[0]&524320&&(i&&!H?(console.log("ğŸ” [PitchDetector] Debug mode enabled - starting status monitoring"),t(19,H=setInterval(K,3e3)),K()):!i&&H&&(console.log("ğŸ” [PitchDetector] Debug mode disabled - stopping status monitoring"),clearInterval(H),t(19,H=null))),r.$$.dirty[0]&458768&&(s&&a==="ready"&&h&&!C?ee():!s&&C&&j())},[o,F,P,k,s,i,l,c,O,J,ee,j,re,ie,ae,se,a,h,C,H]}class Tt extends xe{constructor(e){super(),Te(this,e,yt,gt,Fe,{isActive:4,className:0,debugMode:5,trainingPhase:6,disableHarmonicCorrection:7,resetDisplayState:8,initialize:9,startDetection:10,stopDetection:11,getIsInitialized:12,getState:13,reinitialize:14,cleanup:15},null,[-1,-1])}get resetDisplayState(){return this.$$.ctx[8]}get initialize(){return this.$$.ctx[9]}get startDetection(){return this.$$.ctx[10]}get stopDetection(){return this.$$.ctx[11]}get getIsInitialized(){return this.$$.ctx[12]}get getState(){return this.$$.ctx[13]}get reinitialize(){return this.$$.ctx[14]}get cleanup(){return this.$$.ctx[15]}}function _t(r){let e,t,n=(r[0]>0?Math.round(r[0]):"---")+"",s,o,i,l="Hz",c,a,m="|",d,g,f;return{c(){e=I("div"),t=I("span"),s=Ae(n),o=Z(),i=I("span"),i.textContent=l,c=Z(),a=I("span"),a.textContent=m,d=Z(),g=I("span"),f=Ae(r[1]),this.h()},l(u){e=z(u,"DIV",{class:!0});var h=V(e);t=z(h,"SPAN",{class:!0});var _=V(t);s=pe(_,n),_.forEach(T),o=Y(h),i=z(h,"SPAN",{class:!0,"data-svelte-h":!0}),Me(i)!=="svelte-5uyilv"&&(i.textContent=l),c=Y(h),a=z(h,"SPAN",{class:!0,"data-svelte-h":!0}),Me(a)!=="svelte-1dytxz4"&&(a.textContent=m),d=Y(h),g=z(h,"SPAN",{class:!0});var y=V(g);f=pe(y,r[1]),y.forEach(T),h.forEach(T),this.h()},h(){x(t,"class","detected-frequency svelte-1datf0r"),x(i,"class","hz-suffix svelte-1datf0r"),x(a,"class","divider svelte-1datf0r"),x(g,"class","detected-note svelte-1datf0r"),x(e,"class","detection-values svelte-1datf0r")},m(u,h){he(u,e,h),M(e,t),M(t,s),M(e,o),M(e,i),M(e,c),M(e,a),M(e,d),M(e,g),M(g,f)},p(u,h){h&1&&n!==(n=(u[0]>0?Math.round(u[0]):"---")+"")&&be(s,n),h&2&&be(f,u[1])},d(u){u&&T(e)}}}function bt(r){let e,t;return{c(){e=I("span"),t=Ae(r[4]),this.h()},l(n){e=z(n,"SPAN",{class:!0});var s=V(e);t=pe(s,r[4]),s.forEach(T),this.h()},h(){x(e,"class","muted-message svelte-1datf0r")},m(n,s){he(n,e,s),M(e,t)},p(n,s){s&16&&be(t,n[4])},d(n){n&&T(e)}}}function pt(r){let e,t='<h3 class="section-title svelte-1datf0r">ğŸ™ï¸ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³ç¨‹æ¤œå‡º</h3>',n,s,o,i,l,c,a,m;function d(u,h){return u[3]?bt:_t}let g=d(r),f=g(r);return a=new Be({props:{volume:!r[3]&&r[0]>0?r[2]:0,className:"volume-bar"}}),{c(){e=I("div"),e.innerHTML=t,n=Z(),s=I("div"),o=I("div"),i=I("div"),l=I("div"),f.c(),c=Z(),Ee(a.$$.fragment),this.h()},l(u){e=z(u,"DIV",{class:!0,"data-svelte-h":!0}),Me(e)!=="svelte-10ekeq9"&&(e.innerHTML=t),n=Y(u),s=z(u,"DIV",{class:!0});var h=V(s);o=z(h,"DIV",{class:!0});var _=V(o);i=z(_,"DIV",{class:!0});var y=V(i);l=z(y,"DIV",{class:!0});var A=V(l);f.l(A),A.forEach(T),c=Y(y),Ne(a.$$.fragment,y),y.forEach(T),_.forEach(T),h.forEach(T),this.h()},h(){x(e,"class","card-header svelte-1datf0r"),x(l,"class","detection-card svelte-1datf0r"),x(i,"class","detection-display svelte-1datf0r"),x(o,"class","pitch-detector svelte-1datf0r"),x(s,"class","card-content svelte-1datf0r")},m(u,h){he(u,e,h),he(u,n,h),he(u,s,h),M(s,o),M(o,i),M(i,l),f.m(l,null),M(i,c),Pe(a,i,null),m=!0},p(u,h){g===(g=d(u))&&f?f.p(u,h):(f.d(1),f=g(u),f&&(f.c(),f.m(l,null)));const _={};h&13&&(_.volume=!u[3]&&u[0]>0?u[2]:0),a.$set(_)},i(u){m||(Ie(a.$$.fragment,u),m=!0)},o(u){ze(a.$$.fragment,u),m=!1},d(u){u&&(T(e),T(n),T(s)),f.d(),De(a)}}}function Mt(r){let e,t;return e=new st({props:{class:"main-card "+r[5],$$slots:{default:[pt]},$$scope:{ctx:r}}}),{c(){Ee(e.$$.fragment)},l(n){Ne(e.$$.fragment,n)},m(n,s){Pe(e,n,s),t=!0},p(n,[s]){const o={};s&32&&(o.class="main-card "+n[5]),s&95&&(o.$$scope={dirty:s,ctx:n}),e.$set(o)},i(n){t||(Ie(e.$$.fragment,n),t=!0)},o(n){ze(e.$$.fragment,n),t=!1},d(n){De(e,n)}}}function At(r,e,t){let{frequency:n=0}=e,{note:s="ãƒ¼ãƒ¼"}=e,{volume:o=0}=e,{isMuted:i=!1}=e,{muteMessage:l="å¾…æ©Ÿä¸­..."}=e,{className:c=""}=e;return r.$$set=a=>{"frequency"in a&&t(0,n=a.frequency),"note"in a&&t(1,s=a.note),"volume"in a&&t(2,o=a.volume),"isMuted"in a&&t(3,i=a.isMuted),"muteMessage"in a&&t(4,l=a.muteMessage),"className"in a&&t(5,c=a.className)},[n,s,o,i,l,c]}class Ft extends xe{constructor(e){super(),Te(this,e,At,Mt,Fe,{frequency:0,note:1,volume:2,isMuted:3,muteMessage:4,className:5})}}export{Ft as P,Ce as a,Tt as b,Se as h,mt as l};
