var vt=Object.defineProperty;var yt=(r,e,t)=>e in r?vt(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var X=(r,e,t)=>yt(r,typeof e!="symbol"?e+"":e,t);import{S as Ge,i as We,s as Ue,d as le,n as tt,a as Qe,D as ke,b as S,G as H,z as P,f as we,g as C,h as T,j as E,k as R,m as te,o as z,p as ne,F as wt,a0 as nt,K as st,q as Ke,r as Je,u as Xe,e as Fe,w as Ye,l as xe,A as Te,x as Ze,t as Ee,y as Oe}from"./zXoIIrMa.js";import{g as bt}from"./D0QH3NT1.js";import"./BntN8Vum.js";import{C as rt}from"./DvJsnY7X.js";function _t(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function Q(r){if(this.size=r|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=r<<1;for(var e=new Array(this.size*2),t=0;t<e.length;t+=2){const u=Math.PI*t/this.size;e[t]=Math.cos(u),e[t+1]=-Math.sin(u)}this.table=e;for(var o=0,n=1;this.size>n;n<<=1)o++;this._width=o%2===0?o-1:o,this._bitrev=new Array(1<<this._width);for(var s=0;s<this._bitrev.length;s++){this._bitrev[s]=0;for(var i=0;i<this._width;i+=2){var d=this._width-i-2;this._bitrev[s]|=(s>>>i&3)<<d}}this._out=null,this._data=null,this._inv=0}var pt=Q;Q.prototype.fromComplexArray=function(e,t){for(var o=t||new Array(e.length>>>1),n=0;n<e.length;n+=2)o[n>>>1]=e[n];return o};Q.prototype.createComplexArray=function(){const e=new Array(this._csize);for(var t=0;t<e.length;t++)e[t]=0;return e};Q.prototype.toComplexArray=function(e,t){for(var o=t||this.createComplexArray(),n=0;n<o.length;n+=2)o[n]=e[n>>>1],o[n+1]=0;return o};Q.prototype.completeSpectrum=function(e){for(var t=this._csize,o=t>>>1,n=2;n<o;n+=2)e[t-n]=e[n],e[t-n+1]=-e[n+1]};Q.prototype.transform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._transform4(),this._out=null,this._data=null};Q.prototype.realTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._realTransform4(),this._out=null,this._data=null};Q.prototype.inverseTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=1,this._transform4();for(var o=0;o<e.length;o++)e[o]/=this.size;this._out=null,this._data=null};Q.prototype._transform4=function(){var e=this._out,t=this._csize,o=this._width,n=1<<o,s=t/n<<1,i,d,u=this._bitrev;if(s===4)for(i=0,d=0;i<t;i+=s,d++){const v=u[d];this._singleTransform2(i,v,n)}else for(i=0,d=0;i<t;i+=s,d++){const v=u[d];this._singleTransform4(i,v,n)}var c=this._inv?-1:1,f=this.table;for(n>>=2;n>=2;n>>=2){s=t/n<<1;var g=s>>>2;for(i=0;i<t;i+=s)for(var h=i+g,w=i,l=0;w<h;w+=2,l+=n){const v=w,y=v+g,m=y+g,b=m+g,p=e[v],I=e[v+1],M=e[y],_=e[y+1],A=e[m],F=e[m+1],x=e[b],N=e[b+1],B=p,W=I,J=f[l],q=c*f[l+1],Z=M*J-_*q,K=M*q+_*J,L=f[2*l],ue=c*f[2*l+1],se=A*L-F*ue,oe=A*ue+F*L,re=f[3*l],O=c*f[3*l+1],ie=x*re-N*O,he=x*O+N*re,de=B+se,ae=W+oe,$=B-se,me=W-oe,ge=Z+ie,a=K+he,D=c*(Z-ie),V=c*(K-he),G=de+ge,j=ae+a,fe=de-ge,De=ae-a,be=$+V,Ce=me-D,Ae=$-V,ee=me+D;e[v]=G,e[v+1]=j,e[y]=be,e[y+1]=Ce,e[m]=fe,e[m+1]=De,e[b]=Ae,e[b+1]=ee}}};Q.prototype._singleTransform2=function(e,t,o){const n=this._out,s=this._data,i=s[t],d=s[t+1],u=s[t+o],c=s[t+o+1],f=i+u,g=d+c,h=i-u,w=d-c;n[e]=f,n[e+1]=g,n[e+2]=h,n[e+3]=w};Q.prototype._singleTransform4=function(e,t,o){const n=this._out,s=this._data,i=this._inv?-1:1,d=o*2,u=o*3,c=s[t],f=s[t+1],g=s[t+o],h=s[t+o+1],w=s[t+d],l=s[t+d+1],v=s[t+u],y=s[t+u+1],m=c+w,b=f+l,p=c-w,I=f-l,M=g+v,_=h+y,A=i*(g-v),F=i*(h-y),x=m+M,N=b+_,B=p+F,W=I-A,J=m-M,q=b-_,Z=p-F,K=I+A;n[e]=x,n[e+1]=N,n[e+2]=B,n[e+3]=W,n[e+4]=J,n[e+5]=q,n[e+6]=Z,n[e+7]=K};Q.prototype._realTransform4=function(){var e=this._out,t=this._csize,o=this._width,n=1<<o,s=t/n<<1,i,d,u=this._bitrev;if(s===4)for(i=0,d=0;i<t;i+=s,d++){const Be=u[d];this._singleRealTransform2(i,Be>>>1,n>>>1)}else for(i=0,d=0;i<t;i+=s,d++){const Be=u[d];this._singleRealTransform4(i,Be>>>1,n>>>1)}var c=this._inv?-1:1,f=this.table;for(n>>=2;n>=2;n>>=2){s=t/n<<1;var g=s>>>1,h=g>>>1,w=h>>>1;for(i=0;i<t;i+=s)for(var l=0,v=0;l<=w;l+=2,v+=n){var y=i+l,m=y+h,b=m+h,p=b+h,I=e[y],M=e[y+1],_=e[m],A=e[m+1],F=e[b],x=e[b+1],N=e[p],B=e[p+1],W=I,J=M,q=f[v],Z=c*f[v+1],K=_*q-A*Z,L=_*Z+A*q,ue=f[2*v],se=c*f[2*v+1],oe=F*ue-x*se,re=F*se+x*ue,O=f[3*v],ie=c*f[3*v+1],he=N*O-B*ie,de=N*ie+B*O,ae=W+oe,$=J+re,me=W-oe,ge=J-re,a=K+he,D=L+de,V=c*(K-he),G=c*(L-de),j=ae+a,fe=$+D,De=me+G,be=ge-V;if(e[y]=j,e[y+1]=fe,e[m]=De,e[m+1]=be,l===0){var Ce=ae-a,Ae=$-D;e[b]=Ce,e[b+1]=Ae;continue}if(l!==w){var ee=me,ze=-ge,He=ae,Ne=-$,U=-c*G,Se=-c*V,ut=-c*D,ht=-c*a,dt=ee+U,mt=ze+Se,ft=He+ht,gt=Ne-ut,$e=i+h-l,et=i+g-l;e[$e]=dt,e[$e+1]=mt,e[et]=ft,e[et+1]=gt}}}};Q.prototype._singleRealTransform2=function(e,t,o){const n=this._out,s=this._data,i=s[t],d=s[t+o],u=i+d,c=i-d;n[e]=u,n[e+1]=0,n[e+2]=c,n[e+3]=0};Q.prototype._singleRealTransform4=function(e,t,o){const n=this._out,s=this._data,i=this._inv?-1:1,d=o*2,u=o*3,c=s[t],f=s[t+o],g=s[t+d],h=s[t+u],w=c+g,l=c-g,v=f+h,y=i*(f-h),m=w+v,b=l,p=-y,I=w-v,M=l,_=y;n[e]=m,n[e+1]=0,n[e+2]=b,n[e+3]=p,n[e+4]=I,n[e+5]=0,n[e+6]=M,n[e+7]=_};const Mt=_t(pt);class Pe{constructor(e,t){X(this,"_inputLength");X(this,"_fft");X(this,"_bufferSupplier");X(this,"_paddedInputBuffer");X(this,"_transformBuffer");X(this,"_inverseBuffer");if(e<1)throw new Error("Input length must be at least one");this._inputLength=e,this._fft=new Mt(At(2*e)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(e){return new Pe(e,t=>new Float32Array(t))}static forFloat64Array(e){return new Pe(e,t=>new Float64Array(t))}static forNumberArray(e){return new Pe(e,t=>Array(t))}get inputLength(){return this._inputLength}autocorrelate(e,t=this._bufferSupplier(e.length)){if(e.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${e.length}`);for(let n=0;n<e.length;n++)this._paddedInputBuffer[n]=e[n];for(let n=e.length;n<this._paddedInputBuffer.length;n++)this._paddedInputBuffer[n]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const o=this._transformBuffer;for(let n=0;n<o.length;n+=2)o[n]=o[n]*o[n]+o[n+1]*o[n+1],o[n+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let n=0;n<e.length;n++)t[n]=this._inverseBuffer[2*n];return t}}function Dt(r){const e=[];let t=!1,o=-1/0,n=-1;for(let s=1;s<r.length-1;s++)r[s-1]<=0&&r[s]>0?(t=!0,n=s,o=r[s]):r[s-1]>0&&r[s]<=0?(t=!1,n!==-1&&e.push(n)):t&&r[s]>o&&(o=r[s],n=s);return e}function Ct(r,e){const[t,o,n]=[r-1,r,r+1],[s,i,d]=[e[t],e[o],e[n]],u=s/2-i+d/2,c=-(s/2)*(o+n)+i*(t+n)-d/2*(t+o),f=s*o*n/2-i*t*n+d*t*o/2,g=-c/(2*u),h=u*g*g+c*g+f;return[g,h]}class Me{constructor(e,t){X(this,"_autocorrelator");X(this,"_nsdfBuffer");X(this,"_clarityThreshold",.9);X(this,"_minVolumeAbsolute",0);X(this,"_maxInputAmplitude",1);this._autocorrelator=new Pe(e,t),this._nsdfBuffer=t(e)}static forFloat32Array(e){return new Me(e,t=>new Float32Array(t))}static forFloat64Array(e){return new Me(e,t=>new Float64Array(t))}static forNumberArray(e){return new Me(e,t=>Array(t))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(e){if(!Number.isFinite(e)||e<=0||e>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=e}set minVolumeAbsolute(e){if(!Number.isFinite(e)||e<0||e>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=e}set minVolumeDecibels(e){if(!Number.isFinite(e)||e>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(e/10)}set maxInputAmplitude(e){if(!Number.isFinite(e)||e<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=e}findPitch(e,t){if(this._belowMinimumVolume(e))return[0,0];this._nsdf(e);const o=Dt(this._nsdfBuffer);if(o.length===0)return[0,0];const n=Math.max(...o.map(u=>this._nsdfBuffer[u])),s=o.find(u=>this._nsdfBuffer[u]>=this._clarityThreshold*n),[i,d]=Ct(s,this._nsdfBuffer);return[t/i,Math.min(d,1)]}_belowMinimumVolume(e){if(this._minVolumeAbsolute===0)return!1;let t=0;for(let o=0;o<e.length;o++)t+=e[o]**2;return Math.sqrt(t/e.length)<this._minVolumeAbsolute}_nsdf(e){this._autocorrelator.autocorrelate(e,this._nsdfBuffer);let t=2*this._nsdfBuffer[0],o;for(o=0;o<this._nsdfBuffer.length&&t>0;o++)this._nsdfBuffer[o]=2*this._nsdfBuffer[o]/t,t-=e[o]**2+e[e.length-o-1]**2;for(;o<this._nsdfBuffer.length;o++)this._nsdfBuffer[o]=0}}function At(r){return r--,r|=r>>1,r|=r>>2,r|=r>>4,r|=r>>8,r|=r>>16,r++,r}const Ie="src/lib/components/VolumeBar.svelte";function Re(r){let e,t,o,n,s,i;const d={c:function(){e=z("div"),t=z("div"),o=z("div"),n=ne(),s=z("div"),this.h()},l:function(c){e=E(c,"DIV",{class:!0});var f=R(e);t=E(f,"DIV",{class:!0,style:!0});var g=R(t);o=E(g,"DIV",{class:!0,style:!0}),R(o).forEach(S),g.forEach(S),n=te(f),s=E(f,"DIV",{class:!0,style:!0}),R(s).forEach(S),f.forEach(S),this.h()},h:function(){P(o,"class","volume-bar-fill"),H(o,"position","absolute"),H(o,"top","0"),H(o,"left","0"),H(o,"height","100%"),T(o,Ie,51,4,1464),P(t,"class","volume-bar-bg"),H(t,"height",r[1]),H(t,"border-radius","9999px"),H(t,"background-color","#e2e8f0"),H(t,"position","relative"),H(t,"overflow","hidden"),T(t,Ie,50,2,1318),P(s,"class","threshold-indicator svelte-13z7ppf"),H(s,"position","absolute"),H(s,"top","0"),H(s,"left",r[0]+"%"),H(s,"width","2px"),H(s,"height",r[1]),H(s,"background-color","#64748b"),H(s,"border-radius","1px"),T(s,Ie,59,2,1643),P(e,"class",i="volume-bar-container "+r[2]+" svelte-13z7ppf"),T(e,Ie,49,0,1269)},m:function(c,f){we(c,e,f),C(e,t),C(t,o),r[5](o),C(e,n),C(e,s)},p:function(c,[f]){f&2&&H(t,"height",c[1]),f&1&&H(s,"left",c[0]+"%"),f&2&&H(s,"height",c[1]),f&4&&i!==(i="volume-bar-container "+c[2]+" svelte-13z7ppf")&&P(e,"class",i)},i:tt,o:tt,d:function(c){c&&S(e),r[5](null)}};return le("SvelteRegisterBlock",{block:d,id:Re.name,type:"component",source:"",ctx:r}),d}function St(r,e,t){let{$$slots:o={},$$scope:n}=e;Qe("VolumeBar",o,[]);let{volume:s=0}=e,{threshold:i=30}=e,{height:d="12px"}=e,{className:u=""}=e,c;function f(l){return l<i?`rgba(37, 99, 235, ${Math.max(.2,l/i*.8)})`:"#2563eb"}function g(l){if(c){const v=Math.max(0,Math.min(100,l)),y=f(v);t(3,c.style.width=`${v}%`,c),t(3,c.style.backgroundColor=y,c)}}ke(()=>{c&&(t(3,c.style.width="0%",c),t(3,c.style.backgroundColor="#2563eb",c),t(3,c.style.height=d,c),t(3,c.style.borderRadius="9999px",c),t(3,c.style.transition="width 0.2s ease-out, background-color 0.2s ease-out",c))});const h=["volume","threshold","height","className"];Object.keys(e).forEach(l=>{!~h.indexOf(l)&&l.slice(0,2)!=="$$"&&l!=="slot"&&console.warn(`<VolumeBar> was created with unknown prop '${l}'`)});function w(l){wt[l?"unshift":"push"](()=>{c=l,t(3,c)})}return r.$$set=l=>{"volume"in l&&t(4,s=l.volume),"threshold"in l&&t(0,i=l.threshold),"height"in l&&t(1,d=l.height),"className"in l&&t(2,u=l.className)},r.$capture_state=()=>({onMount:ke,volume:s,threshold:i,height:d,className:u,barElement:c,getVolumeColor:f,updateVolumeBar:g}),r.$inject_state=l=>{"volume"in l&&t(4,s=l.volume),"threshold"in l&&t(0,i=l.threshold),"height"in l&&t(1,d=l.height),"className"in l&&t(2,u=l.className),"barElement"in l&&t(3,c=l.barElement)},e&&"$$inject"in e&&r.$inject_state(e.$$inject),r.$$.update=()=>{r.$$.dirty&16&&g(s)},[i,d,u,c,s,w]}class Ve extends Ge{constructor(e){super(e),We(this,e,St,Re,Ue,{volume:4,threshold:0,height:1,className:2}),le("SvelteRegisterComponent",{component:this,tagName:"VolumeBar",options:e,id:Re.name})}get volume(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set volume(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get threshold(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set threshold(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get height(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set height(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}class Pt{constructor(){this.audioContext=null,this.mediaStream=null,this.sourceNode=null,this.analysers=new Map,this.filters=new Map,this.refCount=0,this.initPromise=null,this.isInitialized=!1,this.lastError=null}async initialize(){var e,t,o;if(this.initPromise)return this.initPromise;if(this.isInitialized&&this.audioContext&&this.mediaStream){const n=this.checkMediaStreamHealth();if(n.healthy)return this.refCount++,{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode};console.warn("‚ö†Ô∏è [AudioManager] MediaStream‰∏çÂÅ•Â∫∑Ê§úÂá∫ - Âº∑Âà∂ÂÜçÂàùÊúüÂåñ:",n.reason),console.log("üîÑ [AudioManager] ‰∏çÂÅ•Â∫∑„Å™MediaStreamË©≥Á¥∞:",{mediaStreamActive:(e=this.mediaStream)==null?void 0:e.active,trackCount:(t=this.mediaStream)==null?void 0:t.getTracks().length,trackStates:(o=this.mediaStream)==null?void 0:o.getTracks().map(s=>({kind:s.kind,readyState:s.readyState,enabled:s.enabled,muted:s.muted}))}),this._cleanup(),this.isInitialized=!1,this.refCount=0,await new Promise(s=>setTimeout(s,100)),console.log("üîÑ [AudioManager] „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü - ÂÜçÂàùÊúüÂåñÈñãÂßã")}this.initPromise=this._doInitialize();try{const n=await this.initPromise;return this.initPromise=null,n}catch(n){throw this.initPromise=null,n}}async _doInitialize(){try{if(console.log("üé§ [AudioManager] ÂàùÊúüÂåñÈñãÂßã"),this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),console.log("‚úÖ [AudioManager] AudioContext‰ΩúÊàêÂÆå‰∫Ü")),this.audioContext.state==="suspended"&&(await this.audioContext.resume(),console.log("‚úÖ [AudioManager] AudioContextÂÜçÈñãÂÆå‰∫Ü")),!this.mediaStream){const e={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,sampleRate:44100,channelCount:1,sampleSize:16,latency:.1,volume:1,deviceId:{ideal:"default"}}};console.log("üé§ [AudioManager] SafariÂØæÂøúË®≠ÂÆö„ÅßMediaStreamÂèñÂæó‰∏≠:",e),this.mediaStream=await navigator.mediaDevices.getUserMedia(e),console.log("‚úÖ [AudioManager] MediaStreamÂèñÂæóÂÆå‰∫Ü")}if(!this.sourceNode){this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),console.log("‚úÖ [AudioManager] SourceNode‰ΩúÊàêÂÆå‰∫Ü");const e=this.mediaStream.getTracks();console.log("üé§ [AudioManager] MediaStream tracks:",e.map(t=>({kind:t.kind,label:t.label,enabled:t.enabled,readyState:t.readyState,muted:t.muted})))}return this.isInitialized=!0,this.refCount++,this.lastError=null,console.log(`üé§ [AudioManager] ÂàùÊúüÂåñÂÆå‰∫Ü (ÂèÇÁÖß„Ç´„Ç¶„É≥„Éà: ${this.refCount})`),{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode}}catch(e){throw console.error("‚ùå [AudioManager] ÂàùÊúüÂåñ„Ç®„É©„Éº:",e),this.lastError=e,this.isInitialized=!1,this._cleanup(),e}}createAnalyser(e,t={}){if(!this.isInitialized||!this.audioContext||!this.sourceNode)throw new Error("AudioManager not initialized. Call initialize() first.");this.removeAnalyser(e);const{fftSize:o=2048,smoothingTimeConstant:n=.8,minDecibels:s=-90,maxDecibels:i=-10,useFilters:d=!0}=t,u=this.audioContext.createAnalyser();if(u.fftSize=Math.min(o,2048),u.smoothingTimeConstant=Math.max(n,.7),u.minDecibels=Math.max(s,-80),u.maxDecibels=Math.min(i,-10),this.sourceNode,d){const c=this._createFilterChain();this.filters.set(e,c),this.sourceNode.connect(c.highpass),c.highpass.connect(c.lowpass),c.lowpass.connect(c.notch),c.notch.connect(u),console.log(`üîß [AudioManager] „Éï„Ç£„É´„Çø„Éº‰ªò„ÅçAnalyser‰ΩúÊàê: ${e}`)}else this.sourceNode.connect(u),console.log(`üîß [AudioManager] Áîü‰ø°Âè∑Analyser‰ΩúÊàê: ${e}`);return this.analysers.set(e,u),u}_createFilterChain(){const e=this.audioContext.createBiquadFilter();e.type="highpass",e.frequency.setValueAtTime(80,this.audioContext.currentTime),e.Q.setValueAtTime(.7,this.audioContext.currentTime);const t=this.audioContext.createBiquadFilter();t.type="lowpass",t.frequency.setValueAtTime(800,this.audioContext.currentTime),t.Q.setValueAtTime(.7,this.audioContext.currentTime);const o=this.audioContext.createBiquadFilter();return o.type="notch",o.frequency.setValueAtTime(60,this.audioContext.currentTime),o.Q.setValueAtTime(10,this.audioContext.currentTime),{highpass:e,lowpass:t,notch:o}}removeAnalyser(e){if(this.analysers.has(e)&&(this.analysers.get(e).disconnect(),this.analysers.delete(e),console.log(`üóëÔ∏è [AudioManager] AnalyserÂâäÈô§: ${e}`)),this.filters.has(e)){const t=this.filters.get(e);t.highpass.disconnect(),t.lowpass.disconnect(),t.notch.disconnect(),this.filters.delete(e),console.log(`üóëÔ∏è [AudioManager] „Éï„Ç£„É´„Çø„Éº„ÉÅ„Çß„Éº„É≥ÂâäÈô§: ${e}`)}}release(e=[]){e.forEach(t=>this.removeAnalyser(t)),this.refCount=Math.max(0,this.refCount-1),console.log(`üìâ [AudioManager] ÂèÇÁÖß„Ç´„Ç¶„É≥„ÉàÊ∏õÁÆó: ${this.refCount}`),this.refCount<=0&&(console.log("üßπ [AudioManager] ÂÖ®„É™„ÇΩ„Éº„Çπ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÈñãÂßã"),this._cleanup())}forceCleanup(){console.log("üö® [AudioManager] Âº∑Âà∂„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂÆüË°å"),this._cleanup()}_cleanup(){console.log("üßπ [AudioManager] „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÈñãÂßã");for(const e of this.analysers.keys())this.removeAnalyser(e);if(this.mediaStream){const e=this.mediaStream.getTracks();console.log(`üõë [AudioManager] MediaStreamÂÅúÊ≠¢‰∏≠: ${e.length} tracks`),e.forEach((t,o)=>{try{t.readyState!=="ended"?(t.stop(),console.log(`üõë [AudioManager] Track ${o} ÂÅúÊ≠¢ÂÆå‰∫Ü`)):console.log(`‚ö†Ô∏è [AudioManager] Track ${o} Êó¢„Å´ÁµÇ‰∫ÜÊ∏à„Åø`)}catch(n){console.warn(`‚ö†Ô∏è [AudioManager] Track ${o} ÂÅúÊ≠¢„Ç®„É©„Éº:`,n)}}),this.mediaStream=null}if(this.audioContext&&this.audioContext.state!=="closed"){try{this.audioContext.close(),console.log("üõë [AudioManager] AudioContextÈñâÈéñÂÆå‰∫Ü")}catch(e){console.warn("‚ö†Ô∏è [AudioManager] AudioContextÈñâÈéñ„Ç®„É©„Éº:",e)}this.audioContext=null}this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.isInitialized=!1,this.refCount=0,this.initPromise=null,console.log("‚úÖ [AudioManager] „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü")}getStatus(){var e,t;return{isInitialized:this.isInitialized,refCount:this.refCount,audioContextState:((e=this.audioContext)==null?void 0:e.state)||"none",mediaStreamActive:((t=this.mediaStream)==null?void 0:t.active)||!1,activeAnalysers:Array.from(this.analysers.keys()),activeFilters:Array.from(this.filters.keys()),lastError:this.lastError}}checkMediaStreamHealth(){if(!this.mediaStream)return{healthy:!1,reason:"MediaStream not initialized"};if(!this.mediaStream.active)return{healthy:!1,reason:"MediaStream inactive"};const e=this.mediaStream.getTracks();if(e.length===0)return{healthy:!1,reason:"No tracks available"};const t=e.find(o=>o.kind==="audio");return t?t.readyState==="ended"?{healthy:!1,reason:"Audio track ended"}:t.enabled?t.muted?{healthy:!1,reason:"Audio track muted"}:this.mediaStream.active&&t.readyState!=="live"?{healthy:!1,reason:"Track state inconsistent with MediaStream"}:{healthy:!0,track:t}:{healthy:!1,reason:"Audio track disabled"}:{healthy:!1,reason:"No audio track found"}}}const _e=new Pt;typeof window<"u"&&(window.audioManager=_e);class Ft{constructor(e={}){this.vocalRangeMin=e.vocalRangeMin||130.81,this.vocalRangeMax=e.vocalRangeMax||1046.5,this.stabilityThreshold=e.stabilityThreshold||.3,this.evaluationWeights={vocalRange:e.vocalRangeWeight||.4,continuity:e.continuityWeight||.4,musical:e.musicalWeight||.2},this.fundamentalCandidates=e.fundamentalCandidates||[1,.5,.333,2],this.harmonicHistory=[],this.previousFrequency=0,this.maxHistoryLength=5,this.debugMode=!1,this.volumeThreshold=e.volumeThreshold||.02,this.currentContext={}}correctHarmonic(e,t=1,o=!1){if(!e||e<=0)return 0;const n=t>=this.volumeThreshold,i=this.fundamentalCandidates.map(c=>({frequency:e*c,ratio:c})).map(c=>{const f=this.evaluateFundamental(c.frequency);return{...c,...f}}),d=i.reduce((c,f)=>f.totalScore>c.totalScore?f:c),u=this.stabilizeFrequency(d.frequency,n);return(o||this.debugMode)&&this.logHarmonicCorrection(e,i,d,u,this.currentContext,t,n),n&&(this.previousFrequency=u),u}logHarmonicCorrection(e,t,o,n,s={},i=1,d=!0){console.group(`üîß [HarmonicCorrection] ${e.toFixed(1)}Hz ‚Üí ${n.toFixed(1)}Hz`),console.log(`üîä Èü≥Èáè: ${(i*100).toFixed(1)}% (ÈñæÂÄ§: ${(this.volumeThreshold*100).toFixed(1)}%) ${d?"‚úÖ ÊúâÂäπ":"‚ùå „Éé„Ç§„Ç∫Èô§Â§ñ"}`);const u=this.frequencyToNote(e),c=this.frequencyToNote(n);console.log(`üìù Èü≥Á®ãÂ§âÊèõ: ${u} ‚Üí ${c}`);const f=this.getCorrectionType(o.ratio);if(console.log(`üéØ Ë£úÊ≠£„Çø„Ç§„Éó: ${f}`),s.baseFrequency&&s.currentScale&&s.targetFrequency){console.log("üéµ Èü≥Èöé„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà:"),console.log(`   Âü∫Èü≥: ${s.baseFrequency.toFixed(1)}Hz (${this.frequencyToNote(s.baseFrequency)})`),console.log(`   ÁèæÂú®„ÅÆÈü≥Èöé: ${s.currentScale}`),console.log(`   ÁõÆÊ®ôÂë®Ê≥¢Êï∞: ${s.targetFrequency.toFixed(1)}Hz (${this.frequencyToNote(s.targetFrequency)})`);const h=n-s.targetFrequency,w=1200*Math.log2(n/s.targetFrequency);console.log(`   ÁõÆÊ®ô„Å®„ÅÆÂ∑Æ: ${h>0?"+":""}${h.toFixed(1)}Hz (${w>0?"+":""}${w.toFixed(0)}„Çª„É≥„Éà)`);const l=Math.abs(w)<=50?"üéØ È´òÁ≤æÂ∫¶":Math.abs(w)<=100?"‚úÖ ËâØÂ•Ω":Math.abs(w)<=200?"‚ö†Ô∏è Ë¶ÅÊîπÂñÑ":"‚ùå ‰∏çÊ≠£Á¢∫";console.log(`   Á≤æÂ∫¶Ë©ï‰æ°: ${l} (${Math.abs(w).toFixed(0)}„Çª„É≥„ÉàÂ∑Æ)`)}console.table(t.map(h=>({ÂÄçÁéá:`${h.ratio.toFixed(3)}x`,Âë®Ê≥¢Êï∞:`${h.frequency.toFixed(1)}Hz`,Èü≥Âêç:this.frequencyToNote(h.frequency),Èü≥Âüü:h.vocalRangeScore.toFixed(2),ÈÄ£Á∂öÊÄß:h.continuityScore.toFixed(2),Èü≥Ê•ΩÊÄß:h.musicalScore.toFixed(2),Á∑èÂêà:h.totalScore.toFixed(3),ÈÅ∏Êäû:h===o?"‚úÖ":""})));const g=Math.abs(n-o.frequency);g>.5&&console.log(`üîÑ ÂÆâÂÆöÂåñ: ${o.frequency.toFixed(1)}Hz ‚Üí ${n.toFixed(1)}Hz (${g.toFixed(1)}HzË™øÊï¥)`),console.groupEnd()}getCorrectionType(e){return Math.abs(e-1)<.01?"Ë£úÊ≠£„Å™„ÅóÔºàÂü∫Èü≥Ôºâ":Math.abs(e-.5)<.01?"2ÂÄçÈü≥Ë£úÊ≠£Ôºà1„Ç™„ÇØ„Çø„Éº„Éñ‰∏ãÔºâ":Math.abs(e-.333)<.01?"3ÂÄçÈü≥Ë£úÊ≠£Ôºà1„Ç™„ÇØ„Çø„Éº„Éñ+5Â∫¶‰∏ãÔºâ":Math.abs(e-.25)<.01?"4ÂÄçÈü≥Ë£úÊ≠£Ôºà2„Ç™„ÇØ„Çø„Éº„Éñ‰∏ãÔºâ":Math.abs(e-2)<.01?"„Ç™„ÇØ„Çø„Éº„Éñ‰∏äË£úÊ≠£":`„Ç´„Çπ„Çø„É†Ë£úÊ≠£Ôºà${e.toFixed(3)}xÔºâ`}frequencyToNote(e){if(!e||e<=0)return"---";const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=Math.round(12*Math.log2(e/440)),s=(n+9+120)%12,i=Math.floor((n+9)/12)+4;return t[s]+i}evaluateFundamental(e){const o=e>=this.vocalRangeMin&&e<=this.vocalRangeMax?1:0,n=this.previousFrequency>0?1-Math.min(Math.abs(e-this.previousFrequency)/this.previousFrequency,1):.5,s=this.calculateMusicalScore(e),i=o*this.evaluationWeights.vocalRange+n*this.evaluationWeights.continuity+s*this.evaluationWeights.musical;return{vocalRangeScore:o,continuityScore:n,musicalScore:s,totalScore:i}}calculateMusicalScore(e){const o=Math.log2(e/261.63)*12,n=Math.round(o),s=Math.abs(o-n);return Math.max(0,1-s/.5)}stabilizeFrequency(e,t=!0){if(!e||e<=0)return 0;if(t&&this.harmonicHistory.push(e),this.harmonicHistory.length>this.maxHistoryLength&&this.harmonicHistory.shift(),this.harmonicHistory.length<2)return e;const o=[...this.harmonicHistory].sort((d,u)=>d-u),n=o[Math.floor(o.length/2)],s=n*this.stabilityThreshold;return Math.abs(e-n)>s?n+Math.sign(e-n)*s:e}resetHistory(){this.harmonicHistory=[],this.previousFrequency=0}updateConfig(e){Object.assign(this,e),console.log("‚öôÔ∏è [HarmonicCorrection] Ë®≠ÂÆöÊõ¥Êñ∞:",e)}enableDebugLogging(){this.debugMode=!0,console.log("üîç [HarmonicCorrection] „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ÊúâÂäπÂåñ - Ê¨°Âõû„ÅÆË£úÊ≠£„Åã„ÇâË©≥Á¥∞„É≠„Ç∞„ÇíÂá∫Âäõ„Åó„Åæ„Åô"),console.log("ÁÑ°ÂäπÂåñ„Åô„Çã„Å´„ÅØ: harmonicCorrection.disableDebugLogging()")}disableDebugLogging(){this.debugMode=!1,console.log("üîç [HarmonicCorrection] „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ÁÑ°ÂäπÂåñ")}setScaleContext(e){this.currentContext={baseFrequency:e.baseFrequency,currentScale:e.currentScale,targetFrequency:e.targetFrequency}}clearContext(){this.currentContext={}}getStatus(){return{vocalRangeMin:this.vocalRangeMin,vocalRangeMax:this.vocalRangeMax,stabilityThreshold:this.stabilityThreshold,evaluationWeights:this.evaluationWeights,historyLength:this.harmonicHistory.length,previousFrequency:this.previousFrequency,recentHistory:this.harmonicHistory.slice(-3)}}}const pe=new Ft;typeof window<"u"&&(window.harmonicCorrection=pe);const it=(()=>{if(typeof window<"u"){const e=new URLSearchParams(window.location.search).get("debug");if(e)return e}return"info"})(),ce={error:0,warn:1,info:2,debug:3},ve=ce[it]??ce.info,qe={error:(r,...e)=>{ve>=ce.error&&console.error(`‚ùå ${r}`,...e)},warn:(r,...e)=>{ve>=ce.warn&&console.warn(`‚ö†Ô∏è ${r}`,...e)},info:(r,...e)=>{ve>=ce.info&&console.log(`‚ÑπÔ∏è ${r}`,...e)},debug:(r,...e)=>{ve>=ce.debug&&console.log(`üîç ${r}`,...e)},realtime:(()=>{let r=0;const e=1e3;return(t,...o)=>{if(ve>=ce.debug){const n=Date.now();n-r>=e&&(console.log(`üìä ${t}`,...o),r=n)}}})(),scoring:(r,...e)=>{ve>=ce.info&&console.log(`üéØ ${r}`,...e)},audio:(r,...e)=>{ve>=ce.info&&console.log(`üé§ ${r}`,...e)}};typeof import.meta<"u"&&qe.info(`Debug Level: ${it} (Change with ?debug=level)`);const{Error:k,console:xt}=bt,ye="src/lib/components/PitchDetector.svelte";function Le(r){let e,t,o,n,s=(r[2]>0?Math.round(r[2]):"---")+"",i,d,u,c="Hz",f,g,h="|",w,l,v,y,m,b,p;m=new Ve({props:{volume:r[2]>0?r[1]:0,className:"volume-bar"},$$inline:!0});const I={c:function(){e=z("div"),t=z("div"),o=z("div"),n=z("span"),i=Ee(s),d=ne(),u=z("span"),u.textContent=c,f=ne(),g=z("span"),g.textContent=h,w=ne(),l=z("span"),v=Ee(r[3]),y=ne(),Oe(m.$$.fragment),this.h()},l:function(_){e=E(_,"DIV",{class:!0});var A=R(e);t=E(A,"DIV",{class:!0});var F=R(t);o=E(F,"DIV",{class:!0});var x=R(o);n=E(x,"SPAN",{class:!0});var N=R(n);i=xe(N,s),N.forEach(S),d=te(x),u=E(x,"SPAN",{class:!0,"data-svelte-h":!0}),Te(u)!=="svelte-5uyilv"&&(u.textContent=c),f=te(x),g=E(x,"SPAN",{class:!0,"data-svelte-h":!0}),Te(g)!=="svelte-1dytxz4"&&(g.textContent=h),w=te(x),l=E(x,"SPAN",{class:!0});var B=R(l);v=xe(B,r[3]),B.forEach(S),x.forEach(S),y=te(F),Ze(m.$$.fragment,F),F.forEach(S),A.forEach(S),this.h()},h:function(){P(n,"class","detected-frequency svelte-vc1bho"),T(n,ye,528,6,15447),P(u,"class","hz-suffix svelte-vc1bho"),T(u,ye,529,6,15555),P(g,"class","divider svelte-vc1bho"),T(g,ye,530,6,15595),P(l,"class","detected-note svelte-vc1bho"),T(l,ye,531,6,15632),P(o,"class","detection-card svelte-vc1bho"),T(o,ye,527,4,15412),P(t,"class","detection-display svelte-vc1bho"),T(t,ye,526,2,15376),P(e,"class",b="pitch-detector "+r[0]+" svelte-vc1bho"),T(e,ye,525,0,15333)},m:function(_,A){we(_,e,A),C(e,t),C(t,o),C(o,n),C(n,i),C(o,d),C(o,u),C(o,f),C(o,g),C(o,w),C(o,l),C(l,v),C(t,y),Ye(m,t,null),p=!0},p:function(_,A){(!p||A[0]&4)&&s!==(s=(_[2]>0?Math.round(_[2]):"---")+"")&&Fe(i,s),(!p||A[0]&8)&&Fe(v,_[3]);const F={};A[0]&6&&(F.volume=_[2]>0?_[1]:0),m.$set(F),(!p||A[0]&1&&b!==(b="pitch-detector "+_[0]+" svelte-vc1bho"))&&P(e,"class",b)},i:function(_){p||(Xe(m.$$.fragment,_),p=!0)},o:function(_){Je(m.$$.fragment,_),p=!1},d:function(_){_&&S(e),Ke(m)}};return le("SvelteRegisterBlock",{block:I,id:Le.name,type:"component",source:"",ctx:r}),I}function ot(r){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(r<=0)return"„Éº„Éº";const o=Math.round(12*Math.log2(r/440)),n=(o+9+120)%12,s=Math.floor((o+9)/12)+4;return e[n]+s}function Tt(r,e,t){let{$$slots:o={},$$scope:n}=e;Qe("PitchDetector",o,[]);const s=nt();let{isActive:i=!1}=e,{className:d=""}=e,{debugMode:u=!1}=e,{trainingPhase:c=""}=e,{disableHarmonicCorrection:f=!1}=e,g="uninitialized",h=null,w=!1,l=null,v=null,y=null,m=null,b=null,p=null,I=null,M=!1,_=[],A=new Map,F=0,x=0,N=0,B="„Éº„Éº",W=0,J=[],q=[],Z=0,K=0,L=null;function ue(){F=0,t(1,x=0),t(2,N=0),t(3,B="„Éº„Éº"),W=0,Z=0,K=0,J=[],q=[],pe.resetHistory(),u&&console.log("üîÑ [PitchDetector] Display state reset")}function se(){if(!u)return;const a=new Date().toLocaleTimeString(),D={timestamp:a,componentState:g,isActive:i,isDetecting:M,isInitialized:w,mediaStreamActive:v?v.active:null,mediaStreamTracks:v?v.getTracks().length:0,trackStates:v?v.getTracks().map(j=>({kind:j.kind,enabled:j.enabled,readyState:j.readyState,muted:j.muted})):[],audioContextState:l?l.state:null,hasAnalyser:!!m,currentVolume:F,currentFrequency:N};qe.realtime(`[PitchDetector] ${a}:`,D);let V=!0,G=[];v&&!v.active&&(console.warn("‚ö†Ô∏è [PitchDetector] MediaStream is inactive!",v),V=!1,G.push("MediaStream inactive")),l&&l.state==="suspended"&&(console.warn("‚ö†Ô∏è [PitchDetector] AudioContext is suspended!",l),V=!1,G.push("AudioContext suspended")),v&&v.getTracks().forEach((j,fe)=>{j.readyState==="ended"&&(console.error(`‚ùå [PitchDetector] Track ${fe} has ended!`,j),V=!1,G.push(`Track ${fe} ended`))}),s("microphoneHealthChange",{healthy:V,errors:G,details:D})}async function oe(){try{t(16,g="initializing"),h=null,console.log("üéôÔ∏è [PitchDetector] AudioManagerÁµåÁî±„ÅßÂàùÊúüÂåñÈñãÂßã");const a=await _e.initialize();l=a.audioContext,v=a.mediaStream,y=a.sourceNode,console.log("‚úÖ [PitchDetector] AudioManager „É™„ÇΩ„Éº„ÇπÂèñÂæóÂÆå‰∫Ü");const D=`pitch-detector-filtered-${Date.now()}`;t(17,m=_e.createAnalyser(D,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!0})),_.push(D);const V=`pitch-detector-raw-${Date.now()}`;b=_e.createAnalyser(V,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!1}),_.push(V),console.log("‚úÖ [PitchDetector] Analyser‰ΩúÊàêÂÆå‰∫Ü:",_),p=Me.forFloat32Array(m.fftSize),t(16,g="ready"),w=!0,s("stateChange",{state:g}),me(),console.log("‚úÖ [PitchDetector] ÂàùÊúüÂåñÂÆå‰∫Ü")}catch(a){throw console.error("‚ùå [PitchDetector] ÂàùÊúüÂåñ„Ç®„É©„Éº:",a),t(16,g="error"),h=a,w=!1,s("error",{error:a,context:"initialization"}),a}}function re(){if(g!=="ready"){const a=new Error(`Cannot start detection: component state is ${g}`);return s("error",{error:a,context:"start-detection"}),!1}if(!m||!p||!l){const a=new Error("Required components not available");return t(16,g="error"),s("error",{error:a,context:"start-detection"}),!1}return t(16,g="detecting"),t(18,M=!0),s("stateChange",{state:g}),ie(),!0}function O(){t(18,M=!1),I&&(cancelAnimationFrame(I),I=null),g==="detecting"&&w&&(t(16,g="ready"),s("stateChange",{state:g}))}function ie(){if(!M||!m||!b||!p)return;const a=m.fftSize,D=new Float32Array(a),V=new Float32Array(b.fftSize);m.getFloatTimeDomainData(D),b.getFloatTimeDomainData(V);let G=0;for(let U=0;U<a;U++)G+=Math.abs(D[U]);const j=Math.sqrt(G/a),fe=Math.log10(j+.001)*50+100,De=Math.max(0,Math.min(100,fe));let be=0;for(let U=0;U<V.length;U++)be+=Math.abs(V[U]);const Ce=Math.sqrt(be/V.length),Ae=Math.log10(Ce+.001)*50+100;t(1,x=Math.max(0,Math.min(100,Ae))),q.push(De),q.length>5&&q.shift(),K=q.reduce((U,Se)=>U+Se,0)/q.length,F=K;const[ee,ze]=p.findPitch(D,l.sampleRate),He=ee>=65&&ee<=1200;if(ee&&ze>.8&&F>30&&He){let U=ee;if(f)u&&console.log("üîß [PitchDetector] „Éè„Éº„É¢„Éã„ÉÉ„ÇØË£úÊ≠£ÁÑ°ÂäπÂåñ‰∏≠ - ÁîüÂÄ§‰ΩøÁî®:",ee);else{const Se=Math.min(F/100,1);U=pe.correctHarmonic(ee,Se)}t(2,N=Math.round(U)),t(3,B=ot(N)),W=ze}else N===0&&pe.resetHistory(),t(2,N=0),t(3,B="„Éº„Éº"),W=0;const Ne=N>0?x:0;s("pitchUpdate",{frequency:N,note:B,volume:Ne,rawVolume:Ne,clarity:W}),I=requestAnimationFrame(ie)}function he(){return w&&g==="ready"}function de(){return{componentState:g,isInitialized:w,isDetecting:M,lastError:h,hasRequiredComponents:!!(m&&p&&l&&v)}}async function ae(){console.log("üîÑ [PitchDetector] ÂÜçÂàùÊúüÂåñÈñãÂßã"),$(),await new Promise(a=>setTimeout(a,100)),await oe(),console.log("‚úÖ [PitchDetector] ÂÜçÂàùÊúüÂåñÂÆå‰∫Ü")}function $(){console.log("üßπ [PitchDetector] „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÈñãÂßã"),O(),A.size>0&&(A.forEach((a,D)=>{D.removeEventListener("ended",a.endedHandler),D.removeEventListener("mute",a.muteHandler),D.removeEventListener("unmute",a.unmuteHandler)}),A.clear(),console.log("üîÑ [PitchDetector] MediaStream„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÂâäÈô§")),_.length>0&&(_e.release(_),console.log("üì§ [PitchDetector] AudioManager„Å´AnalyserËß£ÊîæÈÄöÁü•:",_),_=[]),t(16,g="uninitialized"),w=!1,h=null,l=null,v=null,y=null,t(17,m=null),b=null,p=null,J=[],q=[],pe.resetHistory(),console.log("‚úÖ [PitchDetector] „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü")}function me(){if(!v)return;const a=v.getTracks();a.forEach(D=>{const V=()=>{console.error("üö® [PitchDetector] MediaStreamTrackÁµÇ‰∫ÜÊ§úÂá∫:",D.kind),t(16,g="error"),h=new Error(`MediaStreamTrack (${D.kind}) ended`),s("error",{error:h,reason:"mediastream_ended",recovery:"restart_required"}),M&&O()},G=()=>{console.warn("‚ö†Ô∏è [PitchDetector] MediaStreamTrack muted:",D.kind),s("warning",{reason:"track_muted",track:D.kind})},j=()=>{console.log("‚úÖ [PitchDetector] MediaStreamTrack unmuted:",D.kind),s("info",{reason:"track_unmuted",track:D.kind})};D.addEventListener("ended",V),D.addEventListener("mute",G),D.addEventListener("unmute",j),A.set(D,{endedHandler:V,muteHandler:G,unmuteHandler:j})}),console.log("üîç [PitchDetector] MediaStreamÁõ£Ë¶ñÈñãÂßã:",a.length+" tracks")}st(()=>{L&&(clearInterval(L),t(19,L=null)),console.log("üîÑ [PitchDetector] onDestroy - AudioManager„É™„ÇΩ„Éº„Çπ„ÅØ‰øùÊåÅ")});const ge=["isActive","className","debugMode","trainingPhase","disableHarmonicCorrection"];return Object.keys(e).forEach(a=>{!~ge.indexOf(a)&&a.slice(0,2)!=="$$"&&a!=="slot"&&xt.warn(`<PitchDetector> was created with unknown prop '${a}'`)}),r.$$set=a=>{"isActive"in a&&t(4,i=a.isActive),"className"in a&&t(0,d=a.className),"debugMode"in a&&t(5,u=a.debugMode),"trainingPhase"in a&&t(6,c=a.trainingPhase),"disableHarmonicCorrection"in a&&t(7,f=a.disableHarmonicCorrection)},r.$capture_state=()=>({onMount:ke,onDestroy:st,createEventDispatcher:nt,PitchDetector:Me,VolumeBar:Ve,audioManager:_e,harmonicCorrection:pe,logger:qe,dispatch:s,isActive:i,className:d,debugMode:u,trainingPhase:c,disableHarmonicCorrection:f,componentState:g,lastError:h,isInitialized:w,audioContext:l,mediaStream:v,sourceNode:y,analyser:m,rawAnalyser:b,pitchDetector:p,animationFrame:I,isDetecting:M,analyserIds:_,mediaStreamListeners:A,currentVolume:F,rawVolume:x,currentFrequency:N,detectedNote:B,pitchClarity:W,frequencyHistory:J,volumeHistory:q,stableFrequency:Z,stableVolume:K,debugInterval:L,resetDisplayState:ue,checkMicrophoneStatus:se,initialize:oe,startDetection:re,stopDetection:O,detectPitch:ie,frequencyToNote:ot,getIsInitialized:he,getState:de,reinitialize:ae,cleanup:$,setupMediaStreamMonitoring:me}),r.$inject_state=a=>{"isActive"in a&&t(4,i=a.isActive),"className"in a&&t(0,d=a.className),"debugMode"in a&&t(5,u=a.debugMode),"trainingPhase"in a&&t(6,c=a.trainingPhase),"disableHarmonicCorrection"in a&&t(7,f=a.disableHarmonicCorrection),"componentState"in a&&t(16,g=a.componentState),"lastError"in a&&(h=a.lastError),"isInitialized"in a&&(w=a.isInitialized),"audioContext"in a&&(l=a.audioContext),"mediaStream"in a&&(v=a.mediaStream),"sourceNode"in a&&(y=a.sourceNode),"analyser"in a&&t(17,m=a.analyser),"rawAnalyser"in a&&(b=a.rawAnalyser),"pitchDetector"in a&&(p=a.pitchDetector),"animationFrame"in a&&(I=a.animationFrame),"isDetecting"in a&&t(18,M=a.isDetecting),"analyserIds"in a&&(_=a.analyserIds),"mediaStreamListeners"in a&&(A=a.mediaStreamListeners),"currentVolume"in a&&(F=a.currentVolume),"rawVolume"in a&&t(1,x=a.rawVolume),"currentFrequency"in a&&t(2,N=a.currentFrequency),"detectedNote"in a&&t(3,B=a.detectedNote),"pitchClarity"in a&&(W=a.pitchClarity),"frequencyHistory"in a&&(J=a.frequencyHistory),"volumeHistory"in a&&(q=a.volumeHistory),"stableFrequency"in a&&(Z=a.stableFrequency),"stableVolume"in a&&(K=a.stableVolume),"debugInterval"in a&&t(19,L=a.debugInterval)},e&&"$$inject"in e&&r.$inject_state(e.$$inject),r.$$.update=()=>{r.$$.dirty[0]&524320&&(u&&!L?(console.log("üîç [PitchDetector] Debug mode enabled - starting status monitoring"),t(19,L=setInterval(se,3e3)),se()):!u&&L&&(console.log("üîç [PitchDetector] Debug mode disabled - stopping status monitoring"),clearInterval(L),t(19,L=null))),r.$$.dirty[0]&458768&&(i&&g==="ready"&&m&&!M?re():!i&&M&&O())},[d,x,N,B,i,u,c,f,ue,oe,re,O,he,de,ae,$,g,m,M,L]}class Bt extends Ge{constructor(e){super(e),We(this,e,Tt,Le,Ue,{isActive:4,className:0,debugMode:5,trainingPhase:6,disableHarmonicCorrection:7,resetDisplayState:8,initialize:9,startDetection:10,stopDetection:11,getIsInitialized:12,getState:13,reinitialize:14,cleanup:15},null,[-1,-1]),le("SvelteRegisterComponent",{component:this,tagName:"PitchDetector_1",options:e,id:Le.name})}get isActive(){throw new k("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set isActive(e){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new k("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(e){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get debugMode(){throw new k("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set debugMode(e){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get trainingPhase(){throw new k("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set trainingPhase(e){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get disableHarmonicCorrection(){throw new k("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set disableHarmonicCorrection(e){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get resetDisplayState(){return this.$$.ctx[8]}set resetDisplayState(e){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get initialize(){return this.$$.ctx[9]}set initialize(e){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get startDetection(){return this.$$.ctx[10]}set startDetection(e){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get stopDetection(){return this.$$.ctx[11]}set stopDetection(e){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get getIsInitialized(){return this.$$.ctx[12]}set getIsInitialized(e){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get getState(){return this.$$.ctx[13]}set getState(e){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get reinitialize(){return this.$$.ctx[14]}set reinitialize(e){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get cleanup(){return this.$$.ctx[15]}set cleanup(e){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}const Y="src/lib/components/PitchDetectionDisplay.svelte";function at(r){let e,t,o=(r[0]>0?Math.round(r[0]):"---")+"",n,s,i,d="Hz",u,c,f="|",g,h,w;const l={c:function(){e=z("div"),t=z("span"),n=Ee(o),s=ne(),i=z("span"),i.textContent=d,u=ne(),c=z("span"),c.textContent=f,g=ne(),h=z("span"),w=Ee(r[1]),this.h()},l:function(y){e=E(y,"DIV",{class:!0});var m=R(e);t=E(m,"SPAN",{class:!0});var b=R(t);n=xe(b,o),b.forEach(S),s=te(m),i=E(m,"SPAN",{class:!0,"data-svelte-h":!0}),Te(i)!=="svelte-5uyilv"&&(i.textContent=d),u=te(m),c=E(m,"SPAN",{class:!0,"data-svelte-h":!0}),Te(c)!=="svelte-1dytxz4"&&(c.textContent=f),g=te(m),h=E(m,"SPAN",{class:!0});var p=R(h);w=xe(p,r[1]),p.forEach(S),m.forEach(S),this.h()},h:function(){P(t,"class","detected-frequency svelte-1datf0r"),T(t,Y,25,14,712),P(i,"class","hz-suffix svelte-1datf0r"),T(i,Y,26,14,814),P(c,"class","divider svelte-1datf0r"),T(c,Y,27,14,862),P(h,"class","detected-note svelte-1datf0r"),T(h,Y,28,14,907),P(e,"class","detection-values svelte-1datf0r"),T(e,Y,24,12,667)},m:function(y,m){we(y,e,m),C(e,t),C(t,n),C(e,s),C(e,i),C(e,u),C(e,c),C(e,g),C(e,h),C(h,w)},p:function(y,m){m&1&&o!==(o=(y[0]>0?Math.round(y[0]):"---")+"")&&Fe(n,o),m&2&&Fe(w,y[1])},d:function(y){y&&S(e)}};return le("SvelteRegisterBlock",{block:l,id:at.name,type:"else",source:"(24:10) {:else}",ctx:r}),l}function ct(r){let e,t;const o={c:function(){e=z("span"),t=Ee(r[4]),this.h()},l:function(s){e=E(s,"SPAN",{class:!0});var i=R(e);t=xe(i,r[4]),i.forEach(S),this.h()},h:function(){P(e,"class","muted-message svelte-1datf0r"),T(e,Y,22,12,588)},m:function(s,i){we(s,e,i),C(e,t)},p:function(s,i){i&16&&Fe(t,s[4])},d:function(s){s&&S(e)}};return le("SvelteRegisterBlock",{block:o,id:ct.name,type:"if",source:"(22:10) {#if isMuted}",ctx:r}),o}function lt(r){let e,t,o="üéôÔ∏è „É™„Ç¢„É´„Çø„Ç§„É†Èü≥Á®ãÊ§úÂá∫",n,s,i,d,u,c,f,g;function h(y,m){return y[3]?ct:at}let w=h(r),l=w(r);f=new Ve({props:{volume:!r[3]&&r[0]>0?r[2]:0,className:"volume-bar"},$$inline:!0});const v={c:function(){e=z("div"),t=z("h3"),t.textContent=o,n=ne(),s=z("div"),i=z("div"),d=z("div"),u=z("div"),l.c(),c=ne(),Oe(f.$$.fragment),this.h()},l:function(m){e=E(m,"DIV",{class:!0});var b=R(e);t=E(b,"H3",{class:!0,"data-svelte-h":!0}),Te(t)!=="svelte-1bj87i9"&&(t.textContent=o),b.forEach(S),n=te(m),s=E(m,"DIV",{class:!0});var p=R(s);i=E(p,"DIV",{class:!0});var I=R(i);d=E(I,"DIV",{class:!0});var M=R(d);u=E(M,"DIV",{class:!0});var _=R(u);l.l(_),_.forEach(S),c=te(M),Ze(f.$$.fragment,M),M.forEach(S),I.forEach(S),p.forEach(S),this.h()},h:function(){P(t,"class","section-title svelte-1datf0r"),T(t,Y,15,4,360),P(e,"class","card-header svelte-1datf0r"),T(e,Y,14,2,330),P(u,"class","detection-card svelte-1datf0r"),T(u,Y,20,8,523),P(d,"class","detection-display svelte-1datf0r"),T(d,Y,19,6,483),P(i,"class","pitch-detector svelte-1datf0r"),T(i,Y,18,4,448),P(s,"class","card-content svelte-1datf0r"),T(s,Y,17,2,417)},m:function(m,b){we(m,e,b),C(e,t),we(m,n,b),we(m,s,b),C(s,i),C(i,d),C(d,u),l.m(u,null),C(d,c),Ye(f,d,null),g=!0},p:function(m,b){w===(w=h(m))&&l?l.p(m,b):(l.d(1),l=w(m),l&&(l.c(),l.m(u,null)));const p={};b&13&&(p.volume=!m[3]&&m[0]>0?m[2]:0),f.$set(p)},i:function(m){g||(Xe(f.$$.fragment,m),g=!0)},o:function(m){Je(f.$$.fragment,m),g=!1},d:function(m){m&&(S(e),S(n),S(s)),l.d(),Ke(f)}};return le("SvelteRegisterBlock",{block:v,id:lt.name,type:"slot",source:'(14:0) <Card class=\\"main-card {className}\\">',ctx:r}),v}function je(r){let e,t;e=new rt({props:{class:"main-card "+r[5],$$slots:{default:[lt]},$$scope:{ctx:r}},$$inline:!0});const o={c:function(){Oe(e.$$.fragment)},l:function(s){Ze(e.$$.fragment,s)},m:function(s,i){Ye(e,s,i),t=!0},p:function(s,[i]){const d={};i&32&&(d.class="main-card "+s[5]),i&95&&(d.$$scope={dirty:i,ctx:s}),e.$set(d)},i:function(s){t||(Xe(e.$$.fragment,s),t=!0)},o:function(s){Je(e.$$.fragment,s),t=!1},d:function(s){Ke(e,s)}};return le("SvelteRegisterBlock",{block:o,id:je.name,type:"component",source:"",ctx:r}),o}function Et(r,e,t){let{$$slots:o={},$$scope:n}=e;Qe("PitchDetectionDisplay",o,[]);let{frequency:s=0}=e,{note:i="„Éº„Éº"}=e,{volume:d=0}=e,{isMuted:u=!1}=e,{muteMessage:c="ÂæÖÊ©ü‰∏≠..."}=e,{className:f=""}=e;const g=["frequency","note","volume","isMuted","muteMessage","className"];return Object.keys(e).forEach(h=>{!~g.indexOf(h)&&h.slice(0,2)!=="$$"&&h!=="slot"&&console.warn(`<PitchDetectionDisplay> was created with unknown prop '${h}'`)}),r.$$set=h=>{"frequency"in h&&t(0,s=h.frequency),"note"in h&&t(1,i=h.note),"volume"in h&&t(2,d=h.volume),"isMuted"in h&&t(3,u=h.isMuted),"muteMessage"in h&&t(4,c=h.muteMessage),"className"in h&&t(5,f=h.className)},r.$capture_state=()=>({Card:rt,VolumeBar:Ve,frequency:s,note:i,volume:d,isMuted:u,muteMessage:c,className:f}),r.$inject_state=h=>{"frequency"in h&&t(0,s=h.frequency),"note"in h&&t(1,i=h.note),"volume"in h&&t(2,d=h.volume),"isMuted"in h&&t(3,u=h.isMuted),"muteMessage"in h&&t(4,c=h.muteMessage),"className"in h&&t(5,f=h.className)},e&&"$$inject"in e&&r.$inject_state(e.$$inject),[s,i,d,u,c,f]}class kt extends Ge{constructor(e){super(e),We(this,e,Et,je,Ue,{frequency:0,note:1,volume:2,isMuted:3,muteMessage:4,className:5}),le("SvelteRegisterComponent",{component:this,tagName:"PitchDetectionDisplay",options:e,id:je.name})}get frequency(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set frequency(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get note(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set note(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get volume(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set volume(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get isMuted(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set isMuted(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get muteMessage(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set muteMessage(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}export{kt as P,Ve as V,_e as a,Bt as b,pe as h,qe as l};
