var _t=Object.defineProperty;var Dt=(i,e,t)=>e in i?_t(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var ee=(i,e,t)=>Dt(i,typeof e!="symbol"?e+"":e,t);import{S as Qe,i as Ke,s as Je,d as oe,n as ot,a as Xe,D as He,b as A,L as H,z as S,f as se,g as D,h as F,j as N,k as E,m as U,o as x,p as Q,U as Mt,$ as it,a0 as rt,q as Ye,r as Ze,u as Oe,e as ae,w as $e,l as X,A as Se,x as et,t as Y,y as tt,N as at}from"./D-MQVlDL.js";import{g as Pt}from"./D0QH3NT1.js";import"./DEDhZaYq.js";import{C as ut}from"./BZyPgggR.js";function At(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function Z(i){if(this.size=i|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=i<<1;for(var e=new Array(this.size*2),t=0;t<e.length;t+=2){const h=Math.PI*t/this.size;e[t]=Math.cos(h),e[t+1]=-Math.sin(h)}this.table=e;for(var s=0,n=1;this.size>n;n<<=1)s++;this._width=s%2===0?s-1:s,this._bitrev=new Array(1<<this._width);for(var o=0;o<this._bitrev.length;o++){this._bitrev[o]=0;for(var r=0;r<this._width;r+=2){var d=this._width-r-2;this._bitrev[o]|=(o>>>r&3)<<d}}this._out=null,this._data=null,this._inv=0}var St=Z;Z.prototype.fromComplexArray=function(e,t){for(var s=t||new Array(e.length>>>1),n=0;n<e.length;n+=2)s[n>>>1]=e[n];return s};Z.prototype.createComplexArray=function(){const e=new Array(this._csize);for(var t=0;t<e.length;t++)e[t]=0;return e};Z.prototype.toComplexArray=function(e,t){for(var s=t||this.createComplexArray(),n=0;n<s.length;n+=2)s[n]=e[n>>>1],s[n+1]=0;return s};Z.prototype.completeSpectrum=function(e){for(var t=this._csize,s=t>>>1,n=2;n<s;n+=2)e[t-n]=e[n],e[t-n+1]=-e[n+1]};Z.prototype.transform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._transform4(),this._out=null,this._data=null};Z.prototype.realTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._realTransform4(),this._out=null,this._data=null};Z.prototype.inverseTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=1,this._transform4();for(var s=0;s<e.length;s++)e[s]/=this.size;this._out=null,this._data=null};Z.prototype._transform4=function(){var e=this._out,t=this._csize,s=this._width,n=1<<s,o=t/n<<1,r,d,h=this._bitrev;if(o===4)for(r=0,d=0;r<t;r+=o,d++){const v=h[d];this._singleTransform2(r,v,n)}else for(r=0,d=0;r<t;r+=o,d++){const v=h[d];this._singleTransform4(r,v,n)}var c=this._inv?-1:1,f=this.table;for(n>>=2;n>=2;n>>=2){o=t/n<<1;var m=o>>>2;for(r=0;r<t;r+=o)for(var y=r+m,b=r,l=0;b<y;b+=2,l+=n){const v=b,g=v+m,a=g+m,p=a+m,w=e[v],_=e[v+1],P=e[g],M=e[g+1],k=e[a],T=e[a+1],I=e[p],z=e[p+1],B=w,K=_,$=f[l],L=c*f[l+1],te=P*$-M*L,O=P*L+M*$,G=f[2*l],me=c*f[2*l+1],ce=k*G-T*me,le=k*me+T*G,ue=f[3*l],ne=c*f[3*l+1],he=I*ue-z*ne,ge=I*ne+z*ue,ve=B+ce,de=K+le,ie=B-ce,ye=K-le,be=te+he,u=O+ge,C=c*(te-he),q=c*(O-ge),W=ve+be,j=de+u,we=ve-be,Ce=de-u,De=ie+q,Fe=ye-C,Ne=ie-q,re=ye+C;e[v]=W,e[v+1]=j,e[g]=De,e[g+1]=Fe,e[a]=we,e[a+1]=Ce,e[p]=Ne,e[p+1]=re}}};Z.prototype._singleTransform2=function(e,t,s){const n=this._out,o=this._data,r=o[t],d=o[t+1],h=o[t+s],c=o[t+s+1],f=r+h,m=d+c,y=r-h,b=d-c;n[e]=f,n[e+1]=m,n[e+2]=y,n[e+3]=b};Z.prototype._singleTransform4=function(e,t,s){const n=this._out,o=this._data,r=this._inv?-1:1,d=s*2,h=s*3,c=o[t],f=o[t+1],m=o[t+s],y=o[t+s+1],b=o[t+d],l=o[t+d+1],v=o[t+h],g=o[t+h+1],a=c+b,p=f+l,w=c-b,_=f-l,P=m+v,M=y+g,k=r*(m-v),T=r*(y-g),I=a+P,z=p+M,B=w+T,K=_-k,$=a-P,L=p-M,te=w-T,O=_+k;n[e]=I,n[e+1]=z,n[e+2]=B,n[e+3]=K,n[e+4]=$,n[e+5]=L,n[e+6]=te,n[e+7]=O};Z.prototype._realTransform4=function(){var e=this._out,t=this._csize,s=this._width,n=1<<s,o=t/n<<1,r,d,h=this._bitrev;if(o===4)for(r=0,d=0;r<t;r+=o,d++){const Ve=h[d];this._singleRealTransform2(r,Ve>>>1,n>>>1)}else for(r=0,d=0;r<t;r+=o,d++){const Ve=h[d];this._singleRealTransform4(r,Ve>>>1,n>>>1)}var c=this._inv?-1:1,f=this.table;for(n>>=2;n>=2;n>>=2){o=t/n<<1;var m=o>>>1,y=m>>>1,b=y>>>1;for(r=0;r<t;r+=o)for(var l=0,v=0;l<=b;l+=2,v+=n){var g=r+l,a=g+y,p=a+y,w=p+y,_=e[g],P=e[g+1],M=e[a],k=e[a+1],T=e[p],I=e[p+1],z=e[w],B=e[w+1],K=_,$=P,L=f[v],te=c*f[v+1],O=M*L-k*te,G=M*te+k*L,me=f[2*v],ce=c*f[2*v+1],le=T*me-I*ce,ue=T*ce+I*me,ne=f[3*v],he=c*f[3*v+1],ge=z*ne-B*he,ve=z*he+B*ne,de=K+le,ie=$+ue,ye=K-le,be=$-ue,u=O+ge,C=G+ve,q=c*(O-ge),W=c*(G-ve),j=de+u,we=ie+C,Ce=ye+W,De=be-q;if(e[g]=j,e[g+1]=we,e[a]=Ce,e[a+1]=De,l===0){var Fe=de-u,Ne=ie-C;e[p]=Fe,e[p+1]=Ne;continue}if(l!==b){var re=ye,Ee=-be,qe=de,Te=-ie,J=-c*W,xe=-c*q,gt=-c*C,vt=-c*u,yt=re+J,wt=Ee+xe,bt=qe+vt,pt=Te-gt,nt=r+y-l,st=r+m-l;e[nt]=yt,e[nt+1]=wt,e[st]=bt,e[st+1]=pt}}}};Z.prototype._singleRealTransform2=function(e,t,s){const n=this._out,o=this._data,r=o[t],d=o[t+s],h=r+d,c=r-d;n[e]=h,n[e+1]=0,n[e+2]=c,n[e+3]=0};Z.prototype._singleRealTransform4=function(e,t,s){const n=this._out,o=this._data,r=this._inv?-1:1,d=s*2,h=s*3,c=o[t],f=o[t+s],m=o[t+d],y=o[t+h],b=c+m,l=c-m,v=f+y,g=r*(f-y),a=b+v,p=l,w=-g,_=b-v,P=l,M=g;n[e]=a,n[e+1]=0,n[e+2]=p,n[e+3]=w,n[e+4]=_,n[e+5]=0,n[e+6]=P,n[e+7]=M};const Ct=At(St);class ke{constructor(e,t){ee(this,"_inputLength");ee(this,"_fft");ee(this,"_bufferSupplier");ee(this,"_paddedInputBuffer");ee(this,"_transformBuffer");ee(this,"_inverseBuffer");if(e<1)throw new Error("Input length must be at least one");this._inputLength=e,this._fft=new Ct(xt(2*e)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(e){return new ke(e,t=>new Float32Array(t))}static forFloat64Array(e){return new ke(e,t=>new Float64Array(t))}static forNumberArray(e){return new ke(e,t=>Array(t))}get inputLength(){return this._inputLength}autocorrelate(e,t=this._bufferSupplier(e.length)){if(e.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${e.length}`);for(let n=0;n<e.length;n++)this._paddedInputBuffer[n]=e[n];for(let n=e.length;n<this._paddedInputBuffer.length;n++)this._paddedInputBuffer[n]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const s=this._transformBuffer;for(let n=0;n<s.length;n+=2)s[n]=s[n]*s[n]+s[n+1]*s[n+1],s[n+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let n=0;n<e.length;n++)t[n]=this._inverseBuffer[2*n];return t}}function Ft(i){const e=[];let t=!1,s=-1/0,n=-1;for(let o=1;o<i.length-1;o++)i[o-1]<=0&&i[o]>0?(t=!0,n=o,s=i[o]):i[o-1]>0&&i[o]<=0?(t=!1,n!==-1&&e.push(n)):t&&i[o]>s&&(s=i[o],n=o);return e}function Nt(i,e){const[t,s,n]=[i-1,i,i+1],[o,r,d]=[e[t],e[s],e[n]],h=o/2-r+d/2,c=-(o/2)*(s+n)+r*(t+n)-d/2*(t+s),f=o*s*n/2-r*t*n+d*t*s/2,m=-c/(2*h),y=h*m*m+c*m+f;return[m,y]}class Ae{constructor(e,t){ee(this,"_autocorrelator");ee(this,"_nsdfBuffer");ee(this,"_clarityThreshold",.9);ee(this,"_minVolumeAbsolute",0);ee(this,"_maxInputAmplitude",1);this._autocorrelator=new ke(e,t),this._nsdfBuffer=t(e)}static forFloat32Array(e){return new Ae(e,t=>new Float32Array(t))}static forFloat64Array(e){return new Ae(e,t=>new Float64Array(t))}static forNumberArray(e){return new Ae(e,t=>Array(t))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(e){if(!Number.isFinite(e)||e<=0||e>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=e}set minVolumeAbsolute(e){if(!Number.isFinite(e)||e<0||e>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=e}set minVolumeDecibels(e){if(!Number.isFinite(e)||e>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(e/10)}set maxInputAmplitude(e){if(!Number.isFinite(e)||e<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=e}findPitch(e,t){if(this._belowMinimumVolume(e))return[0,0];this._nsdf(e);const s=Ft(this._nsdfBuffer);if(s.length===0)return[0,0];const n=Math.max(...s.map(h=>this._nsdfBuffer[h])),o=s.find(h=>this._nsdfBuffer[h]>=this._clarityThreshold*n),[r,d]=Nt(o,this._nsdfBuffer);return[t/r,Math.min(d,1)]}_belowMinimumVolume(e){if(this._minVolumeAbsolute===0)return!1;let t=0;for(let s=0;s<e.length;s++)t+=e[s]**2;return Math.sqrt(t/e.length)<this._minVolumeAbsolute}_nsdf(e){this._autocorrelator.autocorrelate(e,this._nsdfBuffer);let t=2*this._nsdfBuffer[0],s;for(s=0;s<this._nsdfBuffer.length&&t>0;s++)this._nsdfBuffer[s]=2*this._nsdfBuffer[s]/t,t-=e[s]**2+e[e.length-s-1]**2;for(;s<this._nsdfBuffer.length;s++)this._nsdfBuffer[s]=0}}function xt(i){return i--,i|=i>>1,i|=i>>2,i|=i>>4,i|=i>>8,i|=i>>16,i++,i}const Ie="src/lib/components/VolumeBar.svelte";function Be(i){let e,t,s,n,o,r;const d={c:function(){e=x("div"),t=x("div"),s=x("div"),n=Q(),o=x("div"),this.h()},l:function(c){e=N(c,"DIV",{class:!0});var f=E(e);t=N(f,"DIV",{class:!0,style:!0});var m=E(t);s=N(m,"DIV",{class:!0,style:!0}),E(s).forEach(A),m.forEach(A),n=U(f),o=N(f,"DIV",{class:!0,style:!0}),E(o).forEach(A),f.forEach(A),this.h()},h:function(){S(s,"class","volume-bar-fill"),H(s,"position","absolute"),H(s,"top","0"),H(s,"left","0"),H(s,"height","100%"),F(s,Ie,51,4,1464),S(t,"class","volume-bar-bg"),H(t,"height",i[1]),H(t,"border-radius","9999px"),H(t,"background-color","#e2e8f0"),H(t,"position","relative"),H(t,"overflow","hidden"),F(t,Ie,50,2,1318),S(o,"class","threshold-indicator svelte-13z7ppf"),H(o,"position","absolute"),H(o,"top","0"),H(o,"left",i[0]+"%"),H(o,"width","2px"),H(o,"height",i[1]),H(o,"background-color","#64748b"),H(o,"border-radius","1px"),F(o,Ie,59,2,1643),S(e,"class",r="volume-bar-container "+i[2]+" svelte-13z7ppf"),F(e,Ie,49,0,1269)},m:function(c,f){se(c,e,f),D(e,t),D(t,s),i[5](s),D(e,n),D(e,o)},p:function(c,[f]){f&2&&H(t,"height",c[1]),f&1&&H(o,"left",c[0]+"%"),f&2&&H(o,"height",c[1]),f&4&&r!==(r="volume-bar-container "+c[2]+" svelte-13z7ppf")&&S(e,"class",r)},i:ot,o:ot,d:function(c){c&&A(e),i[5](null)}};return oe("SvelteRegisterBlock",{block:d,id:Be.name,type:"component",source:"",ctx:i}),d}function kt(i,e,t){let{$$slots:s={},$$scope:n}=e;Xe("VolumeBar",s,[]);let{volume:o=0}=e,{threshold:r=30}=e,{height:d="12px"}=e,{className:h=""}=e,c;function f(l){return l<r?`rgba(37, 99, 235, ${Math.max(.2,l/r*.8)})`:"#2563eb"}function m(l){if(c){const v=Math.max(0,Math.min(100,l)),g=f(v);t(3,c.style.width=`${v}%`,c),t(3,c.style.backgroundColor=g,c)}}He(()=>{c&&(t(3,c.style.width="0%",c),t(3,c.style.backgroundColor="#2563eb",c),t(3,c.style.height=d,c),t(3,c.style.borderRadius="9999px",c),t(3,c.style.transition="width 0.2s ease-out, background-color 0.2s ease-out",c))});const y=["volume","threshold","height","className"];Object.keys(e).forEach(l=>{!~y.indexOf(l)&&l.slice(0,2)!=="$$"&&l!=="slot"&&console.warn(`<VolumeBar> was created with unknown prop '${l}'`)});function b(l){Mt[l?"unshift":"push"](()=>{c=l,t(3,c)})}return i.$$set=l=>{"volume"in l&&t(4,o=l.volume),"threshold"in l&&t(0,r=l.threshold),"height"in l&&t(1,d=l.height),"className"in l&&t(2,h=l.className)},i.$capture_state=()=>({onMount:He,volume:o,threshold:r,height:d,className:h,barElement:c,getVolumeColor:f,updateVolumeBar:m}),i.$inject_state=l=>{"volume"in l&&t(4,o=l.volume),"threshold"in l&&t(0,r=l.threshold),"height"in l&&t(1,d=l.height),"className"in l&&t(2,h=l.className),"barElement"in l&&t(3,c=l.barElement)},e&&"$$inject"in e&&i.$inject_state(e.$$inject),i.$$.update=()=>{i.$$.dirty&16&&m(o)},[r,d,h,c,o,b]}class ze extends Qe{constructor(e){super(e),Ke(this,e,kt,Be,Je,{volume:4,threshold:0,height:1,className:2}),oe("SvelteRegisterComponent",{component:this,tagName:"VolumeBar",options:e,id:Be.name})}get volume(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set volume(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get threshold(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set threshold(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get height(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set height(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}class Et{constructor(){this.audioContext=null,this.mediaStream=null,this.sourceNode=null,this.gainNode=null,this.analysers=new Map,this.filters=new Map,this.refCount=0,this.initPromise=null,this.isInitialized=!1,this.lastError=null,this.currentSensitivity=this._getDefaultSensitivity()}_getDefaultSensitivity(){const e=/iPhone/.test(navigator.userAgent),t=/iPad/.test(navigator.userAgent),s=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document;return t||s?(console.log("🔧 [AudioManager] iPad検出 - デフォルト感度7.0x設定"),7):e?(console.log("🔧 [AudioManager] iPhone検出 - デフォルト感度3.0x設定"),3):(console.log("🔧 [AudioManager] PC検出 - デフォルト感度1.0x設定"),1)}async initialize(){var e,t,s;if(this.initPromise)return this.initPromise;if(this.isInitialized&&this.audioContext&&this.mediaStream){const n=this.checkMediaStreamHealth();if(n.healthy)return this.refCount++,{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode};console.warn("⚠️ [AudioManager] MediaStream不健康検出 - 強制再初期化:",n.reason),console.log("🔄 [AudioManager] 不健康なMediaStream詳細:",{mediaStreamActive:(e=this.mediaStream)==null?void 0:e.active,trackCount:(t=this.mediaStream)==null?void 0:t.getTracks().length,trackStates:(s=this.mediaStream)==null?void 0:s.getTracks().map(o=>({kind:o.kind,readyState:o.readyState,enabled:o.enabled,muted:o.muted}))}),this._cleanup(),this.isInitialized=!1,this.refCount=0,await new Promise(o=>setTimeout(o,100)),console.log("🔄 [AudioManager] クリーンアップ完了 - 再初期化開始")}this.initPromise=this._doInitialize();try{const n=await this.initPromise;return this.initPromise=null,n}catch(n){throw this.initPromise=null,n}}async _doInitialize(){try{if(console.log("🎤 [AudioManager] 初期化開始"),this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),console.log("✅ [AudioManager] AudioContext作成完了")),this.audioContext.state==="suspended"&&(await this.audioContext.resume(),console.log("✅ [AudioManager] AudioContext再開完了")),!this.mediaStream){const e=/iPhone/.test(navigator.userAgent),t=/iPad/.test(navigator.userAgent),s=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document,n=e||t||s;console.log(`🔍 [AudioManager] デバイス検出: ${t||s?"iPad":e?"iPhone":"その他"}`,navigator.userAgent),console.log(`🔍 [AudioManager] タッチサポート: ${"ontouchend"in document}`);const r={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,...n&&{googAutoGainControl:!1,googNoiseSuppression:!1,googEchoCancellation:!1,googHighpassFilter:!1,googTypingNoiseDetection:!1,googBeamforming:!1,mozAutoGainControl:!1,mozNoiseSuppression:!1},sampleRate:44100,channelCount:1,sampleSize:16,latency:.1,volume:1,deviceId:{ideal:"default"}}};console.log("🎤 [AudioManager] Safari対応設定でMediaStream取得中:",r),this.mediaStream=await navigator.mediaDevices.getUserMedia(r),console.log("✅ [AudioManager] MediaStream取得完了")}if(!this.sourceNode){this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),console.log("✅ [AudioManager] SourceNode作成完了");const e=this.mediaStream.getTracks();console.log("🎤 [AudioManager] MediaStream tracks:",e.map(t=>({kind:t.kind,label:t.label,enabled:t.enabled,readyState:t.readyState,muted:t.muted})))}return this.gainNode||(this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=this.currentSensitivity,this.sourceNode.connect(this.gainNode),console.log(`✅ [AudioManager] GainNode作成完了 (感度: ${this.currentSensitivity}x)`)),this.isInitialized=!0,this.refCount++,this.lastError=null,console.log(`🎤 [AudioManager] 初期化完了 (参照カウント: ${this.refCount})`),{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode}}catch(e){throw console.error("❌ [AudioManager] 初期化エラー:",e),this.lastError=e,this.isInitialized=!1,this._cleanup(),e}}createAnalyser(e,t={}){if(!this.isInitialized||!this.audioContext||!this.sourceNode)throw new Error("AudioManager not initialized. Call initialize() first.");this.removeAnalyser(e);const{fftSize:s=2048,smoothingTimeConstant:n=.8,minDecibels:o=-90,maxDecibels:r=-10,useFilters:d=!0}=t,h=this.audioContext.createAnalyser();h.fftSize=Math.min(s,2048),h.smoothingTimeConstant=Math.max(n,.7),h.minDecibels=Math.max(o,-80),h.maxDecibels=Math.min(r,-10);let c=this.gainNode||this.sourceNode;if(d){const f=this._createFilterChain();this.filters.set(e,f),c.connect(f.highpass),f.highpass.connect(f.lowpass),f.lowpass.connect(f.notch),f.notch.connect(h),console.log(`🔧 [AudioManager] フィルター付きAnalyser作成: ${e}`)}else c.connect(h),console.log(`🔧 [AudioManager] 生信号Analyser作成: ${e}`);return this.analysers.set(e,h),h}_createFilterChain(){const e=this.audioContext.createBiquadFilter();e.type="highpass",e.frequency.setValueAtTime(80,this.audioContext.currentTime),e.Q.setValueAtTime(.7,this.audioContext.currentTime);const t=this.audioContext.createBiquadFilter();t.type="lowpass",t.frequency.setValueAtTime(800,this.audioContext.currentTime),t.Q.setValueAtTime(.7,this.audioContext.currentTime);const s=this.audioContext.createBiquadFilter();return s.type="notch",s.frequency.setValueAtTime(60,this.audioContext.currentTime),s.Q.setValueAtTime(10,this.audioContext.currentTime),{highpass:e,lowpass:t,notch:s}}removeAnalyser(e){if(this.analysers.has(e)&&(this.analysers.get(e).disconnect(),this.analysers.delete(e),console.log(`🗑️ [AudioManager] Analyser削除: ${e}`)),this.filters.has(e)){const t=this.filters.get(e);t.highpass.disconnect(),t.lowpass.disconnect(),t.notch.disconnect(),this.filters.delete(e),console.log(`🗑️ [AudioManager] フィルターチェーン削除: ${e}`)}}setSensitivity(e){const t=Math.max(.1,Math.min(10,e));this.gainNode?(this.gainNode.gain.value=t,this.currentSensitivity=t,console.log(`🎤 [AudioManager] マイク感度更新: ${t.toFixed(1)}x`)):(this.currentSensitivity=t,console.log(`🎤 [AudioManager] マイク感度設定（初期化待ち）: ${t.toFixed(1)}x`))}getSensitivity(){return this.currentSensitivity}getPlatformSpecs(){const e=/iPhone/.test(navigator.userAgent),t=/iPad/.test(navigator.userAgent),s=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document,n=e||t||s;return{divisor:n?4:6,gainCompensation:n?1.5:1,noiseThreshold:n?12:15,smoothingFactor:.2,deviceType:t||s?"iPad":e?"iPhone":"PC",isIOS:n}}release(e=[]){e.forEach(t=>this.removeAnalyser(t)),this.refCount=Math.max(0,this.refCount-1),console.log(`📉 [AudioManager] 参照カウント減算: ${this.refCount}`),this.refCount<=0&&(console.log("🧹 [AudioManager] 全リソースクリーンアップ開始"),this._cleanup())}forceCleanup(){console.log("🚨 [AudioManager] 強制クリーンアップ実行"),this._cleanup()}_cleanup(){console.log("🧹 [AudioManager] クリーンアップ開始");for(const e of this.analysers.keys())this.removeAnalyser(e);if(this.mediaStream){const e=this.mediaStream.getTracks();console.log(`🛑 [AudioManager] MediaStream停止中: ${e.length} tracks`),e.forEach((t,s)=>{try{t.readyState!=="ended"?(t.stop(),console.log(`🛑 [AudioManager] Track ${s} 停止完了`)):console.log(`⚠️ [AudioManager] Track ${s} 既に終了済み`)}catch(n){console.warn(`⚠️ [AudioManager] Track ${s} 停止エラー:`,n)}}),this.mediaStream=null}if(this.audioContext&&this.audioContext.state!=="closed"){try{this.audioContext.close(),console.log("🛑 [AudioManager] AudioContext閉鎖完了")}catch(e){console.warn("⚠️ [AudioManager] AudioContext閉鎖エラー:",e)}this.audioContext=null}this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.isInitialized=!1,this.refCount=0,this.initPromise=null,this.currentSensitivity=this._getDefaultSensitivity(),console.log("✅ [AudioManager] クリーンアップ完了")}getStatus(){var e,t;return{isInitialized:this.isInitialized,refCount:this.refCount,audioContextState:((e=this.audioContext)==null?void 0:e.state)||"none",mediaStreamActive:((t=this.mediaStream)==null?void 0:t.active)||!1,activeAnalysers:Array.from(this.analysers.keys()),activeFilters:Array.from(this.filters.keys()),lastError:this.lastError}}checkMediaStreamHealth(){if(!this.mediaStream)return{healthy:!1,reason:"MediaStream not initialized"};if(!this.mediaStream.active)return{healthy:!1,reason:"MediaStream inactive"};const e=this.mediaStream.getTracks();if(e.length===0)return{healthy:!1,reason:"No tracks available"};const t=e.find(s=>s.kind==="audio");return t?t.readyState==="ended"?{healthy:!1,reason:"Audio track ended"}:t.enabled?t.muted?{healthy:!1,reason:"Audio track muted"}:this.mediaStream.active&&t.readyState!=="live"?{healthy:!1,reason:"Track state inconsistent with MediaStream"}:{healthy:!0,track:t}:{healthy:!1,reason:"Audio track disabled"}:{healthy:!1,reason:"No audio track found"}}}const Me=new Et;typeof window<"u"&&(window.audioManager=Me);class Tt{constructor(e={}){this.vocalRangeMin=e.vocalRangeMin||130.81,this.vocalRangeMax=e.vocalRangeMax||1046.5,this.stabilityThreshold=e.stabilityThreshold||.3,this.evaluationWeights={vocalRange:e.vocalRangeWeight||.4,continuity:e.continuityWeight||.4,musical:e.musicalWeight||.2},this.fundamentalCandidates=e.fundamentalCandidates||[1,.5,.333,2],this.harmonicHistory=[],this.previousFrequency=0,this.maxHistoryLength=5,this.debugMode=!1,this.volumeThreshold=e.volumeThreshold||.02,this.currentContext={}}correctHarmonic(e,t=1,s=!1){if(!e||e<=0)return 0;const n=t>=this.volumeThreshold,r=this.fundamentalCandidates.map(c=>({frequency:e*c,ratio:c})).map(c=>{const f=this.evaluateFundamental(c.frequency);return{...c,...f}}),d=r.reduce((c,f)=>f.totalScore>c.totalScore?f:c),h=this.stabilizeFrequency(d.frequency,n);return(s||this.debugMode)&&this.logHarmonicCorrection(e,r,d,h,this.currentContext,t,n),n&&(this.previousFrequency=h),h}logHarmonicCorrection(e,t,s,n,o={},r=1,d=!0){console.group(`🔧 [HarmonicCorrection] ${e.toFixed(1)}Hz → ${n.toFixed(1)}Hz`),console.log(`🔊 音量: ${(r*100).toFixed(1)}% (閾値: ${(this.volumeThreshold*100).toFixed(1)}%) ${d?"✅ 有効":"❌ ノイズ除外"}`);const h=this.frequencyToNote(e),c=this.frequencyToNote(n);console.log(`📝 音程変換: ${h} → ${c}`);const f=this.getCorrectionType(s.ratio);if(console.log(`🎯 補正タイプ: ${f}`),o.baseFrequency&&o.currentScale&&o.targetFrequency){console.log("🎵 音階コンテキスト:"),console.log(`   基音: ${o.baseFrequency.toFixed(1)}Hz (${this.frequencyToNote(o.baseFrequency)})`),console.log(`   現在の音階: ${o.currentScale}`),console.log(`   目標周波数: ${o.targetFrequency.toFixed(1)}Hz (${this.frequencyToNote(o.targetFrequency)})`);const y=n-o.targetFrequency,b=1200*Math.log2(n/o.targetFrequency);console.log(`   目標との差: ${y>0?"+":""}${y.toFixed(1)}Hz (${b>0?"+":""}${b.toFixed(0)}セント)`);const l=Math.abs(b)<=50?"🎯 高精度":Math.abs(b)<=100?"✅ 良好":Math.abs(b)<=200?"⚠️ 要改善":"❌ 不正確";console.log(`   精度評価: ${l} (${Math.abs(b).toFixed(0)}セント差)`)}console.table(t.map(y=>({倍率:`${y.ratio.toFixed(3)}x`,周波数:`${y.frequency.toFixed(1)}Hz`,音名:this.frequencyToNote(y.frequency),音域:y.vocalRangeScore.toFixed(2),連続性:y.continuityScore.toFixed(2),音楽性:y.musicalScore.toFixed(2),総合:y.totalScore.toFixed(3),選択:y===s?"✅":""})));const m=Math.abs(n-s.frequency);m>.5&&console.log(`🔄 安定化: ${s.frequency.toFixed(1)}Hz → ${n.toFixed(1)}Hz (${m.toFixed(1)}Hz調整)`),console.groupEnd()}getCorrectionType(e){return Math.abs(e-1)<.01?"補正なし（基音）":Math.abs(e-.5)<.01?"2倍音補正（1オクターブ下）":Math.abs(e-.333)<.01?"3倍音補正（1オクターブ+5度下）":Math.abs(e-.25)<.01?"4倍音補正（2オクターブ下）":Math.abs(e-2)<.01?"オクターブ上補正":`カスタム補正（${e.toFixed(3)}x）`}frequencyToNote(e){if(!e||e<=0)return"---";const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=Math.round(12*Math.log2(e/440)),o=(n+9+120)%12,r=Math.floor((n+9)/12)+4;return t[o]+r}evaluateFundamental(e){const s=e>=this.vocalRangeMin&&e<=this.vocalRangeMax?1:0,n=this.previousFrequency>0?1-Math.min(Math.abs(e-this.previousFrequency)/this.previousFrequency,1):.5,o=this.calculateMusicalScore(e),r=s*this.evaluationWeights.vocalRange+n*this.evaluationWeights.continuity+o*this.evaluationWeights.musical;return{vocalRangeScore:s,continuityScore:n,musicalScore:o,totalScore:r}}calculateMusicalScore(e){const s=Math.log2(e/261.63)*12,n=Math.round(s),o=Math.abs(s-n);return Math.max(0,1-o/.5)}stabilizeFrequency(e,t=!0){if(!e||e<=0)return 0;if(t&&this.harmonicHistory.push(e),this.harmonicHistory.length>this.maxHistoryLength&&this.harmonicHistory.shift(),this.harmonicHistory.length<2)return e;const s=[...this.harmonicHistory].sort((d,h)=>d-h),n=s[Math.floor(s.length/2)],o=n*this.stabilityThreshold;return Math.abs(e-n)>o?n+Math.sign(e-n)*o:e}resetHistory(){this.harmonicHistory=[],this.previousFrequency=0}updateConfig(e){Object.assign(this,e),console.log("⚙️ [HarmonicCorrection] 設定更新:",e)}enableDebugLogging(){this.debugMode=!0,console.log("🔍 [HarmonicCorrection] デバッグログ有効化 - 次回の補正から詳細ログを出力します"),console.log("無効化するには: harmonicCorrection.disableDebugLogging()")}disableDebugLogging(){this.debugMode=!1,console.log("🔍 [HarmonicCorrection] デバッグログ無効化")}setScaleContext(e){this.currentContext={baseFrequency:e.baseFrequency,currentScale:e.currentScale,targetFrequency:e.targetFrequency}}clearContext(){this.currentContext={}}getStatus(){return{vocalRangeMin:this.vocalRangeMin,vocalRangeMax:this.vocalRangeMax,stabilityThreshold:this.stabilityThreshold,evaluationWeights:this.evaluationWeights,historyLength:this.harmonicHistory.length,previousFrequency:this.previousFrequency,recentHistory:this.harmonicHistory.slice(-3)}}}const Pe=new Tt;typeof window<"u"&&(window.harmonicCorrection=Pe);const ht=(()=>{if(typeof window<"u"){const e=new URLSearchParams(window.location.search).get("debug");if(e)return e}return"info"})(),fe={error:0,warn:1,info:2,debug:3},pe=fe[ht]??fe.info,Re={error:(i,...e)=>{pe>=fe.error&&console.error(`❌ ${i}`,...e)},warn:(i,...e)=>{pe>=fe.warn&&console.warn(`⚠️ ${i}`,...e)},info:(i,...e)=>{pe>=fe.info&&console.log(`ℹ️ ${i}`,...e)},debug:(i,...e)=>{pe>=fe.debug&&console.log(`🔍 ${i}`,...e)},realtime:(()=>{let i=0;const e=1e3;return(t,...s)=>{if(pe>=fe.debug){const n=Date.now();n-i>=e&&(console.log(`📊 ${t}`,...s),i=n)}}})(),scoring:(i,...e)=>{pe>=fe.info&&console.log(`🎯 ${i}`,...e)},audio:(i,...e)=>{pe>=fe.info&&console.log(`🎤 ${i}`,...e)}};typeof import.meta<"u"&&Re.info(`Debug Level: ${ht} (Change with ?debug=level)`);const{Error:R,console:It}=Pt,_e="src/lib/components/PitchDetector.svelte";function Le(i){let e,t,s,n,o=(i[2]>0?Math.round(i[2]):"---")+"",r,d,h,c="Hz",f,m,y="|",b,l,v,g,a,p,w;a=new ze({props:{volume:i[2]>0?i[1]:0,className:"volume-bar"},$$inline:!0});const _={c:function(){e=x("div"),t=x("div"),s=x("div"),n=x("span"),r=Y(o),d=Q(),h=x("span"),h.textContent=c,f=Q(),m=x("span"),m.textContent=y,b=Q(),l=x("span"),v=Y(i[3]),g=Q(),tt(a.$$.fragment),this.h()},l:function(M){e=N(M,"DIV",{class:!0});var k=E(e);t=N(k,"DIV",{class:!0});var T=E(t);s=N(T,"DIV",{class:!0});var I=E(s);n=N(I,"SPAN",{class:!0});var z=E(n);r=X(z,o),z.forEach(A),d=U(I),h=N(I,"SPAN",{class:!0,"data-svelte-h":!0}),Se(h)!=="svelte-5uyilv"&&(h.textContent=c),f=U(I),m=N(I,"SPAN",{class:!0,"data-svelte-h":!0}),Se(m)!=="svelte-1dytxz4"&&(m.textContent=y),b=U(I),l=N(I,"SPAN",{class:!0});var B=E(l);v=X(B,i[3]),B.forEach(A),I.forEach(A),g=U(T),et(a.$$.fragment,T),T.forEach(A),k.forEach(A),this.h()},h:function(){S(n,"class","detected-frequency svelte-vc1bho"),F(n,_e,528,6,15447),S(h,"class","hz-suffix svelte-vc1bho"),F(h,_e,529,6,15555),S(m,"class","divider svelte-vc1bho"),F(m,_e,530,6,15595),S(l,"class","detected-note svelte-vc1bho"),F(l,_e,531,6,15632),S(s,"class","detection-card svelte-vc1bho"),F(s,_e,527,4,15412),S(t,"class","detection-display svelte-vc1bho"),F(t,_e,526,2,15376),S(e,"class",p="pitch-detector "+i[0]+" svelte-vc1bho"),F(e,_e,525,0,15333)},m:function(M,k){se(M,e,k),D(e,t),D(t,s),D(s,n),D(n,r),D(s,d),D(s,h),D(s,f),D(s,m),D(s,b),D(s,l),D(l,v),D(t,g),$e(a,t,null),w=!0},p:function(M,k){(!w||k[0]&4)&&o!==(o=(M[2]>0?Math.round(M[2]):"---")+"")&&ae(r,o),(!w||k[0]&8)&&ae(v,M[3]);const T={};k[0]&6&&(T.volume=M[2]>0?M[1]:0),a.$set(T),(!w||k[0]&1&&p!==(p="pitch-detector "+M[0]+" svelte-vc1bho"))&&S(e,"class",p)},i:function(M){w||(Oe(a.$$.fragment,M),w=!0)},o:function(M){Ze(a.$$.fragment,M),w=!1},d:function(M){M&&A(e),Ye(a)}};return oe("SvelteRegisterBlock",{block:_,id:Le.name,type:"component",source:"",ctx:i}),_}function ct(i){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(i<=0)return"ーー";const s=Math.round(12*Math.log2(i/440)),n=(s+9+120)%12,o=Math.floor((s+9)/12)+4;return e[n]+o}function zt(i,e,t){let{$$slots:s={},$$scope:n}=e;Xe("PitchDetector",s,[]);const o=it();let{isActive:r=!1}=e,{className:d=""}=e,{debugMode:h=!1}=e,{trainingPhase:c=""}=e,{disableHarmonicCorrection:f=!1}=e,m="uninitialized",y=null,b=!1,l=null,v=null,g=null,a=null,p=null,w=null,_=null,P=!1,M=[],k=new Map,T=0,I=0,z=0,B="ーー",K=0,$=[],L=[],te=0,O=0,G=null;function me(){T=0,t(1,I=0),t(2,z=0),t(3,B="ーー"),K=0,te=0,O=0,$=[],L=[],Pe.resetHistory(),h&&console.log("🔄 [PitchDetector] Display state reset")}function ce(){if(!h)return;const u=new Date().toLocaleTimeString(),C={timestamp:u,componentState:m,isActive:r,isDetecting:P,isInitialized:b,mediaStreamActive:v?v.active:null,mediaStreamTracks:v?v.getTracks().length:0,trackStates:v?v.getTracks().map(j=>({kind:j.kind,enabled:j.enabled,readyState:j.readyState,muted:j.muted})):[],audioContextState:l?l.state:null,hasAnalyser:!!a,currentVolume:T,currentFrequency:z};Re.realtime(`[PitchDetector] ${u}:`,C);let q=!0,W=[];v&&!v.active&&(console.warn("⚠️ [PitchDetector] MediaStream is inactive!",v),q=!1,W.push("MediaStream inactive")),l&&l.state==="suspended"&&(console.warn("⚠️ [PitchDetector] AudioContext is suspended!",l),q=!1,W.push("AudioContext suspended")),v&&v.getTracks().forEach((j,we)=>{j.readyState==="ended"&&(console.error(`❌ [PitchDetector] Track ${we} has ended!`,j),q=!1,W.push(`Track ${we} ended`))}),o("microphoneHealthChange",{healthy:q,errors:W,details:C})}async function le(){try{t(16,m="initializing"),y=null,console.log("🎙️ [PitchDetector] AudioManager経由で初期化開始");const u=await Me.initialize();l=u.audioContext,v=u.mediaStream,g=u.sourceNode,console.log("✅ [PitchDetector] AudioManager リソース取得完了");const C=`pitch-detector-filtered-${Date.now()}`;t(17,a=Me.createAnalyser(C,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!0})),M.push(C);const q=`pitch-detector-raw-${Date.now()}`;p=Me.createAnalyser(q,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!1}),M.push(q),console.log("✅ [PitchDetector] Analyser作成完了:",M),w=Ae.forFloat32Array(a.fftSize),t(16,m="ready"),b=!0,o("stateChange",{state:m}),ye(),console.log("✅ [PitchDetector] 初期化完了")}catch(u){throw console.error("❌ [PitchDetector] 初期化エラー:",u),t(16,m="error"),y=u,b=!1,o("error",{error:u,context:"initialization"}),u}}function ue(){if(m!=="ready"){const u=new Error(`Cannot start detection: component state is ${m}`);return o("error",{error:u,context:"start-detection"}),!1}if(!a||!w||!l){const u=new Error("Required components not available");return t(16,m="error"),o("error",{error:u,context:"start-detection"}),!1}return t(16,m="detecting"),t(18,P=!0),o("stateChange",{state:m}),he(),!0}function ne(){t(18,P=!1),_&&(cancelAnimationFrame(_),_=null),m==="detecting"&&b&&(t(16,m="ready"),o("stateChange",{state:m}))}function he(){if(!P||!a||!p||!w)return;const u=a.fftSize,C=new Float32Array(u),q=new Float32Array(p.fftSize);a.getFloatTimeDomainData(C),p.getFloatTimeDomainData(q);let W=0;for(let J=0;J<u;J++)W+=Math.abs(C[J]);const j=Math.sqrt(W/u),we=Math.log10(j+.001)*50+100,Ce=Math.max(0,Math.min(100,we));let De=0;for(let J=0;J<q.length;J++)De+=Math.abs(q[J]);const Fe=Math.sqrt(De/q.length),Ne=Math.log10(Fe+.001)*50+100;t(1,I=Math.max(0,Math.min(100,Ne))),L.push(Ce),L.length>5&&L.shift(),O=L.reduce((J,xe)=>J+xe,0)/L.length,T=O;const[re,Ee]=w.findPitch(C,l.sampleRate),qe=re>=65&&re<=1200;if(re&&Ee>.8&&T>30&&qe){let J=re;if(f)h&&console.log("🔧 [PitchDetector] ハーモニック補正無効化中 - 生値使用:",re);else{const xe=Math.min(T/100,1);J=Pe.correctHarmonic(re,xe)}t(2,z=Math.round(J)),t(3,B=ct(z)),K=Ee}else z===0&&Pe.resetHistory(),t(2,z=0),t(3,B="ーー"),K=0;const Te=z>0?I:0;o("pitchUpdate",{frequency:z,note:B,volume:Te,rawVolume:Te,clarity:K}),_=requestAnimationFrame(he)}function ge(){return b&&m==="ready"}function ve(){return{componentState:m,isInitialized:b,isDetecting:P,lastError:y,hasRequiredComponents:!!(a&&w&&l&&v)}}async function de(){console.log("🔄 [PitchDetector] 再初期化開始"),ie(),await new Promise(u=>setTimeout(u,100)),await le(),console.log("✅ [PitchDetector] 再初期化完了")}function ie(){console.log("🧹 [PitchDetector] クリーンアップ開始"),ne(),k.size>0&&(k.forEach((u,C)=>{C.removeEventListener("ended",u.endedHandler),C.removeEventListener("mute",u.muteHandler),C.removeEventListener("unmute",u.unmuteHandler)}),k.clear(),console.log("🔄 [PitchDetector] MediaStreamイベントリスナー削除")),M.length>0&&(Me.release(M),console.log("📤 [PitchDetector] AudioManagerにAnalyser解放通知:",M),M=[]),t(16,m="uninitialized"),b=!1,y=null,l=null,v=null,g=null,t(17,a=null),p=null,w=null,$=[],L=[],Pe.resetHistory(),console.log("✅ [PitchDetector] クリーンアップ完了")}function ye(){if(!v)return;const u=v.getTracks();u.forEach(C=>{const q=()=>{console.error("🚨 [PitchDetector] MediaStreamTrack終了検出:",C.kind),t(16,m="error"),y=new Error(`MediaStreamTrack (${C.kind}) ended`),o("error",{error:y,reason:"mediastream_ended",recovery:"restart_required"}),P&&ne()},W=()=>{console.warn("⚠️ [PitchDetector] MediaStreamTrack muted:",C.kind),o("warning",{reason:"track_muted",track:C.kind})},j=()=>{console.log("✅ [PitchDetector] MediaStreamTrack unmuted:",C.kind),o("info",{reason:"track_unmuted",track:C.kind})};C.addEventListener("ended",q),C.addEventListener("mute",W),C.addEventListener("unmute",j),k.set(C,{endedHandler:q,muteHandler:W,unmuteHandler:j})}),console.log("🔍 [PitchDetector] MediaStream監視開始:",u.length+" tracks")}rt(()=>{G&&(clearInterval(G),t(19,G=null)),console.log("🔄 [PitchDetector] onDestroy - AudioManagerリソースは保持")});const be=["isActive","className","debugMode","trainingPhase","disableHarmonicCorrection"];return Object.keys(e).forEach(u=>{!~be.indexOf(u)&&u.slice(0,2)!=="$$"&&u!=="slot"&&It.warn(`<PitchDetector> was created with unknown prop '${u}'`)}),i.$$set=u=>{"isActive"in u&&t(4,r=u.isActive),"className"in u&&t(0,d=u.className),"debugMode"in u&&t(5,h=u.debugMode),"trainingPhase"in u&&t(6,c=u.trainingPhase),"disableHarmonicCorrection"in u&&t(7,f=u.disableHarmonicCorrection)},i.$capture_state=()=>({onMount:He,onDestroy:rt,createEventDispatcher:it,PitchDetector:Ae,VolumeBar:ze,audioManager:Me,harmonicCorrection:Pe,logger:Re,dispatch:o,isActive:r,className:d,debugMode:h,trainingPhase:c,disableHarmonicCorrection:f,componentState:m,lastError:y,isInitialized:b,audioContext:l,mediaStream:v,sourceNode:g,analyser:a,rawAnalyser:p,pitchDetector:w,animationFrame:_,isDetecting:P,analyserIds:M,mediaStreamListeners:k,currentVolume:T,rawVolume:I,currentFrequency:z,detectedNote:B,pitchClarity:K,frequencyHistory:$,volumeHistory:L,stableFrequency:te,stableVolume:O,debugInterval:G,resetDisplayState:me,checkMicrophoneStatus:ce,initialize:le,startDetection:ue,stopDetection:ne,detectPitch:he,frequencyToNote:ct,getIsInitialized:ge,getState:ve,reinitialize:de,cleanup:ie,setupMediaStreamMonitoring:ye}),i.$inject_state=u=>{"isActive"in u&&t(4,r=u.isActive),"className"in u&&t(0,d=u.className),"debugMode"in u&&t(5,h=u.debugMode),"trainingPhase"in u&&t(6,c=u.trainingPhase),"disableHarmonicCorrection"in u&&t(7,f=u.disableHarmonicCorrection),"componentState"in u&&t(16,m=u.componentState),"lastError"in u&&(y=u.lastError),"isInitialized"in u&&(b=u.isInitialized),"audioContext"in u&&(l=u.audioContext),"mediaStream"in u&&(v=u.mediaStream),"sourceNode"in u&&(g=u.sourceNode),"analyser"in u&&t(17,a=u.analyser),"rawAnalyser"in u&&(p=u.rawAnalyser),"pitchDetector"in u&&(w=u.pitchDetector),"animationFrame"in u&&(_=u.animationFrame),"isDetecting"in u&&t(18,P=u.isDetecting),"analyserIds"in u&&(M=u.analyserIds),"mediaStreamListeners"in u&&(k=u.mediaStreamListeners),"currentVolume"in u&&(T=u.currentVolume),"rawVolume"in u&&t(1,I=u.rawVolume),"currentFrequency"in u&&t(2,z=u.currentFrequency),"detectedNote"in u&&t(3,B=u.detectedNote),"pitchClarity"in u&&(K=u.pitchClarity),"frequencyHistory"in u&&($=u.frequencyHistory),"volumeHistory"in u&&(L=u.volumeHistory),"stableFrequency"in u&&(te=u.stableFrequency),"stableVolume"in u&&(O=u.stableVolume),"debugInterval"in u&&t(19,G=u.debugInterval)},e&&"$$inject"in e&&i.$inject_state(e.$$inject),i.$$.update=()=>{i.$$.dirty[0]&524320&&(h&&!G?(console.log("🔍 [PitchDetector] Debug mode enabled - starting status monitoring"),t(19,G=setInterval(ce,3e3)),ce()):!h&&G&&(console.log("🔍 [PitchDetector] Debug mode disabled - stopping status monitoring"),clearInterval(G),t(19,G=null))),i.$$.dirty[0]&458768&&(r&&m==="ready"&&a&&!P?ue():!r&&P&&ne())},[d,I,z,B,r,h,c,f,me,le,ue,ne,ge,ve,de,ie,m,a,P,G]}class Gt extends Qe{constructor(e){super(e),Ke(this,e,zt,Le,Je,{isActive:4,className:0,debugMode:5,trainingPhase:6,disableHarmonicCorrection:7,resetDisplayState:8,initialize:9,startDetection:10,stopDetection:11,getIsInitialized:12,getState:13,reinitialize:14,cleanup:15},null,[-1,-1]),oe("SvelteRegisterComponent",{component:this,tagName:"PitchDetector_1",options:e,id:Le.name})}get isActive(){throw new R("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set isActive(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new R("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get debugMode(){throw new R("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set debugMode(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get trainingPhase(){throw new R("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set trainingPhase(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get disableHarmonicCorrection(){throw new R("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set disableHarmonicCorrection(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get resetDisplayState(){return this.$$.ctx[8]}set resetDisplayState(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get initialize(){return this.$$.ctx[9]}set initialize(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get startDetection(){return this.$$.ctx[10]}set startDetection(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get stopDetection(){return this.$$.ctx[11]}set stopDetection(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get getIsInitialized(){return this.$$.ctx[12]}set getIsInitialized(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get getState(){return this.$$.ctx[13]}set getState(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get reinitialize(){return this.$$.ctx[14]}set reinitialize(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get cleanup(){return this.$$.ctx[15]}set cleanup(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}const V="src/lib/components/PitchDetectionDisplay.svelte";function dt(i){let e,t,s=(i[0]>0?Math.round(i[0]):"---")+"",n,o,r,d="Hz",h,c,f="|",m,y,b,l,v,g=i[9]&&i[6]>0&&Ge(i);const a={c:function(){e=x("div"),t=x("span"),n=Y(s),o=Q(),r=x("span"),r.textContent=d,h=Q(),c=x("span"),c.textContent=f,m=Q(),y=x("span"),b=Y(i[1]),l=Q(),g&&g.c(),v=at(),this.h()},l:function(w){e=N(w,"DIV",{class:!0});var _=E(e);t=N(_,"SPAN",{class:!0});var P=E(t);n=X(P,s),P.forEach(A),o=U(_),r=N(_,"SPAN",{class:!0,"data-svelte-h":!0}),Se(r)!=="svelte-5uyilv"&&(r.textContent=d),h=U(_),c=N(_,"SPAN",{class:!0,"data-svelte-h":!0}),Se(c)!=="svelte-1dytxz4"&&(c.textContent=f),m=U(_),y=N(_,"SPAN",{class:!0});var M=E(y);b=X(M,i[1]),M.forEach(A),_.forEach(A),l=U(w),g&&g.l(w),v=at(),this.h()},h:function(){S(t,"class","detected-frequency svelte-apkxqk"),F(t,V,53,14,1559),S(r,"class","hz-suffix svelte-apkxqk"),F(r,V,54,14,1661),S(c,"class","divider svelte-apkxqk"),F(c,V,55,14,1709),S(y,"class","detected-note svelte-apkxqk"),F(y,V,56,14,1754),S(e,"class","detection-values svelte-apkxqk"),F(e,V,52,12,1514)},m:function(w,_){se(w,e,_),D(e,t),D(t,n),D(e,o),D(e,r),D(e,h),D(e,c),D(e,m),D(e,y),D(y,b),se(w,l,_),g&&g.m(w,_),se(w,v,_)},p:function(w,_){_&1&&s!==(s=(w[0]>0?Math.round(w[0]):"---")+"")&&ae(n,s),_&2&&ae(b,w[1]),w[9]&&w[6]>0?g?g.p(w,_):(g=Ge(w),g.c(),g.m(v.parentNode,v)):g&&(g.d(1),g=null)},d:function(w){w&&(A(e),A(l),A(v)),g&&g.d(w)}};return oe("SvelteRegisterBlock",{block:a,id:dt.name,type:"else",source:"(52:10) {:else}",ctx:i}),a}function ft(i){let e,t;const s={c:function(){e=x("span"),t=Y(i[4]),this.h()},l:function(o){e=N(o,"SPAN",{class:!0});var r=E(e);t=X(r,i[4]),r.forEach(A),this.h()},h:function(){S(e,"class","muted-message svelte-apkxqk"),F(e,V,50,12,1435)},m:function(o,r){se(o,e,r),D(e,t)},p:function(o,r){r&16&&ae(t,o[4])},d:function(o){o&&A(e)}};return oe("SvelteRegisterBlock",{block:s,id:ft.name,type:"if",source:"(50:10) {#if isMuted}",ctx:i}),s}function Ge(i){let e,t,s,n="目標:",o,r,d=Math.round(i[6])+"",h,c,f,m,y,b,l,v,g=i[0]>0&&je(i);const a={c:function(){e=x("div"),t=x("div"),s=x("span"),s.textContent=n,o=Q(),r=x("span"),h=Y(d),c=Y("Hz"),f=Q(),m=x("span"),y=Y("("),b=Y(i[7]),l=Y(")"),v=Q(),g&&g.c(),this.h()},l:function(w){e=N(w,"DIV",{class:!0});var _=E(e);t=N(_,"DIV",{class:!0});var P=E(t);s=N(P,"SPAN",{class:!0,"data-svelte-h":!0}),Se(s)!=="svelte-it05ma"&&(s.textContent=n),o=U(P),r=N(P,"SPAN",{class:!0});var M=E(r);h=X(M,d),c=X(M,"Hz"),M.forEach(A),f=U(P),m=N(P,"SPAN",{class:!0});var k=E(m);y=X(k,"("),b=X(k,i[7]),l=X(k,")"),k.forEach(A),P.forEach(A),v=U(_),g&&g.l(_),_.forEach(A),this.h()},h:function(){S(s,"class","target-label svelte-apkxqk"),F(s,V,62,18,1987),S(r,"class","target-frequency svelte-apkxqk"),F(r,V,63,18,2043),S(m,"class","target-note svelte-apkxqk"),F(m,V,64,18,2131),S(t,"class","target-info svelte-apkxqk"),F(t,V,61,16,1943),S(e,"class","guidance-section svelte-apkxqk"),F(e,V,60,14,1896)},m:function(w,_){se(w,e,_),D(e,t),D(t,s),D(t,o),D(t,r),D(r,h),D(r,c),D(t,f),D(t,m),D(m,y),D(m,b),D(m,l),D(e,v),g&&g.m(e,null)},p:function(w,_){_&64&&d!==(d=Math.round(w[6])+"")&&ae(h,d),_&128&&ae(b,w[7]),w[0]>0?g?g.p(w,_):(g=je(w),g.c(),g.m(e,null)):g&&(g.d(1),g=null)},d:function(w){w&&A(e),g&&g.d()}};return oe("SvelteRegisterBlock",{block:a,id:Ge.name,type:"if",source:"(60:12) {#if showGuidance && targetFrequency > 0}",ctx:i}),a}function je(i){let e,t,s=i[8]>0?"+":"",n,o=Math.round(i[8])+"",r,d,h,c,f=Ue(i[10],i[8])+"",m,y;const b={c:function(){e=x("div"),t=x("span"),n=Y(s),r=Y(o),d=Y("¢"),h=Q(),c=x("span"),m=Y(f),this.h()},l:function(v){e=N(v,"DIV",{class:!0});var g=E(e);t=N(g,"SPAN",{class:!0});var a=E(t);n=X(a,s),r=X(a,o),d=X(a,"¢"),a.forEach(A),h=U(g),c=N(g,"SPAN",{class:!0});var p=E(c);m=X(p,f),p.forEach(A),g.forEach(A),this.h()},h:function(){S(t,"class","cent-diff svelte-apkxqk"),F(t,V,68,20,2333),S(c,"class","accuracy-message"),F(c,V,69,20,2433),S(e,"class",y="accuracy-feedback accuracy-"+i[10]+" svelte-apkxqk"),F(e,V,67,18,2256)},m:function(v,g){se(v,e,g),D(e,t),D(t,n),D(t,r),D(t,d),D(e,h),D(e,c),D(c,m)},p:function(v,g){g&256&&s!==(s=v[8]>0?"+":"")&&ae(n,s),g&256&&o!==(o=Math.round(v[8])+"")&&ae(r,o),g&1280&&f!==(f=Ue(v[10],v[8])+"")&&ae(m,f),g&1024&&y!==(y="accuracy-feedback accuracy-"+v[10]+" svelte-apkxqk")&&S(e,"class",y)},d:function(v){v&&A(e)}};return oe("SvelteRegisterBlock",{block:b,id:je.name,type:"if",source:"(67:16) {#if frequency > 0}",ctx:i}),b}function mt(i){let e,t,s="🎙️ リアルタイム音程検出",n,o,r,d,h,c,f,m;function y(g,a){return g[3]?ft:dt}let b=y(i),l=b(i);f=new ze({props:{volume:!i[3]&&i[0]>0?i[2]:0,className:"volume-bar"},$$inline:!0});const v={c:function(){e=x("div"),t=x("h3"),t.textContent=s,n=Q(),o=x("div"),r=x("div"),d=x("div"),h=x("div"),l.c(),c=Q(),tt(f.$$.fragment),this.h()},l:function(a){e=N(a,"DIV",{class:!0});var p=E(e);t=N(p,"H3",{class:!0,"data-svelte-h":!0}),Se(t)!=="svelte-1bj87i9"&&(t.textContent=s),p.forEach(A),n=U(a),o=N(a,"DIV",{class:!0});var w=E(o);r=N(w,"DIV",{class:!0});var _=E(r);d=N(_,"DIV",{class:!0});var P=E(d);h=N(P,"DIV",{class:!0});var M=E(h);l.l(M),M.forEach(A),c=U(P),et(f.$$.fragment,P),P.forEach(A),_.forEach(A),w.forEach(A),this.h()},h:function(){S(t,"class","section-title svelte-apkxqk"),F(t,V,43,4,1207),S(e,"class","card-header svelte-apkxqk"),F(e,V,42,2,1177),S(h,"class","detection-card svelte-apkxqk"),F(h,V,48,8,1370),S(d,"class","detection-display svelte-apkxqk"),F(d,V,47,6,1330),S(r,"class","pitch-detector svelte-apkxqk"),F(r,V,46,4,1295),S(o,"class","card-content svelte-apkxqk"),F(o,V,45,2,1264)},m:function(a,p){se(a,e,p),D(e,t),se(a,n,p),se(a,o,p),D(o,r),D(r,d),D(d,h),l.m(h,null),D(d,c),$e(f,d,null),m=!0},p:function(a,p){b===(b=y(a))&&l?l.p(a,p):(l.d(1),l=b(a),l&&(l.c(),l.m(h,null)));const w={};p&13&&(w.volume=!a[3]&&a[0]>0?a[2]:0),f.$set(w)},i:function(a){m||(Oe(f.$$.fragment,a),m=!0)},o:function(a){Ze(f.$$.fragment,a),m=!1},d:function(a){a&&(A(e),A(n),A(o)),l.d(),Ye(f)}};return oe("SvelteRegisterBlock",{block:v,id:mt.name,type:"slot",source:'(42:0) <Card class=\\"main-card {className}\\">',ctx:i}),v}function We(i){let e,t;e=new ut({props:{class:"main-card "+i[5],$$slots:{default:[mt]},$$scope:{ctx:i}},$$inline:!0});const s={c:function(){tt(e.$$.fragment)},l:function(o){et(e.$$.fragment,o)},m:function(o,r){$e(e,o,r),t=!0},p:function(o,[r]){const d={};r&32&&(d.class="main-card "+o[5]),r&4063&&(d.$$scope={dirty:r,ctx:o}),e.$set(d)},i:function(o){t||(Oe(e.$$.fragment,o),t=!0)},o:function(o){Ze(e.$$.fragment,o),t=!1},d:function(o){Ye(e,o)}};return oe("SvelteRegisterBlock",{block:s,id:We.name,type:"component",source:"",ctx:i}),s}function lt(i){const e=Math.abs(i);return e<=30?"excellent":e<=60?"good":e<=120?"okay":e<=200?"poor":"very-poor"}function Ue(i,e){return i==="excellent"?"🎯 完璧！":i==="good"?"✅ とても良い":i==="okay"?"🔶 もう少し":i==="poor"?e>0?"📈 もっと高く":"📉 もっと低く":e>0?"⬆️ かなり高く":"⬇️ かなり低く"}function qt(i,e,t){let s,{$$slots:n={},$$scope:o}=e;Xe("PitchDetectionDisplay",n,[]);let{frequency:r=0}=e,{note:d="ーー"}=e,{volume:h=0}=e,{isMuted:c=!1}=e,{muteMessage:f="待機中..."}=e,{className:m=""}=e,{targetFrequency:y=0}=e,{targetNote:b=""}=e,{centDiff:l=0}=e,{showGuidance:v=!1}=e;const g=["frequency","note","volume","isMuted","muteMessage","className","targetFrequency","targetNote","centDiff","showGuidance"];return Object.keys(e).forEach(a=>{!~g.indexOf(a)&&a.slice(0,2)!=="$$"&&a!=="slot"&&console.warn(`<PitchDetectionDisplay> was created with unknown prop '${a}'`)}),i.$$set=a=>{"frequency"in a&&t(0,r=a.frequency),"note"in a&&t(1,d=a.note),"volume"in a&&t(2,h=a.volume),"isMuted"in a&&t(3,c=a.isMuted),"muteMessage"in a&&t(4,f=a.muteMessage),"className"in a&&t(5,m=a.className),"targetFrequency"in a&&t(6,y=a.targetFrequency),"targetNote"in a&&t(7,b=a.targetNote),"centDiff"in a&&t(8,l=a.centDiff),"showGuidance"in a&&t(9,v=a.showGuidance)},i.$capture_state=()=>({Card:ut,VolumeBar:ze,frequency:r,note:d,volume:h,isMuted:c,muteMessage:f,className:m,targetFrequency:y,targetNote:b,centDiff:l,showGuidance:v,getAccuracyLevel:lt,getAccuracyMessage:Ue,accuracyLevel:s}),i.$inject_state=a=>{"frequency"in a&&t(0,r=a.frequency),"note"in a&&t(1,d=a.note),"volume"in a&&t(2,h=a.volume),"isMuted"in a&&t(3,c=a.isMuted),"muteMessage"in a&&t(4,f=a.muteMessage),"className"in a&&t(5,m=a.className),"targetFrequency"in a&&t(6,y=a.targetFrequency),"targetNote"in a&&t(7,b=a.targetNote),"centDiff"in a&&t(8,l=a.centDiff),"showGuidance"in a&&t(9,v=a.showGuidance),"accuracyLevel"in a&&t(10,s=a.accuracyLevel)},e&&"$$inject"in e&&i.$inject_state(e.$$inject),i.$$.update=()=>{i.$$.dirty&256&&t(10,s=lt(l))},[r,d,h,c,f,m,y,b,l,v,s]}class jt extends Qe{constructor(e){super(e),Ke(this,e,qt,We,Je,{frequency:0,note:1,volume:2,isMuted:3,muteMessage:4,className:5,targetFrequency:6,targetNote:7,centDiff:8,showGuidance:9}),oe("SvelteRegisterComponent",{component:this,tagName:"PitchDetectionDisplay",options:e,id:We.name})}get frequency(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set frequency(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get note(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set note(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get volume(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set volume(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get isMuted(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set isMuted(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get muteMessage(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set muteMessage(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get targetFrequency(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set targetFrequency(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get targetNote(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set targetNote(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get centDiff(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set centDiff(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get showGuidance(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set showGuidance(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}export{jt as P,ze as V,Me as a,Gt as b,Pe as h,Re as l};
