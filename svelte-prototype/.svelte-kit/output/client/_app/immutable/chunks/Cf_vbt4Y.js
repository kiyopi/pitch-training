var vt=Object.defineProperty;var yt=(i,e,t)=>e in i?vt(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var K=(i,e,t)=>yt(i,typeof e!="symbol"?e+"":e,t);import{S as Ge,i as Oe,s as Ue,d as le,n as tt,a as We,F as He,b as C,I as B,z as P,f as we,g as A,h as F,j as N,k as R,m as te,o as I,p as ne,X as wt,a2 as nt,E as st,q as Je,r as Qe,u as Ke,e as Te,w as Xe,l as xe,A as Fe,x as Ye,t as Ne,y as Ze}from"./DkMTtSlo.js";import{g as bt}from"./D0QH3NT1.js";import"./Dl4NPMRd.js";import{C as it}from"./DFI0yG1U.js";function pt(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function W(i){if(this.size=i|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=i<<1;for(var e=new Array(this.size*2),t=0;t<e.length;t+=2){const u=Math.PI*t/this.size;e[t]=Math.cos(u),e[t+1]=-Math.sin(u)}this.table=e;for(var s=0,n=1;this.size>n;n<<=1)s++;this._width=s%2===0?s-1:s,this._bitrev=new Array(1<<this._width);for(var o=0;o<this._bitrev.length;o++){this._bitrev[o]=0;for(var r=0;r<this._width;r+=2){var d=this._width-r-2;this._bitrev[o]|=(o>>>r&3)<<d}}this._out=null,this._data=null,this._inv=0}var _t=W;W.prototype.fromComplexArray=function(e,t){for(var s=t||new Array(e.length>>>1),n=0;n<e.length;n+=2)s[n>>>1]=e[n];return s};W.prototype.createComplexArray=function(){const e=new Array(this._csize);for(var t=0;t<e.length;t++)e[t]=0;return e};W.prototype.toComplexArray=function(e,t){for(var s=t||this.createComplexArray(),n=0;n<s.length;n+=2)s[n]=e[n>>>1],s[n+1]=0;return s};W.prototype.completeSpectrum=function(e){for(var t=this._csize,s=t>>>1,n=2;n<s;n+=2)e[t-n]=e[n],e[t-n+1]=-e[n+1]};W.prototype.transform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._transform4(),this._out=null,this._data=null};W.prototype.realTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._realTransform4(),this._out=null,this._data=null};W.prototype.inverseTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=1,this._transform4();for(var s=0;s<e.length;s++)e[s]/=this.size;this._out=null,this._data=null};W.prototype._transform4=function(){var e=this._out,t=this._csize,s=this._width,n=1<<s,o=t/n<<1,r,d,u=this._bitrev;if(o===4)for(r=0,d=0;r<t;r+=o,d++){const v=u[d];this._singleTransform2(r,v,n)}else for(r=0,d=0;r<t;r+=o,d++){const v=u[d];this._singleTransform4(r,v,n)}var c=this._inv?-1:1,m=this.table;for(n>>=2;n>=2;n>>=2){o=t/n<<1;var g=o>>>2;for(r=0;r<t;r+=o)for(var h=r+g,w=r,l=0;w<h;w+=2,l+=n){const v=w,y=v+g,f=y+g,b=f+g,_=e[v],z=e[v+1],S=e[y],p=e[y+1],D=e[f],T=e[f+1],x=e[b],E=e[b+1],k=_,O=z,Q=m[l],q=c*m[l+1],Y=S*Q-p*q,J=S*q+p*Q,L=m[2*l],ue=c*m[2*l+1],se=D*L-T*ue,oe=D*ue+T*L,ie=m[3*l],Z=c*m[3*l+1],re=x*ie-E*Z,he=x*Z+E*ie,de=k+se,ae=O+oe,$=k-se,me=O-oe,ge=Y+re,a=J+he,M=c*(Y-re),V=c*(J-he),G=de+ge,j=ae+a,fe=de-ge,Me=ae-a,be=$+V,Ae=me-M,De=$-V,ee=me+M;e[v]=G,e[v+1]=j,e[y]=be,e[y+1]=Ae,e[f]=fe,e[f+1]=Me,e[b]=De,e[b+1]=ee}}};W.prototype._singleTransform2=function(e,t,s){const n=this._out,o=this._data,r=o[t],d=o[t+1],u=o[t+s],c=o[t+s+1],m=r+u,g=d+c,h=r-u,w=d-c;n[e]=m,n[e+1]=g,n[e+2]=h,n[e+3]=w};W.prototype._singleTransform4=function(e,t,s){const n=this._out,o=this._data,r=this._inv?-1:1,d=s*2,u=s*3,c=o[t],m=o[t+1],g=o[t+s],h=o[t+s+1],w=o[t+d],l=o[t+d+1],v=o[t+u],y=o[t+u+1],f=c+w,b=m+l,_=c-w,z=m-l,S=g+v,p=h+y,D=r*(g-v),T=r*(h-y),x=f+S,E=b+p,k=_+T,O=z-D,Q=f-S,q=b-p,Y=_-T,J=z+D;n[e]=x,n[e+1]=E,n[e+2]=k,n[e+3]=O,n[e+4]=Q,n[e+5]=q,n[e+6]=Y,n[e+7]=J};W.prototype._realTransform4=function(){var e=this._out,t=this._csize,s=this._width,n=1<<s,o=t/n<<1,r,d,u=this._bitrev;if(o===4)for(r=0,d=0;r<t;r+=o,d++){const ke=u[d];this._singleRealTransform2(r,ke>>>1,n>>>1)}else for(r=0,d=0;r<t;r+=o,d++){const ke=u[d];this._singleRealTransform4(r,ke>>>1,n>>>1)}var c=this._inv?-1:1,m=this.table;for(n>>=2;n>=2;n>>=2){o=t/n<<1;var g=o>>>1,h=g>>>1,w=h>>>1;for(r=0;r<t;r+=o)for(var l=0,v=0;l<=w;l+=2,v+=n){var y=r+l,f=y+h,b=f+h,_=b+h,z=e[y],S=e[y+1],p=e[f],D=e[f+1],T=e[b],x=e[b+1],E=e[_],k=e[_+1],O=z,Q=S,q=m[v],Y=c*m[v+1],J=p*q-D*Y,L=p*Y+D*q,ue=m[2*v],se=c*m[2*v+1],oe=T*ue-x*se,ie=T*se+x*ue,Z=m[3*v],re=c*m[3*v+1],he=E*Z-k*re,de=E*re+k*Z,ae=O+oe,$=Q+ie,me=O-oe,ge=Q-ie,a=J+he,M=L+de,V=c*(J-he),G=c*(L-de),j=ae+a,fe=$+M,Me=me+G,be=ge-V;if(e[y]=j,e[y+1]=fe,e[f]=Me,e[f+1]=be,l===0){var Ae=ae-a,De=$-M;e[b]=Ae,e[b+1]=De;continue}if(l!==w){var ee=me,Ie=-ge,Be=ae,Ee=-$,U=-c*G,Ce=-c*V,ut=-c*M,ht=-c*a,dt=ee+U,mt=Ie+Ce,ft=Be+ht,gt=Ee-ut,$e=r+h-l,et=r+g-l;e[$e]=dt,e[$e+1]=mt,e[et]=ft,e[et+1]=gt}}}};W.prototype._singleRealTransform2=function(e,t,s){const n=this._out,o=this._data,r=o[t],d=o[t+s],u=r+d,c=r-d;n[e]=u,n[e+1]=0,n[e+2]=c,n[e+3]=0};W.prototype._singleRealTransform4=function(e,t,s){const n=this._out,o=this._data,r=this._inv?-1:1,d=s*2,u=s*3,c=o[t],m=o[t+s],g=o[t+d],h=o[t+u],w=c+g,l=c-g,v=m+h,y=r*(m-h),f=w+v,b=l,_=-y,z=w-v,S=l,p=y;n[e]=f,n[e+1]=0,n[e+2]=b,n[e+3]=_,n[e+4]=z,n[e+5]=0,n[e+6]=S,n[e+7]=p};const St=pt(_t);class Pe{constructor(e,t){K(this,"_inputLength");K(this,"_fft");K(this,"_bufferSupplier");K(this,"_paddedInputBuffer");K(this,"_transformBuffer");K(this,"_inverseBuffer");if(e<1)throw new Error("Input length must be at least one");this._inputLength=e,this._fft=new St(Dt(2*e)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(e){return new Pe(e,t=>new Float32Array(t))}static forFloat64Array(e){return new Pe(e,t=>new Float64Array(t))}static forNumberArray(e){return new Pe(e,t=>Array(t))}get inputLength(){return this._inputLength}autocorrelate(e,t=this._bufferSupplier(e.length)){if(e.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${e.length}`);for(let n=0;n<e.length;n++)this._paddedInputBuffer[n]=e[n];for(let n=e.length;n<this._paddedInputBuffer.length;n++)this._paddedInputBuffer[n]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const s=this._transformBuffer;for(let n=0;n<s.length;n+=2)s[n]=s[n]*s[n]+s[n+1]*s[n+1],s[n+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let n=0;n<e.length;n++)t[n]=this._inverseBuffer[2*n];return t}}function Mt(i){const e=[];let t=!1,s=-1/0,n=-1;for(let o=1;o<i.length-1;o++)i[o-1]<=0&&i[o]>0?(t=!0,n=o,s=i[o]):i[o-1]>0&&i[o]<=0?(t=!1,n!==-1&&e.push(n)):t&&i[o]>s&&(s=i[o],n=o);return e}function At(i,e){const[t,s,n]=[i-1,i,i+1],[o,r,d]=[e[t],e[s],e[n]],u=o/2-r+d/2,c=-(o/2)*(s+n)+r*(t+n)-d/2*(t+s),m=o*s*n/2-r*t*n+d*t*s/2,g=-c/(2*u),h=u*g*g+c*g+m;return[g,h]}class Se{constructor(e,t){K(this,"_autocorrelator");K(this,"_nsdfBuffer");K(this,"_clarityThreshold",.9);K(this,"_minVolumeAbsolute",0);K(this,"_maxInputAmplitude",1);this._autocorrelator=new Pe(e,t),this._nsdfBuffer=t(e)}static forFloat32Array(e){return new Se(e,t=>new Float32Array(t))}static forFloat64Array(e){return new Se(e,t=>new Float64Array(t))}static forNumberArray(e){return new Se(e,t=>Array(t))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(e){if(!Number.isFinite(e)||e<=0||e>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=e}set minVolumeAbsolute(e){if(!Number.isFinite(e)||e<0||e>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=e}set minVolumeDecibels(e){if(!Number.isFinite(e)||e>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(e/10)}set maxInputAmplitude(e){if(!Number.isFinite(e)||e<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=e}findPitch(e,t){if(this._belowMinimumVolume(e))return[0,0];this._nsdf(e);const s=Mt(this._nsdfBuffer);if(s.length===0)return[0,0];const n=Math.max(...s.map(u=>this._nsdfBuffer[u])),o=s.find(u=>this._nsdfBuffer[u]>=this._clarityThreshold*n),[r,d]=At(o,this._nsdfBuffer);return[t/r,Math.min(d,1)]}_belowMinimumVolume(e){if(this._minVolumeAbsolute===0)return!1;let t=0;for(let s=0;s<e.length;s++)t+=e[s]**2;return Math.sqrt(t/e.length)<this._minVolumeAbsolute}_nsdf(e){this._autocorrelator.autocorrelate(e,this._nsdfBuffer);let t=2*this._nsdfBuffer[0],s;for(s=0;s<this._nsdfBuffer.length&&t>0;s++)this._nsdfBuffer[s]=2*this._nsdfBuffer[s]/t,t-=e[s]**2+e[e.length-s-1]**2;for(;s<this._nsdfBuffer.length;s++)this._nsdfBuffer[s]=0}}function Dt(i){return i--,i|=i>>1,i|=i>>2,i|=i>>4,i|=i>>8,i|=i>>16,i++,i}const ze="src/lib/components/VolumeBar.svelte";function Re(i){let e,t,s,n,o,r;const d={c:function(){e=I("div"),t=I("div"),s=I("div"),n=ne(),o=I("div"),this.h()},l:function(c){e=N(c,"DIV",{class:!0});var m=R(e);t=N(m,"DIV",{class:!0,style:!0});var g=R(t);s=N(g,"DIV",{class:!0,style:!0}),R(s).forEach(C),g.forEach(C),n=te(m),o=N(m,"DIV",{class:!0,style:!0}),R(o).forEach(C),m.forEach(C),this.h()},h:function(){P(s,"class","volume-bar-fill"),B(s,"position","absolute"),B(s,"top","0"),B(s,"left","0"),B(s,"height","100%"),F(s,ze,51,4,1464),P(t,"class","volume-bar-bg"),B(t,"height",i[1]),B(t,"border-radius","9999px"),B(t,"background-color","#e2e8f0"),B(t,"position","relative"),B(t,"overflow","hidden"),F(t,ze,50,2,1318),P(o,"class","threshold-indicator svelte-13z7ppf"),B(o,"position","absolute"),B(o,"top","0"),B(o,"left",i[0]+"%"),B(o,"width","2px"),B(o,"height",i[1]),B(o,"background-color","#64748b"),B(o,"border-radius","1px"),F(o,ze,59,2,1643),P(e,"class",r="volume-bar-container "+i[2]+" svelte-13z7ppf"),F(e,ze,49,0,1269)},m:function(c,m){we(c,e,m),A(e,t),A(t,s),i[5](s),A(e,n),A(e,o)},p:function(c,[m]){m&2&&B(t,"height",c[1]),m&1&&B(o,"left",c[0]+"%"),m&2&&B(o,"height",c[1]),m&4&&r!==(r="volume-bar-container "+c[2]+" svelte-13z7ppf")&&P(e,"class",r)},i:tt,o:tt,d:function(c){c&&C(e),i[5](null)}};return le("SvelteRegisterBlock",{block:d,id:Re.name,type:"component",source:"",ctx:i}),d}function Ct(i,e,t){let{$$slots:s={},$$scope:n}=e;We("VolumeBar",s,[]);let{volume:o=0}=e,{threshold:r=30}=e,{height:d="12px"}=e,{className:u=""}=e,c;function m(l){return l<r?`rgba(37, 99, 235, ${Math.max(.2,l/r*.8)})`:"#2563eb"}function g(l){if(c){const v=Math.max(0,Math.min(100,l)),y=m(v);t(3,c.style.width=`${v}%`,c),t(3,c.style.backgroundColor=y,c)}}He(()=>{c&&(t(3,c.style.width="0%",c),t(3,c.style.backgroundColor="#2563eb",c),t(3,c.style.height=d,c),t(3,c.style.borderRadius="9999px",c),t(3,c.style.transition="width 0.2s ease-out, background-color 0.2s ease-out",c))});const h=["volume","threshold","height","className"];Object.keys(e).forEach(l=>{!~h.indexOf(l)&&l.slice(0,2)!=="$$"&&l!=="slot"&&console.warn(`<VolumeBar> was created with unknown prop '${l}'`)});function w(l){wt[l?"unshift":"push"](()=>{c=l,t(3,c)})}return i.$$set=l=>{"volume"in l&&t(4,o=l.volume),"threshold"in l&&t(0,r=l.threshold),"height"in l&&t(1,d=l.height),"className"in l&&t(2,u=l.className)},i.$capture_state=()=>({onMount:He,volume:o,threshold:r,height:d,className:u,barElement:c,getVolumeColor:m,updateVolumeBar:g}),i.$inject_state=l=>{"volume"in l&&t(4,o=l.volume),"threshold"in l&&t(0,r=l.threshold),"height"in l&&t(1,d=l.height),"className"in l&&t(2,u=l.className),"barElement"in l&&t(3,c=l.barElement)},e&&"$$inject"in e&&i.$inject_state(e.$$inject),i.$$.update=()=>{i.$$.dirty&16&&g(o)},[r,d,u,c,o,w]}class Ve extends Ge{constructor(e){super(e),Oe(this,e,Ct,Re,Ue,{volume:4,threshold:0,height:1,className:2}),le("SvelteRegisterComponent",{component:this,tagName:"VolumeBar",options:e,id:Re.name})}get volume(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set volume(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get threshold(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set threshold(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get height(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set height(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}class Pt{constructor(){this.audioContext=null,this.mediaStream=null,this.sourceNode=null,this.gainNode=null,this.analysers=new Map,this.filters=new Map,this.refCount=0,this.initPromise=null,this.isInitialized=!1,this.lastError=null,this.currentSensitivity=1}async initialize(){var e,t,s;if(this.initPromise)return this.initPromise;if(this.isInitialized&&this.audioContext&&this.mediaStream){const n=this.checkMediaStreamHealth();if(n.healthy)return this.refCount++,{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode};console.warn("⚠️ [AudioManager] MediaStream不健康検出 - 強制再初期化:",n.reason),console.log("🔄 [AudioManager] 不健康なMediaStream詳細:",{mediaStreamActive:(e=this.mediaStream)==null?void 0:e.active,trackCount:(t=this.mediaStream)==null?void 0:t.getTracks().length,trackStates:(s=this.mediaStream)==null?void 0:s.getTracks().map(o=>({kind:o.kind,readyState:o.readyState,enabled:o.enabled,muted:o.muted}))}),this._cleanup(),this.isInitialized=!1,this.refCount=0,await new Promise(o=>setTimeout(o,100)),console.log("🔄 [AudioManager] クリーンアップ完了 - 再初期化開始")}this.initPromise=this._doInitialize();try{const n=await this.initPromise;return this.initPromise=null,n}catch(n){throw this.initPromise=null,n}}async _doInitialize(){try{if(console.log("🎤 [AudioManager] 初期化開始"),this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),console.log("✅ [AudioManager] AudioContext作成完了")),this.audioContext.state==="suspended"&&(await this.audioContext.resume(),console.log("✅ [AudioManager] AudioContext再開完了")),!this.mediaStream){const e=/iPhone/.test(navigator.userAgent),t=/iPad/.test(navigator.userAgent),s=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document,n=e||t||s;console.log(`🔍 [AudioManager] デバイス検出: ${t||s?"iPad":e?"iPhone":"その他"}`,navigator.userAgent),console.log(`🔍 [AudioManager] タッチサポート: ${"ontouchend"in document}`);const r={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,...n&&{googAutoGainControl:!1,googNoiseSuppression:!1,googEchoCancellation:!1,googHighpassFilter:!1,googTypingNoiseDetection:!1,googBeamforming:!1,mozAutoGainControl:!1,mozNoiseSuppression:!1},sampleRate:44100,channelCount:1,sampleSize:16,latency:.1,volume:1,deviceId:{ideal:"default"}}};console.log("🎤 [AudioManager] Safari対応設定でMediaStream取得中:",r),this.mediaStream=await navigator.mediaDevices.getUserMedia(r),console.log("✅ [AudioManager] MediaStream取得完了")}if(!this.sourceNode){this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),console.log("✅ [AudioManager] SourceNode作成完了");const e=this.mediaStream.getTracks();console.log("🎤 [AudioManager] MediaStream tracks:",e.map(t=>({kind:t.kind,label:t.label,enabled:t.enabled,readyState:t.readyState,muted:t.muted})))}return this.gainNode||(this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=this.currentSensitivity,this.sourceNode.connect(this.gainNode),console.log(`✅ [AudioManager] GainNode作成完了 (感度: ${this.currentSensitivity}x)`)),this.isInitialized=!0,this.refCount++,this.lastError=null,console.log(`🎤 [AudioManager] 初期化完了 (参照カウント: ${this.refCount})`),{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode}}catch(e){throw console.error("❌ [AudioManager] 初期化エラー:",e),this.lastError=e,this.isInitialized=!1,this._cleanup(),e}}createAnalyser(e,t={}){if(!this.isInitialized||!this.audioContext||!this.sourceNode)throw new Error("AudioManager not initialized. Call initialize() first.");this.removeAnalyser(e);const{fftSize:s=2048,smoothingTimeConstant:n=.8,minDecibels:o=-90,maxDecibels:r=-10,useFilters:d=!0}=t,u=this.audioContext.createAnalyser();u.fftSize=Math.min(s,2048),u.smoothingTimeConstant=Math.max(n,.7),u.minDecibels=Math.max(o,-80),u.maxDecibels=Math.min(r,-10);let c=this.gainNode||this.sourceNode;if(d){const m=this._createFilterChain();this.filters.set(e,m),c.connect(m.highpass),m.highpass.connect(m.lowpass),m.lowpass.connect(m.notch),m.notch.connect(u),console.log(`🔧 [AudioManager] フィルター付きAnalyser作成: ${e}`)}else c.connect(u),console.log(`🔧 [AudioManager] 生信号Analyser作成: ${e}`);return this.analysers.set(e,u),u}_createFilterChain(){const e=this.audioContext.createBiquadFilter();e.type="highpass",e.frequency.setValueAtTime(80,this.audioContext.currentTime),e.Q.setValueAtTime(.7,this.audioContext.currentTime);const t=this.audioContext.createBiquadFilter();t.type="lowpass",t.frequency.setValueAtTime(800,this.audioContext.currentTime),t.Q.setValueAtTime(.7,this.audioContext.currentTime);const s=this.audioContext.createBiquadFilter();return s.type="notch",s.frequency.setValueAtTime(60,this.audioContext.currentTime),s.Q.setValueAtTime(10,this.audioContext.currentTime),{highpass:e,lowpass:t,notch:s}}removeAnalyser(e){if(this.analysers.has(e)&&(this.analysers.get(e).disconnect(),this.analysers.delete(e),console.log(`🗑️ [AudioManager] Analyser削除: ${e}`)),this.filters.has(e)){const t=this.filters.get(e);t.highpass.disconnect(),t.lowpass.disconnect(),t.notch.disconnect(),this.filters.delete(e),console.log(`🗑️ [AudioManager] フィルターチェーン削除: ${e}`)}}setSensitivity(e){const t=Math.max(.1,Math.min(10,e));this.gainNode?(this.gainNode.gain.value=t,this.currentSensitivity=t,console.log(`🎤 [AudioManager] マイク感度更新: ${t.toFixed(1)}x`)):(this.currentSensitivity=t,console.log(`🎤 [AudioManager] マイク感度設定（初期化待ち）: ${t.toFixed(1)}x`))}getSensitivity(){return this.currentSensitivity}getPlatformSpecs(){const e=/iPhone/.test(navigator.userAgent),t=/iPad/.test(navigator.userAgent),s=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document,n=e||t||s;return{divisor:n?4:6,gainCompensation:n?1.5:1,noiseThreshold:n?12:15,smoothingFactor:.2,deviceType:t||s?"iPad":e?"iPhone":"PC",isIOS:n}}release(e=[]){e.forEach(t=>this.removeAnalyser(t)),this.refCount=Math.max(0,this.refCount-1),console.log(`📉 [AudioManager] 参照カウント減算: ${this.refCount}`),this.refCount<=0&&(console.log("🧹 [AudioManager] 全リソースクリーンアップ開始"),this._cleanup())}forceCleanup(){console.log("🚨 [AudioManager] 強制クリーンアップ実行"),this._cleanup()}_cleanup(){console.log("🧹 [AudioManager] クリーンアップ開始");for(const e of this.analysers.keys())this.removeAnalyser(e);if(this.mediaStream){const e=this.mediaStream.getTracks();console.log(`🛑 [AudioManager] MediaStream停止中: ${e.length} tracks`),e.forEach((t,s)=>{try{t.readyState!=="ended"?(t.stop(),console.log(`🛑 [AudioManager] Track ${s} 停止完了`)):console.log(`⚠️ [AudioManager] Track ${s} 既に終了済み`)}catch(n){console.warn(`⚠️ [AudioManager] Track ${s} 停止エラー:`,n)}}),this.mediaStream=null}if(this.audioContext&&this.audioContext.state!=="closed"){try{this.audioContext.close(),console.log("🛑 [AudioManager] AudioContext閉鎖完了")}catch(e){console.warn("⚠️ [AudioManager] AudioContext閉鎖エラー:",e)}this.audioContext=null}this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.isInitialized=!1,this.refCount=0,this.initPromise=null,this.currentSensitivity=1,console.log("✅ [AudioManager] クリーンアップ完了")}setBaseToneVolume(e){try{const t=this.getAudioSettings();return t.baseToneVolume=e,t.lastUpdated=Date.now(),localStorage.setItem("pitch-training-audio-settings",JSON.stringify(t)),console.log(`✅ [AudioManager] 基音音量保存: ${e}dB`),!0}catch(t){return console.error("❌ [AudioManager] 基音音量保存エラー:",t),!1}}getBaseToneVolume(){try{const e=this.getAudioSettings(),s=this.getPlatformSpecs().isIOS?0:-6,n=e.baseToneVolume!==void 0?e.baseToneVolume:s;return console.log(`📖 [AudioManager] 基音音量取得: ${n}dB (デフォルト: ${s}dB)`),n}catch(e){return console.error("❌ [AudioManager] 基音音量取得エラー:",e),this.getPlatformSpecs().isIOS?0:-6}}getAudioSettings(){try{const e=localStorage.getItem("pitch-training-audio-settings");return e?JSON.parse(e):this.createDefaultSettings()}catch(e){return console.warn("⚠️ [AudioManager] 設定読み込みエラー:",e),this.createDefaultSettings()}}createDefaultSettings(){const e=this.getPlatformSpecs(),t=e.isIOS?12:-6,s=e.isIOS?5:e.gainCompensation;return console.log("🔧 [AudioManager] iOS実機対応設定生成:",{deviceType:e.deviceType,isIOS:e.isIOS,baseToneVolume:`${t}dB`,micSensitivity:`${s}x`,従来値:{baseTone:"6dB→12dB",micSens:"3.0x→5.0x"}}),{baseToneVolume:t,micSensitivity:s,lastUpdated:Date.now(),version:"1.0.0",deviceType:e.deviceType}}validateSettings(e){return!e||typeof e!="object"?!1:["baseToneVolume","micSensitivity","lastUpdated"].every(s=>e.hasOwnProperty(s))}migrateSettings(e){const s={...this.createDefaultSettings(),...e};return s.version="1.0.0",s.lastUpdated=Date.now(),console.log("🔄 [AudioManager] 設定マイグレーション完了"),s}createSettingsBackup(){try{const e=this.getAudioSettings(),t={timestamp:new Date().toISOString(),settings:e,userAgent:navigator.userAgent,deviceType:this.getPlatformSpecs().deviceType};return localStorage.setItem("pitch-training-settings-backup",JSON.stringify(t)),console.log("💾 [AudioManager] 設定バックアップ作成完了"),!0}catch(e){return console.warn("⚠️ [AudioManager] バックアップ作成失敗:",e),!1}}recoverFromError(){try{const e=localStorage.getItem("pitch-training-settings-backup");if(e){const t=JSON.parse(e);return console.log("🔧 [AudioManager] バックアップから復旧"),t.settings}}catch(e){console.warn("⚠️ [AudioManager] バックアップ復旧失敗:",e)}return console.log("🆕 [AudioManager] デフォルト設定で復旧"),this.createDefaultSettings()}getStatus(){var e,t;return{isInitialized:this.isInitialized,refCount:this.refCount,audioContextState:((e=this.audioContext)==null?void 0:e.state)||"none",mediaStreamActive:((t=this.mediaStream)==null?void 0:t.active)||!1,activeAnalysers:Array.from(this.analysers.keys()),activeFilters:Array.from(this.filters.keys()),lastError:this.lastError}}checkMediaStreamHealth(){if(!this.mediaStream)return{healthy:!1,reason:"MediaStream not initialized"};if(!this.mediaStream.active)return{healthy:!1,reason:"MediaStream inactive"};const e=this.mediaStream.getTracks();if(e.length===0)return{healthy:!1,reason:"No tracks available"};const t=e.find(s=>s.kind==="audio");return t?t.readyState==="ended"?{healthy:!1,reason:"Audio track ended"}:t.enabled?t.muted?{healthy:!1,reason:"Audio track muted"}:this.mediaStream.active&&t.readyState!=="live"?{healthy:!1,reason:"Track state inconsistent with MediaStream"}:{healthy:!0,track:t}:{healthy:!1,reason:"Audio track disabled"}:{healthy:!1,reason:"No audio track found"}}}const pe=new Pt;typeof window<"u"&&(window.audioManager=pe);class Tt{constructor(e={}){this.vocalRangeMin=e.vocalRangeMin||130.81,this.vocalRangeMax=e.vocalRangeMax||1046.5,this.stabilityThreshold=e.stabilityThreshold||.3,this.evaluationWeights={vocalRange:e.vocalRangeWeight||.4,continuity:e.continuityWeight||.4,musical:e.musicalWeight||.2},this.fundamentalCandidates=e.fundamentalCandidates||[1,.5,.333,2],this.harmonicHistory=[],this.previousFrequency=0,this.maxHistoryLength=5,this.debugMode=!1,this.volumeThreshold=e.volumeThreshold||.02,this.currentContext={}}correctHarmonic(e,t=1,s=!1){if(!e||e<=0)return 0;const n=t>=this.volumeThreshold,r=this.fundamentalCandidates.map(c=>({frequency:e*c,ratio:c})).map(c=>{const m=this.evaluateFundamental(c.frequency);return{...c,...m}}),d=r.reduce((c,m)=>m.totalScore>c.totalScore?m:c),u=this.stabilizeFrequency(d.frequency,n);return(s||this.debugMode)&&this.logHarmonicCorrection(e,r,d,u,this.currentContext,t,n),n&&(this.previousFrequency=u),u}logHarmonicCorrection(e,t,s,n,o={},r=1,d=!0){console.group(`🔧 [HarmonicCorrection] ${e.toFixed(1)}Hz → ${n.toFixed(1)}Hz`),console.log(`🔊 音量: ${(r*100).toFixed(1)}% (閾値: ${(this.volumeThreshold*100).toFixed(1)}%) ${d?"✅ 有効":"❌ ノイズ除外"}`);const u=this.frequencyToNote(e),c=this.frequencyToNote(n);console.log(`📝 音程変換: ${u} → ${c}`);const m=this.getCorrectionType(s.ratio);if(console.log(`🎯 補正タイプ: ${m}`),o.baseFrequency&&o.currentScale&&o.targetFrequency){console.log("🎵 音階コンテキスト:"),console.log(`   基音: ${o.baseFrequency.toFixed(1)}Hz (${this.frequencyToNote(o.baseFrequency)})`),console.log(`   現在の音階: ${o.currentScale}`),console.log(`   目標周波数: ${o.targetFrequency.toFixed(1)}Hz (${this.frequencyToNote(o.targetFrequency)})`);const h=n-o.targetFrequency,w=1200*Math.log2(n/o.targetFrequency);console.log(`   目標との差: ${h>0?"+":""}${h.toFixed(1)}Hz (${w>0?"+":""}${w.toFixed(0)}セント)`);const l=Math.abs(w)<=50?"🎯 高精度":Math.abs(w)<=100?"✅ 良好":Math.abs(w)<=200?"⚠️ 要改善":"❌ 不正確";console.log(`   精度評価: ${l} (${Math.abs(w).toFixed(0)}セント差)`)}console.table(t.map(h=>({倍率:`${h.ratio.toFixed(3)}x`,周波数:`${h.frequency.toFixed(1)}Hz`,音名:this.frequencyToNote(h.frequency),音域:h.vocalRangeScore.toFixed(2),連続性:h.continuityScore.toFixed(2),音楽性:h.musicalScore.toFixed(2),総合:h.totalScore.toFixed(3),選択:h===s?"✅":""})));const g=Math.abs(n-s.frequency);g>.5&&console.log(`🔄 安定化: ${s.frequency.toFixed(1)}Hz → ${n.toFixed(1)}Hz (${g.toFixed(1)}Hz調整)`),console.groupEnd()}getCorrectionType(e){return Math.abs(e-1)<.01?"補正なし（基音）":Math.abs(e-.5)<.01?"2倍音補正（1オクターブ下）":Math.abs(e-.333)<.01?"3倍音補正（1オクターブ+5度下）":Math.abs(e-.25)<.01?"4倍音補正（2オクターブ下）":Math.abs(e-2)<.01?"オクターブ上補正":`カスタム補正（${e.toFixed(3)}x）`}frequencyToNote(e){if(!e||e<=0)return"---";const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=Math.round(12*Math.log2(e/440)),o=(n+9+120)%12,r=Math.floor((n+9)/12)+4;return t[o]+r}evaluateFundamental(e){const s=e>=this.vocalRangeMin&&e<=this.vocalRangeMax?1:0,n=this.previousFrequency>0?1-Math.min(Math.abs(e-this.previousFrequency)/this.previousFrequency,1):.5,o=this.calculateMusicalScore(e),r=s*this.evaluationWeights.vocalRange+n*this.evaluationWeights.continuity+o*this.evaluationWeights.musical;return{vocalRangeScore:s,continuityScore:n,musicalScore:o,totalScore:r}}calculateMusicalScore(e){const s=Math.log2(e/261.63)*12,n=Math.round(s),o=Math.abs(s-n);return Math.max(0,1-o/.5)}stabilizeFrequency(e,t=!0){if(!e||e<=0)return 0;if(t&&this.harmonicHistory.push(e),this.harmonicHistory.length>this.maxHistoryLength&&this.harmonicHistory.shift(),this.harmonicHistory.length<2)return e;const s=[...this.harmonicHistory].sort((d,u)=>d-u),n=s[Math.floor(s.length/2)],o=n*this.stabilityThreshold;return Math.abs(e-n)>o?n+Math.sign(e-n)*o:e}resetHistory(){this.harmonicHistory=[],this.previousFrequency=0}updateConfig(e){Object.assign(this,e),console.log("⚙️ [HarmonicCorrection] 設定更新:",e)}enableDebugLogging(){this.debugMode=!0,console.log("🔍 [HarmonicCorrection] デバッグログ有効化 - 次回の補正から詳細ログを出力します"),console.log("無効化するには: harmonicCorrection.disableDebugLogging()")}disableDebugLogging(){this.debugMode=!1,console.log("🔍 [HarmonicCorrection] デバッグログ無効化")}setScaleContext(e){this.currentContext={baseFrequency:e.baseFrequency,currentScale:e.currentScale,targetFrequency:e.targetFrequency}}clearContext(){this.currentContext={}}getStatus(){return{vocalRangeMin:this.vocalRangeMin,vocalRangeMax:this.vocalRangeMax,stabilityThreshold:this.stabilityThreshold,evaluationWeights:this.evaluationWeights,historyLength:this.harmonicHistory.length,previousFrequency:this.previousFrequency,recentHistory:this.harmonicHistory.slice(-3)}}}const _e=new Tt;typeof window<"u"&&(window.harmonicCorrection=_e);const rt=(()=>{if(typeof window<"u"){const e=new URLSearchParams(window.location.search).get("debug");if(e)return e}return"info"})(),ce={error:0,warn:1,info:2,debug:3},ve=ce[rt]??ce.info,qe={error:(i,...e)=>{ve>=ce.error&&console.error(`❌ ${i}`,...e)},warn:(i,...e)=>{ve>=ce.warn&&console.warn(`⚠️ ${i}`,...e)},info:(i,...e)=>{ve>=ce.info&&console.log(`ℹ️ ${i}`,...e)},debug:(i,...e)=>{ve>=ce.debug&&console.log(`🔍 ${i}`,...e)},realtime:(()=>{let i=0;const e=1e3;return(t,...s)=>{if(ve>=ce.debug){const n=Date.now();n-i>=e&&(console.log(`📊 ${t}`,...s),i=n)}}})(),scoring:(i,...e)=>{ve>=ce.info&&console.log(`🎯 ${i}`,...e)},audio:(i,...e)=>{ve>=ce.info&&console.log(`🎤 ${i}`,...e)}};typeof import.meta<"u"&&qe.info(`Debug Level: ${rt} (Change with ?debug=level)`);const{Error:H,console:xt}=bt,ye="src/lib/components/PitchDetector.svelte";function Le(i){let e,t,s,n,o=(i[2]>0?Math.round(i[2]):"---")+"",r,d,u,c="Hz",m,g,h="|",w,l,v,y,f,b,_;f=new Ve({props:{volume:i[2]>0?i[1]:0,className:"volume-bar"},$$inline:!0});const z={c:function(){e=I("div"),t=I("div"),s=I("div"),n=I("span"),r=Ne(o),d=ne(),u=I("span"),u.textContent=c,m=ne(),g=I("span"),g.textContent=h,w=ne(),l=I("span"),v=Ne(i[3]),y=ne(),Ze(f.$$.fragment),this.h()},l:function(p){e=N(p,"DIV",{class:!0});var D=R(e);t=N(D,"DIV",{class:!0});var T=R(t);s=N(T,"DIV",{class:!0});var x=R(s);n=N(x,"SPAN",{class:!0});var E=R(n);r=xe(E,o),E.forEach(C),d=te(x),u=N(x,"SPAN",{class:!0,"data-svelte-h":!0}),Fe(u)!=="svelte-5uyilv"&&(u.textContent=c),m=te(x),g=N(x,"SPAN",{class:!0,"data-svelte-h":!0}),Fe(g)!=="svelte-1dytxz4"&&(g.textContent=h),w=te(x),l=N(x,"SPAN",{class:!0});var k=R(l);v=xe(k,i[3]),k.forEach(C),x.forEach(C),y=te(T),Ye(f.$$.fragment,T),T.forEach(C),D.forEach(C),this.h()},h:function(){P(n,"class","detected-frequency svelte-vc1bho"),F(n,ye,528,6,15447),P(u,"class","hz-suffix svelte-vc1bho"),F(u,ye,529,6,15555),P(g,"class","divider svelte-vc1bho"),F(g,ye,530,6,15595),P(l,"class","detected-note svelte-vc1bho"),F(l,ye,531,6,15632),P(s,"class","detection-card svelte-vc1bho"),F(s,ye,527,4,15412),P(t,"class","detection-display svelte-vc1bho"),F(t,ye,526,2,15376),P(e,"class",b="pitch-detector "+i[0]+" svelte-vc1bho"),F(e,ye,525,0,15333)},m:function(p,D){we(p,e,D),A(e,t),A(t,s),A(s,n),A(n,r),A(s,d),A(s,u),A(s,m),A(s,g),A(s,w),A(s,l),A(l,v),A(t,y),Xe(f,t,null),_=!0},p:function(p,D){(!_||D[0]&4)&&o!==(o=(p[2]>0?Math.round(p[2]):"---")+"")&&Te(r,o),(!_||D[0]&8)&&Te(v,p[3]);const T={};D[0]&6&&(T.volume=p[2]>0?p[1]:0),f.$set(T),(!_||D[0]&1&&b!==(b="pitch-detector "+p[0]+" svelte-vc1bho"))&&P(e,"class",b)},i:function(p){_||(Ke(f.$$.fragment,p),_=!0)},o:function(p){Qe(f.$$.fragment,p),_=!1},d:function(p){p&&C(e),Je(f)}};return le("SvelteRegisterBlock",{block:z,id:Le.name,type:"component",source:"",ctx:i}),z}function ot(i){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(i<=0)return"ーー";const s=Math.round(12*Math.log2(i/440)),n=(s+9+120)%12,o=Math.floor((s+9)/12)+4;return e[n]+o}function Ft(i,e,t){let{$$slots:s={},$$scope:n}=e;We("PitchDetector",s,[]);const o=nt();let{isActive:r=!1}=e,{className:d=""}=e,{debugMode:u=!1}=e,{trainingPhase:c=""}=e,{disableHarmonicCorrection:m=!1}=e,g="uninitialized",h=null,w=!1,l=null,v=null,y=null,f=null,b=null,_=null,z=null,S=!1,p=[],D=new Map,T=0,x=0,E=0,k="ーー",O=0,Q=[],q=[],Y=0,J=0,L=null;function ue(){T=0,t(1,x=0),t(2,E=0),t(3,k="ーー"),O=0,Y=0,J=0,Q=[],q=[],_e.resetHistory(),u&&console.log("🔄 [PitchDetector] Display state reset")}function se(){if(!u)return;const a=new Date().toLocaleTimeString(),M={timestamp:a,componentState:g,isActive:r,isDetecting:S,isInitialized:w,mediaStreamActive:v?v.active:null,mediaStreamTracks:v?v.getTracks().length:0,trackStates:v?v.getTracks().map(j=>({kind:j.kind,enabled:j.enabled,readyState:j.readyState,muted:j.muted})):[],audioContextState:l?l.state:null,hasAnalyser:!!f,currentVolume:T,currentFrequency:E};qe.realtime(`[PitchDetector] ${a}:`,M);let V=!0,G=[];v&&!v.active&&(console.warn("⚠️ [PitchDetector] MediaStream is inactive!",v),V=!1,G.push("MediaStream inactive")),l&&l.state==="suspended"&&(console.warn("⚠️ [PitchDetector] AudioContext is suspended!",l),V=!1,G.push("AudioContext suspended")),v&&v.getTracks().forEach((j,fe)=>{j.readyState==="ended"&&(console.error(`❌ [PitchDetector] Track ${fe} has ended!`,j),V=!1,G.push(`Track ${fe} ended`))}),o("microphoneHealthChange",{healthy:V,errors:G,details:M})}async function oe(){try{t(16,g="initializing"),h=null,console.log("🎙️ [PitchDetector] AudioManager経由で初期化開始");const a=await pe.initialize();l=a.audioContext,v=a.mediaStream,y=a.sourceNode,console.log("✅ [PitchDetector] AudioManager リソース取得完了");const M=`pitch-detector-filtered-${Date.now()}`;t(17,f=pe.createAnalyser(M,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!0})),p.push(M);const V=`pitch-detector-raw-${Date.now()}`;b=pe.createAnalyser(V,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!1}),p.push(V),console.log("✅ [PitchDetector] Analyser作成完了:",p),_=Se.forFloat32Array(f.fftSize),t(16,g="ready"),w=!0,o("stateChange",{state:g}),me(),console.log("✅ [PitchDetector] 初期化完了")}catch(a){throw console.error("❌ [PitchDetector] 初期化エラー:",a),t(16,g="error"),h=a,w=!1,o("error",{error:a,context:"initialization"}),a}}function ie(){if(g!=="ready"){const a=new Error(`Cannot start detection: component state is ${g}`);return o("error",{error:a,context:"start-detection"}),!1}if(!f||!_||!l){const a=new Error("Required components not available");return t(16,g="error"),o("error",{error:a,context:"start-detection"}),!1}return t(16,g="detecting"),t(18,S=!0),o("stateChange",{state:g}),re(),!0}function Z(){t(18,S=!1),z&&(cancelAnimationFrame(z),z=null),g==="detecting"&&w&&(t(16,g="ready"),o("stateChange",{state:g}))}function re(){if(!S||!f||!b||!_)return;const a=f.fftSize,M=new Float32Array(a),V=new Float32Array(b.fftSize);f.getFloatTimeDomainData(M),b.getFloatTimeDomainData(V);let G=0;for(let U=0;U<a;U++)G+=Math.abs(M[U]);const j=Math.sqrt(G/a),fe=Math.log10(j+.001)*50+100,Me=Math.max(0,Math.min(100,fe));let be=0;for(let U=0;U<V.length;U++)be+=Math.abs(V[U]);const Ae=Math.sqrt(be/V.length),De=Math.log10(Ae+.001)*50+100;t(1,x=Math.max(0,Math.min(100,De))),q.push(Me),q.length>5&&q.shift(),J=q.reduce((U,Ce)=>U+Ce,0)/q.length,T=J;const[ee,Ie]=_.findPitch(M,l.sampleRate),Be=ee>=65&&ee<=1200;if(ee&&Ie>.8&&T>30&&Be){let U=ee;if(m)u&&console.log("🔧 [PitchDetector] ハーモニック補正無効化中 - 生値使用:",ee);else{const Ce=Math.min(T/100,1);U=_e.correctHarmonic(ee,Ce)}t(2,E=Math.round(U)),t(3,k=ot(E)),O=Ie}else E===0&&_e.resetHistory(),t(2,E=0),t(3,k="ーー"),O=0;const Ee=E>0?x:0;o("pitchUpdate",{frequency:E,note:k,volume:Ee,rawVolume:Ee,clarity:O}),z=requestAnimationFrame(re)}function he(){return w&&g==="ready"}function de(){return{componentState:g,isInitialized:w,isDetecting:S,lastError:h,hasRequiredComponents:!!(f&&_&&l&&v)}}async function ae(){console.log("🔄 [PitchDetector] 再初期化開始"),$(),await new Promise(a=>setTimeout(a,100)),await oe(),console.log("✅ [PitchDetector] 再初期化完了")}function $(){console.log("🧹 [PitchDetector] クリーンアップ開始"),Z(),D.size>0&&(D.forEach((a,M)=>{M.removeEventListener("ended",a.endedHandler),M.removeEventListener("mute",a.muteHandler),M.removeEventListener("unmute",a.unmuteHandler)}),D.clear(),console.log("🔄 [PitchDetector] MediaStreamイベントリスナー削除")),p.length>0&&(pe.release(p),console.log("📤 [PitchDetector] AudioManagerにAnalyser解放通知:",p),p=[]),t(16,g="uninitialized"),w=!1,h=null,l=null,v=null,y=null,t(17,f=null),b=null,_=null,Q=[],q=[],_e.resetHistory(),console.log("✅ [PitchDetector] クリーンアップ完了")}function me(){if(!v)return;const a=v.getTracks();a.forEach(M=>{const V=()=>{console.error("🚨 [PitchDetector] MediaStreamTrack終了検出:",M.kind),t(16,g="error"),h=new Error(`MediaStreamTrack (${M.kind}) ended`),o("error",{error:h,reason:"mediastream_ended",recovery:"restart_required"}),S&&Z()},G=()=>{console.warn("⚠️ [PitchDetector] MediaStreamTrack muted:",M.kind),o("warning",{reason:"track_muted",track:M.kind})},j=()=>{console.log("✅ [PitchDetector] MediaStreamTrack unmuted:",M.kind),o("info",{reason:"track_unmuted",track:M.kind})};M.addEventListener("ended",V),M.addEventListener("mute",G),M.addEventListener("unmute",j),D.set(M,{endedHandler:V,muteHandler:G,unmuteHandler:j})}),console.log("🔍 [PitchDetector] MediaStream監視開始:",a.length+" tracks")}st(()=>{L&&(clearInterval(L),t(19,L=null)),console.log("🔄 [PitchDetector] onDestroy - AudioManagerリソースは保持")});const ge=["isActive","className","debugMode","trainingPhase","disableHarmonicCorrection"];return Object.keys(e).forEach(a=>{!~ge.indexOf(a)&&a.slice(0,2)!=="$$"&&a!=="slot"&&xt.warn(`<PitchDetector> was created with unknown prop '${a}'`)}),i.$$set=a=>{"isActive"in a&&t(4,r=a.isActive),"className"in a&&t(0,d=a.className),"debugMode"in a&&t(5,u=a.debugMode),"trainingPhase"in a&&t(6,c=a.trainingPhase),"disableHarmonicCorrection"in a&&t(7,m=a.disableHarmonicCorrection)},i.$capture_state=()=>({onMount:He,onDestroy:st,createEventDispatcher:nt,PitchDetector:Se,VolumeBar:Ve,audioManager:pe,harmonicCorrection:_e,logger:qe,dispatch:o,isActive:r,className:d,debugMode:u,trainingPhase:c,disableHarmonicCorrection:m,componentState:g,lastError:h,isInitialized:w,audioContext:l,mediaStream:v,sourceNode:y,analyser:f,rawAnalyser:b,pitchDetector:_,animationFrame:z,isDetecting:S,analyserIds:p,mediaStreamListeners:D,currentVolume:T,rawVolume:x,currentFrequency:E,detectedNote:k,pitchClarity:O,frequencyHistory:Q,volumeHistory:q,stableFrequency:Y,stableVolume:J,debugInterval:L,resetDisplayState:ue,checkMicrophoneStatus:se,initialize:oe,startDetection:ie,stopDetection:Z,detectPitch:re,frequencyToNote:ot,getIsInitialized:he,getState:de,reinitialize:ae,cleanup:$,setupMediaStreamMonitoring:me}),i.$inject_state=a=>{"isActive"in a&&t(4,r=a.isActive),"className"in a&&t(0,d=a.className),"debugMode"in a&&t(5,u=a.debugMode),"trainingPhase"in a&&t(6,c=a.trainingPhase),"disableHarmonicCorrection"in a&&t(7,m=a.disableHarmonicCorrection),"componentState"in a&&t(16,g=a.componentState),"lastError"in a&&(h=a.lastError),"isInitialized"in a&&(w=a.isInitialized),"audioContext"in a&&(l=a.audioContext),"mediaStream"in a&&(v=a.mediaStream),"sourceNode"in a&&(y=a.sourceNode),"analyser"in a&&t(17,f=a.analyser),"rawAnalyser"in a&&(b=a.rawAnalyser),"pitchDetector"in a&&(_=a.pitchDetector),"animationFrame"in a&&(z=a.animationFrame),"isDetecting"in a&&t(18,S=a.isDetecting),"analyserIds"in a&&(p=a.analyserIds),"mediaStreamListeners"in a&&(D=a.mediaStreamListeners),"currentVolume"in a&&(T=a.currentVolume),"rawVolume"in a&&t(1,x=a.rawVolume),"currentFrequency"in a&&t(2,E=a.currentFrequency),"detectedNote"in a&&t(3,k=a.detectedNote),"pitchClarity"in a&&(O=a.pitchClarity),"frequencyHistory"in a&&(Q=a.frequencyHistory),"volumeHistory"in a&&(q=a.volumeHistory),"stableFrequency"in a&&(Y=a.stableFrequency),"stableVolume"in a&&(J=a.stableVolume),"debugInterval"in a&&t(19,L=a.debugInterval)},e&&"$$inject"in e&&i.$inject_state(e.$$inject),i.$$.update=()=>{i.$$.dirty[0]&524320&&(u&&!L?(console.log("🔍 [PitchDetector] Debug mode enabled - starting status monitoring"),t(19,L=setInterval(se,3e3)),se()):!u&&L&&(console.log("🔍 [PitchDetector] Debug mode disabled - stopping status monitoring"),clearInterval(L),t(19,L=null))),i.$$.dirty[0]&458768&&(r&&g==="ready"&&f&&!S?ie():!r&&S&&Z())},[d,x,E,k,r,u,c,m,ue,oe,ie,Z,he,de,ae,$,g,f,S,L]}class kt extends Ge{constructor(e){super(e),Oe(this,e,Ft,Le,Ue,{isActive:4,className:0,debugMode:5,trainingPhase:6,disableHarmonicCorrection:7,resetDisplayState:8,initialize:9,startDetection:10,stopDetection:11,getIsInitialized:12,getState:13,reinitialize:14,cleanup:15},null,[-1,-1]),le("SvelteRegisterComponent",{component:this,tagName:"PitchDetector_1",options:e,id:Le.name})}get isActive(){throw new H("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set isActive(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new H("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get debugMode(){throw new H("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set debugMode(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get trainingPhase(){throw new H("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set trainingPhase(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get disableHarmonicCorrection(){throw new H("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set disableHarmonicCorrection(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get resetDisplayState(){return this.$$.ctx[8]}set resetDisplayState(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get initialize(){return this.$$.ctx[9]}set initialize(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get startDetection(){return this.$$.ctx[10]}set startDetection(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get stopDetection(){return this.$$.ctx[11]}set stopDetection(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get getIsInitialized(){return this.$$.ctx[12]}set getIsInitialized(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get getState(){return this.$$.ctx[13]}set getState(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get reinitialize(){return this.$$.ctx[14]}set reinitialize(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get cleanup(){return this.$$.ctx[15]}set cleanup(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}const X="src/lib/components/PitchDetectionDisplay.svelte";function at(i){let e,t,s=(i[0]>0?Math.round(i[0]):"---")+"",n,o,r,d="Hz",u,c,m="|",g,h,w;const l={c:function(){e=I("div"),t=I("span"),n=Ne(s),o=ne(),r=I("span"),r.textContent=d,u=ne(),c=I("span"),c.textContent=m,g=ne(),h=I("span"),w=Ne(i[1]),this.h()},l:function(y){e=N(y,"DIV",{class:!0});var f=R(e);t=N(f,"SPAN",{class:!0});var b=R(t);n=xe(b,s),b.forEach(C),o=te(f),r=N(f,"SPAN",{class:!0,"data-svelte-h":!0}),Fe(r)!=="svelte-5uyilv"&&(r.textContent=d),u=te(f),c=N(f,"SPAN",{class:!0,"data-svelte-h":!0}),Fe(c)!=="svelte-1dytxz4"&&(c.textContent=m),g=te(f),h=N(f,"SPAN",{class:!0});var _=R(h);w=xe(_,i[1]),_.forEach(C),f.forEach(C),this.h()},h:function(){P(t,"class","detected-frequency svelte-1datf0r"),F(t,X,25,14,712),P(r,"class","hz-suffix svelte-1datf0r"),F(r,X,26,14,814),P(c,"class","divider svelte-1datf0r"),F(c,X,27,14,862),P(h,"class","detected-note svelte-1datf0r"),F(h,X,28,14,907),P(e,"class","detection-values svelte-1datf0r"),F(e,X,24,12,667)},m:function(y,f){we(y,e,f),A(e,t),A(t,n),A(e,o),A(e,r),A(e,u),A(e,c),A(e,g),A(e,h),A(h,w)},p:function(y,f){f&1&&s!==(s=(y[0]>0?Math.round(y[0]):"---")+"")&&Te(n,s),f&2&&Te(w,y[1])},d:function(y){y&&C(e)}};return le("SvelteRegisterBlock",{block:l,id:at.name,type:"else",source:"(24:10) {:else}",ctx:i}),l}function ct(i){let e,t;const s={c:function(){e=I("span"),t=Ne(i[4]),this.h()},l:function(o){e=N(o,"SPAN",{class:!0});var r=R(e);t=xe(r,i[4]),r.forEach(C),this.h()},h:function(){P(e,"class","muted-message svelte-1datf0r"),F(e,X,22,12,588)},m:function(o,r){we(o,e,r),A(e,t)},p:function(o,r){r&16&&Te(t,o[4])},d:function(o){o&&C(e)}};return le("SvelteRegisterBlock",{block:s,id:ct.name,type:"if",source:"(22:10) {#if isMuted}",ctx:i}),s}function lt(i){let e,t,s="🎙️ リアルタイム音程検出",n,o,r,d,u,c,m,g;function h(y,f){return y[3]?ct:at}let w=h(i),l=w(i);m=new Ve({props:{volume:!i[3]&&i[0]>0?i[2]:0,className:"volume-bar"},$$inline:!0});const v={c:function(){e=I("div"),t=I("h3"),t.textContent=s,n=ne(),o=I("div"),r=I("div"),d=I("div"),u=I("div"),l.c(),c=ne(),Ze(m.$$.fragment),this.h()},l:function(f){e=N(f,"DIV",{class:!0});var b=R(e);t=N(b,"H3",{class:!0,"data-svelte-h":!0}),Fe(t)!=="svelte-1bj87i9"&&(t.textContent=s),b.forEach(C),n=te(f),o=N(f,"DIV",{class:!0});var _=R(o);r=N(_,"DIV",{class:!0});var z=R(r);d=N(z,"DIV",{class:!0});var S=R(d);u=N(S,"DIV",{class:!0});var p=R(u);l.l(p),p.forEach(C),c=te(S),Ye(m.$$.fragment,S),S.forEach(C),z.forEach(C),_.forEach(C),this.h()},h:function(){P(t,"class","section-title svelte-1datf0r"),F(t,X,15,4,360),P(e,"class","card-header svelte-1datf0r"),F(e,X,14,2,330),P(u,"class","detection-card svelte-1datf0r"),F(u,X,20,8,523),P(d,"class","detection-display svelte-1datf0r"),F(d,X,19,6,483),P(r,"class","pitch-detector svelte-1datf0r"),F(r,X,18,4,448),P(o,"class","card-content svelte-1datf0r"),F(o,X,17,2,417)},m:function(f,b){we(f,e,b),A(e,t),we(f,n,b),we(f,o,b),A(o,r),A(r,d),A(d,u),l.m(u,null),A(d,c),Xe(m,d,null),g=!0},p:function(f,b){w===(w=h(f))&&l?l.p(f,b):(l.d(1),l=w(f),l&&(l.c(),l.m(u,null)));const _={};b&13&&(_.volume=!f[3]&&f[0]>0?f[2]:0),m.$set(_)},i:function(f){g||(Ke(m.$$.fragment,f),g=!0)},o:function(f){Qe(m.$$.fragment,f),g=!1},d:function(f){f&&(C(e),C(n),C(o)),l.d(),Je(m)}};return le("SvelteRegisterBlock",{block:v,id:lt.name,type:"slot",source:'(14:0) <Card class=\\"main-card {className}\\">',ctx:i}),v}function je(i){let e,t;e=new it({props:{class:"main-card "+i[5],$$slots:{default:[lt]},$$scope:{ctx:i}},$$inline:!0});const s={c:function(){Ze(e.$$.fragment)},l:function(o){Ye(e.$$.fragment,o)},m:function(o,r){Xe(e,o,r),t=!0},p:function(o,[r]){const d={};r&32&&(d.class="main-card "+o[5]),r&95&&(d.$$scope={dirty:r,ctx:o}),e.$set(d)},i:function(o){t||(Ke(e.$$.fragment,o),t=!0)},o:function(o){Qe(e.$$.fragment,o),t=!1},d:function(o){Je(e,o)}};return le("SvelteRegisterBlock",{block:s,id:je.name,type:"component",source:"",ctx:i}),s}function Nt(i,e,t){let{$$slots:s={},$$scope:n}=e;We("PitchDetectionDisplay",s,[]);let{frequency:o=0}=e,{note:r="ーー"}=e,{volume:d=0}=e,{isMuted:u=!1}=e,{muteMessage:c="待機中..."}=e,{className:m=""}=e;const g=["frequency","note","volume","isMuted","muteMessage","className"];return Object.keys(e).forEach(h=>{!~g.indexOf(h)&&h.slice(0,2)!=="$$"&&h!=="slot"&&console.warn(`<PitchDetectionDisplay> was created with unknown prop '${h}'`)}),i.$$set=h=>{"frequency"in h&&t(0,o=h.frequency),"note"in h&&t(1,r=h.note),"volume"in h&&t(2,d=h.volume),"isMuted"in h&&t(3,u=h.isMuted),"muteMessage"in h&&t(4,c=h.muteMessage),"className"in h&&t(5,m=h.className)},i.$capture_state=()=>({Card:it,VolumeBar:Ve,frequency:o,note:r,volume:d,isMuted:u,muteMessage:c,className:m}),i.$inject_state=h=>{"frequency"in h&&t(0,o=h.frequency),"note"in h&&t(1,r=h.note),"volume"in h&&t(2,d=h.volume),"isMuted"in h&&t(3,u=h.isMuted),"muteMessage"in h&&t(4,c=h.muteMessage),"className"in h&&t(5,m=h.className)},e&&"$$inject"in e&&i.$inject_state(e.$$inject),[o,r,d,u,c,m]}class Ht extends Ge{constructor(e){super(e),Oe(this,e,Nt,je,Ue,{frequency:0,note:1,volume:2,isMuted:3,muteMessage:4,className:5}),le("SvelteRegisterComponent",{component:this,tagName:"PitchDetectionDisplay",options:e,id:je.name})}get frequency(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set frequency(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get note(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set note(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get volume(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set volume(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get isMuted(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set isMuted(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get muteMessage(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set muteMessage(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}export{Ht as P,Ve as V,pe as a,kt as b,_e as h,qe as l};
