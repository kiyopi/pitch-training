var vt=Object.defineProperty;var yt=(r,e,t)=>e in r?vt(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var X=(r,e,t)=>yt(r,typeof e!="symbol"?e+"":e,t);import{S as Ye,i as Ze,s as Oe,d as de,n as ct,a as $e,D as Ue,b as x,G as B,z as F,f as _e,g as D,h as E,j as z,k as R,m as ne,o as N,p as se,F as wt,a0 as lt,K as ut,q as et,r as tt,u as nt,e as Te,w as st,l as Ee,A as ze,x as ot,t as Ne,y as rt}from"./BJ74v9sL.js";import{g as bt}from"./D0QH3NT1.js";import"./DEjcJ3UU.js";import{C as ht}from"./DUi99-yi.js";function _t(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function U(r){if(this.size=r|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=r<<1;for(var e=new Array(this.size*2),t=0;t<e.length;t+=2){const h=Math.PI*t/this.size;e[t]=Math.cos(h),e[t+1]=-Math.sin(h)}this.table=e;for(var o=0,n=1;this.size>n;n<<=1)o++;this._width=o%2===0?o-1:o,this._bitrev=new Array(1<<this._width);for(var s=0;s<this._bitrev.length;s++){this._bitrev[s]=0;for(var i=0;i<this._width;i+=2){var d=this._width-i-2;this._bitrev[s]|=(s>>>i&3)<<d}}this._out=null,this._data=null,this._inv=0}var pt=U;U.prototype.fromComplexArray=function(e,t){for(var o=t||new Array(e.length>>>1),n=0;n<e.length;n+=2)o[n>>>1]=e[n];return o};U.prototype.createComplexArray=function(){const e=new Array(this._csize);for(var t=0;t<e.length;t++)e[t]=0;return e};U.prototype.toComplexArray=function(e,t){for(var o=t||this.createComplexArray(),n=0;n<o.length;n+=2)o[n]=e[n>>>1],o[n+1]=0;return o};U.prototype.completeSpectrum=function(e){for(var t=this._csize,o=t>>>1,n=2;n<o;n+=2)e[t-n]=e[n],e[t-n+1]=-e[n+1]};U.prototype.transform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._transform4(),this._out=null,this._data=null};U.prototype.realTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._realTransform4(),this._out=null,this._data=null};U.prototype.inverseTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=1,this._transform4();for(var o=0;o<e.length;o++)e[o]/=this.size;this._out=null,this._data=null};U.prototype._transform4=function(){var e=this._out,t=this._csize,o=this._width,n=1<<o,s=t/n<<1,i,d,h=this._bitrev;if(s===4)for(i=0,d=0;i<t;i+=s,d++){const y=h[d];this._singleTransform2(i,y,n)}else for(i=0,d=0;i<t;i+=s,d++){const y=h[d];this._singleTransform4(i,y,n)}var c=this._inv?-1:1,u=this.table;for(n>>=2;n>=2;n>>=2){s=t/n<<1;var g=s>>>2;for(i=0;i<t;i+=s)for(var m=i+g,w=i,l=0;w<m;w+=2,l+=n){const y=w,v=y+g,f=v+g,b=f+g,p=e[y],S=e[y+1],M=e[v],_=e[v+1],P=e[f],T=e[f+1],C=e[b],H=e[b+1],q=p,K=S,L=u[l],Z=c*u[l+1],Q=M*L-_*Z,V=M*Z+_*L,O=u[2*l],$=c*u[2*l+1],me=P*O-T*$,oe=P*$+T*O,re=u[3*l],ie=c*u[3*l+1],ee=C*re-H*ie,ae=C*ie+H*re,fe=q+me,ce=K+oe,le=q-me,ue=K-oe,ge=Q+ee,ve=V+ae,a=c*(Q-ee),A=c*(V-ae),I=fe+ge,W=ce+ve,j=fe-ge,ye=ce-ve,Ce=le+A,pe=ue-a,Se=le-A,Pe=ue+a;e[y]=I,e[y+1]=W,e[v]=Ce,e[v+1]=pe,e[f]=j,e[f+1]=ye,e[b]=Se,e[b+1]=Pe}}};U.prototype._singleTransform2=function(e,t,o){const n=this._out,s=this._data,i=s[t],d=s[t+1],h=s[t+o],c=s[t+o+1],u=i+h,g=d+c,m=i-h,w=d-c;n[e]=u,n[e+1]=g,n[e+2]=m,n[e+3]=w};U.prototype._singleTransform4=function(e,t,o){const n=this._out,s=this._data,i=this._inv?-1:1,d=o*2,h=o*3,c=s[t],u=s[t+1],g=s[t+o],m=s[t+o+1],w=s[t+d],l=s[t+d+1],y=s[t+h],v=s[t+h+1],f=c+w,b=u+l,p=c-w,S=u-l,M=g+y,_=m+v,P=i*(g-y),T=i*(m-v),C=f+M,H=b+_,q=p+T,K=S-P,L=f-M,Z=b-_,Q=p-T,V=S+P;n[e]=C,n[e+1]=H,n[e+2]=q,n[e+3]=K,n[e+4]=L,n[e+5]=Z,n[e+6]=Q,n[e+7]=V};U.prototype._realTransform4=function(){var e=this._out,t=this._csize,o=this._width,n=1<<o,s=t/n<<1,i,d,h=this._bitrev;if(s===4)for(i=0,d=0;i<t;i+=s,d++){const We=h[d];this._singleRealTransform2(i,We>>>1,n>>>1)}else for(i=0,d=0;i<t;i+=s,d++){const We=h[d];this._singleRealTransform4(i,We>>>1,n>>>1)}var c=this._inv?-1:1,u=this.table;for(n>>=2;n>=2;n>>=2){s=t/n<<1;var g=s>>>1,m=g>>>1,w=m>>>1;for(i=0;i<t;i+=s)for(var l=0,y=0;l<=w;l+=2,y+=n){var v=i+l,f=v+m,b=f+m,p=b+m,S=e[v],M=e[v+1],_=e[f],P=e[f+1],T=e[b],C=e[b+1],H=e[p],q=e[p+1],K=S,L=M,Z=u[y],Q=c*u[y+1],V=_*Z-P*Q,O=_*Q+P*Z,$=u[2*y],me=c*u[2*y+1],oe=T*$-C*me,re=T*me+C*$,ie=u[3*y],ee=c*u[3*y+1],ae=H*ie-q*ee,fe=H*ee+q*ie,ce=K+oe,le=L+re,ue=K-oe,ge=L-re,ve=V+ae,a=O+fe,A=c*(V-ae),I=c*(O-fe),W=ce+ve,j=le+a,ye=ue+I,Ce=ge-A;if(e[v]=W,e[v+1]=j,e[f]=ye,e[f+1]=Ce,l===0){var pe=ce-ve,Se=le-a;e[b]=pe,e[b+1]=Se;continue}if(l!==w){var Pe=ue,te=-ge,Ie=ce,Re=-le,qe=-c*I,k=-c*A,J=-c*a,Le=-c*ve,je=Pe+qe,Ge=te+k,xe=Ie+Le,Ve=Re-J,it=i+m-l,at=i+g-l;e[it]=je,e[it+1]=Ge,e[at]=xe,e[at+1]=Ve}}}};U.prototype._singleRealTransform2=function(e,t,o){const n=this._out,s=this._data,i=s[t],d=s[t+o],h=i+d,c=i-d;n[e]=h,n[e+1]=0,n[e+2]=c,n[e+3]=0};U.prototype._singleRealTransform4=function(e,t,o){const n=this._out,s=this._data,i=this._inv?-1:1,d=o*2,h=o*3,c=s[t],u=s[t+o],g=s[t+d],m=s[t+h],w=c+g,l=c-g,y=u+m,v=i*(u-m),f=w+y,b=l,p=-v,S=w-y,M=l,_=v;n[e]=f,n[e+1]=0,n[e+2]=b,n[e+3]=p,n[e+4]=S,n[e+5]=0,n[e+6]=M,n[e+7]=_};const Mt=_t(pt);class Fe{constructor(e,t){X(this,"_inputLength");X(this,"_fft");X(this,"_bufferSupplier");X(this,"_paddedInputBuffer");X(this,"_transformBuffer");X(this,"_inverseBuffer");if(e<1)throw new Error("Input length must be at least one");this._inputLength=e,this._fft=new Mt(Ct(2*e)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(e){return new Fe(e,t=>new Float32Array(t))}static forFloat64Array(e){return new Fe(e,t=>new Float64Array(t))}static forNumberArray(e){return new Fe(e,t=>Array(t))}get inputLength(){return this._inputLength}autocorrelate(e,t=this._bufferSupplier(e.length)){if(e.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${e.length}`);for(let n=0;n<e.length;n++)this._paddedInputBuffer[n]=e[n];for(let n=e.length;n<this._paddedInputBuffer.length;n++)this._paddedInputBuffer[n]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const o=this._transformBuffer;for(let n=0;n<o.length;n+=2)o[n]=o[n]*o[n]+o[n+1]*o[n+1],o[n+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let n=0;n<e.length;n++)t[n]=this._inverseBuffer[2*n];return t}}function Dt(r){const e=[];let t=!1,o=-1/0,n=-1;for(let s=1;s<r.length-1;s++)r[s-1]<=0&&r[s]>0?(t=!0,n=s,o=r[s]):r[s-1]>0&&r[s]<=0?(t=!1,n!==-1&&e.push(n)):t&&r[s]>o&&(o=r[s],n=s);return e}function At(r,e){const[t,o,n]=[r-1,r,r+1],[s,i,d]=[e[t],e[o],e[n]],h=s/2-i+d/2,c=-(s/2)*(o+n)+i*(t+n)-d/2*(t+o),u=s*o*n/2-i*t*n+d*t*o/2,g=-c/(2*h),m=h*g*g+c*g+u;return[g,m]}class Ae{constructor(e,t){X(this,"_autocorrelator");X(this,"_nsdfBuffer");X(this,"_clarityThreshold",.9);X(this,"_minVolumeAbsolute",0);X(this,"_maxInputAmplitude",1);this._autocorrelator=new Fe(e,t),this._nsdfBuffer=t(e)}static forFloat32Array(e){return new Ae(e,t=>new Float32Array(t))}static forFloat64Array(e){return new Ae(e,t=>new Float64Array(t))}static forNumberArray(e){return new Ae(e,t=>Array(t))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(e){if(!Number.isFinite(e)||e<=0||e>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=e}set minVolumeAbsolute(e){if(!Number.isFinite(e)||e<0||e>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=e}set minVolumeDecibels(e){if(!Number.isFinite(e)||e>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(e/10)}set maxInputAmplitude(e){if(!Number.isFinite(e)||e<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=e}findPitch(e,t){if(this._belowMinimumVolume(e))return[0,0];this._nsdf(e);const o=Dt(this._nsdfBuffer);if(o.length===0)return[0,0];const n=Math.max(...o.map(h=>this._nsdfBuffer[h])),s=o.find(h=>this._nsdfBuffer[h]>=this._clarityThreshold*n),[i,d]=At(s,this._nsdfBuffer);return[t/i,Math.min(d,1)]}_belowMinimumVolume(e){if(this._minVolumeAbsolute===0)return!1;let t=0;for(let o=0;o<e.length;o++)t+=e[o]**2;return Math.sqrt(t/e.length)<this._minVolumeAbsolute}_nsdf(e){this._autocorrelator.autocorrelate(e,this._nsdfBuffer);let t=2*this._nsdfBuffer[0],o;for(o=0;o<this._nsdfBuffer.length&&t>0;o++)this._nsdfBuffer[o]=2*this._nsdfBuffer[o]/t,t-=e[o]**2+e[e.length-o-1]**2;for(;o<this._nsdfBuffer.length;o++)this._nsdfBuffer[o]=0}}function Ct(r){return r--,r|=r>>1,r|=r>>2,r|=r>>4,r|=r>>8,r|=r>>16,r++,r}const Be="src/lib/components/VolumeBar.svelte";function Qe(r){let e,t,o,n,s,i;const d={c:function(){e=N("div"),t=N("div"),o=N("div"),n=se(),s=N("div"),this.h()},l:function(c){e=z(c,"DIV",{class:!0});var u=R(e);t=z(u,"DIV",{class:!0,style:!0});var g=R(t);o=z(g,"DIV",{class:!0,style:!0}),R(o).forEach(x),g.forEach(x),n=ne(u),s=z(u,"DIV",{class:!0,style:!0}),R(s).forEach(x),u.forEach(x),this.h()},h:function(){F(o,"class","volume-bar-fill"),B(o,"position","absolute"),B(o,"top","0"),B(o,"left","0"),B(o,"height","100%"),E(o,Be,51,4,1464),F(t,"class","volume-bar-bg"),B(t,"height",r[1]),B(t,"border-radius","9999px"),B(t,"background-color","#e2e8f0"),B(t,"position","relative"),B(t,"overflow","hidden"),E(t,Be,50,2,1318),F(s,"class","threshold-indicator svelte-13z7ppf"),B(s,"position","absolute"),B(s,"top","0"),B(s,"left",r[0]+"%"),B(s,"width","2px"),B(s,"height",r[1]),B(s,"background-color","#64748b"),B(s,"border-radius","1px"),E(s,Be,59,2,1643),F(e,"class",i="volume-bar-container "+r[2]+" svelte-13z7ppf"),E(e,Be,49,0,1269)},m:function(c,u){_e(c,e,u),D(e,t),D(t,o),r[5](o),D(e,n),D(e,s)},p:function(c,[u]){u&2&&B(t,"height",c[1]),u&1&&B(s,"left",c[0]+"%"),u&2&&B(s,"height",c[1]),u&4&&i!==(i="volume-bar-container "+c[2]+" svelte-13z7ppf")&&F(e,"class",i)},i:ct,o:ct,d:function(c){c&&x(e),r[5](null)}};return de("SvelteRegisterBlock",{block:d,id:Qe.name,type:"component",source:"",ctx:r}),d}function St(r,e,t){let{$$slots:o={},$$scope:n}=e;$e("VolumeBar",o,[]);let{volume:s=0}=e,{threshold:i=30}=e,{height:d="12px"}=e,{className:h=""}=e,c;function u(l){return l<i?`rgba(37, 99, 235, ${Math.max(.2,l/i*.8)})`:"#2563eb"}function g(l){if(c){const y=Math.max(0,Math.min(100,l)),v=u(y);t(3,c.style.width=`${y}%`,c),t(3,c.style.backgroundColor=v,c)}}Ue(()=>{c&&(t(3,c.style.width="0%",c),t(3,c.style.backgroundColor="#2563eb",c),t(3,c.style.height=d,c),t(3,c.style.borderRadius="9999px",c),t(3,c.style.transition="width 0.2s ease-out, background-color 0.2s ease-out",c))});const m=["volume","threshold","height","className"];Object.keys(e).forEach(l=>{!~m.indexOf(l)&&l.slice(0,2)!=="$$"&&l!=="slot"&&console.warn(`<VolumeBar> was created with unknown prop '${l}'`)});function w(l){wt[l?"unshift":"push"](()=>{c=l,t(3,c)})}return r.$$set=l=>{"volume"in l&&t(4,s=l.volume),"threshold"in l&&t(0,i=l.threshold),"height"in l&&t(1,d=l.height),"className"in l&&t(2,h=l.className)},r.$capture_state=()=>({onMount:Ue,volume:s,threshold:i,height:d,className:h,barElement:c,getVolumeColor:u,updateVolumeBar:g}),r.$inject_state=l=>{"volume"in l&&t(4,s=l.volume),"threshold"in l&&t(0,i=l.threshold),"height"in l&&t(1,d=l.height),"className"in l&&t(2,h=l.className),"barElement"in l&&t(3,c=l.barElement)},e&&"$$inject"in e&&r.$inject_state(e.$$inject),r.$$.update=()=>{r.$$.dirty&16&&g(s)},[i,d,h,c,s,w]}class ke extends Ye{constructor(e){super(e),Ze(this,e,St,Qe,Oe,{volume:4,threshold:0,height:1,className:2}),de("SvelteRegisterComponent",{component:this,tagName:"VolumeBar",options:e,id:Qe.name})}get volume(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set volume(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get threshold(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set threshold(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get height(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set height(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}class Pt{constructor(){this.audioContext=null,this.mediaStream=null,this.sourceNode=null,this.analysers=new Map,this.filters=new Map,this.refCount=0,this.initPromise=null,this.isInitialized=!1,this.lastError=null}async initialize(){var e,t,o;if(this.initPromise)return this.initPromise;if(this.isInitialized&&this.audioContext&&this.mediaStream){const n=this.checkMediaStreamHealth();if(n.healthy)return this.refCount++,{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode};console.warn("‚ö†Ô∏è [AudioManager] MediaStream‰∏çÂÅ•Â∫∑Ê§úÂá∫ - Âº∑Âà∂ÂÜçÂàùÊúüÂåñ:",n.reason),console.log("üîÑ [AudioManager] ‰∏çÂÅ•Â∫∑„Å™MediaStreamË©≥Á¥∞:",{mediaStreamActive:(e=this.mediaStream)==null?void 0:e.active,trackCount:(t=this.mediaStream)==null?void 0:t.getTracks().length,trackStates:(o=this.mediaStream)==null?void 0:o.getTracks().map(s=>({kind:s.kind,readyState:s.readyState,enabled:s.enabled,muted:s.muted}))}),this._cleanup(),this.isInitialized=!1,this.refCount=0,await new Promise(s=>setTimeout(s,100)),console.log("üîÑ [AudioManager] „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü - ÂÜçÂàùÊúüÂåñÈñãÂßã")}this.initPromise=this._doInitialize();try{const n=await this.initPromise;return this.initPromise=null,n}catch(n){throw this.initPromise=null,n}}async _doInitialize(){try{if(console.log("üé§ [AudioManager] ÂàùÊúüÂåñÈñãÂßã"),this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),console.log("‚úÖ [AudioManager] AudioContext‰ΩúÊàêÂÆå‰∫Ü")),this.audioContext.state==="suspended"&&(await this.audioContext.resume(),console.log("‚úÖ [AudioManager] AudioContextÂÜçÈñãÂÆå‰∫Ü")),!this.mediaStream){const e={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,sampleRate:44100,channelCount:1,sampleSize:16,latency:.1,volume:1,deviceId:{ideal:"default"}}};console.log("üé§ [AudioManager] SafariÂØæÂøúË®≠ÂÆö„ÅßMediaStreamÂèñÂæó‰∏≠:",e),this.mediaStream=await navigator.mediaDevices.getUserMedia(e),console.log("‚úÖ [AudioManager] MediaStreamÂèñÂæóÂÆå‰∫Ü")}if(!this.sourceNode){this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),console.log("‚úÖ [AudioManager] SourceNode‰ΩúÊàêÂÆå‰∫Ü");const e=this.mediaStream.getTracks();console.log("üé§ [AudioManager] MediaStream tracks:",e.map(t=>({kind:t.kind,label:t.label,enabled:t.enabled,readyState:t.readyState,muted:t.muted})))}return this.isInitialized=!0,this.refCount++,this.lastError=null,console.log(`üé§ [AudioManager] ÂàùÊúüÂåñÂÆå‰∫Ü (ÂèÇÁÖß„Ç´„Ç¶„É≥„Éà: ${this.refCount})`),{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode}}catch(e){throw console.error("‚ùå [AudioManager] ÂàùÊúüÂåñ„Ç®„É©„Éº:",e),this.lastError=e,this.isInitialized=!1,this._cleanup(),e}}createAnalyser(e,t={}){if(!this.isInitialized||!this.audioContext||!this.sourceNode)throw new Error("AudioManager not initialized. Call initialize() first.");this.removeAnalyser(e);const{fftSize:o=2048,smoothingTimeConstant:n=.8,minDecibels:s=-90,maxDecibels:i=-10,useFilters:d=!0}=t,h=this.audioContext.createAnalyser();if(h.fftSize=Math.min(o,2048),h.smoothingTimeConstant=Math.max(n,.7),h.minDecibels=Math.max(s,-80),h.maxDecibels=Math.min(i,-10),this.sourceNode,d){const c=this._createFilterChain();this.filters.set(e,c),this.sourceNode.connect(c.highpass),c.highpass.connect(c.lowpass),c.lowpass.connect(c.notch),c.notch.connect(h),console.log(`üîß [AudioManager] „Éï„Ç£„É´„Çø„Éº‰ªò„ÅçAnalyser‰ΩúÊàê: ${e}`)}else this.sourceNode.connect(h),console.log(`üîß [AudioManager] Áîü‰ø°Âè∑Analyser‰ΩúÊàê: ${e}`);return this.analysers.set(e,h),h}_createFilterChain(){const e=this.audioContext.createBiquadFilter();e.type="highpass",e.frequency.setValueAtTime(80,this.audioContext.currentTime),e.Q.setValueAtTime(.7,this.audioContext.currentTime);const t=this.audioContext.createBiquadFilter();t.type="lowpass",t.frequency.setValueAtTime(800,this.audioContext.currentTime),t.Q.setValueAtTime(.7,this.audioContext.currentTime);const o=this.audioContext.createBiquadFilter();return o.type="notch",o.frequency.setValueAtTime(60,this.audioContext.currentTime),o.Q.setValueAtTime(10,this.audioContext.currentTime),{highpass:e,lowpass:t,notch:o}}removeAnalyser(e){if(this.analysers.has(e)&&(this.analysers.get(e).disconnect(),this.analysers.delete(e),console.log(`üóëÔ∏è [AudioManager] AnalyserÂâäÈô§: ${e}`)),this.filters.has(e)){const t=this.filters.get(e);t.highpass.disconnect(),t.lowpass.disconnect(),t.notch.disconnect(),this.filters.delete(e),console.log(`üóëÔ∏è [AudioManager] „Éï„Ç£„É´„Çø„Éº„ÉÅ„Çß„Éº„É≥ÂâäÈô§: ${e}`)}}release(e=[]){e.forEach(t=>this.removeAnalyser(t)),this.refCount=Math.max(0,this.refCount-1),console.log(`üìâ [AudioManager] ÂèÇÁÖß„Ç´„Ç¶„É≥„ÉàÊ∏õÁÆó: ${this.refCount}`),this.refCount<=0&&(console.log("üßπ [AudioManager] ÂÖ®„É™„ÇΩ„Éº„Çπ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÈñãÂßã"),this._cleanup())}forceCleanup(){console.log("üö® [AudioManager] Âº∑Âà∂„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂÆüË°å"),this._cleanup()}_cleanup(){console.log("üßπ [AudioManager] „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÈñãÂßã");for(const e of this.analysers.keys())this.removeAnalyser(e);if(this.mediaStream){const e=this.mediaStream.getTracks();console.log(`üõë [AudioManager] MediaStreamÂÅúÊ≠¢‰∏≠: ${e.length} tracks`),e.forEach((t,o)=>{try{t.readyState!=="ended"?(t.stop(),console.log(`üõë [AudioManager] Track ${o} ÂÅúÊ≠¢ÂÆå‰∫Ü`)):console.log(`‚ö†Ô∏è [AudioManager] Track ${o} Êó¢„Å´ÁµÇ‰∫ÜÊ∏à„Åø`)}catch(n){console.warn(`‚ö†Ô∏è [AudioManager] Track ${o} ÂÅúÊ≠¢„Ç®„É©„Éº:`,n)}}),this.mediaStream=null}if(this.audioContext&&this.audioContext.state!=="closed"){try{this.audioContext.close(),console.log("üõë [AudioManager] AudioContextÈñâÈéñÂÆå‰∫Ü")}catch(e){console.warn("‚ö†Ô∏è [AudioManager] AudioContextÈñâÈéñ„Ç®„É©„Éº:",e)}this.audioContext=null}this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.isInitialized=!1,this.refCount=0,this.initPromise=null,console.log("‚úÖ [AudioManager] „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü")}getStatus(){var e,t;return{isInitialized:this.isInitialized,refCount:this.refCount,audioContextState:((e=this.audioContext)==null?void 0:e.state)||"none",mediaStreamActive:((t=this.mediaStream)==null?void 0:t.active)||!1,activeAnalysers:Array.from(this.analysers.keys()),activeFilters:Array.from(this.filters.keys()),lastError:this.lastError}}checkMediaStreamHealth(){if(!this.mediaStream)return{healthy:!1,reason:"MediaStream not initialized"};if(!this.mediaStream.active)return{healthy:!1,reason:"MediaStream inactive"};const e=this.mediaStream.getTracks();if(e.length===0)return{healthy:!1,reason:"No tracks available"};const t=e.find(o=>o.kind==="audio");return t?t.readyState==="ended"?{healthy:!1,reason:"Audio track ended"}:t.enabled?t.muted?{healthy:!1,reason:"Audio track muted"}:this.mediaStream.active&&t.readyState!=="live"?{healthy:!1,reason:"Track state inconsistent with MediaStream"}:{healthy:!0,track:t}:{healthy:!1,reason:"Audio track disabled"}:{healthy:!1,reason:"No audio track found"}}}const Me=new Pt;typeof window<"u"&&(window.audioManager=Me);class xt{constructor(e={}){this.vocalRangeMin=e.vocalRangeMin||130.81,this.vocalRangeMax=e.vocalRangeMax||1046.5,this.stabilityThreshold=e.stabilityThreshold||.1,this.evaluationWeights={vocalRange:e.vocalRangeWeight||.4,continuity:e.continuityWeight||.4,musical:e.musicalWeight||.2},this.fundamentalCandidates=e.fundamentalCandidates||[1,.5,.333,.25,2],this.harmonicHistory=[],this.previousFrequency=0,this.maxHistoryLength=5,this.debugMode=!1,this.currentContext={}}correctHarmonic(e,t=!1){if(!e||e<=0)return 0;const n=this.fundamentalCandidates.map(d=>({frequency:e*d,ratio:d})).map(d=>{const h=this.evaluateFundamental(d.frequency);return{...d,...h}}),s=n.reduce((d,h)=>h.totalScore>d.totalScore?h:d),i=this.stabilizeFrequency(s.frequency);return(t||this.debugMode)&&this.logHarmonicCorrection(e,n,s,i,this.currentContext),this.previousFrequency=i,i}logHarmonicCorrection(e,t,o,n,s={}){console.group(`üîß [HarmonicCorrection] ${e.toFixed(1)}Hz ‚Üí ${n.toFixed(1)}Hz`);const i=this.frequencyToNote(e),d=this.frequencyToNote(n);console.log(`üìù Èü≥Á®ãÂ§âÊèõ: ${i} ‚Üí ${d}`);const h=this.getCorrectionType(o.ratio);if(console.log(`üéØ Ë£úÊ≠£„Çø„Ç§„Éó: ${h}`),s.baseFrequency&&s.currentScale&&s.targetFrequency){console.log("üéµ Èü≥Èöé„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà:"),console.log(`   Âü∫Èü≥: ${s.baseFrequency.toFixed(1)}Hz (${this.frequencyToNote(s.baseFrequency)})`),console.log(`   ÁèæÂú®„ÅÆÈü≥Èöé: ${s.currentScale}`),console.log(`   ÁõÆÊ®ôÂë®Ê≥¢Êï∞: ${s.targetFrequency.toFixed(1)}Hz (${this.frequencyToNote(s.targetFrequency)})`);const u=n-s.targetFrequency,g=1200*Math.log2(n/s.targetFrequency);console.log(`   ÁõÆÊ®ô„Å®„ÅÆÂ∑Æ: ${u>0?"+":""}${u.toFixed(1)}Hz (${g>0?"+":""}${g.toFixed(0)}„Çª„É≥„Éà)`);const m=Math.abs(g)<=50?"üéØ È´òÁ≤æÂ∫¶":Math.abs(g)<=100?"‚úÖ ËâØÂ•Ω":Math.abs(g)<=200?"‚ö†Ô∏è Ë¶ÅÊîπÂñÑ":"‚ùå ‰∏çÊ≠£Á¢∫";console.log(`   Á≤æÂ∫¶Ë©ï‰æ°: ${m} (${Math.abs(g).toFixed(0)}„Çª„É≥„ÉàÂ∑Æ)`)}console.table(t.map(u=>({ÂÄçÁéá:`${u.ratio.toFixed(3)}x`,Âë®Ê≥¢Êï∞:`${u.frequency.toFixed(1)}Hz`,Èü≥Âêç:this.frequencyToNote(u.frequency),Èü≥Âüü:u.vocalRangeScore.toFixed(2),ÈÄ£Á∂öÊÄß:u.continuityScore.toFixed(2),Èü≥Ê•ΩÊÄß:u.musicalScore.toFixed(2),Á∑èÂêà:u.totalScore.toFixed(3),ÈÅ∏Êäû:u===o?"‚úÖ":""})));const c=Math.abs(n-o.frequency);c>.5&&console.log(`üîÑ ÂÆâÂÆöÂåñ: ${o.frequency.toFixed(1)}Hz ‚Üí ${n.toFixed(1)}Hz (${c.toFixed(1)}HzË™øÊï¥)`),console.groupEnd()}getCorrectionType(e){return Math.abs(e-1)<.01?"Ë£úÊ≠£„Å™„ÅóÔºàÂü∫Èü≥Ôºâ":Math.abs(e-.5)<.01?"2ÂÄçÈü≥Ë£úÊ≠£Ôºà1„Ç™„ÇØ„Çø„Éº„Éñ‰∏ãÔºâ":Math.abs(e-.333)<.01?"3ÂÄçÈü≥Ë£úÊ≠£Ôºà1„Ç™„ÇØ„Çø„Éº„Éñ+5Â∫¶‰∏ãÔºâ":Math.abs(e-.25)<.01?"4ÂÄçÈü≥Ë£úÊ≠£Ôºà2„Ç™„ÇØ„Çø„Éº„Éñ‰∏ãÔºâ":Math.abs(e-2)<.01?"„Ç™„ÇØ„Çø„Éº„Éñ‰∏äË£úÊ≠£":`„Ç´„Çπ„Çø„É†Ë£úÊ≠£Ôºà${e.toFixed(3)}xÔºâ`}frequencyToNote(e){if(!e||e<=0)return"---";const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=Math.round(12*Math.log2(e/440)),s=(n+9+120)%12,i=Math.floor((n+9)/12)+4;return t[s]+i}evaluateFundamental(e){const o=e>=this.vocalRangeMin&&e<=this.vocalRangeMax?1:0,n=this.previousFrequency>0?1-Math.min(Math.abs(e-this.previousFrequency)/this.previousFrequency,1):.5,s=this.calculateMusicalScore(e),i=o*this.evaluationWeights.vocalRange+n*this.evaluationWeights.continuity+s*this.evaluationWeights.musical;return{vocalRangeScore:o,continuityScore:n,musicalScore:s,totalScore:i}}calculateMusicalScore(e){const o=Math.log2(e/261.63)*12,n=Math.round(o),s=Math.abs(o-n);return Math.max(0,1-s/.5)}stabilizeFrequency(e){if(!e||e<=0)return 0;if(this.harmonicHistory.push(e),this.harmonicHistory.length>this.maxHistoryLength&&this.harmonicHistory.shift(),this.harmonicHistory.length<2)return e;const t=[...this.harmonicHistory].sort((i,d)=>i-d),o=t[Math.floor(t.length/2)],n=o*this.stabilityThreshold;return Math.abs(e-o)>n?o+Math.sign(e-o)*n:e}resetHistory(){this.harmonicHistory=[],this.previousFrequency=0}updateConfig(e){Object.assign(this,e),console.log("‚öôÔ∏è [HarmonicCorrection] Ë®≠ÂÆöÊõ¥Êñ∞:",e)}enableDebugLogging(){this.debugMode=!0,console.log("üîç [HarmonicCorrection] „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ÊúâÂäπÂåñ - Ê¨°Âõû„ÅÆË£úÊ≠£„Åã„ÇâË©≥Á¥∞„É≠„Ç∞„ÇíÂá∫Âäõ„Åó„Åæ„Åô"),console.log("ÁÑ°ÂäπÂåñ„Åô„Çã„Å´„ÅØ: harmonicCorrection.disableDebugLogging()")}disableDebugLogging(){this.debugMode=!1,console.log("üîç [HarmonicCorrection] „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ÁÑ°ÂäπÂåñ")}setScaleContext(e){this.currentContext={baseFrequency:e.baseFrequency,currentScale:e.currentScale,targetFrequency:e.targetFrequency}}clearContext(){this.currentContext={}}getStatus(){return{vocalRangeMin:this.vocalRangeMin,vocalRangeMax:this.vocalRangeMax,stabilityThreshold:this.stabilityThreshold,evaluationWeights:this.evaluationWeights,historyLength:this.harmonicHistory.length,previousFrequency:this.previousFrequency,recentHistory:this.harmonicHistory.slice(-3)}}}const De=new xt;typeof window<"u"&&(window.harmonicCorrection=De);const dt=(()=>{if(typeof window<"u"){const e=new URLSearchParams(window.location.search).get("debug");if(e)return e}return"info"})(),he={error:0,warn:1,info:2,debug:3},we=he[dt]??he.info,Ke={error:(r,...e)=>{we>=he.error&&console.error(`‚ùå ${r}`,...e)},warn:(r,...e)=>{we>=he.warn&&console.warn(`‚ö†Ô∏è ${r}`,...e)},info:(r,...e)=>{we>=he.info&&console.log(`‚ÑπÔ∏è ${r}`,...e)},debug:(r,...e)=>{we>=he.debug&&console.log(`üîç ${r}`,...e)},realtime:(()=>{let r=0;const e=1e3;return(t,...o)=>{if(we>=he.debug){const n=Date.now();n-r>=e&&(console.log(`üìä ${t}`,...o),r=n)}}})(),scoring:(r,...e)=>{we>=he.info&&console.log(`üéØ ${r}`,...e)},audio:(r,...e)=>{we>=he.info&&console.log(`üé§ ${r}`,...e)}};typeof import.meta<"u"&&Ke.info(`Debug Level: ${dt} (Change with ?debug=level)`);const{Error:G,console:Ft}=bt,be="src/lib/components/PitchDetector.svelte";function Je(r){let e,t,o,n,s=(r[2]>0?Math.round(r[2]):"---")+"",i,d,h,c="Hz",u,g,m="|",w,l,y,v,f,b,p;f=new ke({props:{volume:r[2]>0?r[1]:0,className:"volume-bar"},$$inline:!0});const S={c:function(){e=N("div"),t=N("div"),o=N("div"),n=N("span"),i=Ne(s),d=se(),h=N("span"),h.textContent=c,u=se(),g=N("span"),g.textContent=m,w=se(),l=N("span"),y=Ne(r[3]),v=se(),rt(f.$$.fragment),this.h()},l:function(_){e=z(_,"DIV",{class:!0});var P=R(e);t=z(P,"DIV",{class:!0});var T=R(t);o=z(T,"DIV",{class:!0});var C=R(o);n=z(C,"SPAN",{class:!0});var H=R(n);i=Ee(H,s),H.forEach(x),d=ne(C),h=z(C,"SPAN",{class:!0,"data-svelte-h":!0}),ze(h)!=="svelte-5uyilv"&&(h.textContent=c),u=ne(C),g=z(C,"SPAN",{class:!0,"data-svelte-h":!0}),ze(g)!=="svelte-1dytxz4"&&(g.textContent=m),w=ne(C),l=z(C,"SPAN",{class:!0});var q=R(l);y=Ee(q,r[3]),q.forEach(x),C.forEach(x),v=ne(T),ot(f.$$.fragment,T),T.forEach(x),P.forEach(x),this.h()},h:function(){F(n,"class","detected-frequency svelte-vc1bho"),E(n,be,545,6,16161),F(h,"class","hz-suffix svelte-vc1bho"),E(h,be,546,6,16269),F(g,"class","divider svelte-vc1bho"),E(g,be,547,6,16309),F(l,"class","detected-note svelte-vc1bho"),E(l,be,548,6,16346),F(o,"class","detection-card svelte-vc1bho"),E(o,be,544,4,16126),F(t,"class","detection-display svelte-vc1bho"),E(t,be,543,2,16090),F(e,"class",b="pitch-detector "+r[0]+" svelte-vc1bho"),E(e,be,542,0,16047)},m:function(_,P){_e(_,e,P),D(e,t),D(t,o),D(o,n),D(n,i),D(o,d),D(o,h),D(o,u),D(o,g),D(o,w),D(o,l),D(l,y),D(t,v),st(f,t,null),p=!0},p:function(_,P){(!p||P[0]&4)&&s!==(s=(_[2]>0?Math.round(_[2]):"---")+"")&&Te(i,s),(!p||P[0]&8)&&Te(y,_[3]);const T={};P[0]&6&&(T.volume=_[2]>0?_[1]:0),f.$set(T),(!p||P[0]&1&&b!==(b="pitch-detector "+_[0]+" svelte-vc1bho"))&&F(e,"class",b)},i:function(_){p||(nt(f.$$.fragment,_),p=!0)},o:function(_){tt(f.$$.fragment,_),p=!1},d:function(_){_&&x(e),et(f)}};return de("SvelteRegisterBlock",{block:S,id:Je.name,type:"component",source:"",ctx:r}),S}function He(r){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(r<=0)return"„Éº„Éº";const o=Math.round(12*Math.log2(r/440)),n=(o+9+120)%12,s=Math.floor((o+9)/12)+4;return e[n]+s}function Tt(r,e,t){let{$$slots:o={},$$scope:n}=e;$e("PitchDetector",o,[]);const s=lt();let{isActive:i=!1}=e,{className:d=""}=e,{debugMode:h=!1}=e,{trainingPhase:c=""}=e,u="uninitialized",g=null,m=!1,w=null,l=null,y=null,v=null,f=null,b=null,p=null,S=!1,M=[],_=new Map,P=0,T=0,C=0,H="„Éº„Éº",q=0,K=[],L=[],Z=0,Q=0,V=null,O="",$=0;function me(){P=0,t(1,T=0),t(2,C=0),t(3,H="„Éº„Éº"),q=0,Z=0,Q=0,K=[],L=[],De.resetHistory(),O="",$=0,h&&console.log("üîÑ [PitchDetector] Display state reset")}function oe(){if(!h)return;const a=new Date().toLocaleTimeString(),A={timestamp:a,componentState:u,isActive:i,isDetecting:S,isInitialized:m,mediaStreamActive:l?l.active:null,mediaStreamTracks:l?l.getTracks().length:0,trackStates:l?l.getTracks().map(j=>({kind:j.kind,enabled:j.enabled,readyState:j.readyState,muted:j.muted})):[],audioContextState:w?w.state:null,hasAnalyser:!!v,currentVolume:P,currentFrequency:C};Ke.realtime(`[PitchDetector] ${a}:`,A);let I=!0,W=[];l&&!l.active&&(console.warn("‚ö†Ô∏è [PitchDetector] MediaStream is inactive!",l),I=!1,W.push("MediaStream inactive")),w&&w.state==="suspended"&&(console.warn("‚ö†Ô∏è [PitchDetector] AudioContext is suspended!",w),I=!1,W.push("AudioContext suspended")),l&&l.getTracks().forEach((j,ye)=>{j.readyState==="ended"&&(console.error(`‚ùå [PitchDetector] Track ${ye} has ended!`,j),I=!1,W.push(`Track ${ye} ended`))}),s("microphoneHealthChange",{healthy:I,errors:W,details:A})}async function re(){try{t(15,u="initializing"),g=null,console.log("üéôÔ∏è [PitchDetector] AudioManagerÁµåÁî±„ÅßÂàùÊúüÂåñÈñãÂßã");const a=await Me.initialize();w=a.audioContext,l=a.mediaStream,y=a.sourceNode,console.log("‚úÖ [PitchDetector] AudioManager „É™„ÇΩ„Éº„ÇπÂèñÂæóÂÆå‰∫Ü");const A=`pitch-detector-filtered-${Date.now()}`;t(16,v=Me.createAnalyser(A,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!0})),M.push(A);const I=`pitch-detector-raw-${Date.now()}`;f=Me.createAnalyser(I,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!1}),M.push(I),console.log("‚úÖ [PitchDetector] Analyser‰ΩúÊàêÂÆå‰∫Ü:",M),b=Ae.forFloat32Array(v.fftSize),t(15,u="ready"),m=!0,s("stateChange",{state:u}),ge(),console.log("‚úÖ [PitchDetector] ÂàùÊúüÂåñÂÆå‰∫Ü")}catch(a){throw console.error("‚ùå [PitchDetector] ÂàùÊúüÂåñ„Ç®„É©„Éº:",a),t(15,u="error"),g=a,m=!1,s("error",{error:a,context:"initialization"}),a}}function ie(){if(u!=="ready"){const a=new Error(`Cannot start detection: component state is ${u}`);return s("error",{error:a,context:"start-detection"}),!1}if(!v||!b||!w){const a=new Error("Required components not available");return t(15,u="error"),s("error",{error:a,context:"start-detection"}),!1}return t(15,u="detecting"),t(17,S=!0),s("stateChange",{state:u}),ae(),!0}function ee(){t(17,S=!1),p&&(cancelAnimationFrame(p),p=null),u==="detecting"&&m&&(t(15,u="ready"),s("stateChange",{state:u}))}function ae(){if(!S||!v||!f||!b)return;const a=v.fftSize,A=new Float32Array(a),I=new Float32Array(f.fftSize);v.getFloatTimeDomainData(A),f.getFloatTimeDomainData(I);let W=0;for(let k=0;k<a;k++)W+=Math.abs(A[k]);const j=Math.sqrt(W/a),ye=Math.log10(j+.001)*50+100,Ce=Math.max(0,Math.min(100,ye));let pe=0;for(let k=0;k<I.length;k++)pe+=Math.abs(I[k]);const Se=Math.sqrt(pe/I.length),Pe=Math.log10(Se+.001)*50+100;t(1,T=Math.max(0,Math.min(100,Pe))),L.push(Ce),L.length>5&&L.shift(),Q=L.reduce((k,J)=>k+J,0)/L.length,P=Q;const[te,Ie]=b.findPitch(A,w.sampleRate),Re=te>=65&&te<=1200;if(te&&Ie>.6&&P>10&&Re){const k=De.correctHarmonic(te);if(k!==te&&Math.abs(k-te)>5&&c==="guiding"){const J=te/k,Le=J>1.8&&J<2.2?"2x":J>2.8&&J<3.2?"3x":J>3.8&&J<4.2?"4x":J>.45&&J<.55?"1/2x":"other",je=He(te),Ge=He(k),xe=`üîß [Harmonic] ${te.toFixed(0)}Hz(${je}) ‚Üí ${k.toFixed(0)}Hz(${Ge}) [${Le}Ë£úÊ≠£]`,Ve=Date.now();xe!==O&&Ve-$>500&&(console.log(xe),O=xe,$=Ve)}t(2,C=Math.round(k)),t(3,H=He(C)),q=Ie}else C===0&&De.resetHistory(),t(2,C=0),t(3,H="„Éº„Éº"),q=0;const qe=C>0?T:0;s("pitchUpdate",{frequency:C,note:H,volume:P,rawVolume:qe,clarity:q}),p=requestAnimationFrame(ae)}function fe(){return m&&u==="ready"}function ce(){return{componentState:u,isInitialized:m,isDetecting:S,lastError:g,hasRequiredComponents:!!(v&&b&&w&&l)}}async function le(){console.log("üîÑ [PitchDetector] ÂÜçÂàùÊúüÂåñÈñãÂßã"),ue(),await new Promise(a=>setTimeout(a,100)),await re(),console.log("‚úÖ [PitchDetector] ÂÜçÂàùÊúüÂåñÂÆå‰∫Ü")}function ue(){console.log("üßπ [PitchDetector] „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÈñãÂßã"),ee(),_.size>0&&(_.forEach((a,A)=>{A.removeEventListener("ended",a.endedHandler),A.removeEventListener("mute",a.muteHandler),A.removeEventListener("unmute",a.unmuteHandler)}),_.clear(),console.log("üîÑ [PitchDetector] MediaStream„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÂâäÈô§")),M.length>0&&(Me.release(M),console.log("üì§ [PitchDetector] AudioManager„Å´AnalyserËß£ÊîæÈÄöÁü•:",M),M=[]),t(15,u="uninitialized"),m=!1,g=null,w=null,l=null,y=null,t(16,v=null),f=null,b=null,K=[],L=[],De.resetHistory(),console.log("‚úÖ [PitchDetector] „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü")}function ge(){if(!l)return;const a=l.getTracks();a.forEach(A=>{const I=()=>{console.error("üö® [PitchDetector] MediaStreamTrackÁµÇ‰∫ÜÊ§úÂá∫:",A.kind),t(15,u="error"),g=new Error(`MediaStreamTrack (${A.kind}) ended`),s("error",{error:g,reason:"mediastream_ended",recovery:"restart_required"}),S&&ee()},W=()=>{console.warn("‚ö†Ô∏è [PitchDetector] MediaStreamTrack muted:",A.kind),s("warning",{reason:"track_muted",track:A.kind})},j=()=>{console.log("‚úÖ [PitchDetector] MediaStreamTrack unmuted:",A.kind),s("info",{reason:"track_unmuted",track:A.kind})};A.addEventListener("ended",I),A.addEventListener("mute",W),A.addEventListener("unmute",j),_.set(A,{endedHandler:I,muteHandler:W,unmuteHandler:j})}),console.log("üîç [PitchDetector] MediaStreamÁõ£Ë¶ñÈñãÂßã:",a.length+" tracks")}ut(()=>{V&&(clearInterval(V),t(18,V=null)),console.log("üîÑ [PitchDetector] onDestroy - AudioManager„É™„ÇΩ„Éº„Çπ„ÅØ‰øùÊåÅ")});const ve=["isActive","className","debugMode","trainingPhase"];return Object.keys(e).forEach(a=>{!~ve.indexOf(a)&&a.slice(0,2)!=="$$"&&a!=="slot"&&Ft.warn(`<PitchDetector> was created with unknown prop '${a}'`)}),r.$$set=a=>{"isActive"in a&&t(4,i=a.isActive),"className"in a&&t(0,d=a.className),"debugMode"in a&&t(5,h=a.debugMode),"trainingPhase"in a&&t(6,c=a.trainingPhase)},r.$capture_state=()=>({onMount:Ue,onDestroy:ut,createEventDispatcher:lt,PitchDetector:Ae,VolumeBar:ke,audioManager:Me,harmonicCorrection:De,logger:Ke,dispatch:s,isActive:i,className:d,debugMode:h,trainingPhase:c,componentState:u,lastError:g,isInitialized:m,audioContext:w,mediaStream:l,sourceNode:y,analyser:v,rawAnalyser:f,pitchDetector:b,animationFrame:p,isDetecting:S,analyserIds:M,mediaStreamListeners:_,currentVolume:P,rawVolume:T,currentFrequency:C,detectedNote:H,pitchClarity:q,frequencyHistory:K,volumeHistory:L,stableFrequency:Z,stableVolume:Q,debugInterval:V,lastHarmonicLog:O,lastLogTime:$,resetDisplayState:me,checkMicrophoneStatus:oe,initialize:re,startDetection:ie,stopDetection:ee,detectPitch:ae,frequencyToNote:He,getIsInitialized:fe,getState:ce,reinitialize:le,cleanup:ue,setupMediaStreamMonitoring:ge}),r.$inject_state=a=>{"isActive"in a&&t(4,i=a.isActive),"className"in a&&t(0,d=a.className),"debugMode"in a&&t(5,h=a.debugMode),"trainingPhase"in a&&t(6,c=a.trainingPhase),"componentState"in a&&t(15,u=a.componentState),"lastError"in a&&(g=a.lastError),"isInitialized"in a&&(m=a.isInitialized),"audioContext"in a&&(w=a.audioContext),"mediaStream"in a&&(l=a.mediaStream),"sourceNode"in a&&(y=a.sourceNode),"analyser"in a&&t(16,v=a.analyser),"rawAnalyser"in a&&(f=a.rawAnalyser),"pitchDetector"in a&&(b=a.pitchDetector),"animationFrame"in a&&(p=a.animationFrame),"isDetecting"in a&&t(17,S=a.isDetecting),"analyserIds"in a&&(M=a.analyserIds),"mediaStreamListeners"in a&&(_=a.mediaStreamListeners),"currentVolume"in a&&(P=a.currentVolume),"rawVolume"in a&&t(1,T=a.rawVolume),"currentFrequency"in a&&t(2,C=a.currentFrequency),"detectedNote"in a&&t(3,H=a.detectedNote),"pitchClarity"in a&&(q=a.pitchClarity),"frequencyHistory"in a&&(K=a.frequencyHistory),"volumeHistory"in a&&(L=a.volumeHistory),"stableFrequency"in a&&(Z=a.stableFrequency),"stableVolume"in a&&(Q=a.stableVolume),"debugInterval"in a&&t(18,V=a.debugInterval),"lastHarmonicLog"in a&&(O=a.lastHarmonicLog),"lastLogTime"in a&&($=a.lastLogTime)},e&&"$$inject"in e&&r.$inject_state(e.$$inject),r.$$.update=()=>{r.$$.dirty[0]&262176&&(h&&!V?(console.log("üîç [PitchDetector] Debug mode enabled - starting status monitoring"),t(18,V=setInterval(oe,3e3)),oe()):!h&&V&&(console.log("üîç [PitchDetector] Debug mode disabled - stopping status monitoring"),clearInterval(V),t(18,V=null))),r.$$.dirty[0]&229392&&(i&&u==="ready"&&v&&!S?ie():!i&&S&&ee())},[d,T,C,H,i,h,c,me,re,ie,ee,fe,ce,le,ue,u,v,S,V]}class Ht extends Ye{constructor(e){super(e),Ze(this,e,Tt,Je,Oe,{isActive:4,className:0,debugMode:5,trainingPhase:6,resetDisplayState:7,initialize:8,startDetection:9,stopDetection:10,getIsInitialized:11,getState:12,reinitialize:13,cleanup:14},null,[-1,-1]),de("SvelteRegisterComponent",{component:this,tagName:"PitchDetector_1",options:e,id:Je.name})}get isActive(){throw new G("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set isActive(e){throw new G("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new G("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(e){throw new G("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get debugMode(){throw new G("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set debugMode(e){throw new G("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get trainingPhase(){throw new G("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set trainingPhase(e){throw new G("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get resetDisplayState(){return this.$$.ctx[7]}set resetDisplayState(e){throw new G("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get initialize(){return this.$$.ctx[8]}set initialize(e){throw new G("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get startDetection(){return this.$$.ctx[9]}set startDetection(e){throw new G("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get stopDetection(){return this.$$.ctx[10]}set stopDetection(e){throw new G("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get getIsInitialized(){return this.$$.ctx[11]}set getIsInitialized(e){throw new G("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get getState(){return this.$$.ctx[12]}set getState(e){throw new G("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get reinitialize(){return this.$$.ctx[13]}set reinitialize(e){throw new G("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get cleanup(){return this.$$.ctx[14]}set cleanup(e){throw new G("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}const Y="src/lib/components/PitchDetectionDisplay.svelte";function mt(r){let e,t,o=(r[0]>0?Math.round(r[0]):"---")+"",n,s,i,d="Hz",h,c,u="|",g,m,w;const l={c:function(){e=N("div"),t=N("span"),n=Ne(o),s=se(),i=N("span"),i.textContent=d,h=se(),c=N("span"),c.textContent=u,g=se(),m=N("span"),w=Ne(r[1]),this.h()},l:function(v){e=z(v,"DIV",{class:!0});var f=R(e);t=z(f,"SPAN",{class:!0});var b=R(t);n=Ee(b,o),b.forEach(x),s=ne(f),i=z(f,"SPAN",{class:!0,"data-svelte-h":!0}),ze(i)!=="svelte-5uyilv"&&(i.textContent=d),h=ne(f),c=z(f,"SPAN",{class:!0,"data-svelte-h":!0}),ze(c)!=="svelte-1dytxz4"&&(c.textContent=u),g=ne(f),m=z(f,"SPAN",{class:!0});var p=R(m);w=Ee(p,r[1]),p.forEach(x),f.forEach(x),this.h()},h:function(){F(t,"class","detected-frequency svelte-1datf0r"),E(t,Y,25,14,712),F(i,"class","hz-suffix svelte-1datf0r"),E(i,Y,26,14,814),F(c,"class","divider svelte-1datf0r"),E(c,Y,27,14,862),F(m,"class","detected-note svelte-1datf0r"),E(m,Y,28,14,907),F(e,"class","detection-values svelte-1datf0r"),E(e,Y,24,12,667)},m:function(v,f){_e(v,e,f),D(e,t),D(t,n),D(e,s),D(e,i),D(e,h),D(e,c),D(e,g),D(e,m),D(m,w)},p:function(v,f){f&1&&o!==(o=(v[0]>0?Math.round(v[0]):"---")+"")&&Te(n,o),f&2&&Te(w,v[1])},d:function(v){v&&x(e)}};return de("SvelteRegisterBlock",{block:l,id:mt.name,type:"else",source:"(24:10) {:else}",ctx:r}),l}function ft(r){let e,t;const o={c:function(){e=N("span"),t=Ne(r[4]),this.h()},l:function(s){e=z(s,"SPAN",{class:!0});var i=R(e);t=Ee(i,r[4]),i.forEach(x),this.h()},h:function(){F(e,"class","muted-message svelte-1datf0r"),E(e,Y,22,12,588)},m:function(s,i){_e(s,e,i),D(e,t)},p:function(s,i){i&16&&Te(t,s[4])},d:function(s){s&&x(e)}};return de("SvelteRegisterBlock",{block:o,id:ft.name,type:"if",source:"(22:10) {#if isMuted}",ctx:r}),o}function gt(r){let e,t,o="üéôÔ∏è „É™„Ç¢„É´„Çø„Ç§„É†Èü≥Á®ãÊ§úÂá∫",n,s,i,d,h,c,u,g;function m(v,f){return v[3]?ft:mt}let w=m(r),l=w(r);u=new ke({props:{volume:!r[3]&&r[0]>0?r[2]:0,className:"volume-bar"},$$inline:!0});const y={c:function(){e=N("div"),t=N("h3"),t.textContent=o,n=se(),s=N("div"),i=N("div"),d=N("div"),h=N("div"),l.c(),c=se(),rt(u.$$.fragment),this.h()},l:function(f){e=z(f,"DIV",{class:!0});var b=R(e);t=z(b,"H3",{class:!0,"data-svelte-h":!0}),ze(t)!=="svelte-1bj87i9"&&(t.textContent=o),b.forEach(x),n=ne(f),s=z(f,"DIV",{class:!0});var p=R(s);i=z(p,"DIV",{class:!0});var S=R(i);d=z(S,"DIV",{class:!0});var M=R(d);h=z(M,"DIV",{class:!0});var _=R(h);l.l(_),_.forEach(x),c=ne(M),ot(u.$$.fragment,M),M.forEach(x),S.forEach(x),p.forEach(x),this.h()},h:function(){F(t,"class","section-title svelte-1datf0r"),E(t,Y,15,4,360),F(e,"class","card-header svelte-1datf0r"),E(e,Y,14,2,330),F(h,"class","detection-card svelte-1datf0r"),E(h,Y,20,8,523),F(d,"class","detection-display svelte-1datf0r"),E(d,Y,19,6,483),F(i,"class","pitch-detector svelte-1datf0r"),E(i,Y,18,4,448),F(s,"class","card-content svelte-1datf0r"),E(s,Y,17,2,417)},m:function(f,b){_e(f,e,b),D(e,t),_e(f,n,b),_e(f,s,b),D(s,i),D(i,d),D(d,h),l.m(h,null),D(d,c),st(u,d,null),g=!0},p:function(f,b){w===(w=m(f))&&l?l.p(f,b):(l.d(1),l=w(f),l&&(l.c(),l.m(h,null)));const p={};b&13&&(p.volume=!f[3]&&f[0]>0?f[2]:0),u.$set(p)},i:function(f){g||(nt(u.$$.fragment,f),g=!0)},o:function(f){tt(u.$$.fragment,f),g=!1},d:function(f){f&&(x(e),x(n),x(s)),l.d(),et(u)}};return de("SvelteRegisterBlock",{block:y,id:gt.name,type:"slot",source:'(14:0) <Card class=\\"main-card {className}\\">',ctx:r}),y}function Xe(r){let e,t;e=new ht({props:{class:"main-card "+r[5],$$slots:{default:[gt]},$$scope:{ctx:r}},$$inline:!0});const o={c:function(){rt(e.$$.fragment)},l:function(s){ot(e.$$.fragment,s)},m:function(s,i){st(e,s,i),t=!0},p:function(s,[i]){const d={};i&32&&(d.class="main-card "+s[5]),i&95&&(d.$$scope={dirty:i,ctx:s}),e.$set(d)},i:function(s){t||(nt(e.$$.fragment,s),t=!0)},o:function(s){tt(e.$$.fragment,s),t=!1},d:function(s){et(e,s)}};return de("SvelteRegisterBlock",{block:o,id:Xe.name,type:"component",source:"",ctx:r}),o}function Et(r,e,t){let{$$slots:o={},$$scope:n}=e;$e("PitchDetectionDisplay",o,[]);let{frequency:s=0}=e,{note:i="„Éº„Éº"}=e,{volume:d=0}=e,{isMuted:h=!1}=e,{muteMessage:c="ÂæÖÊ©ü‰∏≠..."}=e,{className:u=""}=e;const g=["frequency","note","volume","isMuted","muteMessage","className"];return Object.keys(e).forEach(m=>{!~g.indexOf(m)&&m.slice(0,2)!=="$$"&&m!=="slot"&&console.warn(`<PitchDetectionDisplay> was created with unknown prop '${m}'`)}),r.$$set=m=>{"frequency"in m&&t(0,s=m.frequency),"note"in m&&t(1,i=m.note),"volume"in m&&t(2,d=m.volume),"isMuted"in m&&t(3,h=m.isMuted),"muteMessage"in m&&t(4,c=m.muteMessage),"className"in m&&t(5,u=m.className)},r.$capture_state=()=>({Card:ht,VolumeBar:ke,frequency:s,note:i,volume:d,isMuted:h,muteMessage:c,className:u}),r.$inject_state=m=>{"frequency"in m&&t(0,s=m.frequency),"note"in m&&t(1,i=m.note),"volume"in m&&t(2,d=m.volume),"isMuted"in m&&t(3,h=m.isMuted),"muteMessage"in m&&t(4,c=m.muteMessage),"className"in m&&t(5,u=m.className)},e&&"$$inject"in e&&r.$inject_state(e.$$inject),[s,i,d,h,c,u]}class kt extends Ye{constructor(e){super(e),Ze(this,e,Et,Xe,Oe,{frequency:0,note:1,volume:2,isMuted:3,muteMessage:4,className:5}),de("SvelteRegisterComponent",{component:this,tagName:"PitchDetectionDisplay",options:e,id:Xe.name})}get frequency(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set frequency(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get note(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set note(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get volume(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set volume(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get isMuted(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set isMuted(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get muteMessage(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set muteMessage(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new Error("<PitchDetectionDisplay>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(e){throw new Error("<PitchDetectionDisplay>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}export{kt as P,ke as V,Me as a,Ht as b,De as h,Ke as l};
