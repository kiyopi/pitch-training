var Ye=Object.defineProperty;var Ze=(o,e,t)=>e in o?Ye(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var W=(o,e,t)=>Ze(o,typeof e!="symbol"?e+"":e,t);import{S as Te,i as xe,s as Fe,n as ke,d as x,J as N,y as T,b as he,c as M,e as z,f as V,h as Y,j as I,k as Z,I as Oe,K as $e,C as De,m as ze,o as Ie,a as be,D as Ee,g as pe,G as Me,E as Ne,t as Ae,F as Pe,R as et,M as tt}from"./C89DxXZR.js";import"./IHki7fMi.js";import{C as st}from"./B6vuRUvI.js";function rt(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}function L(o){if(this.size=o|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=o<<1;for(var e=new Array(this.size*2),t=0;t<e.length;t+=2){const c=Math.PI*t/this.size;e[t]=Math.cos(c),e[t+1]=-Math.sin(c)}this.table=e;for(var r=0,s=1;this.size>s;s<<=1)r++;this._width=r%2===0?r-1:r,this._bitrev=new Array(1<<this._width);for(var n=0;n<this._bitrev.length;n++){this._bitrev[n]=0;for(var i=0;i<this._width;i+=2){var l=this._width-i-2;this._bitrev[n]|=(n>>>i&3)<<l}}this._out=null,this._data=null,this._inv=0}var nt=L;L.prototype.fromComplexArray=function(e,t){for(var r=t||new Array(e.length>>>1),s=0;s<e.length;s+=2)r[s>>>1]=e[s];return r};L.prototype.createComplexArray=function(){const e=new Array(this._csize);for(var t=0;t<e.length;t++)e[t]=0;return e};L.prototype.toComplexArray=function(e,t){for(var r=t||this.createComplexArray(),s=0;s<r.length;s+=2)r[s]=e[s>>>1],r[s+1]=0;return r};L.prototype.completeSpectrum=function(e){for(var t=this._csize,r=t>>>1,s=2;s<r;s+=2)e[t-s]=e[s],e[t-s+1]=-e[s+1]};L.prototype.transform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._transform4(),this._out=null,this._data=null};L.prototype.realTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._realTransform4(),this._out=null,this._data=null};L.prototype.inverseTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=1,this._transform4();for(var r=0;r<e.length;r++)e[r]/=this.size;this._out=null,this._data=null};L.prototype._transform4=function(){var e=this._out,t=this._csize,r=this._width,s=1<<r,n=t/s<<1,i,l,c=this._bitrev;if(n===4)for(i=0,l=0;i<t;i+=n,l++){const h=c[l];this._singleTransform2(i,h,s)}else for(i=0,l=0;i<t;i+=n,l++){const h=c[l];this._singleTransform4(i,h,s)}var a=this._inv?-1:1,g=this.table;for(s>>=2;s>=2;s>>=2){n=t/s<<1;var d=n>>>2;for(i=0;i<t;i+=n)for(var m=i+d,f=i,u=0;f<m;f+=2,u+=s){const h=f,_=h+d,y=_+d,A=y+d,C=e[h],b=e[h+1],S=e[_],w=e[_+1],F=e[y],E=e[y+1],k=e[A],G=e[A+1],q=C,U=b,H=g[u],O=a*g[u+1],K=S*H-w*O,J=S*O+w*H,ee=g[2*u],j=a*g[2*u+1],te=F*ee-E*j,oe=F*j+E*ee,ae=g[3*u],ie=a*g[3*u+1],se=k*ae-G*ie,le=k*ie+G*ae,v=q+te,p=U+oe,D=q-te,R=U-oe,P=K+se,Q=J+le,re=a*(K-se),ne=a*(J-le),de=v+P,ge=p+Q,X=v-P,fe=p-Q,ve=D+ne,me=R-re,B=D-ne,ce=R+re;e[h]=de,e[h+1]=ge,e[_]=ve,e[_+1]=me,e[y]=X,e[y+1]=fe,e[A]=B,e[A+1]=ce}}};L.prototype._singleTransform2=function(e,t,r){const s=this._out,n=this._data,i=n[t],l=n[t+1],c=n[t+r],a=n[t+r+1],g=i+c,d=l+a,m=i-c,f=l-a;s[e]=g,s[e+1]=d,s[e+2]=m,s[e+3]=f};L.prototype._singleTransform4=function(e,t,r){const s=this._out,n=this._data,i=this._inv?-1:1,l=r*2,c=r*3,a=n[t],g=n[t+1],d=n[t+r],m=n[t+r+1],f=n[t+l],u=n[t+l+1],h=n[t+c],_=n[t+c+1],y=a+f,A=g+u,C=a-f,b=g-u,S=d+h,w=m+_,F=i*(d-h),E=i*(m-_),k=y+S,G=A+w,q=C+E,U=b-F,H=y-S,O=A-w,K=C-E,J=b+F;s[e]=k,s[e+1]=G,s[e+2]=q,s[e+3]=U,s[e+4]=H,s[e+5]=O,s[e+6]=K,s[e+7]=J};L.prototype._realTransform4=function(){var e=this._out,t=this._csize,r=this._width,s=1<<r,n=t/s<<1,i,l,c=this._bitrev;if(n===4)for(i=0,l=0;i<t;i+=n,l++){const we=c[l];this._singleRealTransform2(i,we>>>1,s>>>1)}else for(i=0,l=0;i<t;i+=n,l++){const we=c[l];this._singleRealTransform4(i,we>>>1,s>>>1)}var a=this._inv?-1:1,g=this.table;for(s>>=2;s>=2;s>>=2){n=t/s<<1;var d=n>>>1,m=d>>>1,f=m>>>1;for(i=0;i<t;i+=n)for(var u=0,h=0;u<=f;u+=2,h+=s){var _=i+u,y=_+m,A=y+m,C=A+m,b=e[_],S=e[_+1],w=e[y],F=e[y+1],E=e[A],k=e[A+1],G=e[C],q=e[C+1],U=b,H=S,O=g[h],K=a*g[h+1],J=w*O-F*K,ee=w*K+F*O,j=g[2*h],te=a*g[2*h+1],oe=E*j-k*te,ae=E*te+k*j,ie=g[3*h],se=a*g[3*h+1],le=G*ie-q*se,v=G*se+q*ie,p=U+oe,D=H+ae,R=U-oe,P=H-ae,Q=J+le,re=ee+v,ne=a*(J-le),de=a*(ee-v),ge=p+Q,X=D+re,fe=R+de,ve=P-ne;if(e[_]=ge,e[_+1]=X,e[y]=fe,e[y+1]=ve,u===0){var me=p-Q,B=D-re;e[A]=me,e[A+1]=B;continue}if(u!==f){var ce=R,Be=-P,qe=p,Le=-D,Ge=-a*de,We=-a*ne,Ue=-a*re,Qe=-a*Q,Ke=ce+Ge,Je=Be+We,je=qe+Qe,Xe=Le-Ue,He=i+m-u,Ve=i+d-u;e[He]=Ke,e[He+1]=Je,e[Ve]=je,e[Ve+1]=Xe}}}};L.prototype._singleRealTransform2=function(e,t,r){const s=this._out,n=this._data,i=n[t],l=n[t+r],c=i+l,a=i-l;s[e]=c,s[e+1]=0,s[e+2]=a,s[e+3]=0};L.prototype._singleRealTransform4=function(e,t,r){const s=this._out,n=this._data,i=this._inv?-1:1,l=r*2,c=r*3,a=n[t],g=n[t+r],d=n[t+l],m=n[t+c],f=a+d,u=a-d,h=g+m,_=i*(g-m),y=f+h,A=u,C=-_,b=f-h,S=u,w=_;s[e]=y,s[e+1]=0,s[e+2]=A,s[e+3]=C,s[e+4]=b,s[e+5]=0,s[e+6]=S,s[e+7]=w};const ot=rt(nt);class ye{constructor(e,t){W(this,"_inputLength");W(this,"_fft");W(this,"_bufferSupplier");W(this,"_paddedInputBuffer");W(this,"_transformBuffer");W(this,"_inverseBuffer");if(e<1)throw new Error("Input length must be at least one");this._inputLength=e,this._fft=new ot(lt(2*e)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(e){return new ye(e,t=>new Float32Array(t))}static forFloat64Array(e){return new ye(e,t=>new Float64Array(t))}static forNumberArray(e){return new ye(e,t=>Array(t))}get inputLength(){return this._inputLength}autocorrelate(e,t=this._bufferSupplier(e.length)){if(e.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${e.length}`);for(let s=0;s<e.length;s++)this._paddedInputBuffer[s]=e[s];for(let s=e.length;s<this._paddedInputBuffer.length;s++)this._paddedInputBuffer[s]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const r=this._transformBuffer;for(let s=0;s<r.length;s+=2)r[s]=r[s]*r[s]+r[s+1]*r[s+1],r[s+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let s=0;s<e.length;s++)t[s]=this._inverseBuffer[2*s];return t}}function at(o){const e=[];let t=!1,r=-1/0,s=-1;for(let n=1;n<o.length-1;n++)o[n-1]<=0&&o[n]>0?(t=!0,s=n,r=o[n]):o[n-1]>0&&o[n]<=0?(t=!1,s!==-1&&e.push(s)):t&&o[n]>r&&(r=o[n],s=n);return e}function it(o,e){const[t,r,s]=[o-1,o,o+1],[n,i,l]=[e[t],e[r],e[s]],c=n/2-i+l/2,a=-(n/2)*(r+s)+i*(t+s)-l/2*(t+r),g=n*r*s/2-i*t*s+l*t*r/2,d=-a/(2*c),m=c*d*d+a*d+g;return[d,m]}class _e{constructor(e,t){W(this,"_autocorrelator");W(this,"_nsdfBuffer");W(this,"_clarityThreshold",.9);W(this,"_minVolumeAbsolute",0);W(this,"_maxInputAmplitude",1);this._autocorrelator=new ye(e,t),this._nsdfBuffer=t(e)}static forFloat32Array(e){return new _e(e,t=>new Float32Array(t))}static forFloat64Array(e){return new _e(e,t=>new Float64Array(t))}static forNumberArray(e){return new _e(e,t=>Array(t))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(e){if(!Number.isFinite(e)||e<=0||e>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=e}set minVolumeAbsolute(e){if(!Number.isFinite(e)||e<0||e>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=e}set minVolumeDecibels(e){if(!Number.isFinite(e)||e>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(e/10)}set maxInputAmplitude(e){if(!Number.isFinite(e)||e<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=e}findPitch(e,t){if(this._belowMinimumVolume(e))return[0,0];this._nsdf(e);const r=at(this._nsdfBuffer);if(r.length===0)return[0,0];const s=Math.max(...r.map(c=>this._nsdfBuffer[c])),n=r.find(c=>this._nsdfBuffer[c]>=this._clarityThreshold*s),[i,l]=it(n,this._nsdfBuffer);return[t/i,Math.min(l,1)]}_belowMinimumVolume(e){if(this._minVolumeAbsolute===0)return!1;let t=0;for(let r=0;r<e.length;r++)t+=e[r]**2;return Math.sqrt(t/e.length)<this._minVolumeAbsolute}_nsdf(e){this._autocorrelator.autocorrelate(e,this._nsdfBuffer);let t=2*this._nsdfBuffer[0],r;for(r=0;r<this._nsdfBuffer.length&&t>0;r++)this._nsdfBuffer[r]=2*this._nsdfBuffer[r]/t,t-=e[r]**2+e[e.length-r-1]**2;for(;r<this._nsdfBuffer.length;r++)this._nsdfBuffer[r]=0}}function lt(o){return o--,o|=o>>1,o|=o>>2,o|=o>>4,o|=o>>8,o|=o>>16,o++,o}function ct(o){let e,t,r,s,n,i;return{c(){e=I("div"),t=I("div"),r=I("div"),s=Z(),n=I("div"),this.h()},l(l){e=z(l,"DIV",{class:!0});var c=V(e);t=z(c,"DIV",{class:!0,style:!0});var a=V(t);r=z(a,"DIV",{class:!0,style:!0}),V(r).forEach(x),a.forEach(x),s=Y(c),n=z(c,"DIV",{class:!0,style:!0}),V(n).forEach(x),c.forEach(x),this.h()},h(){T(r,"class","volume-bar-fill"),N(r,"position","absolute"),N(r,"top","0"),N(r,"left","0"),N(r,"height","100%"),T(t,"class","volume-bar-bg"),N(t,"height",o[1]),N(t,"border-radius","9999px"),N(t,"background-color","#e2e8f0"),N(t,"position","relative"),N(t,"overflow","hidden"),T(n,"class","threshold-indicator svelte-13z7ppf"),N(n,"position","absolute"),N(n,"top","0"),N(n,"left",o[0]+"%"),N(n,"width","2px"),N(n,"height",o[1]),N(n,"background-color","#64748b"),N(n,"border-radius","1px"),T(e,"class",i="volume-bar-container "+o[2]+" svelte-13z7ppf")},m(l,c){he(l,e,c),M(e,t),M(t,r),o[5](r),M(e,s),M(e,n)},p(l,[c]){c&2&&N(t,"height",l[1]),c&1&&N(n,"left",l[0]+"%"),c&2&&N(n,"height",l[1]),c&4&&i!==(i="volume-bar-container "+l[2]+" svelte-13z7ppf")&&T(e,"class",i)},i:ke,o:ke,d(l){l&&x(e),o[5](null)}}}function ut(o,e,t){let{volume:r=0}=e,{threshold:s=30}=e,{height:n="12px"}=e,{className:i=""}=e,l;function c(d){return d<s?`rgba(37, 99, 235, ${Math.max(.2,d/s*.8)})`:"#2563eb"}function a(d){if(l){const m=Math.max(0,Math.min(100,d)),f=c(m);t(3,l.style.width=`${m}%`,l),t(3,l.style.backgroundColor=f,l)}}Oe(()=>{l&&(t(3,l.style.width="0%",l),t(3,l.style.backgroundColor="#2563eb",l),t(3,l.style.height=n,l),t(3,l.style.borderRadius="9999px",l),t(3,l.style.transition="width 0.2s ease-out, background-color 0.2s ease-out",l))});function g(d){$e[d?"unshift":"push"](()=>{l=d,t(3,l)})}return o.$$set=d=>{"volume"in d&&t(4,r=d.volume),"threshold"in d&&t(0,s=d.threshold),"height"in d&&t(1,n=d.height),"className"in d&&t(2,i=d.className)},o.$$.update=()=>{o.$$.dirty&16&&a(r)},[s,n,i,l,r,g]}class Re extends Te{constructor(e){super(),xe(this,e,ut,ct,Fe,{volume:4,threshold:0,height:1,className:2})}}class ht{constructor(){this.audioContext=null,this.mediaStream=null,this.sourceNode=null,this.analysers=new Map,this.filters=new Map,this.refCount=0,this.initPromise=null,this.isInitialized=!1,this.lastError=null}async initialize(){var e,t,r;if(this.initPromise)return this.initPromise;if(this.isInitialized&&this.audioContext&&this.mediaStream){const s=this.checkMediaStreamHealth();if(s.healthy)return this.refCount++,{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode};console.warn("⚠️ [AudioManager] MediaStream不健康検出 - 強制再初期化:",s.reason),console.log("🔄 [AudioManager] 不健康なMediaStream詳細:",{mediaStreamActive:(e=this.mediaStream)==null?void 0:e.active,trackCount:(t=this.mediaStream)==null?void 0:t.getTracks().length,trackStates:(r=this.mediaStream)==null?void 0:r.getTracks().map(n=>({kind:n.kind,readyState:n.readyState,enabled:n.enabled,muted:n.muted}))}),this._cleanup(),this.isInitialized=!1,this.refCount=0,await new Promise(n=>setTimeout(n,100)),console.log("🔄 [AudioManager] クリーンアップ完了 - 再初期化開始")}this.initPromise=this._doInitialize();try{const s=await this.initPromise;return this.initPromise=null,s}catch(s){throw this.initPromise=null,s}}async _doInitialize(){try{if(console.log("🎤 [AudioManager] 初期化開始"),this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),console.log("✅ [AudioManager] AudioContext作成完了")),this.audioContext.state==="suspended"&&(await this.audioContext.resume(),console.log("✅ [AudioManager] AudioContext再開完了")),!this.mediaStream){const e={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,sampleRate:44100,channelCount:1,sampleSize:16,latency:.1,volume:1,deviceId:{ideal:"default"}}};console.log("🎤 [AudioManager] Safari対応設定でMediaStream取得中:",e),this.mediaStream=await navigator.mediaDevices.getUserMedia(e),console.log("✅ [AudioManager] MediaStream取得完了")}if(!this.sourceNode){this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),console.log("✅ [AudioManager] SourceNode作成完了");const e=this.mediaStream.getTracks();console.log("🎤 [AudioManager] MediaStream tracks:",e.map(t=>({kind:t.kind,label:t.label,enabled:t.enabled,readyState:t.readyState,muted:t.muted})))}return this.isInitialized=!0,this.refCount++,this.lastError=null,console.log(`🎤 [AudioManager] 初期化完了 (参照カウント: ${this.refCount})`),{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode}}catch(e){throw console.error("❌ [AudioManager] 初期化エラー:",e),this.lastError=e,this.isInitialized=!1,this._cleanup(),e}}createAnalyser(e,t={}){if(!this.isInitialized||!this.audioContext||!this.sourceNode)throw new Error("AudioManager not initialized. Call initialize() first.");this.removeAnalyser(e);const{fftSize:r=2048,smoothingTimeConstant:s=.8,minDecibels:n=-90,maxDecibels:i=-10,useFilters:l=!0}=t,c=this.audioContext.createAnalyser();if(c.fftSize=Math.min(r,2048),c.smoothingTimeConstant=Math.max(s,.7),c.minDecibels=Math.max(n,-80),c.maxDecibels=Math.min(i,-10),this.sourceNode,l){const a=this._createFilterChain();this.filters.set(e,a),this.sourceNode.connect(a.highpass),a.highpass.connect(a.lowpass),a.lowpass.connect(a.notch),a.notch.connect(c),console.log(`🔧 [AudioManager] フィルター付きAnalyser作成: ${e}`)}else this.sourceNode.connect(c),console.log(`🔧 [AudioManager] 生信号Analyser作成: ${e}`);return this.analysers.set(e,c),c}_createFilterChain(){const e=this.audioContext.createBiquadFilter();e.type="highpass",e.frequency.setValueAtTime(80,this.audioContext.currentTime),e.Q.setValueAtTime(.7,this.audioContext.currentTime);const t=this.audioContext.createBiquadFilter();t.type="lowpass",t.frequency.setValueAtTime(800,this.audioContext.currentTime),t.Q.setValueAtTime(.7,this.audioContext.currentTime);const r=this.audioContext.createBiquadFilter();return r.type="notch",r.frequency.setValueAtTime(60,this.audioContext.currentTime),r.Q.setValueAtTime(10,this.audioContext.currentTime),{highpass:e,lowpass:t,notch:r}}removeAnalyser(e){if(this.analysers.has(e)&&(this.analysers.get(e).disconnect(),this.analysers.delete(e),console.log(`🗑️ [AudioManager] Analyser削除: ${e}`)),this.filters.has(e)){const t=this.filters.get(e);t.highpass.disconnect(),t.lowpass.disconnect(),t.notch.disconnect(),this.filters.delete(e),console.log(`🗑️ [AudioManager] フィルターチェーン削除: ${e}`)}}release(e=[]){e.forEach(t=>this.removeAnalyser(t)),this.refCount=Math.max(0,this.refCount-1),console.log(`📉 [AudioManager] 参照カウント減算: ${this.refCount}`),this.refCount<=0&&(console.log("🧹 [AudioManager] 全リソースクリーンアップ開始"),this._cleanup())}forceCleanup(){console.log("🚨 [AudioManager] 強制クリーンアップ実行"),this._cleanup()}_cleanup(){console.log("🧹 [AudioManager] クリーンアップ開始");for(const e of this.analysers.keys())this.removeAnalyser(e);if(this.mediaStream){const e=this.mediaStream.getTracks();console.log(`🛑 [AudioManager] MediaStream停止中: ${e.length} tracks`),e.forEach((t,r)=>{try{t.readyState!=="ended"?(t.stop(),console.log(`🛑 [AudioManager] Track ${r} 停止完了`)):console.log(`⚠️ [AudioManager] Track ${r} 既に終了済み`)}catch(s){console.warn(`⚠️ [AudioManager] Track ${r} 停止エラー:`,s)}}),this.mediaStream=null}if(this.audioContext&&this.audioContext.state!=="closed"){try{this.audioContext.close(),console.log("🛑 [AudioManager] AudioContext閉鎖完了")}catch(e){console.warn("⚠️ [AudioManager] AudioContext閉鎖エラー:",e)}this.audioContext=null}this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.isInitialized=!1,this.refCount=0,this.initPromise=null,console.log("✅ [AudioManager] クリーンアップ完了")}getStatus(){var e,t;return{isInitialized:this.isInitialized,refCount:this.refCount,audioContextState:((e=this.audioContext)==null?void 0:e.state)||"none",mediaStreamActive:((t=this.mediaStream)==null?void 0:t.active)||!1,activeAnalysers:Array.from(this.analysers.keys()),activeFilters:Array.from(this.filters.keys()),lastError:this.lastError}}checkMediaStreamHealth(){if(!this.mediaStream)return{healthy:!1,reason:"MediaStream not initialized"};if(!this.mediaStream.active)return{healthy:!1,reason:"MediaStream inactive"};const e=this.mediaStream.getTracks();if(e.length===0)return{healthy:!1,reason:"No tracks available"};const t=e.find(r=>r.kind==="audio");return t?t.readyState==="ended"?{healthy:!1,reason:"Audio track ended"}:t.enabled?t.muted?{healthy:!1,reason:"Audio track muted"}:this.mediaStream.active&&t.readyState!=="live"?{healthy:!1,reason:"Track state inconsistent with MediaStream"}:{healthy:!0,track:t}:{healthy:!1,reason:"Audio track disabled"}:{healthy:!1,reason:"No audio track found"}}}const Ce=new ht;class dt{constructor(e={}){this.vocalRangeMin=e.vocalRangeMin||130.81,this.vocalRangeMax=e.vocalRangeMax||1046.5,this.stabilityThreshold=e.stabilityThreshold||.3,this.evaluationWeights={vocalRange:e.vocalRangeWeight||.4,continuity:e.continuityWeight||.4,musical:e.musicalWeight||.2},this.fundamentalCandidates=e.fundamentalCandidates||[1,.5,.333,2],this.harmonicHistory=[],this.previousFrequency=0,this.maxHistoryLength=5,this.debugMode=!1,this.volumeThreshold=e.volumeThreshold||.02,this.currentContext={}}correctHarmonic(e,t=1,r=!1){if(!e||e<=0)return 0;const s=t>=this.volumeThreshold,i=this.fundamentalCandidates.map(a=>({frequency:e*a,ratio:a})).map(a=>{const g=this.evaluateFundamental(a.frequency);return{...a,...g}}),l=i.reduce((a,g)=>g.totalScore>a.totalScore?g:a),c=this.stabilizeFrequency(l.frequency,s);return(r||this.debugMode)&&this.logHarmonicCorrection(e,i,l,c,this.currentContext,t,s),s&&(this.previousFrequency=c),c}logHarmonicCorrection(e,t,r,s,n={},i=1,l=!0){console.group(`🔧 [HarmonicCorrection] ${e.toFixed(1)}Hz → ${s.toFixed(1)}Hz`),console.log(`🔊 音量: ${(i*100).toFixed(1)}% (閾値: ${(this.volumeThreshold*100).toFixed(1)}%) ${l?"✅ 有効":"❌ ノイズ除外"}`);const c=this.frequencyToNote(e),a=this.frequencyToNote(s);console.log(`📝 音程変換: ${c} → ${a}`);const g=this.getCorrectionType(r.ratio);if(console.log(`🎯 補正タイプ: ${g}`),n.baseFrequency&&n.currentScale&&n.targetFrequency){console.log("🎵 音階コンテキスト:"),console.log(`   基音: ${n.baseFrequency.toFixed(1)}Hz (${this.frequencyToNote(n.baseFrequency)})`),console.log(`   現在の音階: ${n.currentScale}`),console.log(`   目標周波数: ${n.targetFrequency.toFixed(1)}Hz (${this.frequencyToNote(n.targetFrequency)})`);const m=s-n.targetFrequency,f=1200*Math.log2(s/n.targetFrequency);console.log(`   目標との差: ${m>0?"+":""}${m.toFixed(1)}Hz (${f>0?"+":""}${f.toFixed(0)}セント)`);const u=Math.abs(f)<=50?"🎯 高精度":Math.abs(f)<=100?"✅ 良好":Math.abs(f)<=200?"⚠️ 要改善":"❌ 不正確";console.log(`   精度評価: ${u} (${Math.abs(f).toFixed(0)}セント差)`)}console.table(t.map(m=>({倍率:`${m.ratio.toFixed(3)}x`,周波数:`${m.frequency.toFixed(1)}Hz`,音名:this.frequencyToNote(m.frequency),音域:m.vocalRangeScore.toFixed(2),連続性:m.continuityScore.toFixed(2),音楽性:m.musicalScore.toFixed(2),総合:m.totalScore.toFixed(3),選択:m===r?"✅":""})));const d=Math.abs(s-r.frequency);d>.5&&console.log(`🔄 安定化: ${r.frequency.toFixed(1)}Hz → ${s.toFixed(1)}Hz (${d.toFixed(1)}Hz調整)`),console.groupEnd()}getCorrectionType(e){return Math.abs(e-1)<.01?"補正なし（基音）":Math.abs(e-.5)<.01?"2倍音補正（1オクターブ下）":Math.abs(e-.333)<.01?"3倍音補正（1オクターブ+5度下）":Math.abs(e-.25)<.01?"4倍音補正（2オクターブ下）":Math.abs(e-2)<.01?"オクターブ上補正":`カスタム補正（${e.toFixed(3)}x）`}frequencyToNote(e){if(!e||e<=0)return"---";const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],s=Math.round(12*Math.log2(e/440)),n=(s+9+120)%12,i=Math.floor((s+9)/12)+4;return t[n]+i}evaluateFundamental(e){const r=e>=this.vocalRangeMin&&e<=this.vocalRangeMax?1:0,s=this.previousFrequency>0?1-Math.min(Math.abs(e-this.previousFrequency)/this.previousFrequency,1):.5,n=this.calculateMusicalScore(e),i=r*this.evaluationWeights.vocalRange+s*this.evaluationWeights.continuity+n*this.evaluationWeights.musical;return{vocalRangeScore:r,continuityScore:s,musicalScore:n,totalScore:i}}calculateMusicalScore(e){const r=Math.log2(e/261.63)*12,s=Math.round(r),n=Math.abs(r-s);return Math.max(0,1-n/.5)}stabilizeFrequency(e,t=!0){if(!e||e<=0)return 0;if(t&&this.harmonicHistory.push(e),this.harmonicHistory.length>this.maxHistoryLength&&this.harmonicHistory.shift(),this.harmonicHistory.length<2)return e;const r=[...this.harmonicHistory].sort((l,c)=>l-c),s=r[Math.floor(r.length/2)],n=s*this.stabilityThreshold;return Math.abs(e-s)>n?s+Math.sign(e-s)*n:e}resetHistory(){this.harmonicHistory=[],this.previousFrequency=0}updateConfig(e){Object.assign(this,e),console.log("⚙️ [HarmonicCorrection] 設定更新:",e)}enableDebugLogging(){this.debugMode=!0,console.log("🔍 [HarmonicCorrection] デバッグログ有効化 - 次回の補正から詳細ログを出力します"),console.log("無効化するには: harmonicCorrection.disableDebugLogging()")}disableDebugLogging(){this.debugMode=!1,console.log("🔍 [HarmonicCorrection] デバッグログ無効化")}setScaleContext(e){this.currentContext={baseFrequency:e.baseFrequency,currentScale:e.currentScale,targetFrequency:e.targetFrequency}}clearContext(){this.currentContext={}}getStatus(){return{vocalRangeMin:this.vocalRangeMin,vocalRangeMax:this.vocalRangeMax,stabilityThreshold:this.stabilityThreshold,evaluationWeights:this.evaluationWeights,historyLength:this.harmonicHistory.length,previousFrequency:this.previousFrequency,recentHistory:this.harmonicHistory.slice(-3)}}}const Se=new dt,ft=(()=>{if(typeof import.meta<"u")return"error";if(typeof window<"u"){const e=new URLSearchParams(window.location.search).get("debug");if(e)return e}return"info"})(),$={error:0,warn:1,info:2,debug:3},ue=$[ft]??$.info,mt={error:(o,...e)=>{ue>=$.error&&console.error(`❌ ${o}`,...e)},warn:(o,...e)=>{ue>=$.warn&&console.warn(`⚠️ ${o}`,...e)},info:(o,...e)=>{ue>=$.info&&console.log(`ℹ️ ${o}`,...e)},debug:(o,...e)=>{ue>=$.debug&&console.log(`🔍 ${o}`,...e)},realtime:(()=>{let o=0;const e=1e3;return(t,...r)=>{if(ue>=$.debug){const s=Date.now();s-o>=e&&(console.log(`📊 ${t}`,...r),o=s)}}})(),scoring:(o,...e)=>{ue>=$.info&&console.log(`🎯 ${o}`,...e)},audio:(o,...e)=>{ue>=$.info&&console.log(`🎤 ${o}`,...e)}};function gt(o){let e,t,r,s,n=(o[2]>0?Math.round(o[2]):"---")+"",i,l,c,a="Hz",g,d,m="|",f,u,h,_,y,A,C;return y=new Re({props:{volume:o[2]>0?o[1]:0,className:"volume-bar"}}),{c(){e=I("div"),t=I("div"),r=I("div"),s=I("span"),i=Ae(n),l=Z(),c=I("span"),c.textContent=a,g=Z(),d=I("span"),d.textContent=m,f=Z(),u=I("span"),h=Ae(o[3]),_=Z(),Pe(y.$$.fragment),this.h()},l(b){e=z(b,"DIV",{class:!0});var S=V(e);t=z(S,"DIV",{class:!0});var w=V(t);r=z(w,"DIV",{class:!0});var F=V(r);s=z(F,"SPAN",{class:!0});var E=V(s);i=pe(E,n),E.forEach(x),l=Y(F),c=z(F,"SPAN",{class:!0,"data-svelte-h":!0}),Me(c)!=="svelte-5uyilv"&&(c.textContent=a),g=Y(F),d=z(F,"SPAN",{class:!0,"data-svelte-h":!0}),Me(d)!=="svelte-1dytxz4"&&(d.textContent=m),f=Y(F),u=z(F,"SPAN",{class:!0});var k=V(u);h=pe(k,o[3]),k.forEach(x),F.forEach(x),_=Y(w),Ne(y.$$.fragment,w),w.forEach(x),S.forEach(x),this.h()},h(){T(s,"class","detected-frequency svelte-vc1bho"),T(c,"class","hz-suffix svelte-vc1bho"),T(d,"class","divider svelte-vc1bho"),T(u,"class","detected-note svelte-vc1bho"),T(r,"class","detection-card svelte-vc1bho"),T(t,"class","detection-display svelte-vc1bho"),T(e,"class",A="pitch-detector "+o[0]+" svelte-vc1bho")},m(b,S){he(b,e,S),M(e,t),M(t,r),M(r,s),M(s,i),M(r,l),M(r,c),M(r,g),M(r,d),M(r,f),M(r,u),M(u,h),M(t,_),Ee(y,t,null),C=!0},p(b,S){(!C||S[0]&4)&&n!==(n=(b[2]>0?Math.round(b[2]):"---")+"")&&be(i,n),(!C||S[0]&8)&&be(h,b[3]);const w={};S[0]&6&&(w.volume=b[2]>0?b[1]:0),y.$set(w),(!C||S[0]&1&&A!==(A="pitch-detector "+b[0]+" svelte-vc1bho"))&&T(e,"class",A)},i(b){C||(Ie(y.$$.fragment,b),C=!0)},o(b){ze(y.$$.fragment,b),C=!1},d(b){b&&x(e),De(y)}}}function vt(o){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(o<=0)return"ーー";const r=Math.round(12*Math.log2(o/440)),s=(r+9+120)%12,n=Math.floor((r+9)/12)+4;return e[s]+n}function yt(o,e,t){const r=et();let{isActive:s=!1}=e,{className:n=""}=e,{debugMode:i=!1}=e,{trainingPhase:l=""}=e,{disableHarmonicCorrection:c=!1}=e,a="uninitialized",g=null,d=!1,m=null,f=null,u=null,h=null,_=null,y=null,A=null,C=!1,b=[],S=new Map,w=0,F=0,E=0,k="ーー",G=0,q=[],U=0,H=null;function O(){w=0,t(1,F=0),t(2,E=0),t(3,k="ーー"),G=0,U=0,q=[],Se.resetHistory(),i&&console.log("🔄 [PitchDetector] Display state reset")}function K(){if(!i)return;const v=new Date().toLocaleTimeString(),p={timestamp:v,componentState:a,isActive:s,isDetecting:C,isInitialized:d,mediaStreamActive:f?f.active:null,mediaStreamTracks:f?f.getTracks().length:0,trackStates:f?f.getTracks().map(P=>({kind:P.kind,enabled:P.enabled,readyState:P.readyState,muted:P.muted})):[],audioContextState:m?m.state:null,hasAnalyser:!!h,currentVolume:w,currentFrequency:E};mt.realtime(`[PitchDetector] ${v}:`,p);let D=!0,R=[];f&&!f.active&&(console.warn("⚠️ [PitchDetector] MediaStream is inactive!",f),D=!1,R.push("MediaStream inactive")),m&&m.state==="suspended"&&(console.warn("⚠️ [PitchDetector] AudioContext is suspended!",m),D=!1,R.push("AudioContext suspended")),f&&f.getTracks().forEach((P,Q)=>{P.readyState==="ended"&&(console.error(`❌ [PitchDetector] Track ${Q} has ended!`,P),D=!1,R.push(`Track ${Q} ended`))}),r("microphoneHealthChange",{healthy:D,errors:R,details:p})}async function J(){try{t(16,a="initializing"),g=null,console.log("🎙️ [PitchDetector] AudioManager経由で初期化開始");const v=await Ce.initialize();m=v.audioContext,f=v.mediaStream,u=v.sourceNode,console.log("✅ [PitchDetector] AudioManager リソース取得完了");const p=`pitch-detector-filtered-${Date.now()}`;t(17,h=Ce.createAnalyser(p,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!0})),b.push(p);const D=`pitch-detector-raw-${Date.now()}`;_=Ce.createAnalyser(D,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!1}),b.push(D),console.log("✅ [PitchDetector] Analyser作成完了:",b),y=_e.forFloat32Array(h.fftSize),t(16,a="ready"),d=!0,r("stateChange",{state:a}),le(),console.log("✅ [PitchDetector] 初期化完了")}catch(v){throw console.error("❌ [PitchDetector] 初期化エラー:",v),t(16,a="error"),g=v,d=!1,r("error",{error:v,context:"initialization"}),v}}function ee(){if(a!=="ready"){const v=new Error(`Cannot start detection: component state is ${a}`);return r("error",{error:v,context:"start-detection"}),!1}if(!h||!y||!m){const v=new Error("Required components not available");return t(16,a="error"),r("error",{error:v,context:"start-detection"}),!1}return t(16,a="detecting"),t(18,C=!0),r("stateChange",{state:a}),te(),!0}function j(){t(18,C=!1),A&&(cancelAnimationFrame(A),A=null),a==="detecting"&&d&&(t(16,a="ready"),r("stateChange",{state:a}))}function te(){if(!C||!h||!_||!y)return;const v=h.fftSize,p=new Float32Array(v),D=new Float32Array(_.fftSize);h.getFloatTimeDomainData(p),_.getFloatTimeDomainData(D);let R=0;for(let B=0;B<v;B++)R+=Math.abs(p[B]);const P=Math.sqrt(R/v),Q=Math.log10(P+.001)*50+100,re=Math.max(0,Math.min(100,Q));let ne=0;for(let B=0;B<D.length;B++)ne+=Math.abs(D[B]);const de=Math.sqrt(ne/D.length),ge=Math.log10(de+.001)*50+100;t(1,F=Math.max(0,Math.min(100,ge))),q.push(re),q.length>5&&q.shift(),U=q.reduce((B,ce)=>B+ce,0)/q.length,w=U;const[X,fe]=y.findPitch(p,m.sampleRate),ve=X>=65&&X<=1200;if(X&&fe>.8&&w>30&&ve){let B=X;if(c)i&&console.log("🔧 [PitchDetector] ハーモニック補正無効化中 - 生値使用:",X);else{const ce=Math.min(w/100,1);B=Se.correctHarmonic(X,ce)}t(2,E=Math.round(B)),t(3,k=vt(E)),G=fe}else E===0&&Se.resetHistory(),t(2,E=0),t(3,k="ーー"),G=0;const me=E>0?F:0;r("pitchUpdate",{frequency:E,note:k,volume:me,rawVolume:me,clarity:G}),A=requestAnimationFrame(te)}function oe(){return d&&a==="ready"}function ae(){return{componentState:a,isInitialized:d,isDetecting:C,lastError:g,hasRequiredComponents:!!(h&&y&&m&&f)}}async function ie(){console.log("🔄 [PitchDetector] 再初期化開始"),se(),await new Promise(v=>setTimeout(v,100)),await J(),console.log("✅ [PitchDetector] 再初期化完了")}function se(){console.log("🧹 [PitchDetector] クリーンアップ開始"),j(),S.size>0&&(S.forEach((v,p)=>{p.removeEventListener("ended",v.endedHandler),p.removeEventListener("mute",v.muteHandler),p.removeEventListener("unmute",v.unmuteHandler)}),S.clear(),console.log("🔄 [PitchDetector] MediaStreamイベントリスナー削除")),b.length>0&&(Ce.release(b),console.log("📤 [PitchDetector] AudioManagerにAnalyser解放通知:",b),b=[]),t(16,a="uninitialized"),d=!1,g=null,m=null,f=null,u=null,t(17,h=null),_=null,y=null,q=[],Se.resetHistory(),console.log("✅ [PitchDetector] クリーンアップ完了")}function le(){if(!f)return;const v=f.getTracks();v.forEach(p=>{const D=()=>{console.error("🚨 [PitchDetector] MediaStreamTrack終了検出:",p.kind),t(16,a="error"),g=new Error(`MediaStreamTrack (${p.kind}) ended`),r("error",{error:g,reason:"mediastream_ended",recovery:"restart_required"}),C&&j()},R=()=>{console.warn("⚠️ [PitchDetector] MediaStreamTrack muted:",p.kind),r("warning",{reason:"track_muted",track:p.kind})},P=()=>{console.log("✅ [PitchDetector] MediaStreamTrack unmuted:",p.kind),r("info",{reason:"track_unmuted",track:p.kind})};p.addEventListener("ended",D),p.addEventListener("mute",R),p.addEventListener("unmute",P),S.set(p,{endedHandler:D,muteHandler:R,unmuteHandler:P})}),console.log("🔍 [PitchDetector] MediaStream監視開始:",v.length+" tracks")}return tt(()=>{H&&(clearInterval(H),t(19,H=null)),console.log("🔄 [PitchDetector] onDestroy - AudioManagerリソースは保持")}),o.$$set=v=>{"isActive"in v&&t(4,s=v.isActive),"className"in v&&t(0,n=v.className),"debugMode"in v&&t(5,i=v.debugMode),"trainingPhase"in v&&t(6,l=v.trainingPhase),"disableHarmonicCorrection"in v&&t(7,c=v.disableHarmonicCorrection)},o.$$.update=()=>{o.$$.dirty[0]&524320&&(i&&!H?(console.log("🔍 [PitchDetector] Debug mode enabled - starting status monitoring"),t(19,H=setInterval(K,3e3)),K()):!i&&H&&(console.log("🔍 [PitchDetector] Debug mode disabled - stopping status monitoring"),clearInterval(H),t(19,H=null))),o.$$.dirty[0]&458768&&(s&&a==="ready"&&h&&!C?ee():!s&&C&&j())},[n,F,E,k,s,i,l,c,O,J,ee,j,oe,ae,ie,se,a,h,C,H]}class xt extends Te{constructor(e){super(),xe(this,e,yt,gt,Fe,{isActive:4,className:0,debugMode:5,trainingPhase:6,disableHarmonicCorrection:7,resetDisplayState:8,initialize:9,startDetection:10,stopDetection:11,getIsInitialized:12,getState:13,reinitialize:14,cleanup:15},null,[-1,-1])}get resetDisplayState(){return this.$$.ctx[8]}get initialize(){return this.$$.ctx[9]}get startDetection(){return this.$$.ctx[10]}get stopDetection(){return this.$$.ctx[11]}get getIsInitialized(){return this.$$.ctx[12]}get getState(){return this.$$.ctx[13]}get reinitialize(){return this.$$.ctx[14]}get cleanup(){return this.$$.ctx[15]}}function _t(o){let e,t,r=(o[0]>0?Math.round(o[0]):"---")+"",s,n,i,l="Hz",c,a,g="|",d,m,f;return{c(){e=I("div"),t=I("span"),s=Ae(r),n=Z(),i=I("span"),i.textContent=l,c=Z(),a=I("span"),a.textContent=g,d=Z(),m=I("span"),f=Ae(o[1]),this.h()},l(u){e=z(u,"DIV",{class:!0});var h=V(e);t=z(h,"SPAN",{class:!0});var _=V(t);s=pe(_,r),_.forEach(x),n=Y(h),i=z(h,"SPAN",{class:!0,"data-svelte-h":!0}),Me(i)!=="svelte-5uyilv"&&(i.textContent=l),c=Y(h),a=z(h,"SPAN",{class:!0,"data-svelte-h":!0}),Me(a)!=="svelte-1dytxz4"&&(a.textContent=g),d=Y(h),m=z(h,"SPAN",{class:!0});var y=V(m);f=pe(y,o[1]),y.forEach(x),h.forEach(x),this.h()},h(){T(t,"class","detected-frequency svelte-1datf0r"),T(i,"class","hz-suffix svelte-1datf0r"),T(a,"class","divider svelte-1datf0r"),T(m,"class","detected-note svelte-1datf0r"),T(e,"class","detection-values svelte-1datf0r")},m(u,h){he(u,e,h),M(e,t),M(t,s),M(e,n),M(e,i),M(e,c),M(e,a),M(e,d),M(e,m),M(m,f)},p(u,h){h&1&&r!==(r=(u[0]>0?Math.round(u[0]):"---")+"")&&be(s,r),h&2&&be(f,u[1])},d(u){u&&x(e)}}}function bt(o){let e,t;return{c(){e=I("span"),t=Ae(o[4]),this.h()},l(r){e=z(r,"SPAN",{class:!0});var s=V(e);t=pe(s,o[4]),s.forEach(x),this.h()},h(){T(e,"class","muted-message svelte-1datf0r")},m(r,s){he(r,e,s),M(e,t)},p(r,s){s&16&&be(t,r[4])},d(r){r&&x(e)}}}function pt(o){let e,t='<h3 class="section-title svelte-1datf0r">🎙️ リアルタイム音程検出</h3>',r,s,n,i,l,c,a,g;function d(u,h){return u[3]?bt:_t}let m=d(o),f=m(o);return a=new Re({props:{volume:!o[3]&&o[0]>0?o[2]:0,className:"volume-bar"}}),{c(){e=I("div"),e.innerHTML=t,r=Z(),s=I("div"),n=I("div"),i=I("div"),l=I("div"),f.c(),c=Z(),Pe(a.$$.fragment),this.h()},l(u){e=z(u,"DIV",{class:!0,"data-svelte-h":!0}),Me(e)!=="svelte-10ekeq9"&&(e.innerHTML=t),r=Y(u),s=z(u,"DIV",{class:!0});var h=V(s);n=z(h,"DIV",{class:!0});var _=V(n);i=z(_,"DIV",{class:!0});var y=V(i);l=z(y,"DIV",{class:!0});var A=V(l);f.l(A),A.forEach(x),c=Y(y),Ne(a.$$.fragment,y),y.forEach(x),_.forEach(x),h.forEach(x),this.h()},h(){T(e,"class","card-header svelte-1datf0r"),T(l,"class","detection-card svelte-1datf0r"),T(i,"class","detection-display svelte-1datf0r"),T(n,"class","pitch-detector svelte-1datf0r"),T(s,"class","card-content svelte-1datf0r")},m(u,h){he(u,e,h),he(u,r,h),he(u,s,h),M(s,n),M(n,i),M(i,l),f.m(l,null),M(i,c),Ee(a,i,null),g=!0},p(u,h){m===(m=d(u))&&f?f.p(u,h):(f.d(1),f=m(u),f&&(f.c(),f.m(l,null)));const _={};h&13&&(_.volume=!u[3]&&u[0]>0?u[2]:0),a.$set(_)},i(u){g||(Ie(a.$$.fragment,u),g=!0)},o(u){ze(a.$$.fragment,u),g=!1},d(u){u&&(x(e),x(r),x(s)),f.d(),De(a)}}}function Mt(o){let e,t;return e=new st({props:{class:"main-card "+o[5],$$slots:{default:[pt]},$$scope:{ctx:o}}}),{c(){Pe(e.$$.fragment)},l(r){Ne(e.$$.fragment,r)},m(r,s){Ee(e,r,s),t=!0},p(r,[s]){const n={};s&32&&(n.class="main-card "+r[5]),s&95&&(n.$$scope={dirty:s,ctx:r}),e.$set(n)},i(r){t||(Ie(e.$$.fragment,r),t=!0)},o(r){ze(e.$$.fragment,r),t=!1},d(r){De(e,r)}}}function At(o,e,t){let{frequency:r=0}=e,{note:s="ーー"}=e,{volume:n=0}=e,{isMuted:i=!1}=e,{muteMessage:l="待機中..."}=e,{className:c=""}=e;return o.$$set=a=>{"frequency"in a&&t(0,r=a.frequency),"note"in a&&t(1,s=a.note),"volume"in a&&t(2,n=a.volume),"isMuted"in a&&t(3,i=a.isMuted),"muteMessage"in a&&t(4,l=a.muteMessage),"className"in a&&t(5,c=a.className)},[r,s,n,i,l,c]}class Ft extends Te{constructor(e){super(),xe(this,e,At,Mt,Fe,{frequency:0,note:1,volume:2,isMuted:3,muteMessage:4,className:5})}}export{Ft as P,xt as a,Ce as b,Se as h,mt as l};
