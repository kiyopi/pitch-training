var et=Object.defineProperty;var tt=(a,e,t)=>e in a?et(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var j=(a,e,t)=>tt(a,typeof e!="symbol"?e+"":e,t);import{S as xe,i as De,s as Te,n as He,d as S,K as P,y as C,b as Y,c as p,e as x,f as k,h as L,j as D,k as G,L as st,M as nt,C as Fe,m as ke,o as ze,a as te,D as Ie,g as W,G as _e,E as Ne,t as U,F as Pe,Q as ot,R as at,r as Ve}from"./CJUHymq1.js";import"./IHki7fMi.js";import{C as rt}from"./DqnuPPYK.js";function it(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}function Q(a){if(this.size=a|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=a<<1;for(var e=new Array(this.size*2),t=0;t<e.length;t+=2){const u=Math.PI*t/this.size;e[t]=Math.cos(u),e[t+1]=-Math.sin(u)}this.table=e;for(var s=0,n=1;this.size>n;n<<=1)s++;this._width=s%2===0?s-1:s,this._bitrev=new Array(1<<this._width);for(var o=0;o<this._bitrev.length;o++){this._bitrev[o]=0;for(var r=0;r<this._width;r+=2){var i=this._width-r-2;this._bitrev[o]|=(o>>>r&3)<<i}}this._out=null,this._data=null,this._inv=0}var lt=Q;Q.prototype.fromComplexArray=function(e,t){for(var s=t||new Array(e.length>>>1),n=0;n<e.length;n+=2)s[n>>>1]=e[n];return s};Q.prototype.createComplexArray=function(){const e=new Array(this._csize);for(var t=0;t<e.length;t++)e[t]=0;return e};Q.prototype.toComplexArray=function(e,t){for(var s=t||this.createComplexArray(),n=0;n<s.length;n+=2)s[n]=e[n>>>1],s[n+1]=0;return s};Q.prototype.completeSpectrum=function(e){for(var t=this._csize,s=t>>>1,n=2;n<s;n+=2)e[t-n]=e[n],e[t-n+1]=-e[n+1]};Q.prototype.transform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._transform4(),this._out=null,this._data=null};Q.prototype.realTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._realTransform4(),this._out=null,this._data=null};Q.prototype.inverseTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=1,this._transform4();for(var s=0;s<e.length;s++)e[s]/=this.size;this._out=null,this._data=null};Q.prototype._transform4=function(){var e=this._out,t=this._csize,s=this._width,n=1<<s,o=t/n<<1,r,i,u=this._bitrev;if(o===4)for(r=0,i=0;r<t;r+=o,i++){const y=u[i];this._singleTransform2(r,y,n)}else for(r=0,i=0;r<t;r+=o,i++){const y=u[i];this._singleTransform4(r,y,n)}var l=this._inv?-1:1,f=this.table;for(n>>=2;n>=2;n>>=2){o=t/n<<1;var d=o>>>2;for(r=0;r<t;r+=o)for(var m=r+d,h=r,c=0;h<m;h+=2,c+=n){const y=h,g=y+d,v=g+d,_=v+d,A=e[y],M=e[y+1],T=e[g],F=e[g+1],z=e[v],N=e[v+1],H=e[_],K=e[_+1],B=A,J=M,q=f[c],se=l*f[c+1],Z=T*q-F*se,O=T*se+F*q,oe=f[2*c],$=l*f[2*c+1],ae=z*oe-N*$,ce=z*$+N*oe,ue=f[3*c],he=l*f[3*c+1],re=H*ue-K*he,de=H*he+K*ue,b=B+ae,w=J+ce,I=B-ae,V=J-ce,E=Z+re,X=O+de,ie=l*(Z-re),le=l*(O-de),ge=b+E,pe=w+X,ee=b-E,ve=w-X,be=I+le,ye=V-ie,R=I-le,fe=V+ie;e[y]=ge,e[y+1]=pe,e[g]=be,e[g+1]=ye,e[v]=ee,e[v+1]=ve,e[_]=R,e[_+1]=fe}}};Q.prototype._singleTransform2=function(e,t,s){const n=this._out,o=this._data,r=o[t],i=o[t+1],u=o[t+s],l=o[t+s+1],f=r+u,d=i+l,m=r-u,h=i-l;n[e]=f,n[e+1]=d,n[e+2]=m,n[e+3]=h};Q.prototype._singleTransform4=function(e,t,s){const n=this._out,o=this._data,r=this._inv?-1:1,i=s*2,u=s*3,l=o[t],f=o[t+1],d=o[t+s],m=o[t+s+1],h=o[t+i],c=o[t+i+1],y=o[t+u],g=o[t+u+1],v=l+h,_=f+c,A=l-h,M=f-c,T=d+y,F=m+g,z=r*(d-y),N=r*(m-g),H=v+T,K=_+F,B=A+N,J=M-z,q=v-T,se=_-F,Z=A-N,O=M+z;n[e]=H,n[e+1]=K,n[e+2]=B,n[e+3]=J,n[e+4]=q,n[e+5]=se,n[e+6]=Z,n[e+7]=O};Q.prototype._realTransform4=function(){var e=this._out,t=this._csize,s=this._width,n=1<<s,o=t/n<<1,r,i,u=this._bitrev;if(o===4)for(r=0,i=0;r<t;r+=o,i++){const we=u[i];this._singleRealTransform2(r,we>>>1,n>>>1)}else for(r=0,i=0;r<t;r+=o,i++){const we=u[i];this._singleRealTransform4(r,we>>>1,n>>>1)}var l=this._inv?-1:1,f=this.table;for(n>>=2;n>=2;n>>=2){o=t/n<<1;var d=o>>>1,m=d>>>1,h=m>>>1;for(r=0;r<t;r+=o)for(var c=0,y=0;c<=h;c+=2,y+=n){var g=r+c,v=g+m,_=v+m,A=_+m,M=e[g],T=e[g+1],F=e[v],z=e[v+1],N=e[_],H=e[_+1],K=e[A],B=e[A+1],J=M,q=T,se=f[y],Z=l*f[y+1],O=F*se-z*Z,oe=F*Z+z*se,$=f[2*y],ae=l*f[2*y+1],ce=N*$-H*ae,ue=N*ae+H*$,he=f[3*y],re=l*f[3*y+1],de=K*he-B*re,b=K*re+B*he,w=J+ce,I=q+ue,V=J-ce,E=q-ue,X=O+de,ie=oe+b,le=l*(O-de),ge=l*(oe-b),pe=w+X,ee=I+ie,ve=V+ge,be=E-le;if(e[g]=pe,e[g+1]=ee,e[v]=ve,e[v+1]=be,c===0){var ye=w-X,R=I-ie;e[_]=ye,e[_+1]=R;continue}if(c!==h){var fe=V,We=-E,Ue=w,Qe=-I,Ke=-l*ge,je=-l*le,Je=-l*ie,Xe=-l*X,Ye=fe+Ke,Ze=We+je,Oe=Ue+Xe,$e=Qe-Je,Ee=r+m-c,qe=r+d-c;e[Ee]=Ye,e[Ee+1]=Ze,e[qe]=Oe,e[qe+1]=$e}}}};Q.prototype._singleRealTransform2=function(e,t,s){const n=this._out,o=this._data,r=o[t],i=o[t+s],u=r+i,l=r-i;n[e]=u,n[e+1]=0,n[e+2]=l,n[e+3]=0};Q.prototype._singleRealTransform4=function(e,t,s){const n=this._out,o=this._data,r=this._inv?-1:1,i=s*2,u=s*3,l=o[t],f=o[t+s],d=o[t+i],m=o[t+u],h=l+d,c=l-d,y=f+m,g=r*(f-m),v=h+y,_=c,A=-g,M=h-y,T=c,F=g;n[e]=v,n[e+1]=0,n[e+2]=_,n[e+3]=A,n[e+4]=M,n[e+5]=0,n[e+6]=T,n[e+7]=F};const ct=it(lt);class Me{constructor(e,t){j(this,"_inputLength");j(this,"_fft");j(this,"_bufferSupplier");j(this,"_paddedInputBuffer");j(this,"_transformBuffer");j(this,"_inverseBuffer");if(e<1)throw new Error("Input length must be at least one");this._inputLength=e,this._fft=new ct(dt(2*e)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(e){return new Me(e,t=>new Float32Array(t))}static forFloat64Array(e){return new Me(e,t=>new Float64Array(t))}static forNumberArray(e){return new Me(e,t=>Array(t))}get inputLength(){return this._inputLength}autocorrelate(e,t=this._bufferSupplier(e.length)){if(e.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${e.length}`);for(let n=0;n<e.length;n++)this._paddedInputBuffer[n]=e[n];for(let n=e.length;n<this._paddedInputBuffer.length;n++)this._paddedInputBuffer[n]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const s=this._transformBuffer;for(let n=0;n<s.length;n+=2)s[n]=s[n]*s[n]+s[n+1]*s[n+1],s[n+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let n=0;n<e.length;n++)t[n]=this._inverseBuffer[2*n];return t}}function ut(a){const e=[];let t=!1,s=-1/0,n=-1;for(let o=1;o<a.length-1;o++)a[o-1]<=0&&a[o]>0?(t=!0,n=o,s=a[o]):a[o-1]>0&&a[o]<=0?(t=!1,n!==-1&&e.push(n)):t&&a[o]>s&&(s=a[o],n=o);return e}function ht(a,e){const[t,s,n]=[a-1,a,a+1],[o,r,i]=[e[t],e[s],e[n]],u=o/2-r+i/2,l=-(o/2)*(s+n)+r*(t+n)-i/2*(t+s),f=o*s*n/2-r*t*n+i*t*s/2,d=-l/(2*u),m=u*d*d+l*d+f;return[d,m]}class Ae{constructor(e,t){j(this,"_autocorrelator");j(this,"_nsdfBuffer");j(this,"_clarityThreshold",.9);j(this,"_minVolumeAbsolute",0);j(this,"_maxInputAmplitude",1);this._autocorrelator=new Me(e,t),this._nsdfBuffer=t(e)}static forFloat32Array(e){return new Ae(e,t=>new Float32Array(t))}static forFloat64Array(e){return new Ae(e,t=>new Float64Array(t))}static forNumberArray(e){return new Ae(e,t=>Array(t))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(e){if(!Number.isFinite(e)||e<=0||e>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=e}set minVolumeAbsolute(e){if(!Number.isFinite(e)||e<0||e>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=e}set minVolumeDecibels(e){if(!Number.isFinite(e)||e>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(e/10)}set maxInputAmplitude(e){if(!Number.isFinite(e)||e<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=e}findPitch(e,t){if(this._belowMinimumVolume(e))return[0,0];this._nsdf(e);const s=ut(this._nsdfBuffer);if(s.length===0)return[0,0];const n=Math.max(...s.map(u=>this._nsdfBuffer[u])),o=s.find(u=>this._nsdfBuffer[u]>=this._clarityThreshold*n),[r,i]=ht(o,this._nsdfBuffer);return[t/r,Math.min(i,1)]}_belowMinimumVolume(e){if(this._minVolumeAbsolute===0)return!1;let t=0;for(let s=0;s<e.length;s++)t+=e[s]**2;return Math.sqrt(t/e.length)<this._minVolumeAbsolute}_nsdf(e){this._autocorrelator.autocorrelate(e,this._nsdfBuffer);let t=2*this._nsdfBuffer[0],s;for(s=0;s<this._nsdfBuffer.length&&t>0;s++)this._nsdfBuffer[s]=2*this._nsdfBuffer[s]/t,t-=e[s]**2+e[e.length-s-1]**2;for(;s<this._nsdfBuffer.length;s++)this._nsdfBuffer[s]=0}}function dt(a){return a--,a|=a>>1,a|=a>>2,a|=a>>4,a|=a>>8,a|=a>>16,a++,a}function ft(a){let e,t,s,n,o,r;return{c(){e=D("div"),t=D("div"),s=D("div"),n=G(),o=D("div"),this.h()},l(i){e=x(i,"DIV",{class:!0});var u=k(e);t=x(u,"DIV",{class:!0,style:!0});var l=k(t);s=x(l,"DIV",{class:!0,style:!0}),k(s).forEach(S),l.forEach(S),n=L(u),o=x(u,"DIV",{class:!0,style:!0}),k(o).forEach(S),u.forEach(S),this.h()},h(){C(s,"class","volume-bar-fill"),P(s,"position","absolute"),P(s,"top","0"),P(s,"left","0"),P(s,"height","100%"),C(t,"class","volume-bar-bg"),P(t,"height",a[1]),P(t,"border-radius","9999px"),P(t,"background-color","#e2e8f0"),P(t,"position","relative"),P(t,"overflow","hidden"),C(o,"class","threshold-indicator svelte-13z7ppf"),P(o,"position","absolute"),P(o,"top","0"),P(o,"left",a[0]+"%"),P(o,"width","2px"),P(o,"height",a[1]),P(o,"background-color","#64748b"),P(o,"border-radius","1px"),C(e,"class",r="volume-bar-container "+a[2]+" svelte-13z7ppf")},m(i,u){Y(i,e,u),p(e,t),p(t,s),a[5](s),p(e,n),p(e,o)},p(i,[u]){u&2&&P(t,"height",i[1]),u&1&&P(o,"left",i[0]+"%"),u&2&&P(o,"height",i[1]),u&4&&r!==(r="volume-bar-container "+i[2]+" svelte-13z7ppf")&&C(e,"class",r)},i:He,o:He,d(i){i&&S(e),a[5](null)}}}function mt(a,e,t){let{volume:s=0}=e,{threshold:n=30}=e,{height:o="12px"}=e,{className:r=""}=e,i;function u(d){return d<n?`rgba(37, 99, 235, ${Math.max(.2,d/n*.8)})`:"#2563eb"}function l(d){if(i){const m=Math.max(0,Math.min(100,d)),h=u(m);t(3,i.style.width=`${m}%`,i),t(3,i.style.backgroundColor=h,i)}}st(()=>{i&&(t(3,i.style.width="0%",i),t(3,i.style.backgroundColor="#2563eb",i),t(3,i.style.height=o,i),t(3,i.style.borderRadius="9999px",i),t(3,i.style.transition="width 0.2s ease-out, background-color 0.2s ease-out",i))});function f(d){nt[d?"unshift":"push"](()=>{i=d,t(3,i)})}return a.$$set=d=>{"volume"in d&&t(4,s=d.volume),"threshold"in d&&t(0,n=d.threshold),"height"in d&&t(1,o=d.height),"className"in d&&t(2,r=d.className)},a.$$.update=()=>{a.$$.dirty&16&&l(s)},[n,o,r,i,s,f]}class Ge extends xe{constructor(e){super(),De(this,e,mt,ft,Te,{volume:4,threshold:0,height:1,className:2})}}class gt{constructor(){this.audioContext=null,this.mediaStream=null,this.sourceNode=null,this.gainNode=null,this.analysers=new Map,this.filters=new Map,this.refCount=0,this.initPromise=null,this.isInitialized=!1,this.lastError=null,this.currentSensitivity=this._getDefaultSensitivity()}_getDefaultSensitivity(){const e=/iPhone/.test(navigator.userAgent),t=/iPad/.test(navigator.userAgent),s=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document;return t||s?(console.log("🔧 [AudioManager] iPad検出 - デフォルト感度7.0x設定"),7):e?(console.log("🔧 [AudioManager] iPhone検出 - デフォルト感度3.0x設定"),3):(console.log("🔧 [AudioManager] PC検出 - デフォルト感度1.0x設定"),1)}async initialize(){var e,t,s;if(this.initPromise)return this.initPromise;if(this.isInitialized&&this.audioContext&&this.mediaStream){const n=this.checkMediaStreamHealth();if(n.healthy)return this.refCount++,{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode};console.warn("⚠️ [AudioManager] MediaStream不健康検出 - 強制再初期化:",n.reason),console.log("🔄 [AudioManager] 不健康なMediaStream詳細:",{mediaStreamActive:(e=this.mediaStream)==null?void 0:e.active,trackCount:(t=this.mediaStream)==null?void 0:t.getTracks().length,trackStates:(s=this.mediaStream)==null?void 0:s.getTracks().map(o=>({kind:o.kind,readyState:o.readyState,enabled:o.enabled,muted:o.muted}))}),this._cleanup(),this.isInitialized=!1,this.refCount=0,await new Promise(o=>setTimeout(o,100)),console.log("🔄 [AudioManager] クリーンアップ完了 - 再初期化開始")}this.initPromise=this._doInitialize();try{const n=await this.initPromise;return this.initPromise=null,n}catch(n){throw this.initPromise=null,n}}async _doInitialize(){try{if(console.log("🎤 [AudioManager] 初期化開始"),this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),console.log("✅ [AudioManager] AudioContext作成完了")),this.audioContext.state==="suspended"&&(await this.audioContext.resume(),console.log("✅ [AudioManager] AudioContext再開完了")),!this.mediaStream){const e=/iPhone/.test(navigator.userAgent),t=/iPad/.test(navigator.userAgent),s=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document,n=e||t||s;console.log(`🔍 [AudioManager] デバイス検出: ${t||s?"iPad":e?"iPhone":"その他"}`,navigator.userAgent),console.log(`🔍 [AudioManager] タッチサポート: ${"ontouchend"in document}`);const r={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,...n&&{googAutoGainControl:!1,googNoiseSuppression:!1,googEchoCancellation:!1,googHighpassFilter:!1,googTypingNoiseDetection:!1,googBeamforming:!1,mozAutoGainControl:!1,mozNoiseSuppression:!1},sampleRate:44100,channelCount:1,sampleSize:16,latency:.1,volume:1,deviceId:{ideal:"default"}}};console.log("🎤 [AudioManager] Safari対応設定でMediaStream取得中:",r),this.mediaStream=await navigator.mediaDevices.getUserMedia(r),console.log("✅ [AudioManager] MediaStream取得完了")}if(!this.sourceNode){this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),console.log("✅ [AudioManager] SourceNode作成完了");const e=this.mediaStream.getTracks();console.log("🎤 [AudioManager] MediaStream tracks:",e.map(t=>({kind:t.kind,label:t.label,enabled:t.enabled,readyState:t.readyState,muted:t.muted})))}return this.gainNode||(this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=this.currentSensitivity,this.sourceNode.connect(this.gainNode),console.log(`✅ [AudioManager] GainNode作成完了 (感度: ${this.currentSensitivity}x)`)),this.isInitialized=!0,this.refCount++,this.lastError=null,console.log(`🎤 [AudioManager] 初期化完了 (参照カウント: ${this.refCount})`),{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode}}catch(e){throw console.error("❌ [AudioManager] 初期化エラー:",e),this.lastError=e,this.isInitialized=!1,this._cleanup(),e}}createAnalyser(e,t={}){if(!this.isInitialized||!this.audioContext||!this.sourceNode)throw new Error("AudioManager not initialized. Call initialize() first.");this.removeAnalyser(e);const{fftSize:s=2048,smoothingTimeConstant:n=.8,minDecibels:o=-90,maxDecibels:r=-10,useFilters:i=!0}=t,u=this.audioContext.createAnalyser();u.fftSize=Math.min(s,2048),u.smoothingTimeConstant=Math.max(n,.7),u.minDecibels=Math.max(o,-80),u.maxDecibels=Math.min(r,-10);let l=this.gainNode||this.sourceNode;if(i){const f=this._createFilterChain();this.filters.set(e,f),l.connect(f.highpass),f.highpass.connect(f.lowpass),f.lowpass.connect(f.notch),f.notch.connect(u),console.log(`🔧 [AudioManager] フィルター付きAnalyser作成: ${e}`)}else l.connect(u),console.log(`🔧 [AudioManager] 生信号Analyser作成: ${e}`);return this.analysers.set(e,u),u}_createFilterChain(){const e=this.audioContext.createBiquadFilter();e.type="highpass",e.frequency.setValueAtTime(80,this.audioContext.currentTime),e.Q.setValueAtTime(.7,this.audioContext.currentTime);const t=this.audioContext.createBiquadFilter();t.type="lowpass",t.frequency.setValueAtTime(800,this.audioContext.currentTime),t.Q.setValueAtTime(.7,this.audioContext.currentTime);const s=this.audioContext.createBiquadFilter();return s.type="notch",s.frequency.setValueAtTime(60,this.audioContext.currentTime),s.Q.setValueAtTime(10,this.audioContext.currentTime),{highpass:e,lowpass:t,notch:s}}removeAnalyser(e){if(this.analysers.has(e)&&(this.analysers.get(e).disconnect(),this.analysers.delete(e),console.log(`🗑️ [AudioManager] Analyser削除: ${e}`)),this.filters.has(e)){const t=this.filters.get(e);t.highpass.disconnect(),t.lowpass.disconnect(),t.notch.disconnect(),this.filters.delete(e),console.log(`🗑️ [AudioManager] フィルターチェーン削除: ${e}`)}}setSensitivity(e){const t=Math.max(.1,Math.min(10,e));this.gainNode?(this.gainNode.gain.value=t,this.currentSensitivity=t,console.log(`🎤 [AudioManager] マイク感度更新: ${t.toFixed(1)}x`)):(this.currentSensitivity=t,console.log(`🎤 [AudioManager] マイク感度設定（初期化待ち）: ${t.toFixed(1)}x`))}getSensitivity(){return this.currentSensitivity}getPlatformSpecs(){const e=/iPhone/.test(navigator.userAgent),t=/iPad/.test(navigator.userAgent),s=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document,n=e||t||s;return{divisor:n?4:6,gainCompensation:n?1.5:1,noiseThreshold:n?12:15,smoothingFactor:.2,deviceType:t||s?"iPad":e?"iPhone":"PC",isIOS:n}}release(e=[]){e.forEach(t=>this.removeAnalyser(t)),this.refCount=Math.max(0,this.refCount-1),console.log(`📉 [AudioManager] 参照カウント減算: ${this.refCount}`),this.refCount<=0&&(console.log("🧹 [AudioManager] 全リソースクリーンアップ開始"),this._cleanup())}forceCleanup(){console.log("🚨 [AudioManager] 強制クリーンアップ実行"),this._cleanup()}_cleanup(){console.log("🧹 [AudioManager] クリーンアップ開始");for(const e of this.analysers.keys())this.removeAnalyser(e);if(this.mediaStream){const e=this.mediaStream.getTracks();console.log(`🛑 [AudioManager] MediaStream停止中: ${e.length} tracks`),e.forEach((t,s)=>{try{t.readyState!=="ended"?(t.stop(),console.log(`🛑 [AudioManager] Track ${s} 停止完了`)):console.log(`⚠️ [AudioManager] Track ${s} 既に終了済み`)}catch(n){console.warn(`⚠️ [AudioManager] Track ${s} 停止エラー:`,n)}}),this.mediaStream=null}if(this.audioContext&&this.audioContext.state!=="closed"){try{this.audioContext.close(),console.log("🛑 [AudioManager] AudioContext閉鎖完了")}catch(e){console.warn("⚠️ [AudioManager] AudioContext閉鎖エラー:",e)}this.audioContext=null}this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.isInitialized=!1,this.refCount=0,this.initPromise=null,this.currentSensitivity=this._getDefaultSensitivity(),console.log("✅ [AudioManager] クリーンアップ完了")}getStatus(){var e,t;return{isInitialized:this.isInitialized,refCount:this.refCount,audioContextState:((e=this.audioContext)==null?void 0:e.state)||"none",mediaStreamActive:((t=this.mediaStream)==null?void 0:t.active)||!1,activeAnalysers:Array.from(this.analysers.keys()),activeFilters:Array.from(this.filters.keys()),lastError:this.lastError}}checkMediaStreamHealth(){if(!this.mediaStream)return{healthy:!1,reason:"MediaStream not initialized"};if(!this.mediaStream.active)return{healthy:!1,reason:"MediaStream inactive"};const e=this.mediaStream.getTracks();if(e.length===0)return{healthy:!1,reason:"No tracks available"};const t=e.find(s=>s.kind==="audio");return t?t.readyState==="ended"?{healthy:!1,reason:"Audio track ended"}:t.enabled?t.muted?{healthy:!1,reason:"Audio track muted"}:this.mediaStream.active&&t.readyState!=="live"?{healthy:!1,reason:"Track state inconsistent with MediaStream"}:{healthy:!0,track:t}:{healthy:!1,reason:"Audio track disabled"}:{healthy:!1,reason:"No audio track found"}}}const Se=new gt;class vt{constructor(e={}){this.vocalRangeMin=e.vocalRangeMin||130.81,this.vocalRangeMax=e.vocalRangeMax||1046.5,this.stabilityThreshold=e.stabilityThreshold||.3,this.evaluationWeights={vocalRange:e.vocalRangeWeight||.4,continuity:e.continuityWeight||.4,musical:e.musicalWeight||.2},this.fundamentalCandidates=e.fundamentalCandidates||[1,.5,.333,2],this.harmonicHistory=[],this.previousFrequency=0,this.maxHistoryLength=5,this.debugMode=!1,this.volumeThreshold=e.volumeThreshold||.02,this.currentContext={}}correctHarmonic(e,t=1,s=!1){if(!e||e<=0)return 0;const n=t>=this.volumeThreshold,r=this.fundamentalCandidates.map(l=>({frequency:e*l,ratio:l})).map(l=>{const f=this.evaluateFundamental(l.frequency);return{...l,...f}}),i=r.reduce((l,f)=>f.totalScore>l.totalScore?f:l),u=this.stabilizeFrequency(i.frequency,n);return(s||this.debugMode)&&this.logHarmonicCorrection(e,r,i,u,this.currentContext,t,n),n&&(this.previousFrequency=u),u}logHarmonicCorrection(e,t,s,n,o={},r=1,i=!0){console.group(`🔧 [HarmonicCorrection] ${e.toFixed(1)}Hz → ${n.toFixed(1)}Hz`),console.log(`🔊 音量: ${(r*100).toFixed(1)}% (閾値: ${(this.volumeThreshold*100).toFixed(1)}%) ${i?"✅ 有効":"❌ ノイズ除外"}`);const u=this.frequencyToNote(e),l=this.frequencyToNote(n);console.log(`📝 音程変換: ${u} → ${l}`);const f=this.getCorrectionType(s.ratio);if(console.log(`🎯 補正タイプ: ${f}`),o.baseFrequency&&o.currentScale&&o.targetFrequency){console.log("🎵 音階コンテキスト:"),console.log(`   基音: ${o.baseFrequency.toFixed(1)}Hz (${this.frequencyToNote(o.baseFrequency)})`),console.log(`   現在の音階: ${o.currentScale}`),console.log(`   目標周波数: ${o.targetFrequency.toFixed(1)}Hz (${this.frequencyToNote(o.targetFrequency)})`);const m=n-o.targetFrequency,h=1200*Math.log2(n/o.targetFrequency);console.log(`   目標との差: ${m>0?"+":""}${m.toFixed(1)}Hz (${h>0?"+":""}${h.toFixed(0)}セント)`);const c=Math.abs(h)<=50?"🎯 高精度":Math.abs(h)<=100?"✅ 良好":Math.abs(h)<=200?"⚠️ 要改善":"❌ 不正確";console.log(`   精度評価: ${c} (${Math.abs(h).toFixed(0)}セント差)`)}console.table(t.map(m=>({倍率:`${m.ratio.toFixed(3)}x`,周波数:`${m.frequency.toFixed(1)}Hz`,音名:this.frequencyToNote(m.frequency),音域:m.vocalRangeScore.toFixed(2),連続性:m.continuityScore.toFixed(2),音楽性:m.musicalScore.toFixed(2),総合:m.totalScore.toFixed(3),選択:m===s?"✅":""})));const d=Math.abs(n-s.frequency);d>.5&&console.log(`🔄 安定化: ${s.frequency.toFixed(1)}Hz → ${n.toFixed(1)}Hz (${d.toFixed(1)}Hz調整)`),console.groupEnd()}getCorrectionType(e){return Math.abs(e-1)<.01?"補正なし（基音）":Math.abs(e-.5)<.01?"2倍音補正（1オクターブ下）":Math.abs(e-.333)<.01?"3倍音補正（1オクターブ+5度下）":Math.abs(e-.25)<.01?"4倍音補正（2オクターブ下）":Math.abs(e-2)<.01?"オクターブ上補正":`カスタム補正（${e.toFixed(3)}x）`}frequencyToNote(e){if(!e||e<=0)return"---";const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],n=Math.round(12*Math.log2(e/440)),o=(n+9+120)%12,r=Math.floor((n+9)/12)+4;return t[o]+r}evaluateFundamental(e){const s=e>=this.vocalRangeMin&&e<=this.vocalRangeMax?1:0,n=this.previousFrequency>0?1-Math.min(Math.abs(e-this.previousFrequency)/this.previousFrequency,1):.5,o=this.calculateMusicalScore(e),r=s*this.evaluationWeights.vocalRange+n*this.evaluationWeights.continuity+o*this.evaluationWeights.musical;return{vocalRangeScore:s,continuityScore:n,musicalScore:o,totalScore:r}}calculateMusicalScore(e){const s=Math.log2(e/261.63)*12,n=Math.round(s),o=Math.abs(s-n);return Math.max(0,1-o/.5)}stabilizeFrequency(e,t=!0){if(!e||e<=0)return 0;if(t&&this.harmonicHistory.push(e),this.harmonicHistory.length>this.maxHistoryLength&&this.harmonicHistory.shift(),this.harmonicHistory.length<2)return e;const s=[...this.harmonicHistory].sort((i,u)=>i-u),n=s[Math.floor(s.length/2)],o=n*this.stabilityThreshold;return Math.abs(e-n)>o?n+Math.sign(e-n)*o:e}resetHistory(){this.harmonicHistory=[],this.previousFrequency=0}updateConfig(e){Object.assign(this,e),console.log("⚙️ [HarmonicCorrection] 設定更新:",e)}enableDebugLogging(){this.debugMode=!0,console.log("🔍 [HarmonicCorrection] デバッグログ有効化 - 次回の補正から詳細ログを出力します"),console.log("無効化するには: harmonicCorrection.disableDebugLogging()")}disableDebugLogging(){this.debugMode=!1,console.log("🔍 [HarmonicCorrection] デバッグログ無効化")}setScaleContext(e){this.currentContext={baseFrequency:e.baseFrequency,currentScale:e.currentScale,targetFrequency:e.targetFrequency}}clearContext(){this.currentContext={}}getStatus(){return{vocalRangeMin:this.vocalRangeMin,vocalRangeMax:this.vocalRangeMax,stabilityThreshold:this.stabilityThreshold,evaluationWeights:this.evaluationWeights,historyLength:this.harmonicHistory.length,previousFrequency:this.previousFrequency,recentHistory:this.harmonicHistory.slice(-3)}}}const Ce=new vt,yt=(()=>{if(typeof import.meta<"u")return"error";if(typeof window<"u"){const e=new URLSearchParams(window.location.search).get("debug");if(e)return e}return"info"})(),ne={error:0,warn:1,info:2,debug:3},me=ne[yt]??ne.info,_t={error:(a,...e)=>{me>=ne.error&&console.error(`❌ ${a}`,...e)},warn:(a,...e)=>{me>=ne.warn&&console.warn(`⚠️ ${a}`,...e)},info:(a,...e)=>{me>=ne.info&&console.log(`ℹ️ ${a}`,...e)},debug:(a,...e)=>{me>=ne.debug&&console.log(`🔍 ${a}`,...e)},realtime:(()=>{let a=0;const e=1e3;return(t,...s)=>{if(me>=ne.debug){const n=Date.now();n-a>=e&&(console.log(`📊 ${t}`,...s),a=n)}}})(),scoring:(a,...e)=>{me>=ne.info&&console.log(`🎯 ${a}`,...e)},audio:(a,...e)=>{me>=ne.info&&console.log(`🎤 ${a}`,...e)}};function pt(a){let e,t,s,n,o=(a[2]>0?Math.round(a[2]):"---")+"",r,i,u,l="Hz",f,d,m="|",h,c,y,g,v,_,A;return v=new Ge({props:{volume:a[2]>0?a[1]:0,className:"volume-bar"}}),{c(){e=D("div"),t=D("div"),s=D("div"),n=D("span"),r=U(o),i=G(),u=D("span"),u.textContent=l,f=G(),d=D("span"),d.textContent=m,h=G(),c=D("span"),y=U(a[3]),g=G(),Pe(v.$$.fragment),this.h()},l(M){e=x(M,"DIV",{class:!0});var T=k(e);t=x(T,"DIV",{class:!0});var F=k(t);s=x(F,"DIV",{class:!0});var z=k(s);n=x(z,"SPAN",{class:!0});var N=k(n);r=W(N,o),N.forEach(S),i=L(z),u=x(z,"SPAN",{class:!0,"data-svelte-h":!0}),_e(u)!=="svelte-5uyilv"&&(u.textContent=l),f=L(z),d=x(z,"SPAN",{class:!0,"data-svelte-h":!0}),_e(d)!=="svelte-1dytxz4"&&(d.textContent=m),h=L(z),c=x(z,"SPAN",{class:!0});var H=k(c);y=W(H,a[3]),H.forEach(S),z.forEach(S),g=L(F),Ne(v.$$.fragment,F),F.forEach(S),T.forEach(S),this.h()},h(){C(n,"class","detected-frequency svelte-vc1bho"),C(u,"class","hz-suffix svelte-vc1bho"),C(d,"class","divider svelte-vc1bho"),C(c,"class","detected-note svelte-vc1bho"),C(s,"class","detection-card svelte-vc1bho"),C(t,"class","detection-display svelte-vc1bho"),C(e,"class",_="pitch-detector "+a[0]+" svelte-vc1bho")},m(M,T){Y(M,e,T),p(e,t),p(t,s),p(s,n),p(n,r),p(s,i),p(s,u),p(s,f),p(s,d),p(s,h),p(s,c),p(c,y),p(t,g),Ie(v,t,null),A=!0},p(M,T){(!A||T[0]&4)&&o!==(o=(M[2]>0?Math.round(M[2]):"---")+"")&&te(r,o),(!A||T[0]&8)&&te(y,M[3]);const F={};T[0]&6&&(F.volume=M[2]>0?M[1]:0),v.$set(F),(!A||T[0]&1&&_!==(_="pitch-detector "+M[0]+" svelte-vc1bho"))&&C(e,"class",_)},i(M){A||(ze(v.$$.fragment,M),A=!0)},o(M){ke(v.$$.fragment,M),A=!1},d(M){M&&S(e),Fe(v)}}}function bt(a){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(a<=0)return"ーー";const s=Math.round(12*Math.log2(a/440)),n=(s+9+120)%12,o=Math.floor((s+9)/12)+4;return e[n]+o}function Mt(a,e,t){const s=ot();let{isActive:n=!1}=e,{className:o=""}=e,{debugMode:r=!1}=e;const i="";let{disableHarmonicCorrection:u=!1}=e,l="uninitialized",f=null,d=!1,m=null,h=null,c=null,y=null,g=null,v=null,_=null,A=!1,M=[],T=new Map,F=0,z=0,N=0,H="ーー",K=0,B=[],J=0,q=null;function se(){F=0,t(1,z=0),t(2,N=0),t(3,H="ーー"),K=0,J=0,B=[],Ce.resetHistory(),r&&console.log("🔄 [PitchDetector] Display state reset")}function Z(){if(!r)return;const b=new Date().toLocaleTimeString(),w={timestamp:b,componentState:l,isActive:n,isDetecting:A,isInitialized:d,mediaStreamActive:h?h.active:null,mediaStreamTracks:h?h.getTracks().length:0,trackStates:h?h.getTracks().map(E=>({kind:E.kind,enabled:E.enabled,readyState:E.readyState,muted:E.muted})):[],audioContextState:m?m.state:null,hasAnalyser:!!y,currentVolume:F,currentFrequency:N};_t.realtime(`[PitchDetector] ${b}:`,w);let I=!0,V=[];h&&!h.active&&(console.warn("⚠️ [PitchDetector] MediaStream is inactive!",h),I=!1,V.push("MediaStream inactive")),m&&m.state==="suspended"&&(console.warn("⚠️ [PitchDetector] AudioContext is suspended!",m),I=!1,V.push("AudioContext suspended")),h&&h.getTracks().forEach((E,X)=>{E.readyState==="ended"&&(console.error(`❌ [PitchDetector] Track ${X} has ended!`,E),I=!1,V.push(`Track ${X} ended`))}),s("microphoneHealthChange",{healthy:I,errors:V,details:w})}async function O(){try{t(16,l="initializing"),f=null,console.log("🎙️ [PitchDetector] AudioManager経由で初期化開始");const b=await Se.initialize();m=b.audioContext,h=b.mediaStream,c=b.sourceNode,console.log("✅ [PitchDetector] AudioManager リソース取得完了");const w=`pitch-detector-filtered-${Date.now()}`;t(17,y=Se.createAnalyser(w,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!0})),M.push(w);const I=`pitch-detector-raw-${Date.now()}`;g=Se.createAnalyser(I,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!1}),M.push(I),console.log("✅ [PitchDetector] Analyser作成完了:",M),v=Ae.forFloat32Array(y.fftSize),t(16,l="ready"),d=!0,s("stateChange",{state:l}),de(),console.log("✅ [PitchDetector] 初期化完了")}catch(b){throw console.error("❌ [PitchDetector] 初期化エラー:",b),t(16,l="error"),f=b,d=!1,s("error",{error:b,context:"initialization"}),b}}function oe(){if(l!=="ready"){const b=new Error(`Cannot start detection: component state is ${l}`);return s("error",{error:b,context:"start-detection"}),!1}if(!y||!v||!m){const b=new Error("Required components not available");return t(16,l="error"),s("error",{error:b,context:"start-detection"}),!1}return t(16,l="detecting"),t(18,A=!0),s("stateChange",{state:l}),ae(),!0}function $(){t(18,A=!1),_&&(cancelAnimationFrame(_),_=null),l==="detecting"&&d&&(t(16,l="ready"),s("stateChange",{state:l}))}function ae(){if(!A||!y||!g||!v)return;const b=y.fftSize,w=new Float32Array(b),I=new Float32Array(g.fftSize);y.getFloatTimeDomainData(w),g.getFloatTimeDomainData(I);let V=0;for(let R=0;R<b;R++)V+=Math.abs(w[R]);const E=Math.sqrt(V/b),X=Math.log10(E+.001)*50+100,ie=Math.max(0,Math.min(100,X));let le=0;for(let R=0;R<I.length;R++)le+=Math.abs(I[R]);const ge=Math.sqrt(le/I.length),pe=Math.log10(ge+.001)*50+100;t(1,z=Math.max(0,Math.min(100,pe))),B.push(ie),B.length>5&&B.shift(),J=B.reduce((R,fe)=>R+fe,0)/B.length,F=J;const[ee,ve]=v.findPitch(w,m.sampleRate),be=ee>=65&&ee<=1200;if(ee&&ve>.8&&F>30&&be){let R=ee;if(u)r&&console.log("🔧 [PitchDetector] ハーモニック補正無効化中 - 生値使用:",ee);else{const fe=Math.min(F/100,1);R=Ce.correctHarmonic(ee,fe)}t(2,N=Math.round(R)),t(3,H=bt(N)),K=ve}else N===0&&Ce.resetHistory(),t(2,N=0),t(3,H="ーー"),K=0;const ye=N>0?z:0;s("pitchUpdate",{frequency:N,note:H,volume:ye,rawVolume:ye,clarity:K}),_=requestAnimationFrame(ae)}function ce(){return d&&l==="ready"}function ue(){return{componentState:l,isInitialized:d,isDetecting:A,lastError:f,hasRequiredComponents:!!(y&&v&&m&&h)}}async function he(){console.log("🔄 [PitchDetector] 再初期化開始"),re(),await new Promise(b=>setTimeout(b,100)),await O(),console.log("✅ [PitchDetector] 再初期化完了")}function re(){console.log("🧹 [PitchDetector] クリーンアップ開始"),$(),T.size>0&&(T.forEach((b,w)=>{w.removeEventListener("ended",b.endedHandler),w.removeEventListener("mute",b.muteHandler),w.removeEventListener("unmute",b.unmuteHandler)}),T.clear(),console.log("🔄 [PitchDetector] MediaStreamイベントリスナー削除")),M.length>0&&(Se.release(M),console.log("📤 [PitchDetector] AudioManagerにAnalyser解放通知:",M),M=[]),t(16,l="uninitialized"),d=!1,f=null,m=null,h=null,c=null,t(17,y=null),g=null,v=null,B=[],Ce.resetHistory(),console.log("✅ [PitchDetector] クリーンアップ完了")}function de(){if(!h)return;const b=h.getTracks();b.forEach(w=>{const I=()=>{console.error("🚨 [PitchDetector] MediaStreamTrack終了検出:",w.kind),t(16,l="error"),f=new Error(`MediaStreamTrack (${w.kind}) ended`),s("error",{error:f,reason:"mediastream_ended",recovery:"restart_required"}),A&&$()},V=()=>{console.warn("⚠️ [PitchDetector] MediaStreamTrack muted:",w.kind),s("warning",{reason:"track_muted",track:w.kind})},E=()=>{console.log("✅ [PitchDetector] MediaStreamTrack unmuted:",w.kind),s("info",{reason:"track_unmuted",track:w.kind})};w.addEventListener("ended",I),w.addEventListener("mute",V),w.addEventListener("unmute",E),T.set(w,{endedHandler:I,muteHandler:V,unmuteHandler:E})}),console.log("🔍 [PitchDetector] MediaStream監視開始:",b.length+" tracks")}return at(()=>{q&&(clearInterval(q),t(19,q=null)),console.log("🔄 [PitchDetector] onDestroy - AudioManagerリソースは保持")}),a.$$set=b=>{"isActive"in b&&t(4,n=b.isActive),"className"in b&&t(0,o=b.className),"debugMode"in b&&t(5,r=b.debugMode),"disableHarmonicCorrection"in b&&t(7,u=b.disableHarmonicCorrection)},a.$$.update=()=>{a.$$.dirty[0]&524320&&(r&&!q?(console.log("🔍 [PitchDetector] Debug mode enabled - starting status monitoring"),t(19,q=setInterval(Z,3e3)),Z()):!r&&q&&(console.log("🔍 [PitchDetector] Debug mode disabled - stopping status monitoring"),clearInterval(q),t(19,q=null))),a.$$.dirty[0]&458768&&(n&&l==="ready"&&y&&!A?oe():!n&&A&&$())},[o,z,N,H,n,r,i,u,se,O,oe,$,ce,ue,he,re,l,y,A,q]}class It extends xe{constructor(e){super(),De(this,e,Mt,pt,Te,{isActive:4,className:0,debugMode:5,trainingPhase:6,disableHarmonicCorrection:7,resetDisplayState:8,initialize:9,startDetection:10,stopDetection:11,getIsInitialized:12,getState:13,reinitialize:14,cleanup:15},null,[-1,-1])}get trainingPhase(){return this.$$.ctx[6]}get resetDisplayState(){return this.$$.ctx[8]}get initialize(){return this.$$.ctx[9]}get startDetection(){return this.$$.ctx[10]}get stopDetection(){return this.$$.ctx[11]}get getIsInitialized(){return this.$$.ctx[12]}get getState(){return this.$$.ctx[13]}get reinitialize(){return this.$$.ctx[14]}get cleanup(){return this.$$.ctx[15]}}function At(a){let e,t,s=(a[0]>0?Math.round(a[0]):"---")+"",n,o,r,i="Hz",u,l,f="|",d,m,h,c,y,g=a[9]&&a[6]>0&&Re(a);return{c(){e=D("div"),t=D("span"),n=U(s),o=G(),r=D("span"),r.textContent=i,u=G(),l=D("span"),l.textContent=f,d=G(),m=D("span"),h=U(a[1]),c=G(),g&&g.c(),y=Ve(),this.h()},l(v){e=x(v,"DIV",{class:!0});var _=k(e);t=x(_,"SPAN",{class:!0});var A=k(t);n=W(A,s),A.forEach(S),o=L(_),r=x(_,"SPAN",{class:!0,"data-svelte-h":!0}),_e(r)!=="svelte-5uyilv"&&(r.textContent=i),u=L(_),l=x(_,"SPAN",{class:!0,"data-svelte-h":!0}),_e(l)!=="svelte-1dytxz4"&&(l.textContent=f),d=L(_),m=x(_,"SPAN",{class:!0});var M=k(m);h=W(M,a[1]),M.forEach(S),_.forEach(S),c=L(v),g&&g.l(v),y=Ve(),this.h()},h(){C(t,"class","detected-frequency svelte-apkxqk"),C(r,"class","hz-suffix svelte-apkxqk"),C(l,"class","divider svelte-apkxqk"),C(m,"class","detected-note svelte-apkxqk"),C(e,"class","detection-values svelte-apkxqk")},m(v,_){Y(v,e,_),p(e,t),p(t,n),p(e,o),p(e,r),p(e,u),p(e,l),p(e,d),p(e,m),p(m,h),Y(v,c,_),g&&g.m(v,_),Y(v,y,_)},p(v,_){_&1&&s!==(s=(v[0]>0?Math.round(v[0]):"---")+"")&&te(n,s),_&2&&te(h,v[1]),v[9]&&v[6]>0?g?g.p(v,_):(g=Re(v),g.c(),g.m(y.parentNode,y)):g&&(g.d(1),g=null)},d(v){v&&(S(e),S(c),S(y)),g&&g.d(v)}}}function St(a){let e,t;return{c(){e=D("span"),t=U(a[4]),this.h()},l(s){e=x(s,"SPAN",{class:!0});var n=k(e);t=W(n,a[4]),n.forEach(S),this.h()},h(){C(e,"class","muted-message svelte-apkxqk")},m(s,n){Y(s,e,n),p(e,t)},p(s,n){n&16&&te(t,s[4])},d(s){s&&S(e)}}}function Re(a){let e,t,s,n="目標:",o,r,i=Math.round(a[6])+"",u,l,f,d,m,h,c,y,g=a[0]>0&&Be(a);return{c(){e=D("div"),t=D("div"),s=D("span"),s.textContent=n,o=G(),r=D("span"),u=U(i),l=U("Hz"),f=G(),d=D("span"),m=U("("),h=U(a[7]),c=U(")"),y=G(),g&&g.c(),this.h()},l(v){e=x(v,"DIV",{class:!0});var _=k(e);t=x(_,"DIV",{class:!0});var A=k(t);s=x(A,"SPAN",{class:!0,"data-svelte-h":!0}),_e(s)!=="svelte-it05ma"&&(s.textContent=n),o=L(A),r=x(A,"SPAN",{class:!0});var M=k(r);u=W(M,i),l=W(M,"Hz"),M.forEach(S),f=L(A),d=x(A,"SPAN",{class:!0});var T=k(d);m=W(T,"("),h=W(T,a[7]),c=W(T,")"),T.forEach(S),A.forEach(S),y=L(_),g&&g.l(_),_.forEach(S),this.h()},h(){C(s,"class","target-label svelte-apkxqk"),C(r,"class","target-frequency svelte-apkxqk"),C(d,"class","target-note svelte-apkxqk"),C(t,"class","target-info svelte-apkxqk"),C(e,"class","guidance-section svelte-apkxqk")},m(v,_){Y(v,e,_),p(e,t),p(t,s),p(t,o),p(t,r),p(r,u),p(r,l),p(t,f),p(t,d),p(d,m),p(d,h),p(d,c),p(e,y),g&&g.m(e,null)},p(v,_){_&64&&i!==(i=Math.round(v[6])+"")&&te(u,i),_&128&&te(h,v[7]),v[0]>0?g?g.p(v,_):(g=Be(v),g.c(),g.m(e,null)):g&&(g.d(1),g=null)},d(v){v&&S(e),g&&g.d()}}}function Be(a){let e,t,s=a[8]>0?"+":"",n,o=Math.round(a[8])+"",r,i,u,l,f=Le(a[10],a[8])+"",d,m;return{c(){e=D("div"),t=D("span"),n=U(s),r=U(o),i=U("¢"),u=G(),l=D("span"),d=U(f),this.h()},l(h){e=x(h,"DIV",{class:!0});var c=k(e);t=x(c,"SPAN",{class:!0});var y=k(t);n=W(y,s),r=W(y,o),i=W(y,"¢"),y.forEach(S),u=L(c),l=x(c,"SPAN",{class:!0});var g=k(l);d=W(g,f),g.forEach(S),c.forEach(S),this.h()},h(){C(t,"class","cent-diff svelte-apkxqk"),C(l,"class","accuracy-message"),C(e,"class",m="accuracy-feedback accuracy-"+a[10]+" svelte-apkxqk")},m(h,c){Y(h,e,c),p(e,t),p(t,n),p(t,r),p(t,i),p(e,u),p(e,l),p(l,d)},p(h,c){c&256&&s!==(s=h[8]>0?"+":"")&&te(n,s),c&256&&o!==(o=Math.round(h[8])+"")&&te(r,o),c&1280&&f!==(f=Le(h[10],h[8])+"")&&te(d,f),c&1024&&m!==(m="accuracy-feedback accuracy-"+h[10]+" svelte-apkxqk")&&C(e,"class",m)},d(h){h&&S(e)}}}function Ct(a){let e,t='<h3 class="section-title svelte-apkxqk">🎙️ リアルタイム音程検出</h3>',s,n,o,r,i,u,l,f;function d(c,y){return c[3]?St:At}let m=d(a),h=m(a);return l=new Ge({props:{volume:!a[3]&&a[0]>0?a[2]:0,className:"volume-bar"}}),{c(){e=D("div"),e.innerHTML=t,s=G(),n=D("div"),o=D("div"),r=D("div"),i=D("div"),h.c(),u=G(),Pe(l.$$.fragment),this.h()},l(c){e=x(c,"DIV",{class:!0,"data-svelte-h":!0}),_e(e)!=="svelte-10ekeq9"&&(e.innerHTML=t),s=L(c),n=x(c,"DIV",{class:!0});var y=k(n);o=x(y,"DIV",{class:!0});var g=k(o);r=x(g,"DIV",{class:!0});var v=k(r);i=x(v,"DIV",{class:!0});var _=k(i);h.l(_),_.forEach(S),u=L(v),Ne(l.$$.fragment,v),v.forEach(S),g.forEach(S),y.forEach(S),this.h()},h(){C(e,"class","card-header svelte-apkxqk"),C(i,"class","detection-card svelte-apkxqk"),C(r,"class","detection-display svelte-apkxqk"),C(o,"class","pitch-detector svelte-apkxqk"),C(n,"class","card-content svelte-apkxqk")},m(c,y){Y(c,e,y),Y(c,s,y),Y(c,n,y),p(n,o),p(o,r),p(r,i),h.m(i,null),p(r,u),Ie(l,r,null),f=!0},p(c,y){m===(m=d(c))&&h?h.p(c,y):(h.d(1),h=m(c),h&&(h.c(),h.m(i,null)));const g={};y&13&&(g.volume=!c[3]&&c[0]>0?c[2]:0),l.$set(g)},i(c){f||(ze(l.$$.fragment,c),f=!0)},o(c){ke(l.$$.fragment,c),f=!1},d(c){c&&(S(e),S(s),S(n)),h.d(),Fe(l)}}}function wt(a){let e,t;return e=new rt({props:{class:"main-card "+a[5],$$slots:{default:[Ct]},$$scope:{ctx:a}}}),{c(){Pe(e.$$.fragment)},l(s){Ne(e.$$.fragment,s)},m(s,n){Ie(e,s,n),t=!0},p(s,[n]){const o={};n&32&&(o.class="main-card "+s[5]),n&4063&&(o.$$scope={dirty:n,ctx:s}),e.$set(o)},i(s){t||(ze(e.$$.fragment,s),t=!0)},o(s){ke(e.$$.fragment,s),t=!1},d(s){Fe(e,s)}}}function xt(a){const e=Math.abs(a);return e<=30?"excellent":e<=60?"good":e<=120?"okay":e<=200?"poor":"very-poor"}function Le(a,e){return a==="excellent"?"🎯 完璧！":a==="good"?"✅ とても良い":a==="okay"?"🔶 もう少し":a==="poor"?e>0?"📈 もっと高く":"📉 もっと低く":e>0?"⬆️ かなり高く":"⬇️ かなり低く"}function Dt(a,e,t){let s,{frequency:n=0}=e,{note:o="ーー"}=e,{volume:r=0}=e,{isMuted:i=!1}=e,{muteMessage:u="待機中..."}=e,{className:l=""}=e,{targetFrequency:f=0}=e,{targetNote:d=""}=e,{centDiff:m=0}=e,{showGuidance:h=!1}=e;return a.$$set=c=>{"frequency"in c&&t(0,n=c.frequency),"note"in c&&t(1,o=c.note),"volume"in c&&t(2,r=c.volume),"isMuted"in c&&t(3,i=c.isMuted),"muteMessage"in c&&t(4,u=c.muteMessage),"className"in c&&t(5,l=c.className),"targetFrequency"in c&&t(6,f=c.targetFrequency),"targetNote"in c&&t(7,d=c.targetNote),"centDiff"in c&&t(8,m=c.centDiff),"showGuidance"in c&&t(9,h=c.showGuidance)},a.$$.update=()=>{a.$$.dirty&256&&t(10,s=xt(m))},[n,o,r,i,u,l,f,d,m,h,s]}class Nt extends xe{constructor(e){super(),De(this,e,Dt,wt,Te,{frequency:0,note:1,volume:2,isMuted:3,muteMessage:4,className:5,targetFrequency:6,targetNote:7,centDiff:8,showGuidance:9})}}export{Nt as P,Se as a,It as b};
