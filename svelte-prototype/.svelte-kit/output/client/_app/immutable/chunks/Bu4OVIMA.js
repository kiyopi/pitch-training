class u{constructor(){this.audioContext=null,this.mediaStream=null,this.sourceNode=null,this.analysers=new Map,this.filters=new Map,this.refCount=0,this.initPromise=null,this.isInitialized=!1,this.lastError=null}async initialize(){if(this.initPromise)return this.initPromise;if(this.isInitialized&&this.audioContext&&this.mediaStream)return this.refCount++,{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode};this.initPromise=this._doInitialize();try{const e=await this.initPromise;return this.initPromise=null,e}catch(e){throw this.initPromise=null,e}}async _doInitialize(){try{if(console.log("ğŸ¤ [AudioManager] åˆæœŸåŒ–é–‹å§‹"),this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),console.log("âœ… [AudioManager] AudioContextä½œæˆå®Œäº†")),this.audioContext.state==="suspended"&&(await this.audioContext.resume(),console.log("âœ… [AudioManager] AudioContextå†é–‹å®Œäº†")),this.mediaStream||(this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}}),console.log("âœ… [AudioManager] MediaStreamå–å¾—å®Œäº†")),!this.sourceNode){this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),console.log("âœ… [AudioManager] SourceNodeä½œæˆå®Œäº†");const e=this.mediaStream.getTracks();console.log("ğŸ¤ [AudioManager] MediaStream tracks:",e.map(t=>({kind:t.kind,label:t.label,enabled:t.enabled,readyState:t.readyState,muted:t.muted})))}return this.isInitialized=!0,this.refCount++,this.lastError=null,console.log(`ğŸ¤ [AudioManager] åˆæœŸåŒ–å®Œäº† (å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆ: ${this.refCount})`),{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode}}catch(e){throw console.error("âŒ [AudioManager] åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:",e),this.lastError=e,this.isInitialized=!1,this._cleanup(),e}}createAnalyser(e,t={}){if(!this.isInitialized||!this.audioContext||!this.sourceNode)throw new Error("AudioManager not initialized. Call initialize() first.");this.removeAnalyser(e);const{fftSize:i=2048,smoothingTimeConstant:o=.8,minDecibels:n=-90,maxDecibels:r=-10,useFilters:l=!0}=t,a=this.audioContext.createAnalyser();if(a.fftSize=i,a.smoothingTimeConstant=o,a.minDecibels=n,a.maxDecibels=r,this.sourceNode,l){const s=this._createFilterChain();this.filters.set(e,s),this.sourceNode.connect(s.highpass),s.highpass.connect(s.lowpass),s.lowpass.connect(s.notch),s.notch.connect(a),console.log(`ğŸ”§ [AudioManager] ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä»˜ãAnalyserä½œæˆ: ${e}`)}else this.sourceNode.connect(a),console.log(`ğŸ”§ [AudioManager] ç”Ÿä¿¡å·Analyserä½œæˆ: ${e}`);return this.analysers.set(e,a),a}_createFilterChain(){const e=this.audioContext.createBiquadFilter();e.type="highpass",e.frequency.setValueAtTime(80,this.audioContext.currentTime),e.Q.setValueAtTime(.7,this.audioContext.currentTime);const t=this.audioContext.createBiquadFilter();t.type="lowpass",t.frequency.setValueAtTime(800,this.audioContext.currentTime),t.Q.setValueAtTime(.7,this.audioContext.currentTime);const i=this.audioContext.createBiquadFilter();return i.type="notch",i.frequency.setValueAtTime(60,this.audioContext.currentTime),i.Q.setValueAtTime(10,this.audioContext.currentTime),{highpass:e,lowpass:t,notch:i}}removeAnalyser(e){if(this.analysers.has(e)&&(this.analysers.get(e).disconnect(),this.analysers.delete(e),console.log(`ğŸ—‘ï¸ [AudioManager] Analyserå‰Šé™¤: ${e}`)),this.filters.has(e)){const t=this.filters.get(e);t.highpass.disconnect(),t.lowpass.disconnect(),t.notch.disconnect(),this.filters.delete(e),console.log(`ğŸ—‘ï¸ [AudioManager] ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒã‚§ãƒ¼ãƒ³å‰Šé™¤: ${e}`)}}release(e=[]){e.forEach(t=>this.removeAnalyser(t)),this.refCount=Math.max(0,this.refCount-1),console.log(`ğŸ“‰ [AudioManager] å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆæ¸›ç®—: ${this.refCount}`),this.refCount<=0&&(console.log("ğŸ§¹ [AudioManager] å…¨ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹"),this._cleanup())}forceCleanup(){console.log("ğŸš¨ [AudioManager] å¼·åˆ¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œ"),this._cleanup()}_cleanup(){for(const e of this.analysers.keys())this.removeAnalyser(e);this.mediaStream&&(this.mediaStream.getTracks().forEach(e=>{e.stop(),console.log("ğŸ›‘ [AudioManager] MediaStreamTrackåœæ­¢")}),this.mediaStream=null),this.audioContext&&this.audioContext.state!=="closed"&&(this.audioContext.close(),console.log("ğŸ›‘ [AudioManager] AudioContexté–‰é–"),this.audioContext=null),this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.isInitialized=!1,this.refCount=0,this.initPromise=null,console.log("âœ… [AudioManager] ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†")}getStatus(){var e,t;return{isInitialized:this.isInitialized,refCount:this.refCount,audioContextState:((e=this.audioContext)==null?void 0:e.state)||"none",mediaStreamActive:((t=this.mediaStream)==null?void 0:t.active)||!1,activeAnalysers:Array.from(this.analysers.keys()),activeFilters:Array.from(this.filters.keys()),lastError:this.lastError}}checkMediaStreamHealth(){if(!this.mediaStream)return{healthy:!1,reason:"MediaStream not initialized"};const e=this.mediaStream.getTracks();if(e.length===0)return{healthy:!1,reason:"No tracks available"};const t=e.find(i=>i.kind==="audio");return t?t.readyState==="ended"?{healthy:!1,reason:"Audio track ended"}:t.enabled?{healthy:!0,track:t}:{healthy:!1,reason:"Audio track disabled"}:{healthy:!1,reason:"No audio track found"}}}const h=new u;typeof window<"u"&&(window.audioManager=h);export{h as a};
