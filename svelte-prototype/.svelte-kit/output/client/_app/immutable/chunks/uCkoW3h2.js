var tt=Object.defineProperty;var nt=(i,e,t)=>e in i?tt(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var Q=(i,e,t)=>nt(i,typeof e!="symbol"?e+"":e,t);import{S as Ge,i as Qe,s as Ue,d as Ce,n as Ve,a as Je,D as Te,b as Y,L as I,z as G,f as Ke,g as B,h as K,j as W,k as re,m as be,o as X,p as Ae,F as st,a0 as Ne,J as Be,q as ot,r as rt,u as it,e as ke,w as at,l as Re,A as He,x as ct,t as qe,y as lt}from"./DmID7u62.js";import{g as ut}from"./D0QH3NT1.js";import"./DfcMgxLU.js";function ht(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function q(i){if(this.size=i|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=i<<1;for(var e=new Array(this.size*2),t=0;t<e.length;t+=2){const l=Math.PI*t/this.size;e[t]=Math.cos(l),e[t+1]=-Math.sin(l)}this.table=e;for(var s=0,n=1;this.size>n;n<<=1)s++;this._width=s%2===0?s-1:s,this._bitrev=new Array(1<<this._width);for(var o=0;o<this._bitrev.length;o++){this._bitrev[o]=0;for(var c=0;c<this._width;c+=2){var h=this._width-c-2;this._bitrev[o]|=(o>>>c&3)<<h}}this._out=null,this._data=null,this._inv=0}var dt=q;q.prototype.fromComplexArray=function(e,t){for(var s=t||new Array(e.length>>>1),n=0;n<e.length;n+=2)s[n>>>1]=e[n];return s};q.prototype.createComplexArray=function(){const e=new Array(this._csize);for(var t=0;t<e.length;t++)e[t]=0;return e};q.prototype.toComplexArray=function(e,t){for(var s=t||this.createComplexArray(),n=0;n<s.length;n+=2)s[n]=e[n>>>1],s[n+1]=0;return s};q.prototype.completeSpectrum=function(e){for(var t=this._csize,s=t>>>1,n=2;n<s;n+=2)e[t-n]=e[n],e[t-n+1]=-e[n+1]};q.prototype.transform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._transform4(),this._out=null,this._data=null};q.prototype.realTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._realTransform4(),this._out=null,this._data=null};q.prototype.inverseTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=1,this._transform4();for(var s=0;s<e.length;s++)e[s]/=this.size;this._out=null,this._data=null};q.prototype._transform4=function(){var e=this._out,t=this._csize,s=this._width,n=1<<s,o=t/n<<1,c,h,l=this._bitrev;if(o===4)for(c=0,h=0;c<t;c+=o,h++){const f=l[h];this._singleTransform2(c,f,n)}else for(c=0,h=0;c<t;c+=o,h++){const f=l[h];this._singleTransform4(c,f,n)}var a=this._inv?-1:1,d=this.table;for(n>>=2;n>=2;n>>=2){o=t/n<<1;var m=o>>>2;for(c=0;c<t;c+=o)for(var v=c+m,g=c,u=0;g<v;g+=2,u+=n){const f=g,b=f+m,_=b+m,M=_+m,A=e[f],P=e[f+1],C=e[b],y=e[b+1],S=e[_],p=e[_+1],D=e[M],E=e[M+1],k=A,V=P,U=d[u],j=a*d[u+1],R=C*U-y*j,F=C*j+y*U,N=d[2*u],ie=a*d[2*u+1],Z=S*N-p*ie,O=S*ie+p*N,$=d[3*u],J=a*d[3*u+1],ee=D*$-E*J,ae=D*J+E*$,ce=k+Z,te=V+O,ne=k-Z,se=V-O,le=R+ee,ue=F+ae,r=a*(R-ee),w=a*(F-ae),x=ce+le,T=te+ue,z=ce-le,oe=te-ue,de=ne+w,he=se-r,ye=ne-w,_e=se+r;e[f]=x,e[f+1]=T,e[b]=de,e[b+1]=he,e[_]=z,e[_+1]=oe,e[M]=ye,e[M+1]=_e}}};q.prototype._singleTransform2=function(e,t,s){const n=this._out,o=this._data,c=o[t],h=o[t+1],l=o[t+s],a=o[t+s+1],d=c+l,m=h+a,v=c-l,g=h-a;n[e]=d,n[e+1]=m,n[e+2]=v,n[e+3]=g};q.prototype._singleTransform4=function(e,t,s){const n=this._out,o=this._data,c=this._inv?-1:1,h=s*2,l=s*3,a=o[t],d=o[t+1],m=o[t+s],v=o[t+s+1],g=o[t+h],u=o[t+h+1],f=o[t+l],b=o[t+l+1],_=a+g,M=d+u,A=a-g,P=d-u,C=m+f,y=v+b,S=c*(m-f),p=c*(v-b),D=_+C,E=M+y,k=A+p,V=P-S,U=_-C,j=M-y,R=A-p,F=P+S;n[e]=D,n[e+1]=E,n[e+2]=k,n[e+3]=V,n[e+4]=U,n[e+5]=j,n[e+6]=R,n[e+7]=F};q.prototype._realTransform4=function(){var e=this._out,t=this._csize,s=this._width,n=1<<s,o=t/n<<1,c,h,l=this._bitrev;if(o===4)for(c=0,h=0;c<t;c+=o,h++){const Pe=l[h];this._singleRealTransform2(c,Pe>>>1,n>>>1)}else for(c=0,h=0;c<t;c+=o,h++){const Pe=l[h];this._singleRealTransform4(c,Pe>>>1,n>>>1)}var a=this._inv?-1:1,d=this.table;for(n>>=2;n>=2;n>>=2){o=t/n<<1;var m=o>>>1,v=m>>>1,g=v>>>1;for(c=0;c<t;c+=o)for(var u=0,f=0;u<=g;u+=2,f+=n){var b=c+u,_=b+v,M=_+v,A=M+v,P=e[b],C=e[b+1],y=e[_],S=e[_+1],p=e[M],D=e[M+1],E=e[A],k=e[A+1],V=P,U=C,j=d[f],R=a*d[f+1],F=y*j-S*R,N=y*R+S*j,ie=d[2*f],Z=a*d[2*f+1],O=p*ie-D*Z,$=p*Z+D*ie,J=d[3*f],ee=a*d[3*f+1],ae=E*J-k*ee,ce=E*ee+k*J,te=V+O,ne=U+$,se=V-O,le=U-$,ue=F+ae,r=N+ce,w=a*(F-ae),x=a*(N-ce),T=te+ue,z=ne+r,oe=se+x,de=le-w;if(e[b]=T,e[b+1]=z,e[_]=oe,e[_+1]=de,u===0){var he=te-ue,ye=ne-r;e[M]=he,e[M+1]=ye;continue}if(u!==g){var _e=se,fe=-le,Me=te,De=-ne,xe=-a*x,L=-a*w,we=-a*r,Ye=-a*ue,Ze=_e+xe,Oe=fe+L,$e=Me+Ye,et=De-we,Fe=c+v-u,Ee=c+m-u;e[Fe]=Ze,e[Fe+1]=Oe,e[Ee]=$e,e[Ee+1]=et}}}};q.prototype._singleRealTransform2=function(e,t,s){const n=this._out,o=this._data,c=o[t],h=o[t+s],l=c+h,a=c-h;n[e]=l,n[e+1]=0,n[e+2]=a,n[e+3]=0};q.prototype._singleRealTransform4=function(e,t,s){const n=this._out,o=this._data,c=this._inv?-1:1,h=s*2,l=s*3,a=o[t],d=o[t+s],m=o[t+h],v=o[t+l],g=a+m,u=a-m,f=d+v,b=c*(d-v),_=g+f,M=u,A=-b,P=g-f,C=u,y=b;n[e]=_,n[e+1]=0,n[e+2]=M,n[e+3]=A,n[e+4]=P,n[e+5]=0,n[e+6]=C,n[e+7]=y};const mt=ht(dt);class pe{constructor(e,t){Q(this,"_inputLength");Q(this,"_fft");Q(this,"_bufferSupplier");Q(this,"_paddedInputBuffer");Q(this,"_transformBuffer");Q(this,"_inverseBuffer");if(e<1)throw new Error("Input length must be at least one");this._inputLength=e,this._fft=new mt(vt(2*e)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(e){return new pe(e,t=>new Float32Array(t))}static forFloat64Array(e){return new pe(e,t=>new Float64Array(t))}static forNumberArray(e){return new pe(e,t=>Array(t))}get inputLength(){return this._inputLength}autocorrelate(e,t=this._bufferSupplier(e.length)){if(e.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${e.length}`);for(let n=0;n<e.length;n++)this._paddedInputBuffer[n]=e[n];for(let n=e.length;n<this._paddedInputBuffer.length;n++)this._paddedInputBuffer[n]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const s=this._transformBuffer;for(let n=0;n<s.length;n+=2)s[n]=s[n]*s[n]+s[n+1]*s[n+1],s[n+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let n=0;n<e.length;n++)t[n]=this._inverseBuffer[2*n];return t}}function ft(i){const e=[];let t=!1,s=-1/0,n=-1;for(let o=1;o<i.length-1;o++)i[o-1]<=0&&i[o]>0?(t=!0,n=o,s=i[o]):i[o-1]>0&&i[o]<=0?(t=!1,n!==-1&&e.push(n)):t&&i[o]>s&&(s=i[o],n=o);return e}function gt(i,e){const[t,s,n]=[i-1,i,i+1],[o,c,h]=[e[t],e[s],e[n]],l=o/2-c+h/2,a=-(o/2)*(s+n)+c*(t+n)-h/2*(t+s),d=o*s*n/2-c*t*n+h*t*s/2,m=-a/(2*l),v=l*m*m+a*m+d;return[m,v]}class ve{constructor(e,t){Q(this,"_autocorrelator");Q(this,"_nsdfBuffer");Q(this,"_clarityThreshold",.9);Q(this,"_minVolumeAbsolute",0);Q(this,"_maxInputAmplitude",1);this._autocorrelator=new pe(e,t),this._nsdfBuffer=t(e)}static forFloat32Array(e){return new ve(e,t=>new Float32Array(t))}static forFloat64Array(e){return new ve(e,t=>new Float64Array(t))}static forNumberArray(e){return new ve(e,t=>Array(t))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(e){if(!Number.isFinite(e)||e<=0||e>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=e}set minVolumeAbsolute(e){if(!Number.isFinite(e)||e<0||e>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=e}set minVolumeDecibels(e){if(!Number.isFinite(e)||e>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(e/10)}set maxInputAmplitude(e){if(!Number.isFinite(e)||e<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=e}findPitch(e,t){if(this._belowMinimumVolume(e))return[0,0];this._nsdf(e);const s=ft(this._nsdfBuffer);if(s.length===0)return[0,0];const n=Math.max(...s.map(l=>this._nsdfBuffer[l])),o=s.find(l=>this._nsdfBuffer[l]>=this._clarityThreshold*n),[c,h]=gt(o,this._nsdfBuffer);return[t/c,Math.min(h,1)]}_belowMinimumVolume(e){if(this._minVolumeAbsolute===0)return!1;let t=0;for(let s=0;s<e.length;s++)t+=e[s]**2;return Math.sqrt(t/e.length)<this._minVolumeAbsolute}_nsdf(e){this._autocorrelator.autocorrelate(e,this._nsdfBuffer);let t=2*this._nsdfBuffer[0],s;for(s=0;s<this._nsdfBuffer.length&&t>0;s++)this._nsdfBuffer[s]=2*this._nsdfBuffer[s]/t,t-=e[s]**2+e[e.length-s-1]**2;for(;s<this._nsdfBuffer.length;s++)this._nsdfBuffer[s]=0}}function vt(i){return i--,i|=i>>1,i|=i>>2,i|=i>>4,i|=i>>8,i|=i>>16,i++,i}const Se="src/lib/components/VolumeBar.svelte";function ze(i){let e,t,s,n,o,c;const h={c:function(){e=X("div"),t=X("div"),s=X("div"),n=Ae(),o=X("div"),this.h()},l:function(a){e=W(a,"DIV",{class:!0});var d=re(e);t=W(d,"DIV",{class:!0,style:!0});var m=re(t);s=W(m,"DIV",{class:!0,style:!0}),re(s).forEach(Y),m.forEach(Y),n=be(d),o=W(d,"DIV",{class:!0,style:!0}),re(o).forEach(Y),d.forEach(Y),this.h()},h:function(){G(s,"class","volume-bar-fill"),I(s,"position","absolute"),I(s,"top","0"),I(s,"left","0"),I(s,"height","100%"),K(s,Se,51,4,1464),G(t,"class","volume-bar-bg"),I(t,"height",i[1]),I(t,"border-radius","9999px"),I(t,"background-color","#e2e8f0"),I(t,"position","relative"),I(t,"overflow","hidden"),K(t,Se,50,2,1318),G(o,"class","threshold-indicator svelte-13z7ppf"),I(o,"position","absolute"),I(o,"top","0"),I(o,"left",i[0]+"%"),I(o,"width","2px"),I(o,"height",i[1]),I(o,"background-color","#64748b"),I(o,"border-radius","1px"),K(o,Se,59,2,1643),G(e,"class",c="volume-bar-container "+i[2]+" svelte-13z7ppf"),K(e,Se,49,0,1269)},m:function(a,d){Ke(a,e,d),B(e,t),B(t,s),i[5](s),B(e,n),B(e,o)},p:function(a,[d]){d&2&&I(t,"height",a[1]),d&1&&I(o,"left",a[0]+"%"),d&2&&I(o,"height",a[1]),d&4&&c!==(c="volume-bar-container "+a[2]+" svelte-13z7ppf")&&G(e,"class",c)},i:Ve,o:Ve,d:function(a){a&&Y(e),i[5](null)}};return Ce("SvelteRegisterBlock",{block:h,id:ze.name,type:"component",source:"",ctx:i}),h}function yt(i,e,t){let{$$slots:s={},$$scope:n}=e;Je("VolumeBar",s,[]);let{volume:o=0}=e,{threshold:c=30}=e,{height:h="12px"}=e,{className:l=""}=e,a;function d(u){return u<c?`rgba(37, 99, 235, ${Math.max(.2,u/c*.8)})`:"#2563eb"}function m(u){if(a){const f=Math.max(0,Math.min(100,u)),b=d(f);t(3,a.style.width=`${f}%`,a),t(3,a.style.backgroundColor=b,a)}}Te(()=>{a&&(t(3,a.style.width="0%",a),t(3,a.style.backgroundColor="#2563eb",a),t(3,a.style.height=h,a),t(3,a.style.borderRadius="9999px",a),t(3,a.style.transition="width 0.2s ease-out, background-color 0.2s ease-out",a))});const v=["volume","threshold","height","className"];Object.keys(e).forEach(u=>{!~v.indexOf(u)&&u.slice(0,2)!=="$$"&&u!=="slot"&&console.warn(`<VolumeBar> was created with unknown prop '${u}'`)});function g(u){st[u?"unshift":"push"](()=>{a=u,t(3,a)})}return i.$$set=u=>{"volume"in u&&t(4,o=u.volume),"threshold"in u&&t(0,c=u.threshold),"height"in u&&t(1,h=u.height),"className"in u&&t(2,l=u.className)},i.$capture_state=()=>({onMount:Te,volume:o,threshold:c,height:h,className:l,barElement:a,getVolumeColor:d,updateVolumeBar:m}),i.$inject_state=u=>{"volume"in u&&t(4,o=u.volume),"threshold"in u&&t(0,c=u.threshold),"height"in u&&t(1,h=u.height),"className"in u&&t(2,l=u.className),"barElement"in u&&t(3,a=u.barElement)},e&&"$$inject"in e&&i.$inject_state(e.$$inject),i.$$.update=()=>{i.$$.dirty&16&&m(o)},[c,h,l,a,o,g]}class We extends Ge{constructor(e){super(e),Qe(this,e,yt,ze,Ue,{volume:4,threshold:0,height:1,className:2}),Ce("SvelteRegisterComponent",{component:this,tagName:"VolumeBar",options:e,id:ze.name})}get volume(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set volume(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get threshold(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set threshold(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get height(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set height(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}class _t{constructor(){this.audioContext=null,this.mediaStream=null,this.sourceNode=null,this.analysers=new Map,this.filters=new Map,this.refCount=0,this.initPromise=null,this.isInitialized=!1,this.lastError=null}async initialize(){var e,t,s;if(this.initPromise)return this.initPromise;if(this.isInitialized&&this.audioContext&&this.mediaStream){const n=this.checkMediaStreamHealth();if(n.healthy)return this.refCount++,{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode};console.warn("⚠️ [AudioManager] MediaStream不健康検出 - 強制再初期化:",n.reason),console.log("🔄 [AudioManager] 不健康なMediaStream詳細:",{mediaStreamActive:(e=this.mediaStream)==null?void 0:e.active,trackCount:(t=this.mediaStream)==null?void 0:t.getTracks().length,trackStates:(s=this.mediaStream)==null?void 0:s.getTracks().map(o=>({kind:o.kind,readyState:o.readyState,enabled:o.enabled,muted:o.muted}))}),this._cleanup(),this.isInitialized=!1,this.refCount=0,await new Promise(o=>setTimeout(o,100)),console.log("🔄 [AudioManager] クリーンアップ完了 - 再初期化開始")}this.initPromise=this._doInitialize();try{const n=await this.initPromise;return this.initPromise=null,n}catch(n){throw this.initPromise=null,n}}async _doInitialize(){try{if(console.log("🎤 [AudioManager] 初期化開始"),this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),console.log("✅ [AudioManager] AudioContext作成完了")),this.audioContext.state==="suspended"&&(await this.audioContext.resume(),console.log("✅ [AudioManager] AudioContext再開完了")),!this.mediaStream){const e={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,sampleRate:44100,channelCount:1,sampleSize:16,latency:.1,volume:1,deviceId:{ideal:"default"}}};console.log("🎤 [AudioManager] Safari対応設定でMediaStream取得中:",e),this.mediaStream=await navigator.mediaDevices.getUserMedia(e),console.log("✅ [AudioManager] MediaStream取得完了")}if(!this.sourceNode){this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),console.log("✅ [AudioManager] SourceNode作成完了");const e=this.mediaStream.getTracks();console.log("🎤 [AudioManager] MediaStream tracks:",e.map(t=>({kind:t.kind,label:t.label,enabled:t.enabled,readyState:t.readyState,muted:t.muted})))}return this.isInitialized=!0,this.refCount++,this.lastError=null,console.log(`🎤 [AudioManager] 初期化完了 (参照カウント: ${this.refCount})`),{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode}}catch(e){throw console.error("❌ [AudioManager] 初期化エラー:",e),this.lastError=e,this.isInitialized=!1,this._cleanup(),e}}createAnalyser(e,t={}){if(!this.isInitialized||!this.audioContext||!this.sourceNode)throw new Error("AudioManager not initialized. Call initialize() first.");this.removeAnalyser(e);const{fftSize:s=2048,smoothingTimeConstant:n=.8,minDecibels:o=-90,maxDecibels:c=-10,useFilters:h=!0}=t,l=this.audioContext.createAnalyser();if(l.fftSize=Math.min(s,2048),l.smoothingTimeConstant=Math.max(n,.7),l.minDecibels=Math.max(o,-80),l.maxDecibels=Math.min(c,-10),this.sourceNode,h){const a=this._createFilterChain();this.filters.set(e,a),this.sourceNode.connect(a.highpass),a.highpass.connect(a.lowpass),a.lowpass.connect(a.notch),a.notch.connect(l),console.log(`🔧 [AudioManager] フィルター付きAnalyser作成: ${e}`)}else this.sourceNode.connect(l),console.log(`🔧 [AudioManager] 生信号Analyser作成: ${e}`);return this.analysers.set(e,l),l}_createFilterChain(){const e=this.audioContext.createBiquadFilter();e.type="highpass",e.frequency.setValueAtTime(80,this.audioContext.currentTime),e.Q.setValueAtTime(.7,this.audioContext.currentTime);const t=this.audioContext.createBiquadFilter();t.type="lowpass",t.frequency.setValueAtTime(800,this.audioContext.currentTime),t.Q.setValueAtTime(.7,this.audioContext.currentTime);const s=this.audioContext.createBiquadFilter();return s.type="notch",s.frequency.setValueAtTime(60,this.audioContext.currentTime),s.Q.setValueAtTime(10,this.audioContext.currentTime),{highpass:e,lowpass:t,notch:s}}removeAnalyser(e){if(this.analysers.has(e)&&(this.analysers.get(e).disconnect(),this.analysers.delete(e),console.log(`🗑️ [AudioManager] Analyser削除: ${e}`)),this.filters.has(e)){const t=this.filters.get(e);t.highpass.disconnect(),t.lowpass.disconnect(),t.notch.disconnect(),this.filters.delete(e),console.log(`🗑️ [AudioManager] フィルターチェーン削除: ${e}`)}}release(e=[]){e.forEach(t=>this.removeAnalyser(t)),this.refCount=Math.max(0,this.refCount-1),console.log(`📉 [AudioManager] 参照カウント減算: ${this.refCount}`),this.refCount<=0&&(console.log("🧹 [AudioManager] 全リソースクリーンアップ開始"),this._cleanup())}forceCleanup(){console.log("🚨 [AudioManager] 強制クリーンアップ実行"),this._cleanup()}_cleanup(){console.log("🧹 [AudioManager] クリーンアップ開始");for(const e of this.analysers.keys())this.removeAnalyser(e);if(this.mediaStream){const e=this.mediaStream.getTracks();console.log(`🛑 [AudioManager] MediaStream停止中: ${e.length} tracks`),e.forEach((t,s)=>{try{t.readyState!=="ended"?(t.stop(),console.log(`🛑 [AudioManager] Track ${s} 停止完了`)):console.log(`⚠️ [AudioManager] Track ${s} 既に終了済み`)}catch(n){console.warn(`⚠️ [AudioManager] Track ${s} 停止エラー:`,n)}}),this.mediaStream=null}if(this.audioContext&&this.audioContext.state!=="closed"){try{this.audioContext.close(),console.log("🛑 [AudioManager] AudioContext閉鎖完了")}catch(e){console.warn("⚠️ [AudioManager] AudioContext閉鎖エラー:",e)}this.audioContext=null}this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.isInitialized=!1,this.refCount=0,this.initPromise=null,console.log("✅ [AudioManager] クリーンアップ完了")}getStatus(){var e,t;return{isInitialized:this.isInitialized,refCount:this.refCount,audioContextState:((e=this.audioContext)==null?void 0:e.state)||"none",mediaStreamActive:((t=this.mediaStream)==null?void 0:t.active)||!1,activeAnalysers:Array.from(this.analysers.keys()),activeFilters:Array.from(this.filters.keys()),lastError:this.lastError}}checkMediaStreamHealth(){if(!this.mediaStream)return{healthy:!1,reason:"MediaStream not initialized"};if(!this.mediaStream.active)return{healthy:!1,reason:"MediaStream inactive"};const e=this.mediaStream.getTracks();if(e.length===0)return{healthy:!1,reason:"No tracks available"};const t=e.find(s=>s.kind==="audio");return t?t.readyState==="ended"?{healthy:!1,reason:"Audio track ended"}:t.enabled?t.muted?{healthy:!1,reason:"Audio track muted"}:this.mediaStream.active&&t.readyState!=="live"?{healthy:!1,reason:"Track state inconsistent with MediaStream"}:{healthy:!0,track:t}:{healthy:!1,reason:"Audio track disabled"}:{healthy:!1,reason:"No audio track found"}}}const ge=new _t;typeof window<"u"&&(window.audioManager=ge);const{Error:H,console:wt}=ut,me="src/lib/components/PitchDetector.svelte";function Ie(i){let e,t,s,n,o=(i[2]>0?Math.round(i[2]):"---")+"",c,h,l,a="Hz",d,m,v="|",g,u,f,b,_,M,A;_=new We({props:{volume:i[2]>0?i[1]:0,className:"volume-bar"},$$inline:!0});const P={c:function(){e=X("div"),t=X("div"),s=X("div"),n=X("span"),c=qe(o),h=Ae(),l=X("span"),l.textContent=a,d=Ae(),m=X("span"),m.textContent=v,g=Ae(),u=X("span"),f=qe(i[3]),b=Ae(),lt(_.$$.fragment),this.h()},l:function(y){e=W(y,"DIV",{class:!0});var S=re(e);t=W(S,"DIV",{class:!0});var p=re(t);s=W(p,"DIV",{class:!0});var D=re(s);n=W(D,"SPAN",{class:!0});var E=re(n);c=Re(E,o),E.forEach(Y),h=be(D),l=W(D,"SPAN",{class:!0,"data-svelte-h":!0}),He(l)!=="svelte-5uyilv"&&(l.textContent=a),d=be(D),m=W(D,"SPAN",{class:!0,"data-svelte-h":!0}),He(m)!=="svelte-1dytxz4"&&(m.textContent=v),g=be(D),u=W(D,"SPAN",{class:!0});var k=re(u);f=Re(k,i[3]),k.forEach(Y),D.forEach(Y),b=be(p),ct(_.$$.fragment,p),p.forEach(Y),S.forEach(Y),this.h()},h:function(){G(n,"class","detected-frequency svelte-vc1bho"),K(n,me,595,6,17375),G(l,"class","hz-suffix svelte-vc1bho"),K(l,me,596,6,17483),G(m,"class","divider svelte-vc1bho"),K(m,me,597,6,17523),G(u,"class","detected-note svelte-vc1bho"),K(u,me,598,6,17560),G(s,"class","detection-card svelte-vc1bho"),K(s,me,594,4,17340),G(t,"class","detection-display svelte-vc1bho"),K(t,me,593,2,17304),G(e,"class",M="pitch-detector "+i[0]+" svelte-vc1bho"),K(e,me,592,0,17261)},m:function(y,S){Ke(y,e,S),B(e,t),B(t,s),B(s,n),B(n,c),B(s,h),B(s,l),B(s,d),B(s,m),B(s,g),B(s,u),B(u,f),B(t,b),at(_,t,null),A=!0},p:function(y,S){(!A||S[0]&4)&&o!==(o=(y[2]>0?Math.round(y[2]):"---")+"")&&ke(c,o),(!A||S[0]&8)&&ke(f,y[3]);const p={};S[0]&6&&(p.volume=y[2]>0?y[1]:0),_.$set(p),(!A||S[0]&1&&M!==(M="pitch-detector "+y[0]+" svelte-vc1bho"))&&G(e,"class",M)},i:function(y){A||(it(_.$$.fragment,y),A=!0)},o:function(y){rt(_.$$.fragment,y),A=!1},d:function(y){y&&Y(e),ot(_)}};return Ce("SvelteRegisterBlock",{block:P,id:Ie.name,type:"component",source:"",ctx:i}),P}function Xe(i){const t=Math.log2(i/261.63)*12,s=Math.round(t),n=Math.abs(t-s);return Math.max(0,1-n/.5)}function je(i,e){const t=[i,i/2,i/3,i/4,i*2],s=130.81,n=1046.5,o=l=>{const d=l>=s&&l<=n?1:0,m=e>0?1-Math.min(Math.abs(l-e)/e,1):.5,v=Xe(l),g=d*.4+m*.4+v*.2;return{freq:l,score:g}};return t.map(o).reduce((l,a)=>a.score>l.score?a:l).freq}function Le(i){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(i<=0)return"ーー";const s=Math.round(12*Math.log2(i/440)),n=(s+9+120)%12,o=Math.floor((s+9)/12)+4;return e[n]+o}function bt(i,e,t){let{$$slots:s={},$$scope:n}=e;Je("PitchDetector",s,[]);const o=Ne();let{isActive:c=!1}=e,{className:h=""}=e,{debugMode:l=!1}=e,a="uninitialized",d=null,m=!1,v=null,g=null,u=null,f=null,b=null,_=null,M=null,A=!1,P=[],C=new Map,y=0,S=0,p=0,D="ーー",E=0,k=[],V=[],U=0,j=0,R=0,F=[],N=null;function ie(){y=0,t(1,S=0),t(2,p=0),t(3,D="ーー"),E=0,U=0,j=0,R=0,k=[],V=[],F=[],l&&console.log("🔄 [PitchDetector] Display state reset")}function Z(){if(!l)return;const r=new Date().toLocaleTimeString(),w={timestamp:r,componentState:a,isActive:c,isDetecting:A,isInitialized:m,mediaStreamActive:g?g.active:null,mediaStreamTracks:g?g.getTracks().length:0,trackStates:g?g.getTracks().map(z=>({kind:z.kind,enabled:z.enabled,readyState:z.readyState,muted:z.muted})):[],audioContextState:v?v.state:null,hasAnalyser:!!f,currentVolume:y,currentFrequency:p};console.log(`🎤 [PitchDetector] ${r}:`,w);let x=!0,T=[];g&&!g.active&&(console.warn("⚠️ [PitchDetector] MediaStream is inactive!",g),x=!1,T.push("MediaStream inactive")),v&&v.state==="suspended"&&(console.warn("⚠️ [PitchDetector] AudioContext is suspended!",v),x=!1,T.push("AudioContext suspended")),g&&g.getTracks().forEach((z,oe)=>{z.readyState==="ended"&&(console.error(`❌ [PitchDetector] Track ${oe} has ended!`,z),x=!1,T.push(`Track ${oe} ended`))}),o("microphoneHealthChange",{healthy:x,errors:T,details:w})}async function O(){try{t(14,a="initializing"),d=null,console.log("🎙️ [PitchDetector] AudioManager経由で初期化開始");const r=await ge.initialize();v=r.audioContext,g=r.mediaStream,u=r.sourceNode,console.log("✅ [PitchDetector] AudioManager リソース取得完了");const w=`pitch-detector-filtered-${Date.now()}`;t(15,f=ge.createAnalyser(w,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!0})),P.push(w);const x=`pitch-detector-raw-${Date.now()}`;b=ge.createAnalyser(x,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!1}),P.push(x),console.log("✅ [PitchDetector] Analyser作成完了:",P),_=ve.forFloat32Array(f.fftSize),t(14,a="ready"),m=!0,o("stateChange",{state:a}),le(),console.log("✅ [PitchDetector] 初期化完了")}catch(r){throw console.error("❌ [PitchDetector] 初期化エラー:",r),t(14,a="error"),d=r,m=!1,o("error",{error:r,context:"initialization"}),r}}function $(){if(a!=="ready"){const r=new Error(`Cannot start detection: component state is ${a}`);return o("error",{error:r,context:"start-detection"}),!1}if(!f||!_||!v){const r=new Error("Required components not available");return t(14,a="error"),o("error",{error:r,context:"start-detection"}),!1}return t(14,a="detecting"),t(16,A=!0),o("stateChange",{state:a}),ee(),!0}function J(){t(16,A=!1),M&&(cancelAnimationFrame(M),M=null),a==="detecting"&&m&&(t(14,a="ready"),o("stateChange",{state:a}))}function ee(){if(!A||!f||!b||!_)return;const r=f.fftSize,w=new Float32Array(r),x=new Float32Array(b.fftSize);f.getFloatTimeDomainData(w),b.getFloatTimeDomainData(x);let T=0;for(let L=0;L<r;L++)T+=Math.abs(w[L]);const z=Math.sqrt(T/r),oe=Math.log10(z+.001)*50+100,de=Math.max(0,Math.min(100,oe));let he=0;for(let L=0;L<x.length;L++)he+=Math.abs(x[L]);const ye=Math.sqrt(he/x.length),_e=Math.log10(ye+.001)*50+100;t(1,S=Math.max(0,Math.min(100,_e))),V.push(de),V.length>5&&V.shift(),j=V.reduce((L,we)=>L+we,0)/V.length,y=j;const[fe,Me]=_.findPitch(w,v.sampleRate),De=fe>=65&&fe<=1200;if(fe&&Me>.6&&y>10&&De){const L=je(fe,R),we=ae(L);t(2,p=Math.round(we)),t(3,D=Le(p)),E=Me,R=p}else F.length>0&&(F=[]),p===0&&(R=0),t(2,p=0),t(3,D="ーー"),E=0;const xe=p>0?S:0;o("pitchUpdate",{frequency:p,note:D,volume:y,rawVolume:xe,clarity:E}),M=requestAnimationFrame(ee)}function ae(r,w=.1){F.push(r),F.length>5&&F.shift();const x=[...F].sort((de,he)=>de-he),T=x[Math.floor(x.length/2)],z=T*w;return Math.abs(r-T)>z?T+Math.sign(r-T)*z:r}function ce(){return m&&a==="ready"}function te(){return{componentState:a,isInitialized:m,isDetecting:A,lastError:d,hasRequiredComponents:!!(f&&_&&v&&g)}}async function ne(){console.log("🔄 [PitchDetector] 再初期化開始"),se(),await new Promise(r=>setTimeout(r,100)),await O(),console.log("✅ [PitchDetector] 再初期化完了")}function se(){console.log("🧹 [PitchDetector] クリーンアップ開始"),J(),C.size>0&&(C.forEach((r,w)=>{w.removeEventListener("ended",r.endedHandler),w.removeEventListener("mute",r.muteHandler),w.removeEventListener("unmute",r.unmuteHandler)}),C.clear(),console.log("🔄 [PitchDetector] MediaStreamイベントリスナー削除")),P.length>0&&(ge.release(P),console.log("📤 [PitchDetector] AudioManagerにAnalyser解放通知:",P),P=[]),t(14,a="uninitialized"),m=!1,d=null,v=null,g=null,u=null,t(15,f=null),b=null,_=null,k=[],V=[],F=[],console.log("✅ [PitchDetector] クリーンアップ完了")}function le(){if(!g)return;const r=g.getTracks();r.forEach(w=>{const x=()=>{console.error("🚨 [PitchDetector] MediaStreamTrack終了検出:",w.kind),t(14,a="error"),d=new Error(`MediaStreamTrack (${w.kind}) ended`),o("error",{error:d,reason:"mediastream_ended",recovery:"restart_required"}),A&&J()},T=()=>{console.warn("⚠️ [PitchDetector] MediaStreamTrack muted:",w.kind),o("warning",{reason:"track_muted",track:w.kind})},z=()=>{console.log("✅ [PitchDetector] MediaStreamTrack unmuted:",w.kind),o("info",{reason:"track_unmuted",track:w.kind})};w.addEventListener("ended",x),w.addEventListener("mute",T),w.addEventListener("unmute",z),C.set(w,{endedHandler:x,muteHandler:T,unmuteHandler:z})}),console.log("🔍 [PitchDetector] MediaStream監視開始:",r.length+" tracks")}Be(()=>{N&&(clearInterval(N),t(17,N=null)),console.log("🔄 [PitchDetector] onDestroy - AudioManagerリソースは保持")});const ue=["isActive","className","debugMode"];return Object.keys(e).forEach(r=>{!~ue.indexOf(r)&&r.slice(0,2)!=="$$"&&r!=="slot"&&wt.warn(`<PitchDetector> was created with unknown prop '${r}'`)}),i.$$set=r=>{"isActive"in r&&t(4,c=r.isActive),"className"in r&&t(0,h=r.className),"debugMode"in r&&t(5,l=r.debugMode)},i.$capture_state=()=>({onMount:Te,onDestroy:Be,createEventDispatcher:Ne,PitchDetector:ve,VolumeBar:We,audioManager:ge,dispatch:o,isActive:c,className:h,debugMode:l,componentState:a,lastError:d,isInitialized:m,audioContext:v,mediaStream:g,sourceNode:u,analyser:f,rawAnalyser:b,pitchDetector:_,animationFrame:M,isDetecting:A,analyserIds:P,mediaStreamListeners:C,currentVolume:y,rawVolume:S,currentFrequency:p,detectedNote:D,pitchClarity:E,frequencyHistory:k,volumeHistory:V,stableFrequency:U,stableVolume:j,previousFrequency:R,harmonicHistory:F,debugInterval:N,resetDisplayState:ie,checkMicrophoneStatus:Z,initialize:O,startDetection:$,stopDetection:J,detectPitch:ee,calculateMusicalScore:Xe,correctHarmonicFrequency:je,stabilizeFrequency:ae,frequencyToNote:Le,getIsInitialized:ce,getState:te,reinitialize:ne,cleanup:se,setupMediaStreamMonitoring:le}),i.$inject_state=r=>{"isActive"in r&&t(4,c=r.isActive),"className"in r&&t(0,h=r.className),"debugMode"in r&&t(5,l=r.debugMode),"componentState"in r&&t(14,a=r.componentState),"lastError"in r&&(d=r.lastError),"isInitialized"in r&&(m=r.isInitialized),"audioContext"in r&&(v=r.audioContext),"mediaStream"in r&&(g=r.mediaStream),"sourceNode"in r&&(u=r.sourceNode),"analyser"in r&&t(15,f=r.analyser),"rawAnalyser"in r&&(b=r.rawAnalyser),"pitchDetector"in r&&(_=r.pitchDetector),"animationFrame"in r&&(M=r.animationFrame),"isDetecting"in r&&t(16,A=r.isDetecting),"analyserIds"in r&&(P=r.analyserIds),"mediaStreamListeners"in r&&(C=r.mediaStreamListeners),"currentVolume"in r&&(y=r.currentVolume),"rawVolume"in r&&t(1,S=r.rawVolume),"currentFrequency"in r&&t(2,p=r.currentFrequency),"detectedNote"in r&&t(3,D=r.detectedNote),"pitchClarity"in r&&(E=r.pitchClarity),"frequencyHistory"in r&&(k=r.frequencyHistory),"volumeHistory"in r&&(V=r.volumeHistory),"stableFrequency"in r&&(U=r.stableFrequency),"stableVolume"in r&&(j=r.stableVolume),"previousFrequency"in r&&(R=r.previousFrequency),"harmonicHistory"in r&&(F=r.harmonicHistory),"debugInterval"in r&&t(17,N=r.debugInterval)},e&&"$$inject"in e&&i.$inject_state(e.$$inject),i.$$.update=()=>{i.$$.dirty[0]&131104&&(l&&!N?(console.log("🔍 [PitchDetector] Debug mode enabled - starting status monitoring"),t(17,N=setInterval(Z,3e3)),Z()):!l&&N&&(console.log("🔍 [PitchDetector] Debug mode disabled - stopping status monitoring"),clearInterval(N),t(17,N=null))),i.$$.dirty[0]&114704&&(c&&a==="ready"&&f&&!A?$():!c&&A&&J())},[h,S,p,D,c,l,ie,O,$,J,ce,te,ne,se,a,f,A,N]}class Ct extends Ge{constructor(e){super(e),Qe(this,e,bt,Ie,Ue,{isActive:4,className:0,debugMode:5,resetDisplayState:6,initialize:7,startDetection:8,stopDetection:9,getIsInitialized:10,getState:11,reinitialize:12,cleanup:13},null,[-1,-1]),Ce("SvelteRegisterComponent",{component:this,tagName:"PitchDetector_1",options:e,id:Ie.name})}get isActive(){throw new H("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set isActive(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new H("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get debugMode(){throw new H("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set debugMode(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get resetDisplayState(){return this.$$.ctx[6]}set resetDisplayState(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get initialize(){return this.$$.ctx[7]}set initialize(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get startDetection(){return this.$$.ctx[8]}set startDetection(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get stopDetection(){return this.$$.ctx[9]}set stopDetection(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get getIsInitialized(){return this.$$.ctx[10]}set getIsInitialized(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get getState(){return this.$$.ctx[11]}set getState(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get reinitialize(){return this.$$.ctx[12]}set reinitialize(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get cleanup(){return this.$$.ctx[13]}set cleanup(e){throw new H("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}export{Ct as P,We as V,ge as a};
