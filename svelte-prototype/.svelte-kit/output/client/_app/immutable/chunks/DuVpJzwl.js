var tt=Object.defineProperty;var st=(i,e,t)=>e in i?tt(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var Q=(i,e,t)=>st(i,typeof e!="symbol"?e+"":e,t);import{S as Ge,i as Qe,s as Le,d as De,n as Ve,a as Ue,D as Pe,b as X,H as F,z as G,f as Ke,g as N,h as K,j as J,k as ne,m as we,o as W,p as be,G as nt,a0 as Ee,E as Ne,q as ot,r as rt,u as it,e as Be,w as at,l as ke,A as Re,x as ct,t as He,y as lt}from"./Ci2ptbdh.js";import{g as ut}from"./D0QH3NT1.js";import"./CDirIs2-.js";function ht(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function H(i){if(this.size=i|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=i<<1;for(var e=new Array(this.size*2),t=0;t<e.length;t+=2){const l=Math.PI*t/this.size;e[t]=Math.cos(l),e[t+1]=-Math.sin(l)}this.table=e;for(var n=0,s=1;this.size>s;s<<=1)n++;this._width=n%2===0?n-1:n,this._bitrev=new Array(1<<this._width);for(var o=0;o<this._bitrev.length;o++){this._bitrev[o]=0;for(var c=0;c<this._width;c+=2){var h=this._width-c-2;this._bitrev[o]|=(o>>>c&3)<<h}}this._out=null,this._data=null,this._inv=0}var dt=H;H.prototype.fromComplexArray=function(e,t){for(var n=t||new Array(e.length>>>1),s=0;s<e.length;s+=2)n[s>>>1]=e[s];return n};H.prototype.createComplexArray=function(){const e=new Array(this._csize);for(var t=0;t<e.length;t++)e[t]=0;return e};H.prototype.toComplexArray=function(e,t){for(var n=t||this.createComplexArray(),s=0;s<n.length;s+=2)n[s]=e[s>>>1],n[s+1]=0;return n};H.prototype.completeSpectrum=function(e){for(var t=this._csize,n=t>>>1,s=2;s<n;s+=2)e[t-s]=e[s],e[t-s+1]=-e[s+1]};H.prototype.transform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._transform4(),this._out=null,this._data=null};H.prototype.realTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._realTransform4(),this._out=null,this._data=null};H.prototype.inverseTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=1,this._transform4();for(var n=0;n<e.length;n++)e[n]/=this.size;this._out=null,this._data=null};H.prototype._transform4=function(){var e=this._out,t=this._csize,n=this._width,s=1<<n,o=t/s<<1,c,h,l=this._bitrev;if(o===4)for(c=0,h=0;c<t;c+=o,h++){const f=l[h];this._singleTransform2(c,f,s)}else for(c=0,h=0;c<t;c+=o,h++){const f=l[h];this._singleTransform4(c,f,s)}var a=this._inv?-1:1,d=this.table;for(s>>=2;s>=2;s>>=2){o=t/s<<1;var m=o>>>2;for(c=0;c<t;c+=o)for(var v=c+m,g=c,u=0;g<v;g+=2,u+=s){const f=g,w=f+m,y=w+m,C=y+m,p=e[f],x=e[f+1],D=e[w],_=e[w+1],b=e[y],M=e[y+1],S=e[C],B=e[C+1],T=p,L=x,q=d[u],k=a*d[u+1],I=D*q-_*k,z=D*k+_*q,oe=d[2*u],Z=a*d[2*u+1],O=b*oe-M*Z,$=b*Z+M*oe,U=d[3*u],ee=a*d[3*u+1],re=S*U-B*ee,ie=S*ee+B*U,ae=T+O,te=L+$,Y=T-O,ce=L-$,he=I+re,r=z+ie,A=a*(I-re),P=a*(z-ie),V=ae+he,E=te+r,se=ae-he,de=te-r,le=Y+P,ve=ce-A,ye=Y-P,ue=ce+A;e[f]=V,e[f+1]=E,e[w]=le,e[w+1]=ve,e[y]=se,e[y+1]=de,e[C]=ye,e[C+1]=ue}}};H.prototype._singleTransform2=function(e,t,n){const s=this._out,o=this._data,c=o[t],h=o[t+1],l=o[t+n],a=o[t+n+1],d=c+l,m=h+a,v=c-l,g=h-a;s[e]=d,s[e+1]=m,s[e+2]=v,s[e+3]=g};H.prototype._singleTransform4=function(e,t,n){const s=this._out,o=this._data,c=this._inv?-1:1,h=n*2,l=n*3,a=o[t],d=o[t+1],m=o[t+n],v=o[t+n+1],g=o[t+h],u=o[t+h+1],f=o[t+l],w=o[t+l+1],y=a+g,C=d+u,p=a-g,x=d-u,D=m+f,_=v+w,b=c*(m-f),M=c*(v-w),S=y+D,B=C+_,T=p+M,L=x-b,q=y-D,k=C-_,I=p-M,z=x+b;s[e]=S,s[e+1]=B,s[e+2]=T,s[e+3]=L,s[e+4]=q,s[e+5]=k,s[e+6]=I,s[e+7]=z};H.prototype._realTransform4=function(){var e=this._out,t=this._csize,n=this._width,s=1<<n,o=t/s<<1,c,h,l=this._bitrev;if(o===4)for(c=0,h=0;c<t;c+=o,h++){const xe=l[h];this._singleRealTransform2(c,xe>>>1,s>>>1)}else for(c=0,h=0;c<t;c+=o,h++){const xe=l[h];this._singleRealTransform4(c,xe>>>1,s>>>1)}var a=this._inv?-1:1,d=this.table;for(s>>=2;s>=2;s>>=2){o=t/s<<1;var m=o>>>1,v=m>>>1,g=v>>>1;for(c=0;c<t;c+=o)for(var u=0,f=0;u<=g;u+=2,f+=s){var w=c+u,y=w+v,C=y+v,p=C+v,x=e[w],D=e[w+1],_=e[y],b=e[y+1],M=e[C],S=e[C+1],B=e[p],T=e[p+1],L=x,q=D,k=d[f],I=a*d[f+1],z=_*k-b*I,oe=_*I+b*k,Z=d[2*f],O=a*d[2*f+1],$=M*Z-S*O,U=M*O+S*Z,ee=d[3*f],re=a*d[3*f+1],ie=B*ee-T*re,ae=B*re+T*ee,te=L+$,Y=q+U,ce=L-$,he=q-U,r=z+ie,A=oe+ae,P=a*(z-ie),V=a*(oe-ae),E=te+r,se=Y+A,de=ce+V,le=he-P;if(e[w]=E,e[w+1]=se,e[y]=de,e[y+1]=le,u===0){var ve=te-r,ye=Y-A;e[C]=ve,e[C+1]=ye;continue}if(u!==g){var ue=ce,Ae=-he,Me=te,Se=-Y,j=-a*V,_e=-a*P,Xe=-a*A,Ye=-a*r,Ze=ue+j,Oe=Ae+_e,$e=Me+Ye,et=Se-Xe,Fe=c+v-u,Ie=c+m-u;e[Fe]=Ze,e[Fe+1]=Oe,e[Ie]=$e,e[Ie+1]=et}}}};H.prototype._singleRealTransform2=function(e,t,n){const s=this._out,o=this._data,c=o[t],h=o[t+n],l=c+h,a=c-h;s[e]=l,s[e+1]=0,s[e+2]=a,s[e+3]=0};H.prototype._singleRealTransform4=function(e,t,n){const s=this._out,o=this._data,c=this._inv?-1:1,h=n*2,l=n*3,a=o[t],d=o[t+n],m=o[t+h],v=o[t+l],g=a+m,u=a-m,f=d+v,w=c*(d-v),y=g+f,C=u,p=-w,x=g-f,D=u,_=w;s[e]=y,s[e+1]=0,s[e+2]=C,s[e+3]=p,s[e+4]=x,s[e+5]=0,s[e+6]=D,s[e+7]=_};const mt=ht(dt);class pe{constructor(e,t){Q(this,"_inputLength");Q(this,"_fft");Q(this,"_bufferSupplier");Q(this,"_paddedInputBuffer");Q(this,"_transformBuffer");Q(this,"_inverseBuffer");if(e<1)throw new Error("Input length must be at least one");this._inputLength=e,this._fft=new mt(vt(2*e)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(e){return new pe(e,t=>new Float32Array(t))}static forFloat64Array(e){return new pe(e,t=>new Float64Array(t))}static forNumberArray(e){return new pe(e,t=>Array(t))}get inputLength(){return this._inputLength}autocorrelate(e,t=this._bufferSupplier(e.length)){if(e.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${e.length}`);for(let s=0;s<e.length;s++)this._paddedInputBuffer[s]=e[s];for(let s=e.length;s<this._paddedInputBuffer.length;s++)this._paddedInputBuffer[s]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const n=this._transformBuffer;for(let s=0;s<n.length;s+=2)n[s]=n[s]*n[s]+n[s+1]*n[s+1],n[s+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let s=0;s<e.length;s++)t[s]=this._inverseBuffer[2*s];return t}}function ft(i){const e=[];let t=!1,n=-1/0,s=-1;for(let o=1;o<i.length-1;o++)i[o-1]<=0&&i[o]>0?(t=!0,s=o,n=i[o]):i[o-1]>0&&i[o]<=0?(t=!1,s!==-1&&e.push(s)):t&&i[o]>n&&(n=i[o],s=o);return e}function gt(i,e){const[t,n,s]=[i-1,i,i+1],[o,c,h]=[e[t],e[n],e[s]],l=o/2-c+h/2,a=-(o/2)*(n+s)+c*(t+s)-h/2*(t+n),d=o*n*s/2-c*t*s+h*t*n/2,m=-a/(2*l),v=l*m*m+a*m+d;return[m,v]}class ge{constructor(e,t){Q(this,"_autocorrelator");Q(this,"_nsdfBuffer");Q(this,"_clarityThreshold",.9);Q(this,"_minVolumeAbsolute",0);Q(this,"_maxInputAmplitude",1);this._autocorrelator=new pe(e,t),this._nsdfBuffer=t(e)}static forFloat32Array(e){return new ge(e,t=>new Float32Array(t))}static forFloat64Array(e){return new ge(e,t=>new Float64Array(t))}static forNumberArray(e){return new ge(e,t=>Array(t))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(e){if(!Number.isFinite(e)||e<=0||e>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=e}set minVolumeAbsolute(e){if(!Number.isFinite(e)||e<0||e>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=e}set minVolumeDecibels(e){if(!Number.isFinite(e)||e>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(e/10)}set maxInputAmplitude(e){if(!Number.isFinite(e)||e<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=e}findPitch(e,t){if(this._belowMinimumVolume(e))return[0,0];this._nsdf(e);const n=ft(this._nsdfBuffer);if(n.length===0)return[0,0];const s=Math.max(...n.map(l=>this._nsdfBuffer[l])),o=n.find(l=>this._nsdfBuffer[l]>=this._clarityThreshold*s),[c,h]=gt(o,this._nsdfBuffer);return[t/c,Math.min(h,1)]}_belowMinimumVolume(e){if(this._minVolumeAbsolute===0)return!1;let t=0;for(let n=0;n<e.length;n++)t+=e[n]**2;return Math.sqrt(t/e.length)<this._minVolumeAbsolute}_nsdf(e){this._autocorrelator.autocorrelate(e,this._nsdfBuffer);let t=2*this._nsdfBuffer[0],n;for(n=0;n<this._nsdfBuffer.length&&t>0;n++)this._nsdfBuffer[n]=2*this._nsdfBuffer[n]/t,t-=e[n]**2+e[e.length-n-1]**2;for(;n<this._nsdfBuffer.length;n++)this._nsdfBuffer[n]=0}}function vt(i){return i--,i|=i>>1,i|=i>>2,i|=i>>4,i|=i>>8,i|=i>>16,i++,i}const Ce="src/lib/components/VolumeBar.svelte";function Te(i){let e,t,n,s,o,c;const h={c:function(){e=W("div"),t=W("div"),n=W("div"),s=be(),o=W("div"),this.h()},l:function(a){e=J(a,"DIV",{class:!0});var d=ne(e);t=J(d,"DIV",{class:!0,style:!0});var m=ne(t);n=J(m,"DIV",{class:!0,style:!0}),ne(n).forEach(X),m.forEach(X),s=we(d),o=J(d,"DIV",{class:!0,style:!0}),ne(o).forEach(X),d.forEach(X),this.h()},h:function(){G(n,"class","volume-bar-fill"),F(n,"position","absolute"),F(n,"top","0"),F(n,"left","0"),F(n,"height","100%"),K(n,Ce,51,4,1464),G(t,"class","volume-bar-bg"),F(t,"height",i[1]),F(t,"border-radius","9999px"),F(t,"background-color","#e2e8f0"),F(t,"position","relative"),F(t,"overflow","hidden"),K(t,Ce,50,2,1318),G(o,"class","threshold-indicator svelte-13z7ppf"),F(o,"position","absolute"),F(o,"top","0"),F(o,"left",i[0]+"%"),F(o,"width","2px"),F(o,"height",i[1]),F(o,"background-color","#64748b"),F(o,"border-radius","1px"),K(o,Ce,59,2,1643),G(e,"class",c="volume-bar-container "+i[2]+" svelte-13z7ppf"),K(e,Ce,49,0,1269)},m:function(a,d){Ke(a,e,d),N(e,t),N(t,n),i[5](n),N(e,s),N(e,o)},p:function(a,[d]){d&2&&F(t,"height",a[1]),d&1&&F(o,"left",a[0]+"%"),d&2&&F(o,"height",a[1]),d&4&&c!==(c="volume-bar-container "+a[2]+" svelte-13z7ppf")&&G(e,"class",c)},i:Ve,o:Ve,d:function(a){a&&X(e),i[5](null)}};return De("SvelteRegisterBlock",{block:h,id:Te.name,type:"component",source:"",ctx:i}),h}function yt(i,e,t){let{$$slots:n={},$$scope:s}=e;Ue("VolumeBar",n,[]);let{volume:o=0}=e,{threshold:c=30}=e,{height:h="12px"}=e,{className:l=""}=e,a;function d(u){return u<c?`rgba(37, 99, 235, ${Math.max(.2,u/c*.8)})`:"#2563eb"}function m(u){if(a){const f=Math.max(0,Math.min(100,u)),w=d(f);t(3,a.style.width=`${f}%`,a),t(3,a.style.backgroundColor=w,a)}}Pe(()=>{a&&(t(3,a.style.width="0%",a),t(3,a.style.backgroundColor="#2563eb",a),t(3,a.style.height=h,a),t(3,a.style.borderRadius="9999px",a),t(3,a.style.transition="width 0.2s ease-out, background-color 0.2s ease-out",a))});const v=["volume","threshold","height","className"];Object.keys(e).forEach(u=>{!~v.indexOf(u)&&u.slice(0,2)!=="$$"&&u!=="slot"&&console.warn(`<VolumeBar> was created with unknown prop '${u}'`)});function g(u){nt[u?"unshift":"push"](()=>{a=u,t(3,a)})}return i.$$set=u=>{"volume"in u&&t(4,o=u.volume),"threshold"in u&&t(0,c=u.threshold),"height"in u&&t(1,h=u.height),"className"in u&&t(2,l=u.className)},i.$capture_state=()=>({onMount:Pe,volume:o,threshold:c,height:h,className:l,barElement:a,getVolumeColor:d,updateVolumeBar:m}),i.$inject_state=u=>{"volume"in u&&t(4,o=u.volume),"threshold"in u&&t(0,c=u.threshold),"height"in u&&t(1,h=u.height),"className"in u&&t(2,l=u.className),"barElement"in u&&t(3,a=u.barElement)},e&&"$$inject"in e&&i.$inject_state(e.$$inject),i.$$.update=()=>{i.$$.dirty&16&&m(o)},[c,h,l,a,o,g]}class Je extends Ge{constructor(e){super(e),Qe(this,e,yt,Te,Le,{volume:4,threshold:0,height:1,className:2}),De("SvelteRegisterComponent",{component:this,tagName:"VolumeBar",options:e,id:Te.name})}get volume(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set volume(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get threshold(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set threshold(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get height(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set height(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(e){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}class _t{constructor(){this.audioContext=null,this.mediaStream=null,this.sourceNode=null,this.analysers=new Map,this.filters=new Map,this.refCount=0,this.initPromise=null,this.isInitialized=!1,this.lastError=null}async initialize(){if(this.initPromise)return this.initPromise;if(this.isInitialized&&this.audioContext&&this.mediaStream)return this.refCount++,{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode};this.initPromise=this._doInitialize();try{const e=await this.initPromise;return this.initPromise=null,e}catch(e){throw this.initPromise=null,e}}async _doInitialize(){try{if(console.log("üé§ [AudioManager] ÂàùÊúüÂåñÈñãÂßã"),this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),console.log("‚úÖ [AudioManager] AudioContext‰ΩúÊàêÂÆå‰∫Ü")),this.audioContext.state==="suspended"&&(await this.audioContext.resume(),console.log("‚úÖ [AudioManager] AudioContextÂÜçÈñãÂÆå‰∫Ü")),this.mediaStream||(this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}}),console.log("‚úÖ [AudioManager] MediaStreamÂèñÂæóÂÆå‰∫Ü")),!this.sourceNode){this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),console.log("‚úÖ [AudioManager] SourceNode‰ΩúÊàêÂÆå‰∫Ü");const e=this.mediaStream.getTracks();console.log("üé§ [AudioManager] MediaStream tracks:",e.map(t=>({kind:t.kind,label:t.label,enabled:t.enabled,readyState:t.readyState,muted:t.muted})))}return this.isInitialized=!0,this.refCount++,this.lastError=null,console.log(`üé§ [AudioManager] ÂàùÊúüÂåñÂÆå‰∫Ü (ÂèÇÁÖß„Ç´„Ç¶„É≥„Éà: ${this.refCount})`),{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode}}catch(e){throw console.error("‚ùå [AudioManager] ÂàùÊúüÂåñ„Ç®„É©„Éº:",e),this.lastError=e,this.isInitialized=!1,this._cleanup(),e}}createAnalyser(e,t={}){if(!this.isInitialized||!this.audioContext||!this.sourceNode)throw new Error("AudioManager not initialized. Call initialize() first.");this.removeAnalyser(e);const{fftSize:n=2048,smoothingTimeConstant:s=.8,minDecibels:o=-90,maxDecibels:c=-10,useFilters:h=!0}=t,l=this.audioContext.createAnalyser();if(l.fftSize=n,l.smoothingTimeConstant=s,l.minDecibels=o,l.maxDecibels=c,this.sourceNode,h){const a=this._createFilterChain();this.filters.set(e,a),this.sourceNode.connect(a.highpass),a.highpass.connect(a.lowpass),a.lowpass.connect(a.notch),a.notch.connect(l),console.log(`üîß [AudioManager] „Éï„Ç£„É´„Çø„Éº‰ªò„ÅçAnalyser‰ΩúÊàê: ${e}`)}else this.sourceNode.connect(l),console.log(`üîß [AudioManager] Áîü‰ø°Âè∑Analyser‰ΩúÊàê: ${e}`);return this.analysers.set(e,l),l}_createFilterChain(){const e=this.audioContext.createBiquadFilter();e.type="highpass",e.frequency.setValueAtTime(80,this.audioContext.currentTime),e.Q.setValueAtTime(.7,this.audioContext.currentTime);const t=this.audioContext.createBiquadFilter();t.type="lowpass",t.frequency.setValueAtTime(800,this.audioContext.currentTime),t.Q.setValueAtTime(.7,this.audioContext.currentTime);const n=this.audioContext.createBiquadFilter();return n.type="notch",n.frequency.setValueAtTime(60,this.audioContext.currentTime),n.Q.setValueAtTime(10,this.audioContext.currentTime),{highpass:e,lowpass:t,notch:n}}removeAnalyser(e){if(this.analysers.has(e)&&(this.analysers.get(e).disconnect(),this.analysers.delete(e),console.log(`üóëÔ∏è [AudioManager] AnalyserÂâäÈô§: ${e}`)),this.filters.has(e)){const t=this.filters.get(e);t.highpass.disconnect(),t.lowpass.disconnect(),t.notch.disconnect(),this.filters.delete(e),console.log(`üóëÔ∏è [AudioManager] „Éï„Ç£„É´„Çø„Éº„ÉÅ„Çß„Éº„É≥ÂâäÈô§: ${e}`)}}release(e=[]){e.forEach(t=>this.removeAnalyser(t)),this.refCount=Math.max(0,this.refCount-1),console.log(`üìâ [AudioManager] ÂèÇÁÖß„Ç´„Ç¶„É≥„ÉàÊ∏õÁÆó: ${this.refCount}`),this.refCount<=0&&(console.log("üßπ [AudioManager] ÂÖ®„É™„ÇΩ„Éº„Çπ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÈñãÂßã"),this._cleanup())}forceCleanup(){console.log("üö® [AudioManager] Âº∑Âà∂„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂÆüË°å"),this._cleanup()}_cleanup(){for(const e of this.analysers.keys())this.removeAnalyser(e);this.mediaStream&&(this.mediaStream.getTracks().forEach(e=>{e.stop(),console.log("üõë [AudioManager] MediaStreamTrackÂÅúÊ≠¢")}),this.mediaStream=null),this.audioContext&&this.audioContext.state!=="closed"&&(this.audioContext.close(),console.log("üõë [AudioManager] AudioContextÈñâÈéñ"),this.audioContext=null),this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.isInitialized=!1,this.refCount=0,this.initPromise=null,console.log("‚úÖ [AudioManager] „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü")}getStatus(){var e,t;return{isInitialized:this.isInitialized,refCount:this.refCount,audioContextState:((e=this.audioContext)==null?void 0:e.state)||"none",mediaStreamActive:((t=this.mediaStream)==null?void 0:t.active)||!1,activeAnalysers:Array.from(this.analysers.keys()),activeFilters:Array.from(this.filters.keys()),lastError:this.lastError}}checkMediaStreamHealth(){if(!this.mediaStream)return{healthy:!1,reason:"MediaStream not initialized"};const e=this.mediaStream.getTracks();if(e.length===0)return{healthy:!1,reason:"No tracks available"};const t=e.find(n=>n.kind==="audio");return t?t.readyState==="ended"?{healthy:!1,reason:"Audio track ended"}:t.enabled?{healthy:!0,track:t}:{healthy:!1,reason:"Audio track disabled"}:{healthy:!1,reason:"No audio track found"}}}const fe=new _t;typeof window<"u"&&(window.audioManager=fe);const{Error:R,console:wt}=ut,me="src/lib/components/PitchDetector.svelte";function ze(i){let e,t,n,s,o=(i[2]>0?Math.round(i[2]):"---")+"",c,h,l,a="Hz",d,m,v="|",g,u,f,w,y,C,p;y=new Je({props:{volume:i[2]>0?i[1]:0,className:"volume-bar"},$$inline:!0});const x={c:function(){e=W("div"),t=W("div"),n=W("div"),s=W("span"),c=He(o),h=be(),l=W("span"),l.textContent=a,d=be(),m=W("span"),m.textContent=v,g=be(),u=W("span"),f=He(i[3]),w=be(),lt(y.$$.fragment),this.h()},l:function(_){e=J(_,"DIV",{class:!0});var b=ne(e);t=J(b,"DIV",{class:!0});var M=ne(t);n=J(M,"DIV",{class:!0});var S=ne(n);s=J(S,"SPAN",{class:!0});var B=ne(s);c=ke(B,o),B.forEach(X),h=we(S),l=J(S,"SPAN",{class:!0,"data-svelte-h":!0}),Re(l)!=="svelte-5uyilv"&&(l.textContent=a),d=we(S),m=J(S,"SPAN",{class:!0,"data-svelte-h":!0}),Re(m)!=="svelte-1dytxz4"&&(m.textContent=v),g=we(S),u=J(S,"SPAN",{class:!0});var T=ne(u);f=ke(T,i[3]),T.forEach(X),S.forEach(X),w=we(M),ct(y.$$.fragment,M),M.forEach(X),b.forEach(X),this.h()},h:function(){G(s,"class","detected-frequency svelte-vc1bho"),K(s,me,575,6,16583),G(l,"class","hz-suffix svelte-vc1bho"),K(l,me,576,6,16691),G(m,"class","divider svelte-vc1bho"),K(m,me,577,6,16731),G(u,"class","detected-note svelte-vc1bho"),K(u,me,578,6,16768),G(n,"class","detection-card svelte-vc1bho"),K(n,me,574,4,16548),G(t,"class","detection-display svelte-vc1bho"),K(t,me,573,2,16512),G(e,"class",C="pitch-detector "+i[0]+" svelte-vc1bho"),K(e,me,572,0,16469)},m:function(_,b){Ke(_,e,b),N(e,t),N(t,n),N(n,s),N(s,c),N(n,h),N(n,l),N(n,d),N(n,m),N(n,g),N(n,u),N(u,f),N(t,w),at(y,t,null),p=!0},p:function(_,b){(!p||b[0]&4)&&o!==(o=(_[2]>0?Math.round(_[2]):"---")+"")&&Be(c,o),(!p||b[0]&8)&&Be(f,_[3]);const M={};b[0]&6&&(M.volume=_[2]>0?_[1]:0),y.$set(M),(!p||b[0]&1&&C!==(C="pitch-detector "+_[0]+" svelte-vc1bho"))&&G(e,"class",C)},i:function(_){p||(it(y.$$.fragment,_),p=!0)},o:function(_){rt(y.$$.fragment,_),p=!1},d:function(_){_&&X(e),ot(y)}};return De("SvelteRegisterBlock",{block:x,id:ze.name,type:"component",source:"",ctx:i}),x}function We(i){const t=Math.log2(i/261.63)*12,n=Math.round(t),s=Math.abs(t-n);return Math.max(0,1-s/.5)}function qe(i,e){const t=[i,i/2,i/3,i/4,i*2],n=130.81,s=1046.5,o=l=>{const d=l>=n&&l<=s?1:0,m=e>0?1-Math.min(Math.abs(l-e)/e,1):.5,v=We(l),g=d*.4+m*.4+v*.2;return{freq:l,score:g}};return t.map(o).reduce((l,a)=>a.score>l.score?a:l).freq}function je(i){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(i<=0)return"„Éº„Éº";const n=Math.round(12*Math.log2(i/440)),s=(n+9+120)%12,o=Math.floor((n+9)/12)+4;return e[s]+o}function bt(i,e,t){let{$$slots:n={},$$scope:s}=e;Ue("PitchDetector",n,[]);const o=Ee();let{isActive:c=!1}=e,{className:h=""}=e,{debugMode:l=!1}=e,a="uninitialized",d=null,m=!1,v=null,g=null,u=null,f=null,w=null,y=null,C=null,p=!1,x=[],D=0,_=0,b=0,M="„Éº„Éº",S=0,B=[],T=[],L=0,q=0,k=0,I=[],z=null;function oe(){D=0,t(1,_=0),t(2,b=0),t(3,M="„Éº„Éº"),S=0,L=0,q=0,k=0,B=[],T=[],I=[],l&&console.log("üîÑ [PitchDetector] Display state reset")}function Z(){if(!l)return;const r=new Date().toLocaleTimeString(),A={timestamp:r,componentState:a,isActive:c,isDetecting:p,isInitialized:m,mediaStreamActive:g?g.active:null,mediaStreamTracks:g?g.getTracks().length:0,trackStates:g?g.getTracks().map(E=>({kind:E.kind,enabled:E.enabled,readyState:E.readyState,muted:E.muted})):[],audioContextState:v?v.state:null,hasAnalyser:!!f,currentVolume:D,currentFrequency:b};console.log(`üé§ [PitchDetector] ${r}:`,A);let P=!0,V=[];g&&!g.active&&(console.warn("‚ö†Ô∏è [PitchDetector] MediaStream is inactive!",g),P=!1,V.push("MediaStream inactive")),v&&v.state==="suspended"&&(console.warn("‚ö†Ô∏è [PitchDetector] AudioContext is suspended!",v),P=!1,V.push("AudioContext suspended")),g&&g.getTracks().forEach((E,se)=>{E.readyState==="ended"&&(console.error(`‚ùå [PitchDetector] Track ${se} has ended!`,E),P=!1,V.push(`Track ${se} ended`))}),o("microphoneHealthChange",{healthy:P,errors:V,details:A})}async function O(){try{t(14,a="initializing"),d=null,console.log("üéôÔ∏è [PitchDetector] AudioManagerÁµåÁî±„ÅßÂàùÊúüÂåñÈñãÂßã");const r=await fe.initialize();v=r.audioContext,g=r.mediaStream,u=r.sourceNode,console.log("‚úÖ [PitchDetector] AudioManager „É™„ÇΩ„Éº„ÇπÂèñÂæóÂÆå‰∫Ü");const A=`pitch-detector-filtered-${Date.now()}`;t(15,f=fe.createAnalyser(A,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!0})),x.push(A);const P=`pitch-detector-raw-${Date.now()}`;w=fe.createAnalyser(P,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!1}),x.push(P),console.log("‚úÖ [PitchDetector] Analyser‰ΩúÊàêÂÆå‰∫Ü:",x),y=ge.forFloat32Array(f.fftSize),t(14,a="ready"),m=!0,o("stateChange",{state:a}),ce(),console.log("‚úÖ [PitchDetector] ÂàùÊúüÂåñÂÆå‰∫Ü")}catch(r){throw console.error("‚ùå [PitchDetector] ÂàùÊúüÂåñ„Ç®„É©„Éº:",r),t(14,a="error"),d=r,m=!1,o("error",{error:r,context:"initialization"}),r}}function $(){if(a!=="ready"){const r=new Error(`Cannot start detection: component state is ${a}`);return o("error",{error:r,context:"start-detection"}),!1}if(!f||!y||!v){const r=new Error("Required components not available");return t(14,a="error"),o("error",{error:r,context:"start-detection"}),!1}return t(14,a="detecting"),t(16,p=!0),o("stateChange",{state:a}),ee(),!0}function U(){t(16,p=!1),C&&(cancelAnimationFrame(C),C=null),a==="detecting"&&m&&(t(14,a="ready"),o("stateChange",{state:a}))}function ee(){if(!p||!f||!w||!y)return;const r=f.fftSize,A=new Float32Array(r),P=new Float32Array(w.fftSize);f.getFloatTimeDomainData(A),w.getFloatTimeDomainData(P);let V=0;for(let j=0;j<r;j++)V+=Math.abs(A[j]);const E=Math.sqrt(V/r),se=Math.log10(E+.001)*50+100,de=Math.max(0,Math.min(100,se));let le=0;for(let j=0;j<P.length;j++)le+=Math.abs(P[j]);const ve=Math.sqrt(le/P.length),ye=Math.log10(ve+.001)*50+100;t(1,_=Math.max(0,Math.min(100,ye))),T.push(de),T.length>5&&T.shift(),q=T.reduce((j,_e)=>j+_e,0)/T.length,D=q;const[ue,Ae]=y.findPitch(A,v.sampleRate),Me=ue>=65&&ue<=1200;if(ue&&Ae>.6&&D>10&&Me){const j=qe(ue,k),_e=re(j);t(2,b=Math.round(_e)),t(3,M=je(b)),S=Ae,k=b}else I.length>0&&(I=[]),b===0&&(k=0),t(2,b=0),t(3,M="„Éº„Éº"),S=0;const Se=b>0?_:0;o("pitchUpdate",{frequency:b,note:M,volume:D,rawVolume:Se,clarity:S}),C=requestAnimationFrame(ee)}function re(r,A=.1){I.push(r),I.length>5&&I.shift();const P=[...I].sort((de,le)=>de-le),V=P[Math.floor(P.length/2)],E=V*A;return Math.abs(r-V)>E?V+Math.sign(r-V)*E:r}function ie(){return m&&a==="ready"}function ae(){return{componentState:a,isInitialized:m,isDetecting:p,lastError:d,hasRequiredComponents:!!(f&&y&&v&&g)}}async function te(){console.log("üîÑ [PitchDetector] ÂÜçÂàùÊúüÂåñÈñãÂßã"),Y(),await new Promise(r=>setTimeout(r,100)),await O(),console.log("‚úÖ [PitchDetector] ÂÜçÂàùÊúüÂåñÂÆå‰∫Ü")}function Y(){console.log("üßπ [PitchDetector] „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÈñãÂßã"),U(),x.length>0&&(fe.release(x),console.log("üì§ [PitchDetector] AudioManager„Å´AnalyserËß£ÊîæÈÄöÁü•:",x),x=[]),t(14,a="uninitialized"),m=!1,d=null,v=null,g=null,u=null,t(15,f=null),w=null,y=null,B=[],T=[],I=[],console.log("‚úÖ [PitchDetector] „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü")}function ce(){if(!g)return;const r=g.getTracks();r.forEach(A=>{A.addEventListener("ended",()=>{console.error("üö® [PitchDetector] MediaStreamTrackÁµÇ‰∫ÜÊ§úÂá∫:",A.kind),t(14,a="error"),d=new Error(`MediaStreamTrack (${A.kind}) ended`),o("error",{error:d,reason:"mediastream_ended",recovery:"restart_required"}),p&&U()}),A.addEventListener("mute",()=>{console.warn("‚ö†Ô∏è [PitchDetector] MediaStreamTrack muted:",A.kind),o("warning",{reason:"track_muted",track:A.kind})}),A.addEventListener("unmute",()=>{console.log("‚úÖ [PitchDetector] MediaStreamTrack unmuted:",A.kind),o("info",{reason:"track_unmuted",track:A.kind})})}),console.log("üîç [PitchDetector] MediaStreamÁõ£Ë¶ñÈñãÂßã:",r.length+" tracks")}Ne(()=>{z&&(clearInterval(z),t(17,z=null)),console.log("üîÑ [PitchDetector] onDestroy - AudioManager„É™„ÇΩ„Éº„Çπ„ÅØ‰øùÊåÅ")});const he=["isActive","className","debugMode"];return Object.keys(e).forEach(r=>{!~he.indexOf(r)&&r.slice(0,2)!=="$$"&&r!=="slot"&&wt.warn(`<PitchDetector> was created with unknown prop '${r}'`)}),i.$$set=r=>{"isActive"in r&&t(4,c=r.isActive),"className"in r&&t(0,h=r.className),"debugMode"in r&&t(5,l=r.debugMode)},i.$capture_state=()=>({onMount:Pe,onDestroy:Ne,createEventDispatcher:Ee,PitchDetector:ge,VolumeBar:Je,audioManager:fe,dispatch:o,isActive:c,className:h,debugMode:l,componentState:a,lastError:d,isInitialized:m,audioContext:v,mediaStream:g,sourceNode:u,analyser:f,rawAnalyser:w,pitchDetector:y,animationFrame:C,isDetecting:p,analyserIds:x,currentVolume:D,rawVolume:_,currentFrequency:b,detectedNote:M,pitchClarity:S,frequencyHistory:B,volumeHistory:T,stableFrequency:L,stableVolume:q,previousFrequency:k,harmonicHistory:I,debugInterval:z,resetDisplayState:oe,checkMicrophoneStatus:Z,initialize:O,startDetection:$,stopDetection:U,detectPitch:ee,calculateMusicalScore:We,correctHarmonicFrequency:qe,stabilizeFrequency:re,frequencyToNote:je,getIsInitialized:ie,getState:ae,reinitialize:te,cleanup:Y,setupMediaStreamMonitoring:ce}),i.$inject_state=r=>{"isActive"in r&&t(4,c=r.isActive),"className"in r&&t(0,h=r.className),"debugMode"in r&&t(5,l=r.debugMode),"componentState"in r&&t(14,a=r.componentState),"lastError"in r&&(d=r.lastError),"isInitialized"in r&&(m=r.isInitialized),"audioContext"in r&&(v=r.audioContext),"mediaStream"in r&&(g=r.mediaStream),"sourceNode"in r&&(u=r.sourceNode),"analyser"in r&&t(15,f=r.analyser),"rawAnalyser"in r&&(w=r.rawAnalyser),"pitchDetector"in r&&(y=r.pitchDetector),"animationFrame"in r&&(C=r.animationFrame),"isDetecting"in r&&t(16,p=r.isDetecting),"analyserIds"in r&&(x=r.analyserIds),"currentVolume"in r&&(D=r.currentVolume),"rawVolume"in r&&t(1,_=r.rawVolume),"currentFrequency"in r&&t(2,b=r.currentFrequency),"detectedNote"in r&&t(3,M=r.detectedNote),"pitchClarity"in r&&(S=r.pitchClarity),"frequencyHistory"in r&&(B=r.frequencyHistory),"volumeHistory"in r&&(T=r.volumeHistory),"stableFrequency"in r&&(L=r.stableFrequency),"stableVolume"in r&&(q=r.stableVolume),"previousFrequency"in r&&(k=r.previousFrequency),"harmonicHistory"in r&&(I=r.harmonicHistory),"debugInterval"in r&&t(17,z=r.debugInterval)},e&&"$$inject"in e&&i.$inject_state(e.$$inject),i.$$.update=()=>{i.$$.dirty[0]&131104&&(l&&!z?(console.log("üîç [PitchDetector] Debug mode enabled - starting status monitoring"),t(17,z=setInterval(Z,3e3)),Z()):!l&&z&&(console.log("üîç [PitchDetector] Debug mode disabled - stopping status monitoring"),clearInterval(z),t(17,z=null))),i.$$.dirty[0]&114704&&(c&&a==="ready"&&f&&!p?$():!c&&p&&U())},[h,_,b,M,c,l,oe,O,$,U,ie,ae,te,Y,a,f,p,z]}class Mt extends Ge{constructor(e){super(e),Qe(this,e,bt,ze,Le,{isActive:4,className:0,debugMode:5,resetDisplayState:6,initialize:7,startDetection:8,stopDetection:9,getIsInitialized:10,getState:11,reinitialize:12,cleanup:13},null,[-1,-1]),De("SvelteRegisterComponent",{component:this,tagName:"PitchDetector_1",options:e,id:ze.name})}get isActive(){throw new R("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set isActive(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new R("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get debugMode(){throw new R("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set debugMode(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get resetDisplayState(){return this.$$.ctx[6]}set resetDisplayState(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get initialize(){return this.$$.ctx[7]}set initialize(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get startDetection(){return this.$$.ctx[8]}set startDetection(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get stopDetection(){return this.$$.ctx[9]}set stopDetection(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get getIsInitialized(){return this.$$.ctx[10]}set getIsInitialized(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get getState(){return this.$$.ctx[11]}set getState(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get reinitialize(){return this.$$.ctx[12]}set reinitialize(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get cleanup(){return this.$$.ctx[13]}set cleanup(e){throw new R("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}export{Mt as P,Je as V,fe as a};
