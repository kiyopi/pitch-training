class b{constructor(){this.intervalTypes={unison:{name:"åŒåº¦",semitones:0,importance:.8,description:"åŸºéŸ³ã¨åŒã˜é«˜ã•",difficulty:"åŸºæœ¬",commonErrors:["å¾®ç´°ãªãƒ”ãƒƒãƒã®ãšã‚Œ"]},minorSecond:{name:"çŸ­2åº¦",semitones:1,importance:.9,description:"åŠéŸ³ä¸Š",difficulty:"é«˜",commonErrors:["é•·2åº¦ã¨ã®æ··åŒ","éŸ³ç¨‹å¹…ã®éå¤§è©•ä¾¡"]},majorSecond:{name:"é•·2åº¦",semitones:2,importance:1,description:"å…¨éŸ³ä¸Šï¼ˆãƒ‰ãƒ¬ï¼‰",difficulty:"åŸºæœ¬",commonErrors:["çŸ­2åº¦ã¨ã®æ··åŒ"]},minorThird:{name:"çŸ­3åº¦",semitones:3,importance:1,description:"çŸ­èª¿ã®3åº¦ï¼ˆãƒ‰ãƒŸâ™­ï¼‰",difficulty:"ä¸­",commonErrors:["é•·3åº¦ã¨ã®æ··åŒ"]},majorThird:{name:"é•·3åº¦",semitones:4,importance:1,description:"é•·èª¿ã®3åº¦ï¼ˆãƒ‰ãƒŸï¼‰",difficulty:"åŸºæœ¬",commonErrors:["çŸ­3åº¦ã¨ã®æ··åŒ","å®Œå…¨4åº¦ã¸ã®èª¤èª"]},perfectFourth:{name:"å®Œå…¨4åº¦",semitones:5,importance:.9,description:"å®‰å®šã—ãŸå”å’ŒéŸ³ç¨‹ï¼ˆãƒ‰ãƒ•ã‚¡ï¼‰",difficulty:"åŸºæœ¬",commonErrors:["é•·3åº¦ãƒ»æ¸›5åº¦ã¨ã®æ··åŒ"]},tritone:{name:"æ¸›5åº¦",semitones:6,importance:.7,description:"ä¸å®‰å®šãªéŸ³ç¨‹ï¼ˆãƒ‰ãƒ•ã‚¡#ï¼‰",difficulty:"é«˜",commonErrors:["å®Œå…¨4åº¦ãƒ»å®Œå…¨5åº¦ã¨ã®æ··åŒ"]},perfectFifth:{name:"å®Œå…¨5åº¦",semitones:7,importance:.9,description:"æœ€ã‚‚å®‰å®šã—ãŸéŸ³ç¨‹ï¼ˆãƒ‰ã‚½ï¼‰",difficulty:"åŸºæœ¬",commonErrors:["æ¸›5åº¦ãƒ»é•·6åº¦ã¨ã®æ··åŒ"]},minorSixth:{name:"çŸ­6åº¦",semitones:8,importance:.8,description:"çŸ­èª¿çš„è‰²å½©ï¼ˆãƒ‰ãƒ©â™­ï¼‰",difficulty:"ä¸­",commonErrors:["é•·6åº¦ãƒ»å®Œå…¨5åº¦ã¨ã®æ··åŒ"]},majorSixth:{name:"é•·6åº¦",semitones:9,importance:.8,description:"æ˜ã‚‹ã„éŸ¿ãï¼ˆãƒ‰ãƒ©ï¼‰",difficulty:"ä¸­",commonErrors:["çŸ­6åº¦ãƒ»çŸ­7åº¦ã¨ã®æ··åŒ"]},minorSeventh:{name:"çŸ­7åº¦",semitones:10,importance:.7,description:"å±7å’ŒéŸ³ã®7åº¦ï¼ˆãƒ‰ã‚·â™­ï¼‰",difficulty:"ä¸­",commonErrors:["é•·7åº¦ãƒ»é•·6åº¦ã¨ã®æ··åŒ"]},majorSeventh:{name:"é•·7åº¦",semitones:11,importance:.7,description:"é‹­ã„ä¸å”å’ŒéŸ³ç¨‹ï¼ˆãƒ‰ã‚·ï¼‰",difficulty:"é«˜",commonErrors:["çŸ­7åº¦ãƒ»8åº¦ã¨ã®æ··åŒ"]},octave:{name:"8åº¦",semitones:12,importance:.9,description:"1ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸Šï¼ˆãƒ‰ãƒ‰ï¼‰",difficulty:"åŸºæœ¬",commonErrors:["HarmonicCorrectionã«ã‚ˆã‚‹å€éŸ³èª¤æ¤œå‡º"]}},this.masteryData=new Map,this.analysisHistory=[],this.maxHistoryLength=100,this.debugMode=!0,this.initializeMasteryData(),this.log("ğŸµ IntervalAnalyzeråˆæœŸåŒ–å®Œäº†",{intervalCount:Object.keys(this.intervalTypes).length,masteryData:this.masteryData.size})}analyzeInterval(e,t,s){try{const n=this.calculateSemitones(e,t),r=this.identifyInterval(n),i=this.calculateSemitones(e,s),a=this.identifyInterval(i),o=this.calculateIntervalAccuracy(n,i);this.updateMastery(r.key,o);const c=this.getMastery(r.key),l={targetInterval:r,detectedInterval:a,targetSemitones:n,detectedSemitones:i,accuracy:o,mastery:c,masteryLevels:Object.fromEntries(this.masteryData),isCorrectInterval:r.key===a.key,feedback:this.generateIntervalFeedback(r,a,o),timestamp:Date.now()};return this.recordAnalysis(l),this.debugMode&&this.logAnalysisDetails(l),l}catch(n){return console.error("âŒ [IntervalAnalyzer] åˆ†æã‚¨ãƒ©ãƒ¼:",n),this.createErrorResult(e,t,s)}}calculateSemitones(e,t){return!e||!t||e<=0||t<=0?0:(12*Math.log2(t/e)%12+12)%12}identifyInterval(e){let t=null,s=1/0;for(const[n,r]of Object.entries(this.intervalTypes)){const i=Math.abs(e-r.semitones);i<s&&(s=i,t={key:n,...r,distance:i})}return t}calculateIntervalAccuracy(e,t){const s=Math.abs(e-t),n=Math.max(0,100-s*50);return Math.min(100,n)}updateMastery(e,t){this.masteryData.has(e)||this.masteryData.set(e,{attempts:0,totalAccuracy:0,averageAccuracy:0,bestAccuracy:0,recentAttempts:[],lastAttempt:null,trend:"stable"});const s=this.masteryData.get(e);s.attempts++,s.totalAccuracy+=t,s.averageAccuracy=s.totalAccuracy/s.attempts,s.bestAccuracy=Math.max(s.bestAccuracy,t),s.lastAttempt=Date.now(),s.recentAttempts.push(t),s.recentAttempts.length>10&&s.recentAttempts.shift(),s.trend=this.calculateTrend(s.recentAttempts),this.masteryData.set(e,s)}getMastery(e){const t=this.masteryData.get(e);if(!t)return{attempts:0,averageAccuracy:0,bestAccuracy:0,level:"beginner",progress:0};const s=this.determineMasteryLevel(t.averageAccuracy,t.attempts),n=Math.min(100,t.averageAccuracy*t.attempts/500);return{...t,level:s,progress:Math.round(n)}}determineMasteryLevel(e,t){return t<3?"beginner":e>=90&&t>=10?"master":e>=80&&t>=7?"advanced":e>=70&&t>=5?"intermediate":e>=50?"novice":"beginner"}calculateTrend(e){if(e.length<3)return"stable";const t=e.slice(-3),s=e.slice(-6,-3);if(s.length===0)return"stable";const n=t.reduce((a,o)=>a+o,0)/t.length,r=s.reduce((a,o)=>a+o,0)/s.length,i=n-r;return i>5?"improving":i<-5?"declining":"stable"}generateIntervalFeedback(e,t,s){const n=e.key===t.key;if(n&&s>=90)return`ğŸ¯ ${e.name}ã‚’å®Œç’§ã«èªè­˜ã—ã¾ã—ãŸï¼`;if(n&&s>=70)return`âœ… ${e.name}ã®èªè­˜ã¯æ­£ã—ã„ã§ã™ã€‚ç²¾åº¦ã‚’ä¸Šã’ã¦ã¿ã¾ã—ã‚‡ã†ã€‚`;if(n)return`ğŸ‘ ${e.name}ã‚’èªè­˜ã§ãã¦ã„ã¾ã™ã€‚ã‚‚ã†å°‘ã—æ­£ç¢ºã«ã€‚`;const r=this.analyzeIntervalError(e,t);return`âŒ ${e.name}ã§ã¯ãªã${t.name}ã¨èªè­˜ã•ã‚Œã¾ã—ãŸã€‚${r}`}analyzeIntervalError(e,t){const s=t.semitones-e.semitones;return Math.abs(s)===1?s>0?"å°‘ã—é«˜ã‚ã«æ­Œã£ã¦ã„ã¾ã™ã€‚":"å°‘ã—ä½ã‚ã«æ­Œã£ã¦ã„ã¾ã™ã€‚":Math.abs(s)<=2?"éŸ³ç¨‹å¹…ã®èª¿æ•´ãŒå¿…è¦ã§ã™ã€‚":Math.abs(s)>=6?"ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–é–¢ä¿‚ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚":"éŸ³ç¨‹ã®ç‰¹å¾´ã‚’æ„è­˜ã—ã¦ã¿ã¦ãã ã•ã„ã€‚"}getAllMasteryData(){const e={};for(const[t,s]of Object.entries(this.intervalTypes))e[t]={interval:s,mastery:this.getMastery(t)};return e}getWeakIntervals(e=3){return Object.entries(this.getAllMasteryData()).filter(([s,n])=>n.mastery.attempts>=2).sort((s,n)=>s[1].mastery.averageAccuracy-n[1].mastery.averageAccuracy).slice(0,e).map(([s,n])=>({key:s,name:n.interval.name,accuracy:n.mastery.averageAccuracy,attempts:n.mastery.attempts,improvement:this.generateImprovementTip(s,n)}))}getStrongIntervals(e=3){return Object.entries(this.getAllMasteryData()).filter(([s,n])=>n.mastery.attempts>=3).sort((s,n)=>n[1].mastery.averageAccuracy-s[1].mastery.averageAccuracy).slice(0,e).map(([s,n])=>({key:s,name:n.interval.name,accuracy:n.mastery.averageAccuracy,attempts:n.mastery.attempts,reason:this.generateStrengthReason(s,n)}))}generateImprovementTip(e,t){const s=t.interval;return t.mastery.trend==="improving"?`ğŸ“ˆ æ”¹å–„ä¸­ã§ã™ï¼${s.description}ã®ç‰¹å¾´ã‚’æ„è­˜ã—ã¦ç·´ç¿’ã‚’ç¶šã‘ã¾ã—ã‚‡ã†ã€‚`:s.commonErrors.length>0?`ğŸ’¡ ${s.commonErrors[0]}ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚`:`ğŸ¯ ${s.description}ã‚’æ„è­˜ã—ã¦ã€ã‚†ã£ãã‚Šã¨ç·´ç¿’ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚`}generateStrengthReason(e,t){const s=t.interval,n=t.mastery;return n.averageAccuracy>=95?`å®Œç’§ãªç²¾åº¦ã§${s.name}ã‚’èªè­˜ã§ãã¦ã„ã¾ã™ï¼`:n.trend==="improving"?`${s.name}ã®ç†è§£ãŒæ€¥é€Ÿã«å‘ä¸Šã—ã¦ã„ã¾ã™ã€‚`:`${s.name}ã®èªè­˜ãŒå®‰å®šã—ã¦ã„ã¾ã™ã€‚`}initializeMasteryData(){}recordAnalysis(e){this.analysisHistory.push(e),this.analysisHistory.length>this.maxHistoryLength&&this.analysisHistory.shift()}createErrorResult(e,t,s){return{targetInterval:{name:"ä¸æ˜",key:"unknown"},detectedInterval:{name:"ä¸æ˜",key:"unknown"},accuracy:0,mastery:{level:"beginner",progress:0},masteryLevels:Object.fromEntries(this.masteryData),isCorrectInterval:!1,feedback:"éŸ³ç¨‹åˆ†æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚",error:!0}}logAnalysisDetails(e){var t;console.group(`ğŸµ [IntervalAnalyzer] ${e.targetInterval.name}åˆ†æçµæœ`),console.log("ğŸ¯ éŸ³ç¨‹åˆ†æ:",{ç›®æ¨™:`${e.targetInterval.name} (${e.targetSemitones.toFixed(1)}ã‚»ãƒŸãƒˆãƒ¼ãƒ³)`,æ¤œå‡º:`${e.detectedInterval.name} (${e.detectedSemitones.toFixed(1)}ã‚»ãƒŸãƒˆãƒ¼ãƒ³)`,æ­£è§£:e.isCorrectInterval?"âœ…":"âŒ",ç²¾åº¦:`${e.accuracy.toFixed(1)}%`}),console.log("ğŸ“Š ç¿’å¾—çŠ¶æ³:",{ãƒ¬ãƒ™ãƒ«:e.mastery.level,è©¦è¡Œå›æ•°:e.mastery.attempts,å¹³å‡ç²¾åº¦:`${((t=e.mastery.averageAccuracy)==null?void 0:t.toFixed(1))||0}%`,é€²æ—:`${e.mastery.progress}%`,ãƒˆãƒ¬ãƒ³ãƒ‰:e.mastery.trend}),console.log("ğŸ’¬ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯:",e.feedback),console.groupEnd()}log(e,t=null){this.debugMode&&(t?console.log(`[IntervalAnalyzer] ${e}`,t):console.log(`[IntervalAnalyzer] ${e}`))}getStatistics(){return{totalAnalyses:this.analysisHistory.length,intervalTypes:Object.keys(this.intervalTypes).length,masteryLevels:Object.fromEntries(this.masteryData),sessionStartTime:this.sessionStartTime||Date.now()}}reset(){this.masteryData.clear(),this.analysisHistory=[],this.initializeMasteryData(),this.log("ğŸ”„ IntervalAnalyzer ãƒªã‚»ãƒƒãƒˆå®Œäº†")}}typeof window<"u"&&(window.IntervalAnalyzer=b);class M{constructor(){this.directions={ascending:{name:"ä¸Šè¡Œ",icon:"â†—ï¸",description:"åŸºéŸ³ã‚ˆã‚Šé«˜ã„éŸ³ç¨‹",color:"#10b981",commonErrors:["ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸‹èªè­˜ï¼ˆå€éŸ³åŠ¹æœï¼‰","éŸ³ç¨‹å¹…ã®éå°è©•ä¾¡","ç›®æ¨™éŸ³ç¨‹ã®æ‰‹å‰ã§åœæ­¢"]},descending:{name:"ä¸‹è¡Œ",icon:"â†˜ï¸",description:"åŸºéŸ³ã‚ˆã‚Šä½ã„éŸ³ç¨‹",color:"#3b82f6",commonErrors:["ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸Šèªè­˜ï¼ˆå€éŸ³åŠ¹æœï¼‰","éŸ³ç¨‹å¹…ã®éå¤§è©•ä¾¡","ç›®æ¨™éŸ³ç¨‹ã‚’é€šã‚Šè¶Šã™"]},unison:{name:"åŒéŸ³",icon:"â¡ï¸",description:"åŸºéŸ³ã¨åŒã˜é«˜ã•",color:"#6b7280",commonErrors:["å¾®ç´°ãªãƒ”ãƒƒãƒãšã‚Œ","å€éŸ³ã«ã‚ˆã‚‹èª¤èªè­˜"]}},this.directionMastery=new Map,this.analysisHistory=[],this.maxHistoryLength=50,this.debugMode=!0,this.thresholds={unison:.5,overshoot:1.5,significant:3},this.initializeDirectionMastery(),this.log("ğŸ§­ DirectionAnalyzeråˆæœŸåŒ–å®Œäº†",{directions:Object.keys(this.directions).length,thresholds:this.thresholds})}analyzeDirection(e,t,s){try{const n=this.determineDirection(e,t),r=this.calculateSemitones(e,t),i=this.determineDirection(e,s),a=this.calculateSemitones(e,s),o=n.key===i.key,c=this.analyzeOvershoot(r,a),l=this.calculateDirectionAccuracy(n.key,i.key,r,a);this.updateDirectionMastery(n.key,l,o);const m=this.getDirectionMastery(n.key),h={targetDirection:n,detectedDirection:i,targetSemitones:r,detectedSemitones:a,directionCorrect:o,accuracy:l,mastery:m,overshoot:c,feedback:this.generateDirectionFeedback(n,i,c,l),timestamp:Date.now()};return this.recordAnalysis(h),this.debugMode&&this.logAnalysisDetails(h),h}catch(n){return console.error("âŒ [DirectionAnalyzer] åˆ†æã‚¨ãƒ©ãƒ¼:",n),this.createErrorResult(e,t,s)}}determineDirection(e,t){const s=this.calculateSemitones(e,t);return Math.abs(s)<=this.thresholds.unison?{key:"unison",...this.directions.unison}:s>0?{key:"ascending",...this.directions.ascending}:{key:"descending",...this.directions.descending}}calculateSemitones(e,t){return!e||!t||e<=0||t<=0?0:12*Math.log2(t/e)}analyzeOvershoot(e,t){const s=t-e,n=Math.abs(s);let r="accurate",i="none";return n>=this.thresholds.overshoot&&(s>0?r="overshoot":r="undershoot",n>=this.thresholds.significant?i="severe":i="moderate"),{type:r,severity:i,difference:s,absDifference:n,percentage:n/Math.abs(e)*100}}calculateDirectionAccuracy(e,t,s,n){if(e!==t)return Math.max(0,30-Math.abs(n-s)*5);const r=Math.abs(n-s),i=Math.max(0,100-r*25);return Math.min(100,i)}updateDirectionMastery(e,t,s){this.directionMastery.has(e)||this.directionMastery.set(e,{attempts:0,correctAttempts:0,totalAccuracy:0,averageAccuracy:0,bestAccuracy:0,successRate:0,recentAttempts:[],recentCorrects:[],lastAttempt:null,trend:"stable"});const n=this.directionMastery.get(e);n.attempts++,s&&n.correctAttempts++,n.totalAccuracy+=t,n.averageAccuracy=n.totalAccuracy/n.attempts,n.bestAccuracy=Math.max(n.bestAccuracy,t),n.successRate=n.correctAttempts/n.attempts*100,n.lastAttempt=Date.now(),n.recentAttempts.push(t),n.recentCorrects.push(s),n.recentAttempts.length>10&&(n.recentAttempts.shift(),n.recentCorrects.shift()),n.trend=this.calculateDirectionTrend(n.recentCorrects),this.directionMastery.set(e,n)}getDirectionMastery(e){const t=this.directionMastery.get(e);if(!t)return{attempts:0,successRate:0,averageAccuracy:0,level:"beginner",progress:0};const s=this.determineDirectionLevel(t.successRate,t.attempts),n=Math.min(100,t.successRate*t.attempts/500);return{...t,level:s,progress:Math.round(n)}}determineDirectionLevel(e,t){return t<3?"beginner":e>=95&&t>=10?"master":e>=85&&t>=7?"advanced":e>=75&&t>=5?"intermediate":e>=60?"novice":"beginner"}calculateDirectionTrend(e){if(e.length<5)return"stable";const t=e.slice(-3),s=e.slice(-6,-3);if(s.length===0)return"stable";const n=t.filter(Boolean).length/t.length,r=s.filter(Boolean).length/s.length,i=n-r;return i>.2?"improving":i<-.2?"declining":"stable"}generateDirectionFeedback(e,t,s,n){const r=e.key===t.key;return r&&n>=90?`ğŸ¯ ${e.name}ã®æ–¹å‘æ€§ãŒå®Œç’§ã§ã™ï¼`:r&&n>=70?`âœ… ${e.name}ã®æ–¹å‘ã¯æ­£ã—ã„ã§ã™ã€‚è·é›¢ã®èª¿æ•´ã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚`:r?s.type==="overshoot"?`ğŸ‘ ${e.name}ã®æ–¹å‘ã¯æ­£ã—ã„ã§ã™ãŒã€å°‘ã—æ­Œã„ã™ãã§ã™ã€‚`:s.type==="undershoot"?`ğŸ‘ ${e.name}ã®æ–¹å‘ã¯æ­£ã—ã„ã§ã™ãŒã€ã‚‚ã†å°‘ã—å¤§ããæ­Œã£ã¦ã¿ã¦ãã ã•ã„ã€‚`:`ğŸ‘ ${e.name}ã®æ–¹å‘ã¯èªè­˜ã§ãã¦ã„ã¾ã™ã€‚`:e.key==="ascending"&&t.key==="descending"?"âŒ ä¸Šè¡Œã®ã¤ã‚‚ã‚ŠãŒä¸‹è¡Œã«ãªã£ã¦ã„ã¾ã™ã€‚åŸºéŸ³ã‚ˆã‚Šé«˜ãæ­Œã£ã¦ãã ã•ã„ã€‚":e.key==="descending"&&t.key==="ascending"?"âŒ ä¸‹è¡Œã®ã¤ã‚‚ã‚ŠãŒä¸Šè¡Œã«ãªã£ã¦ã„ã¾ã™ã€‚åŸºéŸ³ã‚ˆã‚Šä½ãæ­Œã£ã¦ãã ã•ã„ã€‚":e.key!=="unison"&&t.key==="unison"?`âŒ éŸ³ç¨‹å¤‰åŒ–ãŒå°ã•ã™ãã¾ã™ã€‚${e.name}ã«ã‚ˆã‚Šå¤§ããæ­Œã£ã¦ãã ã•ã„ã€‚`:`âŒ ${e.name}ã§ã¯ãªã${t.name}ã¨èªè­˜ã•ã‚Œã¾ã—ãŸã€‚`}getAllDirectionMastery(){const e={};for(const[t,s]of Object.entries(this.directions))e[t]={direction:s,mastery:this.getDirectionMastery(t)};return e}getDirectionComparison(){const e=this.getDirectionMastery("ascending"),t=this.getDirectionMastery("descending");return{ascending:e,descending:t,comparison:{betterDirection:e.successRate>t.successRate?"ascending":"descending",difference:Math.abs(e.successRate-t.successRate),recommendation:this.generateDirectionRecommendation(e,t)}}}generateDirectionRecommendation(e,t){const s=e.successRate-t.successRate;return Math.abs(s)<10?"ä¸Šè¡Œãƒ»ä¸‹è¡Œã¨ã‚‚ã«ãƒãƒ©ãƒ³ã‚¹è‰¯ãç¿’å¾—ã§ãã¦ã„ã¾ã™ã€‚":s>10?"ä¸‹è¡Œã®ç·´ç¿’ã‚’é‡ç‚¹çš„ã«è¡Œã†ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚ä¸‹å‘ãã®éŸ³ç¨‹ã«ã‚ˆã‚Šæ„è­˜ã‚’å‘ã‘ã¦ã¿ã¦ãã ã•ã„ã€‚":"ä¸Šè¡Œã®ç·´ç¿’ã‚’é‡ç‚¹çš„ã«è¡Œã†ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚ä¸Šå‘ãã®éŸ³ç¨‹ã«ã‚ˆã‚Šæ„è­˜ã‚’å‘ã‘ã¦ã¿ã¦ãã ã•ã„ã€‚"}initializeDirectionMastery(){for(const e of Object.keys(this.directions))this.directionMastery.has(e)||this.directionMastery.set(e,{attempts:0,correctAttempts:0,totalAccuracy:0,averageAccuracy:0,bestAccuracy:0,successRate:0,recentAttempts:[],recentCorrects:[],lastAttempt:null,trend:"stable"})}recordAnalysis(e){this.analysisHistory.push(e),this.analysisHistory.length>this.maxHistoryLength&&this.analysisHistory.shift()}createErrorResult(e,t,s){return{targetDirection:{name:"ä¸æ˜",key:"unknown"},detectedDirection:{name:"ä¸æ˜",key:"unknown"},directionCorrect:!1,accuracy:0,mastery:{level:"beginner",progress:0},overshoot:{type:"unknown",severity:"none"},feedback:"æ–¹å‘æ€§åˆ†æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚",error:!0}}logAnalysisDetails(e){var t;console.group(`ğŸ§­ [DirectionAnalyzer] ${e.targetDirection.name}åˆ†æçµæœ`),console.log("ğŸ¯ æ–¹å‘æ€§åˆ†æ:",{ç›®æ¨™:`${e.targetDirection.name} (${e.targetSemitones.toFixed(1)}ã‚»ãƒŸãƒˆãƒ¼ãƒ³)`,æ¤œå‡º:`${e.detectedDirection.name} (${e.detectedSemitones.toFixed(1)}ã‚»ãƒŸãƒˆãƒ¼ãƒ³)`,æ­£è§£:e.directionCorrect?"âœ…":"âŒ",ç²¾åº¦:`${e.accuracy.toFixed(1)}%`}),console.log("ğŸ“Š ã‚ªãƒ¼ãƒãƒ¼ã‚·ãƒ¥ãƒ¼ãƒˆåˆ†æ:",{ã‚¿ã‚¤ãƒ—:e.overshoot.type,æ·±åˆ»åº¦:e.overshoot.severity,å·®åˆ†:`${e.overshoot.difference.toFixed(1)}ã‚»ãƒŸãƒˆãƒ¼ãƒ³`,èª¤å·®ç‡:`${e.overshoot.percentage.toFixed(1)}%`}),console.log("ğŸ“ˆ ç¿’å¾—çŠ¶æ³:",{ãƒ¬ãƒ™ãƒ«:e.mastery.level,æˆåŠŸç‡:`${((t=e.mastery.successRate)==null?void 0:t.toFixed(1))||0}%`,è©¦è¡Œå›æ•°:e.mastery.attempts,ãƒˆãƒ¬ãƒ³ãƒ‰:e.mastery.trend}),console.log("ğŸ’¬ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯:",e.feedback),console.groupEnd()}log(e,t=null){this.debugMode&&(t?console.log(`[DirectionAnalyzer] ${e}`,t):console.log(`[DirectionAnalyzer] ${e}`))}getStatistics(){return{totalAnalyses:this.analysisHistory.length,directionTypes:Object.keys(this.directions).length,masteryData:Object.fromEntries(this.directionMastery),thresholds:this.thresholds}}reset(){this.directionMastery.clear(),this.analysisHistory=[],this.initializeDirectionMastery(),this.log("ğŸ”„ DirectionAnalyzer ãƒªã‚»ãƒƒãƒˆå®Œäº†")}}typeof window<"u"&&(window.DirectionAnalyzer=M);class S{constructor(e={}){this.config={windowSize:e.windowSize||5,maxHistory:e.maxHistory||100,stabilityThreshold:e.stabilityThreshold||25,trendWindowSize:e.trendWindowSize||10,fatigueDetectionWindow:e.fatigueDetectionWindow||15},this.consistencyData=new Map,this.stabilityHistory=[],this.sessionData={startTime:Date.now(),totalAttempts:0,overallConsistency:0,stabilityTrend:"stable",fatigueLevel:"fresh",concentrationLevel:"high"},this.debugMode=!0,this.log("ğŸ“Š ConsistencyTrackeråˆæœŸåŒ–å®Œäº†",{config:this.config,sessionStart:new Date(this.sessionData.startTime).toLocaleTimeString()})}recordAttempt(e,t,s,n){try{this.addAttemptData(e,t,s,n);const r=this.calculateIntervalConsistency(e);this.updateOverallConsistency();const i=this.analyzeStabilityTrend(),a=this.analyzeFatigue(),o={intervalType:e,intervalConsistency:r,overallConsistency:this.sessionData.overallConsistency,stabilityTrend:i,fatigueAnalysis:a,recommendations:this.generateConsistencyRecommendations(r,a),timestamp:Date.now()};return this.updateSessionData(o),this.debugMode&&this.logConsistencyDetails(o),o}catch(r){return console.error("âŒ [ConsistencyTracker] è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:",r),this.createErrorResult(e)}}addAttemptData(e,t,s,n){this.consistencyData.has(e)||this.consistencyData.set(e,{attempts:[],statistics:{count:0,mean:0,standardDeviation:0,variance:0,range:0,consistencyScore:0},trend:"stable",lastUpdated:Date.now()});const r=this.consistencyData.get(e),i={centsDiff:t,accuracy:s,responseTime:n,timestamp:Date.now()};r.attempts.push(i),r.attempts.length>this.config.maxHistory&&r.attempts.shift(),this.updateStatistics(e),this.stabilityHistory.push({intervalType:e,centsDiff:Math.abs(t),accuracy:s,timestamp:Date.now()}),this.stabilityHistory.length>this.config.maxHistory&&this.stabilityHistory.shift(),this.sessionData.totalAttempts++}updateStatistics(e){const t=this.consistencyData.get(e),s=t.attempts;if(s.length===0)return;const n=s.map(m=>Math.abs(m.centsDiff)),r=n.length,i=n.reduce((m,h)=>m+h,0)/r,a=n.reduce((m,h)=>m+Math.pow(h-i,2),0)/r,o=Math.sqrt(a),c=Math.max(...n)-Math.min(...n),l=Math.max(0,100-o*2);t.statistics={count:r,mean:Math.round(i*10)/10,standardDeviation:Math.round(o*10)/10,variance:Math.round(a*10)/10,range:Math.round(c*10)/10,consistencyScore:Math.round(l*10)/10},t.trend=this.calculateIntervalTrend(s),t.lastUpdated=Date.now()}calculateIntervalConsistency(e){const t=this.consistencyData.get(e);if(!t||t.attempts.length<2)return{level:"insufficient_data",score:0,description:"ãƒ‡ãƒ¼ã‚¿ä¸è¶³",attempts:(t==null?void 0:t.attempts.length)||0};const s=t.statistics,n=this.determineConsistencyLevel(s.consistencyScore);return{intervalType:e,level:n,score:s.consistencyScore,statistics:s,trend:t.trend,description:this.getConsistencyDescription(n),attempts:s.count,recommendation:this.getIntervalRecommendation(e,s,t.trend)}}determineConsistencyLevel(e){return e>=90?"excellent":e>=75?"good":e>=60?"fair":e>=40?"poor":"very_poor"}getConsistencyDescription(e){return{excellent:"éå¸¸ã«å®‰å®šã—ãŸç²¾åº¦ã§èªè­˜ã§ãã¦ã„ã¾ã™",good:"å®‰å®šã—ãŸèªè­˜ãŒã§ãã¦ã„ã¾ã™",fair:"ã‚„ã‚„ä¸å®‰å®šã§ã™ãŒã€æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™",poor:"ä¸å®‰å®šãªèªè­˜ã§ã™ã€‚ç·´ç¿’ã‚’é‡ã­ã¾ã—ã‚‡ã†",very_poor:"éå¸¸ã«ä¸å®‰å®šã§ã™ã€‚åŸºç¤ç·´ç¿’ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†",insufficient_data:"ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™"}[e]||"è©•ä¾¡ä¸èƒ½"}updateOverallConsistency(){if(this.stabilityHistory.length<5){this.sessionData.overallConsistency=0;return}const t=this.stabilityHistory.slice(-this.config.trendWindowSize).map(r=>r.centsDiff),s=t.reduce((r,i)=>r+i,0)/t.length,n=Math.sqrt(t.reduce((r,i)=>r+Math.pow(i-s,2),0)/t.length);this.sessionData.overallConsistency=Math.max(0,100-n*2)}analyzeStabilityTrend(){if(this.stabilityHistory.length<this.config.trendWindowSize)return{trend:"insufficient_data",direction:"stable",confidence:0,description:"ãƒ‡ãƒ¼ã‚¿ä¸è¶³"};const e=this.stabilityHistory.slice(-this.config.trendWindowSize),t=Math.floor(this.config.trendWindowSize/2),s=e.slice(0,t),n=e.slice(-t),r=s.reduce((h,d)=>h+d.centsDiff,0)/s.length,i=n.reduce((h,d)=>h+d.centsDiff,0)/n.length,a=r-i,o=a/r*100;let c,l,m;return Math.abs(o)<10?(c="stable",l="stable",m=.7):a>0?(c="improving",l="better",m=Math.min(.9,Math.abs(o)/20)):(c="declining",l="worse",m=Math.min(.9,Math.abs(o)/20)),this.sessionData.stabilityTrend=c,{trend:c,direction:l,confidence:Math.round(m*100)/100,improvement:Math.round(a*10)/10,improvementPercent:Math.round(o*10)/10,description:this.getTrendDescription(c,l)}}analyzeFatigue(){if(this.stabilityHistory.length<this.config.fatigueDetectionWindow)return{fatigueLevel:"unknown",concentrationLevel:"unknown",recommendation:"ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã®ãŸã‚åˆ¤å®šã§ãã¾ã›ã‚“"};const e=this.stabilityHistory.slice(-this.config.fatigueDetectionWindow),s=(Date.now()-this.sessionData.startTime)/(1e3*60);let n="fresh";s>30&&(n="moderate"),s>60&&(n="tired"),s>90&&(n="exhausted");const r=e.map(d=>d.accuracy),i=r.reduce((d,u)=>d+u,0)/r.length,a=this.stabilityHistory.map(d=>d.accuracy),c=a.reduce((d,u)=>d+u,0)/a.length-i;let l="fresh";c>5&&(l="moderate"),c>10&&(l="tired"),c>20&&(l="exhausted");const m=this.combineFatigueFactors(n,l),h=this.evaluateConcentration(e);return this.sessionData.fatigueLevel=m,this.sessionData.concentrationLevel=h,{fatigueLevel:m,concentrationLevel:h,sessionMinutes:Math.round(s),accuracyDrop:Math.round(c*10)/10,recommendation:this.getFatigueRecommendation(m,h)}}combineFatigueFactors(e,t){const s=["fresh","moderate","tired","exhausted"],n=s.indexOf(e),r=s.indexOf(t),i=Math.max(n,r);return s[i]}evaluateConcentration(e){const t=e.map(n=>n.centsDiff),s=Math.sqrt(t.reduce((n,r)=>n+Math.pow(r-t.reduce((i,a)=>i+a,0)/t.length,2),0)/t.length);return s<=15?"high":s<=25?"medium":s<=40?"low":"very_low"}generateConsistencyRecommendations(e,t){const s=[];return(t.fatigueLevel==="tired"||t.fatigueLevel==="exhausted")&&s.push({type:"rest",priority:"high",message:"ç–²åŠ´ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚10-15åˆ†ã®ä¼‘æ†©ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚",icon:"ğŸ˜´"}),(t.concentrationLevel==="low"||t.concentrationLevel==="very_low")&&s.push({type:"focus",priority:"medium",message:"é›†ä¸­åŠ›ãŒä½ä¸‹ã—ã¦ã„ã¾ã™ã€‚æ·±å‘¼å¸ã‚’ã—ã¦ã€ã‚†ã£ãã‚Šã¨ç·´ç¿’ã—ã¦ã¿ã¦ãã ã•ã„ã€‚",icon:"ğŸ§˜"}),(e.level==="poor"||e.level==="very_poor")&&s.push({type:"practice",priority:"medium",message:`${e.intervalType}ã®ç·´ç¿’ã‚’é‡ç‚¹çš„ã«è¡Œã„ã¾ã—ã‚‡ã†ã€‚ã‚†ã£ãã‚Šã¨æ­£ç¢ºã«æ­Œã†ã“ã¨ã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚`,icon:"ğŸ¯"}),e.trend==="improving"&&s.push({type:"encouragement",priority:"low",message:"æ”¹å–„ãŒè¦‹ã‚‰ã‚Œã¾ã™ï¼ã“ã®èª¿å­ã§ç·´ç¿’ã‚’ç¶šã‘ã¦ãã ã•ã„ã€‚",icon:"ğŸ“ˆ"}),s}getIntervalRecommendation(e,t,s){return t.consistencyScore>=80?"å®‰å®šã—ãŸèªè­˜ãŒã§ãã¦ã„ã¾ã™ã€‚ã“ã®ç²¾åº¦ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚":s==="improving"?"æ”¹å–„å‚¾å‘ã«ã‚ã‚Šã¾ã™ã€‚ç¶™ç¶šã—ã¦ç·´ç¿’ã—ã¦ãã ã•ã„ã€‚":t.standardDeviation>30?"ã°ã‚‰ã¤ããŒå¤§ãã„ã§ã™ã€‚ã‚†ã£ãã‚Šã¨æ­£ç¢ºã«æ­Œã†ã“ã¨ã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚":`${e}ã®ç‰¹å¾´ã‚’æ„è­˜ã—ã¦ã€ä¸€å®šã®ç²¾åº¦ã§æ­Œãˆã‚‹ã‚ˆã†ç·´ç¿’ã—ã¾ã—ã‚‡ã†ã€‚`}getTrendDescription(e,t){return{stable:"å®‰å®šã—ãŸç²¾åº¦ã‚’ç¶­æŒã—ã¦ã„ã¾ã™",improving:"ç²¾åº¦ãŒå‘ä¸Šã—ã¦ã„ã¾ã™",declining:"ç²¾åº¦ãŒä½ä¸‹ã—ã¦ã„ã¾ã™"}[e]||"å‚¾å‘ã‚’åˆ†æä¸­"}getFatigueRecommendation(e,t){return e==="exhausted"?"ä»Šæ—¥ã¯ã“ã“ã¾ã§ã«ã—ã¦ã€ååˆ†ãªä¼‘æ¯ã‚’å–ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚":e==="tired"?"15-20åˆ†ã®ä¼‘æ†©ã‚’å–ã£ã¦ã‹ã‚‰ç·´ç¿’ã‚’å†é–‹ã—ã¾ã—ã‚‡ã†ã€‚":t==="very_low"?"é›†ä¸­åŠ›ãŒä½ä¸‹ã—ã¦ã„ã¾ã™ã€‚ç’°å¢ƒã‚’æ•´ãˆã¦ã€çŸ­æ™‚é–“ã®é›†ä¸­ç·´ç¿’ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†ã€‚":t==="low"?"æ·±å‘¼å¸ã‚’ã—ã¦ã€ä¸€ã¤ä¸€ã¤ã®éŸ³ç¨‹ã«é›†ä¸­ã—ã¦ç·´ç¿’ã—ã¦ã¿ã¦ãã ã•ã„ã€‚":"è‰¯ã„çŠ¶æ…‹ã§ã™ã€‚ã“ã®èª¿å­ã§ç·´ç¿’ã‚’ç¶šã‘ã¦ãã ã•ã„ã€‚"}calculateIntervalTrend(e){if(e.length<6)return"stable";const t=e.slice(-3),s=e.slice(-6,-3),n=t.reduce((a,o)=>a+Math.abs(o.centsDiff),0)/t.length,i=s.reduce((a,o)=>a+Math.abs(o.centsDiff),0)/s.length-n;return i>5?"improving":i<-5?"declining":"stable"}updateSessionData(e){this.sessionData.overallConsistency=e.overallConsistency,this.sessionData.stabilityTrend=e.stabilityTrend.trend,this.sessionData.fatigueLevel=e.fatigueAnalysis.fatigueLevel,this.sessionData.concentrationLevel=e.fatigueAnalysis.concentrationLevel}createErrorResult(e){return{intervalType:e,intervalConsistency:{level:"error",score:0},overallConsistency:0,stabilityTrend:{trend:"error"},fatigueAnalysis:{fatigueLevel:"unknown"},recommendations:[],error:!0}}logConsistencyDetails(e){var t;console.group(`ğŸ“Š [ConsistencyTracker] ${e.intervalType}ä¸€è²«æ€§åˆ†æ`),console.log("ğŸ¯ éŸ³ç¨‹ä¸€è²«æ€§:",{ãƒ¬ãƒ™ãƒ«:e.intervalConsistency.level,ã‚¹ã‚³ã‚¢:`${e.intervalConsistency.score}%`,æ¨™æº–åå·®:`${((t=e.intervalConsistency.statistics)==null?void 0:t.standardDeviation)||0}ã‚»ãƒ³ãƒˆ`,è©¦è¡Œå›æ•°:e.intervalConsistency.attempts}),console.log("ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ:",{å…¨ä½“å‚¾å‘:e.stabilityTrend.trend,æ–¹å‘:e.stabilityTrend.direction,ä¿¡é ¼åº¦:`${(e.stabilityTrend.confidence*100).toFixed(0)}%`,æ”¹å–„åº¦:`${e.stabilityTrend.improvement}ã‚»ãƒ³ãƒˆ`}),console.log("ğŸ˜´ ç–²åŠ´åˆ†æ:",{ç–²åŠ´åº¦:e.fatigueAnalysis.fatigueLevel,é›†ä¸­åŠ›:e.fatigueAnalysis.concentrationLevel,ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“:`${e.fatigueAnalysis.sessionMinutes}åˆ†`,ç²¾åº¦ä½ä¸‹:`${e.fatigueAnalysis.accuracyDrop}%`}),e.recommendations.length>0&&console.log("ğŸ’¡ æ¨å¥¨äº‹é …:",e.recommendations.map(s=>s.message)),console.groupEnd()}log(e,t=null){this.debugMode&&(t?console.log(`[ConsistencyTracker] ${e}`,t):console.log(`[ConsistencyTracker] ${e}`))}getAllConsistencyData(){const e={};for(const[t,s]of this.consistencyData.entries())e[t]={statistics:s.statistics,trend:s.trend,attempts:s.attempts.length,lastUpdated:s.lastUpdated};return{intervalData:e,sessionData:this.sessionData,overallStats:{totalAttempts:this.sessionData.totalAttempts,overallConsistency:this.sessionData.overallConsistency,sessionDuration:Date.now()-this.sessionData.startTime}}}getStatistics(){return{totalIntervalTypes:this.consistencyData.size,totalAttempts:this.sessionData.totalAttempts,sessionDuration:Date.now()-this.sessionData.startTime,overallConsistency:this.sessionData.overallConsistency,stabilityTrend:this.sessionData.stabilityTrend,fatigueLevel:this.sessionData.fatigueLevel}}reset(){this.consistencyData.clear(),this.stabilityHistory=[],this.sessionData={startTime:Date.now(),totalAttempts:0,overallConsistency:0,stabilityTrend:"stable",fatigueLevel:"fresh",concentrationLevel:"high"},this.log("ğŸ”„ ConsistencyTracker ãƒªã‚»ãƒƒãƒˆå®Œäº†")}}typeof window<"u"&&(window.ConsistencyTracker=S);class w{constructor(e={}){var t,s,n,r,i,a,o,c,l,m,h;this.config={weights:{pitchAccuracy:((t=e.weights)==null?void 0:t.pitchAccuracy)||.4,recognitionSpeed:((s=e.weights)==null?void 0:s.recognitionSpeed)||.2,intervalMastery:((n=e.weights)==null?void 0:n.intervalMastery)||.2,directionAccuracy:((r=e.weights)==null?void 0:r.directionAccuracy)||.1,consistency:((i=e.weights)==null?void 0:i.consistency)||.1},speedThresholds:{excellent:((a=e.speedThresholds)==null?void 0:a.excellent)||1e3,good:((o=e.speedThresholds)==null?void 0:o.good)||2e3,fair:((c=e.speedThresholds)==null?void 0:c.fair)||3e3,poor:((l=e.speedThresholds)==null?void 0:l.poor)||5e3},harmonicCorrection:{enabled:((m=e.harmonicCorrection)==null?void 0:m.enabled)??!0,tolerance:((h=e.harmonicCorrection)==null?void 0:h.tolerance)||50},sessionTracking:e.sessionTracking??!0,maxHistorySize:e.maxHistorySize||100},this.intervalAnalyzer=new b,this.directionAnalyzer=new M,this.consistencyTracker=new S,this.sessionData={startTime:Date.now(),totalAttempts:0,overallScore:0,performanceHistory:[],currentLevel:"beginner",achievements:new Set,lastAnalysis:null},this.performanceMetrics={averageSpeed:0,accuracyTrend:"stable",strengthAreas:[],improvementAreas:[],sessionProgress:0},this.debugMode=!0,this.log("ğŸ¯ EnhancedScoringEngineåˆæœŸåŒ–å®Œäº†",{weights:this.config.weights,analyzers:["IntervalAnalyzer","DirectionAnalyzer","ConsistencyTracker"]})}async analyzePerformance(e){try{const{baseFreq:t,targetFreq:s,detectedFreq:n,responseTime:r,volume:i=50,harmonicCorrection:a=null}=e,o=this.validateInputs(e);if(!o.valid)return this.createErrorResult(o.error);const c=this.applyHarmonicCorrection(n,a),l=await Promise.all([this.intervalAnalyzer.analyzeInterval(t,s,c),this.directionAnalyzer.analyzeDirection(t,s,c),this.consistencyTracker.recordAttempt(this.getIntervalType(t,s),this.calculateCentsDifference(s,c),this.calculateRawAccuracy(s,c),r)]),[m,h,d]=l,u=this.analyzeRecognitionSpeed(r),y=this.calculateIntegratedScore({intervalAnalysis:m,directionAnalysis:h,consistencyAnalysis:d,speedAnalysis:u,volume:i}),p=this.evaluateOverallPerformance(y),f=this.generateAdaptiveFeedback({intervalAnalysis:m,directionAnalysis:h,consistencyAnalysis:d,speedAnalysis:u,performanceEvaluation:p}),v=this.updateSessionData(y,p),g={timestamp:Date.now(),sessionAttempt:this.sessionData.totalAttempts,analyses:{interval:m,direction:h,consistency:d,speed:u},score:y,performance:p,feedback:f,session:v,metadata:{baseFreq:t,targetFreq:s,detectedFreq:n,correctedFreq:c,responseTime:r,volume:i,harmonicCorrectionApplied:!!a}};return this.recordAnalysisResult(g),this.debugMode&&this.logScoringDetails(g),g}catch(t){return console.error("âŒ [EnhancedScoringEngine] æ¡ç‚¹ã‚¨ãƒ©ãƒ¼:",t),this.createErrorResult("æ¡ç‚¹å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ")}}validateInputs(e){const{baseFreq:t,targetFreq:s,detectedFreq:n,responseTime:r}=e;return!t||!s||!n?{valid:!1,error:"å¿…è¦ãªå‘¨æ³¢æ•°ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™"}:t<=0||s<=0||n<=0?{valid:!1,error:"å‘¨æ³¢æ•°ã¯æ­£ã®å€¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"}:r<0||r>3e4?{valid:!1,error:"åå¿œæ™‚é–“ãŒç¯„å›²å¤–ã§ã™"}:{valid:!0}}applyHarmonicCorrection(e,t){return!this.config.harmonicCorrection.enabled||!t?e:t.correctedFrequency&&Math.abs(t.correctedFrequency-e)<=this.config.harmonicCorrection.tolerance?(this.log("ğŸ”§ HarmonicCorrectioné©ç”¨",{original:e,corrected:t.correctedFrequency,correction:t.correction}),t.correctedFrequency):e}analyzeRecognitionSpeed(e){const{speedThresholds:t}=this.config;let s,n,r;return e<=t.excellent?(s="excellent",n=100,r="âš¡ ç´ æ—©ã„èªè­˜ã§ã™ï¼"):e<=t.good?(s="good",n=85,r="ğŸ‘ è‰¯ã„åå¿œé€Ÿåº¦ã§ã™ã€‚"):e<=t.fair?(s="fair",n=70,r="ğŸ“ˆ ã‚‚ã†å°‘ã—æ—©ãèªè­˜ã§ãã‚‹ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚"):e<=t.poor?(s="poor",n=50,r="ğŸŒ ã‚†ã£ãã‚Šã¨ç¢ºå®Ÿã«èªè­˜ã—ã¾ã—ã‚‡ã†ã€‚"):(s="very_poor",n=25,r="â° æ™‚é–“ã‚’ã‹ã‘ã™ãã¦ã„ã¾ã™ã€‚ç·´ç¿’ã‚’é‡ã­ã¾ã—ã‚‡ã†ã€‚"),{level:s,score:n,responseTime:e,feedback:r,comparison:this.compareToAverageSpeed(e)}}calculateIntegratedScore(e){const{weights:t}=this.config,{intervalAnalysis:s,directionAnalysis:n,consistencyAnalysis:r,speedAnalysis:i,volume:a}=e,o=s.accuracy||0,c=i.score||0,l=this.calculateMasteryScore(s.mastery),m=n.accuracy||0,h=r.overallConsistency||0,d=o*t.pitchAccuracy+c*t.recognitionSpeed+l*t.intervalMastery+m*t.directionAccuracy+h*t.consistency,u=this.calculateVolumeAdjustment(a),y=Math.min(100,d*u);return{total:Math.round(y*10)/10,components:{pitchAccuracy:Math.round(o*10)/10,recognitionSpeed:Math.round(c*10)/10,intervalMastery:Math.round(l*10)/10,directionAccuracy:Math.round(m*10)/10,consistency:Math.round(h*10)/10},weights:t,volumeAdjustment:Math.round(u*100)/100,grade:this.determineGrade(y)}}calculateMasteryScore(e){if(!e||e.attempts===0)return 0;const t=e.averageAccuracy||0,s=Math.min(20,e.attempts*2),n=e.trend==="improving"?10:0;return Math.min(100,t+s+n)}calculateVolumeAdjustment(e){return e<20?.8:e>80?.95:1}determineGrade(e){return e>=95?"S":e>=90?"A+":e>=85?"A":e>=80?"B+":e>=75?"B":e>=70?"C+":e>=65?"C":e>=60?"D+":e>=55?"D":"F"}evaluateOverallPerformance(e){const t=this.determinePerformanceLevel(e.total),s=this.identifyStrengths(e.components),n=this.identifyWeaknesses(e.components),r=this.calculateImprovement();return{level:t,score:e.total,grade:e.grade,strengths:s,weaknesses:n,improvement:r,recommendation:this.generatePerformanceRecommendation(t,s,n)}}determinePerformanceLevel(e){return e>=90?"excellent":e>=80?"good":e>=70?"average":e>=60?"below_average":"needs_improvement"}identifyStrengths(e){const t=[];return Object.entries(e).forEach(([s,n])=>{n>=85?t.push({area:s,score:n,level:"excellent"}):n>=75&&t.push({area:s,score:n,level:"good"})}),t.sort((s,n)=>n.score-s.score)}identifyWeaknesses(e){const t=[];return Object.entries(e).forEach(([s,n])=>{n<60&&t.push({area:s,score:n,severity:n<40?"high":"medium"})}),t.sort((s,n)=>s.score-n.score)}calculateImprovement(){const e=this.sessionData.performanceHistory;if(e.length<3)return{trend:"insufficient_data",change:0,description:"ãƒ‡ãƒ¼ã‚¿ä¸è¶³"};const t=e.slice(-3),s=e.slice(-6,-3);if(s.length===0)return{trend:"stable",change:0,description:"å®‰å®š"};const n=t.reduce((c,l)=>c+l,0)/t.length,r=s.reduce((c,l)=>c+l,0)/s.length,i=n-r;let a,o;return i>5?(a="improving",o="å‘ä¸Šä¸­"):i<-5?(a="declining",o="ä½ä¸‹ä¸­"):(a="stable",o="å®‰å®š"),{trend:a,change:Math.round(i*10)/10,description:o}}generateAdaptiveFeedback(e){const{intervalAnalysis:t,directionAnalysis:s,consistencyAnalysis:n,speedAnalysis:r,performanceEvaluation:i}=e;return{primary:this.getPrimaryFeedback(i),detailed:{interval:t.feedback||"éŸ³ç¨‹åˆ†æçµæœãªã—",direction:s.feedback||"æ–¹å‘æ€§åˆ†æçµæœãªã—",consistency:this.getConsistencyFeedback(n),speed:r.feedback||"é€Ÿåº¦åˆ†æçµæœãªã—"},recommendations:this.generateRecommendations(e),encouragement:this.generateEncouragement(i),nextSteps:this.suggestNextSteps(i)}}getPrimaryFeedback(e){const{level:t,grade:s,score:n}=e;return{excellent:`ğŸ¯ ç´ æ™´ã‚‰ã—ã„ï¼${s}è©•ä¾¡ï¼ˆ${n}ç‚¹ï¼‰ã§ã™ã€‚`,good:`ğŸ‘ è‰¯ã„çµæœã§ã™ï¼${s}è©•ä¾¡ï¼ˆ${n}ç‚¹ï¼‰ã€‚`,average:`ğŸ“ˆ å¹³å‡çš„ãªçµæœã§ã™ã€‚${s}è©•ä¾¡ï¼ˆ${n}ç‚¹ï¼‰ã€‚`,below_average:`ğŸ’ª ç·´ç¿’ã‚’ç¶šã‘ã¾ã—ã‚‡ã†ã€‚${s}è©•ä¾¡ï¼ˆ${n}ç‚¹ï¼‰ã€‚`,needs_improvement:`ğŸ“ åŸºç¤ã‹ã‚‰ç·´ç¿’ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚${s}è©•ä¾¡ï¼ˆ${n}ç‚¹ï¼‰ã€‚`}[t]||`çµæœ: ${s}è©•ä¾¡ï¼ˆ${n}ç‚¹ï¼‰`}getConsistencyFeedback(e){if(e.recommendations&&e.recommendations.length>0)return e.recommendations[0].message;const t=e.overallConsistency||0;return t>=80?"ğŸ¯ ä¸€è²«ã—ãŸç²¾åº¦ã‚’ä¿ã£ã¦ã„ã¾ã™ã€‚":t>=60?"ğŸ“Š ã¾ãšã¾ãšã®å®‰å®šæ€§ã§ã™ã€‚":"ğŸ“ˆ ä¸€è²«æ€§ã®æ”¹å–„ãŒå¿…è¦ã§ã™ã€‚"}generateRecommendations(e){const t=[];e.consistencyAnalysis.recommendations&&t.push(...e.consistencyAnalysis.recommendations);const{performanceEvaluation:s}=e;if(s.weaknesses.length>0){const n=s.weaknesses[0];t.push({type:"improvement",priority:"high",message:this.getImprovementSuggestion(n.area),icon:"ğŸ¯"})}return t}getImprovementSuggestion(e){return{pitchAccuracy:"éŸ³ç¨‹ã®ç²¾åº¦å‘ä¸Šã®ãŸã‚ã€ã‚†ã£ãã‚Šã¨æ­£ç¢ºã«æ­Œã†ç·´ç¿’ã‚’ã—ã¾ã—ã‚‡ã†ã€‚",recognitionSpeed:"åå¿œé€Ÿåº¦å‘ä¸Šã®ãŸã‚ã€èã„ãŸç¬é–“ã«æ­Œã†ç·´ç¿’ã‚’ã—ã¾ã—ã‚‡ã†ã€‚",intervalMastery:"è‹¦æ‰‹ãªéŸ³ç¨‹ã‚’é‡ç‚¹çš„ã«ç·´ç¿’ã—ã¾ã—ã‚‡ã†ã€‚",directionAccuracy:"ä¸Šè¡Œãƒ»ä¸‹è¡Œã®æ–¹å‘æ€§ã‚’æ„è­˜ã—ã¦ç·´ç¿’ã—ã¾ã—ã‚‡ã†ã€‚",consistency:"ä¸€å®šã®ç²¾åº¦ã‚’ä¿ã¤ãŸã‚ã€é›†ä¸­åŠ›ã‚’é«˜ã‚ã¦ç·´ç¿’ã—ã¾ã—ã‚‡ã†ã€‚"}[e]||"ç¶™ç¶šçš„ãªç·´ç¿’ã§æ”¹å–„ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚"}generateEncouragement(e){if(e.improvement.trend==="improving")return"ğŸ“ˆ ç¢ºå®Ÿã«ä¸Šé”ã—ã¦ã„ã¾ã™ï¼ã“ã®èª¿å­ã§ç¶šã‘ã¾ã—ã‚‡ã†ã€‚";if(e.strengths.length>0){const t=e.strengths[0];return`â­ ${this.getAreaName(t.area)}ãŒå¾—æ„ã§ã™ã­ï¼`}return"ğŸŒŸ ç·´ç¿’ã‚’ç¶šã‘ã‚‹ã“ã¨ã§å¿…ãšä¸Šé”ã—ã¾ã™ã€‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼"}suggestNextSteps(e){if(e.level==="excellent")return"ğŸ“ ä¸Šç´šãƒ¬ãƒ™ãƒ«ã«åˆ°é”ã—ã¦ã„ã¾ã™ã€‚ã‚ˆã‚Šè¤‡é›‘ãªéŸ³ç¨‹ã«æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚";if(e.weaknesses.length>0){const t=e.weaknesses[0];return`ğŸ¯ ${this.getAreaName(t.area)}ã®ç·´ç¿’ã«é‡ç‚¹ã‚’ç½®ãã¾ã—ã‚‡ã†ã€‚`}return"ğŸ“š åŸºç¤ç·´ç¿’ã‚’ç¶™ç¶šã—ã€å…¨ä½“çš„ãªãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ã€‚"}getAreaName(e){return{pitchAccuracy:"éŸ³ç¨‹ç²¾åº¦",recognitionSpeed:"èªè­˜é€Ÿåº¦",intervalMastery:"éŸ³ç¨‹ç¿’å¾—åº¦",directionAccuracy:"æ–¹å‘æ€§èªè­˜",consistency:"ä¸€è²«æ€§"}[e]||e}updateSessionData(e,t){return this.sessionData.totalAttempts++,this.sessionData.performanceHistory.push(e.total),this.sessionData.overallScore=this.calculateSessionAverage(),this.sessionData.currentLevel=t.level,this.sessionData.lastAnalysis=Date.now(),this.sessionData.performanceHistory.length>this.config.maxHistorySize&&this.sessionData.performanceHistory.shift(),this.updatePerformanceMetrics(e,t),this.checkAchievements(e,t),{attempt:this.sessionData.totalAttempts,sessionAverage:this.sessionData.overallScore,sessionDuration:Date.now()-this.sessionData.startTime,level:this.sessionData.currentLevel,newAchievements:Array.from(this.sessionData.achievements)}}calculateSessionAverage(){const e=this.sessionData.performanceHistory;return e.length===0?0:e.reduce((t,s)=>t+s,0)/e.length}updatePerformanceMetrics(e,t){e.components.recognitionSpeed>0&&(this.performanceMetrics.averageSpeed=(this.performanceMetrics.averageSpeed+e.components.recognitionSpeed)/2),this.performanceMetrics.accuracyTrend=t.improvement.trend,this.performanceMetrics.strengthAreas=t.strengths.map(s=>s.area),this.performanceMetrics.improvementAreas=t.weaknesses.map(s=>s.area),this.performanceMetrics.sessionProgress=Math.min(100,this.sessionData.totalAttempts/20*100)}checkAchievements(e,t){this.sessionData.totalAttempts===1&&this.sessionData.achievements.add("first_attempt"),e.total>=90&&!this.sessionData.achievements.has("high_score")&&this.sessionData.achievements.add("high_score"),e.total>=98&&!this.sessionData.achievements.has("perfect_score")&&this.sessionData.achievements.add("perfect_score"),this.sessionData.totalAttempts>=10&&!this.sessionData.achievements.has("persistent")&&this.sessionData.achievements.add("persistent"),t.improvement.trend==="improving"&&!this.sessionData.achievements.has("improving")&&this.sessionData.achievements.add("improving")}compareToAverageSpeed(e){const t=this.performanceMetrics.averageSpeed||2e3,s=e-t;return{sessionAverage:t,difference:s,comparison:s<-500?"much_faster":s<-200?"faster":s<200?"similar":s<500?"slower":"much_slower"}}getIntervalType(e,t){const n=(Math.round(12*Math.log2(t/e))%12+12)%12;return{0:"unison",1:"minorSecond",2:"majorSecond",3:"minorThird",4:"majorThird",5:"perfectFourth",6:"tritone",7:"perfectFifth",8:"minorSixth",9:"majorSixth",10:"minorSeventh",11:"majorSeventh"}[n]||"unknown"}calculateCentsDifference(e,t){return!e||!t?0:1200*Math.log2(t/e)}calculateRawAccuracy(e,t){const s=Math.abs(this.calculateCentsDifference(e,t));return Math.max(0,100-s)}recordAnalysisResult(e){this.sessionData.lastAnalysis=e}createErrorResult(e){return{timestamp:Date.now(),error:!0,message:e,score:{total:0,components:{pitchAccuracy:0,recognitionSpeed:0,intervalMastery:0,directionAccuracy:0,consistency:0},grade:"F"},performance:{level:"needs_improvement",strengths:[],weaknesses:[],improvement:{trend:"unknown",change:0}},feedback:{primary:"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",detailed:{},recommendations:[],encouragement:"",nextSteps:""}}}logScoringDetails(e){console.group(`ğŸ¯ [EnhancedScoringEngine] çµ±åˆæ¡ç‚¹çµæœ #${e.sessionAttempt}`),console.log("ğŸ“Š çµ±åˆã‚¹ã‚³ã‚¢:",{ç·åˆ:`${e.score.total}ç‚¹ (${e.score.grade})`,éŸ³ç¨‹ç²¾åº¦:`${e.score.components.pitchAccuracy}%`,èªè­˜é€Ÿåº¦:`${e.score.components.recognitionSpeed}%`,éŸ³ç¨‹ç¿’å¾—åº¦:`${e.score.components.intervalMastery}%`,æ–¹å‘æ€§ç²¾åº¦:`${e.score.components.directionAccuracy}%`,ä¸€è²«æ€§:`${e.score.components.consistency}%`}),console.log("ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹:",{ãƒ¬ãƒ™ãƒ«:e.performance.level,æ”¹å–„å‚¾å‘:e.performance.improvement.trend,å¼·ã¿:e.performance.strengths.map(t=>t.area),å¼±ç‚¹:e.performance.weaknesses.map(t=>t.area)}),console.log("ğŸ’¬ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯:",{ãƒ¡ã‚¤ãƒ³:e.feedback.primary,æ¨å¥¨äº‹é …:e.feedback.recommendations.length}),console.log("ğŸ“š ã‚»ãƒƒã‚·ãƒ§ãƒ³:",{è©¦è¡Œå›æ•°:e.session.attempt,å¹³å‡ç‚¹:e.session.sessionAverage.toFixed(1),ç¶™ç¶šæ™‚é–“:`${Math.round(e.session.sessionDuration/6e4)}åˆ†`}),console.groupEnd()}log(e,t=null){this.debugMode&&(t?console.log(`[EnhancedScoringEngine] ${e}`,t):console.log(`[EnhancedScoringEngine] ${e}`))}async processAttempt(e){return await this.analyzePerformance(e)}generateDetailedReport(){var m,h,d,u,y,p,f,v;const e=this.getStatistics(),t=this.sessionData,s={totalScore:t.overallScore,totalAttempts:t.totalAttempts,averageScore:t.totalAttempts>0?t.overallScore/t.totalAttempts:0,sessionDuration:Date.now()-t.startTime,level:t.currentLevel},n={intervals:e.analyzers.interval,directions:e.analyzers.direction,consistency:e.analyzers.consistency},r=this.generateImprovementSuggestions(),i={startTime:t.startTime,duration:Date.now()-t.startTime,attempts:t.totalAttempts,achievements:Array.from(t.achievements),performanceHistory:t.performanceHistory.slice(-10)},a={primary:r.length>0?r[0].message:"è‰¯å¥½ãªæ¼”å¥ã§ã™ï¼",detailed:r.map(g=>g.message),suggestions:r.map(g=>g.actions).flat()},o=[{label:"éŸ³ç¨‹ç²¾åº¦",value:Math.round(((m=e.analyzers.interval)==null?void 0:m.averageAccuracy)||0),weight:40},{label:"èªè­˜é€Ÿåº¦",value:Math.round(100-(e.averageResponseTime||5e3)/50),weight:20},{label:"éŸ³ç¨‹ç¿’å¾—",value:Math.round(((h=e.analyzers.interval)==null?void 0:h.masteryLevel)||0),weight:20},{label:"æ–¹å‘ç²¾åº¦",value:Math.round(((d=e.analyzers.direction)==null?void 0:d.accuracy)||0),weight:10},{label:"ä¸€è²«æ€§",value:Math.round(((u=e.analyzers.consistency)==null?void 0:u.score)||0),weight:10}],c=o.reduce((g,D)=>g+D.value*D.weight/100,0);let l="C";return c>=90?l="S":c>=80?l="A":c>=70&&(l="B"),{timestamp:Date.now(),totalScore:Math.round(c),grade:l,componentScores:o,feedback:a,intervalAnalysis:{masteryLevels:((y=e.analyzers.interval)==null?void 0:y.intervalMastery)||{},attemptCounts:((p=e.analyzers.interval)==null?void 0:p.attemptCounts)||{},accuracyRates:((f=e.analyzers.interval)==null?void 0:f.accuracyRates)||{}},consistencyHistory:((v=e.analyzers.consistency)==null?void 0:v.recentScores)||[],overall:s,detailed:n,improvements:r,session:i,metadata:{version:"2.2.1-FIXED",engine:"EnhancedScoringEngine"}}}generateImprovementSuggestions(){const e=[],t=this.getStatistics();return t.analyzers.interval.averageAccuracy<70&&e.push({category:"interval",priority:"high",message:"éŸ³ç¨‹ã®æ­£ç¢ºæ€§å‘ä¸ŠãŒå¿…è¦ã§ã™ã€‚åŸºæœ¬çš„ãªéŸ³ç¨‹ï¼ˆå®Œå…¨5åº¦ã€ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ï¼‰ã‹ã‚‰ç·´ç¿’ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚",actions:["åŸºæœ¬éŸ³ç¨‹ã®é›†ä¸­ç·´ç¿’","æ¥½å™¨ã§ã®ç¢ºèª","æ­Œå”±ç·´ç¿’"]}),t.analyzers.direction.accuracy<80&&e.push({category:"direction",priority:"medium",message:"éŸ³ç¨‹ã®ä¸Šè¡Œãƒ»ä¸‹è¡Œã®åˆ¤æ–­ç²¾åº¦ã‚’å‘ä¸Šã•ã›ã¾ã—ã‚‡ã†ã€‚",actions:["éŸ³éšç·´ç¿’","è´éŸ³ç·´ç¿’","ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è­˜åˆ¥"]}),t.analyzers.consistency.score<75&&e.push({category:"consistency",priority:"medium",message:"å®‰å®šã—ãŸç²¾åº¦ã‚’ä¿ã¤ãŸã‚ã€ç¶™ç¶šçš„ãªç·´ç¿’ãŒåŠ¹æœçš„ã§ã™ã€‚",actions:["å®šæœŸçš„ãªç·´ç¿’","é›†ä¸­åŠ›å‘ä¸Š","ç–²åŠ´ç®¡ç†"]}),e}getStatistics(){return{session:this.sessionData,performance:this.performanceMetrics,analyzers:{interval:this.intervalAnalyzer.getStatistics(),direction:this.directionAnalyzer.getStatistics(),consistency:this.consistencyTracker.getStatistics()},config:this.config}}updateConfig(e){this.config={...this.config,...e},this.log("âš™ï¸ è¨­å®šæ›´æ–°å®Œäº†",this.config)}reset(){this.intervalAnalyzer.reset(),this.directionAnalyzer.reset(),this.consistencyTracker.reset(),this.sessionData={startTime:Date.now(),totalAttempts:0,overallScore:0,performanceHistory:[],currentLevel:"beginner",achievements:new Set,lastAnalysis:null},this.performanceMetrics={averageSpeed:0,accuracyTrend:"stable",strengthAreas:[],improvementAreas:[],sessionProgress:0},this.log("ğŸ”„ EnhancedScoringEngine ãƒªã‚»ãƒƒãƒˆå®Œäº†")}}typeof window<"u"&&(window.EnhancedScoringEngine=w);export{w as E};
