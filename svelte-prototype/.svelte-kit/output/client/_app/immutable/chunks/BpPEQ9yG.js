class v{constructor(){this.intervalTypes={unison:{name:"åŒåº¦",semitones:0,importance:.8,description:"åŸºéŸ³ã¨åŒã˜é«˜ã•",difficulty:"åŸºæœ¬",commonErrors:["å¾®ç´°ãªãƒ”ãƒƒãƒã®ãšã‚Œ"]},minorSecond:{name:"çŸ­2åº¦",semitones:1,importance:.9,description:"åŠéŸ³ä¸Š",difficulty:"é«˜",commonErrors:["é•·2åº¦ã¨ã®æ··åŒ","éŸ³ç¨‹å¹…ã®éå¤§è©•ä¾¡"]},majorSecond:{name:"é•·2åº¦",semitones:2,importance:1,description:"å…¨éŸ³ä¸Šï¼ˆãƒ‰ãƒ¬ï¼‰",difficulty:"åŸºæœ¬",commonErrors:["çŸ­2åº¦ã¨ã®æ··åŒ"]},minorThird:{name:"çŸ­3åº¦",semitones:3,importance:1,description:"çŸ­èª¿ã®3åº¦ï¼ˆãƒ‰ãƒŸâ™­ï¼‰",difficulty:"ä¸­",commonErrors:["é•·3åº¦ã¨ã®æ··åŒ"]},majorThird:{name:"é•·3åº¦",semitones:4,importance:1,description:"é•·èª¿ã®3åº¦ï¼ˆãƒ‰ãƒŸï¼‰",difficulty:"åŸºæœ¬",commonErrors:["çŸ­3åº¦ã¨ã®æ··åŒ","å®Œå…¨4åº¦ã¸ã®èª¤èª"]},perfectFourth:{name:"å®Œå…¨4åº¦",semitones:5,importance:.9,description:"å®‰å®šã—ãŸå”å’ŒéŸ³ç¨‹ï¼ˆãƒ‰ãƒ•ã‚¡ï¼‰",difficulty:"åŸºæœ¬",commonErrors:["é•·3åº¦ãƒ»æ¸›5åº¦ã¨ã®æ··åŒ"]},tritone:{name:"æ¸›5åº¦",semitones:6,importance:.7,description:"ä¸å®‰å®šãªéŸ³ç¨‹ï¼ˆãƒ‰ãƒ•ã‚¡#ï¼‰",difficulty:"é«˜",commonErrors:["å®Œå…¨4åº¦ãƒ»å®Œå…¨5åº¦ã¨ã®æ··åŒ"]},perfectFifth:{name:"å®Œå…¨5åº¦",semitones:7,importance:.9,description:"æœ€ã‚‚å®‰å®šã—ãŸéŸ³ç¨‹ï¼ˆãƒ‰ã‚½ï¼‰",difficulty:"åŸºæœ¬",commonErrors:["æ¸›5åº¦ãƒ»é•·6åº¦ã¨ã®æ··åŒ"]},minorSixth:{name:"çŸ­6åº¦",semitones:8,importance:.8,description:"çŸ­èª¿çš„è‰²å½©ï¼ˆãƒ‰ãƒ©â™­ï¼‰",difficulty:"ä¸­",commonErrors:["é•·6åº¦ãƒ»å®Œå…¨5åº¦ã¨ã®æ··åŒ"]},majorSixth:{name:"é•·6åº¦",semitones:9,importance:.8,description:"æ˜ã‚‹ã„éŸ¿ãï¼ˆãƒ‰ãƒ©ï¼‰",difficulty:"ä¸­",commonErrors:["çŸ­6åº¦ãƒ»çŸ­7åº¦ã¨ã®æ··åŒ"]},minorSeventh:{name:"çŸ­7åº¦",semitones:10,importance:.7,description:"å±7å’ŒéŸ³ã®7åº¦ï¼ˆãƒ‰ã‚·â™­ï¼‰",difficulty:"ä¸­",commonErrors:["é•·7åº¦ãƒ»é•·6åº¦ã¨ã®æ··åŒ"]},majorSeventh:{name:"é•·7åº¦",semitones:11,importance:.7,description:"é‹­ã„ä¸å”å’ŒéŸ³ç¨‹ï¼ˆãƒ‰ã‚·ï¼‰",difficulty:"é«˜",commonErrors:["çŸ­7åº¦ãƒ»8åº¦ã¨ã®æ··åŒ"]},octave:{name:"8åº¦",semitones:12,importance:.9,description:"1ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸Šï¼ˆãƒ‰ãƒ‰ï¼‰",difficulty:"åŸºæœ¬",commonErrors:["HarmonicCorrectionã«ã‚ˆã‚‹å€éŸ³èª¤æ¤œå‡º"]}},this.masteryData=new Map,this.analysisHistory=[],this.maxHistoryLength=100,this.debugMode=!0,this.initializeMasteryData(),this.log("ğŸµ IntervalAnalyzeråˆæœŸåŒ–å®Œäº†",{intervalCount:Object.keys(this.intervalTypes).length,masteryData:this.masteryData.size})}analyzeInterval(e,t,n){try{const s=this.calculateSemitones(e,t),r=this.identifyInterval(s),i=this.calculateSemitones(e,n),o=this.identifyInterval(i),a=this.calculateIntervalAccuracy(s,i);this.updateMastery(r.key,a);const c=this.getMastery(r.key),l={targetInterval:r,detectedInterval:o,targetSemitones:s,detectedSemitones:i,accuracy:a,mastery:c,isCorrectInterval:r.key===o.key,feedback:this.generateIntervalFeedback(r,o,a),timestamp:Date.now()};return this.recordAnalysis(l),this.debugMode&&this.logAnalysisDetails(l),l}catch(s){return console.error("âŒ [IntervalAnalyzer] åˆ†æã‚¨ãƒ©ãƒ¼:",s),this.createErrorResult(e,t,n)}}calculateSemitones(e,t){return!e||!t||e<=0||t<=0?0:(12*Math.log2(t/e)%12+12)%12}identifyInterval(e){let t=null,n=1/0;for(const[s,r]of Object.entries(this.intervalTypes)){const i=Math.abs(e-r.semitones);i<n&&(n=i,t={key:s,...r,distance:i})}return t}calculateIntervalAccuracy(e,t){const n=Math.abs(e-t),s=Math.max(0,100-n*50);return Math.min(100,s)}updateMastery(e,t){this.masteryData.has(e)||this.masteryData.set(e,{attempts:0,totalAccuracy:0,averageAccuracy:0,bestAccuracy:0,recentAttempts:[],lastAttempt:null,trend:"stable"});const n=this.masteryData.get(e);n.attempts++,n.totalAccuracy+=t,n.averageAccuracy=n.totalAccuracy/n.attempts,n.bestAccuracy=Math.max(n.bestAccuracy,t),n.lastAttempt=Date.now(),n.recentAttempts.push(t),n.recentAttempts.length>10&&n.recentAttempts.shift(),n.trend=this.calculateTrend(n.recentAttempts),this.masteryData.set(e,n)}getMastery(e){const t=this.masteryData.get(e);if(!t)return{attempts:0,averageAccuracy:0,bestAccuracy:0,level:"beginner",progress:0};const n=this.determineMasteryLevel(t.averageAccuracy,t.attempts),s=Math.min(100,t.averageAccuracy*t.attempts/500);return{...t,level:n,progress:Math.round(s)}}determineMasteryLevel(e,t){return t<3?"beginner":e>=90&&t>=10?"master":e>=80&&t>=7?"advanced":e>=70&&t>=5?"intermediate":e>=50?"novice":"beginner"}calculateTrend(e){if(e.length<3)return"stable";const t=e.slice(-3),n=e.slice(-6,-3);if(n.length===0)return"stable";const s=t.reduce((o,a)=>o+a,0)/t.length,r=n.reduce((o,a)=>o+a,0)/n.length,i=s-r;return i>5?"improving":i<-5?"declining":"stable"}generateIntervalFeedback(e,t,n){const s=e.key===t.key;if(s&&n>=90)return`ğŸ¯ ${e.name}ã‚’å®Œç’§ã«èªè­˜ã—ã¾ã—ãŸï¼`;if(s&&n>=70)return`âœ… ${e.name}ã®èªè­˜ã¯æ­£ã—ã„ã§ã™ã€‚ç²¾åº¦ã‚’ä¸Šã’ã¦ã¿ã¾ã—ã‚‡ã†ã€‚`;if(s)return`ğŸ‘ ${e.name}ã‚’èªè­˜ã§ãã¦ã„ã¾ã™ã€‚ã‚‚ã†å°‘ã—æ­£ç¢ºã«ã€‚`;const r=this.analyzeIntervalError(e,t);return`âŒ ${e.name}ã§ã¯ãªã${t.name}ã¨èªè­˜ã•ã‚Œã¾ã—ãŸã€‚${r}`}analyzeIntervalError(e,t){const n=t.semitones-e.semitones;return Math.abs(n)===1?n>0?"å°‘ã—é«˜ã‚ã«æ­Œã£ã¦ã„ã¾ã™ã€‚":"å°‘ã—ä½ã‚ã«æ­Œã£ã¦ã„ã¾ã™ã€‚":Math.abs(n)<=2?"éŸ³ç¨‹å¹…ã®èª¿æ•´ãŒå¿…è¦ã§ã™ã€‚":Math.abs(n)>=6?"ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–é–¢ä¿‚ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚":"éŸ³ç¨‹ã®ç‰¹å¾´ã‚’æ„è­˜ã—ã¦ã¿ã¦ãã ã•ã„ã€‚"}getAllMasteryData(){const e={};for(const[t,n]of Object.entries(this.intervalTypes))e[t]={interval:n,mastery:this.getMastery(t)};return e}getWeakIntervals(e=3){return Object.entries(this.getAllMasteryData()).filter(([n,s])=>s.mastery.attempts>=2).sort((n,s)=>n[1].mastery.averageAccuracy-s[1].mastery.averageAccuracy).slice(0,e).map(([n,s])=>({key:n,name:s.interval.name,accuracy:s.mastery.averageAccuracy,attempts:s.mastery.attempts,improvement:this.generateImprovementTip(n,s)}))}getStrongIntervals(e=3){return Object.entries(this.getAllMasteryData()).filter(([n,s])=>s.mastery.attempts>=3).sort((n,s)=>s[1].mastery.averageAccuracy-n[1].mastery.averageAccuracy).slice(0,e).map(([n,s])=>({key:n,name:s.interval.name,accuracy:s.mastery.averageAccuracy,attempts:s.mastery.attempts,reason:this.generateStrengthReason(n,s)}))}generateImprovementTip(e,t){const n=t.interval;return t.mastery.trend==="improving"?`ğŸ“ˆ æ”¹å–„ä¸­ã§ã™ï¼${n.description}ã®ç‰¹å¾´ã‚’æ„è­˜ã—ã¦ç·´ç¿’ã‚’ç¶šã‘ã¾ã—ã‚‡ã†ã€‚`:n.commonErrors.length>0?`ğŸ’¡ ${n.commonErrors[0]}ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚`:`ğŸ¯ ${n.description}ã‚’æ„è­˜ã—ã¦ã€ã‚†ã£ãã‚Šã¨ç·´ç¿’ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚`}generateStrengthReason(e,t){const n=t.interval,s=t.mastery;return s.averageAccuracy>=95?`å®Œç’§ãªç²¾åº¦ã§${n.name}ã‚’èªè­˜ã§ãã¦ã„ã¾ã™ï¼`:s.trend==="improving"?`${n.name}ã®ç†è§£ãŒæ€¥é€Ÿã«å‘ä¸Šã—ã¦ã„ã¾ã™ã€‚`:`${n.name}ã®èªè­˜ãŒå®‰å®šã—ã¦ã„ã¾ã™ã€‚`}initializeMasteryData(){}recordAnalysis(e){this.analysisHistory.push(e),this.analysisHistory.length>this.maxHistoryLength&&this.analysisHistory.shift()}createErrorResult(e,t,n){return{targetInterval:{name:"ä¸æ˜",key:"unknown"},detectedInterval:{name:"ä¸æ˜",key:"unknown"},accuracy:0,mastery:{level:"beginner",progress:0},isCorrectInterval:!1,feedback:"éŸ³ç¨‹åˆ†æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚",error:!0}}logAnalysisDetails(e){var t;console.group(`ğŸµ [IntervalAnalyzer] ${e.targetInterval.name}åˆ†æçµæœ`),console.log("ğŸ¯ éŸ³ç¨‹åˆ†æ:",{ç›®æ¨™:`${e.targetInterval.name} (${e.targetSemitones.toFixed(1)}ã‚»ãƒŸãƒˆãƒ¼ãƒ³)`,æ¤œå‡º:`${e.detectedInterval.name} (${e.detectedSemitones.toFixed(1)}ã‚»ãƒŸãƒˆãƒ¼ãƒ³)`,æ­£è§£:e.isCorrectInterval?"âœ…":"âŒ",ç²¾åº¦:`${e.accuracy.toFixed(1)}%`}),console.log("ğŸ“Š ç¿’å¾—çŠ¶æ³:",{ãƒ¬ãƒ™ãƒ«:e.mastery.level,è©¦è¡Œå›æ•°:e.mastery.attempts,å¹³å‡ç²¾åº¦:`${((t=e.mastery.averageAccuracy)==null?void 0:t.toFixed(1))||0}%`,é€²æ—:`${e.mastery.progress}%`,ãƒˆãƒ¬ãƒ³ãƒ‰:e.mastery.trend}),console.log("ğŸ’¬ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯:",e.feedback),console.groupEnd()}log(e,t=null){this.debugMode&&(t?console.log(`[IntervalAnalyzer] ${e}`,t):console.log(`[IntervalAnalyzer] ${e}`))}getStatistics(){return{totalAnalyses:this.analysisHistory.length,intervalTypes:Object.keys(this.intervalTypes).length,masteryLevels:Object.fromEntries(this.masteryData),sessionStartTime:this.sessionStartTime||Date.now()}}reset(){this.masteryData.clear(),this.analysisHistory=[],this.initializeMasteryData(),this.log("ğŸ”„ IntervalAnalyzer ãƒªã‚»ãƒƒãƒˆå®Œäº†")}}typeof window<"u"&&(window.IntervalAnalyzer=v);class A{constructor(){this.directions={ascending:{name:"ä¸Šè¡Œ",icon:"â†—ï¸",description:"åŸºéŸ³ã‚ˆã‚Šé«˜ã„éŸ³ç¨‹",color:"#10b981",commonErrors:["ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸‹èªè­˜ï¼ˆå€éŸ³åŠ¹æœï¼‰","éŸ³ç¨‹å¹…ã®éå°è©•ä¾¡","ç›®æ¨™éŸ³ç¨‹ã®æ‰‹å‰ã§åœæ­¢"]},descending:{name:"ä¸‹è¡Œ",icon:"â†˜ï¸",description:"åŸºéŸ³ã‚ˆã‚Šä½ã„éŸ³ç¨‹",color:"#3b82f6",commonErrors:["ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸Šèªè­˜ï¼ˆå€éŸ³åŠ¹æœï¼‰","éŸ³ç¨‹å¹…ã®éå¤§è©•ä¾¡","ç›®æ¨™éŸ³ç¨‹ã‚’é€šã‚Šè¶Šã™"]},unison:{name:"åŒéŸ³",icon:"â¡ï¸",description:"åŸºéŸ³ã¨åŒã˜é«˜ã•",color:"#6b7280",commonErrors:["å¾®ç´°ãªãƒ”ãƒƒãƒãšã‚Œ","å€éŸ³ã«ã‚ˆã‚‹èª¤èªè­˜"]}},this.directionMastery=new Map,this.analysisHistory=[],this.maxHistoryLength=50,this.debugMode=!0,this.thresholds={unison:.5,overshoot:1.5,significant:3},this.initializeDirectionMastery(),this.log("ğŸ§­ DirectionAnalyzeråˆæœŸåŒ–å®Œäº†",{directions:Object.keys(this.directions).length,thresholds:this.thresholds})}analyzeDirection(e,t,n){try{const s=this.determineDirection(e,t),r=this.calculateSemitones(e,t),i=this.determineDirection(e,n),o=this.calculateSemitones(e,n),a=s.key===i.key,c=this.analyzeOvershoot(r,o),l=this.calculateDirectionAccuracy(s.key,i.key,r,o);this.updateDirectionMastery(s.key,l,a);const h=this.getDirectionMastery(s.key),m={targetDirection:s,detectedDirection:i,targetSemitones:r,detectedSemitones:o,directionCorrect:a,accuracy:l,mastery:h,overshoot:c,feedback:this.generateDirectionFeedback(s,i,c,l),timestamp:Date.now()};return this.recordAnalysis(m),this.debugMode&&this.logAnalysisDetails(m),m}catch(s){return console.error("âŒ [DirectionAnalyzer] åˆ†æã‚¨ãƒ©ãƒ¼:",s),this.createErrorResult(e,t,n)}}determineDirection(e,t){const n=this.calculateSemitones(e,t);return Math.abs(n)<=this.thresholds.unison?{key:"unison",...this.directions.unison}:n>0?{key:"ascending",...this.directions.ascending}:{key:"descending",...this.directions.descending}}calculateSemitones(e,t){return!e||!t||e<=0||t<=0?0:12*Math.log2(t/e)}analyzeOvershoot(e,t){const n=t-e,s=Math.abs(n);let r="accurate",i="none";return s>=this.thresholds.overshoot&&(n>0?r="overshoot":r="undershoot",s>=this.thresholds.significant?i="severe":i="moderate"),{type:r,severity:i,difference:n,absDifference:s,percentage:s/Math.abs(e)*100}}calculateDirectionAccuracy(e,t,n,s){if(e!==t)return Math.max(0,30-Math.abs(s-n)*5);const r=Math.abs(s-n),i=Math.max(0,100-r*25);return Math.min(100,i)}updateDirectionMastery(e,t,n){this.directionMastery.has(e)||this.directionMastery.set(e,{attempts:0,correctAttempts:0,totalAccuracy:0,averageAccuracy:0,bestAccuracy:0,successRate:0,recentAttempts:[],recentCorrects:[],lastAttempt:null,trend:"stable"});const s=this.directionMastery.get(e);s.attempts++,n&&s.correctAttempts++,s.totalAccuracy+=t,s.averageAccuracy=s.totalAccuracy/s.attempts,s.bestAccuracy=Math.max(s.bestAccuracy,t),s.successRate=s.correctAttempts/s.attempts*100,s.lastAttempt=Date.now(),s.recentAttempts.push(t),s.recentCorrects.push(n),s.recentAttempts.length>10&&(s.recentAttempts.shift(),s.recentCorrects.shift()),s.trend=this.calculateDirectionTrend(s.recentCorrects),this.directionMastery.set(e,s)}getDirectionMastery(e){const t=this.directionMastery.get(e);if(!t)return{attempts:0,successRate:0,averageAccuracy:0,level:"beginner",progress:0};const n=this.determineDirectionLevel(t.successRate,t.attempts),s=Math.min(100,t.successRate*t.attempts/500);return{...t,level:n,progress:Math.round(s)}}determineDirectionLevel(e,t){return t<3?"beginner":e>=95&&t>=10?"master":e>=85&&t>=7?"advanced":e>=75&&t>=5?"intermediate":e>=60?"novice":"beginner"}calculateDirectionTrend(e){if(e.length<5)return"stable";const t=e.slice(-3),n=e.slice(-6,-3);if(n.length===0)return"stable";const s=t.filter(Boolean).length/t.length,r=n.filter(Boolean).length/n.length,i=s-r;return i>.2?"improving":i<-.2?"declining":"stable"}generateDirectionFeedback(e,t,n,s){const r=e.key===t.key;return r&&s>=90?`ğŸ¯ ${e.name}ã®æ–¹å‘æ€§ãŒå®Œç’§ã§ã™ï¼`:r&&s>=70?`âœ… ${e.name}ã®æ–¹å‘ã¯æ­£ã—ã„ã§ã™ã€‚è·é›¢ã®èª¿æ•´ã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚`:r?n.type==="overshoot"?`ğŸ‘ ${e.name}ã®æ–¹å‘ã¯æ­£ã—ã„ã§ã™ãŒã€å°‘ã—æ­Œã„ã™ãã§ã™ã€‚`:n.type==="undershoot"?`ğŸ‘ ${e.name}ã®æ–¹å‘ã¯æ­£ã—ã„ã§ã™ãŒã€ã‚‚ã†å°‘ã—å¤§ããæ­Œã£ã¦ã¿ã¦ãã ã•ã„ã€‚`:`ğŸ‘ ${e.name}ã®æ–¹å‘ã¯èªè­˜ã§ãã¦ã„ã¾ã™ã€‚`:e.key==="ascending"&&t.key==="descending"?"âŒ ä¸Šè¡Œã®ã¤ã‚‚ã‚ŠãŒä¸‹è¡Œã«ãªã£ã¦ã„ã¾ã™ã€‚åŸºéŸ³ã‚ˆã‚Šé«˜ãæ­Œã£ã¦ãã ã•ã„ã€‚":e.key==="descending"&&t.key==="ascending"?"âŒ ä¸‹è¡Œã®ã¤ã‚‚ã‚ŠãŒä¸Šè¡Œã«ãªã£ã¦ã„ã¾ã™ã€‚åŸºéŸ³ã‚ˆã‚Šä½ãæ­Œã£ã¦ãã ã•ã„ã€‚":e.key!=="unison"&&t.key==="unison"?`âŒ éŸ³ç¨‹å¤‰åŒ–ãŒå°ã•ã™ãã¾ã™ã€‚${e.name}ã«ã‚ˆã‚Šå¤§ããæ­Œã£ã¦ãã ã•ã„ã€‚`:`âŒ ${e.name}ã§ã¯ãªã${t.name}ã¨èªè­˜ã•ã‚Œã¾ã—ãŸã€‚`}getAllDirectionMastery(){const e={};for(const[t,n]of Object.entries(this.directions))e[t]={direction:n,mastery:this.getDirectionMastery(t)};return e}getDirectionComparison(){const e=this.getDirectionMastery("ascending"),t=this.getDirectionMastery("descending");return{ascending:e,descending:t,comparison:{betterDirection:e.successRate>t.successRate?"ascending":"descending",difference:Math.abs(e.successRate-t.successRate),recommendation:this.generateDirectionRecommendation(e,t)}}}generateDirectionRecommendation(e,t){const n=e.successRate-t.successRate;return Math.abs(n)<10?"ä¸Šè¡Œãƒ»ä¸‹è¡Œã¨ã‚‚ã«ãƒãƒ©ãƒ³ã‚¹è‰¯ãç¿’å¾—ã§ãã¦ã„ã¾ã™ã€‚":n>10?"ä¸‹è¡Œã®ç·´ç¿’ã‚’é‡ç‚¹çš„ã«è¡Œã†ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚ä¸‹å‘ãã®éŸ³ç¨‹ã«ã‚ˆã‚Šæ„è­˜ã‚’å‘ã‘ã¦ã¿ã¦ãã ã•ã„ã€‚":"ä¸Šè¡Œã®ç·´ç¿’ã‚’é‡ç‚¹çš„ã«è¡Œã†ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚ä¸Šå‘ãã®éŸ³ç¨‹ã«ã‚ˆã‚Šæ„è­˜ã‚’å‘ã‘ã¦ã¿ã¦ãã ã•ã„ã€‚"}initializeDirectionMastery(){for(const e of Object.keys(this.directions))this.directionMastery.has(e)||this.directionMastery.set(e,{attempts:0,correctAttempts:0,totalAccuracy:0,averageAccuracy:0,bestAccuracy:0,successRate:0,recentAttempts:[],recentCorrects:[],lastAttempt:null,trend:"stable"})}recordAnalysis(e){this.analysisHistory.push(e),this.analysisHistory.length>this.maxHistoryLength&&this.analysisHistory.shift()}createErrorResult(e,t,n){return{targetDirection:{name:"ä¸æ˜",key:"unknown"},detectedDirection:{name:"ä¸æ˜",key:"unknown"},directionCorrect:!1,accuracy:0,mastery:{level:"beginner",progress:0},overshoot:{type:"unknown",severity:"none"},feedback:"æ–¹å‘æ€§åˆ†æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚",error:!0}}logAnalysisDetails(e){var t;console.group(`ğŸ§­ [DirectionAnalyzer] ${e.targetDirection.name}åˆ†æçµæœ`),console.log("ğŸ¯ æ–¹å‘æ€§åˆ†æ:",{ç›®æ¨™:`${e.targetDirection.name} (${e.targetSemitones.toFixed(1)}ã‚»ãƒŸãƒˆãƒ¼ãƒ³)`,æ¤œå‡º:`${e.detectedDirection.name} (${e.detectedSemitones.toFixed(1)}ã‚»ãƒŸãƒˆãƒ¼ãƒ³)`,æ­£è§£:e.directionCorrect?"âœ…":"âŒ",ç²¾åº¦:`${e.accuracy.toFixed(1)}%`}),console.log("ğŸ“Š ã‚ªãƒ¼ãƒãƒ¼ã‚·ãƒ¥ãƒ¼ãƒˆåˆ†æ:",{ã‚¿ã‚¤ãƒ—:e.overshoot.type,æ·±åˆ»åº¦:e.overshoot.severity,å·®åˆ†:`${e.overshoot.difference.toFixed(1)}ã‚»ãƒŸãƒˆãƒ¼ãƒ³`,èª¤å·®ç‡:`${e.overshoot.percentage.toFixed(1)}%`}),console.log("ğŸ“ˆ ç¿’å¾—çŠ¶æ³:",{ãƒ¬ãƒ™ãƒ«:e.mastery.level,æˆåŠŸç‡:`${((t=e.mastery.successRate)==null?void 0:t.toFixed(1))||0}%`,è©¦è¡Œå›æ•°:e.mastery.attempts,ãƒˆãƒ¬ãƒ³ãƒ‰:e.mastery.trend}),console.log("ğŸ’¬ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯:",e.feedback),console.groupEnd()}log(e,t=null){this.debugMode&&(t?console.log(`[DirectionAnalyzer] ${e}`,t):console.log(`[DirectionAnalyzer] ${e}`))}getStatistics(){return{totalAnalyses:this.analysisHistory.length,directionTypes:Object.keys(this.directions).length,masteryData:Object.fromEntries(this.directionMastery),thresholds:this.thresholds}}reset(){this.directionMastery.clear(),this.analysisHistory=[],this.initializeDirectionMastery(),this.log("ğŸ”„ DirectionAnalyzer ãƒªã‚»ãƒƒãƒˆå®Œäº†")}}typeof window<"u"&&(window.DirectionAnalyzer=A);class D{constructor(e={}){this.config={windowSize:e.windowSize||5,maxHistory:e.maxHistory||100,stabilityThreshold:e.stabilityThreshold||25,trendWindowSize:e.trendWindowSize||10,fatigueDetectionWindow:e.fatigueDetectionWindow||15},this.consistencyData=new Map,this.stabilityHistory=[],this.sessionData={startTime:Date.now(),totalAttempts:0,overallConsistency:0,stabilityTrend:"stable",fatigueLevel:"fresh",concentrationLevel:"high"},this.debugMode=!0,this.log("ğŸ“Š ConsistencyTrackeråˆæœŸåŒ–å®Œäº†",{config:this.config,sessionStart:new Date(this.sessionData.startTime).toLocaleTimeString()})}recordAttempt(e,t,n,s){try{this.addAttemptData(e,t,n,s);const r=this.calculateIntervalConsistency(e);this.updateOverallConsistency();const i=this.analyzeStabilityTrend(),o=this.analyzeFatigue(),a={intervalType:e,intervalConsistency:r,overallConsistency:this.sessionData.overallConsistency,stabilityTrend:i,fatigueAnalysis:o,recommendations:this.generateConsistencyRecommendations(r,o),timestamp:Date.now()};return this.updateSessionData(a),this.debugMode&&this.logConsistencyDetails(a),a}catch(r){return console.error("âŒ [ConsistencyTracker] è¨˜éŒ²ã‚¨ãƒ©ãƒ¼:",r),this.createErrorResult(e)}}addAttemptData(e,t,n,s){this.consistencyData.has(e)||this.consistencyData.set(e,{attempts:[],statistics:{count:0,mean:0,standardDeviation:0,variance:0,range:0,consistencyScore:0},trend:"stable",lastUpdated:Date.now()});const r=this.consistencyData.get(e),i={centsDiff:t,accuracy:n,responseTime:s,timestamp:Date.now()};r.attempts.push(i),r.attempts.length>this.config.maxHistory&&r.attempts.shift(),this.updateStatistics(e),this.stabilityHistory.push({intervalType:e,centsDiff:Math.abs(t),accuracy:n,timestamp:Date.now()}),this.stabilityHistory.length>this.config.maxHistory&&this.stabilityHistory.shift(),this.sessionData.totalAttempts++}updateStatistics(e){const t=this.consistencyData.get(e),n=t.attempts;if(n.length===0)return;const s=n.map(h=>Math.abs(h.centsDiff)),r=s.length,i=s.reduce((h,m)=>h+m,0)/r,o=s.reduce((h,m)=>h+Math.pow(m-i,2),0)/r,a=Math.sqrt(o),c=Math.max(...s)-Math.min(...s),l=Math.max(0,100-a*2);t.statistics={count:r,mean:Math.round(i*10)/10,standardDeviation:Math.round(a*10)/10,variance:Math.round(o*10)/10,range:Math.round(c*10)/10,consistencyScore:Math.round(l*10)/10},t.trend=this.calculateIntervalTrend(n),t.lastUpdated=Date.now()}calculateIntervalConsistency(e){const t=this.consistencyData.get(e);if(!t||t.attempts.length<2)return{level:"insufficient_data",score:0,description:"ãƒ‡ãƒ¼ã‚¿ä¸è¶³",attempts:(t==null?void 0:t.attempts.length)||0};const n=t.statistics,s=this.determineConsistencyLevel(n.consistencyScore);return{intervalType:e,level:s,score:n.consistencyScore,statistics:n,trend:t.trend,description:this.getConsistencyDescription(s),attempts:n.count,recommendation:this.getIntervalRecommendation(e,n,t.trend)}}determineConsistencyLevel(e){return e>=90?"excellent":e>=75?"good":e>=60?"fair":e>=40?"poor":"very_poor"}getConsistencyDescription(e){return{excellent:"éå¸¸ã«å®‰å®šã—ãŸç²¾åº¦ã§èªè­˜ã§ãã¦ã„ã¾ã™",good:"å®‰å®šã—ãŸèªè­˜ãŒã§ãã¦ã„ã¾ã™",fair:"ã‚„ã‚„ä¸å®‰å®šã§ã™ãŒã€æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™",poor:"ä¸å®‰å®šãªèªè­˜ã§ã™ã€‚ç·´ç¿’ã‚’é‡ã­ã¾ã—ã‚‡ã†",very_poor:"éå¸¸ã«ä¸å®‰å®šã§ã™ã€‚åŸºç¤ç·´ç¿’ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†",insufficient_data:"ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™"}[e]||"è©•ä¾¡ä¸èƒ½"}updateOverallConsistency(){if(this.stabilityHistory.length<5){this.sessionData.overallConsistency=0;return}const t=this.stabilityHistory.slice(-this.config.trendWindowSize).map(r=>r.centsDiff),n=t.reduce((r,i)=>r+i,0)/t.length,s=Math.sqrt(t.reduce((r,i)=>r+Math.pow(i-n,2),0)/t.length);this.sessionData.overallConsistency=Math.max(0,100-s*2)}analyzeStabilityTrend(){if(this.stabilityHistory.length<this.config.trendWindowSize)return{trend:"insufficient_data",direction:"stable",confidence:0,description:"ãƒ‡ãƒ¼ã‚¿ä¸è¶³"};const e=this.stabilityHistory.slice(-this.config.trendWindowSize),t=Math.floor(this.config.trendWindowSize/2),n=e.slice(0,t),s=e.slice(-t),r=n.reduce((m,d)=>m+d.centsDiff,0)/n.length,i=s.reduce((m,d)=>m+d.centsDiff,0)/s.length,o=r-i,a=o/r*100;let c,l,h;return Math.abs(a)<10?(c="stable",l="stable",h=.7):o>0?(c="improving",l="better",h=Math.min(.9,Math.abs(a)/20)):(c="declining",l="worse",h=Math.min(.9,Math.abs(a)/20)),this.sessionData.stabilityTrend=c,{trend:c,direction:l,confidence:Math.round(h*100)/100,improvement:Math.round(o*10)/10,improvementPercent:Math.round(a*10)/10,description:this.getTrendDescription(c,l)}}analyzeFatigue(){if(this.stabilityHistory.length<this.config.fatigueDetectionWindow)return{fatigueLevel:"unknown",concentrationLevel:"unknown",recommendation:"ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã®ãŸã‚åˆ¤å®šã§ãã¾ã›ã‚“"};const e=this.stabilityHistory.slice(-this.config.fatigueDetectionWindow),n=(Date.now()-this.sessionData.startTime)/(1e3*60);let s="fresh";n>30&&(s="moderate"),n>60&&(s="tired"),n>90&&(s="exhausted");const r=e.map(d=>d.accuracy),i=r.reduce((d,u)=>d+u,0)/r.length,o=this.stabilityHistory.map(d=>d.accuracy),c=o.reduce((d,u)=>d+u,0)/o.length-i;let l="fresh";c>5&&(l="moderate"),c>10&&(l="tired"),c>20&&(l="exhausted");const h=this.combineFatigueFactors(s,l),m=this.evaluateConcentration(e);return this.sessionData.fatigueLevel=h,this.sessionData.concentrationLevel=m,{fatigueLevel:h,concentrationLevel:m,sessionMinutes:Math.round(n),accuracyDrop:Math.round(c*10)/10,recommendation:this.getFatigueRecommendation(h,m)}}combineFatigueFactors(e,t){const n=["fresh","moderate","tired","exhausted"],s=n.indexOf(e),r=n.indexOf(t),i=Math.max(s,r);return n[i]}evaluateConcentration(e){const t=e.map(s=>s.centsDiff),n=Math.sqrt(t.reduce((s,r)=>s+Math.pow(r-t.reduce((i,o)=>i+o,0)/t.length,2),0)/t.length);return n<=15?"high":n<=25?"medium":n<=40?"low":"very_low"}generateConsistencyRecommendations(e,t){const n=[];return(t.fatigueLevel==="tired"||t.fatigueLevel==="exhausted")&&n.push({type:"rest",priority:"high",message:"ç–²åŠ´ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚10-15åˆ†ã®ä¼‘æ†©ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚",icon:"ğŸ˜´"}),(t.concentrationLevel==="low"||t.concentrationLevel==="very_low")&&n.push({type:"focus",priority:"medium",message:"é›†ä¸­åŠ›ãŒä½ä¸‹ã—ã¦ã„ã¾ã™ã€‚æ·±å‘¼å¸ã‚’ã—ã¦ã€ã‚†ã£ãã‚Šã¨ç·´ç¿’ã—ã¦ã¿ã¦ãã ã•ã„ã€‚",icon:"ğŸ§˜"}),(e.level==="poor"||e.level==="very_poor")&&n.push({type:"practice",priority:"medium",message:`${e.intervalType}ã®ç·´ç¿’ã‚’é‡ç‚¹çš„ã«è¡Œã„ã¾ã—ã‚‡ã†ã€‚ã‚†ã£ãã‚Šã¨æ­£ç¢ºã«æ­Œã†ã“ã¨ã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚`,icon:"ğŸ¯"}),e.trend==="improving"&&n.push({type:"encouragement",priority:"low",message:"æ”¹å–„ãŒè¦‹ã‚‰ã‚Œã¾ã™ï¼ã“ã®èª¿å­ã§ç·´ç¿’ã‚’ç¶šã‘ã¦ãã ã•ã„ã€‚",icon:"ğŸ“ˆ"}),n}getIntervalRecommendation(e,t,n){return t.consistencyScore>=80?"å®‰å®šã—ãŸèªè­˜ãŒã§ãã¦ã„ã¾ã™ã€‚ã“ã®ç²¾åº¦ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚":n==="improving"?"æ”¹å–„å‚¾å‘ã«ã‚ã‚Šã¾ã™ã€‚ç¶™ç¶šã—ã¦ç·´ç¿’ã—ã¦ãã ã•ã„ã€‚":t.standardDeviation>30?"ã°ã‚‰ã¤ããŒå¤§ãã„ã§ã™ã€‚ã‚†ã£ãã‚Šã¨æ­£ç¢ºã«æ­Œã†ã“ã¨ã‚’æ„è­˜ã—ã¦ãã ã•ã„ã€‚":`${e}ã®ç‰¹å¾´ã‚’æ„è­˜ã—ã¦ã€ä¸€å®šã®ç²¾åº¦ã§æ­Œãˆã‚‹ã‚ˆã†ç·´ç¿’ã—ã¾ã—ã‚‡ã†ã€‚`}getTrendDescription(e,t){return{stable:"å®‰å®šã—ãŸç²¾åº¦ã‚’ç¶­æŒã—ã¦ã„ã¾ã™",improving:"ç²¾åº¦ãŒå‘ä¸Šã—ã¦ã„ã¾ã™",declining:"ç²¾åº¦ãŒä½ä¸‹ã—ã¦ã„ã¾ã™"}[e]||"å‚¾å‘ã‚’åˆ†æä¸­"}getFatigueRecommendation(e,t){return e==="exhausted"?"ä»Šæ—¥ã¯ã“ã“ã¾ã§ã«ã—ã¦ã€ååˆ†ãªä¼‘æ¯ã‚’å–ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚":e==="tired"?"15-20åˆ†ã®ä¼‘æ†©ã‚’å–ã£ã¦ã‹ã‚‰ç·´ç¿’ã‚’å†é–‹ã—ã¾ã—ã‚‡ã†ã€‚":t==="very_low"?"é›†ä¸­åŠ›ãŒä½ä¸‹ã—ã¦ã„ã¾ã™ã€‚ç’°å¢ƒã‚’æ•´ãˆã¦ã€çŸ­æ™‚é–“ã®é›†ä¸­ç·´ç¿’ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†ã€‚":t==="low"?"æ·±å‘¼å¸ã‚’ã—ã¦ã€ä¸€ã¤ä¸€ã¤ã®éŸ³ç¨‹ã«é›†ä¸­ã—ã¦ç·´ç¿’ã—ã¦ã¿ã¦ãã ã•ã„ã€‚":"è‰¯ã„çŠ¶æ…‹ã§ã™ã€‚ã“ã®èª¿å­ã§ç·´ç¿’ã‚’ç¶šã‘ã¦ãã ã•ã„ã€‚"}calculateIntervalTrend(e){if(e.length<6)return"stable";const t=e.slice(-3),n=e.slice(-6,-3),s=t.reduce((o,a)=>o+Math.abs(a.centsDiff),0)/t.length,i=n.reduce((o,a)=>o+Math.abs(a.centsDiff),0)/n.length-s;return i>5?"improving":i<-5?"declining":"stable"}updateSessionData(e){this.sessionData.overallConsistency=e.overallConsistency,this.sessionData.stabilityTrend=e.stabilityTrend.trend,this.sessionData.fatigueLevel=e.fatigueAnalysis.fatigueLevel,this.sessionData.concentrationLevel=e.fatigueAnalysis.concentrationLevel}createErrorResult(e){return{intervalType:e,intervalConsistency:{level:"error",score:0},overallConsistency:0,stabilityTrend:{trend:"error"},fatigueAnalysis:{fatigueLevel:"unknown"},recommendations:[],error:!0}}logConsistencyDetails(e){var t;console.group(`ğŸ“Š [ConsistencyTracker] ${e.intervalType}ä¸€è²«æ€§åˆ†æ`),console.log("ğŸ¯ éŸ³ç¨‹ä¸€è²«æ€§:",{ãƒ¬ãƒ™ãƒ«:e.intervalConsistency.level,ã‚¹ã‚³ã‚¢:`${e.intervalConsistency.score}%`,æ¨™æº–åå·®:`${((t=e.intervalConsistency.statistics)==null?void 0:t.standardDeviation)||0}ã‚»ãƒ³ãƒˆ`,è©¦è¡Œå›æ•°:e.intervalConsistency.attempts}),console.log("ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ:",{å…¨ä½“å‚¾å‘:e.stabilityTrend.trend,æ–¹å‘:e.stabilityTrend.direction,ä¿¡é ¼åº¦:`${(e.stabilityTrend.confidence*100).toFixed(0)}%`,æ”¹å–„åº¦:`${e.stabilityTrend.improvement}ã‚»ãƒ³ãƒˆ`}),console.log("ğŸ˜´ ç–²åŠ´åˆ†æ:",{ç–²åŠ´åº¦:e.fatigueAnalysis.fatigueLevel,é›†ä¸­åŠ›:e.fatigueAnalysis.concentrationLevel,ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“:`${e.fatigueAnalysis.sessionMinutes}åˆ†`,ç²¾åº¦ä½ä¸‹:`${e.fatigueAnalysis.accuracyDrop}%`}),e.recommendations.length>0&&console.log("ğŸ’¡ æ¨å¥¨äº‹é …:",e.recommendations.map(n=>n.message)),console.groupEnd()}log(e,t=null){this.debugMode&&(t?console.log(`[ConsistencyTracker] ${e}`,t):console.log(`[ConsistencyTracker] ${e}`))}getAllConsistencyData(){const e={};for(const[t,n]of this.consistencyData.entries())e[t]={statistics:n.statistics,trend:n.trend,attempts:n.attempts.length,lastUpdated:n.lastUpdated};return{intervalData:e,sessionData:this.sessionData,overallStats:{totalAttempts:this.sessionData.totalAttempts,overallConsistency:this.sessionData.overallConsistency,sessionDuration:Date.now()-this.sessionData.startTime}}}getStatistics(){return{totalIntervalTypes:this.consistencyData.size,totalAttempts:this.sessionData.totalAttempts,sessionDuration:Date.now()-this.sessionData.startTime,overallConsistency:this.sessionData.overallConsistency,stabilityTrend:this.sessionData.stabilityTrend,fatigueLevel:this.sessionData.fatigueLevel}}reset(){this.consistencyData.clear(),this.stabilityHistory=[],this.sessionData={startTime:Date.now(),totalAttempts:0,overallConsistency:0,stabilityTrend:"stable",fatigueLevel:"fresh",concentrationLevel:"high"},this.log("ğŸ”„ ConsistencyTracker ãƒªã‚»ãƒƒãƒˆå®Œäº†")}}typeof window<"u"&&(window.ConsistencyTracker=D);class S{constructor(e={}){var t,n,s,r,i,o,a,c,l,h,m;this.config={weights:{pitchAccuracy:((t=e.weights)==null?void 0:t.pitchAccuracy)||.4,recognitionSpeed:((n=e.weights)==null?void 0:n.recognitionSpeed)||.2,intervalMastery:((s=e.weights)==null?void 0:s.intervalMastery)||.2,directionAccuracy:((r=e.weights)==null?void 0:r.directionAccuracy)||.1,consistency:((i=e.weights)==null?void 0:i.consistency)||.1},speedThresholds:{excellent:((o=e.speedThresholds)==null?void 0:o.excellent)||1e3,good:((a=e.speedThresholds)==null?void 0:a.good)||2e3,fair:((c=e.speedThresholds)==null?void 0:c.fair)||3e3,poor:((l=e.speedThresholds)==null?void 0:l.poor)||5e3},harmonicCorrection:{enabled:((h=e.harmonicCorrection)==null?void 0:h.enabled)??!0,tolerance:((m=e.harmonicCorrection)==null?void 0:m.tolerance)||50},sessionTracking:e.sessionTracking??!0,maxHistorySize:e.maxHistorySize||100},this.intervalAnalyzer=new v,this.directionAnalyzer=new A,this.consistencyTracker=new D,this.sessionData={startTime:Date.now(),totalAttempts:0,overallScore:0,performanceHistory:[],currentLevel:"beginner",achievements:new Set,lastAnalysis:null},this.performanceMetrics={averageSpeed:0,accuracyTrend:"stable",strengthAreas:[],improvementAreas:[],sessionProgress:0},this.debugMode=!0,this.log("ğŸ¯ EnhancedScoringEngineåˆæœŸåŒ–å®Œäº†",{weights:this.config.weights,analyzers:["IntervalAnalyzer","DirectionAnalyzer","ConsistencyTracker"]})}async analyzePerformance(e){try{const{baseFreq:t,targetFreq:n,detectedFreq:s,responseTime:r,volume:i=50,harmonicCorrection:o=null}=e,a=this.validateInputs(e);if(!a.valid)return this.createErrorResult(a.error);const c=this.applyHarmonicCorrection(s,o),l=await Promise.all([this.intervalAnalyzer.analyzeInterval(t,n,c),this.directionAnalyzer.analyzeDirection(t,n,c),this.consistencyTracker.recordAttempt(this.getIntervalType(t,n),this.calculateCentsDifference(n,c),this.calculateRawAccuracy(n,c),r)]),[h,m,d]=l,u=this.analyzeRecognitionSpeed(r),y=this.calculateIntegratedScore({intervalAnalysis:h,directionAnalysis:m,consistencyAnalysis:d,speedAnalysis:u,volume:i}),f=this.evaluateOverallPerformance(y),M=this.generateAdaptiveFeedback({intervalAnalysis:h,directionAnalysis:m,consistencyAnalysis:d,speedAnalysis:u,performanceEvaluation:f}),b=this.updateSessionData(y,f),p={timestamp:Date.now(),sessionAttempt:this.sessionData.totalAttempts,analyses:{interval:h,direction:m,consistency:d,speed:u},score:y,performance:f,feedback:M,session:b,metadata:{baseFreq:t,targetFreq:n,detectedFreq:s,correctedFreq:c,responseTime:r,volume:i,harmonicCorrectionApplied:!!o}};return this.recordAnalysisResult(p),this.debugMode&&this.logScoringDetails(p),p}catch(t){return console.error("âŒ [EnhancedScoringEngine] æ¡ç‚¹ã‚¨ãƒ©ãƒ¼:",t),this.createErrorResult("æ¡ç‚¹å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ")}}validateInputs(e){const{baseFreq:t,targetFreq:n,detectedFreq:s,responseTime:r}=e;return!t||!n||!s?{valid:!1,error:"å¿…è¦ãªå‘¨æ³¢æ•°ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™"}:t<=0||n<=0||s<=0?{valid:!1,error:"å‘¨æ³¢æ•°ã¯æ­£ã®å€¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"}:r<0||r>3e4?{valid:!1,error:"åå¿œæ™‚é–“ãŒç¯„å›²å¤–ã§ã™"}:{valid:!0}}applyHarmonicCorrection(e,t){return!this.config.harmonicCorrection.enabled||!t?e:t.correctedFrequency&&Math.abs(t.correctedFrequency-e)<=this.config.harmonicCorrection.tolerance?(this.log("ğŸ”§ HarmonicCorrectioné©ç”¨",{original:e,corrected:t.correctedFrequency,correction:t.correction}),t.correctedFrequency):e}analyzeRecognitionSpeed(e){const{speedThresholds:t}=this.config;let n,s,r;return e<=t.excellent?(n="excellent",s=100,r="âš¡ ç´ æ—©ã„èªè­˜ã§ã™ï¼"):e<=t.good?(n="good",s=85,r="ğŸ‘ è‰¯ã„åå¿œé€Ÿåº¦ã§ã™ã€‚"):e<=t.fair?(n="fair",s=70,r="ğŸ“ˆ ã‚‚ã†å°‘ã—æ—©ãèªè­˜ã§ãã‚‹ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚"):e<=t.poor?(n="poor",s=50,r="ğŸŒ ã‚†ã£ãã‚Šã¨ç¢ºå®Ÿã«èªè­˜ã—ã¾ã—ã‚‡ã†ã€‚"):(n="very_poor",s=25,r="â° æ™‚é–“ã‚’ã‹ã‘ã™ãã¦ã„ã¾ã™ã€‚ç·´ç¿’ã‚’é‡ã­ã¾ã—ã‚‡ã†ã€‚"),{level:n,score:s,responseTime:e,feedback:r,comparison:this.compareToAverageSpeed(e)}}calculateIntegratedScore(e){const{weights:t}=this.config,{intervalAnalysis:n,directionAnalysis:s,consistencyAnalysis:r,speedAnalysis:i,volume:o}=e,a=n.accuracy||0,c=i.score||0,l=this.calculateMasteryScore(n.mastery),h=s.accuracy||0,m=r.overallConsistency||0,d=a*t.pitchAccuracy+c*t.recognitionSpeed+l*t.intervalMastery+h*t.directionAccuracy+m*t.consistency,u=this.calculateVolumeAdjustment(o),y=Math.min(100,d*u);return{total:Math.round(y*10)/10,components:{pitchAccuracy:Math.round(a*10)/10,recognitionSpeed:Math.round(c*10)/10,intervalMastery:Math.round(l*10)/10,directionAccuracy:Math.round(h*10)/10,consistency:Math.round(m*10)/10},weights:t,volumeAdjustment:Math.round(u*100)/100,grade:this.determineGrade(y)}}calculateMasteryScore(e){if(!e||e.attempts===0)return 0;const t=e.averageAccuracy||0,n=Math.min(20,e.attempts*2),s=e.trend==="improving"?10:0;return Math.min(100,t+n+s)}calculateVolumeAdjustment(e){return e<20?.8:e>80?.95:1}determineGrade(e){return e>=95?"S":e>=90?"A+":e>=85?"A":e>=80?"B+":e>=75?"B":e>=70?"C+":e>=65?"C":e>=60?"D+":e>=55?"D":"F"}evaluateOverallPerformance(e){const t=this.determinePerformanceLevel(e.total),n=this.identifyStrengths(e.components),s=this.identifyWeaknesses(e.components),r=this.calculateImprovement();return{level:t,score:e.total,grade:e.grade,strengths:n,weaknesses:s,improvement:r,recommendation:this.generatePerformanceRecommendation(t,n,s)}}determinePerformanceLevel(e){return e>=90?"excellent":e>=80?"good":e>=70?"average":e>=60?"below_average":"needs_improvement"}identifyStrengths(e){const t=[];return Object.entries(e).forEach(([n,s])=>{s>=85?t.push({area:n,score:s,level:"excellent"}):s>=75&&t.push({area:n,score:s,level:"good"})}),t.sort((n,s)=>s.score-n.score)}identifyWeaknesses(e){const t=[];return Object.entries(e).forEach(([n,s])=>{s<60&&t.push({area:n,score:s,severity:s<40?"high":"medium"})}),t.sort((n,s)=>n.score-s.score)}calculateImprovement(){const e=this.sessionData.performanceHistory;if(e.length<3)return{trend:"insufficient_data",change:0,description:"ãƒ‡ãƒ¼ã‚¿ä¸è¶³"};const t=e.slice(-3),n=e.slice(-6,-3);if(n.length===0)return{trend:"stable",change:0,description:"å®‰å®š"};const s=t.reduce((c,l)=>c+l,0)/t.length,r=n.reduce((c,l)=>c+l,0)/n.length,i=s-r;let o,a;return i>5?(o="improving",a="å‘ä¸Šä¸­"):i<-5?(o="declining",a="ä½ä¸‹ä¸­"):(o="stable",a="å®‰å®š"),{trend:o,change:Math.round(i*10)/10,description:a}}generateAdaptiveFeedback(e){const{intervalAnalysis:t,directionAnalysis:n,consistencyAnalysis:s,speedAnalysis:r,performanceEvaluation:i}=e;return{primary:this.getPrimaryFeedback(i),detailed:{interval:t.feedback||"éŸ³ç¨‹åˆ†æçµæœãªã—",direction:n.feedback||"æ–¹å‘æ€§åˆ†æçµæœãªã—",consistency:this.getConsistencyFeedback(s),speed:r.feedback||"é€Ÿåº¦åˆ†æçµæœãªã—"},recommendations:this.generateRecommendations(e),encouragement:this.generateEncouragement(i),nextSteps:this.suggestNextSteps(i)}}getPrimaryFeedback(e){const{level:t,grade:n,score:s}=e;return{excellent:`ğŸ¯ ç´ æ™´ã‚‰ã—ã„ï¼${n}è©•ä¾¡ï¼ˆ${s}ç‚¹ï¼‰ã§ã™ã€‚`,good:`ğŸ‘ è‰¯ã„çµæœã§ã™ï¼${n}è©•ä¾¡ï¼ˆ${s}ç‚¹ï¼‰ã€‚`,average:`ğŸ“ˆ å¹³å‡çš„ãªçµæœã§ã™ã€‚${n}è©•ä¾¡ï¼ˆ${s}ç‚¹ï¼‰ã€‚`,below_average:`ğŸ’ª ç·´ç¿’ã‚’ç¶šã‘ã¾ã—ã‚‡ã†ã€‚${n}è©•ä¾¡ï¼ˆ${s}ç‚¹ï¼‰ã€‚`,needs_improvement:`ğŸ“ åŸºç¤ã‹ã‚‰ç·´ç¿’ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚${n}è©•ä¾¡ï¼ˆ${s}ç‚¹ï¼‰ã€‚`}[t]||`çµæœ: ${n}è©•ä¾¡ï¼ˆ${s}ç‚¹ï¼‰`}getConsistencyFeedback(e){if(e.recommendations&&e.recommendations.length>0)return e.recommendations[0].message;const t=e.overallConsistency||0;return t>=80?"ğŸ¯ ä¸€è²«ã—ãŸç²¾åº¦ã‚’ä¿ã£ã¦ã„ã¾ã™ã€‚":t>=60?"ğŸ“Š ã¾ãšã¾ãšã®å®‰å®šæ€§ã§ã™ã€‚":"ğŸ“ˆ ä¸€è²«æ€§ã®æ”¹å–„ãŒå¿…è¦ã§ã™ã€‚"}generateRecommendations(e){const t=[];e.consistencyAnalysis.recommendations&&t.push(...e.consistencyAnalysis.recommendations);const{performanceEvaluation:n}=e;if(n.weaknesses.length>0){const s=n.weaknesses[0];t.push({type:"improvement",priority:"high",message:this.getImprovementSuggestion(s.area),icon:"ğŸ¯"})}return t}getImprovementSuggestion(e){return{pitchAccuracy:"éŸ³ç¨‹ã®ç²¾åº¦å‘ä¸Šã®ãŸã‚ã€ã‚†ã£ãã‚Šã¨æ­£ç¢ºã«æ­Œã†ç·´ç¿’ã‚’ã—ã¾ã—ã‚‡ã†ã€‚",recognitionSpeed:"åå¿œé€Ÿåº¦å‘ä¸Šã®ãŸã‚ã€èã„ãŸç¬é–“ã«æ­Œã†ç·´ç¿’ã‚’ã—ã¾ã—ã‚‡ã†ã€‚",intervalMastery:"è‹¦æ‰‹ãªéŸ³ç¨‹ã‚’é‡ç‚¹çš„ã«ç·´ç¿’ã—ã¾ã—ã‚‡ã†ã€‚",directionAccuracy:"ä¸Šè¡Œãƒ»ä¸‹è¡Œã®æ–¹å‘æ€§ã‚’æ„è­˜ã—ã¦ç·´ç¿’ã—ã¾ã—ã‚‡ã†ã€‚",consistency:"ä¸€å®šã®ç²¾åº¦ã‚’ä¿ã¤ãŸã‚ã€é›†ä¸­åŠ›ã‚’é«˜ã‚ã¦ç·´ç¿’ã—ã¾ã—ã‚‡ã†ã€‚"}[e]||"ç¶™ç¶šçš„ãªç·´ç¿’ã§æ”¹å–„ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚"}generateEncouragement(e){if(e.improvement.trend==="improving")return"ğŸ“ˆ ç¢ºå®Ÿã«ä¸Šé”ã—ã¦ã„ã¾ã™ï¼ã“ã®èª¿å­ã§ç¶šã‘ã¾ã—ã‚‡ã†ã€‚";if(e.strengths.length>0){const t=e.strengths[0];return`â­ ${this.getAreaName(t.area)}ãŒå¾—æ„ã§ã™ã­ï¼`}return"ğŸŒŸ ç·´ç¿’ã‚’ç¶šã‘ã‚‹ã“ã¨ã§å¿…ãšä¸Šé”ã—ã¾ã™ã€‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼"}suggestNextSteps(e){if(e.level==="excellent")return"ğŸ“ ä¸Šç´šãƒ¬ãƒ™ãƒ«ã«åˆ°é”ã—ã¦ã„ã¾ã™ã€‚ã‚ˆã‚Šè¤‡é›‘ãªéŸ³ç¨‹ã«æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚";if(e.weaknesses.length>0){const t=e.weaknesses[0];return`ğŸ¯ ${this.getAreaName(t.area)}ã®ç·´ç¿’ã«é‡ç‚¹ã‚’ç½®ãã¾ã—ã‚‡ã†ã€‚`}return"ğŸ“š åŸºç¤ç·´ç¿’ã‚’ç¶™ç¶šã—ã€å…¨ä½“çš„ãªãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ã€‚"}getAreaName(e){return{pitchAccuracy:"éŸ³ç¨‹ç²¾åº¦",recognitionSpeed:"èªè­˜é€Ÿåº¦",intervalMastery:"éŸ³ç¨‹ç¿’å¾—åº¦",directionAccuracy:"æ–¹å‘æ€§èªè­˜",consistency:"ä¸€è²«æ€§"}[e]||e}updateSessionData(e,t){return this.sessionData.totalAttempts++,this.sessionData.performanceHistory.push(e.total),this.sessionData.overallScore=this.calculateSessionAverage(),this.sessionData.currentLevel=t.level,this.sessionData.lastAnalysis=Date.now(),this.sessionData.performanceHistory.length>this.config.maxHistorySize&&this.sessionData.performanceHistory.shift(),this.updatePerformanceMetrics(e,t),this.checkAchievements(e,t),{attempt:this.sessionData.totalAttempts,sessionAverage:this.sessionData.overallScore,sessionDuration:Date.now()-this.sessionData.startTime,level:this.sessionData.currentLevel,newAchievements:Array.from(this.sessionData.achievements)}}calculateSessionAverage(){const e=this.sessionData.performanceHistory;return e.length===0?0:e.reduce((t,n)=>t+n,0)/e.length}updatePerformanceMetrics(e,t){e.components.recognitionSpeed>0&&(this.performanceMetrics.averageSpeed=(this.performanceMetrics.averageSpeed+e.components.recognitionSpeed)/2),this.performanceMetrics.accuracyTrend=t.improvement.trend,this.performanceMetrics.strengthAreas=t.strengths.map(n=>n.area),this.performanceMetrics.improvementAreas=t.weaknesses.map(n=>n.area),this.performanceMetrics.sessionProgress=Math.min(100,this.sessionData.totalAttempts/20*100)}checkAchievements(e,t){this.sessionData.totalAttempts===1&&this.sessionData.achievements.add("first_attempt"),e.total>=90&&!this.sessionData.achievements.has("high_score")&&this.sessionData.achievements.add("high_score"),e.total>=98&&!this.sessionData.achievements.has("perfect_score")&&this.sessionData.achievements.add("perfect_score"),this.sessionData.totalAttempts>=10&&!this.sessionData.achievements.has("persistent")&&this.sessionData.achievements.add("persistent"),t.improvement.trend==="improving"&&!this.sessionData.achievements.has("improving")&&this.sessionData.achievements.add("improving")}compareToAverageSpeed(e){const t=this.performanceMetrics.averageSpeed||2e3,n=e-t;return{sessionAverage:t,difference:n,comparison:n<-500?"much_faster":n<-200?"faster":n<200?"similar":n<500?"slower":"much_slower"}}getIntervalType(e,t){const s=(Math.round(12*Math.log2(t/e))%12+12)%12;return{0:"unison",1:"minorSecond",2:"majorSecond",3:"minorThird",4:"majorThird",5:"perfectFourth",6:"tritone",7:"perfectFifth",8:"minorSixth",9:"majorSixth",10:"minorSeventh",11:"majorSeventh"}[s]||"unknown"}calculateCentsDifference(e,t){return!e||!t?0:1200*Math.log2(t/e)}calculateRawAccuracy(e,t){const n=Math.abs(this.calculateCentsDifference(e,t));return Math.max(0,100-n)}recordAnalysisResult(e){this.sessionData.lastAnalysis=e}createErrorResult(e){return{timestamp:Date.now(),error:!0,message:e,score:{total:0,components:{pitchAccuracy:0,recognitionSpeed:0,intervalMastery:0,directionAccuracy:0,consistency:0},grade:"F"},performance:{level:"needs_improvement",strengths:[],weaknesses:[],improvement:{trend:"unknown",change:0}},feedback:{primary:"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",detailed:{},recommendations:[],encouragement:"",nextSteps:""}}}logScoringDetails(e){console.group(`ğŸ¯ [EnhancedScoringEngine] çµ±åˆæ¡ç‚¹çµæœ #${e.sessionAttempt}`),console.log("ğŸ“Š çµ±åˆã‚¹ã‚³ã‚¢:",{ç·åˆ:`${e.score.total}ç‚¹ (${e.score.grade})`,éŸ³ç¨‹ç²¾åº¦:`${e.score.components.pitchAccuracy}%`,èªè­˜é€Ÿåº¦:`${e.score.components.recognitionSpeed}%`,éŸ³ç¨‹ç¿’å¾—åº¦:`${e.score.components.intervalMastery}%`,æ–¹å‘æ€§ç²¾åº¦:`${e.score.components.directionAccuracy}%`,ä¸€è²«æ€§:`${e.score.components.consistency}%`}),console.log("ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹:",{ãƒ¬ãƒ™ãƒ«:e.performance.level,æ”¹å–„å‚¾å‘:e.performance.improvement.trend,å¼·ã¿:e.performance.strengths.map(t=>t.area),å¼±ç‚¹:e.performance.weaknesses.map(t=>t.area)}),console.log("ğŸ’¬ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯:",{ãƒ¡ã‚¤ãƒ³:e.feedback.primary,æ¨å¥¨äº‹é …:e.feedback.recommendations.length}),console.log("ğŸ“š ã‚»ãƒƒã‚·ãƒ§ãƒ³:",{è©¦è¡Œå›æ•°:e.session.attempt,å¹³å‡ç‚¹:e.session.sessionAverage.toFixed(1),ç¶™ç¶šæ™‚é–“:`${Math.round(e.session.sessionDuration/6e4)}åˆ†`}),console.groupEnd()}log(e,t=null){this.debugMode&&(t?console.log(`[EnhancedScoringEngine] ${e}`,t):console.log(`[EnhancedScoringEngine] ${e}`))}getStatistics(){return{session:this.sessionData,performance:this.performanceMetrics,analyzers:{interval:this.intervalAnalyzer.getStatistics(),direction:this.directionAnalyzer.getStatistics(),consistency:this.consistencyTracker.getStatistics()},config:this.config}}updateConfig(e){this.config={...this.config,...e},this.log("âš™ï¸ è¨­å®šæ›´æ–°å®Œäº†",this.config)}reset(){this.intervalAnalyzer.reset(),this.directionAnalyzer.reset(),this.consistencyTracker.reset(),this.sessionData={startTime:Date.now(),totalAttempts:0,overallScore:0,performanceHistory:[],currentLevel:"beginner",achievements:new Set,lastAnalysis:null},this.performanceMetrics={averageSpeed:0,accuracyTrend:"stable",strengthAreas:[],improvementAreas:[],sessionProgress:0},this.log("ğŸ”„ EnhancedScoringEngine ãƒªã‚»ãƒƒãƒˆå®Œäº†")}}typeof window<"u"&&(window.EnhancedScoringEngine=S);export{S as E};
