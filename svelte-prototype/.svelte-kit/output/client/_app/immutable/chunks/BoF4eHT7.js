var ee=Object.defineProperty;var se=(r,t,e)=>t in r?ee(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var Q=(r,t,e)=>se(r,typeof t!="symbol"?t+"":t,e);import{S as jt,i as Gt,s as Qt,d as Ct,n as Tt,a as Ut,D as xt,b as X,H as F,z as G,f as Kt,g as B,h as K,j as J,k as nt,m as wt,o as W,p as bt,G as ne,a0 as Vt,E as Nt,q as oe,r as re,u as ie,e as Bt,w as ae,l as Et,A as Rt,x as ce,t as kt,y as le}from"./Ci2ptbdh.js";import{g as ue}from"./D0QH3NT1.js";import"./CDirIs2-.js";function he(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function H(r){if(this.size=r|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=r<<1;for(var t=new Array(this.size*2),e=0;e<t.length;e+=2){const l=Math.PI*e/this.size;t[e]=Math.cos(l),t[e+1]=-Math.sin(l)}this.table=t;for(var n=0,s=1;this.size>s;s<<=1)n++;this._width=n%2===0?n-1:n,this._bitrev=new Array(1<<this._width);for(var o=0;o<this._bitrev.length;o++){this._bitrev[o]=0;for(var c=0;c<this._width;c+=2){var h=this._width-c-2;this._bitrev[o]|=(o>>>c&3)<<h}}this._out=null,this._data=null,this._inv=0}var me=H;H.prototype.fromComplexArray=function(t,e){for(var n=e||new Array(t.length>>>1),s=0;s<t.length;s+=2)n[s>>>1]=t[s];return n};H.prototype.createComplexArray=function(){const t=new Array(this._csize);for(var e=0;e<t.length;e++)t[e]=0;return t};H.prototype.toComplexArray=function(t,e){for(var n=e||this.createComplexArray(),s=0;s<n.length;s+=2)n[s]=t[s>>>1],n[s+1]=0;return n};H.prototype.completeSpectrum=function(t){for(var e=this._csize,n=e>>>1,s=2;s<n;s+=2)t[e-s]=t[s],t[e-s+1]=-t[s+1]};H.prototype.transform=function(t,e){if(t===e)throw new Error("Input and output buffers must be different");this._out=t,this._data=e,this._inv=0,this._transform4(),this._out=null,this._data=null};H.prototype.realTransform=function(t,e){if(t===e)throw new Error("Input and output buffers must be different");this._out=t,this._data=e,this._inv=0,this._realTransform4(),this._out=null,this._data=null};H.prototype.inverseTransform=function(t,e){if(t===e)throw new Error("Input and output buffers must be different");this._out=t,this._data=e,this._inv=1,this._transform4();for(var n=0;n<t.length;n++)t[n]/=this.size;this._out=null,this._data=null};H.prototype._transform4=function(){var t=this._out,e=this._csize,n=this._width,s=1<<n,o=e/s<<1,c,h,l=this._bitrev;if(o===4)for(c=0,h=0;c<e;c+=o,h++){const f=l[h];this._singleTransform2(c,f,s)}else for(c=0,h=0;c<e;c+=o,h++){const f=l[h];this._singleTransform4(c,f,s)}var a=this._inv?-1:1,m=this.table;for(s>>=2;s>=2;s>>=2){o=e/s<<1;var d=o>>>2;for(c=0;c<e;c+=o)for(var v=c+d,g=c,u=0;g<v;g+=2,u+=s){const f=g,w=f+d,y=w+d,A=y+d,p=t[f],x=t[f+1],C=t[w],_=t[w+1],b=t[y],D=t[y+1],M=t[A],E=t[A+1],P=p,U=x,q=m[u],R=a*m[u+1],I=C*q-_*R,z=C*R+_*q,ot=m[2*u],L=a*m[2*u+1],O=b*ot-D*L,$=b*L+D*ot,Y=m[3*u],tt=a*m[3*u+1],rt=M*Y-E*tt,it=M*tt+E*Y,at=P+O,et=U+$,Z=P-O,ut=U-$,i=I+rt,T=z+it,S=a*(I-rt),V=a*(z-it),N=at+i,st=et+T,ht=at-i,ct=et-T,vt=Z+V,yt=ut-S,lt=Z-V,dt=ut+S;t[f]=N,t[f+1]=st,t[w]=vt,t[w+1]=yt,t[y]=ht,t[y+1]=ct,t[A]=lt,t[A+1]=dt}}};H.prototype._singleTransform2=function(t,e,n){const s=this._out,o=this._data,c=o[e],h=o[e+1],l=o[e+n],a=o[e+n+1],m=c+l,d=h+a,v=c-l,g=h-a;s[t]=m,s[t+1]=d,s[t+2]=v,s[t+3]=g};H.prototype._singleTransform4=function(t,e,n){const s=this._out,o=this._data,c=this._inv?-1:1,h=n*2,l=n*3,a=o[e],m=o[e+1],d=o[e+n],v=o[e+n+1],g=o[e+h],u=o[e+h+1],f=o[e+l],w=o[e+l+1],y=a+g,A=m+u,p=a-g,x=m-u,C=d+f,_=v+w,b=c*(d-f),D=c*(v-w),M=y+C,E=A+_,P=p+D,U=x-b,q=y-C,R=A-_,I=p-D,z=x+b;s[t]=M,s[t+1]=E,s[t+2]=P,s[t+3]=U,s[t+4]=q,s[t+5]=R,s[t+6]=I,s[t+7]=z};H.prototype._realTransform4=function(){var t=this._out,e=this._csize,n=this._width,s=1<<n,o=e/s<<1,c,h,l=this._bitrev;if(o===4)for(c=0,h=0;c<e;c+=o,h++){const St=l[h];this._singleRealTransform2(c,St>>>1,s>>>1)}else for(c=0,h=0;c<e;c+=o,h++){const St=l[h];this._singleRealTransform4(c,St>>>1,s>>>1)}var a=this._inv?-1:1,m=this.table;for(s>>=2;s>=2;s>>=2){o=e/s<<1;var d=o>>>1,v=d>>>1,g=v>>>1;for(c=0;c<e;c+=o)for(var u=0,f=0;u<=g;u+=2,f+=s){var w=c+u,y=w+v,A=y+v,p=A+v,x=t[w],C=t[w+1],_=t[y],b=t[y+1],D=t[A],M=t[A+1],E=t[p],P=t[p+1],U=x,q=C,R=m[f],I=a*m[f+1],z=_*R-b*I,ot=_*I+b*R,L=m[2*f],O=a*m[2*f+1],$=D*L-M*O,Y=D*O+M*L,tt=m[3*f],rt=a*m[3*f+1],it=E*tt-P*rt,at=E*rt+P*tt,et=U+$,Z=q+Y,ut=U-$,i=q-Y,T=z+it,S=ot+at,V=a*(z-it),N=a*(ot-at),st=et+T,ht=Z+S,ct=ut+N,vt=i-V;if(t[w]=st,t[w+1]=ht,t[y]=ct,t[y+1]=vt,u===0){var yt=et-T,lt=Z-S;t[A]=yt,t[A+1]=lt;continue}if(u!==g){var dt=ut,Dt=-i,Mt=et,j=-Z,_t=-a*N,Xt=-a*V,Yt=-a*S,Zt=-a*T,Lt=dt+_t,Ot=Dt+Xt,$t=Mt+Zt,te=j-Yt,Ft=c+v-u,It=c+d-u;t[Ft]=Lt,t[Ft+1]=Ot,t[It]=$t,t[It+1]=te}}}};H.prototype._singleRealTransform2=function(t,e,n){const s=this._out,o=this._data,c=o[e],h=o[e+n],l=c+h,a=c-h;s[t]=l,s[t+1]=0,s[t+2]=a,s[t+3]=0};H.prototype._singleRealTransform4=function(t,e,n){const s=this._out,o=this._data,c=this._inv?-1:1,h=n*2,l=n*3,a=o[e],m=o[e+n],d=o[e+h],v=o[e+l],g=a+d,u=a-d,f=m+v,w=c*(m-v),y=g+f,A=u,p=-w,x=g-f,C=u,_=w;s[t]=y,s[t+1]=0,s[t+2]=A,s[t+3]=p,s[t+4]=x,s[t+5]=0,s[t+6]=C,s[t+7]=_};const de=he(me);class pt{constructor(t,e){Q(this,"_inputLength");Q(this,"_fft");Q(this,"_bufferSupplier");Q(this,"_paddedInputBuffer");Q(this,"_transformBuffer");Q(this,"_inverseBuffer");if(t<1)throw new Error("Input length must be at least one");this._inputLength=t,this._fft=new de(ve(2*t)),this._bufferSupplier=e,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(t){return new pt(t,e=>new Float32Array(e))}static forFloat64Array(t){return new pt(t,e=>new Float64Array(e))}static forNumberArray(t){return new pt(t,e=>Array(e))}get inputLength(){return this._inputLength}autocorrelate(t,e=this._bufferSupplier(t.length)){if(t.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${t.length}`);for(let s=0;s<t.length;s++)this._paddedInputBuffer[s]=t[s];for(let s=t.length;s<this._paddedInputBuffer.length;s++)this._paddedInputBuffer[s]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const n=this._transformBuffer;for(let s=0;s<n.length;s+=2)n[s]=n[s]*n[s]+n[s+1]*n[s+1],n[s+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let s=0;s<t.length;s++)e[s]=this._inverseBuffer[2*s];return e}}function fe(r){const t=[];let e=!1,n=-1/0,s=-1;for(let o=1;o<r.length-1;o++)r[o-1]<=0&&r[o]>0?(e=!0,s=o,n=r[o]):r[o-1]>0&&r[o]<=0?(e=!1,s!==-1&&t.push(s)):e&&r[o]>n&&(n=r[o],s=o);return t}function ge(r,t){const[e,n,s]=[r-1,r,r+1],[o,c,h]=[t[e],t[n],t[s]],l=o/2-c+h/2,a=-(o/2)*(n+s)+c*(e+s)-h/2*(e+n),m=o*n*s/2-c*e*s+h*e*n/2,d=-a/(2*l),v=l*d*d+a*d+m;return[d,v]}class gt{constructor(t,e){Q(this,"_autocorrelator");Q(this,"_nsdfBuffer");Q(this,"_clarityThreshold",.9);Q(this,"_minVolumeAbsolute",0);Q(this,"_maxInputAmplitude",1);this._autocorrelator=new pt(t,e),this._nsdfBuffer=e(t)}static forFloat32Array(t){return new gt(t,e=>new Float32Array(e))}static forFloat64Array(t){return new gt(t,e=>new Float64Array(e))}static forNumberArray(t){return new gt(t,e=>Array(e))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(t){if(!Number.isFinite(t)||t<=0||t>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=t}set minVolumeAbsolute(t){if(!Number.isFinite(t)||t<0||t>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=t}set minVolumeDecibels(t){if(!Number.isFinite(t)||t>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(t/10)}set maxInputAmplitude(t){if(!Number.isFinite(t)||t<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=t}findPitch(t,e){if(this._belowMinimumVolume(t))return[0,0];this._nsdf(t);const n=fe(this._nsdfBuffer);if(n.length===0)return[0,0];const s=Math.max(...n.map(l=>this._nsdfBuffer[l])),o=n.find(l=>this._nsdfBuffer[l]>=this._clarityThreshold*s),[c,h]=ge(o,this._nsdfBuffer);return[e/c,Math.min(h,1)]}_belowMinimumVolume(t){if(this._minVolumeAbsolute===0)return!1;let e=0;for(let n=0;n<t.length;n++)e+=t[n]**2;return Math.sqrt(e/t.length)<this._minVolumeAbsolute}_nsdf(t){this._autocorrelator.autocorrelate(t,this._nsdfBuffer);let e=2*this._nsdfBuffer[0],n;for(n=0;n<this._nsdfBuffer.length&&e>0;n++)this._nsdfBuffer[n]=2*this._nsdfBuffer[n]/e,e-=t[n]**2+t[t.length-n-1]**2;for(;n<this._nsdfBuffer.length;n++)this._nsdfBuffer[n]=0}}function ve(r){return r--,r|=r>>1,r|=r>>2,r|=r>>4,r|=r>>8,r|=r>>16,r++,r}const At="src/lib/components/VolumeBar.svelte";function Pt(r){let t,e,n,s,o,c;const h={c:function(){t=W("div"),e=W("div"),n=W("div"),s=bt(),o=W("div"),this.h()},l:function(a){t=J(a,"DIV",{class:!0});var m=nt(t);e=J(m,"DIV",{class:!0,style:!0});var d=nt(e);n=J(d,"DIV",{class:!0,style:!0}),nt(n).forEach(X),d.forEach(X),s=wt(m),o=J(m,"DIV",{class:!0,style:!0}),nt(o).forEach(X),m.forEach(X),this.h()},h:function(){G(n,"class","volume-bar-fill"),F(n,"position","absolute"),F(n,"top","0"),F(n,"left","0"),F(n,"height","100%"),K(n,At,51,4,1464),G(e,"class","volume-bar-bg"),F(e,"height",r[1]),F(e,"border-radius","9999px"),F(e,"background-color","#e2e8f0"),F(e,"position","relative"),F(e,"overflow","hidden"),K(e,At,50,2,1318),G(o,"class","threshold-indicator svelte-13z7ppf"),F(o,"position","absolute"),F(o,"top","0"),F(o,"left",r[0]+"%"),F(o,"width","2px"),F(o,"height",r[1]),F(o,"background-color","#64748b"),F(o,"border-radius","1px"),K(o,At,59,2,1643),G(t,"class",c="volume-bar-container "+r[2]+" svelte-13z7ppf"),K(t,At,49,0,1269)},m:function(a,m){Kt(a,t,m),B(t,e),B(e,n),r[5](n),B(t,s),B(t,o)},p:function(a,[m]){m&2&&F(e,"height",a[1]),m&1&&F(o,"left",a[0]+"%"),m&2&&F(o,"height",a[1]),m&4&&c!==(c="volume-bar-container "+a[2]+" svelte-13z7ppf")&&G(t,"class",c)},i:Tt,o:Tt,d:function(a){a&&X(t),r[5](null)}};return Ct("SvelteRegisterBlock",{block:h,id:Pt.name,type:"component",source:"",ctx:r}),h}function ye(r,t,e){let{$$slots:n={},$$scope:s}=t;Ut("VolumeBar",n,[]);let{volume:o=0}=t,{threshold:c=30}=t,{height:h="12px"}=t,{className:l=""}=t,a;function m(u){return u<c?`rgba(37, 99, 235, ${Math.max(.2,u/c*.8)})`:"#2563eb"}function d(u){if(a){const f=Math.max(0,Math.min(100,u)),w=m(f);e(3,a.style.width=`${f}%`,a),e(3,a.style.backgroundColor=w,a)}}xt(()=>{a&&(e(3,a.style.width="0%",a),e(3,a.style.backgroundColor="#2563eb",a),e(3,a.style.height=h,a),e(3,a.style.borderRadius="9999px",a),e(3,a.style.transition="width 0.2s ease-out, background-color 0.2s ease-out",a))});const v=["volume","threshold","height","className"];Object.keys(t).forEach(u=>{!~v.indexOf(u)&&u.slice(0,2)!=="$$"&&u!=="slot"&&console.warn(`<VolumeBar> was created with unknown prop '${u}'`)});function g(u){ne[u?"unshift":"push"](()=>{a=u,e(3,a)})}return r.$$set=u=>{"volume"in u&&e(4,o=u.volume),"threshold"in u&&e(0,c=u.threshold),"height"in u&&e(1,h=u.height),"className"in u&&e(2,l=u.className)},r.$capture_state=()=>({onMount:xt,volume:o,threshold:c,height:h,className:l,barElement:a,getVolumeColor:m,updateVolumeBar:d}),r.$inject_state=u=>{"volume"in u&&e(4,o=u.volume),"threshold"in u&&e(0,c=u.threshold),"height"in u&&e(1,h=u.height),"className"in u&&e(2,l=u.className),"barElement"in u&&e(3,a=u.barElement)},t&&"$$inject"in t&&r.$inject_state(t.$$inject),r.$$.update=()=>{r.$$.dirty&16&&d(o)},[c,h,l,a,o,g]}class Jt extends jt{constructor(t){super(t),Gt(this,t,ye,Pt,Qt,{volume:4,threshold:0,height:1,className:2}),Ct("SvelteRegisterComponent",{component:this,tagName:"VolumeBar",options:t,id:Pt.name})}get volume(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set volume(t){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get threshold(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set threshold(t){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get height(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set height(t){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new Error("<VolumeBar>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(t){throw new Error("<VolumeBar>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}class _e{constructor(){this.audioContext=null,this.mediaStream=null,this.sourceNode=null,this.analysers=new Map,this.filters=new Map,this.refCount=0,this.initPromise=null,this.isInitialized=!1,this.lastError=null}async initialize(){if(this.initPromise)return this.initPromise;if(this.isInitialized&&this.audioContext&&this.mediaStream)return this.refCount++,{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode};this.initPromise=this._doInitialize();try{const t=await this.initPromise;return this.initPromise=null,t}catch(t){throw this.initPromise=null,t}}async _doInitialize(){try{if(console.log("🎤 [AudioManager] 初期化開始"),this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),console.log("✅ [AudioManager] AudioContext作成完了")),this.audioContext.state==="suspended"&&(await this.audioContext.resume(),console.log("✅ [AudioManager] AudioContext再開完了")),this.mediaStream||(this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}}),console.log("✅ [AudioManager] MediaStream取得完了")),!this.sourceNode){this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),console.log("✅ [AudioManager] SourceNode作成完了");const t=this.mediaStream.getTracks();console.log("🎤 [AudioManager] MediaStream tracks:",t.map(e=>({kind:e.kind,label:e.label,enabled:e.enabled,readyState:e.readyState,muted:e.muted})))}return this.isInitialized=!0,this.refCount++,this.lastError=null,console.log(`🎤 [AudioManager] 初期化完了 (参照カウント: ${this.refCount})`),{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode}}catch(t){throw console.error("❌ [AudioManager] 初期化エラー:",t),this.lastError=t,this.isInitialized=!1,this._cleanup(),t}}createAnalyser(t,e={}){if(!this.isInitialized||!this.audioContext||!this.sourceNode)throw new Error("AudioManager not initialized. Call initialize() first.");this.removeAnalyser(t);const{fftSize:n=2048,smoothingTimeConstant:s=.8,minDecibels:o=-90,maxDecibels:c=-10,useFilters:h=!0}=e,l=this.audioContext.createAnalyser();if(l.fftSize=n,l.smoothingTimeConstant=s,l.minDecibels=o,l.maxDecibels=c,this.sourceNode,h){const a=this._createFilterChain();this.filters.set(t,a),this.sourceNode.connect(a.highpass),a.highpass.connect(a.lowpass),a.lowpass.connect(a.notch),a.notch.connect(l),console.log(`🔧 [AudioManager] フィルター付きAnalyser作成: ${t}`)}else this.sourceNode.connect(l),console.log(`🔧 [AudioManager] 生信号Analyser作成: ${t}`);return this.analysers.set(t,l),l}_createFilterChain(){const t=this.audioContext.createBiquadFilter();t.type="highpass",t.frequency.setValueAtTime(80,this.audioContext.currentTime),t.Q.setValueAtTime(.7,this.audioContext.currentTime);const e=this.audioContext.createBiquadFilter();e.type="lowpass",e.frequency.setValueAtTime(800,this.audioContext.currentTime),e.Q.setValueAtTime(.7,this.audioContext.currentTime);const n=this.audioContext.createBiquadFilter();return n.type="notch",n.frequency.setValueAtTime(60,this.audioContext.currentTime),n.Q.setValueAtTime(10,this.audioContext.currentTime),{highpass:t,lowpass:e,notch:n}}removeAnalyser(t){if(this.analysers.has(t)&&(this.analysers.get(t).disconnect(),this.analysers.delete(t),console.log(`🗑️ [AudioManager] Analyser削除: ${t}`)),this.filters.has(t)){const e=this.filters.get(t);e.highpass.disconnect(),e.lowpass.disconnect(),e.notch.disconnect(),this.filters.delete(t),console.log(`🗑️ [AudioManager] フィルターチェーン削除: ${t}`)}}release(t=[]){t.forEach(e=>this.removeAnalyser(e)),this.refCount=Math.max(0,this.refCount-1),console.log(`📉 [AudioManager] 参照カウント減算: ${this.refCount}`),this.refCount<=0&&(console.log("🧹 [AudioManager] 全リソースクリーンアップ開始"),this._cleanup())}forceCleanup(){console.log("🚨 [AudioManager] 強制クリーンアップ実行"),this._cleanup()}_cleanup(){for(const t of this.analysers.keys())this.removeAnalyser(t);this.mediaStream&&(this.mediaStream.getTracks().forEach(t=>{t.stop(),console.log("🛑 [AudioManager] MediaStreamTrack停止")}),this.mediaStream=null),this.audioContext&&this.audioContext.state!=="closed"&&(this.audioContext.close(),console.log("🛑 [AudioManager] AudioContext閉鎖"),this.audioContext=null),this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.isInitialized=!1,this.refCount=0,this.initPromise=null,console.log("✅ [AudioManager] クリーンアップ完了")}getStatus(){var t,e;return{isInitialized:this.isInitialized,refCount:this.refCount,audioContextState:((t=this.audioContext)==null?void 0:t.state)||"none",mediaStreamActive:((e=this.mediaStream)==null?void 0:e.active)||!1,activeAnalysers:Array.from(this.analysers.keys()),activeFilters:Array.from(this.filters.keys()),lastError:this.lastError}}checkMediaStreamHealth(){if(!this.mediaStream)return{healthy:!1,reason:"MediaStream not initialized"};const t=this.mediaStream.getTracks();if(t.length===0)return{healthy:!1,reason:"No tracks available"};const e=t.find(n=>n.kind==="audio");return e?e.readyState==="ended"?{healthy:!1,reason:"Audio track ended"}:e.enabled?{healthy:!0,track:e}:{healthy:!1,reason:"Audio track disabled"}:{healthy:!1,reason:"No audio track found"}}}const ft=new _e;typeof window<"u"&&(window.audioManager=ft);const{Error:k,console:we}=ue,mt="src/lib/components/PitchDetector.svelte";function zt(r){let t,e,n,s,o=(r[2]>0?Math.round(r[2]):"---")+"",c,h,l,a="Hz",m,d,v="|",g,u,f,w,y,A,p;y=new Jt({props:{volume:r[2]>0?r[1]:0,className:"volume-bar"},$$inline:!0});const x={c:function(){t=W("div"),e=W("div"),n=W("div"),s=W("span"),c=kt(o),h=bt(),l=W("span"),l.textContent=a,m=bt(),d=W("span"),d.textContent=v,g=bt(),u=W("span"),f=kt(r[3]),w=bt(),le(y.$$.fragment),this.h()},l:function(_){t=J(_,"DIV",{class:!0});var b=nt(t);e=J(b,"DIV",{class:!0});var D=nt(e);n=J(D,"DIV",{class:!0});var M=nt(n);s=J(M,"SPAN",{class:!0});var E=nt(s);c=Et(E,o),E.forEach(X),h=wt(M),l=J(M,"SPAN",{class:!0,"data-svelte-h":!0}),Rt(l)!=="svelte-5uyilv"&&(l.textContent=a),m=wt(M),d=J(M,"SPAN",{class:!0,"data-svelte-h":!0}),Rt(d)!=="svelte-1dytxz4"&&(d.textContent=v),g=wt(M),u=J(M,"SPAN",{class:!0});var P=nt(u);f=Et(P,r[3]),P.forEach(X),M.forEach(X),w=wt(D),ce(y.$$.fragment,D),D.forEach(X),b.forEach(X),this.h()},h:function(){G(s,"class","detected-frequency svelte-vc1bho"),K(s,mt,523,6,15131),G(l,"class","hz-suffix svelte-vc1bho"),K(l,mt,524,6,15239),G(d,"class","divider svelte-vc1bho"),K(d,mt,525,6,15279),G(u,"class","detected-note svelte-vc1bho"),K(u,mt,526,6,15316),G(n,"class","detection-card svelte-vc1bho"),K(n,mt,522,4,15096),G(e,"class","detection-display svelte-vc1bho"),K(e,mt,521,2,15060),G(t,"class",A="pitch-detector "+r[0]+" svelte-vc1bho"),K(t,mt,520,0,15017)},m:function(_,b){Kt(_,t,b),B(t,e),B(e,n),B(n,s),B(s,c),B(n,h),B(n,l),B(n,m),B(n,d),B(n,g),B(n,u),B(u,f),B(e,w),ae(y,e,null),p=!0},p:function(_,b){(!p||b[0]&4)&&o!==(o=(_[2]>0?Math.round(_[2]):"---")+"")&&Bt(c,o),(!p||b[0]&8)&&Bt(f,_[3]);const D={};b[0]&6&&(D.volume=_[2]>0?_[1]:0),y.$set(D),(!p||b[0]&1&&A!==(A="pitch-detector "+_[0]+" svelte-vc1bho"))&&G(t,"class",A)},i:function(_){p||(ie(y.$$.fragment,_),p=!0)},o:function(_){re(y.$$.fragment,_),p=!1},d:function(_){_&&X(t),oe(y)}};return Ct("SvelteRegisterBlock",{block:x,id:zt.name,type:"component",source:"",ctx:r}),x}function Wt(r){const e=Math.log2(r/261.63)*12,n=Math.round(e),s=Math.abs(e-n);return Math.max(0,1-s/.5)}function Ht(r,t){const e=[r,r/2,r/3,r/4,r*2],n=130.81,s=1046.5,o=l=>{const m=l>=n&&l<=s?1:0,d=t>0?1-Math.min(Math.abs(l-t)/t,1):.5,v=Wt(l),g=m*.4+d*.4+v*.2;return{freq:l,score:g}};return e.map(o).reduce((l,a)=>a.score>l.score?a:l).freq}function qt(r){const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(r<=0)return"ーー";const n=Math.round(12*Math.log2(r/440)),s=(n+9+120)%12,o=Math.floor((n+9)/12)+4;return t[s]+o}function be(r,t,e){let{$$slots:n={},$$scope:s}=t;Ut("PitchDetector",n,[]);const o=Vt();let{isActive:c=!1}=t,{className:h=""}=t,{debugMode:l=!1}=t,a="uninitialized",m=null,d=!1,v=null,g=null,u=null,f=null,w=null,y=null,A=null,p=!1,x=[],C=0,_=0,b=0,D="ーー",M=0,E=[],P=[],U=0,q=0,R=0,I=[],z=null;function ot(){C=0,e(1,_=0),e(2,b=0),e(3,D="ーー"),M=0,U=0,q=0,R=0,E=[],P=[],I=[],l&&console.log("🔄 [PitchDetector] Display state reset")}function L(){if(!l)return;const i=new Date().toLocaleTimeString(),T={timestamp:i,componentState:a,isActive:c,isDetecting:p,isInitialized:d,mediaStreamActive:g?g.active:null,mediaStreamTracks:g?g.getTracks().length:0,trackStates:g?g.getTracks().map(N=>({kind:N.kind,enabled:N.enabled,readyState:N.readyState,muted:N.muted})):[],audioContextState:v?v.state:null,hasAnalyser:!!f,currentVolume:C,currentFrequency:b};console.log(`🎤 [PitchDetector] ${i}:`,T);let S=!0,V=[];g&&!g.active&&(console.warn("⚠️ [PitchDetector] MediaStream is inactive!",g),S=!1,V.push("MediaStream inactive")),v&&v.state==="suspended"&&(console.warn("⚠️ [PitchDetector] AudioContext is suspended!",v),S=!1,V.push("AudioContext suspended")),g&&g.getTracks().forEach((N,st)=>{N.readyState==="ended"&&(console.error(`❌ [PitchDetector] Track ${st} has ended!`,N),S=!1,V.push(`Track ${st} ended`))}),o("microphoneHealthChange",{healthy:S,errors:V,details:T})}async function O(){try{e(14,a="initializing"),m=null,console.log("🎙️ [PitchDetector] AudioManager経由で初期化開始");const i=await ft.initialize();v=i.audioContext,g=i.mediaStream,u=i.sourceNode,console.log("✅ [PitchDetector] AudioManager リソース取得完了");const T=`pitch-detector-filtered-${Date.now()}`;e(15,f=ft.createAnalyser(T,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!0})),x.push(T);const S=`pitch-detector-raw-${Date.now()}`;w=ft.createAnalyser(S,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!1}),x.push(S),console.log("✅ [PitchDetector] Analyser作成完了:",x),y=gt.forFloat32Array(f.fftSize),e(14,a="ready"),d=!0,o("stateChange",{state:a}),console.log("✅ [PitchDetector] 初期化完了")}catch(i){throw console.error("❌ [PitchDetector] 初期化エラー:",i),e(14,a="error"),m=i,d=!1,o("error",{error:i,context:"initialization"}),i}}function $(){if(a!=="ready"){const i=new Error(`Cannot start detection: component state is ${a}`);return o("error",{error:i,context:"start-detection"}),!1}if(!f||!y||!v){const i=new Error("Required components not available");return e(14,a="error"),o("error",{error:i,context:"start-detection"}),!1}return e(14,a="detecting"),e(16,p=!0),o("stateChange",{state:a}),tt(),!0}function Y(){e(16,p=!1),A&&(cancelAnimationFrame(A),A=null),a==="detecting"&&d&&(e(14,a="ready"),o("stateChange",{state:a}))}function tt(){if(!p||!f||!w||!y)return;const i=f.fftSize,T=new Float32Array(i),S=new Float32Array(w.fftSize);f.getFloatTimeDomainData(T),w.getFloatTimeDomainData(S);let V=0;for(let j=0;j<i;j++)V+=Math.abs(T[j]);const N=Math.sqrt(V/i),st=Math.log10(N+.001)*50+100,ht=Math.max(0,Math.min(100,st));let ct=0;for(let j=0;j<S.length;j++)ct+=Math.abs(S[j]);const vt=Math.sqrt(ct/S.length),yt=Math.log10(vt+.001)*50+100;e(1,_=Math.max(0,Math.min(100,yt))),P.push(ht),P.length>5&&P.shift(),q=P.reduce((j,_t)=>j+_t,0)/P.length,C=q;const[lt,dt]=y.findPitch(T,v.sampleRate),Dt=lt>=65&&lt<=1200;if(lt&&dt>.6&&C>10&&Dt){const j=Ht(lt,R),_t=rt(j);e(2,b=Math.round(_t)),e(3,D=qt(b)),M=dt,R=b}else I.length>0&&(I=[]),b===0&&(R=0),e(2,b=0),e(3,D="ーー"),M=0;const Mt=b>0?_:0;o("pitchUpdate",{frequency:b,note:D,volume:C,rawVolume:Mt,clarity:M}),A=requestAnimationFrame(tt)}function rt(i,T=.1){I.push(i),I.length>5&&I.shift();const S=[...I].sort((ht,ct)=>ht-ct),V=S[Math.floor(S.length/2)],N=V*T;return Math.abs(i-V)>N?V+Math.sign(i-V)*N:i}function it(){return d&&a==="ready"}function at(){return{componentState:a,isInitialized:d,isDetecting:p,lastError:m,hasRequiredComponents:!!(f&&y&&v&&g)}}async function et(){console.log("🔄 [PitchDetector] 再初期化開始"),Z(),await new Promise(i=>setTimeout(i,100)),await O(),console.log("✅ [PitchDetector] 再初期化完了")}function Z(){console.log("🧹 [PitchDetector] クリーンアップ開始"),Y(),x.length>0&&(ft.release(x),console.log("📤 [PitchDetector] AudioManagerにAnalyser解放通知:",x),x=[]),e(14,a="uninitialized"),d=!1,m=null,v=null,g=null,u=null,e(15,f=null),w=null,y=null,E=[],P=[],I=[],console.log("✅ [PitchDetector] クリーンアップ完了")}Nt(()=>{z&&(clearInterval(z),e(17,z=null)),console.log("🔄 [PitchDetector] onDestroy - AudioManagerリソースは保持")});const ut=["isActive","className","debugMode"];return Object.keys(t).forEach(i=>{!~ut.indexOf(i)&&i.slice(0,2)!=="$$"&&i!=="slot"&&we.warn(`<PitchDetector> was created with unknown prop '${i}'`)}),r.$$set=i=>{"isActive"in i&&e(4,c=i.isActive),"className"in i&&e(0,h=i.className),"debugMode"in i&&e(5,l=i.debugMode)},r.$capture_state=()=>({onMount:xt,onDestroy:Nt,createEventDispatcher:Vt,PitchDetector:gt,VolumeBar:Jt,audioManager:ft,dispatch:o,isActive:c,className:h,debugMode:l,componentState:a,lastError:m,isInitialized:d,audioContext:v,mediaStream:g,sourceNode:u,analyser:f,rawAnalyser:w,pitchDetector:y,animationFrame:A,isDetecting:p,analyserIds:x,currentVolume:C,rawVolume:_,currentFrequency:b,detectedNote:D,pitchClarity:M,frequencyHistory:E,volumeHistory:P,stableFrequency:U,stableVolume:q,previousFrequency:R,harmonicHistory:I,debugInterval:z,resetDisplayState:ot,checkMicrophoneStatus:L,initialize:O,startDetection:$,stopDetection:Y,detectPitch:tt,calculateMusicalScore:Wt,correctHarmonicFrequency:Ht,stabilizeFrequency:rt,frequencyToNote:qt,getIsInitialized:it,getState:at,reinitialize:et,cleanup:Z}),r.$inject_state=i=>{"isActive"in i&&e(4,c=i.isActive),"className"in i&&e(0,h=i.className),"debugMode"in i&&e(5,l=i.debugMode),"componentState"in i&&e(14,a=i.componentState),"lastError"in i&&(m=i.lastError),"isInitialized"in i&&(d=i.isInitialized),"audioContext"in i&&(v=i.audioContext),"mediaStream"in i&&(g=i.mediaStream),"sourceNode"in i&&(u=i.sourceNode),"analyser"in i&&e(15,f=i.analyser),"rawAnalyser"in i&&(w=i.rawAnalyser),"pitchDetector"in i&&(y=i.pitchDetector),"animationFrame"in i&&(A=i.animationFrame),"isDetecting"in i&&e(16,p=i.isDetecting),"analyserIds"in i&&(x=i.analyserIds),"currentVolume"in i&&(C=i.currentVolume),"rawVolume"in i&&e(1,_=i.rawVolume),"currentFrequency"in i&&e(2,b=i.currentFrequency),"detectedNote"in i&&e(3,D=i.detectedNote),"pitchClarity"in i&&(M=i.pitchClarity),"frequencyHistory"in i&&(E=i.frequencyHistory),"volumeHistory"in i&&(P=i.volumeHistory),"stableFrequency"in i&&(U=i.stableFrequency),"stableVolume"in i&&(q=i.stableVolume),"previousFrequency"in i&&(R=i.previousFrequency),"harmonicHistory"in i&&(I=i.harmonicHistory),"debugInterval"in i&&e(17,z=i.debugInterval)},t&&"$$inject"in t&&r.$inject_state(t.$$inject),r.$$.update=()=>{r.$$.dirty[0]&131104&&(l&&!z?(console.log("🔍 [PitchDetector] Debug mode enabled - starting status monitoring"),e(17,z=setInterval(L,3e3)),L()):!l&&z&&(console.log("🔍 [PitchDetector] Debug mode disabled - stopping status monitoring"),clearInterval(z),e(17,z=null))),r.$$.dirty[0]&114704&&(c&&a==="ready"&&f&&!p?$():!c&&p&&Y())},[h,_,b,D,c,l,ot,O,$,Y,it,at,et,Z,a,f,p,z]}class Me extends jt{constructor(t){super(t),Gt(this,t,be,zt,Qt,{isActive:4,className:0,debugMode:5,resetDisplayState:6,initialize:7,startDetection:8,stopDetection:9,getIsInitialized:10,getState:11,reinitialize:12,cleanup:13},null,[-1,-1]),Ct("SvelteRegisterComponent",{component:this,tagName:"PitchDetector_1",options:t,id:zt.name})}get isActive(){throw new k("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set isActive(t){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get className(){throw new k("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set className(t){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get debugMode(){throw new k("<PitchDetector>: Props cannot be read directly from the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}set debugMode(t){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get resetDisplayState(){return this.$$.ctx[6]}set resetDisplayState(t){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get initialize(){return this.$$.ctx[7]}set initialize(t){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get startDetection(){return this.$$.ctx[8]}set startDetection(t){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get stopDetection(){return this.$$.ctx[9]}set stopDetection(t){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get getIsInitialized(){return this.$$.ctx[10]}set getIsInitialized(t){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get getState(){return this.$$.ctx[11]}set getState(t){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get reinitialize(){return this.$$.ctx[12]}set reinitialize(t){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}get cleanup(){return this.$$.ctx[13]}set cleanup(t){throw new k("<PitchDetector>: Props cannot be set directly on the component instance unless compiling with 'accessors: true' or '<svelte:options accessors/>'")}}export{Me as P,Jt as V,ft as a};
