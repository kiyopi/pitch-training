var Ze=Object.defineProperty;var Oe=(o,e,t)=>e in o?Ze(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var U=(o,e,t)=>Oe(o,typeof e!="symbol"?e+"":e,t);import{S as Ne,i as Pe,s as He,n as Ue,d as T,J as P,y as x,b as de,c as A,e as D,f as V,h as Z,j as z,k as O,I as $e,K as et,C as ke,m as Ve,o as Re,a as Me,D as Be,g as Ae,G as Ce,E as qe,t as we,F as Le,R as tt,M as st}from"./BbA4__VA.js";import"./IHki7fMi.js";import{C as rt}from"./_ty1ZC3A.js";function nt(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}function L(o){if(this.size=o|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=o<<1;for(var e=new Array(this.size*2),t=0;t<e.length;t+=2){const l=Math.PI*t/this.size;e[t]=Math.cos(l),e[t+1]=-Math.sin(l)}this.table=e;for(var r=0,s=1;this.size>s;s<<=1)r++;this._width=r%2===0?r-1:r,this._bitrev=new Array(1<<this._width);for(var n=0;n<this._bitrev.length;n++){this._bitrev[n]=0;for(var a=0;a<this._width;a+=2){var i=this._width-a-2;this._bitrev[n]|=(n>>>a&3)<<i}}this._out=null,this._data=null,this._inv=0}var ot=L;L.prototype.fromComplexArray=function(e,t){for(var r=t||new Array(e.length>>>1),s=0;s<e.length;s+=2)r[s>>>1]=e[s];return r};L.prototype.createComplexArray=function(){const e=new Array(this._csize);for(var t=0;t<e.length;t++)e[t]=0;return e};L.prototype.toComplexArray=function(e,t){for(var r=t||this.createComplexArray(),s=0;s<r.length;s+=2)r[s]=e[s>>>1],r[s+1]=0;return r};L.prototype.completeSpectrum=function(e){for(var t=this._csize,r=t>>>1,s=2;s<r;s+=2)e[t-s]=e[s],e[t-s+1]=-e[s+1]};L.prototype.transform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._transform4(),this._out=null,this._data=null};L.prototype.realTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=0,this._realTransform4(),this._out=null,this._data=null};L.prototype.inverseTransform=function(e,t){if(e===t)throw new Error("Input and output buffers must be different");this._out=e,this._data=t,this._inv=1,this._transform4();for(var r=0;r<e.length;r++)e[r]/=this.size;this._out=null,this._data=null};L.prototype._transform4=function(){var e=this._out,t=this._csize,r=this._width,s=1<<r,n=t/s<<1,a,i,l=this._bitrev;if(n===4)for(a=0,i=0;a<t;a+=n,i++){const d=l[i];this._singleTransform2(a,d,s)}else for(a=0,i=0;a<t;a+=n,i++){const d=l[i];this._singleTransform4(a,d,s)}var c=this._inv?-1:1,f=this.table;for(s>>=2;s>=2;s>>=2){n=t/s<<1;var h=n>>>2;for(a=0;a<t;a+=n)for(var m=a+h,v=a,u=0;v<m;v+=2,u+=s){const d=v,_=d+h,y=_+h,b=y+h,w=e[d],M=e[d+1],S=e[_],F=e[_+1],C=e[y],H=e[y+1],B=e[b],q=e[b+1],Q=w,k=M,K=f[u],J=c*f[u+1],$=S*K-F*J,X=S*J+F*K,te=f[2*u],se=c*f[2*u+1],Y=C*te-H*se,re=C*se+H*te,oe=f[3*u],ae=c*f[3*u+1],ie=B*oe-q*ae,ne=B*ae+q*oe,le=Q+Y,g=k+re,p=Q-Y,I=k-re,R=$+ie,N=X+ne,j=c*($-ie),ce=c*(X-ne),ue=le+R,me=g+N,ge=le-R,G=g-N,fe=p+ce,ve=I-j,ye=p-ce,E=I+j;e[d]=ue,e[d+1]=me,e[_]=fe,e[_+1]=ve,e[y]=ge,e[y+1]=G,e[b]=ye,e[b+1]=E}}};L.prototype._singleTransform2=function(e,t,r){const s=this._out,n=this._data,a=n[t],i=n[t+1],l=n[t+r],c=n[t+r+1],f=a+l,h=i+c,m=a-l,v=i-c;s[e]=f,s[e+1]=h,s[e+2]=m,s[e+3]=v};L.prototype._singleTransform4=function(e,t,r){const s=this._out,n=this._data,a=this._inv?-1:1,i=r*2,l=r*3,c=n[t],f=n[t+1],h=n[t+r],m=n[t+r+1],v=n[t+i],u=n[t+i+1],d=n[t+l],_=n[t+l+1],y=c+v,b=f+u,w=c-v,M=f-u,S=h+d,F=m+_,C=a*(h-d),H=a*(m-_),B=y+S,q=b+F,Q=w+H,k=M-C,K=y-S,J=b-F,$=w-H,X=M+C;s[e]=B,s[e+1]=q,s[e+2]=Q,s[e+3]=k,s[e+4]=K,s[e+5]=J,s[e+6]=$,s[e+7]=X};L.prototype._realTransform4=function(){var e=this._out,t=this._csize,r=this._width,s=1<<r,n=t/s<<1,a,i,l=this._bitrev;if(n===4)for(a=0,i=0;a<t;a+=n,i++){const Ie=l[i];this._singleRealTransform2(a,Ie>>>1,s>>>1)}else for(a=0,i=0;a<t;a+=n,i++){const Ie=l[i];this._singleRealTransform4(a,Ie>>>1,s>>>1)}var c=this._inv?-1:1,f=this.table;for(s>>=2;s>=2;s>>=2){n=t/s<<1;var h=n>>>1,m=h>>>1,v=m>>>1;for(a=0;a<t;a+=n)for(var u=0,d=0;u<=v;u+=2,d+=s){var _=a+u,y=_+m,b=y+m,w=b+m,M=e[_],S=e[_+1],F=e[y],C=e[y+1],H=e[b],B=e[b+1],q=e[w],Q=e[w+1],k=M,K=S,J=f[d],$=c*f[d+1],X=F*J-C*$,te=F*$+C*J,se=f[2*d],Y=c*f[2*d+1],re=H*se-B*Y,oe=H*Y+B*se,ae=f[3*d],ie=c*f[3*d+1],ne=q*ae-Q*ie,le=q*ie+Q*ae,g=k+re,p=K+oe,I=k-re,R=K-oe,N=X+ne,j=te+le,ce=c*(X-ne),ue=c*(te-le),me=g+N,ge=p+j,G=I+ue,fe=R-ce;if(e[_]=me,e[_+1]=ge,e[y]=G,e[y+1]=fe,u===0){var ve=g-N,ye=p-j;e[b]=ve,e[b+1]=ye;continue}if(u!==v){var E=I,W=-R,Fe=g,De=-p,ze=-c*ue,_e=-c*ce,Se=-c*j,Ke=-c*N,Je=E+ze,je=W+_e,Xe=Fe+Ke,Ye=De-Se,Ge=a+m-u,We=a+h-u;e[Ge]=Je,e[Ge+1]=je,e[We]=Xe,e[We+1]=Ye}}}};L.prototype._singleRealTransform2=function(e,t,r){const s=this._out,n=this._data,a=n[t],i=n[t+r],l=a+i,c=a-i;s[e]=l,s[e+1]=0,s[e+2]=c,s[e+3]=0};L.prototype._singleRealTransform4=function(e,t,r){const s=this._out,n=this._data,a=this._inv?-1:1,i=r*2,l=r*3,c=n[t],f=n[t+r],h=n[t+i],m=n[t+l],v=c+h,u=c-h,d=f+m,_=a*(f-m),y=v+d,b=u,w=-_,M=v-d,S=u,F=_;s[e]=y,s[e+1]=0,s[e+2]=b,s[e+3]=w,s[e+4]=M,s[e+5]=0,s[e+6]=S,s[e+7]=F};const at=nt(ot);class be{constructor(e,t){U(this,"_inputLength");U(this,"_fft");U(this,"_bufferSupplier");U(this,"_paddedInputBuffer");U(this,"_transformBuffer");U(this,"_inverseBuffer");if(e<1)throw new Error("Input length must be at least one");this._inputLength=e,this._fft=new at(ct(2*e)),this._bufferSupplier=t,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(e){return new be(e,t=>new Float32Array(t))}static forFloat64Array(e){return new be(e,t=>new Float64Array(t))}static forNumberArray(e){return new be(e,t=>Array(t))}get inputLength(){return this._inputLength}autocorrelate(e,t=this._bufferSupplier(e.length)){if(e.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${e.length}`);for(let s=0;s<e.length;s++)this._paddedInputBuffer[s]=e[s];for(let s=e.length;s<this._paddedInputBuffer.length;s++)this._paddedInputBuffer[s]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const r=this._transformBuffer;for(let s=0;s<r.length;s+=2)r[s]=r[s]*r[s]+r[s+1]*r[s+1],r[s+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let s=0;s<e.length;s++)t[s]=this._inverseBuffer[2*s];return t}}function it(o){const e=[];let t=!1,r=-1/0,s=-1;for(let n=1;n<o.length-1;n++)o[n-1]<=0&&o[n]>0?(t=!0,s=n,r=o[n]):o[n-1]>0&&o[n]<=0?(t=!1,s!==-1&&e.push(s)):t&&o[n]>r&&(r=o[n],s=n);return e}function lt(o,e){const[t,r,s]=[o-1,o,o+1],[n,a,i]=[e[t],e[r],e[s]],l=n/2-a+i/2,c=-(n/2)*(r+s)+a*(t+s)-i/2*(t+r),f=n*r*s/2-a*t*s+i*t*r/2,h=-c/(2*l),m=l*h*h+c*h+f;return[h,m]}class pe{constructor(e,t){U(this,"_autocorrelator");U(this,"_nsdfBuffer");U(this,"_clarityThreshold",.9);U(this,"_minVolumeAbsolute",0);U(this,"_maxInputAmplitude",1);this._autocorrelator=new be(e,t),this._nsdfBuffer=t(e)}static forFloat32Array(e){return new pe(e,t=>new Float32Array(t))}static forFloat64Array(e){return new pe(e,t=>new Float64Array(t))}static forNumberArray(e){return new pe(e,t=>Array(t))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(e){if(!Number.isFinite(e)||e<=0||e>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=e}set minVolumeAbsolute(e){if(!Number.isFinite(e)||e<0||e>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=e}set minVolumeDecibels(e){if(!Number.isFinite(e)||e>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(e/10)}set maxInputAmplitude(e){if(!Number.isFinite(e)||e<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=e}findPitch(e,t){if(this._belowMinimumVolume(e))return[0,0];this._nsdf(e);const r=it(this._nsdfBuffer);if(r.length===0)return[0,0];const s=Math.max(...r.map(l=>this._nsdfBuffer[l])),n=r.find(l=>this._nsdfBuffer[l]>=this._clarityThreshold*s),[a,i]=lt(n,this._nsdfBuffer);return[t/a,Math.min(i,1)]}_belowMinimumVolume(e){if(this._minVolumeAbsolute===0)return!1;let t=0;for(let r=0;r<e.length;r++)t+=e[r]**2;return Math.sqrt(t/e.length)<this._minVolumeAbsolute}_nsdf(e){this._autocorrelator.autocorrelate(e,this._nsdfBuffer);let t=2*this._nsdfBuffer[0],r;for(r=0;r<this._nsdfBuffer.length&&t>0;r++)this._nsdfBuffer[r]=2*this._nsdfBuffer[r]/t,t-=e[r]**2+e[e.length-r-1]**2;for(;r<this._nsdfBuffer.length;r++)this._nsdfBuffer[r]=0}}function ct(o){return o--,o|=o>>1,o|=o>>2,o|=o>>4,o|=o>>8,o|=o>>16,o++,o}function ut(o){let e,t,r,s,n,a;return{c(){e=z("div"),t=z("div"),r=z("div"),s=O(),n=z("div"),this.h()},l(i){e=D(i,"DIV",{class:!0});var l=V(e);t=D(l,"DIV",{class:!0,style:!0});var c=V(t);r=D(c,"DIV",{class:!0,style:!0}),V(r).forEach(T),c.forEach(T),s=Z(l),n=D(l,"DIV",{class:!0,style:!0}),V(n).forEach(T),l.forEach(T),this.h()},h(){x(r,"class","volume-bar-fill"),P(r,"position","absolute"),P(r,"top","0"),P(r,"left","0"),P(r,"height","100%"),x(t,"class","volume-bar-bg"),P(t,"height",o[1]),P(t,"border-radius","9999px"),P(t,"background-color","#e2e8f0"),P(t,"position","relative"),P(t,"overflow","hidden"),x(n,"class","threshold-indicator svelte-13z7ppf"),P(n,"position","absolute"),P(n,"top","0"),P(n,"left",o[0]+"%"),P(n,"width","2px"),P(n,"height",o[1]),P(n,"background-color","#64748b"),P(n,"border-radius","1px"),x(e,"class",a="volume-bar-container "+o[2]+" svelte-13z7ppf")},m(i,l){de(i,e,l),A(e,t),A(t,r),o[5](r),A(e,s),A(e,n)},p(i,[l]){l&2&&P(t,"height",i[1]),l&1&&P(n,"left",i[0]+"%"),l&2&&P(n,"height",i[1]),l&4&&a!==(a="volume-bar-container "+i[2]+" svelte-13z7ppf")&&x(e,"class",a)},i:Ue,o:Ue,d(i){i&&T(e),o[5](null)}}}function ht(o,e,t){let{volume:r=0}=e,{threshold:s=30}=e,{height:n="12px"}=e,{className:a=""}=e,i;function l(h){return h<s?`rgba(37, 99, 235, ${Math.max(.2,h/s*.8)})`:"#2563eb"}function c(h){if(i){const m=Math.max(0,Math.min(100,h)),v=l(m);t(3,i.style.width=`${m}%`,i),t(3,i.style.backgroundColor=v,i)}}$e(()=>{i&&(t(3,i.style.width="0%",i),t(3,i.style.backgroundColor="#2563eb",i),t(3,i.style.height=n,i),t(3,i.style.borderRadius="9999px",i),t(3,i.style.transition="width 0.2s ease-out, background-color 0.2s ease-out",i))});function f(h){et[h?"unshift":"push"](()=>{i=h,t(3,i)})}return o.$$set=h=>{"volume"in h&&t(4,r=h.volume),"threshold"in h&&t(0,s=h.threshold),"height"in h&&t(1,n=h.height),"className"in h&&t(2,a=h.className)},o.$$.update=()=>{o.$$.dirty&16&&c(r)},[s,n,a,i,r,f]}class Qe extends Ne{constructor(e){super(),Pe(this,e,ht,ut,He,{volume:4,threshold:0,height:1,className:2})}}class dt{constructor(){this.audioContext=null,this.mediaStream=null,this.sourceNode=null,this.analysers=new Map,this.filters=new Map,this.refCount=0,this.initPromise=null,this.isInitialized=!1,this.lastError=null}async initialize(){var e,t,r;if(this.initPromise)return this.initPromise;if(this.isInitialized&&this.audioContext&&this.mediaStream){const s=this.checkMediaStreamHealth();if(s.healthy)return this.refCount++,{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode};console.warn("⚠️ [AudioManager] MediaStream不健康検出 - 強制再初期化:",s.reason),console.log("🔄 [AudioManager] 不健康なMediaStream詳細:",{mediaStreamActive:(e=this.mediaStream)==null?void 0:e.active,trackCount:(t=this.mediaStream)==null?void 0:t.getTracks().length,trackStates:(r=this.mediaStream)==null?void 0:r.getTracks().map(n=>({kind:n.kind,readyState:n.readyState,enabled:n.enabled,muted:n.muted}))}),this._cleanup(),this.isInitialized=!1,this.refCount=0,await new Promise(n=>setTimeout(n,100)),console.log("🔄 [AudioManager] クリーンアップ完了 - 再初期化開始")}this.initPromise=this._doInitialize();try{const s=await this.initPromise;return this.initPromise=null,s}catch(s){throw this.initPromise=null,s}}async _doInitialize(){try{if(console.log("🎤 [AudioManager] 初期化開始"),this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),console.log("✅ [AudioManager] AudioContext作成完了")),this.audioContext.state==="suspended"&&(await this.audioContext.resume(),console.log("✅ [AudioManager] AudioContext再開完了")),!this.mediaStream){const e={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,sampleRate:44100,channelCount:1,sampleSize:16,latency:.1,volume:1,deviceId:{ideal:"default"}}};console.log("🎤 [AudioManager] Safari対応設定でMediaStream取得中:",e),this.mediaStream=await navigator.mediaDevices.getUserMedia(e),console.log("✅ [AudioManager] MediaStream取得完了")}if(!this.sourceNode){this.sourceNode=this.audioContext.createMediaStreamSource(this.mediaStream),console.log("✅ [AudioManager] SourceNode作成完了");const e=this.mediaStream.getTracks();console.log("🎤 [AudioManager] MediaStream tracks:",e.map(t=>({kind:t.kind,label:t.label,enabled:t.enabled,readyState:t.readyState,muted:t.muted})))}return this.isInitialized=!0,this.refCount++,this.lastError=null,console.log(`🎤 [AudioManager] 初期化完了 (参照カウント: ${this.refCount})`),{audioContext:this.audioContext,mediaStream:this.mediaStream,sourceNode:this.sourceNode}}catch(e){throw console.error("❌ [AudioManager] 初期化エラー:",e),this.lastError=e,this.isInitialized=!1,this._cleanup(),e}}createAnalyser(e,t={}){if(!this.isInitialized||!this.audioContext||!this.sourceNode)throw new Error("AudioManager not initialized. Call initialize() first.");this.removeAnalyser(e);const{fftSize:r=2048,smoothingTimeConstant:s=.8,minDecibels:n=-90,maxDecibels:a=-10,useFilters:i=!0}=t,l=this.audioContext.createAnalyser();if(l.fftSize=Math.min(r,2048),l.smoothingTimeConstant=Math.max(s,.7),l.minDecibels=Math.max(n,-80),l.maxDecibels=Math.min(a,-10),this.sourceNode,i){const c=this._createFilterChain();this.filters.set(e,c),this.sourceNode.connect(c.highpass),c.highpass.connect(c.lowpass),c.lowpass.connect(c.notch),c.notch.connect(l),console.log(`🔧 [AudioManager] フィルター付きAnalyser作成: ${e}`)}else this.sourceNode.connect(l),console.log(`🔧 [AudioManager] 生信号Analyser作成: ${e}`);return this.analysers.set(e,l),l}_createFilterChain(){const e=this.audioContext.createBiquadFilter();e.type="highpass",e.frequency.setValueAtTime(80,this.audioContext.currentTime),e.Q.setValueAtTime(.7,this.audioContext.currentTime);const t=this.audioContext.createBiquadFilter();t.type="lowpass",t.frequency.setValueAtTime(800,this.audioContext.currentTime),t.Q.setValueAtTime(.7,this.audioContext.currentTime);const r=this.audioContext.createBiquadFilter();return r.type="notch",r.frequency.setValueAtTime(60,this.audioContext.currentTime),r.Q.setValueAtTime(10,this.audioContext.currentTime),{highpass:e,lowpass:t,notch:r}}removeAnalyser(e){if(this.analysers.has(e)&&(this.analysers.get(e).disconnect(),this.analysers.delete(e),console.log(`🗑️ [AudioManager] Analyser削除: ${e}`)),this.filters.has(e)){const t=this.filters.get(e);t.highpass.disconnect(),t.lowpass.disconnect(),t.notch.disconnect(),this.filters.delete(e),console.log(`🗑️ [AudioManager] フィルターチェーン削除: ${e}`)}}release(e=[]){e.forEach(t=>this.removeAnalyser(t)),this.refCount=Math.max(0,this.refCount-1),console.log(`📉 [AudioManager] 参照カウント減算: ${this.refCount}`),this.refCount<=0&&(console.log("🧹 [AudioManager] 全リソースクリーンアップ開始"),this._cleanup())}forceCleanup(){console.log("🚨 [AudioManager] 強制クリーンアップ実行"),this._cleanup()}_cleanup(){console.log("🧹 [AudioManager] クリーンアップ開始");for(const e of this.analysers.keys())this.removeAnalyser(e);if(this.mediaStream){const e=this.mediaStream.getTracks();console.log(`🛑 [AudioManager] MediaStream停止中: ${e.length} tracks`),e.forEach((t,r)=>{try{t.readyState!=="ended"?(t.stop(),console.log(`🛑 [AudioManager] Track ${r} 停止完了`)):console.log(`⚠️ [AudioManager] Track ${r} 既に終了済み`)}catch(s){console.warn(`⚠️ [AudioManager] Track ${r} 停止エラー:`,s)}}),this.mediaStream=null}if(this.audioContext&&this.audioContext.state!=="closed"){try{this.audioContext.close(),console.log("🛑 [AudioManager] AudioContext閉鎖完了")}catch(e){console.warn("⚠️ [AudioManager] AudioContext閉鎖エラー:",e)}this.audioContext=null}this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=null),this.isInitialized=!1,this.refCount=0,this.initPromise=null,console.log("✅ [AudioManager] クリーンアップ完了")}getStatus(){var e,t;return{isInitialized:this.isInitialized,refCount:this.refCount,audioContextState:((e=this.audioContext)==null?void 0:e.state)||"none",mediaStreamActive:((t=this.mediaStream)==null?void 0:t.active)||!1,activeAnalysers:Array.from(this.analysers.keys()),activeFilters:Array.from(this.filters.keys()),lastError:this.lastError}}checkMediaStreamHealth(){if(!this.mediaStream)return{healthy:!1,reason:"MediaStream not initialized"};if(!this.mediaStream.active)return{healthy:!1,reason:"MediaStream inactive"};const e=this.mediaStream.getTracks();if(e.length===0)return{healthy:!1,reason:"No tracks available"};const t=e.find(r=>r.kind==="audio");return t?t.readyState==="ended"?{healthy:!1,reason:"Audio track ended"}:t.enabled?t.muted?{healthy:!1,reason:"Audio track muted"}:this.mediaStream.active&&t.readyState!=="live"?{healthy:!1,reason:"Track state inconsistent with MediaStream"}:{healthy:!0,track:t}:{healthy:!1,reason:"Audio track disabled"}:{healthy:!1,reason:"No audio track found"}}}const xe=new dt;class ft{constructor(e={}){this.vocalRangeMin=e.vocalRangeMin||130.81,this.vocalRangeMax=e.vocalRangeMax||1046.5,this.stabilityThreshold=e.stabilityThreshold||.1,this.evaluationWeights={vocalRange:e.vocalRangeWeight||.4,continuity:e.continuityWeight||.4,musical:e.musicalWeight||.2},this.fundamentalCandidates=e.fundamentalCandidates||[1,.5,.333,.25,2],this.harmonicHistory=[],this.previousFrequency=0,this.maxHistoryLength=5,this.debugMode=!1,this.currentContext={}}correctHarmonic(e,t=!1){if(!e||e<=0)return 0;const s=this.fundamentalCandidates.map(i=>({frequency:e*i,ratio:i})).map(i=>{const l=this.evaluateFundamental(i.frequency);return{...i,...l}}),n=s.reduce((i,l)=>l.totalScore>i.totalScore?l:i),a=this.stabilizeFrequency(n.frequency);return(t||this.debugMode)&&this.logHarmonicCorrection(e,s,n,a,this.currentContext),this.previousFrequency=a,a}logHarmonicCorrection(e,t,r,s,n={}){console.group(`🔧 [HarmonicCorrection] ${e.toFixed(1)}Hz → ${s.toFixed(1)}Hz`);const a=this.frequencyToNote(e),i=this.frequencyToNote(s);console.log(`📝 音程変換: ${a} → ${i}`);const l=this.getCorrectionType(r.ratio);if(console.log(`🎯 補正タイプ: ${l}`),n.baseFrequency&&n.currentScale&&n.targetFrequency){console.log("🎵 音階コンテキスト:"),console.log(`   基音: ${n.baseFrequency.toFixed(1)}Hz (${this.frequencyToNote(n.baseFrequency)})`),console.log(`   現在の音階: ${n.currentScale}`),console.log(`   目標周波数: ${n.targetFrequency.toFixed(1)}Hz (${this.frequencyToNote(n.targetFrequency)})`);const f=s-n.targetFrequency,h=1200*Math.log2(s/n.targetFrequency);console.log(`   目標との差: ${f>0?"+":""}${f.toFixed(1)}Hz (${h>0?"+":""}${h.toFixed(0)}セント)`);const m=Math.abs(h)<=50?"🎯 高精度":Math.abs(h)<=100?"✅ 良好":Math.abs(h)<=200?"⚠️ 要改善":"❌ 不正確";console.log(`   精度評価: ${m} (${Math.abs(h).toFixed(0)}セント差)`)}console.table(t.map(f=>({倍率:`${f.ratio.toFixed(3)}x`,周波数:`${f.frequency.toFixed(1)}Hz`,音名:this.frequencyToNote(f.frequency),音域:f.vocalRangeScore.toFixed(2),連続性:f.continuityScore.toFixed(2),音楽性:f.musicalScore.toFixed(2),総合:f.totalScore.toFixed(3),選択:f===r?"✅":""})));const c=Math.abs(s-r.frequency);c>.5&&console.log(`🔄 安定化: ${r.frequency.toFixed(1)}Hz → ${s.toFixed(1)}Hz (${c.toFixed(1)}Hz調整)`),console.groupEnd()}getCorrectionType(e){return Math.abs(e-1)<.01?"補正なし（基音）":Math.abs(e-.5)<.01?"2倍音補正（1オクターブ下）":Math.abs(e-.333)<.01?"3倍音補正（1オクターブ+5度下）":Math.abs(e-.25)<.01?"4倍音補正（2オクターブ下）":Math.abs(e-2)<.01?"オクターブ上補正":`カスタム補正（${e.toFixed(3)}x）`}frequencyToNote(e){if(!e||e<=0)return"---";const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],s=Math.round(12*Math.log2(e/440)),n=(s+9+120)%12,a=Math.floor((s+9)/12)+4;return t[n]+a}evaluateFundamental(e){const r=e>=this.vocalRangeMin&&e<=this.vocalRangeMax?1:0,s=this.previousFrequency>0?1-Math.min(Math.abs(e-this.previousFrequency)/this.previousFrequency,1):.5,n=this.calculateMusicalScore(e),a=r*this.evaluationWeights.vocalRange+s*this.evaluationWeights.continuity+n*this.evaluationWeights.musical;return{vocalRangeScore:r,continuityScore:s,musicalScore:n,totalScore:a}}calculateMusicalScore(e){const r=Math.log2(e/261.63)*12,s=Math.round(r),n=Math.abs(r-s);return Math.max(0,1-n/.5)}stabilizeFrequency(e){if(!e||e<=0)return 0;if(this.harmonicHistory.push(e),this.harmonicHistory.length>this.maxHistoryLength&&this.harmonicHistory.shift(),this.harmonicHistory.length<2)return e;const t=[...this.harmonicHistory].sort((a,i)=>a-i),r=t[Math.floor(t.length/2)],s=r*this.stabilityThreshold;return Math.abs(e-r)>s?r+Math.sign(e-r)*s:e}resetHistory(){this.harmonicHistory=[],this.previousFrequency=0}updateConfig(e){Object.assign(this,e),console.log("⚙️ [HarmonicCorrection] 設定更新:",e)}enableDebugLogging(){this.debugMode=!0,console.log("🔍 [HarmonicCorrection] デバッグログ有効化 - 次回の補正から詳細ログを出力します"),console.log("無効化するには: harmonicCorrection.disableDebugLogging()")}disableDebugLogging(){this.debugMode=!1,console.log("🔍 [HarmonicCorrection] デバッグログ無効化")}setScaleContext(e){this.currentContext={baseFrequency:e.baseFrequency,currentScale:e.currentScale,targetFrequency:e.targetFrequency}}clearContext(){this.currentContext={}}getStatus(){return{vocalRangeMin:this.vocalRangeMin,vocalRangeMax:this.vocalRangeMax,stabilityThreshold:this.stabilityThreshold,evaluationWeights:this.evaluationWeights,historyLength:this.harmonicHistory.length,previousFrequency:this.previousFrequency,recentHistory:this.harmonicHistory.slice(-3)}}}const Te=new ft,mt=(()=>{if(typeof import.meta<"u")return"error";if(typeof window<"u"){const e=new URLSearchParams(window.location.search).get("debug");if(e)return e}return"info"})(),ee={error:0,warn:1,info:2,debug:3},he=ee[mt]??ee.info,gt={error:(o,...e)=>{he>=ee.error&&console.error(`❌ ${o}`,...e)},warn:(o,...e)=>{he>=ee.warn&&console.warn(`⚠️ ${o}`,...e)},info:(o,...e)=>{he>=ee.info&&console.log(`ℹ️ ${o}`,...e)},debug:(o,...e)=>{he>=ee.debug&&console.log(`🔍 ${o}`,...e)},realtime:(()=>{let o=0;const e=1e3;return(t,...r)=>{if(he>=ee.debug){const s=Date.now();s-o>=e&&(console.log(`📊 ${t}`,...r),o=s)}}})(),scoring:(o,...e)=>{he>=ee.info&&console.log(`🎯 ${o}`,...e)},audio:(o,...e)=>{he>=ee.info&&console.log(`🎤 ${o}`,...e)}};function vt(o){let e,t,r,s,n=(o[2]>0?Math.round(o[2]):"---")+"",a,i,l,c="Hz",f,h,m="|",v,u,d,_,y,b,w;return y=new Qe({props:{volume:o[2]>0?o[1]:0,className:"volume-bar"}}),{c(){e=z("div"),t=z("div"),r=z("div"),s=z("span"),a=we(n),i=O(),l=z("span"),l.textContent=c,f=O(),h=z("span"),h.textContent=m,v=O(),u=z("span"),d=we(o[3]),_=O(),Le(y.$$.fragment),this.h()},l(M){e=D(M,"DIV",{class:!0});var S=V(e);t=D(S,"DIV",{class:!0});var F=V(t);r=D(F,"DIV",{class:!0});var C=V(r);s=D(C,"SPAN",{class:!0});var H=V(s);a=Ae(H,n),H.forEach(T),i=Z(C),l=D(C,"SPAN",{class:!0,"data-svelte-h":!0}),Ce(l)!=="svelte-5uyilv"&&(l.textContent=c),f=Z(C),h=D(C,"SPAN",{class:!0,"data-svelte-h":!0}),Ce(h)!=="svelte-1dytxz4"&&(h.textContent=m),v=Z(C),u=D(C,"SPAN",{class:!0});var B=V(u);d=Ae(B,o[3]),B.forEach(T),C.forEach(T),_=Z(F),qe(y.$$.fragment,F),F.forEach(T),S.forEach(T),this.h()},h(){x(s,"class","detected-frequency svelte-vc1bho"),x(l,"class","hz-suffix svelte-vc1bho"),x(h,"class","divider svelte-vc1bho"),x(u,"class","detected-note svelte-vc1bho"),x(r,"class","detection-card svelte-vc1bho"),x(t,"class","detection-display svelte-vc1bho"),x(e,"class",b="pitch-detector "+o[0]+" svelte-vc1bho")},m(M,S){de(M,e,S),A(e,t),A(t,r),A(r,s),A(s,a),A(r,i),A(r,l),A(r,f),A(r,h),A(r,v),A(r,u),A(u,d),A(t,_),Be(y,t,null),w=!0},p(M,S){(!w||S[0]&4)&&n!==(n=(M[2]>0?Math.round(M[2]):"---")+"")&&Me(a,n),(!w||S[0]&8)&&Me(d,M[3]);const F={};S[0]&6&&(F.volume=M[2]>0?M[1]:0),y.$set(F),(!w||S[0]&1&&b!==(b="pitch-detector "+M[0]+" svelte-vc1bho"))&&x(e,"class",b)},i(M){w||(Re(y.$$.fragment,M),w=!0)},o(M){Ve(y.$$.fragment,M),w=!1},d(M){M&&T(e),ke(y)}}}function Ee(o){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(o<=0)return"ーー";const r=Math.round(12*Math.log2(o/440)),s=(r+9+120)%12,n=Math.floor((r+9)/12)+4;return e[s]+n}function yt(o,e,t){const r=tt();let{isActive:s=!1}=e,{className:n=""}=e,{debugMode:a=!1}=e,{trainingPhase:i=""}=e,l="uninitialized",c=null,f=!1,h=null,m=null,v=null,u=null,d=null,_=null,y=null,b=!1,w=[],M=new Map,S=0,F=0,C=0,H="ーー",B=0,q=[],Q=0,k=null,K="",J=0;function $(){S=0,t(1,F=0),t(2,C=0),t(3,H="ーー"),B=0,Q=0,q=[],Te.resetHistory(),K="",J=0,a&&console.log("🔄 [PitchDetector] Display state reset")}function X(){if(!a)return;const g=new Date().toLocaleTimeString(),p={timestamp:g,componentState:l,isActive:s,isDetecting:b,isInitialized:f,mediaStreamActive:m?m.active:null,mediaStreamTracks:m?m.getTracks().length:0,trackStates:m?m.getTracks().map(N=>({kind:N.kind,enabled:N.enabled,readyState:N.readyState,muted:N.muted})):[],audioContextState:h?h.state:null,hasAnalyser:!!u,currentVolume:S,currentFrequency:C};gt.realtime(`[PitchDetector] ${g}:`,p);let I=!0,R=[];m&&!m.active&&(console.warn("⚠️ [PitchDetector] MediaStream is inactive!",m),I=!1,R.push("MediaStream inactive")),h&&h.state==="suspended"&&(console.warn("⚠️ [PitchDetector] AudioContext is suspended!",h),I=!1,R.push("AudioContext suspended")),m&&m.getTracks().forEach((N,j)=>{N.readyState==="ended"&&(console.error(`❌ [PitchDetector] Track ${j} has ended!`,N),I=!1,R.push(`Track ${j} ended`))}),r("microphoneHealthChange",{healthy:I,errors:R,details:p})}async function te(){try{t(15,l="initializing"),c=null,console.log("🎙️ [PitchDetector] AudioManager経由で初期化開始");const g=await xe.initialize();h=g.audioContext,m=g.mediaStream,v=g.sourceNode,console.log("✅ [PitchDetector] AudioManager リソース取得完了");const p=`pitch-detector-filtered-${Date.now()}`;t(16,u=xe.createAnalyser(p,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!0})),w.push(p);const I=`pitch-detector-raw-${Date.now()}`;d=xe.createAnalyser(I,{fftSize:2048,smoothingTimeConstant:.8,minDecibels:-90,maxDecibels:-10,useFilters:!1}),w.push(I),console.log("✅ [PitchDetector] Analyser作成完了:",w),_=pe.forFloat32Array(u.fftSize),t(15,l="ready"),f=!0,r("stateChange",{state:l}),le(),console.log("✅ [PitchDetector] 初期化完了")}catch(g){throw console.error("❌ [PitchDetector] 初期化エラー:",g),t(15,l="error"),c=g,f=!1,r("error",{error:g,context:"initialization"}),g}}function se(){if(l!=="ready"){const g=new Error(`Cannot start detection: component state is ${l}`);return r("error",{error:g,context:"start-detection"}),!1}if(!u||!_||!h){const g=new Error("Required components not available");return t(15,l="error"),r("error",{error:g,context:"start-detection"}),!1}return t(15,l="detecting"),t(17,b=!0),r("stateChange",{state:l}),re(),!0}function Y(){t(17,b=!1),y&&(cancelAnimationFrame(y),y=null),l==="detecting"&&f&&(t(15,l="ready"),r("stateChange",{state:l}))}function re(){if(!b||!u||!d||!_)return;const g=u.fftSize,p=new Float32Array(g),I=new Float32Array(d.fftSize);u.getFloatTimeDomainData(p),d.getFloatTimeDomainData(I);let R=0;for(let E=0;E<g;E++)R+=Math.abs(p[E]);const N=Math.sqrt(R/g),j=Math.log10(N+.001)*50+100,ce=Math.max(0,Math.min(100,j));let ue=0;for(let E=0;E<I.length;E++)ue+=Math.abs(I[E]);const me=Math.sqrt(ue/I.length),ge=Math.log10(me+.001)*50+100;t(1,F=Math.max(0,Math.min(100,ge))),q.push(ce),q.length>5&&q.shift(),Q=q.reduce((E,W)=>E+W,0)/q.length,S=Q;const[G,fe]=_.findPitch(p,h.sampleRate),ve=G>=65&&G<=1200;if(G&&fe>.6&&S>10&&ve){const E=Te.correctHarmonic(G);if(E!==G&&Math.abs(E-G)>5&&i==="guiding"){const W=G/E,Fe=W>1.8&&W<2.2?"2x":W>2.8&&W<3.2?"3x":W>3.8&&W<4.2?"4x":W>.45&&W<.55?"1/2x":"other",De=Ee(G),ze=Ee(E),_e=`🔧 [Harmonic] ${G.toFixed(0)}Hz(${De}) → ${E.toFixed(0)}Hz(${ze}) [${Fe}補正]`,Se=Date.now();_e!==K&&Se-J>500&&(console.log(_e),K=_e,J=Se)}t(2,C=Math.round(E)),t(3,H=Ee(C)),B=fe}else C===0&&Te.resetHistory(),t(2,C=0),t(3,H="ーー"),B=0;const ye=C>0?F:0;r("pitchUpdate",{frequency:C,note:H,volume:S,rawVolume:ye,clarity:B}),y=requestAnimationFrame(re)}function oe(){return f&&l==="ready"}function ae(){return{componentState:l,isInitialized:f,isDetecting:b,lastError:c,hasRequiredComponents:!!(u&&_&&h&&m)}}async function ie(){console.log("🔄 [PitchDetector] 再初期化開始"),ne(),await new Promise(g=>setTimeout(g,100)),await te(),console.log("✅ [PitchDetector] 再初期化完了")}function ne(){console.log("🧹 [PitchDetector] クリーンアップ開始"),Y(),M.size>0&&(M.forEach((g,p)=>{p.removeEventListener("ended",g.endedHandler),p.removeEventListener("mute",g.muteHandler),p.removeEventListener("unmute",g.unmuteHandler)}),M.clear(),console.log("🔄 [PitchDetector] MediaStreamイベントリスナー削除")),w.length>0&&(xe.release(w),console.log("📤 [PitchDetector] AudioManagerにAnalyser解放通知:",w),w=[]),t(15,l="uninitialized"),f=!1,c=null,h=null,m=null,v=null,t(16,u=null),d=null,_=null,q=[],Te.resetHistory(),console.log("✅ [PitchDetector] クリーンアップ完了")}function le(){if(!m)return;const g=m.getTracks();g.forEach(p=>{const I=()=>{console.error("🚨 [PitchDetector] MediaStreamTrack終了検出:",p.kind),t(15,l="error"),c=new Error(`MediaStreamTrack (${p.kind}) ended`),r("error",{error:c,reason:"mediastream_ended",recovery:"restart_required"}),b&&Y()},R=()=>{console.warn("⚠️ [PitchDetector] MediaStreamTrack muted:",p.kind),r("warning",{reason:"track_muted",track:p.kind})},N=()=>{console.log("✅ [PitchDetector] MediaStreamTrack unmuted:",p.kind),r("info",{reason:"track_unmuted",track:p.kind})};p.addEventListener("ended",I),p.addEventListener("mute",R),p.addEventListener("unmute",N),M.set(p,{endedHandler:I,muteHandler:R,unmuteHandler:N})}),console.log("🔍 [PitchDetector] MediaStream監視開始:",g.length+" tracks")}return st(()=>{k&&(clearInterval(k),t(18,k=null)),console.log("🔄 [PitchDetector] onDestroy - AudioManagerリソースは保持")}),o.$$set=g=>{"isActive"in g&&t(4,s=g.isActive),"className"in g&&t(0,n=g.className),"debugMode"in g&&t(5,a=g.debugMode),"trainingPhase"in g&&t(6,i=g.trainingPhase)},o.$$.update=()=>{o.$$.dirty[0]&262176&&(a&&!k?(console.log("🔍 [PitchDetector] Debug mode enabled - starting status monitoring"),t(18,k=setInterval(X,3e3)),X()):!a&&k&&(console.log("🔍 [PitchDetector] Debug mode disabled - stopping status monitoring"),clearInterval(k),t(18,k=null))),o.$$.dirty[0]&229392&&(s&&l==="ready"&&u&&!b?se():!s&&b&&Y())},[n,F,C,H,s,a,i,$,te,se,Y,oe,ae,ie,ne,l,u,b,k]}class Tt extends Ne{constructor(e){super(),Pe(this,e,yt,vt,He,{isActive:4,className:0,debugMode:5,trainingPhase:6,resetDisplayState:7,initialize:8,startDetection:9,stopDetection:10,getIsInitialized:11,getState:12,reinitialize:13,cleanup:14},null,[-1,-1])}get resetDisplayState(){return this.$$.ctx[7]}get initialize(){return this.$$.ctx[8]}get startDetection(){return this.$$.ctx[9]}get stopDetection(){return this.$$.ctx[10]}get getIsInitialized(){return this.$$.ctx[11]}get getState(){return this.$$.ctx[12]}get reinitialize(){return this.$$.ctx[13]}get cleanup(){return this.$$.ctx[14]}}function _t(o){let e,t,r=(o[0]>0?Math.round(o[0]):"---")+"",s,n,a,i="Hz",l,c,f="|",h,m,v;return{c(){e=z("div"),t=z("span"),s=we(r),n=O(),a=z("span"),a.textContent=i,l=O(),c=z("span"),c.textContent=f,h=O(),m=z("span"),v=we(o[1]),this.h()},l(u){e=D(u,"DIV",{class:!0});var d=V(e);t=D(d,"SPAN",{class:!0});var _=V(t);s=Ae(_,r),_.forEach(T),n=Z(d),a=D(d,"SPAN",{class:!0,"data-svelte-h":!0}),Ce(a)!=="svelte-5uyilv"&&(a.textContent=i),l=Z(d),c=D(d,"SPAN",{class:!0,"data-svelte-h":!0}),Ce(c)!=="svelte-1dytxz4"&&(c.textContent=f),h=Z(d),m=D(d,"SPAN",{class:!0});var y=V(m);v=Ae(y,o[1]),y.forEach(T),d.forEach(T),this.h()},h(){x(t,"class","detected-frequency svelte-1datf0r"),x(a,"class","hz-suffix svelte-1datf0r"),x(c,"class","divider svelte-1datf0r"),x(m,"class","detected-note svelte-1datf0r"),x(e,"class","detection-values svelte-1datf0r")},m(u,d){de(u,e,d),A(e,t),A(t,s),A(e,n),A(e,a),A(e,l),A(e,c),A(e,h),A(e,m),A(m,v)},p(u,d){d&1&&r!==(r=(u[0]>0?Math.round(u[0]):"---")+"")&&Me(s,r),d&2&&Me(v,u[1])},d(u){u&&T(e)}}}function bt(o){let e,t;return{c(){e=z("span"),t=we(o[4]),this.h()},l(r){e=D(r,"SPAN",{class:!0});var s=V(e);t=Ae(s,o[4]),s.forEach(T),this.h()},h(){x(e,"class","muted-message svelte-1datf0r")},m(r,s){de(r,e,s),A(e,t)},p(r,s){s&16&&Me(t,r[4])},d(r){r&&T(e)}}}function pt(o){let e,t='<h3 class="section-title svelte-1datf0r">🎙️ リアルタイム音程検出</h3>',r,s,n,a,i,l,c,f;function h(u,d){return u[3]?bt:_t}let m=h(o),v=m(o);return c=new Qe({props:{volume:!o[3]&&o[0]>0?o[2]:0,className:"volume-bar"}}),{c(){e=z("div"),e.innerHTML=t,r=O(),s=z("div"),n=z("div"),a=z("div"),i=z("div"),v.c(),l=O(),Le(c.$$.fragment),this.h()},l(u){e=D(u,"DIV",{class:!0,"data-svelte-h":!0}),Ce(e)!=="svelte-10ekeq9"&&(e.innerHTML=t),r=Z(u),s=D(u,"DIV",{class:!0});var d=V(s);n=D(d,"DIV",{class:!0});var _=V(n);a=D(_,"DIV",{class:!0});var y=V(a);i=D(y,"DIV",{class:!0});var b=V(i);v.l(b),b.forEach(T),l=Z(y),qe(c.$$.fragment,y),y.forEach(T),_.forEach(T),d.forEach(T),this.h()},h(){x(e,"class","card-header svelte-1datf0r"),x(i,"class","detection-card svelte-1datf0r"),x(a,"class","detection-display svelte-1datf0r"),x(n,"class","pitch-detector svelte-1datf0r"),x(s,"class","card-content svelte-1datf0r")},m(u,d){de(u,e,d),de(u,r,d),de(u,s,d),A(s,n),A(n,a),A(a,i),v.m(i,null),A(a,l),Be(c,a,null),f=!0},p(u,d){m===(m=h(u))&&v?v.p(u,d):(v.d(1),v=m(u),v&&(v.c(),v.m(i,null)));const _={};d&13&&(_.volume=!u[3]&&u[0]>0?u[2]:0),c.$set(_)},i(u){f||(Re(c.$$.fragment,u),f=!0)},o(u){Ve(c.$$.fragment,u),f=!1},d(u){u&&(T(e),T(r),T(s)),v.d(),ke(c)}}}function Mt(o){let e,t;return e=new rt({props:{class:"main-card "+o[5],$$slots:{default:[pt]},$$scope:{ctx:o}}}),{c(){Le(e.$$.fragment)},l(r){qe(e.$$.fragment,r)},m(r,s){Be(e,r,s),t=!0},p(r,[s]){const n={};s&32&&(n.class="main-card "+r[5]),s&95&&(n.$$scope={dirty:s,ctx:r}),e.$set(n)},i(r){t||(Re(e.$$.fragment,r),t=!0)},o(r){Ve(e.$$.fragment,r),t=!1},d(r){ke(e,r)}}}function At(o,e,t){let{frequency:r=0}=e,{note:s="ーー"}=e,{volume:n=0}=e,{isMuted:a=!1}=e,{muteMessage:i="待機中..."}=e,{className:l=""}=e;return o.$$set=c=>{"frequency"in c&&t(0,r=c.frequency),"note"in c&&t(1,s=c.note),"volume"in c&&t(2,n=c.volume),"isMuted"in c&&t(3,a=c.isMuted),"muteMessage"in c&&t(4,i=c.muteMessage),"className"in c&&t(5,l=c.className)},[r,s,n,a,i,l]}class Ft extends Ne{constructor(e){super(),Pe(this,e,At,Mt,He,{frequency:0,note:1,volume:2,isMuted:3,muteMessage:4,className:5})}}export{Ft as P,Tt as a,xe as b,Te as h,gt as l};
