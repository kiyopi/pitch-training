const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["../chunks/gi3OCs5l.js","../chunks/DXfV3yLF.js","../chunks/BnpKoSs-.js","../chunks/D0QH3NT1.js","../chunks/BgB3jUeu.js","../assets/sessionStorage.2zs4CtXT.css"])))=>i.map(i=>d[i]);
import{_ as wn}from"../chunks/C1FmrZbK.js";import{S as Do,i as qo,d as $,s as wo,v as Ie,c as Ae,a as Co,H as Cn,V as kn,b as h,q as de,r as X,u as K,f as W,w as me,I as ko,m as Y,x as ge,p as Z,y as ye,J as Fo,K as Te,L as Ee,g as m,z as x,h as I,M as Fe,j as A,k as O,A as _e,l as z,N as je,o as T,t as L,e as fe,Q as lt,n as Et,R as xn}from"../chunks/DXfV3yLF.js";import{g as Ro}from"../chunks/D0QH3NT1.js";import"../chunks/BnpKoSs-.js";import{b as it,g as vt}from"../chunks/BgB3jUeu.js";import{p as _t}from"../chunks/0KgvqPOr.js";import{P as Hn,B as ut,C as Ke}from"../chunks/CrwomGmF.js";import{l as ie,a as Je,h as St,P as Vn,b as zn,V as Mo}from"../chunks/BRZWrjh2.js";import{l as bt,s as tt,c as No,r as Io,a as Fn,u as Dt,b as Ao,d as qt,p as To,o as Eo,e as Po,f as wt,i as Ct,g as Bo,h as kt,n as Ft,j as Rt,k as Mt,t as Nt,E as Rn,m as nt,A as Jt,U as Kt,S as xo,F as Ho,C as Vo,I as zo,q as Lo,T as jo,P as Go,M as Ln,v as Oo,w as Uo,x as It}from"../chunks/gi3OCs5l.js";const Wo=!1,Jo=!1,cs=Object.freeze(Object.defineProperty({__proto__:null,prerender:Jo,ssr:Wo},Symbol.toStringTag,{value:"Module"})),{Object:Ko,console:Qo,document:Mn}=Ro,E="src/routes/training/continuous/+page.svelte";function Nn(s,t,e){const i=s.slice();return i[99]=t[e],i[101]=e,i}function In(s,t,e){const i=s.slice();return i[102]=t[e],i}function Pt(s){var j,U;let t,e,i,r,n,a,c,u,f,d,y=(((j=s[24])==null?void 0:j.length)||0)+"",v,C,p,g,_,M,w,N,R=Math.round((((U=s[24])==null?void 0:U.length)||0)/8*100)+"",S,P,H,b,ee,q=s[0]==="results"&&s[5]&&Bt(s);const k={c:function(){t=T("div"),e=T("div"),i=T("div"),r=T("span"),n=L("セッション "),a=L(s[23]),c=L("/8"),u=Z(),f=T("span"),d=L("完了済み "),v=L(y),C=L("セッション"),p=Z(),g=T("div"),_=T("div"),M=T("div"),w=Z(),N=T("span"),S=L(R),P=L("%"),H=Z(),q&&q.c(),b=je(),this.h()},l:function(V){t=A(V,"DIV",{class:!0});var B=O(t);e=A(B,"DIV",{class:!0});var te=O(e);i=A(te,"DIV",{class:!0});var Q=O(i);r=A(Q,"SPAN",{class:!0});var he=O(r);n=z(he,"セッション "),a=z(he,s[23]),c=z(he,"/8"),he.forEach(h),u=Y(Q),f=A(Q,"SPAN",{class:!0});var be=O(f);d=z(be,"完了済み "),v=z(be,y),C=z(be,"セッション"),be.forEach(h),Q.forEach(h),p=Y(te),g=A(te,"DIV",{class:!0});var Pe=O(g);_=A(Pe,"DIV",{class:!0});var Ge=O(_);M=A(Ge,"DIV",{class:!0,style:!0}),O(M).forEach(h),Ge.forEach(h),w=Y(Pe),N=A(Pe,"SPAN",{class:!0});var Ve=O(N);S=z(Ve,R),P=z(Ve,"%"),Ve.forEach(h),Pe.forEach(h),te.forEach(h),B.forEach(h),H=Y(V),q&&q.l(V),b=je(),this.h()},h:function(){var V;x(r,"class","completed-count svelte-rt5px1"),I(r,E,2659,12,90393),x(f,"class","remaining-text svelte-rt5px1"),I(f,E,2660,12,90470),x(i,"class","session-info svelte-rt5px1"),I(i,E,2658,10,90354),x(M,"class","progress-fill svelte-rt5px1"),Fe(M,"width",(((V=s[24])==null?void 0:V.length)||0)/8*100+"%"),I(M,E,2664,14,90658),x(_,"class","progress-bar svelte-rt5px1"),I(_,E,2663,12,90617),x(N,"class","progress-text svelte-rt5px1"),I(N,E,2666,12,90784),x(g,"class","progress-section svelte-rt5px1"),I(g,E,2662,10,90574),x(e,"class","session-status svelte-rt5px1"),I(e,E,2657,8,90315),x(t,"class","session-progress svelte-rt5px1"),I(t,E,2656,6,90276)},m:function(V,B){W(V,t,B),m(t,e),m(e,i),m(i,r),m(r,n),m(r,a),m(r,c),m(i,u),m(i,f),m(f,d),m(f,v),m(f,C),m(e,p),m(e,g),m(g,_),m(_,M),m(g,w),m(g,N),m(N,S),m(N,P),W(V,H,B),q&&q.m(V,B),W(V,b,B),ee=!0},p:function(V,B){var te,Q,he;(!ee||B[0]&8388608)&&fe(a,V[23]),(!ee||B[0]&16777216)&&y!==(y=(((te=V[24])==null?void 0:te.length)||0)+"")&&fe(v,y),(!ee||B[0]&16777216)&&Fe(M,"width",(((Q=V[24])==null?void 0:Q.length)||0)/8*100+"%"),(!ee||B[0]&16777216)&&R!==(R=Math.round((((he=V[24])==null?void 0:he.length)||0)/8*100)+"")&&fe(S,R),V[0]==="results"&&V[5]?q?(q.p(V,B),B[0]&33&&K(q,1)):(q=Bt(V),q.c(),K(q,1),q.m(b.parentNode,b)):q&&(Te(),X(q,1,1,()=>{q=null}),Ee())},i:function(V){ee||(K(q),ee=!0)},o:function(V){X(q),ee=!1},d:function(V){V&&(h(t),h(H),h(b)),q&&q.d(V)}};return $("SvelteRegisterBlock",{block:k,id:Pt.name,type:"if",source:"(2656:4) {#if microphoneState === 'granted' && !$isLoading}",ctx:s}),k}function Bt(s){let t,e,i;e=new Jt({props:{isCompleted:s[5],position:"top"},$$inline:!0}),e.$on("action",s[29]);const r={c:function(){t=T("div"),ye(e.$$.fragment),this.h()},l:function(a){t=A(a,"DIV",{class:!0});var c=O(t);ge(e.$$.fragment,c),c.forEach(h),this.h()},h:function(){x(t,"class","top-action-buttons svelte-rt5px1"),I(t,E,2674,8,91041)},m:function(a,c){W(a,t,c),me(e,t,null),i=!0},p:function(a,c){const u={};c[0]&32&&(u.isCompleted=a[5]),e.$set(u)},i:function(a){i||(K(e.$$.fragment,a),i=!0)},o:function(a){X(e.$$.fragment,a),i=!1},d:function(a){a&&h(t),de(e)}};return $("SvelteRegisterBlock",{block:r,id:Bt.name,type:"if",source:"(2674:6) {#if trainingPhase === 'results' && $isCompleted}",ctx:s}),r}function jn(s){let t,e;t=new Ke({props:{class:"error-card",$$slots:{default:[Wn]},$$scope:{ctx:s}},$$inline:!0});const i={c:function(){ye(t.$$.fragment)},l:function(n){ge(t.$$.fragment,n)},m:function(n,a){me(t,n,a),e=!0},p:function(n,a){const c={};a[3]&4096&&(c.$$scope={dirty:a,ctx:n}),t.$set(c)},i:function(n){e||(K(t.$$.fragment,n),e=!0)},o:function(n){X(t.$$.fragment,n),e=!1},d:function(n){de(t,n)}};return $("SvelteRegisterBlock",{block:i,id:jn.name,type:"else",source:"(2921:2) {:else}",ctx:s}),i}function Gn(s){let t,e,i,r,n,a,c,u={isActive:s[1]==="granted",trainingPhase:s[0],className:"pitch-detector-content",debugMode:!0,disableHarmonicCorrection:!1};e=new zn({props:u,$$inline:!0}),s[35](e),e.$on("pitchUpdate",s[28]),e.$on("stateChange",go),e.$on("error",s[31]),e.$on("microphoneHealthChange",s[32]);let f=s[0]!=="results"&&xt(s),d=s[0]!=="results"&&Lt(s),y=s[0]==="results"&&Ot(s);const v={c:function(){t=T("div"),ye(e.$$.fragment),i=Z(),f&&f.c(),r=Z(),d&&d.c(),n=Z(),y&&y.c(),a=je(),this.h()},l:function(p){t=A(p,"DIV",{style:!0});var g=O(t);ge(e.$$.fragment,g),g.forEach(h),i=Y(p),f&&f.l(p),r=Y(p),d&&d.l(p),n=Y(p),y&&y.l(p),a=je(),this.h()},h:function(){Fe(t,"display","none"),I(t,E,2693,4,91566)},m:function(p,g){W(p,t,g),me(e,t,null),W(p,i,g),f&&f.m(p,g),W(p,r,g),d&&d.m(p,g),W(p,n,g),y&&y.m(p,g),W(p,a,g),c=!0},p:function(p,g){const _={};g[0]&2&&(_.isActive=p[1]==="granted"),g[0]&1&&(_.trainingPhase=p[0]),e.$set(_),p[0]!=="results"?f?(f.p(p,g),g[0]&1&&K(f,1)):(f=xt(p),f.c(),K(f,1),f.m(r.parentNode,r)):f&&(Te(),X(f,1,1,()=>{f=null}),Ee()),p[0]!=="results"?d?(d.p(p,g),g[0]&1&&K(d,1)):(d=Lt(p),d.c(),K(d,1),d.m(n.parentNode,n)):d&&(Te(),X(d,1,1,()=>{d=null}),Ee()),p[0]==="results"?y?(y.p(p,g),g[0]&1&&K(y,1)):(y=Ot(p),y.c(),K(y,1),y.m(a.parentNode,a)):y&&(Te(),X(y,1,1,()=>{y=null}),Ee())},i:function(p){c||(K(e.$$.fragment,p),K(f),K(d),K(y),c=!0)},o:function(p){X(e.$$.fragment,p),X(f),X(d),X(y),c=!1},d:function(p){p&&(h(t),h(i),h(r),h(n),h(a)),s[35](null),de(e),f&&f.d(p),d&&d.d(p),y&&y.d(p)}};return $("SvelteRegisterBlock",{block:v,id:Gn.name,type:"if",source:"(2692:2) {#if microphoneState === 'granted'}",ctx:s}),v}function On(s){let t;const e={c:function(){t=L("🎤 マイクテストページへ移動")},l:function(r){t=z(r,"🎤 マイクテストページへ移動")},m:function(r,n){W(r,t,n)},d:function(r){r&&h(t)}};return $("SvelteRegisterBlock",{block:e,id:On.name,type:"slot",source:'(2935:10) <Button variant=\\"primary\\" on:click={goToMicrophoneTest}>',ctx:s}),e}function Un(s){let t;const e={c:function(){t=L("🏠 ホームに戻る")},l:function(r){t=z(r,"🏠 ホームに戻る")},m:function(r,n){W(r,t,n)},d:function(r){r&&h(t)}};return $("SvelteRegisterBlock",{block:e,id:Un.name,type:"slot",source:'(2938:10) <Button variant=\\"secondary\\" on:click={goHome}>',ctx:s}),e}function Wn(s){let t,e,i="🎤",r,n,a="マイクテストが必要です",c,u,f="連続チャレンジモードを開始する前に、マイクテストページで音声入力の確認をお願いします。",d,y,v,C,p,g="マイクテスト完了後",_,M,w,N="まずはマイクテストページで音声確認を行ってください。",R,S,P,H,b,ee;P=new ut({props:{variant:"primary",$$slots:{default:[On]},$$scope:{ctx:s}},$$inline:!0}),P.$on("click",s[26]),b=new ut({props:{variant:"secondary",$$slots:{default:[Un]},$$scope:{ctx:s}},$$inline:!0}),b.$on("click",s[27]);const q={c:function(){t=T("div"),e=T("div"),e.textContent=i,r=Z(),n=T("h3"),n.textContent=a,c=Z(),u=T("p"),u.textContent=f,d=Z(),y=T("div"),v=T("p"),C=L("このページは"),p=T("strong"),p.textContent=g,_=L("にご利用いただけます。"),M=Z(),w=T("p"),w.textContent=N,R=Z(),S=T("div"),ye(P.$$.fragment),H=Z(),ye(b.$$.fragment),this.h()},l:function(j){t=A(j,"DIV",{class:!0});var U=O(t);e=A(U,"DIV",{class:!0,"data-svelte-h":!0}),_e(e)!=="svelte-15rbx8n"&&(e.textContent=i),r=Y(U),n=A(U,"H3",{class:!0,"data-svelte-h":!0}),_e(n)!=="svelte-17kvze2"&&(n.textContent=a),c=Y(U),u=A(U,"P",{class:!0,"data-svelte-h":!0}),_e(u)!=="svelte-1t09god"&&(u.textContent=f),d=Y(U),y=A(U,"DIV",{class:!0});var oe=O(y);v=A(oe,"P",{class:!0});var V=O(v);C=z(V,"このページは"),p=A(V,"STRONG",{"data-svelte-h":!0}),_e(p)!=="svelte-1n3qsr6"&&(p.textContent=g),_=z(V,"にご利用いただけます。"),V.forEach(h),M=Y(oe),w=A(oe,"P",{class:!0,"data-svelte-h":!0}),_e(w)!=="svelte-v8nd09"&&(w.textContent=N),oe.forEach(h),R=Y(U),S=A(U,"DIV",{class:!0});var B=O(S);ge(P.$$.fragment,B),H=Y(B),ge(b.$$.fragment,B),B.forEach(h),U.forEach(h),this.h()},h:function(){x(e,"class","error-icon svelte-rt5px1"),I(e,E,2924,8,99769),x(n,"class","svelte-rt5px1"),I(n,E,2925,8,99810),x(u,"class","svelte-rt5px1"),I(u,E,2926,8,99839),I(p,E,2929,19,99955),x(v,"class","svelte-rt5px1"),I(v,E,2929,10,99946),x(w,"class","svelte-rt5px1"),I(w,E,2930,10,100007),x(y,"class","recommendation svelte-rt5px1"),I(y,E,2928,8,99907),x(S,"class","action-buttons"),I(S,E,2933,8,100073),x(t,"class","error-content svelte-rt5px1"),I(t,E,2923,6,99733)},m:function(j,U){W(j,t,U),m(t,e),m(t,r),m(t,n),m(t,c),m(t,u),m(t,d),m(t,y),m(y,v),m(v,C),m(v,p),m(v,_),m(y,M),m(y,w),m(t,R),m(t,S),me(P,S,null),m(S,H),me(b,S,null),ee=!0},p:function(j,U){const oe={};U[3]&4096&&(oe.$$scope={dirty:U,ctx:j}),P.$set(oe);const V={};U[3]&4096&&(V.$$scope={dirty:U,ctx:j}),b.$set(V)},i:function(j){ee||(K(P.$$.fragment,j),K(b.$$.fragment,j),ee=!0)},o:function(j){X(P.$$.fragment,j),X(b.$$.fragment,j),ee=!1},d:function(j){j&&h(t),de(P),de(b)}};return $("SvelteRegisterBlock",{block:q,id:Wn.name,type:"slot",source:'(2923:4) <Card class=\\"error-card\\">',ctx:s}),q}function xt(s){let t,e,i,r,n,a,c,u,f,d,y,v,C,p,g,_,M=!s[2]&&s[6].length>0&&Ht(s);i=new Ke({props:{class:"main-card half-width",$$slots:{default:[to]},$$scope:{ctx:s}},$$inline:!0}),g=new Vn({props:{frequency:s[14],note:s[15],volume:s[13],isMuted:s[0]!=="guiding",muteMessage:"基音再生後に開始",className:"half-width",showGuidance:!1},$$inline:!0});const w={c:function(){M&&M.c(),t=Z(),e=T("div"),ye(i.$$.fragment),r=Z(),n=T("div"),a=L("DEBUG: freq="),c=L(s[14]),u=L(", note="),f=L(s[15]),d=L(", vol="),y=L(s[13]),v=L(", phase="),C=L(s[0]),p=Z(),ye(g.$$.fragment),this.h()},l:function(R){M&&M.l(R),t=Y(R),e=A(R,"DIV",{class:!0});var S=O(e);ge(i.$$.fragment,S),r=Y(S),n=A(S,"DIV",{style:!0});var P=O(n);a=z(P,"DEBUG: freq="),c=z(P,s[14]),u=z(P,", note="),f=z(P,s[15]),d=z(P,", vol="),y=z(P,s[13]),v=z(P,", phase="),C=z(P,s[0]),P.forEach(h),p=Y(S),ge(g.$$.fragment,S),S.forEach(h),this.h()},h:function(){Fe(n,"background","yellow"),Fe(n,"padding","10px"),Fe(n,"margin","10px 0"),Fe(n,"font-family","monospace"),Fe(n,"font-size","12px"),I(n,E,2793,8,95160),x(e,"class","side-by-side-container svelte-rt5px1"),I(e,E,2732,6,92903)},m:function(R,S){M&&M.m(R,S),W(R,t,S),W(R,e,S),me(i,e,null),m(e,r),m(e,n),m(n,a),m(n,c),m(n,u),m(n,f),m(n,d),m(n,y),m(n,v),m(n,C),m(e,p),me(g,e,null),_=!0},p:function(R,S){!R[2]&&R[6].length>0?M?(M.p(R,S),S[0]&68&&K(M,1)):(M=Ht(R),M.c(),K(M,1),M.m(t.parentNode,t)):M&&(Te(),X(M,1,1,()=>{M=null}),Ee());const P={};S[0]&8395649|S[3]&4096&&(P.$$scope={dirty:S,ctx:R}),i.$set(P),(!_||S[0]&16384)&&fe(c,R[14]),(!_||S[0]&32768)&&fe(f,R[15]),(!_||S[0]&8192)&&fe(y,R[13]),(!_||S[0]&1)&&fe(C,R[0]);const H={};S[0]&16384&&(H.frequency=R[14]),S[0]&32768&&(H.note=R[15]),S[0]&8192&&(H.volume=R[13]),S[0]&1&&(H.isMuted=R[0]!=="guiding"),g.$set(H)},i:function(R){_||(K(M),K(i.$$.fragment,R),K(g.$$.fragment,R),_=!0)},o:function(R){X(M),X(i.$$.fragment,R),X(g.$$.fragment,R),_=!1},d:function(R){R&&(h(t),h(e)),M&&M.d(R),de(i),de(g)}};return $("SvelteRegisterBlock",{block:w,id:xt.name,type:"if",source:"(2711:4) {#if trainingPhase !== 'results'}",ctx:s}),w}function Ht(s){let t,e;t=new Ke({props:{class:"warning-card",$$slots:{default:[Jn]},$$scope:{ctx:s}},$$inline:!0});const i={c:function(){ye(t.$$.fragment)},l:function(n){ge(t.$$.fragment,n)},m:function(n,a){me(t,n,a),e=!0},p:function(n,a){const c={};a[0]&64|a[3]&4096&&(c.$$scope={dirty:a,ctx:n}),t.$set(c)},i:function(n){e||(K(t.$$.fragment,n),e=!0)},o:function(n){X(t.$$.fragment,n),e=!1},d:function(n){de(t,n)}};return $("SvelteRegisterBlock",{block:i,id:Ht.name,type:"if",source:"(2714:6) {#if !microphoneHealthy && microphoneErrors.length > 0}",ctx:s}),i}function Vt(s){let t,e=s[102]+"",i;const r={c:function(){t=T("li"),i=L(e),this.h()},l:function(a){t=A(a,"LI",{class:!0});var c=O(t);i=z(c,e),c.forEach(h),this.h()},h:function(){x(t,"class","svelte-rt5px1"),I(t,E,2722,16,92671)},m:function(a,c){W(a,t,c),m(t,i)},p:function(a,c){c[0]&64&&e!==(e=a[102]+"")&&fe(i,e)},d:function(a){a&&h(t)}};return $("SvelteRegisterBlock",{block:r,id:Vt.name,type:"each",source:"(2722:14) {#each microphoneErrors as error}",ctx:s}),r}function Jn(s){let t,e,i="⚠️ マイク接続に問題があります",r,n,a,c="マイクが正常に動作していません。以下の問題が検出されました：",u,f,d,y,v,C="解決方法:",p,g=lt(s[6]),_=[];for(let w=0;w<g.length;w+=1)_[w]=Vt(In(s,g,w));const M={c:function(){t=T("div"),e=T("h3"),e.textContent=i,r=Z(),n=T("div"),a=T("p"),a.textContent=c,u=Z(),f=T("ul");for(let N=0;N<_.length;N+=1)_[N].c();d=Z(),y=T("p"),v=T("strong"),v.textContent=C,p=L(" ページを再読み込みしてマイク許可を再度取得してください。"),this.h()},l:function(N){t=A(N,"DIV",{class:!0});var R=O(t);e=A(R,"H3",{class:!0,"data-svelte-h":!0}),_e(e)!=="svelte-15qec5x"&&(e.textContent=i),R.forEach(h),r=Y(N),n=A(N,"DIV",{class:!0});var S=O(n);a=A(S,"P",{class:!0,"data-svelte-h":!0}),_e(a)!=="svelte-171o2p0"&&(a.textContent=c),u=Y(S),f=A(S,"UL",{class:!0});var P=O(f);for(let b=0;b<_.length;b+=1)_[b].l(P);P.forEach(h),d=Y(S),y=A(S,"P",{class:!0});var H=O(y);v=A(H,"STRONG",{"data-svelte-h":!0}),_e(v)!=="svelte-79o66n"&&(v.textContent=C),p=z(H," ページを再読み込みしてマイク許可を再度取得してください。"),H.forEach(h),S.forEach(h),this.h()},h:function(){x(e,"class","section-title svelte-rt5px1"),I(e,E,2716,12,92395),x(t,"class","card-header svelte-rt5px1"),I(t,E,2715,10,92357),x(a,"class","warning-message svelte-rt5px1"),I(a,E,2719,12,92509),x(f,"class","error-list svelte-rt5px1"),I(f,E,2720,12,92583),I(v,E,2726,14,92782),x(y,"class","fix-instruction svelte-rt5px1"),I(y,E,2725,12,92740),x(n,"class","card-content svelte-rt5px1"),I(n,E,2718,10,92470)},m:function(N,R){W(N,t,R),m(t,e),W(N,r,R),W(N,n,R),m(n,a),m(n,u),m(n,f);for(let S=0;S<_.length;S+=1)_[S]&&_[S].m(f,null);m(n,d),m(n,y),m(y,v),m(y,p)},p:function(N,R){if(R[0]&64){g=lt(N[6]);let S;for(S=0;S<g.length;S+=1){const P=In(N,g,S);_[S]?_[S].p(P,R):(_[S]=Vt(P),_[S].c(),_[S].m(f,null))}for(;S<_.length;S+=1)_[S].d(1);_.length=g.length}},d:function(N){N&&(h(t),h(r),h(n)),xn(_,N)}};return $("SvelteRegisterBlock",{block:M,id:Jn.name,type:"slot",source:'(2715:8) <Card class=\\"warning-card\\">',ctx:s}),M}function Kn(s){let t;function e(a,c){return a[9]?$n:a[0]==="guiding"?Zn:a[0]==="results"?Yn:Xn}let i=e(s),r=i(s);const n={c:function(){t=T("div"),r.c(),this.h()},l:function(c){t=A(c,"DIV",{class:!0});var u=O(t);r.l(u),u.forEach(h),this.h()},h:function(){x(t,"class","continuous-status svelte-rt5px1"),I(t,E,2749,14,93552)},m:function(c,u){W(c,t,u),r.m(t,null)},p:function(c,u){i===(i=e(c))&&r?r.p(c,u):(r.d(1),r=i(c),r&&(r.c(),r.m(t,null)))},i:Et,o:Et,d:function(c){c&&h(t),r.d()}};return $("SvelteRegisterBlock",{block:n,id:Kn.name,type:"else",source:"(2748:12) {:else}",ctx:s}),n}function Qn(s){let t,e;t=new ut({props:{variant:"primary",$$slots:{default:[eo]},$$scope:{ctx:s}},$$inline:!0}),t.$on("click",s[30]);const i={c:function(){ye(t.$$.fragment)},l:function(n){ge(t.$$.fragment,n)},m:function(n,a){me(t,n,a),e=!0},p:function(n,a){const c={};a[3]&4096&&(c.$$scope={dirty:a,ctx:n}),t.$set(c)},i:function(n){e||(K(t.$$.fragment,n),e=!0)},o:function(n){X(t.$$.fragment,n),e=!1},d:function(n){de(t,n)}};return $("SvelteRegisterBlock",{block:i,id:Qn.name,type:"if",source:"(2741:12) {#if trainingPhase === 'setup' && !isPlaying && !($currentSessionId > 1)}",ctx:s}),i}function Xn(s){let t,e,i,r;const n={c:function(){t=T("div"),e=L("⚡ 連続モード進行中 ("),i=L(s[23]),r=L("/8)"),this.h()},l:function(c){t=A(c,"DIV",{class:!0});var u=O(t);e=z(u,"⚡ 連続モード進行中 ("),i=z(u,s[23]),r=z(u,"/8)"),u.forEach(h),this.h()},h:function(){x(t,"class","status-text svelte-rt5px1"),I(t,E,2763,18,94142)},m:function(c,u){W(c,t,u),m(t,e),m(t,i),m(t,r)},p:function(c,u){u[0]&8388608&&fe(i,c[23])},d:function(c){c&&h(t)}};return $("SvelteRegisterBlock",{block:n,id:Xn.name,type:"else",source:"(2763:16) {:else}",ctx:s}),n}function Yn(s){let t,e,i,r;const n={c:function(){t=T("div"),e=L("✅ セッション "),i=L(s[23]),r=L("/8 完了"),this.h()},l:function(c){t=A(c,"DIV",{class:!0});var u=O(t);e=z(u,"✅ セッション "),i=z(u,s[23]),r=z(u,"/8 完了"),u.forEach(h),this.h()},h:function(){x(t,"class","status-text svelte-rt5px1"),I(t,E,2759,18,93996)},m:function(c,u){W(c,t,u),m(t,e),m(t,i),m(t,r)},p:function(c,u){u[0]&8388608&&fe(i,c[23])},d:function(c){c&&h(t)}};return $("SvelteRegisterBlock",{block:n,id:Yn.name,type:"if",source:"(2759:54) ",ctx:s}),n}function Zn(s){let t,e,i,r;const n={c:function(){t=T("div"),e=L("🎤 セッション "),i=L(s[23]),r=L("/8: ドレミ発声中"),this.h()},l:function(c){t=A(c,"DIV",{class:!0});var u=O(t);e=z(u,"🎤 セッション "),i=z(u,s[23]),r=z(u,"/8: ドレミ発声中"),u.forEach(h),this.h()},h:function(){x(t,"class","status-text svelte-rt5px1"),I(t,E,2755,18,93813)},m:function(c,u){W(c,t,u),m(t,e),m(t,i),m(t,r)},p:function(c,u){u[0]&8388608&&fe(i,c[23])},d:function(c){c&&h(t)}};return $("SvelteRegisterBlock",{block:n,id:Zn.name,type:"if",source:"(2755:54) ",ctx:s}),n}function $n(s){let t,e,i,r;const n={c:function(){t=T("div"),e=L("🎵 基音 "),i=L(s[23]),r=L("/8 再生中..."),this.h()},l:function(c){t=A(c,"DIV",{class:!0});var u=O(t);e=z(u,"🎵 基音 "),i=z(u,s[23]),r=z(u,"/8 再生中..."),u.forEach(h),this.h()},h:function(){x(t,"class","status-text svelte-rt5px1"),I(t,E,2751,18,93634)},m:function(c,u){W(c,t,u),m(t,e),m(t,i),m(t,r)},p:function(c,u){u[0]&8388608&&fe(i,c[23])},d:function(c){c&&h(t)}};return $("SvelteRegisterBlock",{block:n,id:$n.name,type:"if",source:"(2751:16) {#if isPlaying}",ctx:s}),n}function eo(s){let t;const e={c:function(){t=L("⚡ 連続チャレンジ開始（8セッション）")},l:function(r){t=z(r,"⚡ 連続チャレンジ開始（8セッション）")},m:function(r,n){W(r,t,n)},d:function(r){r&&h(t)}};return $("SvelteRegisterBlock",{block:e,id:eo.name,type:"slot",source:'(2742:14) <Button                  variant=\\"primary\\"                 on:click={startContinuousMode}               >',ctx:s}),e}function zt(s){let t,e,i,r,n,a=s[8].toFixed(1)+"",c,u;const f={c:function(){t=T("div"),e=L("現在の基音: "),i=T("strong"),r=L(s[7]),n=L(" ("),c=L(a),u=L("Hz)"),this.h()},l:function(y){t=A(y,"DIV",{class:!0});var v=O(t);e=z(v,"現在の基音: "),i=A(v,"STRONG",{});var C=O(i);r=z(C,s[7]),C.forEach(h),n=z(v," ("),c=z(v,a),u=z(v,"Hz)"),v.forEach(h),this.h()},h:function(){I(i,E,2772,23,94422),x(t,"class","base-note-info svelte-rt5px1"),I(t,E,2771,14,94370)},m:function(y,v){W(y,t,v),m(t,e),m(t,i),m(i,r),m(t,n),m(t,c),m(t,u)},p:function(y,v){v[0]&128&&fe(r,y[7]),v[0]&256&&a!==(a=y[8].toFixed(1)+"")&&fe(c,a)},d:function(y){y&&h(t)}};return $("SvelteRegisterBlock",{block:f,id:zt.name,type:"if",source:"(2771:12) {#if currentBaseNote}",ctx:s}),f}function to(s){let t,e,i="🎹 基音再生",r,n,a,c,u,f,d,y,v="ガイド開始まで",C,p,g,_,M,w,N,R;const S=[Qn,Kn],P=[];function H(q,k){return q[0]==="setup"&&!q[9]&&!(q[23]>1)?0:1}a=H(s),c=P[a]=S[a](s);let b=s[7]&&zt(s);w=new Ln({props:{size:"20"},$$inline:!0});const ee={c:function(){t=T("div"),e=T("h3"),e.textContent=i,r=Z(),n=T("div"),c.c(),u=Z(),b&&b.c(),f=Z(),d=T("div"),y=T("div"),y.textContent=v,C=Z(),p=T("div"),g=T("div"),_=Z(),M=T("div"),ye(w.$$.fragment),this.h()},l:function(k){t=A(k,"DIV",{class:!0});var j=O(t);e=A(j,"H3",{class:!0,"data-svelte-h":!0}),_e(e)!=="svelte-syc53b"&&(e.textContent=i),j.forEach(h),r=Y(k),n=A(k,"DIV",{class:!0});var U=O(n);c.l(U),u=Y(U),b&&b.l(U),f=Y(U),d=A(U,"DIV",{class:!0});var oe=O(d);y=A(oe,"DIV",{class:!0,"data-svelte-h":!0}),_e(y)!=="svelte-1dufnpv"&&(y.textContent=v),C=Y(oe),p=A(oe,"DIV",{class:!0});var V=O(p);g=A(V,"DIV",{class:!0,style:!0}),O(g).forEach(h),_=Y(V),M=A(V,"DIV",{class:!0});var B=O(M);ge(w.$$.fragment,B),B.forEach(h),V.forEach(h),oe.forEach(h),U.forEach(h),this.h()},h:function(){x(e,"class","section-title svelte-rt5px1"),I(e,E,2736,12,93067),x(t,"class","card-header svelte-rt5px1"),I(t,E,2735,10,93029),x(y,"class","guide-start-label svelte-rt5px1"),I(y,E,2778,14,94647),x(g,"class","guide-progress-fill svelte-rt5px1"),Fe(g,"width",s[11]+"%"),I(g,E,2780,16,94752),x(M,"class",N="guide-music-icon "+(s[12]?"glowing":"")+" svelte-rt5px1"),I(M,E,2784,16,94900),x(p,"class","guide-start-bar svelte-rt5px1"),I(p,E,2779,14,94706),x(d,"class","guide-start-bar-container svelte-rt5px1"),I(d,E,2777,12,94593),x(n,"class","card-content svelte-rt5px1"),I(n,E,2738,10,93133)},m:function(k,j){W(k,t,j),m(t,e),W(k,r,j),W(k,n,j),P[a].m(n,null),m(n,u),b&&b.m(n,null),m(n,f),m(n,d),m(d,y),m(d,C),m(d,p),m(p,g),m(p,_),m(p,M),me(w,M,null),R=!0},p:function(k,j){let U=a;a=H(k),a===U?P[a].p(k,j):(Te(),X(P[U],1,1,()=>{P[U]=null}),Ee(),c=P[a],c?c.p(k,j):(c=P[a]=S[a](k),c.c()),K(c,1),c.m(n,u)),k[7]?b?b.p(k,j):(b=zt(k),b.c(),b.m(n,f)):b&&(b.d(1),b=null),(!R||j[0]&2048)&&Fe(g,"width",k[11]+"%"),(!R||j[0]&4096&&N!==(N="guide-music-icon "+(k[12]?"glowing":"")+" svelte-rt5px1"))&&x(M,"class",N)},i:function(k){R||(K(c),K(w.$$.fragment,k),R=!0)},o:function(k){X(c),X(w.$$.fragment,k),R=!1},d:function(k){k&&(h(t),h(r),h(n)),P[a].d(),b&&b.d(),de(w)}};return $("SvelteRegisterBlock",{block:ee,id:to.name,type:"slot",source:'(2735:8) <Card class=\\"main-card half-width\\">',ctx:s}),ee}function Lt(s){let t,e;t=new Ke({props:{class:"main-card",$$slots:{default:[no]},$$scope:{ctx:s}},$$inline:!0});const i={c:function(){ye(t.$$.fragment)},l:function(n){ge(t.$$.fragment,n)},m:function(n,a){me(t,n,a),e=!0},p:function(n,a){const c={};a[0]&1025|a[3]&4096&&(c.$$scope={dirty:a,ctx:n}),t.$set(c)},i:function(n){e||(K(t.$$.fragment,n),e=!0)},o:function(n){X(t.$$.fragment,n),e=!1},d:function(n){de(t,n)}};return $("SvelteRegisterBlock",{block:i,id:Lt.name,type:"if",source:"(2809:4) {#if trainingPhase !== 'results'}",ctx:s}),i}function jt(s){let t,e=s[99].name+"",i,r,n;const a={c:function(){t=T("div"),i=L(e),r=Z(),this.h()},l:function(u){t=A(u,"DIV",{class:!0});var f=O(t);i=z(f,e),r=Y(f),f.forEach(h),this.h()},h:function(){x(t,"class",n="scale-item "+s[99].state+" svelte-rt5px1"),I(t,E,2817,14,96037)},m:function(u,f){W(u,t,f),m(t,i),m(t,r)},p:function(u,f){f[0]&1024&&e!==(e=u[99].name+"")&&fe(i,e),f[0]&1024&&n!==(n="scale-item "+u[99].state+" svelte-rt5px1")&&x(t,"class",n)},d:function(u){u&&h(t)}};return $("SvelteRegisterBlock",{block:a,id:jt.name,type:"each",source:"(2817:12) {#each scaleSteps as step, index}",ctx:s}),a}function Gt(s){let t,e,i,r="ドレミファソラシド",n;const a={c:function(){t=T("div"),e=L("ガイドに合わせて "),i=T("strong"),i.textContent=r,n=L(" を歌ってください"),this.h()},l:function(u){t=A(u,"DIV",{class:!0});var f=O(t);e=z(f,"ガイドに合わせて "),i=A(f,"STRONG",{"data-svelte-h":!0}),_e(i)!=="svelte-1dipf74"&&(i.textContent=r),n=z(f," を歌ってください"),f.forEach(h),this.h()},h:function(){I(i,E,2826,23,96304),x(t,"class","guide-instruction svelte-rt5px1"),I(t,E,2825,12,96249)},m:function(u,f){W(u,t,f),m(t,e),m(t,i),m(t,n)},d:function(u){u&&h(t)}};return $("SvelteRegisterBlock",{block:a,id:Gt.name,type:"if",source:"(2825:10) {#if trainingPhase === 'guiding'}",ctx:s}),a}function no(s){let t,e,i="🎵 ドレミ音階ガイド",r,n,a,c,u=lt(s[10]),f=[];for(let v=0;v<u.length;v+=1)f[v]=jt(Nn(s,u,v));let d=s[0]==="guiding"&&Gt(s);const y={c:function(){t=T("div"),e=T("h3"),e.textContent=i,r=Z(),n=T("div"),a=T("div");for(let C=0;C<f.length;C+=1)f[C].c();c=Z(),d&&d.c(),this.h()},l:function(C){t=A(C,"DIV",{class:!0});var p=O(t);e=A(p,"H3",{class:!0,"data-svelte-h":!0}),_e(e)!=="svelte-1mor0as"&&(e.textContent=i),p.forEach(h),r=Y(C),n=A(C,"DIV",{class:!0});var g=O(n);a=A(g,"DIV",{class:!0});var _=O(a);for(let M=0;M<f.length;M+=1)f[M].l(_);_.forEach(h),c=Y(g),d&&d.l(g),g.forEach(h),this.h()},h:function(){x(e,"class","section-title svelte-rt5px1"),I(e,E,2812,10,95848),x(t,"class","card-header svelte-rt5px1"),I(t,E,2811,8,95812),x(a,"class","scale-guide svelte-rt5px1"),I(a,E,2815,10,95951),x(n,"class","card-content svelte-rt5px1"),I(n,E,2814,8,95914)},m:function(C,p){W(C,t,p),m(t,e),W(C,r,p),W(C,n,p),m(n,a);for(let g=0;g<f.length;g+=1)f[g]&&f[g].m(a,null);m(n,c),d&&d.m(n,null)},p:function(C,p){if(p[0]&1024){u=lt(C[10]);let g;for(g=0;g<u.length;g+=1){const _=Nn(C,u,g);f[g]?f[g].p(_,p):(f[g]=jt(_),f[g].c(),f[g].m(a,null))}for(;g<f.length;g+=1)f[g].d(1);f.length=u.length}C[0]==="guiding"?d||(d=Gt(C),d.c(),d.m(n,null)):d&&(d.d(1),d=null)},d:function(C){C&&(h(t),h(r),h(n)),xn(f,C),d&&d.d()}};return $("SvelteRegisterBlock",{block:y,id:no.name,type:"slot",source:'(2811:6) <Card class=\\"main-card\\">',ctx:s}),y}function Ot(s){let t,e,i,r,n,a,c;const u=[so,oo],f=[];function d(g,_){return g[4]&&g[5]?0:g[21]?1:-1}~(t=d(s))&&(e=f[t]=u[t](s));const y=[ao,ro],v=[];function C(g,_){return g[0]==="results"&&g[5]?0:g[0]==="results"&&!g[5]?1:-1}~(r=C(s))&&(n=v[r]=y[r](s));const p={c:function(){e&&e.c(),i=Z(),n&&n.c(),a=je()},l:function(_){e&&e.l(_),i=Y(_),n&&n.l(_),a=je()},m:function(_,M){~t&&f[t].m(_,M),W(_,i,M),~r&&v[r].m(_,M),W(_,a,M),c=!0},p:function(_,M){let w=t;t=d(_),t===w?~t&&f[t].p(_,M):(e&&(Te(),X(f[w],1,1,()=>{f[w]=null}),Ee()),~t?(e=f[t],e?e.p(_,M):(e=f[t]=u[t](_),e.c()),K(e,1),e.m(i.parentNode,i)):e=null);let N=r;r=C(_),r===N?~r&&v[r].p(_,M):(n&&(Te(),X(v[N],1,1,()=>{v[N]=null}),Ee()),~r?(n=v[r],n?n.p(_,M):(n=v[r]=y[r](_),n.c()),K(n,1),n.m(a.parentNode,a)):n=null)},i:function(_){c||(K(e),K(n),c=!0)},o:function(_){X(e),X(n),c=!1},d:function(_){_&&(h(i),h(a)),~t&&f[t].d(_),~r&&v[r].d(_)}};return $("SvelteRegisterBlock",{block:p,id:Ot.name,type:"if",source:"(2836:4) {#if trainingPhase === 'results'}",ctx:s}),p}function oo(s){var c,u;let t=console.log("🔍 [ContinuousMode] CurrentUnifiedScoreData structure:",{sessionHistoryLength:((c=s[21].sessionHistory)==null?void 0:c.length)||0,sessionHistory:((u=s[21].sessionHistory)==null?void 0:u.map(Bn))||[]})+"",e,i,r,n;r=new Kt({props:{scoreData:s[21],showDetails:!1,className:"mb-6 iphone-no-margin",currentScoreData:s[16],intervalData:s[3],consistencyData:s[17],feedbackData:s[18],technicalFeedbackData:s[19],sessionStatistics:s[20]},$$inline:!0});const a={c:function(){e=L(t),i=Z(),ye(r.$$.fragment)},l:function(d){e=z(d,t),i=Y(d),ge(r.$$.fragment,d)},m:function(d,y){W(d,e,y),W(d,i,y),me(r,d,y),n=!0},p:function(d,y){var C,p;(!n||y[0]&2097152)&&t!==(t=console.log("🔍 [ContinuousMode] CurrentUnifiedScoreData structure:",{sessionHistoryLength:((C=d[21].sessionHistory)==null?void 0:C.length)||0,sessionHistory:((p=d[21].sessionHistory)==null?void 0:p.map(Bn))||[]})+"")&&fe(e,t);const v={};y[0]&2097152&&(v.scoreData=d[21]),y[0]&65536&&(v.currentScoreData=d[16]),y[0]&8&&(v.intervalData=d[3]),y[0]&131072&&(v.consistencyData=d[17]),y[0]&262144&&(v.feedbackData=d[18]),y[0]&524288&&(v.technicalFeedbackData=d[19]),y[0]&1048576&&(v.sessionStatistics=d[20]),r.$set(v)},i:function(d){n||(K(r.$$.fragment,d),n=!0)},o:function(d){X(r.$$.fragment,d),n=!1},d:function(d){d&&(h(e),h(i)),de(r,d)}};return $("SvelteRegisterBlock",{block:a,id:oo.name,type:"if",source:"(2864:40) ",ctx:s}),a}function so(s){let t,e,i,r=s[4]&&Ut(s);e=new Kt({props:{scoreData:s[4],showDetails:!1,className:"mb-6 iphone-no-margin",currentScoreData:s[16],intervalData:s[3],consistencyData:s[17],feedbackData:s[18],technicalFeedbackData:s[19],sessionStatistics:s[20]},$$inline:!0});const n={c:function(){r&&r.c(),t=Z(),ye(e.$$.fragment)},l:function(c){r&&r.l(c),t=Y(c),ge(e.$$.fragment,c)},m:function(c,u){r&&r.m(c,u),W(c,t,u),me(e,c,u),i=!0},p:function(c,u){c[4]?r?r.p(c,u):(r=Ut(c),r.c(),r.m(t.parentNode,t)):r&&(r.d(1),r=null);const f={};u[0]&16&&(f.scoreData=c[4]),u[0]&65536&&(f.currentScoreData=c[16]),u[0]&8&&(f.intervalData=c[3]),u[0]&131072&&(f.consistencyData=c[17]),u[0]&262144&&(f.feedbackData=c[18]),u[0]&524288&&(f.technicalFeedbackData=c[19]),u[0]&1048576&&(f.sessionStatistics=c[20]),e.$set(f)},i:function(c){i||(K(e.$$.fragment,c),i=!0)},o:function(c){X(e.$$.fragment,c),i=!1},d:function(c){c&&h(t),r&&r.d(c),de(e,c)}};return $("SvelteRegisterBlock",{block:n,id:so.name,type:"if",source:"(2838:6) {#if $unifiedScoreData && $isCompleted}",ctx:s}),n}function Ut(s){var r,n;let t=console.log("🔍 [ContinuousMode] UnifiedScoreData structure:",{sessionHistoryLength:((r=s[4].sessionHistory)==null?void 0:r.length)||0,sessionHistory:((n=s[4].sessionHistory)==null?void 0:n.map(Pn))||[]})+"",e;const i={c:function(){e=L(t)},l:function(c){e=z(c,t)},m:function(c,u){W(c,e,u)},p:function(c,u){var f,d;u[0]&16&&t!==(t=console.log("🔍 [ContinuousMode] UnifiedScoreData structure:",{sessionHistoryLength:((f=c[4].sessionHistory)==null?void 0:f.length)||0,sessionHistory:((d=c[4].sessionHistory)==null?void 0:d.map(Pn))||[]})+"")&&fe(e,t)},d:function(c){c&&h(e)}};return $("SvelteRegisterBlock",{block:i,id:Ut.name,type:"if",source:"(2840:8) {#if $unifiedScoreData}",ctx:s}),i}function ro(s){let t,e;t=new Ke({props:{class:"main-card bottom-action-card",$$slots:{default:[co]},$$scope:{ctx:s}},$$inline:!0});const i={c:function(){ye(t.$$.fragment)},l:function(n){ge(t.$$.fragment,n)},m:function(n,a){me(t,n,a),e=!0},p:function(n,a){const c={};a[3]&4096&&(c.$$scope={dirty:a,ctx:n}),t.$set(c)},i:function(n){e||(K(t.$$.fragment,n),e=!0)},o:function(n){X(t.$$.fragment,n),e=!1},d:function(n){de(t,n)}};return $("SvelteRegisterBlock",{block:i,id:ro.name,type:"if",source:"(2904:61) ",ctx:s}),i}function ao(s){let t,e;t=new Ke({props:{class:"main-card bottom-action-card",$$slots:{default:[io]},$$scope:{ctx:s}},$$inline:!0});const i={c:function(){ye(t.$$.fragment)},l:function(n){ge(t.$$.fragment,n)},m:function(n,a){me(t,n,a),e=!0},p:function(n,a){const c={};a[0]&32|a[3]&4096&&(c.$$scope={dirty:a,ctx:n}),t.$set(c)},i:function(n){e||(K(t.$$.fragment,n),e=!0)},o:function(n){X(t.$$.fragment,n),e=!1},d:function(n){de(t,n)}};return $("SvelteRegisterBlock",{block:i,id:ao.name,type:"if",source:"(2893:6) {#if trainingPhase === 'results' && $isCompleted}",ctx:s}),i}function co(s){let t,e,i,r,n,a,c="次のセッションを準備中...";const u={c:function(){t=T("div"),e=T("div"),i=T("div"),r=T("div"),n=Z(),a=T("span"),a.textContent=c,this.h()},l:function(d){t=A(d,"DIV",{class:!0});var y=O(t);e=A(y,"DIV",{class:!0});var v=O(e);i=A(v,"DIV",{class:!0});var C=O(i);r=A(C,"DIV",{class:!0}),O(r).forEach(h),n=Y(C),a=A(C,"SPAN",{"data-svelte-h":!0}),_e(a)!=="svelte-11jhwau"&&(a.textContent=c),C.forEach(h),v.forEach(h),y.forEach(h),this.h()},h:function(){x(r,"class","spinner"),I(r,E,2909,16,99432),I(a,E,2910,16,99476),x(i,"class","auto-progress-indicator"),I(i,E,2908,14,99378),x(e,"class","continuous-mode-message"),I(e,E,2907,12,99326),x(t,"class","card-content svelte-rt5px1"),I(t,E,2906,10,99287)},m:function(d,y){W(d,t,y),m(t,e),m(e,i),m(i,r),m(i,n),m(i,a)},p:Et,d:function(d){d&&h(t)}};return $("SvelteRegisterBlock",{block:u,id:co.name,type:"slot",source:'(2906:8) <Card class=\\"main-card bottom-action-card\\">',ctx:s}),u}function io(s){let t,e,i;e=new Jt({props:{isCompleted:s[5],position:"bottom"},$$inline:!0}),e.$on("action",s[29]);const r={c:function(){t=T("div"),ye(e.$$.fragment),this.h()},l:function(a){t=A(a,"DIV",{class:!0});var c=O(t);ge(e.$$.fragment,c),c.forEach(h),this.h()},h:function(){x(t,"class","card-content svelte-rt5px1"),I(t,E,2894,10,98845)},m:function(a,c){W(a,t,c),me(e,t,null),i=!0},p:function(a,c){const u={};c[0]&32&&(u.isCompleted=a[5]),e.$set(u)},i:function(a){i||(K(e.$$.fragment,a),i=!0)},o:function(a){X(e.$$.fragment,a),i=!1},d:function(a){a&&h(t),de(e)}};return $("SvelteRegisterBlock",{block:r,id:io.name,type:"slot",source:'(2894:8) <Card class=\\"main-card bottom-action-card\\">',ctx:s}),r}function lo(s){let t,e,i="⚡ 連続チャレンジモード",r,n,a="中級者向け：8セッション連続で基音が自動再生される集中トレーニング",c,u,f,d,y=uo+"",v,C,p=fo+"",g,_,M,w,N=mo+"",R,S,P,H,b,ee,q=s[1]==="granted"&&!s[25]&&Pt(s);const k=[Gn,jn],j=[];function U(V,B){return V[1]==="granted"?0:1}P=U(s),H=j[P]=k[P](s);const oe={c:function(){t=T("div"),e=T("h1"),e.textContent=i,r=Z(),n=T("p"),n.textContent=a,c=Z(),q&&q.c(),u=Z(),f=T("div"),d=L("📱 "),v=L(y),C=L(" | "),g=L(p),_=T("br"),M=Z(),w=T("small"),R=L(N),S=Z(),H.c(),b=je(),this.h()},l:function(B){t=A(B,"DIV",{class:!0});var te=O(t);e=A(te,"H1",{class:!0,"data-svelte-h":!0}),_e(e)!=="svelte-1nub9gt"&&(e.textContent=i),r=Y(te),n=A(te,"P",{class:!0,"data-svelte-h":!0}),_e(n)!=="svelte-gneggn"&&(n.textContent=a),c=Y(te),q&&q.l(te),u=Y(te),f=A(te,"DIV",{class:!0});var Q=O(f);d=z(Q,"📱 "),v=z(Q,y),C=z(Q," | "),g=z(Q,p),_=A(Q,"BR",{}),M=Y(Q),w=A(Q,"SMALL",{style:!0});var he=O(w);R=z(he,N),he.forEach(h),Q.forEach(h),te.forEach(h),S=Y(B),H.l(B),b=je(),this.h()},h:function(){x(e,"class","page-title svelte-rt5px1"),I(e,E,2650,4,90071),x(n,"class","page-description svelte-rt5px1"),I(n,E,2651,4,90116),I(_,E,2685,72,91370),Fe(w,"font-size","0.6rem"),I(w,E,2686,6,91382),x(f,"class","debug-info svelte-rt5px1"),I(f,E,2684,4,91273),x(t,"class","header-section svelte-rt5px1"),I(t,E,2649,2,90038)},m:function(B,te){W(B,t,te),m(t,e),m(t,r),m(t,n),m(t,c),q&&q.m(t,null),m(t,u),m(t,f),m(f,d),m(f,v),m(f,C),m(f,g),m(f,_),m(f,M),m(f,w),m(w,R),W(B,S,te),j[P].m(B,te),W(B,b,te),ee=!0},p:function(B,te){B[1]==="granted"&&!B[25]?q?(q.p(B,te),te[0]&33554434&&K(q,1)):(q=Pt(B),q.c(),K(q,1),q.m(t,u)):q&&(Te(),X(q,1,1,()=>{q=null}),Ee());let Q=P;P=U(B),P===Q?j[P].p(B,te):(Te(),X(j[Q],1,1,()=>{j[Q]=null}),Ee(),H=j[P],H?H.p(B,te):(H=j[P]=k[P](B),H.c()),K(H,1),H.m(b.parentNode,b))},i:function(B){ee||(K(q),K(H),ee=!0)},o:function(B){X(q),X(H),ee=!1},d:function(B){B&&(h(t),h(S),h(b)),q&&q.d(),j[P].d(B)}};return $("SvelteRegisterBlock",{block:oe,id:lo.name,type:"slot",source:"(2648:0) <PageLayout>",ctx:s}),oe}function Wt(s){let t,e,i;e=new Hn({props:{$$slots:{default:[lo]},$$scope:{ctx:s}},$$inline:!0});const r={c:function(){t=Z(),ye(e.$$.fragment),this.h()},l:function(a){ko("svelte-13kpo59",Mn.head).forEach(h),t=Y(a),ge(e.$$.fragment,a),this.h()},h:function(){Mn.title="連続チャレンジモード - 相対音感トレーニング"},m:function(a,c){W(a,t,c),me(e,a,c),i=!0},p:function(a,c){const u={};c[0]&67108863|c[3]&4096&&(u.$$scope={dirty:c,ctx:a}),e.$set(u)},i:function(a){i||(K(e.$$.fragment,a),i=!0)},o:function(a){X(e.$$.fragment,a),i=!1},d:function(a){a&&h(t),de(e,a)}};return $("SvelteRegisterBlock",{block:r,id:Wt.name,type:"component",source:"",ctx:s}),r}const uo="v2.3.1-ANIMATED",fo="07/29 04:15",mo="🎬 評価分布アニメーション実装・UX向上";function An(){const s=/iPhone/.test(navigator.userAgent),t=/iPad/.test(navigator.userAgent),e=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document;return s||t||e?(console.log("🔊 [RandomTraining] iOS/iPadOS検出 - 音量35dB設定"),35):(console.log("🔊 [RandomTraining] PC検出 - 音量-6dB設定"),-6)}function Xo(){return{mode:"continuous",timestamp:new Date,duration:480,totalNotes:64,measuredNotes:59,averageAccuracy:79,baseNote:"C5",baseFrequency:523.25,sessionHistory:[{grade:"excellent",accuracy:92,baseNote:"C4",baseFrequency:261.63,timestamp:new Date(Date.now()-7*6e4),measuredNotes:8,noteResults:[{name:"ド",note:"ド",frequency:262,detectedFrequency:264,cents:13,grade:"excellent"},{name:"レ",note:"レ",frequency:294,detectedFrequency:291,cents:-18,grade:"good"},{name:"ミ",note:"ミ",frequency:330,detectedFrequency:335,cents:26,grade:"pass"},{name:"ファ",note:"ファ",frequency:349,detectedFrequency:346,cents:-15,grade:"excellent"},{name:"ソ",note:"ソ",frequency:392,detectedFrequency:388,cents:-18,grade:"good"},{name:"ラ",note:"ラ",frequency:440,detectedFrequency:444,cents:16,grade:"good"},{name:"シ",note:"シ",frequency:494,detectedFrequency:499,cents:17,grade:"good"},{name:"ド（高）",note:"ド（高）",frequency:523,detectedFrequency:520,cents:-10,grade:"excellent"}]},{grade:"good",accuracy:78,baseNote:"D4",baseFrequency:293.66,timestamp:new Date(Date.now()-6*6e4),measuredNotes:7,noteResults:[{name:"ド",note:"ド",frequency:294,detectedFrequency:290,cents:-23,grade:"good"},{name:"レ",note:"レ",frequency:330,detectedFrequency:340,cents:53,grade:"needWork"},{name:"ミ",note:"ミ",frequency:370,detectedFrequency:375,cents:23,grade:"good"},{name:"ファ",note:"ファ",frequency:392,detectedFrequency:385,cents:-31,grade:"pass"},{name:"ソ",note:"ソ",frequency:440,detectedFrequency:432,cents:-31,grade:"pass"},{name:"ラ",note:"ラ",frequency:494,detectedFrequency:510,cents:56,grade:"needWork"},{name:"シ",note:"シ",frequency:554,detectedFrequency:null,cents:null,grade:"notMeasured"},{name:"ド（高）",note:"ド（高）",frequency:587,detectedFrequency:580,cents:-21,grade:"good"}]},{grade:"excellent",accuracy:95,baseNote:"E4",baseFrequency:329.63,timestamp:new Date(Date.now()-5*6e4),measuredNotes:8,noteResults:[{name:"ド",note:"ド",frequency:330,detectedFrequency:332,cents:10,grade:"excellent"},{name:"レ",note:"レ",frequency:370,detectedFrequency:368,cents:-9,grade:"excellent"},{name:"ミ",note:"ミ",frequency:415,detectedFrequency:418,cents:12,grade:"excellent"},{name:"ファ",note:"ファ",frequency:440,detectedFrequency:436,cents:-16,grade:"good"},{name:"ソ",note:"ソ",frequency:494,detectedFrequency:497,cents:11,grade:"excellent"},{name:"ラ",note:"ラ",frequency:554,detectedFrequency:551,cents:-9,grade:"excellent"},{name:"シ",note:"シ",frequency:622,detectedFrequency:625,cents:8,grade:"excellent"},{name:"ド（高）",note:"ド（高）",frequency:659,detectedFrequency:655,cents:-10,grade:"excellent"}]},{grade:"needWork",accuracy:45,baseNote:"F4",baseFrequency:349.23,timestamp:new Date(Date.now()-4*6e4),measuredNotes:6,noteResults:[{name:"ド",note:"ド",frequency:349,detectedFrequency:345,cents:-20,grade:"good"},{name:"レ",note:"レ",frequency:392,detectedFrequency:420,cents:124,grade:"needWork"},{name:"ミ",note:"ミ",frequency:440,detectedFrequency:435,cents:-20,grade:"good"},{name:"ファ",note:"ファ",frequency:466,detectedFrequency:520,cents:195,grade:"needWork"},{name:"ソ",note:"ソ",frequency:523,detectedFrequency:410,cents:-455,grade:"needWork"},{name:"ラ",note:"ラ",frequency:587,detectedFrequency:null,cents:null,grade:"notMeasured"},{name:"シ",note:"シ",frequency:659,detectedFrequency:650,cents:-24,grade:"good"},{name:"ド（高）",note:"ド（高）",frequency:698,detectedFrequency:null,cents:null,grade:"notMeasured"}]},{grade:"good",accuracy:85,baseNote:"G4",baseFrequency:392,timestamp:new Date(Date.now()-3*6e4),measuredNotes:8,noteResults:[{name:"ド",note:"ド",frequency:392,detectedFrequency:395,cents:13,grade:"excellent"},{name:"レ",note:"レ",frequency:440,detectedFrequency:438,cents:-8,grade:"excellent"},{name:"ミ",note:"ミ",frequency:494,detectedFrequency:500,cents:21,grade:"good"},{name:"ファ",note:"ファ",frequency:523,detectedFrequency:520,cents:-10,grade:"excellent"},{name:"ソ",note:"ソ",frequency:587,detectedFrequency:595,cents:24,grade:"good"},{name:"ラ",note:"ラ",frequency:659,detectedFrequency:665,cents:16,grade:"good"},{name:"シ",note:"シ",frequency:740,detectedFrequency:755,cents:35,grade:"pass"},{name:"ド（高）",note:"ド（高）",frequency:784,detectedFrequency:780,cents:-9,grade:"excellent"}]},{grade:"excellent",accuracy:94,baseNote:"A4",baseFrequency:440,timestamp:new Date(Date.now()-2*6e4),measuredNotes:8,noteResults:[{name:"ド",note:"ド",frequency:440,detectedFrequency:442,cents:8,grade:"excellent"},{name:"レ",note:"レ",frequency:494,detectedFrequency:492,cents:-7,grade:"excellent"},{name:"ミ",note:"ミ",frequency:554,detectedFrequency:558,cents:12,grade:"excellent"},{name:"ファ",note:"ファ",frequency:587,detectedFrequency:585,cents:-6,grade:"excellent"},{name:"ソ",note:"ソ",frequency:659,detectedFrequency:665,cents:16,grade:"good"},{name:"ラ",note:"ラ",frequency:740,detectedFrequency:738,cents:-5,grade:"excellent"},{name:"シ",note:"シ",frequency:831,detectedFrequency:840,cents:19,grade:"good"},{name:"ド（高）",note:"ド（高）",frequency:880,detectedFrequency:882,cents:4,grade:"excellent"}]},{grade:"pass",accuracy:68,baseNote:"Bb4",baseFrequency:466.16,timestamp:new Date(Date.now()-1*6e4),measuredNotes:7,noteResults:[{name:"ド",note:"ド",frequency:466,detectedFrequency:470,cents:15,grade:"excellent"},{name:"レ",note:"レ",frequency:523,detectedFrequency:535,cents:39,grade:"pass"},{name:"ミ",note:"ミ",frequency:587,detectedFrequency:600,cents:38,grade:"pass"},{name:"ファ",note:"ファ",frequency:622,detectedFrequency:615,cents:-19,grade:"good"},{name:"ソ",note:"ソ",frequency:698,detectedFrequency:720,cents:54,grade:"needWork"},{name:"ラ",note:"ラ",frequency:784,detectedFrequency:null,cents:null,grade:"notMeasured"},{name:"シ",note:"シ",frequency:880,detectedFrequency:895,cents:29,grade:"pass"},{name:"ド（高）",note:"ド（高）",frequency:932,detectedFrequency:925,cents:-13,grade:"excellent"}]},{grade:"good",accuracy:82,baseNote:"C5",baseFrequency:523.25,timestamp:new Date,measuredNotes:8,noteResults:[{name:"ド",note:"ド",frequency:523,detectedFrequency:526,cents:10,grade:"excellent"},{name:"レ",note:"レ",frequency:587,detectedFrequency:584,cents:-9,grade:"excellent"},{name:"ミ",note:"ミ",frequency:659,detectedFrequency:665,cents:16,grade:"good"},{name:"ファ",note:"ファ",frequency:698,detectedFrequency:692,cents:-15,grade:"excellent"},{name:"ソ",note:"ソ",frequency:784,detectedFrequency:795,cents:24,grade:"good"},{name:"ラ",note:"ラ",frequency:880,detectedFrequency:890,cents:19,grade:"good"},{name:"シ",note:"シ",frequency:988,detectedFrequency:1010,cents:38,grade:"pass"},{name:"ド（高）",note:"ド（高）",frequency:1047,detectedFrequency:1042,cents:-8,grade:"excellent"}]}]}}function At(s){return[{scale:"ド",interval:"unison",intervalName:"ユニゾン"},{scale:"レ",interval:"major_second",intervalName:"長2度"},{scale:"ミ",interval:"major_third",intervalName:"長3度"},{scale:"ファ",interval:"perfect_fourth",intervalName:"完全4度"},{scale:"ソ",interval:"perfect_fifth",intervalName:"完全5度"},{scale:"ラ",interval:"major_sixth",intervalName:"長6度"},{scale:"シ",interval:"major_seventh",intervalName:"長7度"},{scale:"ド（高）",interval:"octave",intervalName:"オクターブ"}].map((e,i)=>{const r=s.find(n=>n.targetNote&&n.targetNote.includes(e.scale))||s[i];if(r&&r.accuracy!=="notMeasured"){const n=parseFloat(r.accuracy)||0,a=Math.round((100-n)*.5);return{type:e.interval,scale:e.scale,intervalName:e.intervalName,attempts:1,averageError:a,accuracy:n}}else return{type:e.interval,scale:e.scale,intervalName:e.intervalName,attempts:0,averageError:null,accuracy:0}})}function Tn(s){if(!s||!Array.isArray(s))return console.warn("⚠️ [RandomTraining] sessionHistory が無効です"),[];const t=[{type:"unison",scale:"ド",intervalName:"ユニゾン",noteIndex:0},{type:"major_second",scale:"レ",intervalName:"長2度",noteIndex:1},{type:"major_third",scale:"ミ",intervalName:"長3度",noteIndex:2},{type:"perfect_fourth",scale:"ファ",intervalName:"完全4度",noteIndex:3},{type:"perfect_fifth",scale:"ソ",intervalName:"完全5度",noteIndex:4},{type:"major_sixth",scale:"ラ",intervalName:"長6度",noteIndex:5},{type:"major_seventh",scale:"シ",intervalName:"長7度",noteIndex:6},{type:"octave",scale:"ド（高）",intervalName:"オクターブ",noteIndex:7}],e={};return t.forEach(i=>{e[i.type]={type:i.type,scale:i.scale,intervalName:i.intervalName,attempts:0,successCount:0,accuracySum:0,accuracyValues:[],errorValues:[]}}),s.forEach(i=>{!i.noteResults||!Array.isArray(i.noteResults)||i.noteResults.forEach((r,n)=>{if(n>=t.length)return;const a=t[n].type,c=e[a];if(c.attempts++,r.accuracy!=="notMeasured"&&typeof r.accuracy=="number"){c.accuracyValues.push(r.accuracy),c.accuracySum+=r.accuracy;const u=Math.round((100-r.accuracy)*.5);c.errorValues.push(u),r.accuracy>=70&&c.successCount++}})}),t.map(i=>{const r=e[i.type];if(r.attempts===0)return{type:i.type,scale:i.scale,intervalName:i.intervalName,attempts:0,averageError:null,accuracy:0};const n=r.accuracyValues.length>0?Math.round(r.accuracySum/r.accuracyValues.length):0,a=r.errorValues.length>0?Math.round(r.errorValues.reduce((u,f)=>u+f,0)/r.errorValues.length):null,c=r.accuracyValues.length>0?Math.round(r.successCount/r.accuracyValues.length*100):0;return{type:i.type,scale:i.scale,intervalName:i.intervalName,mastery:c,attempts:r.attempts,averageError:a,accuracy:n}})}function En(s){const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(s<=0)return"ーー";const i=Math.round(12*Math.log2(s/440)),r=(i+9+120)%12,n=Math.floor((i+9)/12)+4;return t[r]+n}function Tt(s,t){const e=[{factor:4,freq:s*4,description:"2オクターブ上"},{factor:3,freq:s*3,description:"1.5オクターブ上"},{factor:2.5,freq:s*2.5,description:"1.3オクターブ上"},{factor:2,freq:s*2,description:"1オクターブ上"},{factor:1.5,freq:s*1.5,description:"0.5オクターブ上"},{factor:1,freq:s,description:"補正なし"},{factor:.75,freq:s*.75,description:"0.33オクターブ下"},{factor:.67,freq:s*.67,description:"0.5オクターブ下"},{factor:.5,freq:s*.5,description:"1オクターブ下"},{factor:.4,freq:s*.4,description:"1.3オクターブ下"},{factor:.33,freq:s*.33,description:"1.5オクターブ下"},{factor:.25,freq:s*.25,description:"2オクターブ下"}];let i=null,r=1/0;const n=t*.5,a=t*1.5,c=e.filter(u=>u.freq>=n&&u.freq<=a);for(const u of c){const f=Math.abs(u.freq-t);f<r&&(r=f,i=u)}if(!i)for(const u of e){const f=Math.abs(u.freq-t);f<r&&(r=f,i=u)}return i?{correctedFrequency:i.freq,factor:i.factor,description:i.description,error:r}:{correctedFrequency:s,factor:1,description:"補正なし（フォールバック）",error:Math.abs(s-t)}}function ot(){try{"scrollTo"in window&&"behavior"in document.documentElement.style?window.scrollTo({top:0,behavior:"smooth"}):window.scrollTo(0,0),document.body&&(document.body.scrollTop=0),document.documentElement&&(document.documentElement.scrollTop=0),document.querySelectorAll("[data-scroll-container], .scroll-container, main").forEach(t=>{t.scrollTo?t.scrollTo(0,0):t.scrollTop=0})}catch(s){console.warn("スクロールエラー:",s);try{window.scroll(0,0)}catch(t){console.error("スクロール完全失敗:",t)}}}function go(s){}const Pn=(s,t)=>{var e;return{index:t,sessionId:s.sessionId,baseNote:s.baseNote,hasNoteResults:!!s.noteResults,noteResultsLength:((e=s.noteResults)==null?void 0:e.length)||0,accuracy:s.accuracy}},Bn=(s,t)=>{var e;return{index:t,sessionId:s.sessionId,baseNote:s.baseNote,hasNoteResults:!!s.noteResults,noteResultsLength:((e=s.noteResults)==null?void 0:e.length)||0,accuracy:s.accuracy}};function Yo(s,t,e){let i,r,n,a,c,u,f,d,y,v,C,p;Ie(Mt,"currentSessionId"),Ae(s,Mt,o=>e(23,n=o)),Ie(Dt,"unifiedScoreData"),Ae(s,Dt,o=>e(4,a=o)),Ie(Ct,"isCompleted"),Ae(s,Ct,o=>e(5,c=o)),Ie(_t,"page"),Ae(s,_t,o=>e(54,u=o)),Ie(qt,"remainingSessions"),Ae(s,qt,o=>e(55,f=o)),Ie(Ft,"nextBaseName"),Ae(s,Ft,o=>e(56,d=o)),Ie(Rt,"nextBaseNote"),Ae(s,Rt,o=>e(57,y=o)),Ie(wt,"sessionHistory"),Ae(s,wt,o=>e(24,v=o)),Ie(Nt,"trainingProgress"),Ae(s,Nt,o=>e(58,C=o)),Ie(kt,"isLoading"),Ae(s,kt,o=>e(25,p=o));let{$$slots:g={},$$scope:_}=t;Co("Page",g,[]);function M(o){return nt.evaluateOverall(o)}let w="setup",N=typeof window<"u"?new URLSearchParams(window.location.search).get("from")==="microphone-test"?(ie.info("[RandomTraining] マイクテストページからの遷移を検出"),"granted"):(ie.info("[RandomTraining] ダイレクトアクセスを検出"),"checking"):"checking",R=!0,S=[];const P=["ド","レ","ミ","ファ","ソ","ラ","シ","ド（高）"];let H="",b=0,ee=!1,q=0,k=P.map(o=>({name:o,state:"inactive",completed:!1})),j=null,U=!1,oe=0,V=!1,B=null,te=!1,Q=[],he=[],be=0,Pe=0,Ge="ーー",Ve=0,ze={correctCount:0,totalCount:8,averageAccuracy:0,averageTime:0,isCompleted:!1},Ce=null,Le={totalScore:0,grade:"C",componentScores:{pitchAccuracy:0,recognitionSpeed:0,intervalMastery:0,directionAccuracy:0,consistency:0}},ke=[],Be=[],Oe={},Xe={},Re={totalAttempts:0,successRate:0,averageScore:0,bestScore:0,sessionDuration:0,streakCount:0,fatigueLevel:"fresh",mostDifficultInterval:"-",mostSuccessfulInterval:"-",averageResponseTime:0,sessionStart:Date.now()},ft="intervals",ae=[],ue=null,pe=null,Me=!0,ne=null,xe=null,st=null,rt=null,Qe=null;const Ue=[{note:"C4",name:"ド（中）",frequency:261.63,semitonesFromC:0},{note:"Db4",name:"ド#（中）",frequency:277.18,semitonesFromC:1},{note:"D4",name:"レ（中）",frequency:293.66,semitonesFromC:2},{note:"Eb4",name:"レ#（中）",frequency:311.13,semitonesFromC:3},{note:"E4",name:"ミ（中）",frequency:329.63,semitonesFromC:4},{note:"F4",name:"ファ（中）",frequency:349.23,semitonesFromC:5},{note:"Gb4",name:"ファ#（中）",frequency:369.99,semitonesFromC:6},{note:"Ab4",name:"ラb（中）",frequency:415.3,semitonesFromC:8},{note:"Bb3",name:"シb（低）",frequency:233.08,semitonesFromC:-2},{note:"B3",name:"シ（低）",frequency:246.94,semitonesFromC:-1}];async function We(){var o;e(1,N="checking");try{if(console.log("🎤 [RandomTraining] AudioManager経由でマイク許可確認開始"),!((o=navigator.mediaDevices)!=null&&o.getUserMedia)){e(1,N="error");return}const l=await Je.initialize();st=l.audioContext,xe=l.mediaStream,rt=l.sourceNode,console.log("✅ [RandomTraining] AudioManager リソース取得完了"),e(1,N="granted"),e(0,w="setup"),setTimeout(async()=>{if(ne){ie.audio("[RandomTraining] PitchDetector初期化開始");const D=/iPhone/.test(navigator.userAgent),F=/iPad/.test(navigator.userAgent),G=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document;(F||G)&&(console.log("🔧 [RandomTraining] iPad検出 - マイク感度7.0x自動設定開始"),Je.setSensitivity(7),console.log("✅ [RandomTraining] iPad マイク感度7.0x自動設定完了"));try{console.log("🎤 [RandomTraining] AudioManager再初期化開始（iPad対応）"),await Je.initialize(),console.log("✅ [RandomTraining] AudioManager再初期化完了")}catch(J){console.warn("⚠️ AudioManager再初期化エラー:",J)}await ne.initialize(),ie.audio("[RandomTraining] PitchDetector初期化完了")}},200)}catch(l){ie.error("[RandomTraining] マイク許可エラー:",l),e(1,N=(l==null?void 0:l.name)==="NotAllowedError"?"denied":"error")}}function dt(){const o=y,l=d,D=Ue.find(F=>F.note===o)||Ue.find(F=>F.name===l)||Ue[0];if(e(7,H=D.name),e(8,b=D.frequency),ie.info(`[BaseNote] 基音設定（localStorage連携）: ${H} = ${b}Hz`),ie.info(`[BaseNote] localStorage基音情報: note=${o}, name=${l}`),!b||b<=0)throw ie.error("[BaseNote] 基音周波数設定エラー:",D),new Error(`Invalid base frequency: ${b}`)}async function Qt(){if(ee||!pe||Me)return;if(N!=="granted"){console.log("🎤 [RandomTraining] マイク許可が必要です。許可取得を開始...");try{await We(),console.log("🎤 [RandomTraining] マイク許可取得完了")}catch(l){console.error("❌ マイク許可エラー:",l);return}}if(!xe&&N==="granted"){console.log("🎤 [RandomTraining] AudioManagerリソース未初期化のため取得します");try{await We()}catch(l){console.error("❌ AudioManagerリソース初期化エラー:",l);return}}else xe&&console.log("🎤 [RandomTraining] AudioManagerリソース既存のため再利用");e(9,ee=!0),e(0,w="listening"),Qe=Date.now(),dt();const o=Ue.find(l=>l.name===H).note;pe.triggerAttackRelease(o,2,It(),.7),setTimeout(()=>{e(9,ee=!1),e(0,w="waiting"),setTimeout(()=>gt(),500)},2e3)}async function Xt(){if(ee||!pe||p||!H)return;if(N!=="granted"){console.log("🎤 [RandomTraining] マイク許可が必要です。許可取得を開始...");try{await We(),console.log("🎤 [RandomTraining] マイク許可取得完了")}catch(l){console.error("❌ マイク許可エラー:",l);return}}if(!xe&&N==="granted"){console.log("🎤 [RandomTraining] AudioManagerリソース未初期化のため取得します");try{await We()}catch(l){console.error("❌ AudioManagerリソース初期化エラー:",l);return}}else xe&&console.log("🎤 [RandomTraining] AudioManagerリソース既存のため再利用");if(e(9,ee=!0),e(0,w="listening"),Qe=Date.now(),typeof window<"u"&&window.Tone){const l=window.Tone.context||window.Tone.getContext();l&&l.state==="suspended"&&(console.log("🔄 [RandomTraining] AudioContext suspended検出 - 再開中..."),await l.resume(),console.log("✅ [RandomTraining] AudioContext再開完了"))}const o=Ue.find(l=>l.name===H).note;pe.triggerAttackRelease(o,2,It(),.7),setTimeout(()=>{e(9,ee=!1),e(0,w="waiting"),setTimeout(()=>gt(),500)},2e3)}async function yo(){if(ee||!pe||p||!H){console.log("🔄 [BaseNoteOnly] 再生条件未満: isPlaying:",ee,"sampler:",!!pe,"isLoading:",p,"currentBaseNote:",H);return}if(console.log("🎵 [BaseNoteOnly] 基音のみ再生開始:",H),typeof window<"u"&&window.Tone){const l=window.Tone.context||window.Tone.getContext();l&&l.state==="suspended"&&(console.log("🔄 [BaseNoteOnly] AudioContext suspended検出 - 再開中..."),await l.resume(),console.log("✅ [BaseNoteOnly] AudioContext再開完了"))}const o=Ue.find(l=>l.name===H).note;pe.triggerAttackRelease(o,1.5,It(),.7),console.log("🎵 [BaseNoteOnly] 基音再生完了:",o)}function mt(){H&&b>0?Xt():Qt(),Yt()}function Yt(){B&&clearInterval(B),e(11,oe=0),V=!0,e(12,te=!1),console.log("🎵 [GuideStartBar] ガイドスタートバー開始"),B=setInterval(()=>{e(11,oe+=2.5),oe>=100&&(e(11,oe=100),e(12,te=!0),console.log("🎵 [GuideStartBar] ガイド開始タイミング！"),setTimeout(()=>{V=!1,e(12,te=!1),e(11,oe=0)},800),clearInterval(B),B=null)},50)}function ho(){B&&(clearInterval(B),B=null),V=!1,e(12,te=!1),e(11,oe=0)}function Ye(o,l){const F=[0,2,4,5,7,9,11,12][l],G=o*Math.pow(2,F/12);return ie.debug(`[calculateExpectedFrequency] ${k[l].name}: 基音${o.toFixed(1)}Hz + ${F}半音 = ${G.toFixed(1)}Hz`),G}function Zt(o,l){return Ye(o,l)}function gt(){e(0,w="guiding"),q=0,U=!0,Q=[],console.log(`🎬 ガイド開始: ${H} (${b.toFixed(1)}Hz)`);function o(){if(q<k.length){q>0&&e(10,k[q-1].state="inactive",k),e(10,k[q].state="active",k);const l=Zt(b,q);St.setScaleContext({baseFrequency:b,currentScale:k[q].name,targetFrequency:l}),console.log(`🎵 [Scale] 基音:${H}(${b.toFixed(0)}Hz) 現在:${k[q].name} 目標:${l.toFixed(0)}Hz`),q>=4&&console.log(`🔍 [デバッグ] Step ${q}: currentBaseFrequency=${b}, currentBaseNote='${H}'`),q++,j=setTimeout(()=>{o()},600)}else $t()}o()}function $t(){U=!1,console.log(`🏁 ガイド完了: ${Q.length}/${k.length}ステップ評価`),k.length>0&&e(10,k[k.length-1].state="inactive",k),ne&&ne.stopDetection(),St.clearContext(),en(),rn(),yn(),ae=P.map(o=>{const l=Q.find(D=>D.stepName===o);return l?{name:l.stepName,cents:l.adjustedFrequency?Math.round(l.centDifference):null,targetFreq:l.expectedFrequency,detectedFreq:l.adjustedFrequency||null,diff:l.adjustedFrequency?l.adjustedFrequency-l.expectedFrequency:null,accuracy:l.accuracy}:{name:o,cents:null,targetFreq:null,detectedFreq:null,diff:null,accuracy:"notMeasured"}}),cn(),un(),e(0,w="results")}function en(){let o=0,l=0;Q.forEach((G,J)=>{G.isCorrect&&o++,l+=G.accuracy});const D=Q.length>0?Math.round(l/Q.length):0,F=Math.round(o/k.length*100);ze={correctCount:o,totalCount:k.length,averageAccuracy:D,averageTime:0,isCompleted:!0},console.log(`🎯 結果: ${o}/${k.length}正解 (${F}%) 平均精度${D}%`),Q.length>0&&(he=[...Q])}function po(){switch(w){case"setup":return Me||!pe?"🎵 音源読み込み中...":"🎤 マイク準備完了 - トレーニング開始可能";case"listening":return"🎵 基音再生中...";case"waiting":return"⏳ 間もなく開始...";case"guiding":return"🎙️ ガイドに合わせてドレミファソラシドを歌ってください";case"results":return"🎉 採点結果";default:return"🔄 準備中..."}}function vo(){return Q.length>0?Q:he.length>0?he:[]}function tn(){vt(`${it}/microphone-test`)}function Ze(){vt(`${it}/`)}async function nn(){try{e(34,Me=!0),e(33,pe=new Uo({urls:{C4:"C4.mp3"},baseUrl:`${it}/audio/piano/`,release:1.5,volume:An(),onload:()=>{e(34,Me=!1)},onerror:G=>{console.error("❌ Salamander Piano音源読み込みエラー:",G),e(34,Me=!1)}}).toDestination());const o=/iPhone/.test(navigator.userAgent),l=/iPad/.test(navigator.userAgent),D=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document,F=o||l||D;console.log(l?"🔍 [RandomTraining] iPad検出:":D?"🔍 [RandomTraining] iPadOS検出:":o?"🔍 [RandomTraining] iPhone検出:":"🔍 [RandomTraining] その他デバイス検出:",navigator.userAgent),console.log("🔊 [RandomTraining] 音量設定維持: 35dB")}catch(o){console.error("サンプラー初期化エラー:",o),e(34,Me=!1)}}async function at(){try{(await navigator.permissions.query({name:"microphone"})).state==="granted"?await We():e(1,N="denied")}catch{e(1,N="denied")}}function on(){try{Ce=new Rn,ie.info("[RandomTraining] 採点エンジン初期化完了")}catch(o){ie.error("[RandomTraining] 採点エンジン初期化エラー:",o)}}function sn(o,l){if(!Ce||!U)return;const D=q-1;if(D<0||D>=k.length)return;const F=Ye(b,D),G={baseFrequency:b,targetFrequency:F,detectedFrequency:o,detectedNote:l,volume:be,timestamp:Date.now(),scaleIndex:D,scaleName:k[D].name};try{Ce.processAttempt(G)}catch(J){ie.error("[RandomTraining] 採点エンジンエラー:",J)}}function rn(){if(!Ce){ie.error("[RandomTraining] 採点エンジンが初期化されていません"),an();return}try{const o=Ce.generateDetailedReport();e(16,Le={totalScore:o.totalScore,grade:o.grade,componentScores:o.componentScores}),o.intervalAnalysis&&o.intervalAnalysis.masteryLevels?e(3,ke=Object.entries(o.intervalAnalysis.masteryLevels).map(([l,D])=>{var F,G;return{type:l,mastery:Math.round(D),attempts:((F=o.intervalAnalysis.attemptCounts)==null?void 0:F[l])||0,accuracy:((G=o.intervalAnalysis.accuracyRates)==null?void 0:G[l])||0}})):(console.warn("⚠️ [RandomTraining] intervalAnalysis.masteryLevels が未定義です"),e(3,ke=[])),o.consistencyHistory&&Array.isArray(o.consistencyHistory)?e(17,Be=o.consistencyHistory.map((l,D)=>({score:Math.round(l),timestamp:Date.now()-(o.consistencyHistory.length-D)*1e3}))):(console.warn("⚠️ [RandomTraining] consistencyHistory が未定義または配列ではありません"),e(17,Be=[])),e(18,Oe=o.feedback||{primary:"採点結果を生成中です...",detailed:[],suggestions:[]}),e(20,Re={totalAttempts:o.totalAttempts||0,successRate:o.successRate||0,averageScore:o.totalScore||0,bestScore:Math.max(o.totalScore||0,Re.bestScore||0),sessionDuration:Math.round((Date.now()-Re.sessionStart)/6e4)||0,streakCount:o.streak||0,fatigueLevel:o.fatigueLevel||"normal",mostDifficultInterval:o.mostDifficultInterval||"-",mostSuccessfulInterval:o.mostSuccessfulInterval||"-",averageResponseTime:o.averageResponseTime||0}),ie.info("[RandomTraining] 採点結果生成完了:",Le)}catch(o){ie.error("[RandomTraining] 採点結果生成エラー:",o)}}function an(){ie.info("[RandomTraining] テストデータで採点結果を生成"),e(16,Le={totalScore:78,grade:"B+",componentScores:{pitchAccuracy:82,recognitionSpeed:75,intervalMastery:80,directionAccuracy:85,consistency:70}}),e(3,ke=[{type:"unison",mastery:95,attempts:8,accuracy:98},{type:"major_second",mastery:82,attempts:8,accuracy:85},{type:"major_third",mastery:78,attempts:8,accuracy:80},{type:"perfect_fourth",mastery:65,attempts:8,accuracy:68},{type:"perfect_fifth",mastery:88,attempts:8,accuracy:90},{type:"major_sixth",mastery:72,attempts:8,accuracy:75},{type:"major_seventh",mastery:58,attempts:8,accuracy:62},{type:"octave",mastery:92,attempts:8,accuracy:94}]),e(17,Be=[{score:65,timestamp:Date.now()-42e4},{score:72,timestamp:Date.now()-36e4},{score:68,timestamp:Date.now()-3e5},{score:75,timestamp:Date.now()-24e4},{score:78,timestamp:Date.now()-18e4},{score:82,timestamp:Date.now()-12e4},{score:80,timestamp:Date.now()-6e4},{score:85,timestamp:Date.now()}]),e(18,Oe={type:"improvement",primary:"良い進歩が見られます！",summary:"音程の認識精度が向上しています。特に完全5度とオクターブの習得度が高く、基本的な音感が身についてきています。",details:[{category:"strengths",text:"ユニゾンとオクターブの認識がほぼ完璧です"},{category:"strengths",text:"完全5度の安定性が優秀です"},{category:"improvements",text:"完全4度の練習をもう少し増やしましょう"},{category:"improvements",text:"長7度の認識精度を向上させましょう"},{category:"tips",text:"4度は「ソーファー」の音程です"},{category:"practice",text:"毎日15分の継続練習を心がけましょう"}],nextSteps:["完全4度の集中練習を行いましょう","連続チャレンジモードで実践練習を","1日15分の継続練習を心がけましょう"],motivation:"継続は力なり！あなたの相対音感は確実に向上しています！"}),e(20,Re={totalAttempts:32,successRate:68.8,averageScore:78,bestScore:85,sessionDuration:8,streakCount:4,fatigueLevel:"normal",mostDifficultInterval:"完全4度",mostSuccessfulInterval:"ユニゾン",averageResponseTime:2.1,sessionStart:Date.now()-48e4}),ie.info("[RandomTraining] テスト採点結果生成完了")}function _o(o){ft=o}function cn(){if(!ae||ae.length===0){console.warn("[UnifiedScore] noteResultsForDisplay が空です");return}const o=ae.filter(se=>se.accuracy!=="notMeasured").length,l=ae.length,D=ae.filter(se=>se.accuracy!=="notMeasured"&&typeof se.accuracy=="number").map(se=>se.accuracy),F=D.length>0?Math.round(D.reduce((se,Ne)=>se+Ne,0)/D.length):0,G=H||"Unknown",J=b||0,ce=ae.map(se=>({name:se.name,note:se.note||se.name,frequency:se.targetFreq||se.expectedFrequency,detectedFrequency:se.detectedFreq,cents:se.cents,grade:nt.evaluateNote(se.cents),targetFreq:se.targetFreq,diff:se.diff})),le=C,re=(le==null?void 0:le.sessionHistory)||[],qe={timestamp:new Date,baseNote:G,baseFrequency:J,noteResults:ce,measuredNotes:o,accuracy:F,grade:nt.evaluateSession(ae)},He=[...re,qe];e(21,ue={mode:"continuous",timestamp:new Date,duration:60,totalNotes:l,measuredNotes:o,averageAccuracy:F,baseNote:G,baseFrequency:J,noteResults:ce,distribution:nt.calculateDistribution(ae),sessionHistory:He,unifiedGrade:M(He)}),console.log("[UnifiedScore] 統合採点データ生成完了（完全版）:",ue),ln()}async function ln(){if(!ae||ae.length===0){console.warn("📊 [SessionStorage] 保存データなし");return}try{console.log("📊 [SessionStorage] セッション結果保存開始");const o=ae.map(J=>({name:J.name,cents:J.cents,targetFreq:J.targetFreq||J.expectedFrequency,detectedFreq:J.detectedFreq,diff:J.diff,accuracy:typeof J.accuracy=="number"?J.accuracy:0})),l=Qe?Math.round((Date.now()-Qe)/1e3):60;await Fn(o,l,y,d)?(console.log("📊 [SessionStorage] セッション結果保存完了"),console.log("📊 [SessionStorage] 保存後の状況:",{currentSession:n,totalSessions:v.length,isCompleted:c,nextBaseNote:y,nextBaseName:d})):console.error("📊 [SessionStorage] セッション結果保存失敗")}catch(o){console.error("📊 [SessionStorage] セッション保存エラー:",o)}}async function un(){try{if(Ce){const o=v||[];for(const[D,F]of o.entries())if(F.noteResults&&F.noteResults.length>0){const G=F.baseFrequency||262;for(const J of F.noteResults)J.detectedFreq&&J.targetFreq&&await Ce.analyzePerformance({baseFreq:G,targetFreq:J.targetFreq,detectedFreq:J.detectedFreq,responseTime:2e3,volume:50,harmonicCorrection:null})}const l=Ce.generateDetailedReport();e(16,Le={totalScore:l.totalScore||0,grade:l.grade||"C",componentScores:l.componentScores||{accuracy:0,speed:0,consistency:0}}),l.intervalAnalysis&&l.intervalAnalysis.masteryLevels?e(3,ke=Object.entries(l.intervalAnalysis.masteryLevels).map(([D,F])=>{var G;return{type:D,mastery:Math.round(F),attempts:((G=l.intervalAnalysis.attemptCounts)==null?void 0:G[D])||0,accuracy:Math.round(F*.9)}})):e(3,ke=At(ae)),l.consistencyHistory&&Array.isArray(l.consistencyHistory)?e(17,Be=l.consistencyHistory.map((D,F)=>({score:Math.round(D),timestamp:Date.now()-(l.consistencyHistory.length-F)*1e3}))):e(17,Be=ht(ae)),e(18,Oe=pt(ae)||l.feedback),console.log("🎯 [generateEnhancedScoringData] 技術分析結果生成を開始"),console.log("🎯 [generateEnhancedScoringData] results:",l),e(19,Xe=fn(l)),console.log("🎯 [generateEnhancedScoringData] technicalFeedbackData結果:",Xe),e(20,Re={totalAttempts:l.totalAttempts||ae.length,successRate:l.successRate||ae.filter(D=>D.accuracy!=="notMeasured").length/ae.length*100,averageScore:l.totalScore||(ue==null?void 0:ue.averageAccuracy)||0,bestScore:Math.max(l.totalScore||0,Re.bestScore||0),sessionDuration:Math.round(60),streakCount:l.streak||0,fatigueLevel:l.fatigueLevel||"normal",mostDifficultInterval:l.mostDifficultInterval||"未特定",mostSuccessfulInterval:l.mostSuccessfulInterval||"未特定",averageResponseTime:l.averageResponseTime||2.5,sessionStart:Date.now()-6e4})}else yt();console.log("[EnhancedScoring] 追加採点データ生成完了")}catch(o){console.error("[EnhancedScoring] データ生成エラー:",o),yt()}}function yt(){const o=ae.filter(D=>D.accuracy!=="notMeasured"),l=(ue==null?void 0:ue.averageAccuracy)||0;e(16,Le={totalScore:Math.round(l*.8),grade:l>=90?"A":l>=80?"B":l>=70?"C":"D",componentScores:{accuracy:l,speed:85,consistency:Math.max(60,l-10)}}),e(3,ke=At(ae)),e(17,Be=ht()),e(18,Oe=pt(ae)),e(20,Re={totalAttempts:ae.length,successRate:o.length/ae.length*100,averageScore:l,bestScore:l,sessionDuration:60,streakCount:0,fatigueLevel:"normal",mostDifficultInterval:"未分析",mostSuccessfulInterval:"未分析",averageResponseTime:2.5,sessionStart:Date.now()-6e4})}function ht(o){const l=(ue==null?void 0:ue.averageAccuracy)||70;return Array.from({length:8},(D,F)=>({score:Math.max(30,Math.min(100,l+(Math.random()-.5)*20)),timestamp:Date.now()-(8-F)*7500}))}function pt(o){const l=o.filter(et=>et.accuracy!=="notMeasured").length,D=(ue==null?void 0:ue.averageAccuracy)||0,F=8,G=v||[],J=G.length,ce={type:"info",categories:[{name:"音程精度",icon:"Target",score:D,message:`${D}%の精度で音程を捉えています`},{name:"測定成功率",icon:"Mic",score:Math.round(l/o.length*100),message:`${o.length}音中${l}音を正常に測定`}]};if(J<F)return ce;let le,re,qe;const He=(ue==null?void 0:ue.unifiedGrade)||"E",se=G.length;let Ne=0,ve=0,Se=0;G.forEach(et=>{et.grade==="excellent"?Ne++:et.grade==="good"?ve++:et.grade==="pass"&&Se++});const De=se>0?Math.round(Ne/se*100):0,$e=se>0?Math.round((Ne+ve+Se)/se*100):0,we=se>0?Math.round((Ne+ve+Se)/se*100):0;switch(He){case"S":le="excellent",re="音楽家レベルの相対音感を達成！",qe=`優秀率${De}%超えの実力を証明されました。`;break;case"A":le="excellent",re="エキスパートレベル到達！",qe=`優秀率${De}%の安定した音感能力です。`;break;case"B":le="improvement",re="プロフィシエント級達成！",qe=`良好率${$e}%の確実な進歩を示しています。`;break;case"C":le="improvement",re="アドバンス級到達！",qe=`合格率${we}%で着実に成長中です。`;break;case"D":le="practice",re="継続練習で必ず上達！",qe=`現在の合格率${we}%から目標70%へ向けて練習を続けましょう。`;break;case"E":default:le="encouragement",re="E級ビギナー",qe="練習開始段階です。継続的な練習で必ず上達します。";break}return{...ce,type:le,primary:re,summary:qe}}function fn(o){var He,se,Ne;if((v||[]).length<8||!o)return null;const G=o.improvements||[];(He=o.detailed)!=null&&He.statistics;const J=[];let ce=0,le=0;if((se=o.detailed)!=null&&se.intervals){const ve=o.detailed.intervals;if(ve.totalAnalyses>0){let Se=0,De=0;for(const[$e,we]of Object.entries(ve.masteryLevels))we.attempts>0&&(Se+=we.averageAccuracy*we.attempts,De+=we.attempts);ce=De>0?Se/De:0}}if((Ne=o.detailed)!=null&&Ne.directions){const ve=o.detailed.directions;if(ve.totalAnalyses>0){let Se=0,De=0;for(const[$e,we]of Object.entries(ve.masteryData))we.attempts>0&&(Se+=we.averageAccuracy*we.attempts,De+=we.attempts);le=De>0?Se/De:0}}J.push({category:"improvements",text:`音程精度: ${Math.round(ce)}%　（音の高さを捉える正確性　目標基準：70〜85%）`}),J.push({category:"improvements",text:`方向性: ${Math.round(le)}%　（音程の上下判断の精度　目標基準：80〜90%）`});const re=G.map(ve=>({category:"tips",text:ve.message})),qe=G.flatMap(ve=>(ve.actions||[]).map(Se=>({category:"practice",text:Se})));return[...J,...re,...qe],{type:"info",primary:"詳細分析結果",summary:"音程精度・一貫性・方向性の総合分析",details:J}}Cn(async()=>{if(!(typeof localStorage<"u"?localStorage.getItem("mic-test-completed"):null)){console.log("🚫 [RandomTraining] マイクテスト未完了 - 準備画面表示"),at();return}console.log("📊 [SessionStorage] セッション管理初期化開始");try{if(await bt()){if(console.log("📊 [SessionStorage] セッション進行状況の読み込み完了"),console.log("📊 [SessionStorage] 現在のセッション:",n,"/ 8"),console.log("📊 [SessionStorage] 次の基音:",y,"(",d,")"),console.log("📊 [SessionStorage] 完了状況:",c?"8セッション完了":`残り${f}セッション`),c&&(console.log("🔄 [SessionStorage] 8セッション完了検出 - 新サイクル開始処理"),await tt()?console.log("✅ [SessionStorage] 新サイクル開始完了 - セッション1/8から再開"):console.warn("⚠️ [SessionStorage] 新サイクル開始処理が失敗")),n>1&&!c){console.warn("🔄 [SessionStorage] セッション途中でのリロード検出 - セッション1から再開"),console.warn("🔄 [SessionStorage] 現在:",n,"セッション目 → ダイレクトアクセス誘導");const{SessionStorageManager:D}=await wn(async()=>{const{SessionStorageManager:J}=await import("../chunks/gi3OCs5l.js").then(ce=>ce.y);return{SessionStorageManager:J}},__vite__mapDeps([0,1,2,3,4,5]),import.meta.url),F=D.getInstance();typeof localStorage<"u"&&(localStorage.removeItem("random-training-progress"),localStorage.removeItem("random-training-progress-backup"));const{resetProgress:G}=await wn(async()=>{const{resetProgress:J}=await import("../chunks/gi3OCs5l.js").then(ce=>ce.z);return{resetProgress:J}},__vite__mapDeps([0,1,2,3,4,5]),import.meta.url);await G(),console.log("🔄 [SessionStorage] localStorage + ストア状態完全リセット完了"),at();return}}else console.log("📊 [SessionStorage] 新規セッション開始")}catch(l){console.error("📊 [SessionStorage] 初期化エラー:",l)}if(nn(),on(),u.url.searchParams.get("from")==="microphone-test"){console.log("🎤 [RandomTraining] マイクテストページからの遷移を検出");const l=new URL(window.location);if(l.searchParams.delete("from"),window.history.replaceState({},"",l),e(1,N="granted"),e(0,w="setup"),console.log('🎤 [RandomTraining] microphoneState="granted", trainingPhase="setup" に設定'),!xe){console.log("🎤 [RandomTraining] AudioManagerリソース取得開始");try{const D=await Je.initialize();st=D.audioContext,xe=D.mediaStream,rt=D.sourceNode,console.log("🎤 [RandomTraining] AudioManagerリソース取得完了")}catch(D){console.warn("⚠️ AudioManagerリソース取得失敗（後で再試行）:",D)}}if(await new Promise(D=>setTimeout(D,500)),ne)try{if(console.log("🎙️ [ContinuousMode] PitchDetector初期化開始"),typeof ne.getIsInitialized=="function"){const D=ne.getIsInitialized();if(console.log("🔍 [ContinuousMode] PitchDetector初期化状態:",D),D)console.log("✅ [ContinuousMode] PitchDetectorは既に初期化済み");else{const F=Je.getStatus();console.log("🔍 [ContinuousMode] AudioManager状態:",F),(!F.isInitialized||!F.mediaStreamActive)&&(console.log("🔄 [ContinuousMode] AudioManager再初期化実行"),await Je.initialize()),await ne.initialize(),console.log("✅ [ContinuousMode] PitchDetector初期化完了")}}else console.error("❌ [ContinuousMode] getIsInitializedメソッドが利用できません"),await ne.initialize()}catch(D){console.error("❌ [ContinuousMode] PitchDetector初期化エラー:",D),await new Promise(F=>setTimeout(F,1e3));try{await ne.initialize(),console.log("✅ [ContinuousMode] PitchDetector初期化再試行成功")}catch(F){console.error("❌ [ContinuousMode] PitchDetector初期化再試行も失敗:",F)}}else console.warn("⚠️ [ContinuousMode] PitchDetectorコンポーネントが存在しません")}else await new Promise(l=>setTimeout(l,100)),at()});function dn(o){try{if(!o||!o.detail){console.warn("⚠️ [ContinuousMode] handlePitchUpdate: event.detail が undefined");return}const{frequency:l,note:D,volume:F,rawVolume:G,clarity:J}=o.detail;let ce=l,le=D;if(w==="guiding"&&U&&b>0&&l>0){const re=mn(l);re&&(ce=re.frequency,le=re.note)}e(14,Pe=ce),e(15,Ge=le),e(13,be=F),b>0&&ce>0?Ve=Math.round(1200*Math.log2(ce/b)):Ve=0;try{gn(l,D)}catch(re){console.error("❌ [ContinuousMode] evaluateScaleStep エラー:",re)}try{Ce&&l>0&&b>0&&sn(l,D)}catch(re){console.error("❌ [ContinuousMode] updateScoringEngine エラー:",re)}}catch(l){console.error("❌ [ContinuousMode] handlePitchUpdate エラー:",{error:l.message,stack:l.stack,eventDetail:o==null?void 0:o.detail,trainingPhase:w,currentSessionId:n})}}function mn(o){if(!o||o<=0||!U||!b||be<25)return null;const D=q-1;if(D<0||D>=k.length)return null;const F=Ye(b,D);if(!F||F<=0)return null;const J=Tt(o,F).correctedFrequency,ce=En(J);return{frequency:Math.round(J),note:ce}}function gn(o,l){if(!o||o<=0||!U)return;if(!b||b<=0){console.error(`❌ [採点エラー] 基音周波数が無効: ${b}Hz`),console.error(`❌ [採点エラー] 基音名: ${H}`),console.error(`❌ [採点エラー] activeStepIndex: ${q-1}`),console.error(`❌ [採点エラー] trainingPhase: ${w}`),console.error(`❌ [採点エラー] isGuideAnimationActive: ${U}`);return}if(be<25)return;const F=q-1;if(F<0||F>=k.length)return;F>=4&&ie.debug(`[採点デバッグ] activeStepIndex=${F} (${k[F].name}), currentBaseFrequency=${b}Hz`);const G=Ye(b,F);if(F>=0&&ie.debug(`[音程計算修正版] ${k[F].name}: 期待周波数 ${G.toFixed(1)}Hz`),!G||G<=0||!isFinite(G)){console.error("❌ [採点エラー] 期待周波数計算エラー:"),console.error(`   基音周波数: ${b}Hz`),console.error(`   音階インデックス: ${F}`),console.error(`   期待周波数: ${G}Hz`);return}const J=Tt(o,G),ce=J.correctedFrequency,le=J.factor,re=Math.round(1200*Math.log2(ce/G));if((Math.abs(re)>200||le!==1)&&(ie.debug(`[プロトタイプ式補正] ${k[F].name}:`),console.warn(`   検出周波数: ${o.toFixed(1)}Hz`),console.warn(`   補正後周波数: ${ce.toFixed(1)}Hz`),console.warn(`   期待周波数: ${G.toFixed(1)}Hz`),console.warn(`   セント差: ${re}¢`),console.warn(`   補正係数: ${le} (${J.description})`),console.warn(`   基音: ${H} (${b.toFixed(1)}Hz)`)),!isFinite(re)){console.error("❌ [採点エラー] セント計算エラー:"),console.error(`   検出周波数: ${o}Hz`),console.error(`   期待周波数: ${G}Hz`),console.error(`   セント差: ${re}`);return}const He=Math.abs(re)<=50;if(be>=15){const ve=Math.max(0,Math.round(100-Math.abs(re))),Se=Q.findIndex($e=>$e.stepIndex===F),De={stepIndex:F,stepName:k[F].name,expectedFrequency:Math.round(G),detectedFrequency:Math.round(o),adjustedFrequency:Math.round(ce),centDifference:re,accuracy:ve,isCorrect:He,correctionFactor:le,correctionDescription:J.description,timestamp:Date.now()};Se>=0?Q[Se]=De:Q.push(De),Q.length%4===0&&ie.realtime(`採点進捗: ${Q.length}/${k.length}ステップ完了`)}}function yn(){e(0,w="results"),ze.isCompleted=!0,ze.averageAccuracy=Math.round(ze.correctCount/ze.totalCount*100),ne&&ne.stopDetection(),bn()}async function hn(){if(c){console.warn("🚫 [RestartSame] 8セッション完了状態では再挑戦不可 - 新サイクル開始が必要"),await tt()?(console.log("✅ [RestartSame] 新サイクル開始完了 - セッション1/8から再開"),window.location.reload()):console.error("❌ [RestartSame] 新サイクル開始失敗");return}ot(),e(0,w="setup"),j&&(clearTimeout(j),j=null),ne&&ne.resetDisplayState&&ne.resetDisplayState(),ct(),console.log("🔄 [RestartSame] 同じ基音で再挑戦:",H,b+"Hz"),console.log("🔄 [RestartSame] 基音情報保持完了 - ユーザー操作待機")}async function pn(){if(c){console.warn("🚫 [RestartDifferent] 8セッション完了状態では再挑戦不可 - 新サイクル開始が必要"),await tt()?(console.log("✅ [RestartDifferent] 新サイクル開始完了 - セッション1/8から再開"),window.location.reload()):console.error("❌ [RestartDifferent] 新サイクル開始失敗");return}ot(),e(0,w="setup"),j&&(clearTimeout(j),j=null),e(7,H=""),e(8,b=0),console.log("🔄 [restartDifferentBaseNote] 基音情報をリセットしました"),ne&&ne.resetDisplayState&&ne.resetDisplayState(),ct()}function ct(){q=0,U=!1,Q=[],e(10,k=k.map(o=>({...o,state:"inactive",completed:!1})))}async function vn(){console.log("🚀 [StartNewCycle] 8セッション完了後の最初から挑戦開始");try{await tt()?(console.log("✅ [StartNewCycle] 新サイクル開始完了"),localStorage.getItem("mic-test-completed")?(console.log("✅ [StartNewCycle] マイクテスト完了フラグ確認 - リロードなしで状態リセット"),ot(),await bt(),e(0,w="setup"),ct(),dt(),console.log("✅ [StartNewCycle] 状態リセット完了 - セッション1/8から再開")):window.location.reload()):(console.error("❌ [StartNewCycle] 新サイクル開始失敗"),Ze())}catch(o){console.error("❌ [StartNewCycle] 新サイクル開始エラー:",o),Ze()}}function _n(o){const{type:l}=o.detail;switch(l){case"same":hn();break;case"different":pn();break;case"restart":vn();break;case"home":Ze();break;default:console.warn("🚫 [ActionButtons] 未知のアクションタイプ:",l)}}function Sn(){console.log("⚡ [ContinuousMode] 8セッション連続開始"),mt()}function bn(){console.log("✅ [ContinuousMode] セッション完了:",n),n<8?setTimeout(()=>{if(console.log("🔄 [ContinuousMode] 次セッション自動開始準備:",n+1),e(0,w="setup"),ze={isCompleted:!1,correctCount:0,totalCount:0,averageAccuracy:0},e(9,ee=!1),ne)try{if(ne.getState){const o=ne.getState();console.log("🔍 [ContinuousMode] PitchDetector状態:",o),o.isInitialized&&o.componentState==="ready"?(console.log("🎤 [ContinuousMode] 音程検出再開"),ne.startDetection()):o.componentState==="detecting"?console.log("🔄 [ContinuousMode] 音程検出は既にアクティブ状態 - スキップ"):console.log("⚠️ [ContinuousMode] PitchDetector状態不正 - 音程検出再開をスキップ:",o.componentState)}else console.log("⚠️ [ContinuousMode] getState()メソッド未対応 - フォールバック処理"),ne.getIsInitialized&&ne.getIsInitialized()&&ne.startDetection()}catch(o){console.warn("⚠️ [ContinuousMode] 音程検出再開失敗:",o.message)}console.log("🎵 [ContinuousMode] 次の基音自動再生開始"),mt()},5e3):(console.log("🎉 [ContinuousMode] 8セッション完了！"),setTimeout(()=>{console.log("🏆 [ContinuousMode] 総合評価画面表示完了")},1e3))}function Dn(o){var J;const{error:l,context:D,reason:F,recovery:G}=o.detail;if(D==="initialization"||l!=null&&l.message&&l.message.includes("getIsInitialized")){console.error("❌ [ContinuousMode] PitchDetector初期化エラー詳細:",{error:(l==null?void 0:l.message)||l,stack:l==null?void 0:l.stack,context:D,componentExists:!!ne,hasGetIsInitialized:typeof(ne==null?void 0:ne.getIsInitialized)=="function",trainingPhase:w,currentSessionId:n});return}if(console.error("❌ [ContinuousMode] PitchDetectorエラー詳細:",{error:(l==null?void 0:l.message)||l,stack:l==null?void 0:l.stack,context:D,reason:F,recovery:G,trainingPhase:w,currentSessionId:n}),F==="mediastream_ended"&&G==="restart_required"&&(console.log("⚡ [ContinuousMode] MediaStream終了検出 - 自動復旧を試行"),setTimeout(async()=>{try{await We()}catch(ce){console.error("❌ [ContinuousMode] 自動復旧失敗:",ce)}},1e3)),D==="start-detection"&&((J=l==null?void 0:l.message)!=null&&J.includes("component state is detecting"))){console.log("🔄 [ContinuousMode] 音程検出は既にアクティブ状態です（正常）");return}}function qn(o){const{healthy:l,errors:D,details:F}=o.detail;e(2,R=l),e(6,S=D),l||(console.warn("⚠️ マイクの健康状態が悪化:",D),w==="guiding"&&(e(0,w="setup"),console.warn("🛑 マイク問題によりトレーニングを停止")))}kn(()=>{console.log("🔄 [RandomTraining] onDestroy - AudioManagerリソースは保持"),pe&&(pe.dispose(),e(33,pe=null))});const So=[];Ko.keys(t).forEach(o=>{!~So.indexOf(o)&&o.slice(0,2)!=="$$"&&o!=="slot"&&Qo.warn(`<Page> was created with unknown prop '${o}'`)});function bo(o){Fo[o?"unshift":"push"](()=>{ne=o,e(22,ne)})}return s.$capture_state=()=>({onMount:Cn,onDestroy:kn,goto:vt,base:it,page:_t,ChevronRight:Oo,Music:Ln,Card:Ke,Button:ut,VolumeBar:Mo,PitchDisplay:Go,PitchDetector:zn,PitchDetectionDisplay:Vn,PageLayout:Hn,Tone:jo,audioManager:Je,harmonicCorrection:St,logger:ie,ScoreResultPanel:Lo,IntervalProgressTracker:zo,ConsistencyGraph:Vo,FeedbackDisplay:Ho,SessionStatistics:xo,UnifiedScoreResultFixed:Kt,ActionButtons:Jt,EvaluationEngine:nt,EnhancedScoringEngine:Rn,trainingProgress:Nt,currentSessionId:Mt,nextBaseNote:Rt,nextBaseName:Ft,isLoading:kt,storageError:Bo,isCompleted:Ct,sessionHistory:wt,overallGrade:Po,overallAccuracy:Eo,progressPercentage:To,remainingSessions:qt,latestSessionResult:Ao,unifiedScoreData:Dt,loadProgress:bt,saveSessionResult:Fn,resetProgress:Io,createNewProgress:No,startNewCycleIfCompleted:tt,getVolumeForDevice:An,calculateUnifiedGrade:M,generateTestUnifiedScoreData:Xo,trainingPhase:w,microphoneState:N,microphoneHealthy:R,microphoneErrors:S,buildVersion:uo,buildTimestamp:fo,updateStatus:mo,SCALE_NAMES:P,currentBaseNote:H,currentBaseFrequency:b,isPlaying:ee,currentScaleIndex:q,scaleSteps:k,guideAnimationTimer:j,isGuideAnimationActive:U,guideStartProgress:oe,isGuideStartBarActive:V,guideStartTimer:B,musicIconGlowing:te,scaleEvaluations:Q,previousEvaluations:he,currentVolume:be,currentFrequency:Pe,detectedNote:Ge,pitchDifference:Ve,sessionResults:ze,scoringEngine:Ce,currentScoreData:Le,intervalData:ke,consistencyData:Be,feedbackData:Oe,technicalFeedbackData:Xe,sessionStatistics:Re,activeTab:ft,noteResultsForDisplay:ae,currentUnifiedScoreData:ue,sampler:pe,isSamplerLoading:Me,pitchDetectorComponent:ne,mediaStream:xe,audioContext:st,sourceNode:rt,sessionStartTime:Qe,baseNotes:Ue,checkMicrophonePermission:We,selectRandomBaseNote:dt,playRandomBaseNote:Qt,playCurrentBaseNote:Xt,playBaseNoteOnly:yo,playBaseNote:mt,startGuideStartBar:Yt,cleanupGuideStartBar:ho,calculateExpectedFrequency:Ye,calculateTargetFrequency:Zt,startGuideAnimation:gt,finishGuideAnimation:$t,calculateFinalResults:en,getStatusMessage:po,getDisplayEvaluations:vo,goToMicrophoneTest:tn,goHome:Ze,initializeSampler:nn,checkExistingMicrophonePermission:at,initializeScoringEngine:on,updateScoringEngine:sn,generateFinalScoring:rn,generateTestScoreData:an,switchTab:_o,generateUnifiedScoreData:cn,saveSessionToStorage:ln,generateEnhancedScoringData:un,generateFallbackEnhancedData:yt,generateIntervalDataFromResults:At,generateIntervalDataFromSessionHistory:Tn,generateConsistencyDataFromResults:ht,generateFeedbackFromResults:pt,generateTechnicalFeedbackFromEnhancedEngine:fn,handlePitchUpdate:dn,getEvaluationCorrectedFrequency:mn,frequencyToNote:En,multiStageOctaveCorrection:Tt,evaluateScaleStep:gn,completeSession:yn,restartSameBaseNote:hn,restartDifferentBaseNote:pn,scrollToTop:ot,resetSessionState:ct,startNewCycle:vn,handleActionButtonClick:_n,startContinuousMode:Sn,handleSessionComplete:bn,handlePitchDetectorStateChange:go,handlePitchDetectorError:Dn,handleMicrophoneHealthChange:qn,canRestartSession:r,canStartTraining:i,$currentSessionId:n,$unifiedScoreData:a,$isCompleted:c,$page:u,$remainingSessions:f,$nextBaseName:d,$nextBaseNote:y,$sessionHistory:v,$trainingProgress:C,$isLoading:p}),s.$inject_state=o=>{"trainingPhase"in o&&e(0,w=o.trainingPhase),"microphoneState"in o&&e(1,N=o.microphoneState),"microphoneHealthy"in o&&e(2,R=o.microphoneHealthy),"microphoneErrors"in o&&e(6,S=o.microphoneErrors),"currentBaseNote"in o&&e(7,H=o.currentBaseNote),"currentBaseFrequency"in o&&e(8,b=o.currentBaseFrequency),"isPlaying"in o&&e(9,ee=o.isPlaying),"currentScaleIndex"in o&&(q=o.currentScaleIndex),"scaleSteps"in o&&e(10,k=o.scaleSteps),"guideAnimationTimer"in o&&(j=o.guideAnimationTimer),"isGuideAnimationActive"in o&&(U=o.isGuideAnimationActive),"guideStartProgress"in o&&e(11,oe=o.guideStartProgress),"isGuideStartBarActive"in o&&(V=o.isGuideStartBarActive),"guideStartTimer"in o&&(B=o.guideStartTimer),"musicIconGlowing"in o&&e(12,te=o.musicIconGlowing),"scaleEvaluations"in o&&(Q=o.scaleEvaluations),"previousEvaluations"in o&&(he=o.previousEvaluations),"currentVolume"in o&&e(13,be=o.currentVolume),"currentFrequency"in o&&e(14,Pe=o.currentFrequency),"detectedNote"in o&&e(15,Ge=o.detectedNote),"pitchDifference"in o&&(Ve=o.pitchDifference),"sessionResults"in o&&(ze=o.sessionResults),"scoringEngine"in o&&(Ce=o.scoringEngine),"currentScoreData"in o&&e(16,Le=o.currentScoreData),"intervalData"in o&&e(3,ke=o.intervalData),"consistencyData"in o&&e(17,Be=o.consistencyData),"feedbackData"in o&&e(18,Oe=o.feedbackData),"technicalFeedbackData"in o&&e(19,Xe=o.technicalFeedbackData),"sessionStatistics"in o&&e(20,Re=o.sessionStatistics),"activeTab"in o&&(ft=o.activeTab),"noteResultsForDisplay"in o&&(ae=o.noteResultsForDisplay),"currentUnifiedScoreData"in o&&e(21,ue=o.currentUnifiedScoreData),"sampler"in o&&e(33,pe=o.sampler),"isSamplerLoading"in o&&e(34,Me=o.isSamplerLoading),"pitchDetectorComponent"in o&&e(22,ne=o.pitchDetectorComponent),"mediaStream"in o&&(xe=o.mediaStream),"audioContext"in o&&(st=o.audioContext),"sourceNode"in o&&(rt=o.sourceNode),"sessionStartTime"in o&&(Qe=o.sessionStartTime),"canRestartSession"in o&&(r=o.canRestartSession),"canStartTraining"in o&&(i=o.canStartTraining)},t&&"$$inject"in t&&s.$inject_state(t.$$inject),s.$$.update=()=>{s.$$.dirty[0]&6|s.$$.dirty[1]&12&&(i=N==="granted"&&!Me&&pe&&R),s.$$.dirty[0]&1&&(r=w==="results"),s.$$.dirty[0]&56&&a&&c&&a.sessionHistory&&(e(3,ke=Tn(a.sessionHistory)),console.log("🎵 [RandomTraining] intervalData生成完了:",ke.length,"件")),s.$$.dirty[0]&3&&w==="setup"&&N==="granted"&&ot()},[w,N,R,ke,a,c,S,H,b,ee,k,oe,te,be,Pe,Ge,Le,Be,Oe,Xe,Re,ue,ne,n,v,p,tn,Ze,dn,_n,Sn,Dn,qn,pe,Me,bo]}class is extends Do{constructor(t){super(t),qo(this,t,Yo,Wt,wo,{},null,[-1,-1,-1,-1]),$("SvelteRegisterComponent",{component:this,tagName:"Page",options:t,id:Wt.name})}}export{is as component,cs as universal};
