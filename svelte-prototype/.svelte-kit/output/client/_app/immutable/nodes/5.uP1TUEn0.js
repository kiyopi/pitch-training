import{S as Pe,i as Ve,s as Ne,d as h,m as N,o as V,p as ve,q as ge,b as D,y as T,e as C,f as y,j as k,l as ee,I as Ae,Q as et,C as F,D as H,E as q,F as z,h as E,k as M,c as p,L as se,M as tt,n as j,G as B,O as nt,a as re,g as G,t as x,r as we,N as st,A as Be}from"../chunks/BbQtw8CC.js";import"../chunks/IHki7fMi.js";import{b as le,g as fe}from"../chunks/BNXdTR5k.js";import{C as te,P as ot}from"../chunks/DNmPTphr.js";import{e as De}from"../chunks/D6YF6ztN.js";import{B as Le}from"../chunks/CB02h6m0.js";import{a as Se,b as rt,P as lt}from"../chunks/DjSLRzt-.js";import{l as at,S as it,a as ct,U as ut,A as dt,c as ft,s as vt,n as gt,M as mt,b as ht,E as Ie,i as pt,d as _t,u as bt,e as Ct,f as kt,p as Tt}from"../chunks/GWuUAuKN.js";const wt=!1,Dt=!0,gn=Object.freeze(Object.defineProperty({__proto__:null,prerender:Dt,ssr:wt},Symbol.toStringTag,{value:"Module"}));function $e(l,e,t){const n=l.slice();return n[56]=e[t],n[58]=t,n}function St(l){let e,t,n,o,s,r,i,c,g,v,u,d=l[3]&&ye(l);n=new te({props:{class:"main-card half-width",$$slots:{default:[Bt]},$$scope:{ctx:l}}}),s=new te({props:{class:"main-card half-width",$$slots:{default:[Lt]},$$scope:{ctx:l}}}),i=new te({props:{class:"main-card",$$slots:{default:[Ft]},$$scope:{ctx:l}}});let _={isActive:l[4]==="granted",trainingPhase:l[11]};return v=new rt({props:_}),l[34](v),v.$on("pitchUpdate",l[22]),v.$on("error",l[23]),{c(){d&&d.c(),e=M(),t=k("div"),z(n.$$.fragment),o=M(),z(s.$$.fragment),r=M(),z(i.$$.fragment),c=M(),g=k("div"),z(v.$$.fragment),this.h()},l(a){d&&d.l(a),e=E(a),t=C(a,"DIV",{class:!0});var m=y(t);q(n.$$.fragment,m),o=E(m),q(s.$$.fragment,m),m.forEach(h),r=E(a),q(i.$$.fragment,a),c=E(a),g=C(a,"DIV",{style:!0});var w=y(g);q(v.$$.fragment,w),w.forEach(h),this.h()},h(){T(t,"class","side-by-side-container svelte-lbd18e"),se(g,"display","none")},m(a,m){d&&d.m(a,m),D(a,e,m),D(a,t,m),H(n,t,null),p(t,o),H(s,t,null),D(a,r,m),H(i,a,m),D(a,c,m),D(a,g,m),H(v,g,null),u=!0},p(a,m){a[3]?d?(d.p(a,m),m[0]&8&&V(d,1)):(d=ye(a),d.c(),V(d,1),d.m(e.parentNode,e)):d&&(ve(),N(d,1,1,()=>{d=null}),ge());const w={};m[0]&3778|m[1]&268435456&&(w.$$scope={dirty:m,ctx:a}),n.$set(w);const $={};m[0]&28672|m[1]&268435456&&($.$$scope={dirty:m,ctx:a}),s.$set($);const b={};m[0]&131329|m[1]&268435456&&(b.$$scope={dirty:m,ctx:a}),i.$set(b);const S={};m[0]&16&&(S.isActive=a[4]==="granted"),m[0]&2048&&(S.trainingPhase=a[11]),v.$set(S)},i(a){u||(V(d),V(n.$$.fragment,a),V(s.$$.fragment,a),V(i.$$.fragment,a),V(v.$$.fragment,a),u=!0)},o(a){N(d),N(n.$$.fragment,a),N(s.$$.fragment,a),N(i.$$.fragment,a),N(v.$$.fragment,a),u=!1},d(a){a&&(h(e),h(t),h(r),h(c),h(g)),d&&d.d(a),F(n),F(s),F(i,a),l[34](null),F(v)}}}function It(l){let e,t,n,o;return e=new ut({props:{currentScoreData:l[16],intervalData:[],consistencyData:[],feedbackData:null,technicalFeedbackData:null}}),n=new dt({props:{showRestart:!l[18],showNext:!l[18],showHome:!0}}),n.$on("restart",l[24]),n.$on("next",l[25]),n.$on("home",l[26]),{c(){z(e.$$.fragment),t=M(),z(n.$$.fragment)},l(s){q(e.$$.fragment,s),t=E(s),q(n.$$.fragment,s)},m(s,r){H(e,s,r),D(s,t,r),H(n,s,r),o=!0},p(s,r){const i={};r[0]&65536&&(i.currentScoreData=s[16]),e.$set(i);const c={};r[0]&262144&&(c.showRestart=!s[18]),r[0]&262144&&(c.showNext=!s[18]),n.$set(c)},i(s){o||(V(e.$$.fragment,s),V(n.$$.fragment,s),o=!0)},o(s){N(e.$$.fragment,s),N(n.$$.fragment,s),o=!1},d(s){s&&h(t),F(e,s),F(n,s)}}}function $t(l){let e,t;return e=new te({props:{class:"main-card",$$slots:{default:[qt]},$$scope:{ctx:l}}}),{c(){z(e.$$.fragment)},l(n){q(e.$$.fragment,n)},m(n,o){H(e,n,o),t=!0},p(n,o){const s={};o[1]&268435456&&(s.$$scope={dirty:o,ctx:n}),e.$set(s)},i(n){t||(V(e.$$.fragment,n),t=!0)},o(n){N(e.$$.fragment,n),t=!1},d(n){F(e,n)}}}function yt(l){let e,t;return e=new te({props:{class:"main-card",$$slots:{default:[zt]},$$scope:{ctx:l}}}),{c(){z(e.$$.fragment)},l(n){q(e.$$.fragment,n)},m(n,o){H(e,n,o),t=!0},p(n,o){const s={};o[1]&268435456&&(s.$$scope={dirty:o,ctx:n}),e.$set(s)},i(n){t||(V(e.$$.fragment,n),t=!0)},o(n){N(e.$$.fragment,n),t=!1},d(n){F(e,n)}}}function ye(l){let e,t;return e=new te({props:{class:"main-card",$$slots:{default:[Et]},$$scope:{ctx:l}}}),{c(){z(e.$$.fragment)},l(n){q(e.$$.fragment,n)},m(n,o){H(e,n,o),t=!0},p(n,o){const s={};o[0]&1572868|o[1]&268435456&&(s.$$scope={dirty:o,ctx:n}),e.$set(s)},i(n){t||(V(e.$$.fragment,n),t=!0)},o(n){N(e.$$.fragment,n),t=!1},d(n){F(e,n)}}}function Et(l){let e,t='<h3 class="section-title svelte-lbd18e">📊 進捗状況</h3>',n,o,s,r,i,c,g,v,u,d,_;return{c(){e=k("div"),e.innerHTML=t,n=M(),o=k("div"),s=k("div"),r=k("div"),i=x("セッション "),c=x(l[19]),g=x(" / "),v=x(l[2]),u=M(),d=k("div"),_=k("div"),this.h()},l(a){e=C(a,"DIV",{class:!0,"data-svelte-h":!0}),B(e)!=="svelte-1hcye1c"&&(e.innerHTML=t),n=E(a),o=C(a,"DIV",{class:!0});var m=y(o);s=C(m,"DIV",{class:!0});var w=y(s);r=C(w,"DIV",{class:!0});var $=y(r);i=G($,"セッション "),c=G($,l[19]),g=G($," / "),v=G($,l[2]),$.forEach(h),u=E(w),d=C(w,"DIV",{class:!0});var b=y(d);_=C(b,"DIV",{class:!0,style:!0}),y(_).forEach(h),b.forEach(h),w.forEach(h),m.forEach(h),this.h()},h(){T(e,"class","card-header svelte-lbd18e"),T(r,"class","session-counter svelte-lbd18e"),T(_,"class","progress-fill svelte-lbd18e"),se(_,"width",l[20]+"%"),T(d,"class","progress-bar svelte-lbd18e"),T(s,"class","progress-info svelte-lbd18e"),T(o,"class","card-content svelte-lbd18e")},m(a,m){D(a,e,m),D(a,n,m),D(a,o,m),p(o,s),p(s,r),p(r,i),p(r,c),p(r,g),p(r,v),p(s,u),p(s,d),p(d,_)},p(a,m){m[0]&524288&&re(c,a[19]),m[0]&4&&re(v,a[2]),m[0]&1048576&&se(_,"width",a[20]+"%")},d(a){a&&(h(e),h(n),h(o))}}}function Mt(l){let e;return{c(){e=x("🎹 基音再生")},l(t){e=G(t,"🎹 基音再生")},m(t,n){D(t,e,n)},d(t){t&&h(e)}}}function Pt(l){let e;return{c(){e=x("🔄 自動再生モード")},l(t){e=G(t,"🔄 自動再生モード")},m(t,n){D(t,e,n)},d(t){t&&h(e)}}}function Vt(l){let e;return{c(){e=x("⏳ 読み込み中...")},l(t){e=G(t,"⏳ 読み込み中...")},m(t,n){D(t,e,n)},d(t){t&&h(e)}}}function Nt(l){let e;return{c(){e=x("🎵 再生中...")},l(t){e=G(t,"🎵 再生中...")},m(t,n){D(t,e,n)},d(t){t&&h(e)}}}function At(l){let e;function t(s,r){return s[7]?Nt:s[6]?Vt:s[1]?Pt:Mt}let n=t(l),o=n(l);return{c(){o.c(),e=we()},l(s){o.l(s),e=we()},m(s,r){o.m(s,r),D(s,e,r)},p(s,r){n!==(n=t(s))&&(o.d(1),o=n(s),o&&(o.c(),o.m(e.parentNode,e)))},d(s){s&&h(e),o.d(s)}}}function Bt(l){let e,t='<h3 class="section-title svelte-lbd18e">🎹 基音再生</h3>',n,o,s,r,i,c,g="ガイド開始まで",v,u,d,_,a,m,w,$;return s=new Le({props:{variant:"primary",disabled:l[7]||l[6]||l[1]&&l[11]==="guiding",$$slots:{default:[At]},$$scope:{ctx:l}}}),s.$on("click",l[21]),m=new mt({props:{size:"20"}}),{c(){e=k("div"),e.innerHTML=t,n=M(),o=k("div"),z(s.$$.fragment),r=M(),i=k("div"),c=k("div"),c.textContent=g,v=M(),u=k("div"),d=k("div"),_=M(),a=k("div"),z(m.$$.fragment),this.h()},l(b){e=C(b,"DIV",{class:!0,"data-svelte-h":!0}),B(e)!=="svelte-1u9jvpv"&&(e.innerHTML=t),n=E(b),o=C(b,"DIV",{class:!0});var S=y(o);q(s.$$.fragment,S),r=E(S),i=C(S,"DIV",{class:!0});var I=y(i);c=C(I,"DIV",{class:!0,"data-svelte-h":!0}),B(c)!=="svelte-1dufnpv"&&(c.textContent=g),v=E(I),u=C(I,"DIV",{class:!0});var U=y(u);d=C(U,"DIV",{class:!0,style:!0}),y(d).forEach(h),_=E(U),a=C(U,"DIV",{class:!0});var O=y(a);q(m.$$.fragment,O),O.forEach(h),U.forEach(h),I.forEach(h),S.forEach(h),this.h()},h(){T(e,"class","card-header svelte-lbd18e"),T(c,"class","guide-start-label svelte-lbd18e"),T(d,"class","guide-progress-fill svelte-lbd18e"),se(d,"width",l[9]+"%"),T(a,"class",w="guide-music-icon "+(l[10]?"glowing":"")+" svelte-lbd18e"),T(u,"class","guide-start-bar svelte-lbd18e"),T(i,"class","guide-start-bar-container svelte-lbd18e"),T(o,"class","card-content svelte-lbd18e")},m(b,S){D(b,e,S),D(b,n,S),D(b,o,S),H(s,o,null),p(o,r),p(o,i),p(i,c),p(i,v),p(i,u),p(u,d),p(u,_),p(u,a),H(m,a,null),$=!0},p(b,S){const I={};S[0]&2242&&(I.disabled=b[7]||b[6]||b[1]&&b[11]==="guiding"),S[0]&194|S[1]&268435456&&(I.$$scope={dirty:S,ctx:b}),s.$set(I),(!$||S[0]&512)&&se(d,"width",b[9]+"%"),(!$||S[0]&1024&&w!==(w="guide-music-icon "+(b[10]?"glowing":"")+" svelte-lbd18e"))&&T(a,"class",w)},i(b){$||(V(s.$$.fragment,b),V(m.$$.fragment,b),$=!0)},o(b){N(s.$$.fragment,b),N(m.$$.fragment,b),$=!1},d(b){b&&(h(e),h(n),h(o)),F(s),F(m)}}}function Lt(l){let e,t='<h3 class="section-title svelte-lbd18e">🎤 リアルタイム検出</h3>',n,o,s,r;return s=new lt({props:{frequency:l[13],note:l[14],volume:l[12],isMuted:!1}}),{c(){e=k("div"),e.innerHTML=t,n=M(),o=k("div"),z(s.$$.fragment),this.h()},l(i){e=C(i,"DIV",{class:!0,"data-svelte-h":!0}),B(e)!=="svelte-momj6l"&&(e.innerHTML=t),n=E(i),o=C(i,"DIV",{class:!0});var c=y(o);q(s.$$.fragment,c),c.forEach(h),this.h()},h(){T(e,"class","card-header svelte-lbd18e"),T(o,"class","card-content svelte-lbd18e")},m(i,c){D(i,e,c),D(i,n,c),D(i,o,c),H(s,o,null),r=!0},p(i,c){const g={};c[0]&8192&&(g.frequency=i[13]),c[0]&16384&&(g.note=i[14]),c[0]&4096&&(g.volume=i[12]),s.$set(g)},i(i){r||(V(s.$$.fragment,i),r=!0)},o(i){N(s.$$.fragment,i),r=!1},d(i){i&&(h(e),h(n),h(o)),F(s)}}}function Ee(l){let e,t=l[56]+"",n,o,s;return{c(){e=k("div"),n=x(t),o=M(),this.h()},l(r){e=C(r,"DIV",{class:!0});var i=y(e);n=G(i,t),o=E(i),i.forEach(h),this.h()},h(){var r;T(e,"class",s="scale-item "+(((r=l[8][l[58]])==null?void 0:r.state)||"inactive")+" svelte-lbd18e")},m(r,i){D(r,e,i),p(e,n),p(e,o)},p(r,i){var c;i[0]&131072&&t!==(t=r[56]+"")&&re(n,t),i[0]&256&&s!==(s="scale-item "+(((c=r[8][r[58]])==null?void 0:c.state)||"inactive")+" svelte-lbd18e")&&T(e,"class",s)},d(r){r&&h(e)}}}function Ft(l){let e,t,n,o=l[0]==="chromatic"?"12":"8",s,r,i,c,g,v=De(l[17]),u=[];for(let d=0;d<v.length;d+=1)u[d]=Ee($e(l,v,d));return{c(){e=k("div"),t=k("h3"),n=x("🎵 "),s=x(o),r=x("音階ガイド"),i=M(),c=k("div"),g=k("div");for(let d=0;d<u.length;d+=1)u[d].c();this.h()},l(d){e=C(d,"DIV",{class:!0});var _=y(e);t=C(_,"H3",{class:!0});var a=y(t);n=G(a,"🎵 "),s=G(a,o),r=G(a,"音階ガイド"),a.forEach(h),_.forEach(h),i=E(d),c=C(d,"DIV",{class:!0});var m=y(c);g=C(m,"DIV",{class:!0});var w=y(g);for(let $=0;$<u.length;$+=1)u[$].l(w);w.forEach(h),m.forEach(h),this.h()},h(){T(t,"class","section-title svelte-lbd18e"),T(e,"class","card-header svelte-lbd18e"),T(g,"class","scale-guide svelte-lbd18e"),T(c,"class","card-content svelte-lbd18e")},m(d,_){D(d,e,_),p(e,t),p(t,n),p(t,s),p(t,r),D(d,i,_),D(d,c,_),p(c,g);for(let a=0;a<u.length;a+=1)u[a]&&u[a].m(g,null)},p(d,_){if(_[0]&1&&o!==(o=d[0]==="chromatic"?"12":"8")&&re(s,o),_[0]&131328){v=De(d[17]);let a;for(a=0;a<v.length;a+=1){const m=$e(d,v,a);u[a]?u[a].p(m,_):(u[a]=Ee(m),u[a].c(),u[a].m(g,null))}for(;a<u.length;a+=1)u[a].d(1);u.length=v.length}},d(d){d&&(h(e),h(i),h(c)),nt(u,d)}}}function Ht(l){let e;return{c(){e=x("ホームに戻る")},l(t){e=G(t,"ホームに戻る")},m(t,n){D(t,e,n)},d(t){t&&h(e)}}}function qt(l){let e,t,n="⚠️ マイク許可が必要です",o,s,r="マイクテストページから開始してください",i,c,g;return c=new Le({props:{variant:"primary",$$slots:{default:[Ht]},$$scope:{ctx:l}}}),c.$on("click",l[26]),{c(){e=k("div"),t=k("h3"),t.textContent=n,o=M(),s=k("p"),s.textContent=r,i=M(),z(c.$$.fragment),this.h()},l(v){e=C(v,"DIV",{class:!0});var u=y(e);t=C(u,"H3",{"data-svelte-h":!0}),B(t)!=="svelte-1iz0ljq"&&(t.textContent=n),o=E(u),s=C(u,"P",{"data-svelte-h":!0}),B(s)!=="svelte-13xvrzt"&&(s.textContent=r),i=E(u),q(c.$$.fragment,u),u.forEach(h),this.h()},h(){T(e,"class","card-content text-center svelte-lbd18e")},m(v,u){D(v,e,u),p(e,t),p(e,o),p(e,s),p(e,i),H(c,e,null),g=!0},p(v,u){const d={};u[1]&268435456&&(d.$$scope={dirty:u,ctx:v}),c.$set(d)},i(v){g||(V(c.$$.fragment,v),g=!0)},o(v){N(c.$$.fragment,v),g=!1},d(v){v&&h(e),F(c)}}}function zt(l){let e,t="<h3>⏳ マイク初期化中...</h3> <p>しばらくお待ちください</p>";return{c(){e=k("div"),e.innerHTML=t,this.h()},l(n){e=C(n,"DIV",{class:!0,"data-svelte-h":!0}),B(e)!=="svelte-1f701n6"&&(e.innerHTML=t),this.h()},h(){T(e,"class","card-content text-center svelte-lbd18e")},m(n,o){D(n,e,o)},p:j,d(n){n&&h(e)}}}function Gt(l){let e,t,n,o;const s=[yt,$t,It,St],r=[];function i(c,g){return c[4]==="checking"?0:c[4]==="denied"||c[4]==="error"?1:c[15]&&c[16]?2:3}return t=i(l),n=r[t]=s[t](l),{c(){e=k("div"),n.c(),this.h()},l(c){e=C(c,"DIV",{class:!0});var g=y(e);n.l(g),g.forEach(h),this.h()},h(){T(e,"class","training-core svelte-lbd18e")},m(c,g){D(c,e,g),r[t].m(e,null),o=!0},p(c,g){let v=t;t=i(c),t===v?r[t].p(c,g):(ve(),N(r[v],1,1,()=>{r[v]=null}),ge(),n=r[t],n?n.p(c,g):(n=r[t]=s[t](c),n.c()),V(n,1),n.m(e,null))},i(c){o||(V(n),o=!0)},o(c){N(n),o=!1},d(c){c&&h(e),r[t].d()}}}function Me(){const l=/iPhone/.test(navigator.userAgent),e=/iPad/.test(navigator.userAgent),t=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document;return l||e||t?(console.log("🔊 [TrainingCore] iOS/iPadOS検出 - 音量35dB設定"),35):(console.log("🔊 [TrainingCore] PC検出 - 音量-6dB設定"),-6)}function xt(l){return{C4:261.63,Db4:277.18,D4:293.66,Eb4:311.13,E4:329.63,F4:349.23,Gb4:369.99,G4:392,Ab4:415.3,A4:440,Bb4:466.16,B4:493.88,C5:523.25,Db5:554.37,D5:587.33,Eb5:622.25,E5:659.25,F5:698.46,Gb5:739.99,G5:783.99}[l]||261.63}function Ot(l,e){return l*([1,1.125,1.25,1.3333333333333333,1.5,1.6666666666666667,1.875,2][e]||1)}function Ut(l,e){return!l||!e||l<=0||e<=0?null:Math.round(1200*Math.log2(l/e))}function Rt(l){if(l===null)return 0;const e=Math.abs(l);return Math.max(0,Math.min(100,100-e/50*100))}function jt(l,e,t){let n,o,s,r,i,c,g,v;ee(l,pt,f=>t(18,s=f)),ee(l,_t,f=>t(42,r=f)),ee(l,bt,f=>t(43,i=f)),ee(l,Ct,f=>t(44,c=f)),ee(l,kt,f=>t(19,g=f)),ee(l,Tt,f=>t(20,v=f));let{mode:u="random"}=e,{autoPlay:d=!1}=e,{sessionCount:_=8}=e,{baseNote:a=null}=e,{direction:m="asc"}=e,{useLocalStorage:w=!0}=e;const $="random-training-progress";let{onSessionComplete:b=null}=e,{onAllComplete:S=null}=e,{onMicrophoneError:I=null}=e;const U=null,O=[{note:"C4",name:"ド（中）",frequency:261.63,semitonesFromC:0},{note:"Db4",name:"ド#（中）",frequency:277.18,semitonesFromC:1},{note:"D4",name:"レ（中）",frequency:293.66,semitonesFromC:2},{note:"Eb4",name:"レ#（中）",frequency:311.13,semitonesFromC:3},{note:"E4",name:"ミ（中）",frequency:329.63,semitonesFromC:4},{note:"F4",name:"ファ（中）",frequency:349.23,semitonesFromC:5},{note:"Gb4",name:"ファ#（中）",frequency:369.99,semitonesFromC:6},{note:"Ab4",name:"ラb（中）",frequency:415.3,semitonesFromC:8},{note:"Bb3",name:"シb（低）",frequency:233.08,semitonesFromC:-2},{note:"B3",name:"シ（低）",frequency:246.94,semitonesFromC:-1}];let L="checking",Fe=null,He=null,qe=null,W=null,Y=null,X=!1,ne=!1,K=[],ae=0,ie=!1,Z="waiting",me=0,he=0,pe="ーー",R=[],ce=null,oe=!1,ue=null;Ae(async()=>{console.log(`🚀 [TrainingCore] ${u}モード初期化開始`);try{w&&(await at(),console.log(`✅ [TrainingCore] localStorage初期化完了: セッション${g}/8`)),await ze(),await xe(),Ce(),console.log(`✅ [TrainingCore] ${u}モード初期化完了`)}catch(f){console.error("❌ [TrainingCore] 初期化エラー:",f),I&&I(f.message)}}),et(()=>{Y&&Y.dispose()});async function ze(){const f=typeof localStorage<"u"&&localStorage.getItem("mic-test-completed")==="true";if(console.log("🎤 [TrainingCore] マイクテスト完了フラグ:",f),!f){console.log("⚠️ [TrainingCore] マイクテスト未完了 - マイクテストページへリダイレクト"),I&&I("マイクテストが必要です");return}new URLSearchParams(window.location.search).get("from")==="microphone-test"?(t(4,L="granted"),console.log("✅ [TrainingCore] マイクテスト経由でアクセス - 許可済み"),await _e()):(console.log("🔍 [TrainingCore] ダイレクトアクセス検出 - マイク許可状態確認"),await Ge())}async function Ge(){try{(await navigator.permissions.query({name:"microphone"})).state==="granted"?(console.log("✅ [TrainingCore] マイク許可済み検出 - AudioManager初期化実行"),await _e()):(t(4,L="denied"),console.log("⚠️ [TrainingCore] マイク許可が必要です"))}catch(f){console.error("❌ [TrainingCore] マイク許可確認エラー:",f),t(4,L="error")}}async function _e(){var f;t(4,L="checking");try{if(console.log("🎤 [TrainingCore] AudioManager経由でマイク許可確認開始"),!((f=navigator.mediaDevices)!=null&&f.getUserMedia)){t(4,L="error"),console.error("❌ [TrainingCore] getUserMedia未対応ブラウザ");return}const P=await Se.initialize();He=P.audioContext,Fe=P.mediaStream,qe=P.sourceNode,console.log("✅ [TrainingCore] AudioManager リソース取得完了"),t(4,L="granted"),t(11,Z="waiting"),setTimeout(async()=>{if(W&&W.getIsInitialized&&!W.getIsInitialized())try{console.log("🎙️ [TrainingCore] PitchDetector初期化開始");const A=/iPad/.test(navigator.userAgent),J=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document;if(A||J){console.log("📱 [TrainingCore] iPad/iPadOS検出 - AudioManager再初期化");try{await Se.initialize(),console.log("✅ [TrainingCore] AudioManager再初期化完了")}catch(Q){console.warn("⚠️ AudioManager再初期化エラー:",Q)}}await W.initialize(),console.log("✅ [TrainingCore] PitchDetector初期化完了")}catch(A){console.warn("⚠️ [TrainingCore] PitchDetector初期化失敗:",A)}},300)}catch(P){console.error("❌ [TrainingCore] マイク許可エラー:",P),t(4,L=(P==null?void 0:P.name)==="NotAllowedError"?"denied":"error"),I&&I(P.message)}}async function xe(){try{if(typeof window>"u"){console.log("⚠️ [TrainingCore] SSR環境検出 - 基音再生初期化スキップ");return}t(6,X=!0),console.log("🎹 [TrainingCore] Salamander Grand Piano 読み込み開始"),Y=new it({urls:{C4:"C4.mp3"},baseUrl:`${le}/audio/piano/`,release:1.5,volume:Me(),onload:()=>{t(6,X=!1),console.log("✅ [TrainingCore] Salamander Piano音源読み込み完了")},onerror:f=>{console.error("❌ [TrainingCore] Salamander Piano音源読み込みエラー:",f),t(6,X=!1)}}).toDestination(),await ct(),t(6,X=!1),console.log("✅ [TrainingCore] Salamander Grand Piano 読み込み完了")}catch(f){console.error("❌ [TrainingCore] 基音再生初期化エラー:",f),t(6,X=!1)}}async function be(){if(!(ne||!Y||X))try{if(typeof window<"u"&&window.Tone){const A=window.Tone.context||window.Tone.getContext();A&&A.state==="suspended"&&(console.log("🔄 [TrainingCore] AudioContext suspended検出 - 再開中..."),await A.resume(),console.log("✅ [TrainingCore] AudioContext再開完了")),ft.state!=="running"&&(await vt(),console.log("🔊 [TrainingCore] Tone.js AudioContext 開始"))}t(7,ne=!0);let f;if(u==="chromatic"&&a)f=O.find(A=>A.note===a)||O[0];else{const A=Math.floor(Math.random()*o.length),J=o[A];f=O.find(Q=>Q.note===J)||O[0]}const P=Me();Y.volume.value=P,console.log(`🎹 [TrainingCore] 基音再生: ${f.note} (${f.name}, ${f.frequency}Hz, ${P}dB)`),Y.triggerAttackRelease(f.note,2,gt(),.7),Oe(),setTimeout(()=>{t(7,ne=!1)},3e3)}catch(f){console.error("❌ [TrainingCore] 基音再生エラー:",f),t(7,ne=!1)}}function Ce(){t(8,K=n.map(()=>({state:"inactive"}))),console.log(`🎵 [TrainingCore] ガイドシステム初期化: ${n.length}音階`)}function Oe(){t(11,Z="guiding");let f=0;const P=setInterval(()=>{f+=2,t(9,ae=f),f>=100&&(clearInterval(P),t(10,ie=!0),setTimeout(()=>{Ue()},2e3))},40)}function Ue(){console.log("🎵 [TrainingCore] ガイドシーケンス開始");let f=0;const P=setInterval(()=>{f<K.length?(t(8,K[f].state="active",K),f++,t(8,K=[...K])):(clearInterval(P),t(11,Z="listening"),ce=Date.now(),R=n.map(A=>({name:A,cents:null,targetFreq:0,detectedFreq:0,diff:0,accuracy:0})),console.log("🎤 [TrainingCore] リスニングフェーズ開始"))},500)}async function Re(){if(!ce)return;const f=Math.round((Date.now()-ce)/1e3),P=a||r,A=c;console.log(`✅ [TrainingCore] セッション完了: ${f}秒`),w?await ht(R,f,P,A)&&(console.log("✅ [TrainingCore] セッション結果保存完了"),t(16,ue=i),t(15,oe=!0),b&&b(),s&&S&&S()):(t(16,ue={mode:u,sessionHistory:[{sessionId:1,grade:Ie.evaluateSession(R),accuracy:Ie.calculateAccuracy(R),baseNote:P,baseName:A,noteResults:R,completedAt:new Date().toISOString()}],isCompleted:!0,totalSessions:1,targetSessions:1}),t(15,oe=!0),b&&b())}function je(f){const{frequency:P,note:A,volume:J}=f.detail;t(13,he=P),t(14,pe=A),t(12,me=J),Z==="listening"&&R.length>0&&Ke(P)}function Ke(f,P){const J=xt(a||r),Q=Qe();if(Q>=0&&Q<R.length){const de=Ot(J,Q),Te=Ut(f,de);R[Q]={name:n[Q],cents:Te,targetFreq:de,detectedFreq:f,diff:f-de,accuracy:Rt(Te)},R=[...R],R.filter(Ze=>Ze.cents!==null).length>=n.length&&Re()}}function Qe(){for(let f=0;f<K.length;f++)if(K[f].state==="active")return f;return-1}function Je(f){console.error("❌ [TrainingCore] PitchDetectorエラー:",f.detail),I&&I(f.detail.error)}function ke(){t(15,oe=!1),t(11,Z="waiting"),t(9,ae=0),t(10,ie=!1),Ce()}function We(){ke(),d&&!s&&setTimeout(()=>be(),1e3)}function Xe(){fe(`${le}/`)}function Ye(f){tt[f?"unshift":"push"](()=>{W=f,t(5,W)})}return l.$$set=f=>{"mode"in f&&t(0,u=f.mode),"autoPlay"in f&&t(1,d=f.autoPlay),"sessionCount"in f&&t(2,_=f.sessionCount),"baseNote"in f&&t(27,a=f.baseNote),"direction"in f&&t(28,m=f.direction),"useLocalStorage"in f&&t(3,w=f.useLocalStorage),"onSessionComplete"in f&&t(30,b=f.onSessionComplete),"onAllComplete"in f&&t(31,S=f.onAllComplete),"onMicrophoneError"in f&&t(32,I=f.onMicrophoneError)},l.$$.update=()=>{l.$$.dirty[0]&268435457&&t(17,n=u==="chromatic"?m==="asc"?["ド","ド#","レ","レ#","ミ","ファ","ファ#","ソ","ソ#","ラ","ラ#","シ"]:["シ","ラ#","ラ","ソ#","ソ","ファ#","ファ","ミ","レ#","レ","ド#","ド"]:["ド","レ","ミ","ファ","ソ","ラ","シ","ド（高）"]),l.$$.dirty[0]&1&&(o=u==="continuous"?["Bb3","B3","C4","Db4","D4","Eb4","E4","F4","Gb4","Ab4"]:["C4","Db4","D4","Eb4","E4","F4","Gb4","Ab4","Bb3","B3"])},[u,d,_,w,L,W,X,ne,K,ae,ie,Z,me,he,pe,oe,ue,n,s,g,v,be,je,Je,ke,We,Xe,a,m,$,b,S,I,U,Ye]}class Kt extends Pe{constructor(e){super(),Ve(this,e,jt,Gt,Ne,{mode:0,autoPlay:1,sessionCount:2,baseNote:27,direction:28,useLocalStorage:3,sessionKey:29,onSessionComplete:30,onAllComplete:31,onMicrophoneError:32,onStorageError:33},null,[-1,-1])}get sessionKey(){return this.$$.ctx[29]}get onStorageError(){return this.$$.ctx[33]}}function Qt(l){let e,t='<div class="loading-spinner svelte-1v0ddfk">⚡</div> <p>読み込み中...</p>';return{c(){e=k("div"),e.innerHTML=t,this.h()},l(n){e=C(n,"DIV",{class:!0,"data-svelte-h":!0}),B(e)!=="svelte-1awb2cx"&&(e.innerHTML=t),this.h()},h(){T(e,"class","loading-placeholder svelte-1v0ddfk")},m(n,o){D(n,e,o)},p:j,i:j,o:j,d(n){n&&h(e)}}}function Jt(l){let e,t;return e=new Kt({props:{mode:"continuous",autoPlay:!0,sessionCount:8,useLocalStorage:!0,sessionKey:"continuous-training-progress",onMicrophoneError:l[3],onStorageError:en,onSessionComplete:tn,onAllComplete:nn}}),{c(){z(e.$$.fragment)},l(n){q(e.$$.fragment,n)},m(n,o){H(e,n,o),t=!0},p:j,i(n){t||(V(e.$$.fragment,n),t=!0)},o(n){N(e.$$.fragment,n),t=!1},d(n){F(e,n)}}}function Wt(l){let e,t,n,o='<div class="challenge-icon svelte-1v0ddfk">⚡</div>',s,r,i,c="連続チャレンジモード",g,v,u=`<div class="feature-item svelte-1v0ddfk"><div class="feature-icon svelte-1v0ddfk">🎯</div> <div class="feature-text svelte-1v0ddfk"><strong class="svelte-1v0ddfk">8セッション連続</strong><br/>
                  途中で止まらない集中トレーニング</div></div> <div class="feature-item svelte-1v0ddfk"><div class="feature-icon svelte-1v0ddfk">🔥</div> <div class="feature-text svelte-1v0ddfk"><strong class="svelte-1v0ddfk">中級向け難易度</strong><br/>
                  より難しい基音での挑戦</div></div> <div class="feature-item svelte-1v0ddfk"><div class="feature-icon svelte-1v0ddfk">🚀</div> <div class="feature-text svelte-1v0ddfk"><strong class="svelte-1v0ddfk">自動進行</strong><br/>
                  セッション完了後に自動で次へ</div></div>`,d,_,a='<h3 class="svelte-1v0ddfk">🎼 使用基音（中級レベル）</h3> <div class="base-notes-grid svelte-1v0ddfk"><span class="base-note svelte-1v0ddfk">Bb3</span> <span class="base-note svelte-1v0ddfk">B3</span> <span class="base-note svelte-1v0ddfk">Db4</span> <span class="base-note svelte-1v0ddfk">Eb4</span> <span class="base-note svelte-1v0ddfk">F#4</span> <span class="base-note svelte-1v0ddfk">G#4</span> <span class="base-note svelte-1v0ddfk">Bb4</span> <span class="base-note svelte-1v0ddfk">C#5</span> <span class="base-note svelte-1v0ddfk">Eb5</span> <span class="base-note svelte-1v0ddfk">F#5</span></div>',m,w,$="🔥 チャレンジ開始！",b,S;return{c(){e=k("div"),t=k("div"),n=k("div"),n.innerHTML=o,s=M(),r=k("div"),i=k("h2"),i.textContent=c,g=M(),v=k("div"),v.innerHTML=u,d=M(),_=k("div"),_.innerHTML=a,m=M(),w=k("button"),w.textContent=$,this.h()},l(I){e=C(I,"DIV",{class:!0});var U=y(e);t=C(U,"DIV",{class:!0});var O=y(t);n=C(O,"DIV",{class:!0,"data-svelte-h":!0}),B(n)!=="svelte-13ksuac"&&(n.innerHTML=o),s=E(O),r=C(O,"DIV",{class:!0});var L=y(r);i=C(L,"H2",{class:!0,"data-svelte-h":!0}),B(i)!=="svelte-1je1qsu"&&(i.textContent=c),g=E(L),v=C(L,"DIV",{class:!0,"data-svelte-h":!0}),B(v)!=="svelte-1ew1nx5"&&(v.innerHTML=u),d=E(L),_=C(L,"DIV",{class:!0,"data-svelte-h":!0}),B(_)!=="svelte-9z8rw7"&&(_.innerHTML=a),m=E(L),w=C(L,"BUTTON",{class:!0,"data-svelte-h":!0}),B(w)!=="svelte-la0s3j"&&(w.textContent=$),L.forEach(h),O.forEach(h),U.forEach(h),this.h()},h(){T(n,"class","challenge-icon-wrapper svelte-1v0ddfk"),T(i,"class","challenge-title svelte-1v0ddfk"),T(v,"class","challenge-features svelte-1v0ddfk"),T(_,"class","difficulty-info svelte-1v0ddfk"),T(w,"class","start-challenge-button svelte-1v0ddfk"),T(r,"class","challenge-content"),T(t,"class","challenge-card svelte-1v0ddfk"),T(e,"class","start-screen svelte-1v0ddfk")},m(I,U){D(I,e,U),p(e,t),p(t,n),p(t,s),p(t,r),p(r,i),p(r,g),p(r,v),p(r,d),p(r,_),p(r,m),p(r,w),b||(S=Be(w,"click",l[4]),b=!0)},p:j,i:j,o:j,d(I){I&&h(e),b=!1,S()}}}function Xt(l){let e,t,n,o="⚠️",s,r,i,c="マイクテストが必要です",g,v,u="連続チャレンジを開始する前に、マイクの動作確認を行ってください。",d,_,a="マイクテストを開始",m,w;return{c(){e=k("div"),t=k("div"),n=k("div"),n.textContent=o,s=M(),r=k("div"),i=k("h3"),i.textContent=c,g=M(),v=k("p"),v.textContent=u,d=M(),_=k("button"),_.textContent=a,this.h()},l($){e=C($,"DIV",{class:!0});var b=y(e);t=C(b,"DIV",{class:!0});var S=y(t);n=C(S,"DIV",{class:!0,"data-svelte-h":!0}),B(n)!=="svelte-dwi5dc"&&(n.textContent=o),s=E(S),r=C(S,"DIV",{class:!0});var I=y(r);i=C(I,"H3",{class:!0,"data-svelte-h":!0}),B(i)!=="svelte-17kvze2"&&(i.textContent=c),g=E(I),v=C(I,"P",{class:!0,"data-svelte-h":!0}),B(v)!=="svelte-t9m3nr"&&(v.textContent=u),d=E(I),_=C(I,"BUTTON",{class:!0,"data-svelte-h":!0}),B(_)!=="svelte-18xr2xp"&&(_.textContent=a),I.forEach(h),S.forEach(h),b.forEach(h),this.h()},h(){T(n,"class","warning-icon svelte-1v0ddfk"),T(i,"class","svelte-1v0ddfk"),T(v,"class","svelte-1v0ddfk"),T(_,"class","mic-test-button svelte-1v0ddfk"),T(r,"class","warning-content svelte-1v0ddfk"),T(t,"class","warning-card svelte-1v0ddfk"),T(e,"class","mic-test-required svelte-1v0ddfk")},m($,b){D($,e,b),p(e,t),p(t,n),p(t,s),p(t,r),p(r,i),p(r,g),p(r,v),p(r,d),p(r,_),m||(w=Be(_,"click",l[5]),m=!0)},p:j,i:j,o:j,d($){$&&h(e),m=!1,w()}}}function Yt(l){let e,t,n='<h1 class="page-title svelte-1v0ddfk">⚡ 連続チャレンジモード</h1> <p class="page-description svelte-1v0ddfk">中級者向け：より難しい基音で8セッション連続挑戦</p>',o,s,r,i;const c=[Xt,Wt,Jt,Qt],g=[];function v(u,d){return u[2]&&!u[0]?0:u[2]&&u[0]&&u[1]?1:u[2]&&u[0]&&!u[1]?2:u[2]?-1:3}return~(s=v(l))&&(r=g[s]=c[s](l)),{c(){e=k("div"),t=k("div"),t.innerHTML=n,o=M(),r&&r.c(),this.h()},l(u){e=C(u,"DIV",{class:!0});var d=y(e);t=C(d,"DIV",{class:!0,"data-svelte-h":!0}),B(t)!=="svelte-1la1yd9"&&(t.innerHTML=n),o=E(d),r&&r.l(d),d.forEach(h),this.h()},h(){T(t,"class","page-header svelte-1v0ddfk"),T(e,"class","continuous-training-page svelte-1v0ddfk")},m(u,d){D(u,e,d),p(e,t),p(e,o),~s&&g[s].m(e,null),i=!0},p(u,d){let _=s;s=v(u),s===_?~s&&g[s].p(u,d):(r&&(ve(),N(g[_],1,1,()=>{g[_]=null}),ge()),~s?(r=g[s],r?r.p(u,d):(r=g[s]=c[s](u),r.c()),V(r,1),r.m(e,null)):r=null)},i(u){i||(V(r),i=!0)},o(u){N(r),i=!1},d(u){u&&h(e),~s&&g[s].d()}}}function Zt(l){let e,t,n;return t=new ot({props:{showBackButton:!0,$$slots:{default:[Yt]},$$scope:{ctx:l}}}),{c(){e=M(),z(t.$$.fragment),this.h()},l(o){st("svelte-13kpo59",document.head).forEach(h),e=E(o),q(t.$$.fragment,o),this.h()},h(){document.title="連続チャレンジモード - 相対音感トレーニング"},m(o,s){D(o,e,s),H(t,o,s),n=!0},p(o,[s]){const r={};s&71&&(r.$$scope={dirty:s,ctx:o}),t.$set(r)},i(o){n||(V(t.$$.fragment,o),n=!0)},o(o){N(t.$$.fragment,o),n=!1},d(o){o&&h(e),F(t,o)}}}function en(l){console.error("🚨 [ContinuousTraining] ストレージエラー:",l)}function tn(){console.log("✅ [ContinuousTraining] セッション完了")}function nn(){console.log("🎉 [ContinuousTraining] 8セッション完了！")}function sn(l,e,t){let n=!1,o=!1,s=!1;Ae(()=>{t(2,s=!0),typeof localStorage<"u"&&(t(0,n=localStorage.getItem("mic-test-completed")==="true"),console.log("🎤 [ContinuousTraining] マイクテスト完了フラグ:",n))});function r(g){console.error("🚨 [ContinuousTraining] マイクロフォンエラー:",g),fe(`${le}/microphone-test?mode=continuous`)}function i(){t(1,o=!1)}return[n,o,s,r,i,()=>fe(`${le}/microphone-test?mode=continuous`)]}class mn extends Pe{constructor(e){super(),Ve(this,e,sn,Zt,Ne,{})}}export{mn as component,gn as universal};
