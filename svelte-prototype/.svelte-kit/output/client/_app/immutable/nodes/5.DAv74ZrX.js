import{S as Ee,i as ye,s as Me,d as m,m as P,o as M,p as ge,q as ve,b as S,y as j,e as _,f as I,j as C,l as W,M as Pe,Q as Xe,C as A,D as H,E as L,F as B,h as k,k as E,c as b,K as ne,P as Ye,n as O,G as q,J as Ze,a as oe,g as x,t as F,r as $e,H as et,A as qe}from"../chunks/ChDCDHhu.js";import"../chunks/IHki7fMi.js";import{g as de,b as he}from"../chunks/DYrXUu6e.js";import{C as X,P as tt}from"../chunks/DQaHVEr9.js";import{e as Te}from"../chunks/D6YF6ztN.js";import{B as Ve}from"../chunks/Cx4dwUxr.js";import{a as nt,b as st,P as rt}from"../chunks/B6wEjQM2.js";import{l as ot,S as lt,a as at,U as it,A as ct,c as ut,s as ft,M as dt,i as ht,n as gt,u as vt,b as mt,d as pt,p as bt,e as _t,E as Se}from"../chunks/DrUK7av6.js";const Ct=!1,fn=Object.freeze(Object.defineProperty({__proto__:null,prerender:Ct},Symbol.toStringTag,{value:"Module"}));function we(l,e,t){const n=l.slice();return n[56]=e[t],n[58]=t,n}function jt(l){let e,t,n,r,s,o,i,c,g,h,d,f=l[3]&&Ie(l);n=new X({props:{class:"main-card half-width",$$slots:{default:[Mt]},$$scope:{ctx:l}}}),s=new X({props:{class:"main-card half-width",$$slots:{default:[Pt]},$$scope:{ctx:l}}}),i=new X({props:{class:"main-card",$$slots:{default:[qt]},$$scope:{ctx:l}}});let p={isActive:l[4]==="granted"&&l[11]==="listening",debugMode:!1};return h=new st({props:p}),l[34](h),h.$on("pitchUpdate",l[22]),h.$on("error",l[23]),{c(){f&&f.c(),e=E(),t=C("div"),B(n.$$.fragment),r=E(),B(s.$$.fragment),o=E(),B(i.$$.fragment),c=E(),g=C("div"),B(h.$$.fragment),this.h()},l(a){f&&f.l(a),e=k(a),t=_(a,"DIV",{class:!0});var v=I(t);L(n.$$.fragment,v),r=k(v),L(s.$$.fragment,v),v.forEach(m),o=k(a),L(i.$$.fragment,a),c=k(a),g=_(a,"DIV",{style:!0});var w=I(g);L(h.$$.fragment,w),w.forEach(m),this.h()},h(){j(t,"class","side-by-side-container svelte-q662rn"),ne(g,"display","none")},m(a,v){f&&f.m(a,v),S(a,e,v),S(a,t,v),H(n,t,null),b(t,r),H(s,t,null),S(a,o,v),H(i,a,v),S(a,c,v),S(a,g,v),H(h,g,null),d=!0},p(a,v){a[3]?f?(f.p(a,v),v[0]&8&&M(f,1)):(f=Ie(a),f.c(),M(f,1),f.m(e.parentNode,e)):f&&(ge(),P(f,1,1,()=>{f=null}),ve());const w={};v[0]&3778|v[1]&268435456&&(w.$$scope={dirty:v,ctx:a}),n.$set(w);const T={};v[0]&28672|v[1]&268435456&&(T.$$scope={dirty:v,ctx:a}),s.$set(T);const D={};v[0]&131329|v[1]&268435456&&(D.$$scope={dirty:v,ctx:a}),i.$set(D);const $={};v[0]&2064&&($.isActive=a[4]==="granted"&&a[11]==="listening"),h.$set($)},i(a){d||(M(f),M(n.$$.fragment,a),M(s.$$.fragment,a),M(i.$$.fragment,a),M(h.$$.fragment,a),d=!0)},o(a){P(f),P(n.$$.fragment,a),P(s.$$.fragment,a),P(i.$$.fragment,a),P(h.$$.fragment,a),d=!1},d(a){a&&(m(e),m(t),m(o),m(c),m(g)),f&&f.d(a),A(n),A(s),A(i,a),l[34](null),A(h)}}}function Dt(l){let e,t,n,r;return e=new it({props:{currentScoreData:l[16],intervalData:[],consistencyData:[],feedbackData:null,technicalFeedbackData:null}}),n=new ct({props:{showRestart:!l[18],showNext:!l[18],showHome:!0}}),n.$on("restart",l[24]),n.$on("next",l[25]),n.$on("home",l[26]),{c(){B(e.$$.fragment),t=E(),B(n.$$.fragment)},l(s){L(e.$$.fragment,s),t=k(s),L(n.$$.fragment,s)},m(s,o){H(e,s,o),S(s,t,o),H(n,s,o),r=!0},p(s,o){const i={};o[0]&65536&&(i.currentScoreData=s[16]),e.$set(i);const c={};o[0]&262144&&(c.showRestart=!s[18]),o[0]&262144&&(c.showNext=!s[18]),n.$set(c)},i(s){r||(M(e.$$.fragment,s),M(n.$$.fragment,s),r=!0)},o(s){P(e.$$.fragment,s),P(n.$$.fragment,s),r=!1},d(s){s&&m(t),A(e,s),A(n,s)}}}function $t(l){let e,t;return e=new X({props:{class:"main-card",$$slots:{default:[Nt]},$$scope:{ctx:l}}}),{c(){B(e.$$.fragment)},l(n){L(e.$$.fragment,n)},m(n,r){H(e,n,r),t=!0},p(n,r){const s={};r[1]&268435456&&(s.$$scope={dirty:r,ctx:n}),e.$set(s)},i(n){t||(M(e.$$.fragment,n),t=!0)},o(n){P(e.$$.fragment,n),t=!1},d(n){A(e,n)}}}function Tt(l){let e,t;return e=new X({props:{class:"main-card",$$slots:{default:[At]},$$scope:{ctx:l}}}),{c(){B(e.$$.fragment)},l(n){L(e.$$.fragment,n)},m(n,r){H(e,n,r),t=!0},p(n,r){const s={};r[1]&268435456&&(s.$$scope={dirty:r,ctx:n}),e.$set(s)},i(n){t||(M(e.$$.fragment,n),t=!0)},o(n){P(e.$$.fragment,n),t=!1},d(n){A(e,n)}}}function Ie(l){let e,t;return e=new X({props:{class:"main-card",$$slots:{default:[St]},$$scope:{ctx:l}}}),{c(){B(e.$$.fragment)},l(n){L(e.$$.fragment,n)},m(n,r){H(e,n,r),t=!0},p(n,r){const s={};r[0]&1572868|r[1]&268435456&&(s.$$scope={dirty:r,ctx:n}),e.$set(s)},i(n){t||(M(e.$$.fragment,n),t=!0)},o(n){P(e.$$.fragment,n),t=!1},d(n){A(e,n)}}}function St(l){let e,t='<h3 class="section-title svelte-q662rn">📊 進捗状況</h3>',n,r,s,o,i,c,g,h,d,f,p;return{c(){e=C("div"),e.innerHTML=t,n=E(),r=C("div"),s=C("div"),o=C("div"),i=F("セッション "),c=F(l[19]),g=F(" / "),h=F(l[2]),d=E(),f=C("div"),p=C("div"),this.h()},l(a){e=_(a,"DIV",{class:!0,"data-svelte-h":!0}),q(e)!=="svelte-1hcye1c"&&(e.innerHTML=t),n=k(a),r=_(a,"DIV",{class:!0});var v=I(r);s=_(v,"DIV",{class:!0});var w=I(s);o=_(w,"DIV",{class:!0});var T=I(o);i=x(T,"セッション "),c=x(T,l[19]),g=x(T," / "),h=x(T,l[2]),T.forEach(m),d=k(w),f=_(w,"DIV",{class:!0});var D=I(f);p=_(D,"DIV",{class:!0,style:!0}),I(p).forEach(m),D.forEach(m),w.forEach(m),v.forEach(m),this.h()},h(){j(e,"class","card-header svelte-q662rn"),j(o,"class","session-counter svelte-q662rn"),j(p,"class","progress-fill svelte-q662rn"),ne(p,"width",l[20]+"%"),j(f,"class","progress-bar svelte-q662rn"),j(s,"class","progress-info svelte-q662rn"),j(r,"class","card-content svelte-q662rn")},m(a,v){S(a,e,v),S(a,n,v),S(a,r,v),b(r,s),b(s,o),b(o,i),b(o,c),b(o,g),b(o,h),b(s,d),b(s,f),b(f,p)},p(a,v){v[0]&524288&&oe(c,a[19]),v[0]&4&&oe(h,a[2]),v[0]&1048576&&ne(p,"width",a[20]+"%")},d(a){a&&(m(e),m(n),m(r))}}}function wt(l){let e;return{c(){e=F("🎹 基音再生")},l(t){e=x(t,"🎹 基音再生")},m(t,n){S(t,e,n)},d(t){t&&m(e)}}}function It(l){let e;return{c(){e=F("🔄 自動再生モード")},l(t){e=x(t,"🔄 自動再生モード")},m(t,n){S(t,e,n)},d(t){t&&m(e)}}}function kt(l){let e;return{c(){e=F("⏳ 読み込み中...")},l(t){e=x(t,"⏳ 読み込み中...")},m(t,n){S(t,e,n)},d(t){t&&m(e)}}}function Et(l){let e;return{c(){e=F("🎵 再生中...")},l(t){e=x(t,"🎵 再生中...")},m(t,n){S(t,e,n)},d(t){t&&m(e)}}}function yt(l){let e;function t(s,o){return s[7]?Et:s[6]?kt:s[1]?It:wt}let n=t(l),r=n(l);return{c(){r.c(),e=$e()},l(s){r.l(s),e=$e()},m(s,o){r.m(s,o),S(s,e,o)},p(s,o){n!==(n=t(s))&&(r.d(1),r=n(s),r&&(r.c(),r.m(e.parentNode,e)))},d(s){s&&m(e),r.d(s)}}}function Mt(l){let e,t='<h3 class="section-title svelte-q662rn">🎹 基音再生</h3>',n,r,s,o,i,c,g="ガイド開始まで",h,d,f,p,a,v,w,T;return s=new Ve({props:{variant:"primary",disabled:l[7]||l[6]||l[1]&&l[11]==="guiding",$$slots:{default:[yt]},$$scope:{ctx:l}}}),s.$on("click",l[21]),v=new dt({props:{size:"20"}}),{c(){e=C("div"),e.innerHTML=t,n=E(),r=C("div"),B(s.$$.fragment),o=E(),i=C("div"),c=C("div"),c.textContent=g,h=E(),d=C("div"),f=C("div"),p=E(),a=C("div"),B(v.$$.fragment),this.h()},l(D){e=_(D,"DIV",{class:!0,"data-svelte-h":!0}),q(e)!=="svelte-1u9jvpv"&&(e.innerHTML=t),n=k(D),r=_(D,"DIV",{class:!0});var $=I(r);L(s.$$.fragment,$),o=k($),i=_($,"DIV",{class:!0});var y=I(i);c=_(y,"DIV",{class:!0,"data-svelte-h":!0}),q(c)!=="svelte-1dufnpv"&&(c.textContent=g),h=k(y),d=_(y,"DIV",{class:!0});var V=I(d);f=_(V,"DIV",{class:!0,style:!0}),I(f).forEach(m),p=k(V),a=_(V,"DIV",{class:!0});var G=I(a);L(v.$$.fragment,G),G.forEach(m),V.forEach(m),y.forEach(m),$.forEach(m),this.h()},h(){j(e,"class","card-header svelte-q662rn"),j(c,"class","guide-start-label svelte-q662rn"),j(f,"class","guide-progress-fill svelte-q662rn"),ne(f,"width",l[9]+"%"),j(a,"class",w="guide-music-icon "+(l[10]?"glowing":"")+" svelte-q662rn"),j(d,"class","guide-start-bar svelte-q662rn"),j(i,"class","guide-start-bar-container svelte-q662rn"),j(r,"class","card-content svelte-q662rn")},m(D,$){S(D,e,$),S(D,n,$),S(D,r,$),H(s,r,null),b(r,o),b(r,i),b(i,c),b(i,h),b(i,d),b(d,f),b(d,p),b(d,a),H(v,a,null),T=!0},p(D,$){const y={};$[0]&2242&&(y.disabled=D[7]||D[6]||D[1]&&D[11]==="guiding"),$[0]&194|$[1]&268435456&&(y.$$scope={dirty:$,ctx:D}),s.$set(y),(!T||$[0]&512)&&ne(f,"width",D[9]+"%"),(!T||$[0]&1024&&w!==(w="guide-music-icon "+(D[10]?"glowing":"")+" svelte-q662rn"))&&j(a,"class",w)},i(D){T||(M(s.$$.fragment,D),M(v.$$.fragment,D),T=!0)},o(D){P(s.$$.fragment,D),P(v.$$.fragment,D),T=!1},d(D){D&&(m(e),m(n),m(r)),A(s),A(v)}}}function Pt(l){let e,t='<h3 class="section-title svelte-q662rn">🎤 リアルタイム検出</h3>',n,r,s,o;return s=new rt({props:{frequency:l[13],note:l[14],volume:l[12],isMuted:!1}}),{c(){e=C("div"),e.innerHTML=t,n=E(),r=C("div"),B(s.$$.fragment),this.h()},l(i){e=_(i,"DIV",{class:!0,"data-svelte-h":!0}),q(e)!=="svelte-momj6l"&&(e.innerHTML=t),n=k(i),r=_(i,"DIV",{class:!0});var c=I(r);L(s.$$.fragment,c),c.forEach(m),this.h()},h(){j(e,"class","card-header svelte-q662rn"),j(r,"class","card-content svelte-q662rn")},m(i,c){S(i,e,c),S(i,n,c),S(i,r,c),H(s,r,null),o=!0},p(i,c){const g={};c[0]&8192&&(g.frequency=i[13]),c[0]&16384&&(g.note=i[14]),c[0]&4096&&(g.volume=i[12]),s.$set(g)},i(i){o||(M(s.$$.fragment,i),o=!0)},o(i){P(s.$$.fragment,i),o=!1},d(i){i&&(m(e),m(n),m(r)),A(s)}}}function ke(l){let e,t=l[56]+"",n,r,s;return{c(){e=C("div"),n=F(t),r=E(),this.h()},l(o){e=_(o,"DIV",{class:!0});var i=I(e);n=x(i,t),r=k(i),i.forEach(m),this.h()},h(){var o;j(e,"class",s="scale-item "+(((o=l[8][l[58]])==null?void 0:o.state)||"inactive")+" svelte-q662rn")},m(o,i){S(o,e,i),b(e,n),b(e,r)},p(o,i){var c;i[0]&131072&&t!==(t=o[56]+"")&&oe(n,t),i[0]&256&&s!==(s="scale-item "+(((c=o[8][o[58]])==null?void 0:c.state)||"inactive")+" svelte-q662rn")&&j(e,"class",s)},d(o){o&&m(e)}}}function qt(l){let e,t,n,r=l[0]==="chromatic"?"12":"8",s,o,i,c,g,h=Te(l[17]),d=[];for(let f=0;f<h.length;f+=1)d[f]=ke(we(l,h,f));return{c(){e=C("div"),t=C("h3"),n=F("🎵 "),s=F(r),o=F("音階ガイド"),i=E(),c=C("div"),g=C("div");for(let f=0;f<d.length;f+=1)d[f].c();this.h()},l(f){e=_(f,"DIV",{class:!0});var p=I(e);t=_(p,"H3",{class:!0});var a=I(t);n=x(a,"🎵 "),s=x(a,r),o=x(a,"音階ガイド"),a.forEach(m),p.forEach(m),i=k(f),c=_(f,"DIV",{class:!0});var v=I(c);g=_(v,"DIV",{class:!0});var w=I(g);for(let T=0;T<d.length;T+=1)d[T].l(w);w.forEach(m),v.forEach(m),this.h()},h(){j(t,"class","section-title svelte-q662rn"),j(e,"class","card-header svelte-q662rn"),j(g,"class","scale-guide svelte-q662rn"),j(c,"class","card-content svelte-q662rn")},m(f,p){S(f,e,p),b(e,t),b(t,n),b(t,s),b(t,o),S(f,i,p),S(f,c,p),b(c,g);for(let a=0;a<d.length;a+=1)d[a]&&d[a].m(g,null)},p(f,p){if(p[0]&1&&r!==(r=f[0]==="chromatic"?"12":"8")&&oe(s,r),p[0]&131328){h=Te(f[17]);let a;for(a=0;a<h.length;a+=1){const v=we(f,h,a);d[a]?d[a].p(v,p):(d[a]=ke(v),d[a].c(),d[a].m(g,null))}for(;a<d.length;a+=1)d[a].d(1);d.length=h.length}},d(f){f&&(m(e),m(i),m(c)),Ze(d,f)}}}function Vt(l){let e;return{c(){e=F("ホームに戻る")},l(t){e=x(t,"ホームに戻る")},m(t,n){S(t,e,n)},d(t){t&&m(e)}}}function Nt(l){let e,t,n="⚠️ マイク許可が必要です",r,s,o="マイクテストページから開始してください",i,c,g;return c=new Ve({props:{variant:"primary",$$slots:{default:[Vt]},$$scope:{ctx:l}}}),c.$on("click",l[26]),{c(){e=C("div"),t=C("h3"),t.textContent=n,r=E(),s=C("p"),s.textContent=o,i=E(),B(c.$$.fragment),this.h()},l(h){e=_(h,"DIV",{class:!0});var d=I(e);t=_(d,"H3",{"data-svelte-h":!0}),q(t)!=="svelte-1iz0ljq"&&(t.textContent=n),r=k(d),s=_(d,"P",{"data-svelte-h":!0}),q(s)!=="svelte-13xvrzt"&&(s.textContent=o),i=k(d),L(c.$$.fragment,d),d.forEach(m),this.h()},h(){j(e,"class","card-content text-center svelte-q662rn")},m(h,d){S(h,e,d),b(e,t),b(e,r),b(e,s),b(e,i),H(c,e,null),g=!0},p(h,d){const f={};d[1]&268435456&&(f.$$scope={dirty:d,ctx:h}),c.$set(f)},i(h){g||(M(c.$$.fragment,h),g=!0)},o(h){P(c.$$.fragment,h),g=!1},d(h){h&&m(e),A(c)}}}function At(l){let e,t="<h3>⏳ マイク初期化中...</h3> <p>しばらくお待ちください</p>";return{c(){e=C("div"),e.innerHTML=t,this.h()},l(n){e=_(n,"DIV",{class:!0,"data-svelte-h":!0}),q(e)!=="svelte-1f701n6"&&(e.innerHTML=t),this.h()},h(){j(e,"class","card-content text-center svelte-q662rn")},m(n,r){S(n,e,r)},p:O,d(n){n&&m(e)}}}function Ht(l){let e,t,n,r;const s=[Tt,$t,Dt,jt],o=[];function i(c,g){return c[4]==="checking"?0:c[4]==="denied"||c[4]==="error"?1:c[15]&&c[16]?2:3}return t=i(l),n=o[t]=s[t](l),{c(){e=C("div"),n.c(),this.h()},l(c){e=_(c,"DIV",{class:!0});var g=I(e);n.l(g),g.forEach(m),this.h()},h(){j(e,"class","training-core svelte-q662rn")},m(c,g){S(c,e,g),o[t].m(e,null),r=!0},p(c,g){let h=t;t=i(c),t===h?o[t].p(c,g):(ge(),P(o[h],1,1,()=>{o[h]=null}),ve(),n=o[t],n?n.p(c,g):(n=o[t]=s[t](c),n.c()),M(n,1),n.m(e,null))},i(c){r||(M(n),r=!0)},o(c){P(n),r=!1},d(c){c&&m(e),o[t].d()}}}function Lt(){const l=/iPhone/.test(navigator.userAgent),e=/iPad/.test(navigator.userAgent),t=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document;return l||e||t?35:-6}function Bt(l){return{C4:261.63,Db4:277.18,D4:293.66,Eb4:311.13,E4:329.63,F4:349.23,Gb4:369.99,G4:392,Ab4:415.3,A4:440,Bb4:466.16,B4:493.88,C5:523.25,Db5:554.37,D5:587.33,Eb5:622.25,E5:659.25,F5:698.46,Gb5:739.99,G5:783.99}[l]||261.63}function xt(l,e){return l*([1,1.125,1.25,1.3333333333333333,1.5,1.6666666666666667,1.875,2][e]||1)}function Ft(l,e){return!l||!e||l<=0||e<=0?null:Math.round(1200*Math.log2(l/e))}function zt(l){if(l===null)return 0;const e=Math.abs(l);return Math.max(0,Math.min(100,100-e/50*100))}function Gt(l,e,t){let n,r,s,o,i,c,g;W(l,ht,u=>t(18,r=u)),W(l,gt,u=>t(42,s=u)),W(l,vt,u=>t(43,o=u)),W(l,mt,u=>t(44,i=u)),W(l,pt,u=>t(19,c=u)),W(l,bt,u=>t(20,g=u));let{mode:h="random"}=e,{autoPlay:d=!1}=e,{sessionCount:f=8}=e,{baseNote:p=null}=e,{direction:a="asc"}=e,{useLocalStorage:v=!0}=e;const w="random-training-progress";let{onSessionComplete:T=null}=e,{onAllComplete:D=null}=e,{onMicrophoneError:$=null}=e;const y=null;let V="checking",G=null,z=null,Ne=null,J=null,Q=null,Y=!1,Z=!1,K=[],le=0,ae=!1,ee="waiting",me=0,pe=0,be="ーー",R=[],ie=null,se=!1,ce=null;Pe(async()=>{console.log(`🚀 [TrainingCore] ${h}モード初期化開始`);try{v&&(await ot(),console.log(`✅ [TrainingCore] localStorage初期化完了: セッション${c}/8`)),await Ae(),await Be(),Ce(),console.log(`✅ [TrainingCore] ${h}モード初期化完了`)}catch(u){console.error("❌ [TrainingCore] 初期化エラー:",u),$&&$(u.message)}}),Xe(()=>{Q&&Q.dispose()});async function Ae(){const u=typeof localStorage<"u"&&localStorage.getItem("mic-test-completed")==="true";if(console.log("🎤 [TrainingCore] マイクテスト完了フラグ:",u),!u){console.log("⚠️ [TrainingCore] マイクテスト未完了 - マイクテストページへリダイレクト"),$&&$("マイクテストが必要です");return}new URLSearchParams(window.location.search).get("from")==="microphone-test"?(t(4,V="granted"),console.log("✅ [TrainingCore] マイクテスト経由でアクセス - 許可済み"),await ue()):(await He(),V==="granted"&&await ue())}async function He(){try{(await navigator.permissions.query({name:"microphone"})).state==="granted"?await ue():(t(4,V="denied"),console.log("⚠️ [TrainingCore] マイク許可が必要です"))}catch(u){console.error("❌ [TrainingCore] マイク許可確認エラー:",u),t(4,V="error")}}async function ue(){try{const u=await nt.initialize();z=u.audioContext,G=u.mediaStream,Ne=u.sourceNode,t(4,V="granted"),console.log("✅ [TrainingCore] AudioManager初期化完了"),await Le()}catch(u){console.error("❌ [TrainingCore] AudioManager初期化エラー:",u),t(4,V="error"),$&&$(u.message)}}async function Le(){console.log("🎙️ [TrainingCore] PitchDetector初期化開始");let u=0;const N=10;for(;!J&&u<N;)console.log(`⏳ [TrainingCore] PitchDetectorコンポーネント待機中... (${u+1}/${N})`),await new Promise(U=>setTimeout(U,200)),u++;if(!J){console.error("❌ [TrainingCore] PitchDetectorコンポーネント取得失敗");return}try{z&&G?(console.log("🔧 [TrainingCore] PitchDetector外部AudioContext初期化実行"),await J.initializeWithExternalAudioContext(z,G),console.log("✅ [TrainingCore] PitchDetector初期化完了")):console.error("❌ [TrainingCore] AudioContext または MediaStream が未初期化")}catch(U){console.error("❌ [TrainingCore] PitchDetector初期化エラー:",U)}}async function Be(){try{t(6,Y=!0),console.log("🎹 [TrainingCore] Salamander Grand Piano 読み込み開始"),Q=new lt({urls:{C4:"C4.mp3"},baseUrl:"https://tonejs.github.io/audio/salamander/",release:1.5}).toDestination(),await at(),t(6,Y=!1),console.log("✅ [TrainingCore] Salamander Grand Piano 読み込み完了")}catch(u){console.error("❌ [TrainingCore] 基音再生初期化エラー:",u),t(6,Y=!1)}}async function _e(){if(!(Z||!Q||Y))try{ut.state!=="running"&&(await ft(),console.log("🔊 [TrainingCore] Tone.js AudioContext 開始")),t(7,Z=!0);const u=p||s,N=Lt();Q.volume.value=N,console.log(`🎹 [TrainingCore] 基音再生: ${u} (${N}dB)`),Q.triggerAttackRelease(u,"2n"),xe(),setTimeout(()=>{t(7,Z=!1)},3e3)}catch(u){console.error("❌ [TrainingCore] 基音再生エラー:",u),t(7,Z=!1)}}function Ce(){t(8,K=n.map(()=>({state:"inactive"}))),console.log(`🎵 [TrainingCore] ガイドシステム初期化: ${n.length}音階`)}function xe(){t(11,ee="guiding");let u=0;const N=setInterval(()=>{u+=2,t(9,le=u),u>=100&&(clearInterval(N),t(10,ae=!0),setTimeout(()=>{Fe()},2e3))},40)}function Fe(){console.log("🎵 [TrainingCore] ガイドシーケンス開始");let u=0;const N=setInterval(()=>{u<K.length?(t(8,K[u].state="active",K),u++,t(8,K=[...K])):(clearInterval(N),t(11,ee="listening"),ie=Date.now(),R=n.map(U=>({name:U,cents:null,targetFreq:0,detectedFreq:0,diff:0,accuracy:0})),console.log("🎤 [TrainingCore] リスニングフェーズ開始"))},500)}async function ze(){if(!ie)return;const u=Math.round((Date.now()-ie)/1e3),N=p||s,U=i;console.log(`✅ [TrainingCore] セッション完了: ${u}秒`),v?await _t(R,u,N,U)&&(console.log("✅ [TrainingCore] セッション結果保存完了"),t(16,ce=o),t(15,se=!0),T&&T(),r&&D&&D()):(t(16,ce={mode:h,sessionHistory:[{sessionId:1,grade:Se.evaluateSession(R),accuracy:Se.calculateAccuracy(R),baseNote:N,baseName:U,noteResults:R,completedAt:new Date().toISOString()}],isCompleted:!0,totalSessions:1,targetSessions:1}),t(15,se=!0),T&&T())}function Ge(u){const{frequency:N,note:U,volume:re}=u.detail;t(13,pe=N),t(14,be=U),t(12,me=re),ee==="listening"&&R.length>0&&Re(N)}function Re(u,N){const re=Bt(p||s),te=Ue();if(te>=0&&te<R.length){const fe=xt(re,te),De=Ft(u,fe);R[te]={name:n[te],cents:De,targetFreq:fe,detectedFreq:u,diff:u-fe,accuracy:zt(De)},R=[...R],R.filter(We=>We.cents!==null).length>=n.length&&ze()}}function Ue(){for(let u=0;u<K.length;u++)if(K[u].state==="active")return u;return-1}function Oe(u){console.error("❌ [TrainingCore] PitchDetectorエラー:",u.detail),$&&$(u.detail.error)}function je(){t(15,se=!1),t(11,ee="waiting"),t(9,le=0),t(10,ae=!1),Ce()}function Ke(){je(),d&&!r&&setTimeout(()=>_e(),1e3)}function Je(){de(`${he}/`)}function Qe(u){Ye[u?"unshift":"push"](()=>{J=u,t(5,J)})}return l.$$set=u=>{"mode"in u&&t(0,h=u.mode),"autoPlay"in u&&t(1,d=u.autoPlay),"sessionCount"in u&&t(2,f=u.sessionCount),"baseNote"in u&&t(27,p=u.baseNote),"direction"in u&&t(28,a=u.direction),"useLocalStorage"in u&&t(3,v=u.useLocalStorage),"onSessionComplete"in u&&t(30,T=u.onSessionComplete),"onAllComplete"in u&&t(31,D=u.onAllComplete),"onMicrophoneError"in u&&t(32,$=u.onMicrophoneError)},l.$$.update=()=>{l.$$.dirty[0]&268435457&&t(17,n=h==="chromatic"?a==="asc"?["ド","ド#","レ","レ#","ミ","ファ","ファ#","ソ","ソ#","ラ","ラ#","シ"]:["シ","ラ#","ラ","ソ#","ソ","ファ#","ファ","ミ","レ#","レ","ド#","ド"]:["ド","レ","ミ","ファ","ソ","ラ","シ","ド（高）"]),l.$$.dirty[0]&1},[h,d,f,v,V,J,Y,Z,K,le,ae,ee,me,pe,be,se,ce,n,r,c,g,_e,Ge,Oe,je,Ke,Je,p,a,w,T,D,$,y,Qe]}class Rt extends Ee{constructor(e){super(),ye(this,e,Gt,Ht,Me,{mode:0,autoPlay:1,sessionCount:2,baseNote:27,direction:28,useLocalStorage:3,sessionKey:29,onSessionComplete:30,onAllComplete:31,onMicrophoneError:32,onStorageError:33},null,[-1,-1])}get sessionKey(){return this.$$.ctx[29]}get onStorageError(){return this.$$.ctx[33]}}function Ut(l){let e,t='<div class="loading-spinner svelte-14jb1jb">⚡</div> <p>読み込み中...</p>';return{c(){e=C("div"),e.innerHTML=t,this.h()},l(n){e=_(n,"DIV",{class:!0,"data-svelte-h":!0}),q(e)!=="svelte-1awb2cx"&&(e.innerHTML=t),this.h()},h(){j(e,"class","loading-placeholder svelte-14jb1jb")},m(n,r){S(n,e,r)},p:O,i:O,o:O,d(n){n&&m(e)}}}function Ot(l){let e,t;return e=new Rt({props:{mode:"continuous",autoPlay:!0,sessionCount:8,useLocalStorage:!0,sessionKey:"continuous-training-progress",onMicrophoneError:l[3],onStorageError:Xt,onSessionComplete:Yt,onAllComplete:Zt}}),{c(){B(e.$$.fragment)},l(n){L(e.$$.fragment,n)},m(n,r){H(e,n,r),t=!0},p:O,i(n){t||(M(e.$$.fragment,n),t=!0)},o(n){P(e.$$.fragment,n),t=!1},d(n){A(e,n)}}}function Kt(l){let e,t,n,r='<div class="challenge-icon svelte-14jb1jb">⚡</div>',s,o,i,c="連続チャレンジモード",g,h,d=`<div class="feature-item svelte-14jb1jb"><div class="feature-icon svelte-14jb1jb">🎯</div> <div class="feature-text svelte-14jb1jb"><strong class="svelte-14jb1jb">8セッション連続</strong><br/>
                  途中で止まらない集中トレーニング</div></div> <div class="feature-item svelte-14jb1jb"><div class="feature-icon svelte-14jb1jb">🔥</div> <div class="feature-text svelte-14jb1jb"><strong class="svelte-14jb1jb">中級向け難易度</strong><br/>
                  より難しい基音での挑戦</div></div> <div class="feature-item svelte-14jb1jb"><div class="feature-icon svelte-14jb1jb">🚀</div> <div class="feature-text svelte-14jb1jb"><strong class="svelte-14jb1jb">自動進行</strong><br/>
                  セッション完了後に自動で次へ</div></div>`,f,p,a='<h3 class="svelte-14jb1jb">🎼 使用基音（中級レベル）</h3> <div class="base-notes-grid svelte-14jb1jb"><span class="base-note svelte-14jb1jb">Bb3</span> <span class="base-note svelte-14jb1jb">B3</span> <span class="base-note svelte-14jb1jb">Db4</span> <span class="base-note svelte-14jb1jb">Eb4</span> <span class="base-note svelte-14jb1jb">F#4</span> <span class="base-note svelte-14jb1jb">G#4</span> <span class="base-note svelte-14jb1jb">Bb4</span> <span class="base-note svelte-14jb1jb">C#5</span> <span class="base-note svelte-14jb1jb">Eb5</span> <span class="base-note svelte-14jb1jb">F#5</span></div>',v,w,T="🔥 チャレンジ開始！",D,$;return{c(){e=C("div"),t=C("div"),n=C("div"),n.innerHTML=r,s=E(),o=C("div"),i=C("h2"),i.textContent=c,g=E(),h=C("div"),h.innerHTML=d,f=E(),p=C("div"),p.innerHTML=a,v=E(),w=C("button"),w.textContent=T,this.h()},l(y){e=_(y,"DIV",{class:!0});var V=I(e);t=_(V,"DIV",{class:!0});var G=I(t);n=_(G,"DIV",{class:!0,"data-svelte-h":!0}),q(n)!=="svelte-13ksuac"&&(n.innerHTML=r),s=k(G),o=_(G,"DIV",{class:!0});var z=I(o);i=_(z,"H2",{class:!0,"data-svelte-h":!0}),q(i)!=="svelte-1je1qsu"&&(i.textContent=c),g=k(z),h=_(z,"DIV",{class:!0,"data-svelte-h":!0}),q(h)!=="svelte-1ew1nx5"&&(h.innerHTML=d),f=k(z),p=_(z,"DIV",{class:!0,"data-svelte-h":!0}),q(p)!=="svelte-9z8rw7"&&(p.innerHTML=a),v=k(z),w=_(z,"BUTTON",{class:!0,"data-svelte-h":!0}),q(w)!=="svelte-la0s3j"&&(w.textContent=T),z.forEach(m),G.forEach(m),V.forEach(m),this.h()},h(){j(n,"class","challenge-icon-wrapper svelte-14jb1jb"),j(i,"class","challenge-title svelte-14jb1jb"),j(h,"class","challenge-features svelte-14jb1jb"),j(p,"class","difficulty-info svelte-14jb1jb"),j(w,"class","start-challenge-button svelte-14jb1jb"),j(o,"class","challenge-content"),j(t,"class","challenge-card svelte-14jb1jb"),j(e,"class","start-screen svelte-14jb1jb")},m(y,V){S(y,e,V),b(e,t),b(t,n),b(t,s),b(t,o),b(o,i),b(o,g),b(o,h),b(o,f),b(o,p),b(o,v),b(o,w),D||($=qe(w,"click",l[4]),D=!0)},p:O,i:O,o:O,d(y){y&&m(e),D=!1,$()}}}function Jt(l){let e,t,n,r="⚠️",s,o,i,c="マイクテストが必要です",g,h,d="連続チャレンジを開始する前に、マイクの動作確認を行ってください。",f,p,a="マイクテストを開始",v,w;return{c(){e=C("div"),t=C("div"),n=C("div"),n.textContent=r,s=E(),o=C("div"),i=C("h3"),i.textContent=c,g=E(),h=C("p"),h.textContent=d,f=E(),p=C("button"),p.textContent=a,this.h()},l(T){e=_(T,"DIV",{class:!0});var D=I(e);t=_(D,"DIV",{class:!0});var $=I(t);n=_($,"DIV",{class:!0,"data-svelte-h":!0}),q(n)!=="svelte-dwi5dc"&&(n.textContent=r),s=k($),o=_($,"DIV",{class:!0});var y=I(o);i=_(y,"H3",{class:!0,"data-svelte-h":!0}),q(i)!=="svelte-17kvze2"&&(i.textContent=c),g=k(y),h=_(y,"P",{class:!0,"data-svelte-h":!0}),q(h)!=="svelte-t9m3nr"&&(h.textContent=d),f=k(y),p=_(y,"BUTTON",{class:!0,"data-svelte-h":!0}),q(p)!=="svelte-18xr2xp"&&(p.textContent=a),y.forEach(m),$.forEach(m),D.forEach(m),this.h()},h(){j(n,"class","warning-icon svelte-14jb1jb"),j(i,"class","svelte-14jb1jb"),j(h,"class","svelte-14jb1jb"),j(p,"class","mic-test-button svelte-14jb1jb"),j(o,"class","warning-content svelte-14jb1jb"),j(t,"class","warning-card svelte-14jb1jb"),j(e,"class","mic-test-required svelte-14jb1jb")},m(T,D){S(T,e,D),b(e,t),b(t,n),b(t,s),b(t,o),b(o,i),b(o,g),b(o,h),b(o,f),b(o,p),v||(w=qe(p,"click",l[5]),v=!0)},p:O,i:O,o:O,d(T){T&&m(e),v=!1,w()}}}function Qt(l){let e,t,n='<h1 class="page-title svelte-14jb1jb">⚡ 連続チャレンジモード</h1> <p class="page-description svelte-14jb1jb">中級者向け：より難しい基音で8セッション連続挑戦</p>',r,s,o,i;const c=[Jt,Kt,Ot,Ut],g=[];function h(d,f){return d[2]&&!d[0]?0:d[2]&&d[0]&&d[1]?1:d[2]&&d[0]&&!d[1]?2:d[2]?-1:3}return~(s=h(l))&&(o=g[s]=c[s](l)),{c(){e=C("div"),t=C("div"),t.innerHTML=n,r=E(),o&&o.c(),this.h()},l(d){e=_(d,"DIV",{class:!0});var f=I(e);t=_(f,"DIV",{class:!0,"data-svelte-h":!0}),q(t)!=="svelte-1la1yd9"&&(t.innerHTML=n),r=k(f),o&&o.l(f),f.forEach(m),this.h()},h(){j(t,"class","page-header svelte-14jb1jb"),j(e,"class","continuous-training-page svelte-14jb1jb")},m(d,f){S(d,e,f),b(e,t),b(e,r),~s&&g[s].m(e,null),i=!0},p(d,f){let p=s;s=h(d),s===p?~s&&g[s].p(d,f):(o&&(ge(),P(g[p],1,1,()=>{g[p]=null}),ve()),~s?(o=g[s],o?o.p(d,f):(o=g[s]=c[s](d),o.c()),M(o,1),o.m(e,null)):o=null)},i(d){i||(M(o),i=!0)},o(d){P(o),i=!1},d(d){d&&m(e),~s&&g[s].d()}}}function Wt(l){let e,t,n;return t=new tt({props:{showBackButton:!0,$$slots:{default:[Qt]},$$scope:{ctx:l}}}),{c(){e=E(),B(t.$$.fragment),this.h()},l(r){et("svelte-13kpo59",document.head).forEach(m),e=k(r),L(t.$$.fragment,r),this.h()},h(){document.title="連続チャレンジモード - 相対音感トレーニング"},m(r,s){S(r,e,s),H(t,r,s),n=!0},p(r,[s]){const o={};s&71&&(o.$$scope={dirty:s,ctx:r}),t.$set(o)},i(r){n||(M(t.$$.fragment,r),n=!0)},o(r){P(t.$$.fragment,r),n=!1},d(r){r&&m(e),A(t,r)}}}function Xt(l){console.error("🚨 [ContinuousTraining] ストレージエラー:",l)}function Yt(){console.log("✅ [ContinuousTraining] セッション完了")}function Zt(){console.log("🎉 [ContinuousTraining] 8セッション完了！")}function en(l,e,t){let n=!1,r=!0,s=!1;Pe(()=>{t(2,s=!0),typeof localStorage<"u"&&(t(0,n=localStorage.getItem("mic-test-completed")==="true"),console.log("🎤 [ContinuousTraining] マイクテスト完了フラグ:",n))});function o(g){console.error("🚨 [ContinuousTraining] マイクロフォンエラー:",g),de(`${he}/microphone-test?mode=continuous`)}function i(){t(1,r=!1)}return[n,r,s,o,i,()=>de(`${he}/microphone-test?mode=continuous`)]}class dn extends Ee{constructor(e){super(),ye(this,e,en,Wt,Me,{})}}export{dn as component,fn as universal};
