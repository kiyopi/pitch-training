import{S as Oe,i as Ue,d as T,s as Ze,v as Ye,c as Ke,a as Qe,D as de,E as je,b as h,q as oe,r as X,u as Z,f as W,w as ie,F as Xe,m as x,x as se,p as L,y as le,g as f,z as m,h as _,j as p,k as E,B as ae,A as $,o as b,C as ce,G as qe,H as Ie,l as K,t as Q,e as he,I as we,J as ue}from"../chunks/DPxCR1R2.js";import{g as $e}from"../chunks/D0QH3NT1.js";import"../chunks/Bh1sI7gf.js";import{p as me}from"../chunks/CycEblyf.js";import{P as Ae,B as ke,C as ve}from"../chunks/CeufOIGR.js";import{P as et,V as Me}from"../chunks/wW0fNtx-.js";const{console:tt}=$e,g="src/routes/microphone-test/+page.svelte";function _e(s){let e,t,i,l="音量レベル",n,o,c,d,v,a,u,y="音程検出",M,k,B,R=s[4].toFixed(1)+"",F,j,w,D,q,S,N,z,G,P,I;o=new Me({props:{volume:s[3],height:"16px",className:"volume-bar-wrapper"},$$inline:!0});let A=!s[1]&&ge(s),r=s[6]>0&&ye(s);function U(Y,C){return Y[2]?Y[6]<50?Re:Fe:Ne}let O=U(s),H=O(s),V=s[1]&&!s[2]&&pe(s);const re={c:function(){e=b("div"),t=b("div"),i=b("h3"),i.textContent=l,n=L(),le(o.$$.fragment),c=L(),d=b("div"),A&&A.c(),v=L(),a=b("div"),u=b("h3"),u.textContent=y,M=L(),k=b("div"),B=b("div"),F=Q(R),j=Q(" Hz"),w=L(),D=b("div"),q=Q(s[5]),S=L(),r&&r.c(),N=L(),z=b("div"),H.c(),G=L(),V&&V.c(),P=we(),this.h()},l:function(C){e=p(C,"DIV",{class:!0});var J=E(e);t=p(J,"DIV",{class:!0});var ee=E(t);i=p(ee,"H3",{class:!0,"data-svelte-h":!0}),$(i)!=="svelte-1nc8gri"&&(i.textContent=l),n=x(ee),se(o.$$.fragment,ee),c=x(ee),d=p(ee,"DIV",{class:!0});var Ce=E(d);A&&A.l(Ce),Ce.forEach(h),ee.forEach(h),v=x(J),a=p(J,"DIV",{class:!0});var te=E(a);u=p(te,"H3",{class:!0,"data-svelte-h":!0}),$(u)!=="svelte-1ofzoy2"&&(u.textContent=y),M=x(te),k=p(te,"DIV",{class:!0});var ne=E(k);B=p(ne,"DIV",{class:!0});var fe=E(B);F=K(fe,R),j=K(fe," Hz"),fe.forEach(h),w=x(ne),D=p(ne,"DIV",{class:!0});var De=E(D);q=K(De,s[5]),De.forEach(h),S=x(ne),r&&r.l(ne),ne.forEach(h),N=x(te),z=p(te,"DIV",{class:!0});var Ee=E(z);H.l(Ee),Ee.forEach(h),te.forEach(h),J.forEach(h),G=x(C),V&&V.l(C),P=we(),this.h()},h:function(){m(i,"class","display-title svelte-j70b5i"),_(i,g,372,16,10535),m(d,"class","volume-status svelte-j70b5i"),_(d,g,374,16,10686),m(t,"class","volume-section svelte-j70b5i"),_(t,g,371,14,10490),m(u,"class","display-title svelte-j70b5i"),_(u,g,383,16,10992),m(B,"class","frequency-value svelte-j70b5i"),_(B,g,385,18,11094),m(D,"class","note-value svelte-j70b5i"),_(D,g,386,18,11180),m(k,"class","frequency-display svelte-j70b5i"),_(k,g,384,16,11044),m(z,"class","frequency-status svelte-j70b5i"),_(z,g,399,16,11831),m(a,"class","frequency-section"),_(a,g,382,14,10944),m(e,"class","realtime-display svelte-j70b5i"),_(e,g,369,12,10416)},m:function(C,J){W(C,e,J),f(e,t),f(t,i),f(t,n),ie(o,t,null),f(t,c),f(t,d),A&&A.m(d,null),f(e,v),f(e,a),f(a,u),f(a,M),f(a,k),f(k,B),f(B,F),f(B,j),f(k,w),f(k,D),f(D,q),f(k,S),r&&r.m(k,null),f(a,N),f(a,z),H.m(z,null),W(C,G,J),V&&V.m(C,J),W(C,P,J),I=!0},p:function(C,J){const ee={};J&8&&(ee.volume=C[3]),o.$set(ee),C[1]?A&&(A.d(1),A=null):A||(A=ge(C),A.c(),A.m(d,null)),(!I||J&16)&&R!==(R=C[4].toFixed(1)+"")&&he(F,R),(!I||J&32)&&he(q,C[5]),C[6]>0?r?r.p(C,J):(r=ye(C),r.c(),r.m(k,null)):r&&(r.d(1),r=null),O!==(O=U(C))&&(H.d(1),H=O(C),H&&(H.c(),H.m(z,null))),C[1]&&!C[2]?V||(V=pe(C),V.c(),V.m(P.parentNode,P)):V&&(V.d(1),V=null)},i:function(C){I||(Z(o.$$.fragment,C),I=!0)},o:function(C){X(o.$$.fragment,C),I=!1},d:function(C){C&&(h(e),h(G),h(P)),oe(o),A&&A.d(),r&&r.d(),H.d(),V&&V.d(C)}};return T("SvelteRegisterBlock",{block:re,id:_e.name,type:"if",source:"(369:10) {#if micPermission === 'granted'}",ctx:s}),re}function ge(s){let e,t="⏳ 声を出して音量を確認してください";const i={c:function(){e=b("span"),e.textContent=t,this.h()},l:function(n){e=p(n,"SPAN",{class:!0,"data-svelte-h":!0}),$(e)!=="svelte-7eexnn"&&(e.textContent=t),this.h()},h:function(){m(e,"class","status-pending svelte-j70b5i"),_(e,g,376,20,10774)},m:function(n,o){W(n,e,o)},d:function(n){n&&h(e)}};return T("SvelteRegisterBlock",{block:i,id:ge.name,type:"if",source:"(376:18) {#if !volumeDetected}",ctx:s}),i}function ye(s){let e,t,i,l,n,o;const c={c:function(){e=b("div"),t=Q("信頼度: "),i=Q(s[6]),l=Q(`%
                      `),n=b("div"),o=b("div"),this.h()},l:function(v){e=p(v,"DIV",{class:!0});var a=E(e);t=K(a,"信頼度: "),i=K(a,s[6]),l=K(a,`%
                      `),n=p(a,"DIV",{class:!0});var u=E(n);o=p(u,"DIV",{class:!0,style:!0}),E(o).forEach(h),u.forEach(h),a.forEach(h),this.h()},h:function(){m(o,"class","confidence-fill svelte-j70b5i"),ue(o,"width",s[6]+"%"),ue(o,"background-color",s[6]>70?"#10b981":s[6]>40?"#f59e0b":"#ef4444"),_(o,g,391,24,11450),m(n,"class","confidence-bar svelte-j70b5i"),_(n,g,390,22,11397),m(e,"class","confidence-display svelte-j70b5i"),_(e,g,388,20,11292)},m:function(v,a){W(v,e,a),f(e,t),f(e,i),f(e,l),f(e,n),f(n,o)},p:function(v,a){a&64&&he(i,v[6]),a&64&&ue(o,"width",v[6]+"%"),a&64&&ue(o,"background-color",v[6]>70?"#10b981":v[6]>40?"#f59e0b":"#ef4444")},d:function(v){v&&h(e)}};return T("SvelteRegisterBlock",{block:c,id:ye.name,type:"if",source:"(388:18) {#if detectionConfidence > 0}",ctx:s}),c}function Fe(s){let e,t="✅ 音程検出中";const i={c:function(){e=b("span"),e.textContent=t,this.h()},l:function(n){e=p(n,"SPAN",{class:!0,"data-svelte-h":!0}),$(e)!=="svelte-acahk5"&&(e.textContent=t),this.h()},h:function(){m(e,"class","status-success svelte-j70b5i"),_(e,g,405,20,12156)},m:function(n,o){W(n,e,o)},d:function(n){n&&h(e)}};return T("SvelteRegisterBlock",{block:i,id:Fe.name,type:"else",source:"(405:18) {:else}",ctx:s}),i}function Re(s){let e,t="⚠️ より明確に発声してください";const i={c:function(){e=b("span"),e.textContent=t,this.h()},l:function(n){e=p(n,"SPAN",{class:!0,"data-svelte-h":!0}),$(e)!=="svelte-lq2kpp"&&(e.textContent=t),this.h()},h:function(){m(e,"class","status-warning svelte-j70b5i"),_(e,g,403,20,12057)},m:function(n,o){W(n,e,o)},d:function(n){n&&h(e)}};return T("SvelteRegisterBlock",{block:i,id:Re.name,type:"if",source:"(403:53) ",ctx:s}),i}function Ne(s){let e,t="⏳ 「ド」を発声して音程を確認してください";const i={c:function(){e=b("span"),e.textContent=t,this.h()},l:function(n){e=p(n,"SPAN",{class:!0,"data-svelte-h":!0}),$(e)!=="svelte-lvftl7"&&(e.textContent=t),this.h()},h:function(){m(e,"class","status-pending svelte-j70b5i"),_(e,g,401,20,11925)},m:function(n,o){W(n,e,o)},d:function(n){n&&h(e)}};return T("SvelteRegisterBlock",{block:i,id:Ne.name,type:"if",source:"(401:18) {#if !frequencyDetected}",ctx:s}),i}function pe(s){let e,t,i,l="「ド」を発声してください",n,o,c="任意の高さで「ドー」と歌うように発声してください";const d={c:function(){e=b("div"),t=b("div"),i=b("h3"),i.textContent=l,n=L(),o=b("p"),o.textContent=c,this.h()},l:function(a){e=p(a,"DIV",{class:!0});var u=E(e);t=p(u,"DIV",{class:!0});var y=E(t);i=p(y,"H3",{class:!0,"data-svelte-h":!0}),$(i)!=="svelte-xe90gt"&&(i.textContent=l),n=x(y),o=p(y,"P",{class:!0,"data-svelte-h":!0}),$(o)!=="svelte-1rtajtc"&&(o.textContent=c),y.forEach(h),u.forEach(h),this.h()},h:function(){m(i,"class","svelte-j70b5i"),_(i,g,415,18,12472),m(o,"class","svelte-j70b5i"),_(o,g,416,18,12512),m(t,"class","guidance-content svelte-j70b5i"),_(t,g,414,16,12423),m(e,"class","guidance svelte-j70b5i"),_(e,g,413,14,12384)},m:function(a,u){W(a,e,u),f(e,t),f(t,i),f(t,n),f(t,o)},d:function(a){a&&h(e)}};return T("SvelteRegisterBlock",{block:d,id:pe.name,type:"if",source:"(413:12) {#if volumeDetected && !frequencyDetected}",ctx:s}),d}function ze(s){let e,t,i=s[0]==="granted"&&_e(s);const l={c:function(){e=b("div"),i&&i.c(),this.h()},l:function(o){e=p(o,"DIV",{class:!0});var c=E(e);i&&i.l(c),c.forEach(h),this.h()},h:function(){m(e,"class","mic-test-content svelte-j70b5i"),_(e,g,365,8,10300)},m:function(o,c){W(o,e,c),i&&i.m(e,null),t=!0},p:function(o,c){o[0]==="granted"?i?(i.p(o,c),c&1&&Z(i,1)):(i=_e(o),i.c(),Z(i,1),i.m(e,null)):i&&(qe(),X(i,1,1,()=>{i=null}),Ie())},i:function(o){t||(Z(i),t=!0)},o:function(o){X(i),t=!1},d:function(o){o&&h(e),i&&i.d()}};return T("SvelteRegisterBlock",{block:l,id:ze.name,type:"slot",source:'(365:6) <Card variant=\\"default\\" padding=\\"lg\\">',ctx:s}),l}function He(s){let e,t;e=new ke({props:{variant:"disabled",size:"lg",fullWidth:!0,disabled:!0,$$slots:{default:[Le]},$$scope:{ctx:s}},$$inline:!0});const i={c:function(){le(e.$$.fragment)},l:function(n){se(e.$$.fragment,n)},m:function(n,o){ie(e,n,o),t=!0},p:function(n,o){const c={};o&8388608&&(c.$$scope={dirty:o,ctx:n}),e.$set(c)},i:function(n){t||(Z(e.$$.fragment,n),t=!0)},o:function(n){X(e.$$.fragment,n),t=!1},d:function(n){oe(e,n)}};return T("SvelteRegisterBlock",{block:i,id:He.name,type:"else",source:"(444:10) {:else}",ctx:s}),i}function xe(s){let e,t;e=new ke({props:{href:s[8].path,variant:"primary",size:"lg",fullWidth:!0,$$slots:{default:[Te]},$$scope:{ctx:s}},$$inline:!0});const i={c:function(){le(e.$$.fragment)},l:function(n){se(e.$$.fragment,n)},m:function(n,o){ie(e,n,o),t=!0},p:function(n,o){const c={};o&8388608&&(c.$$scope={dirty:o,ctx:n}),e.$set(c)},i:function(n){t||(Z(e.$$.fragment,n),t=!0)},o:function(n){X(e.$$.fragment,n),t=!1},d:function(n){oe(e,n)}};return T("SvelteRegisterBlock",{block:i,id:xe.name,type:"if",source:"(435:10) {#if startButtonEnabled}",ctx:s}),i}function Le(s){let e;const t={c:function(){e=Q("マイクテスト完了後に開始")},l:function(l){e=K(l,"マイクテスト完了後に開始")},m:function(l,n){W(l,e,n)},d:function(l){l&&h(e)}};return T("SvelteRegisterBlock",{block:t,id:Le.name,type:"slot",source:'(445:12) <Button                variant=\\"disabled\\"                size=\\"lg\\"                fullWidth                disabled             >',ctx:s}),t}function Te(s){let e;const t={c:function(){e=Q("トレーニング開始")},l:function(l){e=K(l,"トレーニング開始")},m:function(l,n){W(l,e,n)},d:function(l){l&&h(e)}};return T("SvelteRegisterBlock",{block:t,id:Te.name,type:"slot",source:'(436:12) <Button                href={selectedMode.path}                variant=\\"primary\\"                size=\\"lg\\"                fullWidth             >',ctx:s}),t}function Ge(s){let e,t,i=s[8].name+"",l,n,o,c=s[8].description+"",d,v,a,u,y;const M=[xe,He],k=[];function B(F,j){return F[7]?0:1}a=B(s),u=k[a]=M[a](s);const R={c:function(){e=b("div"),t=b("h3"),l=Q(i),n=L(),o=b("p"),d=Q(c),v=L(),u.c(),this.h()},l:function(j){e=p(j,"DIV",{class:!0});var w=E(e);t=p(w,"H3",{class:!0});var D=E(t);l=K(D,i),D.forEach(h),n=x(w),o=p(w,"P",{class:!0});var q=E(o);d=K(q,c),q.forEach(h),v=x(w),u.l(w),w.forEach(h),this.h()},h:function(){m(t,"class","start-title svelte-j70b5i"),_(t,g,429,10,12806),m(o,"class","start-description svelte-j70b5i"),_(o,g,430,10,12865),m(e,"class","start-content svelte-j70b5i"),_(e,g,428,8,12768)},m:function(j,w){W(j,e,w),f(e,t),f(t,l),f(e,n),f(e,o),f(o,d),f(e,v),k[a].m(e,null),y=!0},p:function(j,w){let D=a;a=B(j),a===D?k[a].p(j,w):(qe(),X(k[D],1,1,()=>{k[D]=null}),Ie(),u=k[a],u?u.p(j,w):(u=k[a]=M[a](j),u.c()),Z(u,1),u.m(e,null))},i:function(j){y||(Z(u),y=!0)},o:function(j){X(u),y=!1},d:function(j){j&&h(e),k[a].d()}};return T("SvelteRegisterBlock",{block:R,id:Ge.name,type:"slot",source:'(428:6) <Card variant=\\"default\\" padding=\\"lg\\">',ctx:s}),R}function We(s){let e,t,i,l,n,o,c,d,v,a,u,y,M="マイクテスト",k,B,R="音感トレーニングを始める前に、マイクの動作を確認します",F,j,w,D,q,S,N;w=new ve({props:{variant:"default",padding:"lg",$$slots:{default:[ze]},$$scope:{ctx:s}},$$inline:!0}),S=new ve({props:{variant:"default",padding:"lg",$$slots:{default:[Ge]},$$scope:{ctx:s}},$$inline:!0});const z={c:function(){e=b("div"),t=b("div"),i=b("div"),l=b("div"),n=ce("svg"),o=ce("path"),c=ce("path"),d=ce("line"),v=ce("line"),a=L(),u=b("div"),y=b("h1"),y.textContent=M,k=L(),B=b("p"),B.textContent=R,F=L(),j=b("div"),le(w.$$.fragment),D=L(),q=b("div"),le(S.$$.fragment),this.h()},l:function(P){e=p(P,"DIV",{class:!0});var I=E(e);t=p(I,"DIV",{class:!0});var A=E(t);i=p(A,"DIV",{class:!0});var r=E(i);l=p(r,"DIV",{class:!0});var U=E(l);n=ae(U,"svg",{width:!0,height:!0,viewBox:!0,fill:!0,stroke:!0,"stroke-width":!0});var O=E(n);o=ae(O,"path",{d:!0}),E(o).forEach(h),c=ae(O,"path",{d:!0}),E(c).forEach(h),d=ae(O,"line",{x1:!0,x2:!0,y1:!0,y2:!0}),E(d).forEach(h),v=ae(O,"line",{x1:!0,x2:!0,y1:!0,y2:!0}),E(v).forEach(h),O.forEach(h),U.forEach(h),a=x(r),u=p(r,"DIV",{});var H=E(u);y=p(H,"H1",{class:!0,"data-svelte-h":!0}),$(y)!=="svelte-z7m4lk"&&(y.textContent=M),k=x(H),B=p(H,"P",{class:!0,"data-svelte-h":!0}),$(B)!=="svelte-1vtv92f"&&(B.textContent=R),H.forEach(h),r.forEach(h),A.forEach(h),F=x(I),j=p(I,"DIV",{class:!0});var V=E(j);se(w.$$.fragment,V),V.forEach(h),D=x(I),q=p(I,"DIV",{class:!0});var re=E(q);se(S.$$.fragment,re),re.forEach(h),I.forEach(h),this.h()},h:function(){m(o,"d","M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"),_(o,g,349,12,9764),m(c,"d","M19 10v2a7 7 0 0 1-14 0v-2"),_(c,g,350,12,9841),m(d,"x1","12"),m(d,"x2","12"),m(d,"y1","19"),m(d,"y2","22"),_(d,g,351,12,9892),m(v,"x1","8"),m(v,"x2","16"),m(v,"y1","22"),m(v,"y2","22"),_(v,g,352,12,9944),m(n,"width","48"),m(n,"height","48"),m(n,"viewBox","0 0 24 24"),m(n,"fill","none"),m(n,"stroke","currentColor"),m(n,"stroke-width","2"),_(n,g,348,10,9652),m(l,"class","mic-icon svelte-j70b5i"),_(l,g,347,8,9619),m(y,"class","mic-test-title svelte-j70b5i"),_(y,g,356,10,10039),m(B,"class","mic-test-description svelte-j70b5i"),_(B,g,357,10,10088),_(u,g,355,8,10023),m(i,"class","mic-test-header svelte-j70b5i"),_(i,g,346,6,9581),m(t,"class","header svelte-j70b5i"),_(t,g,345,4,9554),m(j,"class","test-section"),_(j,g,363,4,10221),m(q,"class","start-section"),_(q,g,426,4,12688),m(e,"class","microphone-test svelte-j70b5i"),_(e,g,343,2,9502)},m:function(P,I){W(P,e,I),f(e,t),f(t,i),f(i,l),f(l,n),f(n,o),f(n,c),f(n,d),f(n,v),f(i,a),f(i,u),f(u,y),f(u,k),f(u,B),f(e,F),f(e,j),ie(w,j,null),f(e,D),f(e,q),ie(S,q,null),N=!0},p:function(P,I){const A={};I&8388735&&(A.$$scope={dirty:I,ctx:P}),w.$set(A);const r={};I&8388736&&(r.$$scope={dirty:I,ctx:P}),S.$set(r)},i:function(P){N||(Z(w.$$.fragment,P),Z(S.$$.fragment,P),N=!0)},o:function(P){X(w.$$.fragment,P),X(S.$$.fragment,P),N=!1},d:function(P){P&&h(e),oe(w),oe(S)}};return T("SvelteRegisterBlock",{block:z,id:We.name,type:"slot",source:"(343:0) <PageLayout showBackButton={true}>",ctx:s}),z}function be(s){let e,t,i;t=new Ae({props:{showBackButton:!0,$$slots:{default:[We]},$$scope:{ctx:s}},$$inline:!0});const l={c:function(){e=L(),le(t.$$.fragment),this.h()},l:function(o){Xe("svelte-8st1fo",document.head).forEach(h),e=x(o),se(t.$$.fragment,o),this.h()},h:function(){document.title="マイクテスト - 相対音感トレーニング"},m:function(o,c){W(o,e,c),ie(t,o,c),i=!0},p:function(o,[c]){const d={};c&8388863&&(d.$$scope={dirty:c,ctx:o}),t.$set(d)},i:function(o){i||(Z(t.$$.fragment,o),i=!0)},o:function(o){X(t.$$.fragment,o),i=!1},d:function(o){o&&h(e),oe(t,o)}};return T("SvelteRegisterBlock",{block:l,id:be.name,type:"component",source:"",ctx:s}),l}const Be=5;function Se(s){if(s<=0)return"C4（ド4）";const t=Math.round(12*Math.log2(s/440)),i=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],l=((t+9)%12+12)%12,n=Math.floor((t+9)/12)+4,o=i[l];return`${o}${n}（${{C:"ド","C#":"ド#",D:"レ","D#":"レ#",E:"ミ",F:"ファ","F#":"ファ#",G:"ソ","G#":"ソ#",A:"ラ","A#":"ラ#",B:"シ"}[o]}${n}）`}function Pe(s,e){let t=0;for(let a=0;a<s.length;a++)t+=s[a]*s[a];if(t=Math.sqrt(t/s.length),t<.01)return 0;const i=Je(s,e,70),l=Math.floor(e/800),n=Math.floor(e/70);let o=0,c=0,d=0;for(let a=l;a<=n;a++){let u=0,y=0;for(let M=0;M<i.length-a;M++)u+=i[M]*i[M+a],y+=i[M]*i[M];y>0&&(u=u/Math.sqrt(y),u>o?(d=o,o=u,c=a):u>d&&(d=u))}const v=o-d;if(o>.3&&v>.05&&c>0){const a=Math.min(1,o*v*2);return{frequency:e/c,confidence:a}}return{frequency:0,confidence:0}}function Je(s,e,t){const i=1/e,l=1/(t*2*Math.PI),n=l/(l+i),o=new Float32Array(s.length);o[0]=s[0];for(let c=1;c<s.length;c++)o[c]=n*(o[c-1]+s[c]-s[c-1]);return o}function Ve(s){if(s.length===0)return 0;if(s.length===1)return s[0];const e=[...s].sort((o,c)=>o-c),t=e[Math.floor(e.length/2)],i=s.filter(o=>Math.abs(o-t)/t<.1);if(i.length===0)return t;let l=0,n=0;for(let o=0;o<i.length;o++){const c=o+1;l+=i[o]*c,n+=c}return l/n}function nt(s,e,t){let i,l;Ye(me,"page"),Ke(s,me,r=>t(17,l=r));let{$$slots:n={},$$scope:o}=e;Qe("Page",n,[]);let c="random";de(()=>{l.url.searchParams.has("mode")&&(c=l.url.searchParams.get("mode")||"random")});let d="pending",v=!1,a=!1,u=0,y=0,M="",k=!1,B=0,R=[];const F={random:{name:"ランダム基音モード",description:"10種類の基音からランダムに選択してトレーニング",color:"green",path:"./training/random"},continuous:{name:"連続チャレンジモード",description:"選択した回数だけ連続で実行し、総合評価を確認",color:"orange",path:"./training/continuous"},chromatic:{name:"12音階モード",description:"クロマチックスケールの上行・下行で完全制覇",color:"purple",path:"./training/chromatic"}},j=F[c]||F.random;async function w(){t(0,d="pending");try{const r=await navigator.mediaDevices.getUserMedia({audio:!0});t(0,d="granted"),r.getTracks().forEach(U=>U.stop()),setTimeout(()=>{G()},500)}catch(r){console.error("マイク許可エラー:",r),t(0,d="denied")}}let D=null,q=null,S=null,N=null,z=null;async function G(){if(d==="granted")try{D=new(window.AudioContext||window.webkitAudioContext),q=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}}),S=D.createAnalyser(),S.fftSize=2048,S.smoothingTimeConstant=.8,D.createMediaStreamSource(q).connect(S);const U=S.frequencyBinCount;N=new Uint8Array(U),k=!0,P()}catch(r){console.error("マイクアクセスエラー:",r),t(0,d="denied")}}function P(){if(!k||!S)return;S.getByteFrequencyData(N);let r=0;for(let V=0;V<N.length;V++)r+=N[V]*N[V];const U=Math.sqrt(r/N.length);t(3,u=Math.min(100,U/128*100)),u>20&&t(1,v=!0);const O=new Float32Array(S.fftSize);S.getFloatTimeDomainData(O);const H=Pe(O,D.sampleRate);if(H.frequency>0){R.push(H.frequency),R.length>Be&&R.shift();const V=Ve(R);t(4,y=V),t(5,M=Se(y)),t(6,B=Math.round(H.confidence*100)),y>80&&y<800&&t(2,a=!0)}else R=[],t(4,y=0),t(5,M=""),t(6,B=0);z=requestAnimationFrame(P)}function I(){k=!1,z&&(cancelAnimationFrame(z),z=null),q&&(q.getTracks().forEach(r=>r.stop()),q=null),D&&D.state!=="closed"&&(D.close(),D=null),S=null,N=null}je(()=>{I()}),de(()=>{setTimeout(()=>{w()},500)});const A=[];return Object.keys(e).forEach(r=>{!~A.indexOf(r)&&r.slice(0,2)!=="$$"&&r!=="slot"&&tt.warn(`<Page> was created with unknown prop '${r}'`)}),s.$capture_state=()=>({onMount:de,onDestroy:je,page:me,Card:ve,Button:ke,PageLayout:Ae,VolumeBar:Me,PitchDisplay:et,mode:c,micPermission:d,volumeDetected:v,frequencyDetected:a,currentVolume:u,currentFrequency:y,currentNote:M,isListening:k,detectionConfidence:B,frequencyHistory:R,HISTORY_SIZE:Be,trainingModes:F,selectedMode:j,frequencyToNote:Se,requestMicrophone:w,audioContext:D,mediaStream:q,analyser:S,dataArray:N,animationFrame:z,startListening:G,analyzeAudio:P,detectPitchWithAutocorrelation:Pe,applyHighPassFilter:Je,smoothFrequency:Ve,stopListening:I,startButtonEnabled:i,$page:l}),s.$inject_state=r=>{"mode"in r&&(c=r.mode),"micPermission"in r&&t(0,d=r.micPermission),"volumeDetected"in r&&t(1,v=r.volumeDetected),"frequencyDetected"in r&&t(2,a=r.frequencyDetected),"currentVolume"in r&&t(3,u=r.currentVolume),"currentFrequency"in r&&t(4,y=r.currentFrequency),"currentNote"in r&&t(5,M=r.currentNote),"isListening"in r&&(k=r.isListening),"detectionConfidence"in r&&t(6,B=r.detectionConfidence),"frequencyHistory"in r&&(R=r.frequencyHistory),"audioContext"in r&&(D=r.audioContext),"mediaStream"in r&&(q=r.mediaStream),"analyser"in r&&(S=r.analyser),"dataArray"in r&&(N=r.dataArray),"animationFrame"in r&&(z=r.animationFrame),"startButtonEnabled"in r&&t(7,i=r.startButtonEnabled)},e&&"$$inject"in e&&s.$inject_state(e.$$inject),s.$$.update=()=>{s.$$.dirty&7&&t(7,i=d==="granted"&&v&&a)},[d,v,a,u,y,M,B,i,j]}class ct extends Oe{constructor(e){super(e),Ue(this,e,nt,be,Ze,{}),T("SvelteRegisterComponent",{component:this,tagName:"Page",options:e,id:be.name})}}export{ct as component};
