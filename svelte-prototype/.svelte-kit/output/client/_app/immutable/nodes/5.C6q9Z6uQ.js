import{S as Ke,i as Qe,s as Je,d as p,m as V,o as N,p as Ie,q as Me,b as E,y,e as _,f as I,j as C,l as ie,I as We,Q as wt,C as x,D as z,E as G,F as R,h as A,k as P,c as v,L as he,M as jt,n as W,G as H,O as Dt,a as Ce,g as K,t as Q,r as He,N as St,A as Xe}from"../chunks/BbQtw8CC.js";import"../chunks/IHki7fMi.js";import{b as ye,g as Ee}from"../chunks/Dh8H6GB0.js";import{C as de,P as Tt}from"../chunks/DNmPTphr.js";import{e as Le}from"../chunks/D6YF6ztN.js";import{B as Ye}from"../chunks/CB02h6m0.js";import{a as xe,b as kt,P as Et}from"../chunks/DjSLRzt-.js";import{l as It,S as Mt,h as Ft,E as $t,U as At,A as Pt,j as qt,k as Nt,n as Vt,M as Bt,b as Ht,a as me,e as Lt,f as xt,t as zt,i as Gt,d as Rt,c as Ot,p as Ut}from"../chunks/DhyemY5g.js";const Kt=!1,Qt=!1,Nn=Object.freeze(Object.defineProperty({__proto__:null,prerender:Qt,ssr:Kt},Symbol.toStringTag,{value:"Module"}));function ze(a,e,t){const n=a.slice();return n[69]=e[t],n[71]=t,n}function Jt(a){let e,t,n,r,s,o,i,f,g,h,d,c=a[3]&&Ge(a);n=new de({props:{class:"main-card half-width",$$slots:{default:[on]},$$scope:{ctx:a}}}),s=new de({props:{class:"main-card half-width",$$slots:{default:[an]},$$scope:{ctx:a}}}),i=new de({props:{class:"main-card",$$slots:{default:[ln]},$$scope:{ctx:a}}});let b={isActive:a[4]==="granted",trainingPhase:a[11]};return h=new kt({props:b}),a[38](h),h.$on("pitchUpdate",a[26]),h.$on("error",a[27]),{c(){c&&c.c(),e=P(),t=C("div"),R(n.$$.fragment),r=P(),R(s.$$.fragment),o=P(),R(i.$$.fragment),f=P(),g=C("div"),R(h.$$.fragment),this.h()},l(u){c&&c.l(u),e=A(u),t=_(u,"DIV",{class:!0});var m=I(t);G(n.$$.fragment,m),r=A(m),G(s.$$.fragment,m),m.forEach(p),o=A(u),G(i.$$.fragment,u),f=A(u),g=_(u,"DIV",{style:!0});var S=I(g);G(h.$$.fragment,S),S.forEach(p),this.h()},h(){y(t,"class","side-by-side-container svelte-pck0fw"),he(g,"display","none")},m(u,m){c&&c.m(u,m),E(u,e,m),E(u,t,m),z(n,t,null),v(t,r),z(s,t,null),E(u,o,m),z(i,u,m),E(u,f,m),E(u,g,m),z(h,g,null),d=!0},p(u,m){u[3]?c?(c.p(u,m),m[0]&8&&N(c,1)):(c=Ge(u),c.c(),N(c,1),c.m(e.parentNode,e)):c&&(Ie(),V(c,1,1,()=>{c=null}),Me());const S={};m[0]&3778|m[2]&1024&&(S.$$scope={dirty:m,ctx:u}),n.$set(S);const k={};m[0]&28672|m[2]&1024&&(k.$$scope={dirty:m,ctx:u}),s.$set(k);const w={};m[0]&524545|m[2]&1024&&(w.$$scope={dirty:m,ctx:u}),i.$set(w);const T={};m[0]&16&&(T.isActive=u[4]==="granted"),m[0]&2048&&(T.trainingPhase=u[11]),h.$set(T)},i(u){d||(N(c),N(n.$$.fragment,u),N(s.$$.fragment,u),N(i.$$.fragment,u),N(h.$$.fragment,u),d=!0)},o(u){V(c),V(n.$$.fragment,u),V(s.$$.fragment,u),V(i.$$.fragment,u),V(h.$$.fragment,u),d=!1},d(u){u&&(p(e),p(t),p(o),p(f),p(g)),c&&c.d(u),x(n),x(s),x(i,u),a[38](null),x(h)}}}function Wt(a){let e,t,n,r;return e=new At({props:{currentScoreData:a[16],intervalData:a[23]||[],consistencyData:a[24]||[],feedbackData:a[17],technicalFeedbackData:a[18]}}),n=new Pt({props:{showRestart:!a[20],showNext:!a[20],showHome:!0}}),n.$on("restart",a[28]),n.$on("next",a[29]),n.$on("home",a[30]),{c(){R(e.$$.fragment),t=P(),R(n.$$.fragment)},l(s){G(e.$$.fragment,s),t=A(s),G(n.$$.fragment,s)},m(s,o){z(e,s,o),E(s,t,o),z(n,s,o),r=!0},p(s,o){const i={};o[0]&65536&&(i.currentScoreData=s[16]),o[0]&131072&&(i.feedbackData=s[17]),o[0]&262144&&(i.technicalFeedbackData=s[18]),e.$set(i);const f={};o[0]&1048576&&(f.showRestart=!s[20]),o[0]&1048576&&(f.showNext=!s[20]),n.$set(f)},i(s){r||(N(e.$$.fragment,s),N(n.$$.fragment,s),r=!0)},o(s){V(e.$$.fragment,s),V(n.$$.fragment,s),r=!1},d(s){s&&p(t),x(e,s),x(n,s)}}}function Xt(a){let e,t;return e=new de({props:{class:"main-card",$$slots:{default:[un]},$$scope:{ctx:a}}}),{c(){R(e.$$.fragment)},l(n){G(e.$$.fragment,n)},m(n,r){z(e,n,r),t=!0},p(n,r){const s={};r[2]&1024&&(s.$$scope={dirty:r,ctx:n}),e.$set(s)},i(n){t||(N(e.$$.fragment,n),t=!0)},o(n){V(e.$$.fragment,n),t=!1},d(n){x(e,n)}}}function Yt(a){let e,t;return e=new de({props:{class:"main-card",$$slots:{default:[fn]},$$scope:{ctx:a}}}),{c(){R(e.$$.fragment)},l(n){G(e.$$.fragment,n)},m(n,r){z(e,n,r),t=!0},p(n,r){const s={};r[2]&1024&&(s.$$scope={dirty:r,ctx:n}),e.$set(s)},i(n){t||(N(e.$$.fragment,n),t=!0)},o(n){V(e.$$.fragment,n),t=!1},d(n){x(e,n)}}}function Ge(a){let e,t;return e=new de({props:{class:"main-card",$$slots:{default:[Zt]},$$scope:{ctx:a}}}),{c(){R(e.$$.fragment)},l(n){G(e.$$.fragment,n)},m(n,r){z(e,n,r),t=!0},p(n,r){const s={};r[0]&6291460|r[2]&1024&&(s.$$scope={dirty:r,ctx:n}),e.$set(s)},i(n){t||(N(e.$$.fragment,n),t=!0)},o(n){V(e.$$.fragment,n),t=!1},d(n){x(e,n)}}}function Zt(a){let e,t='<h3 class="section-title svelte-pck0fw">📊 進捗状況</h3>',n,r,s,o,i,f,g,h,d,c,b;return{c(){e=C("div"),e.innerHTML=t,n=P(),r=C("div"),s=C("div"),o=C("div"),i=Q("セッション "),f=Q(a[21]),g=Q(" / "),h=Q(a[2]),d=P(),c=C("div"),b=C("div"),this.h()},l(u){e=_(u,"DIV",{class:!0,"data-svelte-h":!0}),H(e)!=="svelte-1hcye1c"&&(e.innerHTML=t),n=A(u),r=_(u,"DIV",{class:!0});var m=I(r);s=_(m,"DIV",{class:!0});var S=I(s);o=_(S,"DIV",{class:!0});var k=I(o);i=K(k,"セッション "),f=K(k,a[21]),g=K(k," / "),h=K(k,a[2]),k.forEach(p),d=A(S),c=_(S,"DIV",{class:!0});var w=I(c);b=_(w,"DIV",{class:!0,style:!0}),I(b).forEach(p),w.forEach(p),S.forEach(p),m.forEach(p),this.h()},h(){y(e,"class","card-header svelte-pck0fw"),y(o,"class","session-counter svelte-pck0fw"),y(b,"class","progress-fill svelte-pck0fw"),he(b,"width",a[22]+"%"),y(c,"class","progress-bar svelte-pck0fw"),y(s,"class","progress-info svelte-pck0fw"),y(r,"class","card-content svelte-pck0fw")},m(u,m){E(u,e,m),E(u,n,m),E(u,r,m),v(r,s),v(s,o),v(o,i),v(o,f),v(o,g),v(o,h),v(s,d),v(s,c),v(c,b)},p(u,m){m[0]&2097152&&Ce(f,u[21]),m[0]&4&&Ce(h,u[2]),m[0]&4194304&&he(b,"width",u[22]+"%")},d(u){u&&(p(e),p(n),p(r))}}}function en(a){let e;return{c(){e=Q("🎹 基音再生")},l(t){e=K(t,"🎹 基音再生")},m(t,n){E(t,e,n)},d(t){t&&p(e)}}}function tn(a){let e;return{c(){e=Q("🔄 自動再生モード")},l(t){e=K(t,"🔄 自動再生モード")},m(t,n){E(t,e,n)},d(t){t&&p(e)}}}function nn(a){let e;return{c(){e=Q("⏳ 読み込み中...")},l(t){e=K(t,"⏳ 読み込み中...")},m(t,n){E(t,e,n)},d(t){t&&p(e)}}}function sn(a){let e;return{c(){e=Q("🎵 再生中...")},l(t){e=K(t,"🎵 再生中...")},m(t,n){E(t,e,n)},d(t){t&&p(e)}}}function rn(a){let e;function t(s,o){return s[7]?sn:s[6]?nn:s[1]?tn:en}let n=t(a),r=n(a);return{c(){r.c(),e=He()},l(s){r.l(s),e=He()},m(s,o){r.m(s,o),E(s,e,o)},p(s,o){n!==(n=t(s))&&(r.d(1),r=n(s),r&&(r.c(),r.m(e.parentNode,e)))},d(s){s&&p(e),r.d(s)}}}function on(a){let e,t='<h3 class="section-title svelte-pck0fw">🎹 基音再生</h3>',n,r,s,o,i,f,g="ガイド開始まで",h,d,c,b,u,m,S,k;return s=new Ye({props:{variant:"primary",disabled:a[7]||a[6]||a[1]&&a[11]==="guiding",$$slots:{default:[rn]},$$scope:{ctx:a}}}),s.$on("click",a[25]),m=new Bt({props:{size:"20"}}),{c(){e=C("div"),e.innerHTML=t,n=P(),r=C("div"),R(s.$$.fragment),o=P(),i=C("div"),f=C("div"),f.textContent=g,h=P(),d=C("div"),c=C("div"),b=P(),u=C("div"),R(m.$$.fragment),this.h()},l(w){e=_(w,"DIV",{class:!0,"data-svelte-h":!0}),H(e)!=="svelte-1u9jvpv"&&(e.innerHTML=t),n=A(w),r=_(w,"DIV",{class:!0});var T=I(r);G(s.$$.fragment,T),o=A(T),i=_(T,"DIV",{class:!0});var M=I(i);f=_(M,"DIV",{class:!0,"data-svelte-h":!0}),H(f)!=="svelte-1dufnpv"&&(f.textContent=g),h=A(M),d=_(M,"DIV",{class:!0});var B=I(d);c=_(B,"DIV",{class:!0,style:!0}),I(c).forEach(p),b=A(B),u=_(B,"DIV",{class:!0});var Y=I(u);G(m.$$.fragment,Y),Y.forEach(p),B.forEach(p),M.forEach(p),T.forEach(p),this.h()},h(){y(e,"class","card-header svelte-pck0fw"),y(f,"class","guide-start-label svelte-pck0fw"),y(c,"class","guide-progress-fill svelte-pck0fw"),he(c,"width",a[9]+"%"),y(u,"class",S="guide-music-icon "+(a[10]?"glowing":"")+" svelte-pck0fw"),y(d,"class","guide-start-bar svelte-pck0fw"),y(i,"class","guide-start-bar-container svelte-pck0fw"),y(r,"class","card-content svelte-pck0fw")},m(w,T){E(w,e,T),E(w,n,T),E(w,r,T),z(s,r,null),v(r,o),v(r,i),v(i,f),v(i,h),v(i,d),v(d,c),v(d,b),v(d,u),z(m,u,null),k=!0},p(w,T){const M={};T[0]&2242&&(M.disabled=w[7]||w[6]||w[1]&&w[11]==="guiding"),T[0]&194|T[2]&1024&&(M.$$scope={dirty:T,ctx:w}),s.$set(M),(!k||T[0]&512)&&he(c,"width",w[9]+"%"),(!k||T[0]&1024&&S!==(S="guide-music-icon "+(w[10]?"glowing":"")+" svelte-pck0fw"))&&y(u,"class",S)},i(w){k||(N(s.$$.fragment,w),N(m.$$.fragment,w),k=!0)},o(w){V(s.$$.fragment,w),V(m.$$.fragment,w),k=!1},d(w){w&&(p(e),p(n),p(r)),x(s),x(m)}}}function an(a){let e,t='<h3 class="section-title svelte-pck0fw">🎤 リアルタイム検出</h3>',n,r,s,o;return s=new Et({props:{frequency:a[13],note:a[14],volume:a[12],isMuted:!1}}),{c(){e=C("div"),e.innerHTML=t,n=P(),r=C("div"),R(s.$$.fragment),this.h()},l(i){e=_(i,"DIV",{class:!0,"data-svelte-h":!0}),H(e)!=="svelte-momj6l"&&(e.innerHTML=t),n=A(i),r=_(i,"DIV",{class:!0});var f=I(r);G(s.$$.fragment,f),f.forEach(p),this.h()},h(){y(e,"class","card-header svelte-pck0fw"),y(r,"class","card-content svelte-pck0fw")},m(i,f){E(i,e,f),E(i,n,f),E(i,r,f),z(s,r,null),o=!0},p(i,f){const g={};f[0]&8192&&(g.frequency=i[13]),f[0]&16384&&(g.note=i[14]),f[0]&4096&&(g.volume=i[12]),s.$set(g)},i(i){o||(N(s.$$.fragment,i),o=!0)},o(i){V(s.$$.fragment,i),o=!1},d(i){i&&(p(e),p(n),p(r)),x(s)}}}function Re(a){let e,t=a[69]+"",n,r,s;return{c(){e=C("div"),n=Q(t),r=P(),this.h()},l(o){e=_(o,"DIV",{class:!0});var i=I(e);n=K(i,t),r=A(i),i.forEach(p),this.h()},h(){var o;y(e,"class",s="scale-item "+(((o=a[8][a[71]])==null?void 0:o.state)||"inactive")+" svelte-pck0fw")},m(o,i){E(o,e,i),v(e,n),v(e,r)},p(o,i){var f;i[0]&524288&&t!==(t=o[69]+"")&&Ce(n,t),i[0]&256&&s!==(s="scale-item "+(((f=o[8][o[71]])==null?void 0:f.state)||"inactive")+" svelte-pck0fw")&&y(e,"class",s)},d(o){o&&p(e)}}}function ln(a){let e,t,n,r=a[0]==="chromatic"?"12":"8",s,o,i,f,g,h=Le(a[19]),d=[];for(let c=0;c<h.length;c+=1)d[c]=Re(ze(a,h,c));return{c(){e=C("div"),t=C("h3"),n=Q("🎵 "),s=Q(r),o=Q("音階ガイド"),i=P(),f=C("div"),g=C("div");for(let c=0;c<d.length;c+=1)d[c].c();this.h()},l(c){e=_(c,"DIV",{class:!0});var b=I(e);t=_(b,"H3",{class:!0});var u=I(t);n=K(u,"🎵 "),s=K(u,r),o=K(u,"音階ガイド"),u.forEach(p),b.forEach(p),i=A(c),f=_(c,"DIV",{class:!0});var m=I(f);g=_(m,"DIV",{class:!0});var S=I(g);for(let k=0;k<d.length;k+=1)d[k].l(S);S.forEach(p),m.forEach(p),this.h()},h(){y(t,"class","section-title svelte-pck0fw"),y(e,"class","card-header svelte-pck0fw"),y(g,"class","scale-guide svelte-pck0fw"),y(f,"class","card-content svelte-pck0fw")},m(c,b){E(c,e,b),v(e,t),v(t,n),v(t,s),v(t,o),E(c,i,b),E(c,f,b),v(f,g);for(let u=0;u<d.length;u+=1)d[u]&&d[u].m(g,null)},p(c,b){if(b[0]&1&&r!==(r=c[0]==="chromatic"?"12":"8")&&Ce(s,r),b[0]&524544){h=Le(c[19]);let u;for(u=0;u<h.length;u+=1){const m=ze(c,h,u);d[u]?d[u].p(m,b):(d[u]=Re(m),d[u].c(),d[u].m(g,null))}for(;u<d.length;u+=1)d[u].d(1);d.length=h.length}},d(c){c&&(p(e),p(i),p(f)),Dt(d,c)}}}function cn(a){let e;return{c(){e=Q("ホームに戻る")},l(t){e=K(t,"ホームに戻る")},m(t,n){E(t,e,n)},d(t){t&&p(e)}}}function un(a){let e,t,n="⚠️ マイク許可が必要です",r,s,o="マイクテストページから開始してください",i,f,g;return f=new Ye({props:{variant:"primary",$$slots:{default:[cn]},$$scope:{ctx:a}}}),f.$on("click",a[30]),{c(){e=C("div"),t=C("h3"),t.textContent=n,r=P(),s=C("p"),s.textContent=o,i=P(),R(f.$$.fragment),this.h()},l(h){e=_(h,"DIV",{class:!0});var d=I(e);t=_(d,"H3",{"data-svelte-h":!0}),H(t)!=="svelte-1iz0ljq"&&(t.textContent=n),r=A(d),s=_(d,"P",{"data-svelte-h":!0}),H(s)!=="svelte-13xvrzt"&&(s.textContent=o),i=A(d),G(f.$$.fragment,d),d.forEach(p),this.h()},h(){y(e,"class","card-content text-center svelte-pck0fw")},m(h,d){E(h,e,d),v(e,t),v(e,r),v(e,s),v(e,i),z(f,e,null),g=!0},p(h,d){const c={};d[2]&1024&&(c.$$scope={dirty:d,ctx:h}),f.$set(c)},i(h){g||(N(f.$$.fragment,h),g=!0)},o(h){V(f.$$.fragment,h),g=!1},d(h){h&&p(e),x(f)}}}function fn(a){let e,t="<h3>⏳ マイク初期化中...</h3> <p>しばらくお待ちください</p>";return{c(){e=C("div"),e.innerHTML=t,this.h()},l(n){e=_(n,"DIV",{class:!0,"data-svelte-h":!0}),H(e)!=="svelte-1f701n6"&&(e.innerHTML=t),this.h()},h(){y(e,"class","card-content text-center svelte-pck0fw")},m(n,r){E(n,e,r)},p:W,d(n){n&&p(e)}}}function dn(a){let e,t,n,r;const s=[Yt,Xt,Wt,Jt],o=[];function i(f,g){return f[4]==="checking"?0:f[4]==="denied"||f[4]==="error"?1:f[15]&&f[16]?2:3}return t=i(a),n=o[t]=s[t](a),{c(){e=C("div"),n.c(),this.h()},l(f){e=_(f,"DIV",{class:!0});var g=I(e);n.l(g),g.forEach(p),this.h()},h(){y(e,"class","training-core svelte-pck0fw")},m(f,g){E(f,e,g),o[t].m(e,null),r=!0},p(f,g){let h=t;t=i(f),t===h?o[t].p(f,g):(Ie(),V(o[h],1,1,()=>{o[h]=null}),Me(),n=o[t],n?n.p(f,g):(n=o[t]=s[t](f),n.c()),N(n,1),n.m(e,null))},i(f){r||(N(n),r=!0)},o(f){V(n),r=!1},d(f){f&&p(e),o[t].d()}}}function Oe(){const a=/iPhone/.test(navigator.userAgent),e=/iPad/.test(navigator.userAgent),t=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document;return a||e||t?(console.log("🔊 [TrainingCore] iOS/iPadOS検出 - 音量35dB設定"),35):(console.log("🔊 [TrainingCore] PC検出 - 音量-6dB設定"),-6)}function Te(a){return{C4:261.63,Db4:277.18,D4:293.66,Eb4:311.13,E4:329.63,F4:349.23,Gb4:369.99,G4:392,Ab4:415.3,A4:440,Bb4:466.16,B4:493.88,C5:523.25,Db5:554.37,D5:587.33,Eb5:622.25,E5:659.25,F5:698.46,Gb5:739.99,G5:783.99}[a]||261.63}function Ue(a,e){return a*([1,1.125,1.25,1.3333333333333333,1.5,1.6666666666666667,1.875,2][e]||1)}function gn(a,e){return!a||!e||a<=0||e<=0?null:Math.round(1200*Math.log2(a/e))}function mn(a){if(a===null)return 0;const e=Math.abs(a);return Math.max(0,Math.min(100,100-e/50*100))}function hn(a){if(!a||a.length===0)return"E";const e=a.map(g=>g.grade),t=e.filter(g=>g==="excellent").length,n=e.filter(g=>g==="good").length,r=e.filter(g=>g==="pass").length,s=e.length,o=t/s,i=(t+n)/s,f=(t+n+r)/s;return o>=.9?"S":o>=.7?"A":i>=.8?"B":f>=.7?"C":f>=.4?"D":"E"}function ke(a){if(!a||a.length===0)return{type:"info",primary:"データなし",summary:"測定データがありません"};const e=a.filter(o=>o.accuracy!=="notMeasured"),t=e.length>0?Math.round(e.reduce((o,i)=>o+i.accuracy,0)/e.length):0;let n,r,s;return t>=85?(n="excellent",r="素晴らしい精度です！",s=`平均精度${t}%で優秀な音感能力を示しています。`):t>=70?(n="improvement",r="良い進歩が見られます",s=`平均精度${t}%で確実に向上しています。`):t>=50?(n="practice",r="継続練習で向上中",s=`現在の精度${t}%から更なる向上を目指しましょう。`):(n="encouragement",r="練習を続けましょう",s="継続的な練習で必ず上達します。"),{type:n,primary:r,summary:s}}function pn(a,e,t){let n,r,s,o,i,f,g,h,d;ie(a,Lt,l=>t(48,s=l)),ie(a,xt,l=>t(49,o=l)),ie(a,zt,l=>t(50,i=l)),ie(a,Gt,l=>t(20,f=l)),ie(a,Rt,l=>t(51,g=l)),ie(a,Ot,l=>t(21,h=l)),ie(a,Ut,l=>t(22,d=l));let{mode:c="random"}=e,{autoPlay:b=!1}=e,{sessionCount:u=8}=e,{baseNote:m=null}=e,{direction:S="asc"}=e,{useLocalStorage:k=!0}=e;const w="random-training-progress";let{onSessionComplete:T=null}=e,{onAllComplete:M=null}=e,{onMicrophoneError:B=null}=e;const Y=null,O=[{note:"C4",name:"ド（中）",frequency:261.63,semitonesFromC:0},{note:"Db4",name:"ド#（中）",frequency:277.18,semitonesFromC:1},{note:"D4",name:"レ（中）",frequency:293.66,semitonesFromC:2},{note:"Eb4",name:"レ#（中）",frequency:311.13,semitonesFromC:3},{note:"E4",name:"ミ（中）",frequency:329.63,semitonesFromC:4},{note:"F4",name:"ファ（中）",frequency:349.23,semitonesFromC:5},{note:"Gb4",name:"ファ#（中）",frequency:369.99,semitonesFromC:6},{note:"Ab4",name:"ラb（中）",frequency:415.3,semitonesFromC:8},{note:"Bb3",name:"シb（低）",frequency:233.08,semitonesFromC:-2},{note:"B3",name:"シ（低）",frequency:246.94,semitonesFromC:-1}];let ne="checking",Ze=null,et=null,tt=null,re=null,ce=null,oe=!1,ge=!1,Z=[],we=0,je=!1,ae="waiting",De=0,Fe=0,$e="ーー",U=[],pe=null,ve=!1,be=null,ue=null,nt=[],st=[],_e=null,Ae=null,J=[];We(async()=>{console.log(`🚀 [TrainingCore] ${c}モード初期化開始`);try{k&&(await It(),console.log(`✅ [TrainingCore] localStorage初期化完了: セッション${h}/8`)),ht(),await rt(),await at(),Ne(),console.log(`✅ [TrainingCore] ${c}モード初期化完了`)}catch(l){console.error("❌ [TrainingCore] 初期化エラー:",l),B&&B(l.message)}}),wt(()=>{ce&&ce.dispose()});async function rt(){const l=typeof localStorage<"u"&&localStorage.getItem("mic-test-completed")==="true";if(console.log("🎤 [TrainingCore] マイクテスト完了フラグ:",l),!l){console.log("⚠️ [TrainingCore] マイクテスト未完了 - マイクテストページへリダイレクト"),B&&B("マイクテストが必要です");return}new URLSearchParams(window.location.search).get("from")==="microphone-test"?(t(4,ne="granted"),console.log("✅ [TrainingCore] マイクテスト経由でアクセス - 許可済み"),await Pe()):(console.log("🔍 [TrainingCore] ダイレクトアクセス検出 - マイク許可状態確認"),await ot())}async function ot(){try{(await navigator.permissions.query({name:"microphone"})).state==="granted"?(console.log("✅ [TrainingCore] マイク許可済み検出 - AudioManager初期化実行"),await Pe()):(t(4,ne="denied"),console.log("⚠️ [TrainingCore] マイク許可が必要です"))}catch(l){console.error("❌ [TrainingCore] マイク許可確認エラー:",l),t(4,ne="error")}}async function Pe(){var l;t(4,ne="checking");try{if(console.log("🎤 [TrainingCore] AudioManager経由でマイク許可確認開始"),!((l=navigator.mediaDevices)!=null&&l.getUserMedia)){t(4,ne="error"),console.error("❌ [TrainingCore] getUserMedia未対応ブラウザ");return}const j=await xe.initialize();et=j.audioContext,Ze=j.mediaStream,tt=j.sourceNode,console.log("✅ [TrainingCore] AudioManager リソース取得完了"),t(4,ne="granted"),t(11,ae="waiting"),setTimeout(async()=>{if(re&&re.getIsInitialized&&!re.getIsInitialized())try{console.log("🎙️ [TrainingCore] PitchDetector初期化開始");const D=/iPad/.test(navigator.userAgent),F=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document;if(D||F){console.log("📱 [TrainingCore] iPad/iPadOS検出 - AudioManager再初期化");try{await xe.initialize(),console.log("✅ [TrainingCore] AudioManager再初期化完了")}catch(q){console.warn("⚠️ AudioManager再初期化エラー:",q)}}await re.initialize(),console.log("✅ [TrainingCore] PitchDetector初期化完了")}catch(D){console.warn("⚠️ [TrainingCore] PitchDetector初期化失敗:",D)}},300)}catch(j){console.error("❌ [TrainingCore] マイク許可エラー:",j),t(4,ne=(j==null?void 0:j.name)==="NotAllowedError"?"denied":"error"),B&&B(j.message)}}async function at(){try{if(typeof window>"u"){console.log("⚠️ [TrainingCore] SSR環境検出 - 基音再生初期化スキップ");return}t(6,oe=!0),console.log("🎹 [TrainingCore] Salamander Grand Piano 読み込み開始"),ce=new Mt({urls:{C4:"C4.mp3"},baseUrl:`${ye}/audio/piano/`,release:1.5,volume:Oe(),onload:()=>{t(6,oe=!1),console.log("✅ [TrainingCore] Salamander Piano音源読み込み完了")},onerror:l=>{console.error("❌ [TrainingCore] Salamander Piano音源読み込みエラー:",l),t(6,oe=!1)}}).toDestination(),await Ft(),t(6,oe=!1),console.log("✅ [TrainingCore] Salamander Grand Piano 読み込み完了")}catch(l){console.error("❌ [TrainingCore] 基音再生初期化エラー:",l),t(6,oe=!1)}}async function qe(){if(!(ge||!ce||oe))try{if(typeof window<"u"&&window.Tone){const D=window.Tone.context||window.Tone.getContext();D&&D.state==="suspended"&&(console.log("🔄 [TrainingCore] AudioContext suspended検出 - 再開中..."),await D.resume(),console.log("✅ [TrainingCore] AudioContext再開完了")),qt.state!=="running"&&(await Nt(),console.log("🔊 [TrainingCore] Tone.js AudioContext 開始"))}t(7,ge=!0);let l;if(c==="chromatic"&&m)l=O.find(D=>D.note===m)||O[0];else{const D=Math.floor(Math.random()*r.length),F=r[D];l=O.find(q=>q.note===F)||O[0]}const j=Oe();ce.volume.value=j,console.log(`🎹 [TrainingCore] 基音再生: ${l.note} (${l.name}, ${l.frequency}Hz, ${j}dB)`),ce.triggerAttackRelease(l.note,2,Vt(),.7),lt(),setTimeout(()=>{t(7,ge=!1)},3e3)}catch(l){console.error("❌ [TrainingCore] 基音再生エラー:",l),t(7,ge=!1)}}function Ne(){t(8,Z=n.map(()=>({state:"inactive"}))),console.log(`🎵 [TrainingCore] ガイドシステム初期化: ${n.length}音階`)}function lt(){t(11,ae="guiding");let l=0;const j=setInterval(()=>{l+=2,t(9,we=l),l>=100&&(clearInterval(j),t(10,je=!0),setTimeout(()=>{it()},2e3))},40)}function it(){console.log("🎵 [TrainingCore] ガイドシーケンス開始");let l=0;const j=setInterval(()=>{l<Z.length?(t(8,Z[l].state="active",Z),l++,t(8,Z=[...Z])):(clearInterval(j),t(11,ae="listening"),pe=Date.now(),U=n.map(D=>({name:D,cents:null,targetFreq:0,detectedFreq:0,diff:0,accuracy:0})),console.log("🎤 [TrainingCore] リスニングフェーズ開始"))},500)}async function ct(){if(!pe)return;const l=Math.round((Date.now()-pe)/1e3),j=m||s,D=g;console.log(`✅ [TrainingCore] セッション完了: ${l}秒`),J=U.map(F=>({name:F.name,cents:F.cents,targetFreq:F.targetFreq,detectedFreq:F.detectedFreq,diff:F.diff,accuracy:F.accuracy===null?"notMeasured":F.accuracy})),k?await Ht(U,l,j,D)&&(console.log("✅ [TrainingCore] セッション結果保存完了"),pt(),bt(),t(15,ve=!0),T&&T(),f&&M&&M()):(vt(j,D),t(15,ve=!0),T&&T())}function ut(l){const{frequency:j,note:D,volume:F}=l.detail;t(13,Fe=j),t(14,$e=D),t(12,De=F),ae==="listening"&&U.length>0&&(ft(j),Ct(j,D))}function ft(l,j){const F=Te(m||s),q=Ve();if(q>=0&&q<U.length){const L=Ue(F,q),X=gn(l,L);U[q]={name:n[q],cents:X,targetFreq:L,detectedFreq:l,diff:l-L,accuracy:mn(X)},U=[...U],U.filter(fe=>fe.cents!==null).length>=n.length&&ct()}}function Ve(){for(let l=0;l<Z.length;l++)if(Z[l].state==="active")return l;return-1}function dt(l){console.error("❌ [TrainingCore] PitchDetectorエラー:",l.detail),B&&B(l.detail.error)}function Be(){t(15,ve=!1),t(11,ae="waiting"),t(9,we=0),t(10,je=!1),Ne()}function gt(){Be(),b&&!f&&setTimeout(()=>qe(),1e3)}function mt(){Ee(`${ye}/`)}function ht(){try{ue=new $t,console.log("[TrainingCore] 採点エンジン初期化完了")}catch(l){console.error("[TrainingCore] 採点エンジン初期化エラー:",l)}}function pt(){if(!J||J.length===0){console.warn("[TrainingCore UnifiedScore] noteResultsForDisplay が空です");return}const l=J.filter($=>$.accuracy!=="notMeasured").length,j=J.length,D=J.filter($=>$.accuracy!=="notMeasured"&&typeof $.accuracy=="number").map($=>$.accuracy),F=D.length>0?Math.round(D.reduce(($,Se)=>$+Se,0)/D.length):0,q=m||s,L=Te(q),X=J.map($=>({name:$.name,note:$.note||$.name,frequency:$.targetFreq,detectedFrequency:$.detectedFreq,cents:$.cents,grade:me.evaluateNote($.cents),targetFreq:$.targetFreq,diff:$.diff})),ee=i,fe=(ee==null?void 0:ee.sessionHistory)||[],le={timestamp:new Date,baseNote:q,baseFrequency:L,noteResults:X,measuredNotes:l,accuracy:F,grade:me.evaluateSession(J)},se=[...fe,le];t(16,be={mode:c,timestamp:new Date,duration:Math.round((Date.now()-pe)/1e3),totalNotes:j,measuredNotes:l,averageAccuracy:F,baseNote:q,baseFrequency:L,noteResults:X,distribution:me.calculateDistribution(J),sessionHistory:se,unifiedGrade:hn(se)}),console.log("[TrainingCore UnifiedScore] 統合採点データ生成完了:",be)}function vt(l,j){const D=me.calculateAccuracy(U);t(16,be={mode:c,sessionHistory:[{sessionId:1,grade:me.evaluateSession(U),accuracy:D,baseNote:l,baseName:j,noteResults:U,completedAt:new Date().toISOString()}],isCompleted:!0,totalSessions:1,targetSessions:1,averageAccuracy:D})}async function bt(){try{if(ue){const l=o||[];for(const[D,F]of l.entries())if(F.noteResults&&F.noteResults.length>0){const q=F.baseFrequency||262;for(const L of F.noteResults)L.detectedFreq&&L.targetFreq&&await ue.analyzePerformance({baseFreq:q,targetFreq:L.targetFreq,detectedFreq:L.detectedFreq,responseTime:2e3,volume:50,harmonicCorrection:null})}const j=ue.generateDetailedReport();t(18,Ae=_t(j)),t(17,_e=ke(J))}else t(17,_e=ke(J));console.log("[TrainingCore EnhancedScoring] 追加採点データ生成完了")}catch(l){console.error("[TrainingCore EnhancedScoring] データ生成エラー:",l),t(17,_e=ke(J))}}function _t(l){var ee,fe;const j=c==="chromatic"?12:8;if((o||[]).length<j||!l)return null;l.improvements;const q=[];let L=0,X=0;if((ee=l.detailed)!=null&&ee.intervals){const le=l.detailed.intervals;if(le.totalAnalyses>0){let se=0,$=0;for(const[Se,te]of Object.entries(le.masteryLevels))te.attempts>0&&(se+=te.averageAccuracy*te.attempts,$+=te.attempts);L=$>0?se/$:0}}if((fe=l.detailed)!=null&&fe.directions){const le=l.detailed.directions;if(le.totalAnalyses>0){let se=0,$=0;for(const[Se,te]of Object.entries(le.masteryData))te.attempts>0&&(se+=te.averageAccuracy*te.attempts,$+=te.attempts);X=$>0?se/$:0}}return q.push({category:"improvements",text:`音程精度: ${Math.round(L)}%　（音の高さを捉える正確性　目標基準：70〜85%）`}),q.push({category:"improvements",text:`方向性: ${Math.round(X)}%　（音程の上下判断の精度　目標基準：80〜90%）`}),{type:"info",primary:"詳細分析結果",summary:"音程精度・一貫性・方向性の総合分析",details:q}}function Ct(l,j){if(!ue||ae!=="listening")return;const D=Ve();if(D<0||D>=U.length)return;const q=Te(m||s),L=Ue(q,D),X={baseFrequency:q,targetFrequency:L,detectedFrequency:l,detectedNote:j,volume:De,timestamp:Date.now(),scaleIndex:D,scaleName:n[D]};try{ue.processAttempt(X)}catch(ee){console.error("[TrainingCore] 採点エンジンエラー:",ee)}}function yt(l){jt[l?"unshift":"push"](()=>{re=l,t(5,re)})}return a.$$set=l=>{"mode"in l&&t(0,c=l.mode),"autoPlay"in l&&t(1,b=l.autoPlay),"sessionCount"in l&&t(2,u=l.sessionCount),"baseNote"in l&&t(31,m=l.baseNote),"direction"in l&&t(32,S=l.direction),"useLocalStorage"in l&&t(3,k=l.useLocalStorage),"onSessionComplete"in l&&t(34,T=l.onSessionComplete),"onAllComplete"in l&&t(35,M=l.onAllComplete),"onMicrophoneError"in l&&t(36,B=l.onMicrophoneError)},a.$$.update=()=>{a.$$.dirty[0]&1|a.$$.dirty[1]&2&&t(19,n=c==="chromatic"?S==="asc"?["ド","ド#","レ","レ#","ミ","ファ","ファ#","ソ","ソ#","ラ","ラ#","シ"]:["シ","ラ#","ラ","ソ#","ソ","ファ#","ファ","ミ","レ#","レ","ド#","ド"]:["ド","レ","ミ","ファ","ソ","ラ","シ","ド（高）"]),a.$$.dirty[0]&1&&(r=c==="continuous"?["Bb3","B3","C4","Db4","D4","Eb4","E4","F4","Gb4","Ab4"]:["C4","Db4","D4","Eb4","E4","F4","Gb4","Ab4","Bb3","B3"])},[c,b,u,k,ne,re,oe,ge,Z,we,je,ae,De,Fe,$e,ve,be,_e,Ae,n,f,h,d,nt,st,qe,ut,dt,Be,gt,mt,m,S,w,T,M,B,Y,yt]}class vn extends Ke{constructor(e){super(),Qe(this,e,pn,dn,Je,{mode:0,autoPlay:1,sessionCount:2,baseNote:31,direction:32,useLocalStorage:3,sessionKey:33,onSessionComplete:34,onAllComplete:35,onMicrophoneError:36,onStorageError:37},null,[-1,-1,-1])}get sessionKey(){return this.$$.ctx[33]}get onStorageError(){return this.$$.ctx[37]}}function bn(a){let e,t='<div class="loading-spinner svelte-14jb1jb">⚡</div> <p>読み込み中...</p>';return{c(){e=C("div"),e.innerHTML=t,this.h()},l(n){e=_(n,"DIV",{class:!0,"data-svelte-h":!0}),H(e)!=="svelte-1awb2cx"&&(e.innerHTML=t),this.h()},h(){y(e,"class","loading-placeholder svelte-14jb1jb")},m(n,r){E(n,e,r)},p:W,i:W,o:W,d(n){n&&p(e)}}}function _n(a){let e,t;return e=new vn({props:{mode:"continuous",autoPlay:!0,sessionCount:8,useLocalStorage:!0,sessionKey:"continuous-training-progress",onMicrophoneError:a[3],onStorageError:Dn,onSessionComplete:Sn,onAllComplete:Tn}}),{c(){R(e.$$.fragment)},l(n){G(e.$$.fragment,n)},m(n,r){z(e,n,r),t=!0},p:W,i(n){t||(N(e.$$.fragment,n),t=!0)},o(n){V(e.$$.fragment,n),t=!1},d(n){x(e,n)}}}function Cn(a){let e,t,n,r='<div class="challenge-icon svelte-14jb1jb">⚡</div>',s,o,i,f="連続チャレンジモード",g,h,d=`<div class="feature-item svelte-14jb1jb"><div class="feature-icon svelte-14jb1jb">🎯</div> <div class="feature-text svelte-14jb1jb"><strong class="svelte-14jb1jb">8セッション連続</strong><br/>
                  途中で止まらない集中トレーニング</div></div> <div class="feature-item svelte-14jb1jb"><div class="feature-icon svelte-14jb1jb">🔥</div> <div class="feature-text svelte-14jb1jb"><strong class="svelte-14jb1jb">中級向け難易度</strong><br/>
                  より難しい基音での挑戦</div></div> <div class="feature-item svelte-14jb1jb"><div class="feature-icon svelte-14jb1jb">🚀</div> <div class="feature-text svelte-14jb1jb"><strong class="svelte-14jb1jb">自動進行</strong><br/>
                  セッション完了後に自動で次へ</div></div>`,c,b,u='<h3 class="svelte-14jb1jb">🎼 使用基音（中級レベル）</h3> <div class="base-notes-grid svelte-14jb1jb"><span class="base-note svelte-14jb1jb">Bb3</span> <span class="base-note svelte-14jb1jb">B3</span> <span class="base-note svelte-14jb1jb">Db4</span> <span class="base-note svelte-14jb1jb">Eb4</span> <span class="base-note svelte-14jb1jb">F#4</span> <span class="base-note svelte-14jb1jb">G#4</span> <span class="base-note svelte-14jb1jb">Bb4</span> <span class="base-note svelte-14jb1jb">C#5</span> <span class="base-note svelte-14jb1jb">Eb5</span> <span class="base-note svelte-14jb1jb">F#5</span></div>',m,S,k="🔥 チャレンジ開始！",w,T;return{c(){e=C("div"),t=C("div"),n=C("div"),n.innerHTML=r,s=P(),o=C("div"),i=C("h2"),i.textContent=f,g=P(),h=C("div"),h.innerHTML=d,c=P(),b=C("div"),b.innerHTML=u,m=P(),S=C("button"),S.textContent=k,this.h()},l(M){e=_(M,"DIV",{class:!0});var B=I(e);t=_(B,"DIV",{class:!0});var Y=I(t);n=_(Y,"DIV",{class:!0,"data-svelte-h":!0}),H(n)!=="svelte-13ksuac"&&(n.innerHTML=r),s=A(Y),o=_(Y,"DIV",{class:!0});var O=I(o);i=_(O,"H2",{class:!0,"data-svelte-h":!0}),H(i)!=="svelte-1je1qsu"&&(i.textContent=f),g=A(O),h=_(O,"DIV",{class:!0,"data-svelte-h":!0}),H(h)!=="svelte-1ew1nx5"&&(h.innerHTML=d),c=A(O),b=_(O,"DIV",{class:!0,"data-svelte-h":!0}),H(b)!=="svelte-9z8rw7"&&(b.innerHTML=u),m=A(O),S=_(O,"BUTTON",{class:!0,"data-svelte-h":!0}),H(S)!=="svelte-la0s3j"&&(S.textContent=k),O.forEach(p),Y.forEach(p),B.forEach(p),this.h()},h(){y(n,"class","challenge-icon-wrapper svelte-14jb1jb"),y(i,"class","challenge-title svelte-14jb1jb"),y(h,"class","challenge-features svelte-14jb1jb"),y(b,"class","difficulty-info svelte-14jb1jb"),y(S,"class","start-challenge-button svelte-14jb1jb"),y(o,"class","challenge-content"),y(t,"class","challenge-card svelte-14jb1jb"),y(e,"class","start-screen svelte-14jb1jb")},m(M,B){E(M,e,B),v(e,t),v(t,n),v(t,s),v(t,o),v(o,i),v(o,g),v(o,h),v(o,c),v(o,b),v(o,m),v(o,S),w||(T=Xe(S,"click",a[4]),w=!0)},p:W,i:W,o:W,d(M){M&&p(e),w=!1,T()}}}function yn(a){let e,t,n,r="⚠️",s,o,i,f="マイクテストが必要です",g,h,d="連続チャレンジを開始する前に、マイクの動作確認を行ってください。",c,b,u="マイクテストを開始",m,S;return{c(){e=C("div"),t=C("div"),n=C("div"),n.textContent=r,s=P(),o=C("div"),i=C("h3"),i.textContent=f,g=P(),h=C("p"),h.textContent=d,c=P(),b=C("button"),b.textContent=u,this.h()},l(k){e=_(k,"DIV",{class:!0});var w=I(e);t=_(w,"DIV",{class:!0});var T=I(t);n=_(T,"DIV",{class:!0,"data-svelte-h":!0}),H(n)!=="svelte-dwi5dc"&&(n.textContent=r),s=A(T),o=_(T,"DIV",{class:!0});var M=I(o);i=_(M,"H3",{class:!0,"data-svelte-h":!0}),H(i)!=="svelte-17kvze2"&&(i.textContent=f),g=A(M),h=_(M,"P",{class:!0,"data-svelte-h":!0}),H(h)!=="svelte-t9m3nr"&&(h.textContent=d),c=A(M),b=_(M,"BUTTON",{class:!0,"data-svelte-h":!0}),H(b)!=="svelte-18xr2xp"&&(b.textContent=u),M.forEach(p),T.forEach(p),w.forEach(p),this.h()},h(){y(n,"class","warning-icon svelte-14jb1jb"),y(i,"class","svelte-14jb1jb"),y(h,"class","svelte-14jb1jb"),y(b,"class","mic-test-button svelte-14jb1jb"),y(o,"class","warning-content svelte-14jb1jb"),y(t,"class","warning-card svelte-14jb1jb"),y(e,"class","mic-test-required svelte-14jb1jb")},m(k,w){E(k,e,w),v(e,t),v(t,n),v(t,s),v(t,o),v(o,i),v(o,g),v(o,h),v(o,c),v(o,b),m||(S=Xe(b,"click",a[5]),m=!0)},p:W,i:W,o:W,d(k){k&&p(e),m=!1,S()}}}function wn(a){let e,t,n='<h1 class="page-title svelte-14jb1jb">⚡ 連続チャレンジモード</h1> <p class="page-description svelte-14jb1jb">中級者向け：より難しい基音で8セッション連続挑戦</p>',r,s,o,i;const f=[yn,Cn,_n,bn],g=[];function h(d,c){return d[2]&&!d[0]?0:d[2]&&d[0]&&d[1]?1:d[2]&&d[0]&&!d[1]?2:d[2]?-1:3}return~(s=h(a))&&(o=g[s]=f[s](a)),{c(){e=C("div"),t=C("div"),t.innerHTML=n,r=P(),o&&o.c(),this.h()},l(d){e=_(d,"DIV",{class:!0});var c=I(e);t=_(c,"DIV",{class:!0,"data-svelte-h":!0}),H(t)!=="svelte-1la1yd9"&&(t.innerHTML=n),r=A(c),o&&o.l(c),c.forEach(p),this.h()},h(){y(t,"class","page-header svelte-14jb1jb"),y(e,"class","continuous-training-page svelte-14jb1jb")},m(d,c){E(d,e,c),v(e,t),v(e,r),~s&&g[s].m(e,null),i=!0},p(d,c){let b=s;s=h(d),s===b?~s&&g[s].p(d,c):(o&&(Ie(),V(g[b],1,1,()=>{g[b]=null}),Me()),~s?(o=g[s],o?o.p(d,c):(o=g[s]=f[s](d),o.c()),N(o,1),o.m(e,null)):o=null)},i(d){i||(N(o),i=!0)},o(d){V(o),i=!1},d(d){d&&p(e),~s&&g[s].d()}}}function jn(a){let e,t,n;return t=new Tt({props:{showBackButton:!0,$$slots:{default:[wn]},$$scope:{ctx:a}}}),{c(){e=P(),R(t.$$.fragment),this.h()},l(r){St("svelte-13kpo59",document.head).forEach(p),e=A(r),G(t.$$.fragment,r),this.h()},h(){document.title="連続チャレンジモード - 相対音感トレーニング"},m(r,s){E(r,e,s),z(t,r,s),n=!0},p(r,[s]){const o={};s&71&&(o.$$scope={dirty:s,ctx:r}),t.$set(o)},i(r){n||(N(t.$$.fragment,r),n=!0)},o(r){V(t.$$.fragment,r),n=!1},d(r){r&&p(e),x(t,r)}}}function Dn(a){console.error("🚨 [ContinuousTraining] ストレージエラー:",a)}function Sn(){console.log("✅ [ContinuousTraining] セッション完了")}function Tn(){console.log("🎉 [ContinuousTraining] 8セッション完了！")}function kn(a,e,t){let n=!1,r=!1,s=!1;We(()=>{t(2,s=!0),typeof localStorage<"u"&&(t(0,n=localStorage.getItem("mic-test-completed")==="true"),console.log("🎤 [ContinuousTraining] マイクテスト完了フラグ:",n),n&&(t(1,r=!0),console.log("🎯 [ContinuousTraining] チャレンジ開始画面を表示")))});function o(g){console.error("🚨 [ContinuousTraining] マイクロフォンエラー:",g),Ee(`${ye}/microphone-test?mode=continuous`)}function i(){t(1,r=!1)}return[n,r,s,o,i,()=>Ee(`${ye}/microphone-test?mode=continuous`)]}class Vn extends Ke{constructor(e){super(),Qe(this,e,kn,jn,Je,{})}}export{Vn as component,Nn as universal};
