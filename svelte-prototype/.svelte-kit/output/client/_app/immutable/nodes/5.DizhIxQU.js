const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["../chunks/COGgd1ld.js","../chunks/BbQtw8CC.js","../chunks/D6YF6ztN.js","../chunks/IHki7fMi.js","../chunks/DToEmvX0.js","../assets/sessionStorage.2zs4CtXT.css"])))=>i.map(i=>d[i]);
import{_ as st}from"../chunks/C1FmrZbK.js";import{S as on,i as an,s as cn,d as h,C as ce,m as B,o as F,b as $,D as le,N as ln,h as O,E as ie,k as G,F as ue,l as we,I as un,Q as fn,p as De,q as Ce,c as g,y as k,L as $e,e as A,f as H,G as pe,g as z,r as Ie,j as T,t as j,M as mn,a as _e,O as It,n as ot}from"../chunks/BbQtw8CC.js";import{e as Ue}from"../chunks/D6YF6ztN.js";import"../chunks/IHki7fMi.js";import{b as Je,g as at}from"../chunks/DToEmvX0.js";import{p as dn}from"../chunks/jGt1E1Xm.js";import{P as gn,C as He}from"../chunks/DNmPTphr.js";import{B as Ke}from"../chunks/CB02h6m0.js";import{l as te,a as Ee,b as pn,P as hn,h as ct}from"../chunks/DjSLRzt-.js";import{l as lt,s as je,S as vn,E as yn,A as Nt,n as it,M as _n,U as Rt,a as Oe,b as Sn,c as bn,u as wn,i as Dn,r as Cn,d as An,e as Tn,f as Mn,t as kn,g as In}from"../chunks/COGgd1ld.js";const Nn=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global,Rn=!1,Fn=!1,pr=Object.freeze(Object.defineProperty({__proto__:null,prerender:Fn,ssr:Rn},Symbol.toStringTag,{value:"Module"})),{document:ut}=Nn;function ft(o,e,t){const n=o.slice();return n[98]=e[t],n[100]=t,n}function mt(o,e,t){const n=o.slice();return n[101]=e[t],n}function dt(o){var x,Q,X;let e,t,n,r,s=(((x=o[24])==null?void 0:x.length)||0)+"",i,m,f,c,u,p=8-(((Q=o[24])==null?void 0:Q.length)||0)+"",d,S,_,C,M,q,Y,w,b=Math.round((((X=o[24])==null?void 0:X.length)||0)/8*100)+"",V,U,v,I,R,P=o[0]==="results"&&gt(o);return{c(){e=T("div"),t=T("div"),n=T("div"),r=T("span"),i=j(s),m=j("/8"),f=G(),c=T("span"),u=j("残り "),d=j(p),S=j(" セッション"),_=G(),C=T("div"),M=T("div"),q=T("div"),Y=G(),w=T("span"),V=j(b),U=j("%"),v=G(),P&&P.c(),I=Ie(),this.h()},l(L){e=A(L,"DIV",{class:!0});var re=H(e);t=A(re,"DIV",{class:!0});var Se=H(t);n=A(Se,"DIV",{class:!0});var se=H(n);r=A(se,"SPAN",{class:!0});var de=H(r);i=z(de,s),m=z(de,"/8"),de.forEach(h),f=O(se),c=A(se,"SPAN",{class:!0});var oe=H(c);u=z(oe,"残り "),d=z(oe,p),S=z(oe," セッション"),oe.forEach(h),se.forEach(h),_=O(Se),C=A(Se,"DIV",{class:!0});var he=H(C);M=A(he,"DIV",{class:!0});var Me=H(M);q=A(Me,"DIV",{class:!0,style:!0}),H(q).forEach(h),Me.forEach(h),Y=O(he),w=A(he,"SPAN",{class:!0});var Ne=H(w);V=z(Ne,b),U=z(Ne,"%"),Ne.forEach(h),he.forEach(h),Se.forEach(h),re.forEach(h),v=O(L),P&&P.l(L),I=Ie(),this.h()},h(){var L;k(r,"class","completed-count svelte-rt5px1"),k(c,"class","remaining-text svelte-rt5px1"),k(n,"class","session-info svelte-rt5px1"),k(q,"class","progress-fill svelte-rt5px1"),$e(q,"width",(((L=o[24])==null?void 0:L.length)||0)/8*100+"%"),k(M,"class","progress-bar svelte-rt5px1"),k(w,"class","progress-text svelte-rt5px1"),k(C,"class","progress-section svelte-rt5px1"),k(t,"class","session-status svelte-rt5px1"),k(e,"class","session-progress svelte-rt5px1")},m(L,re){$(L,e,re),g(e,t),g(t,n),g(n,r),g(r,i),g(r,m),g(n,f),g(n,c),g(c,u),g(c,d),g(c,S),g(t,_),g(t,C),g(C,M),g(M,q),g(C,Y),g(C,w),g(w,V),g(w,U),$(L,v,re),P&&P.m(L,re),$(L,I,re),R=!0},p(L,re){var Se,se,de,oe;(!R||re[0]&16777216)&&s!==(s=(((Se=L[24])==null?void 0:Se.length)||0)+"")&&_e(i,s),(!R||re[0]&16777216)&&p!==(p=8-(((se=L[24])==null?void 0:se.length)||0)+"")&&_e(d,p),(!R||re[0]&16777216)&&$e(q,"width",(((de=L[24])==null?void 0:de.length)||0)/8*100+"%"),(!R||re[0]&16777216)&&b!==(b=Math.round((((oe=L[24])==null?void 0:oe.length)||0)/8*100)+"")&&_e(V,b),L[0]==="results"?P?(P.p(L,re),re[0]&1&&F(P,1)):(P=gt(L),P.c(),F(P,1),P.m(I.parentNode,I)):P&&(De(),B(P,1,1,()=>{P=null}),Ce())},i(L){R||(F(P),R=!0)},o(L){B(P),R=!1},d(L){L&&(h(e),h(v),h(I)),P&&P.d(L)}}}function gt(o){let e,t,n;return t=new Nt({props:{isCompleted:o[5],position:"top"}}),t.$on("action",o[29]),{c(){e=T("div"),ue(t.$$.fragment),this.h()},l(r){e=A(r,"DIV",{class:!0});var s=H(e);ie(t.$$.fragment,s),s.forEach(h),this.h()},h(){k(e,"class","top-action-buttons svelte-rt5px1")},m(r,s){$(r,e,s),le(t,e,null),n=!0},p(r,s){const i={};s[0]&32&&(i.isCompleted=r[5]),t.$set(i)},i(r){n||(F(t.$$.fragment,r),n=!0)},o(r){B(t.$$.fragment,r),n=!1},d(r){r&&h(e),ce(t)}}}function En(o){let e,t;return e=new He({props:{class:"error-card",$$slots:{default:[xn]},$$scope:{ctx:o}}}),{c(){ue(e.$$.fragment)},l(n){ie(e.$$.fragment,n)},m(n,r){le(e,n,r),t=!0},p(n,r){const s={};r[3]&2048&&(s.$$scope={dirty:r,ctx:n}),e.$set(s)},i(n){t||(F(e.$$.fragment,n),t=!0)},o(n){B(e.$$.fragment,n),t=!1},d(n){ce(e,n)}}}function $n(o){let e,t,n,r,s,i,m,f={isActive:o[1]==="granted",trainingPhase:o[0],className:"pitch-detector-content",debugMode:!0,disableHarmonicCorrection:!1};t=new pn({props:f}),o[34](t),t.$on("pitchUpdate",o[28]),t.$on("stateChange",nr),t.$on("error",rr),t.$on("microphoneHealthChange",o[31]);let c=o[0]!=="results"&&pt(o),u=o[0]!=="results"&&_t(o),p=o[0]==="results"&&wt(o);return{c(){e=T("div"),ue(t.$$.fragment),n=G(),c&&c.c(),r=G(),u&&u.c(),s=G(),p&&p.c(),i=Ie(),this.h()},l(d){e=A(d,"DIV",{style:!0});var S=H(e);ie(t.$$.fragment,S),S.forEach(h),n=O(d),c&&c.l(d),r=O(d),u&&u.l(d),s=O(d),p&&p.l(d),i=Ie(),this.h()},h(){$e(e,"display","none")},m(d,S){$(d,e,S),le(t,e,null),$(d,n,S),c&&c.m(d,S),$(d,r,S),u&&u.m(d,S),$(d,s,S),p&&p.m(d,S),$(d,i,S),m=!0},p(d,S){const _={};S[0]&2&&(_.isActive=d[1]==="granted"),S[0]&1&&(_.trainingPhase=d[0]),t.$set(_),d[0]!=="results"?c?(c.p(d,S),S[0]&1&&F(c,1)):(c=pt(d),c.c(),F(c,1),c.m(r.parentNode,r)):c&&(De(),B(c,1,1,()=>{c=null}),Ce()),d[0]!=="results"?u?(u.p(d,S),S[0]&1&&F(u,1)):(u=_t(d),u.c(),F(u,1),u.m(s.parentNode,s)):u&&(De(),B(u,1,1,()=>{u=null}),Ce()),d[0]==="results"?p?(p.p(d,S),S[0]&1&&F(p,1)):(p=wt(d),p.c(),F(p,1),p.m(i.parentNode,i)):p&&(De(),B(p,1,1,()=>{p=null}),Ce())},i(d){m||(F(t.$$.fragment,d),F(c),F(u),F(p),m=!0)},o(d){B(t.$$.fragment,d),B(c),B(u),B(p),m=!1},d(d){d&&(h(e),h(n),h(r),h(s),h(i)),o[34](null),ce(t),c&&c.d(d),u&&u.d(d),p&&p.d(d)}}}function qn(o){let e;return{c(){e=j("🎤 マイクテストページへ移動")},l(t){e=z(t,"🎤 マイクテストページへ移動")},m(t,n){$(t,e,n)},d(t){t&&h(e)}}}function Pn(o){let e;return{c(){e=j("🏠 ホームに戻る")},l(t){e=z(t,"🏠 ホームに戻る")},m(t,n){$(t,e,n)},d(t){t&&h(e)}}}function xn(o){let e,t,n="🎤",r,s,i="マイクテストが必要です",m,f,c="連続チャレンジモードを開始する前に、マイクテストページで音声入力の確認をお願いします。",u,p,d='<p class="svelte-rt5px1">このページは<strong>マイクテスト完了後</strong>にご利用いただけます。</p> <p class="svelte-rt5px1">まずはマイクテストページで音声確認を行ってください。</p>',S,_,C,M,q,Y;return C=new Ke({props:{variant:"primary",$$slots:{default:[qn]},$$scope:{ctx:o}}}),C.$on("click",o[26]),q=new Ke({props:{variant:"secondary",$$slots:{default:[Pn]},$$scope:{ctx:o}}}),q.$on("click",o[27]),{c(){e=T("div"),t=T("div"),t.textContent=n,r=G(),s=T("h3"),s.textContent=i,m=G(),f=T("p"),f.textContent=c,u=G(),p=T("div"),p.innerHTML=d,S=G(),_=T("div"),ue(C.$$.fragment),M=G(),ue(q.$$.fragment),this.h()},l(w){e=A(w,"DIV",{class:!0});var b=H(e);t=A(b,"DIV",{class:!0,"data-svelte-h":!0}),pe(t)!=="svelte-15rbx8n"&&(t.textContent=n),r=O(b),s=A(b,"H3",{class:!0,"data-svelte-h":!0}),pe(s)!=="svelte-17kvze2"&&(s.textContent=i),m=O(b),f=A(b,"P",{class:!0,"data-svelte-h":!0}),pe(f)!=="svelte-1t09god"&&(f.textContent=c),u=O(b),p=A(b,"DIV",{class:!0,"data-svelte-h":!0}),pe(p)!=="svelte-13ge0u9"&&(p.innerHTML=d),S=O(b),_=A(b,"DIV",{class:!0});var V=H(_);ie(C.$$.fragment,V),M=O(V),ie(q.$$.fragment,V),V.forEach(h),b.forEach(h),this.h()},h(){k(t,"class","error-icon svelte-rt5px1"),k(s,"class","svelte-rt5px1"),k(f,"class","svelte-rt5px1"),k(p,"class","recommendation svelte-rt5px1"),k(_,"class","action-buttons"),k(e,"class","error-content svelte-rt5px1")},m(w,b){$(w,e,b),g(e,t),g(e,r),g(e,s),g(e,m),g(e,f),g(e,u),g(e,p),g(e,S),g(e,_),le(C,_,null),g(_,M),le(q,_,null),Y=!0},p(w,b){const V={};b[3]&2048&&(V.$$scope={dirty:b,ctx:w}),C.$set(V);const U={};b[3]&2048&&(U.$$scope={dirty:b,ctx:w}),q.$set(U)},i(w){Y||(F(C.$$.fragment,w),F(q.$$.fragment,w),Y=!0)},o(w){B(C.$$.fragment,w),B(q.$$.fragment,w),Y=!1},d(w){w&&h(e),ce(C),ce(q)}}}function pt(o){let e,t,n,r,s,i,m=!o[2]&&o[6].length>0&&ht(o);return n=new He({props:{class:"main-card half-width",$$slots:{default:[Un]},$$scope:{ctx:o}}}),s=new hn({props:{frequency:o[14],note:o[15],volume:o[13],isMuted:o[0]!=="guiding",muteMessage:"基音再生後に開始",className:"half-width",showGuidance:!1}}),{c(){m&&m.c(),e=G(),t=T("div"),ue(n.$$.fragment),r=G(),ue(s.$$.fragment),this.h()},l(f){m&&m.l(f),e=O(f),t=A(f,"DIV",{class:!0});var c=H(t);ie(n.$$.fragment,c),r=O(c),ie(s.$$.fragment,c),c.forEach(h),this.h()},h(){k(t,"class","side-by-side-container svelte-rt5px1")},m(f,c){m&&m.m(f,c),$(f,e,c),$(f,t,c),le(n,t,null),g(t,r),le(s,t,null),i=!0},p(f,c){!f[2]&&f[6].length>0?m?(m.p(f,c),c[0]&68&&F(m,1)):(m=ht(f),m.c(),F(m,1),m.m(e.parentNode,e)):m&&(De(),B(m,1,1,()=>{m=null}),Ce());const u={};c[0]&8395649|c[3]&2048&&(u.$$scope={dirty:c,ctx:f}),n.$set(u);const p={};c[0]&16384&&(p.frequency=f[14]),c[0]&32768&&(p.note=f[15]),c[0]&8192&&(p.volume=f[13]),c[0]&1&&(p.isMuted=f[0]!=="guiding"),s.$set(p)},i(f){i||(F(m),F(n.$$.fragment,f),F(s.$$.fragment,f),i=!0)},o(f){B(m),B(n.$$.fragment,f),B(s.$$.fragment,f),i=!1},d(f){f&&(h(e),h(t)),m&&m.d(f),ce(n),ce(s)}}}function ht(o){let e,t;return e=new He({props:{class:"warning-card",$$slots:{default:[Vn]},$$scope:{ctx:o}}}),{c(){ue(e.$$.fragment)},l(n){ie(e.$$.fragment,n)},m(n,r){le(e,n,r),t=!0},p(n,r){const s={};r[0]&64|r[3]&2048&&(s.$$scope={dirty:r,ctx:n}),e.$set(s)},i(n){t||(F(e.$$.fragment,n),t=!0)},o(n){B(e.$$.fragment,n),t=!1},d(n){ce(e,n)}}}function vt(o){let e,t=o[101]+"",n;return{c(){e=T("li"),n=j(t),this.h()},l(r){e=A(r,"LI",{class:!0});var s=H(e);n=z(s,t),s.forEach(h),this.h()},h(){k(e,"class","svelte-rt5px1")},m(r,s){$(r,e,s),g(e,n)},p(r,s){s[0]&64&&t!==(t=r[101]+"")&&_e(n,t)},d(r){r&&h(e)}}}function Vn(o){let e,t='<h3 class="section-title svelte-rt5px1">⚠️ マイク接続に問題があります</h3>',n,r,s,i="マイクが正常に動作していません。以下の問題が検出されました：",m,f,c,u,p="<strong>解決方法:</strong> ページを再読み込みしてマイク許可を再度取得してください。",d=Ue(o[6]),S=[];for(let _=0;_<d.length;_+=1)S[_]=vt(mt(o,d,_));return{c(){e=T("div"),e.innerHTML=t,n=G(),r=T("div"),s=T("p"),s.textContent=i,m=G(),f=T("ul");for(let _=0;_<S.length;_+=1)S[_].c();c=G(),u=T("p"),u.innerHTML=p,this.h()},l(_){e=A(_,"DIV",{class:!0,"data-svelte-h":!0}),pe(e)!=="svelte-1mob8td"&&(e.innerHTML=t),n=O(_),r=A(_,"DIV",{class:!0});var C=H(r);s=A(C,"P",{class:!0,"data-svelte-h":!0}),pe(s)!=="svelte-171o2p0"&&(s.textContent=i),m=O(C),f=A(C,"UL",{class:!0});var M=H(f);for(let q=0;q<S.length;q+=1)S[q].l(M);M.forEach(h),c=O(C),u=A(C,"P",{class:!0,"data-svelte-h":!0}),pe(u)!=="svelte-1o4df0k"&&(u.innerHTML=p),C.forEach(h),this.h()},h(){k(e,"class","card-header svelte-rt5px1"),k(s,"class","warning-message svelte-rt5px1"),k(f,"class","error-list svelte-rt5px1"),k(u,"class","fix-instruction svelte-rt5px1"),k(r,"class","card-content svelte-rt5px1")},m(_,C){$(_,e,C),$(_,n,C),$(_,r,C),g(r,s),g(r,m),g(r,f);for(let M=0;M<S.length;M+=1)S[M]&&S[M].m(f,null);g(r,c),g(r,u)},p(_,C){if(C[0]&64){d=Ue(_[6]);let M;for(M=0;M<d.length;M+=1){const q=mt(_,d,M);S[M]?S[M].p(q,C):(S[M]=vt(q),S[M].c(),S[M].m(f,null))}for(;M<S.length;M+=1)S[M].d(1);S.length=d.length}},d(_){_&&(h(e),h(n),h(r)),It(S,_)}}}function Hn(o){let e;function t(s,i){return s[9]?On:s[0]==="guiding"?jn:s[0]==="results"?zn:Ln}let n=t(o),r=n(o);return{c(){e=T("div"),r.c(),this.h()},l(s){e=A(s,"DIV",{class:!0});var i=H(e);r.l(i),i.forEach(h),this.h()},h(){k(e,"class","continuous-status svelte-rt5px1")},m(s,i){$(s,e,i),r.m(e,null)},p(s,i){n===(n=t(s))&&r?r.p(s,i):(r.d(1),r=n(s),r&&(r.c(),r.m(e,null)))},i:ot,o:ot,d(s){s&&h(e),r.d()}}}function Bn(o){let e,t;return e=new Ke({props:{variant:"primary",$$slots:{default:[Gn]},$$scope:{ctx:o}}}),e.$on("click",o[30]),{c(){ue(e.$$.fragment)},l(n){ie(e.$$.fragment,n)},m(n,r){le(e,n,r),t=!0},p(n,r){const s={};r[3]&2048&&(s.$$scope={dirty:r,ctx:n}),e.$set(s)},i(n){t||(F(e.$$.fragment,n),t=!0)},o(n){B(e.$$.fragment,n),t=!1},d(n){ce(e,n)}}}function Ln(o){let e,t,n,r;return{c(){e=T("div"),t=j("⚡ 連続モード進行中 ("),n=j(o[23]),r=j("/8)"),this.h()},l(s){e=A(s,"DIV",{class:!0});var i=H(e);t=z(i,"⚡ 連続モード進行中 ("),n=z(i,o[23]),r=z(i,"/8)"),i.forEach(h),this.h()},h(){k(e,"class","status-text svelte-rt5px1")},m(s,i){$(s,e,i),g(e,t),g(e,n),g(e,r)},p(s,i){i[0]&8388608&&_e(n,s[23])},d(s){s&&h(e)}}}function zn(o){let e,t,n,r;return{c(){e=T("div"),t=j("✅ セッション "),n=j(o[23]),r=j("/8 完了"),this.h()},l(s){e=A(s,"DIV",{class:!0});var i=H(e);t=z(i,"✅ セッション "),n=z(i,o[23]),r=z(i,"/8 完了"),i.forEach(h),this.h()},h(){k(e,"class","status-text svelte-rt5px1")},m(s,i){$(s,e,i),g(e,t),g(e,n),g(e,r)},p(s,i){i[0]&8388608&&_e(n,s[23])},d(s){s&&h(e)}}}function jn(o){let e,t,n,r;return{c(){e=T("div"),t=j("🎤 セッション "),n=j(o[23]),r=j("/8: ドレミ発声中"),this.h()},l(s){e=A(s,"DIV",{class:!0});var i=H(e);t=z(i,"🎤 セッション "),n=z(i,o[23]),r=z(i,"/8: ドレミ発声中"),i.forEach(h),this.h()},h(){k(e,"class","status-text svelte-rt5px1")},m(s,i){$(s,e,i),g(e,t),g(e,n),g(e,r)},p(s,i){i[0]&8388608&&_e(n,s[23])},d(s){s&&h(e)}}}function On(o){let e,t,n,r;return{c(){e=T("div"),t=j("🎵 基音 "),n=j(o[23]),r=j("/8 再生中..."),this.h()},l(s){e=A(s,"DIV",{class:!0});var i=H(e);t=z(i,"🎵 基音 "),n=z(i,o[23]),r=z(i,"/8 再生中..."),i.forEach(h),this.h()},h(){k(e,"class","status-text svelte-rt5px1")},m(s,i){$(s,e,i),g(e,t),g(e,n),g(e,r)},p(s,i){i[0]&8388608&&_e(n,s[23])},d(s){s&&h(e)}}}function Gn(o){let e;return{c(){e=j("⚡ 連続チャレンジ開始（8セッション）")},l(t){e=z(t,"⚡ 連続チャレンジ開始（8セッション）")},m(t,n){$(t,e,n)},d(t){t&&h(e)}}}function yt(o){let e,t,n,r,s,i=o[8].toFixed(1)+"",m,f;return{c(){e=T("div"),t=j("現在の基音: "),n=T("strong"),r=j(o[7]),s=j(" ("),m=j(i),f=j("Hz)"),this.h()},l(c){e=A(c,"DIV",{class:!0});var u=H(e);t=z(u,"現在の基音: "),n=A(u,"STRONG",{});var p=H(n);r=z(p,o[7]),p.forEach(h),s=z(u," ("),m=z(u,i),f=z(u,"Hz)"),u.forEach(h),this.h()},h(){k(e,"class","base-note-info svelte-rt5px1")},m(c,u){$(c,e,u),g(e,t),g(e,n),g(n,r),g(e,s),g(e,m),g(e,f)},p(c,u){u[0]&128&&_e(r,c[7]),u[0]&256&&i!==(i=c[8].toFixed(1)+"")&&_e(m,i)},d(c){c&&h(e)}}}function Un(o){let e,t='<h3 class="section-title svelte-rt5px1">🎹 基音再生</h3>',n,r,s,i,m,f,c,u,p="ガイド開始まで",d,S,_,C,M,q,Y,w;const b=[Bn,Hn],V=[];function U(I,R){return I[0]==="setup"&&!I[9]&&!(I[23]>1)?0:1}s=U(o),i=V[s]=b[s](o);let v=o[7]&&yt(o);return q=new _n({props:{size:"20"}}),{c(){e=T("div"),e.innerHTML=t,n=G(),r=T("div"),i.c(),m=G(),v&&v.c(),f=G(),c=T("div"),u=T("div"),u.textContent=p,d=G(),S=T("div"),_=T("div"),C=G(),M=T("div"),ue(q.$$.fragment),this.h()},l(I){e=A(I,"DIV",{class:!0,"data-svelte-h":!0}),pe(e)!=="svelte-o46h1v"&&(e.innerHTML=t),n=O(I),r=A(I,"DIV",{class:!0});var R=H(r);i.l(R),m=O(R),v&&v.l(R),f=O(R),c=A(R,"DIV",{class:!0});var P=H(c);u=A(P,"DIV",{class:!0,"data-svelte-h":!0}),pe(u)!=="svelte-1dufnpv"&&(u.textContent=p),d=O(P),S=A(P,"DIV",{class:!0});var x=H(S);_=A(x,"DIV",{class:!0,style:!0}),H(_).forEach(h),C=O(x),M=A(x,"DIV",{class:!0});var Q=H(M);ie(q.$$.fragment,Q),Q.forEach(h),x.forEach(h),P.forEach(h),R.forEach(h),this.h()},h(){k(e,"class","card-header svelte-rt5px1"),k(u,"class","guide-start-label svelte-rt5px1"),k(_,"class","guide-progress-fill svelte-rt5px1"),$e(_,"width",o[11]+"%"),k(M,"class",Y="guide-music-icon "+(o[12]?"glowing":"")+" svelte-rt5px1"),k(S,"class","guide-start-bar svelte-rt5px1"),k(c,"class","guide-start-bar-container svelte-rt5px1"),k(r,"class","card-content svelte-rt5px1")},m(I,R){$(I,e,R),$(I,n,R),$(I,r,R),V[s].m(r,null),g(r,m),v&&v.m(r,null),g(r,f),g(r,c),g(c,u),g(c,d),g(c,S),g(S,_),g(S,C),g(S,M),le(q,M,null),w=!0},p(I,R){let P=s;s=U(I),s===P?V[s].p(I,R):(De(),B(V[P],1,1,()=>{V[P]=null}),Ce(),i=V[s],i?i.p(I,R):(i=V[s]=b[s](I),i.c()),F(i,1),i.m(r,m)),I[7]?v?v.p(I,R):(v=yt(I),v.c(),v.m(r,f)):v&&(v.d(1),v=null),(!w||R[0]&2048)&&$e(_,"width",I[11]+"%"),(!w||R[0]&4096&&Y!==(Y="guide-music-icon "+(I[12]?"glowing":"")+" svelte-rt5px1"))&&k(M,"class",Y)},i(I){w||(F(i),F(q.$$.fragment,I),w=!0)},o(I){B(i),B(q.$$.fragment,I),w=!1},d(I){I&&(h(e),h(n),h(r)),V[s].d(),v&&v.d(),ce(q)}}}function _t(o){let e,t;return e=new He({props:{class:"main-card",$$slots:{default:[Qn]},$$scope:{ctx:o}}}),{c(){ue(e.$$.fragment)},l(n){ie(e.$$.fragment,n)},m(n,r){le(e,n,r),t=!0},p(n,r){const s={};r[0]&1025|r[3]&2048&&(s.$$scope={dirty:r,ctx:n}),e.$set(s)},i(n){t||(F(e.$$.fragment,n),t=!0)},o(n){B(e.$$.fragment,n),t=!1},d(n){ce(e,n)}}}function St(o){let e,t=o[98].name+"",n,r,s;return{c(){e=T("div"),n=j(t),r=G(),this.h()},l(i){e=A(i,"DIV",{class:!0});var m=H(e);n=z(m,t),r=O(m),m.forEach(h),this.h()},h(){k(e,"class",s="scale-item "+o[98].state+" svelte-rt5px1")},m(i,m){$(i,e,m),g(e,n),g(e,r)},p(i,m){m[0]&1024&&t!==(t=i[98].name+"")&&_e(n,t),m[0]&1024&&s!==(s="scale-item "+i[98].state+" svelte-rt5px1")&&k(e,"class",s)},d(i){i&&h(e)}}}function bt(o){let e,t="ガイドに合わせて <strong>ドレミファソラシド</strong> を歌ってください";return{c(){e=T("div"),e.innerHTML=t,this.h()},l(n){e=A(n,"DIV",{class:!0,"data-svelte-h":!0}),pe(e)!=="svelte-sgc3nk"&&(e.innerHTML=t),this.h()},h(){k(e,"class","guide-instruction svelte-rt5px1")},m(n,r){$(n,e,r)},d(n){n&&h(e)}}}function Qn(o){let e,t='<h3 class="section-title svelte-rt5px1">🎵 ドレミ音階ガイド</h3>',n,r,s,i,m=Ue(o[10]),f=[];for(let u=0;u<m.length;u+=1)f[u]=St(ft(o,m,u));let c=o[0]==="guiding"&&bt();return{c(){e=T("div"),e.innerHTML=t,n=G(),r=T("div"),s=T("div");for(let u=0;u<f.length;u+=1)f[u].c();i=G(),c&&c.c(),this.h()},l(u){e=A(u,"DIV",{class:!0,"data-svelte-h":!0}),pe(e)!=="svelte-z1jpw4"&&(e.innerHTML=t),n=O(u),r=A(u,"DIV",{class:!0});var p=H(r);s=A(p,"DIV",{class:!0});var d=H(s);for(let S=0;S<f.length;S+=1)f[S].l(d);d.forEach(h),i=O(p),c&&c.l(p),p.forEach(h),this.h()},h(){k(e,"class","card-header svelte-rt5px1"),k(s,"class","scale-guide svelte-rt5px1"),k(r,"class","card-content svelte-rt5px1")},m(u,p){$(u,e,p),$(u,n,p),$(u,r,p),g(r,s);for(let d=0;d<f.length;d+=1)f[d]&&f[d].m(s,null);g(r,i),c&&c.m(r,null)},p(u,p){if(p[0]&1024){m=Ue(u[10]);let d;for(d=0;d<m.length;d+=1){const S=ft(u,m,d);f[d]?f[d].p(S,p):(f[d]=St(S),f[d].c(),f[d].m(s,null))}for(;d<f.length;d+=1)f[d].d(1);f.length=m.length}u[0]==="guiding"?c||(c=bt(),c.c(),c.m(r,null)):c&&(c.d(1),c=null)},d(u){u&&(h(e),h(n),h(r)),It(f,u),c&&c.d()}}}function wt(o){let e,t,n,r,s;const i=[Jn,Xn],m=[];function f(u,p){return u[4]&&u[5]?0:u[21]?1:-1}~(e=f(o))&&(t=m[e]=i[e](o));let c=o[0]==="results"&&Dt(o);return{c(){t&&t.c(),n=G(),c&&c.c(),r=Ie()},l(u){t&&t.l(u),n=O(u),c&&c.l(u),r=Ie()},m(u,p){~e&&m[e].m(u,p),$(u,n,p),c&&c.m(u,p),$(u,r,p),s=!0},p(u,p){let d=e;e=f(u),e===d?~e&&m[e].p(u,p):(t&&(De(),B(m[d],1,1,()=>{m[d]=null}),Ce()),~e?(t=m[e],t?t.p(u,p):(t=m[e]=i[e](u),t.c()),F(t,1),t.m(n.parentNode,n)):t=null),u[0]==="results"?c?(c.p(u,p),p[0]&1&&F(c,1)):(c=Dt(u),c.c(),F(c,1),c.m(r.parentNode,r)):c&&(De(),B(c,1,1,()=>{c=null}),Ce())},i(u){s||(F(t),F(c),s=!0)},o(u){B(t),B(c),s=!1},d(u){u&&(h(n),h(r)),~e&&m[e].d(u),c&&c.d(u)}}}function Xn(o){let e,t;return e=new Rt({props:{scoreData:o[21],showDetails:!1,className:"mb-6 iphone-no-margin",currentScoreData:o[16],intervalData:o[3],consistencyData:o[17],feedbackData:o[18],technicalFeedbackData:o[19],sessionStatistics:o[20]}}),{c(){ue(e.$$.fragment)},l(n){ie(e.$$.fragment,n)},m(n,r){le(e,n,r),t=!0},p(n,r){const s={};r[0]&2097152&&(s.scoreData=n[21]),r[0]&65536&&(s.currentScoreData=n[16]),r[0]&8&&(s.intervalData=n[3]),r[0]&131072&&(s.consistencyData=n[17]),r[0]&262144&&(s.feedbackData=n[18]),r[0]&524288&&(s.technicalFeedbackData=n[19]),r[0]&1048576&&(s.sessionStatistics=n[20]),e.$set(s)},i(n){t||(F(e.$$.fragment,n),t=!0)},o(n){B(e.$$.fragment,n),t=!1},d(n){ce(e,n)}}}function Jn(o){let e,t;return e=new Rt({props:{scoreData:o[4],showDetails:!1,className:"mb-6 iphone-no-margin",currentScoreData:o[16],intervalData:o[3],consistencyData:o[17],feedbackData:o[18],technicalFeedbackData:o[19],sessionStatistics:o[20]}}),{c(){ue(e.$$.fragment)},l(n){ie(e.$$.fragment,n)},m(n,r){le(e,n,r),t=!0},p(n,r){const s={};r[0]&16&&(s.scoreData=n[4]),r[0]&65536&&(s.currentScoreData=n[16]),r[0]&8&&(s.intervalData=n[3]),r[0]&131072&&(s.consistencyData=n[17]),r[0]&262144&&(s.feedbackData=n[18]),r[0]&524288&&(s.technicalFeedbackData=n[19]),r[0]&1048576&&(s.sessionStatistics=n[20]),e.$set(s)},i(n){t||(F(e.$$.fragment,n),t=!0)},o(n){B(e.$$.fragment,n),t=!1},d(n){ce(e,n)}}}function Dt(o){let e,t;return e=new He({props:{class:"main-card bottom-action-card",$$slots:{default:[Kn]},$$scope:{ctx:o}}}),{c(){ue(e.$$.fragment)},l(n){ie(e.$$.fragment,n)},m(n,r){le(e,n,r),t=!0},p(n,r){const s={};r[0]&32|r[3]&2048&&(s.$$scope={dirty:r,ctx:n}),e.$set(s)},i(n){t||(F(e.$$.fragment,n),t=!0)},o(n){B(e.$$.fragment,n),t=!1},d(n){ce(e,n)}}}function Kn(o){let e,t,n;return t=new Nt({props:{isCompleted:o[5],position:"bottom"}}),t.$on("action",o[29]),{c(){e=T("div"),ue(t.$$.fragment),this.h()},l(r){e=A(r,"DIV",{class:!0});var s=H(e);ie(t.$$.fragment,s),s.forEach(h),this.h()},h(){k(e,"class","card-content svelte-rt5px1")},m(r,s){$(r,e,s),le(t,e,null),n=!0},p(r,s){const i={};s[0]&32&&(i.isCompleted=r[5]),t.$set(i)},i(r){n||(F(t.$$.fragment,r),n=!0)},o(r){B(t.$$.fragment,r),n=!1},d(r){r&&h(e),ce(t)}}}function Wn(o){let e,t,n="⚡ 連続チャレンジモード",r,s,i="中級者向け：8セッション連続で基音が自動再生される集中トレーニング",m,f,c,u,p,d,S,_,C,M,q,Y,w,b,V,U,v=o[1]==="granted"&&!o[25]&&dt(o);const I=[$n,En],R=[];function P(x,Q){return x[1]==="granted"?0:1}return w=P(o),b=R[w]=I[w](o),{c(){e=T("div"),t=T("h1"),t.textContent=n,r=G(),s=T("p"),s.textContent=i,m=G(),v&&v.c(),f=G(),c=T("div"),u=j("📱 "),p=j(Ct),d=j(" | "),S=j(At),_=T("br"),C=G(),M=T("small"),q=j(Tt),Y=G(),b.c(),V=Ie(),this.h()},l(x){e=A(x,"DIV",{class:!0});var Q=H(e);t=A(Q,"H1",{class:!0,"data-svelte-h":!0}),pe(t)!=="svelte-1nub9gt"&&(t.textContent=n),r=O(Q),s=A(Q,"P",{class:!0,"data-svelte-h":!0}),pe(s)!=="svelte-gneggn"&&(s.textContent=i),m=O(Q),v&&v.l(Q),f=O(Q),c=A(Q,"DIV",{class:!0});var X=H(c);u=z(X,"📱 "),p=z(X,Ct),d=z(X," | "),S=z(X,At),_=A(X,"BR",{}),C=O(X),M=A(X,"SMALL",{style:!0});var L=H(M);q=z(L,Tt),L.forEach(h),X.forEach(h),Q.forEach(h),Y=O(x),b.l(x),V=Ie(),this.h()},h(){k(t,"class","page-title svelte-rt5px1"),k(s,"class","page-description svelte-rt5px1"),$e(M,"font-size","0.6rem"),k(c,"class","debug-info svelte-rt5px1"),k(e,"class","header-section svelte-rt5px1")},m(x,Q){$(x,e,Q),g(e,t),g(e,r),g(e,s),g(e,m),v&&v.m(e,null),g(e,f),g(e,c),g(c,u),g(c,p),g(c,d),g(c,S),g(c,_),g(c,C),g(c,M),g(M,q),$(x,Y,Q),R[w].m(x,Q),$(x,V,Q),U=!0},p(x,Q){x[1]==="granted"&&!x[25]?v?(v.p(x,Q),Q[0]&33554434&&F(v,1)):(v=dt(x),v.c(),F(v,1),v.m(e,f)):v&&(De(),B(v,1,1,()=>{v=null}),Ce());let X=w;w=P(x),w===X?R[w].p(x,Q):(De(),B(R[X],1,1,()=>{R[X]=null}),Ce(),b=R[w],b?b.p(x,Q):(b=R[w]=I[w](x),b.c()),F(b,1),b.m(V.parentNode,V))},i(x){U||(F(v),F(b),U=!0)},o(x){B(v),B(b),U=!1},d(x){x&&(h(e),h(Y),h(V)),v&&v.d(),R[w].d(x)}}}function Yn(o){let e,t,n;return t=new gn({props:{$$slots:{default:[Wn]},$$scope:{ctx:o}}}),{c(){e=G(),ue(t.$$.fragment),this.h()},l(r){ln("svelte-13kpo59",ut.head).forEach(h),e=O(r),ie(t.$$.fragment,r),this.h()},h(){ut.title="連続チャレンジモード - 相対音感トレーニング"},m(r,s){$(r,e,s),le(t,r,s),n=!0},p(r,s){const i={};s[0]&67108863|s[3]&2048&&(i.$$scope={dirty:s,ctx:r}),t.$set(i)},i(r){n||(F(t.$$.fragment,r),n=!0)},o(r){B(t.$$.fragment,r),n=!1},d(r){r&&h(e),ce(t,r)}}}const Ct="v2.3.1-ANIMATED",At="07/29 04:15",Tt="🎬 評価分布アニメーション実装・UX向上";function Zn(){const o=/iPhone/.test(navigator.userAgent),e=/iPad/.test(navigator.userAgent),t=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document;return o||e||t?(console.log("🔊 [RandomTraining] iOS/iPadOS検出 - 音量35dB設定"),35):(console.log("🔊 [RandomTraining] PC検出 - 音量-6dB設定"),-6)}function Mt(o){return[{scale:"ド",interval:"unison",intervalName:"ユニゾン"},{scale:"レ",interval:"major_second",intervalName:"長2度"},{scale:"ミ",interval:"major_third",intervalName:"長3度"},{scale:"ファ",interval:"perfect_fourth",intervalName:"完全4度"},{scale:"ソ",interval:"perfect_fifth",intervalName:"完全5度"},{scale:"ラ",interval:"major_sixth",intervalName:"長6度"},{scale:"シ",interval:"major_seventh",intervalName:"長7度"},{scale:"ド（高）",interval:"octave",intervalName:"オクターブ"}].map((t,n)=>{const r=o.find(s=>s.targetNote&&s.targetNote.includes(t.scale))||o[n];if(r&&r.accuracy!=="notMeasured"){const s=parseFloat(r.accuracy)||0,i=Math.round((100-s)*.5);return{type:t.interval,scale:t.scale,intervalName:t.intervalName,attempts:1,averageError:i,accuracy:s}}else return{type:t.interval,scale:t.scale,intervalName:t.intervalName,attempts:0,averageError:null,accuracy:0}})}function er(o){if(!o||!Array.isArray(o))return console.warn("⚠️ [RandomTraining] sessionHistory が無効です"),[];const e=[{type:"unison",scale:"ド",intervalName:"ユニゾン",noteIndex:0},{type:"major_second",scale:"レ",intervalName:"長2度",noteIndex:1},{type:"major_third",scale:"ミ",intervalName:"長3度",noteIndex:2},{type:"perfect_fourth",scale:"ファ",intervalName:"完全4度",noteIndex:3},{type:"perfect_fifth",scale:"ソ",intervalName:"完全5度",noteIndex:4},{type:"major_sixth",scale:"ラ",intervalName:"長6度",noteIndex:5},{type:"major_seventh",scale:"シ",intervalName:"長7度",noteIndex:6},{type:"octave",scale:"ド（高）",intervalName:"オクターブ",noteIndex:7}],t={};return e.forEach(n=>{t[n.type]={type:n.type,scale:n.scale,intervalName:n.intervalName,attempts:0,successCount:0,accuracySum:0,accuracyValues:[],errorValues:[]}}),o.forEach(n=>{!n.noteResults||!Array.isArray(n.noteResults)||n.noteResults.forEach((r,s)=>{if(s>=e.length)return;const i=e[s].type,m=t[i];if(m.attempts++,r.accuracy!=="notMeasured"&&typeof r.accuracy=="number"){m.accuracyValues.push(r.accuracy),m.accuracySum+=r.accuracy;const f=Math.round((100-r.accuracy)*.5);m.errorValues.push(f),r.accuracy>=70&&m.successCount++}})}),e.map(n=>{const r=t[n.type];if(r.attempts===0)return{type:n.type,scale:n.scale,intervalName:n.intervalName,attempts:0,averageError:null,accuracy:0};const s=r.accuracyValues.length>0?Math.round(r.accuracySum/r.accuracyValues.length):0,i=r.errorValues.length>0?Math.round(r.errorValues.reduce((f,c)=>f+c,0)/r.errorValues.length):null,m=r.accuracyValues.length>0?Math.round(r.successCount/r.accuracyValues.length*100):0;return{type:n.type,scale:n.scale,intervalName:n.intervalName,mastery:m,attempts:r.attempts,averageError:i,accuracy:s}})}function tr(o){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(o<=0)return"ーー";const n=Math.round(12*Math.log2(o/440)),r=(n+9+120)%12,s=Math.floor((n+9)/12)+4;return e[r]+s}function kt(o,e){const t=[{factor:4,freq:o*4,description:"2オクターブ上"},{factor:3,freq:o*3,description:"1.5オクターブ上"},{factor:2.5,freq:o*2.5,description:"1.3オクターブ上"},{factor:2,freq:o*2,description:"1オクターブ上"},{factor:1.5,freq:o*1.5,description:"0.5オクターブ上"},{factor:1,freq:o,description:"補正なし"},{factor:.75,freq:o*.75,description:"0.33オクターブ下"},{factor:.67,freq:o*.67,description:"0.5オクターブ下"},{factor:.5,freq:o*.5,description:"1オクターブ下"},{factor:.4,freq:o*.4,description:"1.3オクターブ下"},{factor:.33,freq:o*.33,description:"1.5オクターブ下"},{factor:.25,freq:o*.25,description:"2オクターブ下"}];let n=null,r=1/0;const s=e*.5,i=e*1.5,m=t.filter(f=>f.freq>=s&&f.freq<=i);for(const f of m){const c=Math.abs(f.freq-e);c<r&&(r=c,n=f)}if(!n)for(const f of t){const c=Math.abs(f.freq-e);c<r&&(r=c,n=f)}return n?{correctedFrequency:n.freq,factor:n.factor,description:n.description,error:r}:{correctedFrequency:o,factor:1,description:"補正なし（フォールバック）",error:Math.abs(o-e)}}function Ge(){try{"scrollTo"in window&&"behavior"in document.documentElement.style?window.scrollTo({top:0,behavior:"smooth"}):window.scrollTo(0,0),document.body&&(document.body.scrollTop=0),document.documentElement&&(document.documentElement.scrollTop=0),document.querySelectorAll("[data-scroll-container], .scroll-container, main").forEach(e=>{e.scrollTo?e.scrollTo(0,0):e.scrollTop=0})}catch(o){console.warn("スクロールエラー:",o);try{window.scroll(0,0)}catch(e){console.error("スクロール完全失敗:",e)}}}function nr(o){}function rr(o){console.error("❌ PitchDetectorエラー:",o.detail)}function sr(o,e,t){let n,r,s,i,m,f,c,u,p,d;we(o,bn,a=>t(23,n=a)),we(o,wn,a=>t(4,r=a)),we(o,Dn,a=>t(5,s=a)),we(o,dn,a=>t(53,i=a)),we(o,Cn,a=>t(54,m=a)),we(o,An,a=>t(55,f=a)),we(o,Tn,a=>t(56,c=a)),we(o,Mn,a=>t(24,u=a)),we(o,kn,a=>t(57,p=a)),we(o,In,a=>t(25,d=a));function S(a){return Oe.evaluateOverall(a)}let _="setup",C=typeof window<"u"?new URLSearchParams(window.location.search).get("from")==="microphone-test"?(te.info("[RandomTraining] マイクテストページからの遷移を検出"),"granted"):(te.info("[RandomTraining] ダイレクトアクセスを検出"),"checking"):"checking",M=!0,q=[];const Y=["ド","レ","ミ","ファ","ソ","ラ","シ","ド（高）"];let w="",b=0,V=!1,U=0,v=Y.map(a=>({name:a,state:"inactive",completed:!1})),I=null,R=!1,P=0,x=null,Q=!1,X=[],L=0,re=0,Se="ーー",se=null,de={totalScore:0,grade:"C",componentScores:{pitchAccuracy:0,recognitionSpeed:0,intervalMastery:0,directionAccuracy:0,consistency:0}},oe=[],he=[],Me={},Ne={},ke={totalAttempts:0,successRate:0,averageScore:0,bestScore:0,sessionDuration:0,streakCount:0,fatigueLevel:"fresh",mostDifficultInterval:"-",mostSuccessfulInterval:"-",averageResponseTime:0,sessionStart:Date.now()},K=[],ne=null,Ae=null,Fe=!0,ae=null,Re=null,We=null,Ye=null,Be=null;const qe=[{note:"C4",name:"ド（中）",frequency:261.63,semitonesFromC:0},{note:"Db4",name:"ド#（中）",frequency:277.18,semitonesFromC:1},{note:"D4",name:"レ（中）",frequency:293.66,semitonesFromC:2},{note:"Eb4",name:"レ#（中）",frequency:311.13,semitonesFromC:3},{note:"E4",name:"ミ（中）",frequency:329.63,semitonesFromC:4},{note:"F4",name:"ファ（中）",frequency:349.23,semitonesFromC:5},{note:"Gb4",name:"ファ#（中）",frequency:369.99,semitonesFromC:6},{note:"Ab4",name:"ラb（中）",frequency:415.3,semitonesFromC:8},{note:"Bb3",name:"シb（低）",frequency:233.08,semitonesFromC:-2},{note:"B3",name:"シ（低）",frequency:246.94,semitonesFromC:-1}];async function Pe(){var a;t(1,C="checking");try{if(console.log("🎤 [RandomTraining] AudioManager経由でマイク許可確認開始"),!((a=navigator.mediaDevices)!=null&&a.getUserMedia)){t(1,C="error");return}const l=await Ee.initialize();We=l.audioContext,Re=l.mediaStream,Ye=l.sourceNode,console.log("✅ [RandomTraining] AudioManager リソース取得完了"),t(1,C="granted"),t(0,_="setup"),setTimeout(async()=>{if(ae){te.audio("[RandomTraining] PitchDetector初期化開始");const y=/iPhone/.test(navigator.userAgent),D=/iPad/.test(navigator.userAgent),N=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document;(D||N)&&(console.log("🔧 [RandomTraining] iPad検出 - マイク感度7.0x自動設定開始"),Ee.setSensitivity(7),console.log("✅ [RandomTraining] iPad マイク感度7.0x自動設定完了"));try{console.log("🎤 [RandomTraining] AudioManager再初期化開始（iPad対応）"),await Ee.initialize(),console.log("✅ [RandomTraining] AudioManager再初期化完了")}catch(E){console.warn("⚠️ AudioManager再初期化エラー:",E)}await ae.initialize(),te.audio("[RandomTraining] PitchDetector初期化完了")}},200)}catch(l){te.error("[RandomTraining] マイク許可エラー:",l),t(1,C=(l==null?void 0:l.name)==="NotAllowedError"?"denied":"error")}}function Ze(){const a=c,l=f,y=qe.find(D=>D.note===a)||qe.find(D=>D.name===l)||qe[0];if(t(7,w=y.name),t(8,b=y.frequency),te.info(`[BaseNote] 基音設定（localStorage連携）: ${w} = ${b}Hz`),te.info(`[BaseNote] localStorage基音情報: note=${a}, name=${l}`),!b||b<=0)throw te.error("[BaseNote] 基音周波数設定エラー:",y),new Error(`Invalid base frequency: ${b}`)}async function Ft(){if(V||!Ae||Fe)return;if(C!=="granted"){console.log("🎤 [RandomTraining] マイク許可が必要です。許可取得を開始...");try{await Pe(),console.log("🎤 [RandomTraining] マイク許可取得完了")}catch(l){console.error("❌ マイク許可エラー:",l);return}}if(!Re&&C==="granted"){console.log("🎤 [RandomTraining] AudioManagerリソース未初期化のため取得します");try{await Pe()}catch(l){console.error("❌ AudioManagerリソース初期化エラー:",l);return}}else Re&&console.log("🎤 [RandomTraining] AudioManagerリソース既存のため再利用");t(9,V=!0),t(0,_="listening"),Be=Date.now(),Ze();const a=qe.find(l=>l.name===w).note;Ae.triggerAttackRelease(a,2,it(),.7),setTimeout(()=>{t(9,V=!1),t(0,_="waiting"),setTimeout(()=>et(),500)},2e3)}async function Et(){if(V||!Ae||d||!w)return;if(C!=="granted"){console.log("🎤 [RandomTraining] マイク許可が必要です。許可取得を開始...");try{await Pe(),console.log("🎤 [RandomTraining] マイク許可取得完了")}catch(l){console.error("❌ マイク許可エラー:",l);return}}if(!Re&&C==="granted"){console.log("🎤 [RandomTraining] AudioManagerリソース未初期化のため取得します");try{await Pe()}catch(l){console.error("❌ AudioManagerリソース初期化エラー:",l);return}}else Re&&console.log("🎤 [RandomTraining] AudioManagerリソース既存のため再利用");if(t(9,V=!0),t(0,_="listening"),Be=Date.now(),typeof window<"u"&&window.Tone){const l=window.Tone.context||window.Tone.getContext();l&&l.state==="suspended"&&(console.log("🔄 [RandomTraining] AudioContext suspended検出 - 再開中..."),await l.resume(),console.log("✅ [RandomTraining] AudioContext再開完了"))}const a=qe.find(l=>l.name===w).note;Ae.triggerAttackRelease(a,2,it(),.7),setTimeout(()=>{t(9,V=!1),t(0,_="waiting"),setTimeout(()=>et(),500)},2e3)}function $t(){w&&b>0?Et():Ft(),qt()}function qt(){x&&clearInterval(x),t(11,P=0),t(12,Q=!1),console.log("🎵 [GuideStartBar] ガイドスタートバー開始"),x=setInterval(()=>{t(11,P+=2.5),P>=100&&(t(11,P=100),t(12,Q=!0),console.log("🎵 [GuideStartBar] ガイド開始タイミング！"),setTimeout(()=>{t(12,Q=!1),t(11,P=0)},800),clearInterval(x),x=null)},50)}function Le(a,l){const D=[0,2,4,5,7,9,11,12][l],N=a*Math.pow(2,D/12);return te.debug(`[calculateExpectedFrequency] ${v[l].name}: 基音${a.toFixed(1)}Hz + ${D}半音 = ${N.toFixed(1)}Hz`),N}function Pt(a,l){return Le(a,l)}function et(){t(0,_="guiding"),U=0,R=!0,X=[],console.log(`🎬 ガイド開始: ${w} (${b.toFixed(1)}Hz)`);function a(){if(U<v.length){U>0&&t(10,v[U-1].state="inactive",v),t(10,v[U].state="active",v);const l=Pt(b,U);ct.setScaleContext({baseFrequency:b,currentScale:v[U].name,targetFrequency:l}),console.log(`🎵 [Scale] 基音:${w}(${b.toFixed(0)}Hz) 現在:${v[U].name} 目標:${l.toFixed(0)}Hz`),U>=4&&console.log(`🔍 [デバッグ] Step ${U}: currentBaseFrequency=${b}, currentBaseNote='${w}'`),U++,I=setTimeout(()=>{a()},600)}else xt()}a()}function xt(){R=!1,console.log(`🏁 ガイド完了: ${X.length}/${v.length}ステップ評価`),v.length>0&&t(10,v[v.length-1].state="inactive",v),ae&&ae.stopDetection(),ct.clearContext(),Vt(),jt(),K=Y.map(a=>{const l=X.find(y=>y.stepName===a);return l?{name:l.stepName,cents:l.adjustedFrequency?Math.round(l.centDifference):null,targetFreq:l.expectedFrequency,detectedFreq:l.adjustedFrequency||null,diff:l.adjustedFrequency?l.adjustedFrequency-l.expectedFrequency:null,accuracy:l.accuracy}:{name:a,cents:null,targetFreq:null,detectedFreq:null,diff:null,accuracy:"notMeasured"}}),Gt(),Qt(),t(0,_="results")}function Vt(){let a=0,l=0;X.forEach((N,E)=>{N.isCorrect&&a++,l+=N.accuracy});const y=X.length>0?Math.round(l/X.length):0,D=Math.round(a/v.length*100);v.length,console.log(`🎯 結果: ${a}/${v.length}正解 (${D}%) 平均精度${y}%`),X.length>0&&[...X]}function Ht(){at(`${Je}/microphone-test`)}function ze(){at(`${Je}/`)}async function Bt(){try{t(33,Fe=!0),t(32,Ae=new vn({urls:{C4:"C4.mp3"},baseUrl:`${Je}/audio/piano/`,release:1.5,volume:Zn(),onload:()=>{t(33,Fe=!1)},onerror:N=>{console.error("❌ Salamander Piano音源読み込みエラー:",N),t(33,Fe=!1)}}).toDestination());const a=/iPhone/.test(navigator.userAgent),l=/iPad/.test(navigator.userAgent),y=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document,D=a||l||y;console.log(l?"🔍 [RandomTraining] iPad検出:":y?"🔍 [RandomTraining] iPadOS検出:":a?"🔍 [RandomTraining] iPhone検出:":"🔍 [RandomTraining] その他デバイス検出:",navigator.userAgent),console.log("🔊 [RandomTraining] 音量設定維持: 35dB")}catch(a){console.error("サンプラー初期化エラー:",a),t(33,Fe=!1)}}async function Qe(){try{(await navigator.permissions.query({name:"microphone"})).state==="granted"?await Pe():t(1,C="denied")}catch{t(1,C="denied")}}function Lt(){try{se=new yn,te.info("[RandomTraining] 採点エンジン初期化完了")}catch(a){te.error("[RandomTraining] 採点エンジン初期化エラー:",a)}}function zt(a,l){if(!se||!R)return;const y=U-1;if(y<0||y>=v.length)return;const D=Le(b,y),N={baseFrequency:b,targetFrequency:D,detectedFrequency:a,detectedNote:l,volume:L,timestamp:Date.now(),scaleIndex:y,scaleName:v[y].name};try{se.processAttempt(N)}catch(E){te.error("[RandomTraining] 採点エンジンエラー:",E)}}function jt(){if(!se){te.error("[RandomTraining] 採点エンジンが初期化されていません"),Ot();return}try{const a=se.generateDetailedReport();t(16,de={totalScore:a.totalScore,grade:a.grade,componentScores:a.componentScores}),a.intervalAnalysis&&a.intervalAnalysis.masteryLevels?t(3,oe=Object.entries(a.intervalAnalysis.masteryLevels).map(([l,y])=>{var D,N;return{type:l,mastery:Math.round(y),attempts:((D=a.intervalAnalysis.attemptCounts)==null?void 0:D[l])||0,accuracy:((N=a.intervalAnalysis.accuracyRates)==null?void 0:N[l])||0}})):(console.warn("⚠️ [RandomTraining] intervalAnalysis.masteryLevels が未定義です"),t(3,oe=[])),a.consistencyHistory&&Array.isArray(a.consistencyHistory)?t(17,he=a.consistencyHistory.map((l,y)=>({score:Math.round(l),timestamp:Date.now()-(a.consistencyHistory.length-y)*1e3}))):(console.warn("⚠️ [RandomTraining] consistencyHistory が未定義または配列ではありません"),t(17,he=[])),t(18,Me=a.feedback||{primary:"採点結果を生成中です...",detailed:[],suggestions:[]}),t(20,ke={totalAttempts:a.totalAttempts||0,successRate:a.successRate||0,averageScore:a.totalScore||0,bestScore:Math.max(a.totalScore||0,ke.bestScore||0),sessionDuration:Math.round((Date.now()-ke.sessionStart)/6e4)||0,streakCount:a.streak||0,fatigueLevel:a.fatigueLevel||"normal",mostDifficultInterval:a.mostDifficultInterval||"-",mostSuccessfulInterval:a.mostSuccessfulInterval||"-",averageResponseTime:a.averageResponseTime||0}),te.info("[RandomTraining] 採点結果生成完了:",de)}catch(a){te.error("[RandomTraining] 採点結果生成エラー:",a)}}function Ot(){te.info("[RandomTraining] テストデータで採点結果を生成"),t(16,de={totalScore:78,grade:"B+",componentScores:{pitchAccuracy:82,recognitionSpeed:75,intervalMastery:80,directionAccuracy:85,consistency:70}}),t(3,oe=[{type:"unison",mastery:95,attempts:8,accuracy:98},{type:"major_second",mastery:82,attempts:8,accuracy:85},{type:"major_third",mastery:78,attempts:8,accuracy:80},{type:"perfect_fourth",mastery:65,attempts:8,accuracy:68},{type:"perfect_fifth",mastery:88,attempts:8,accuracy:90},{type:"major_sixth",mastery:72,attempts:8,accuracy:75},{type:"major_seventh",mastery:58,attempts:8,accuracy:62},{type:"octave",mastery:92,attempts:8,accuracy:94}]),t(17,he=[{score:65,timestamp:Date.now()-42e4},{score:72,timestamp:Date.now()-36e4},{score:68,timestamp:Date.now()-3e5},{score:75,timestamp:Date.now()-24e4},{score:78,timestamp:Date.now()-18e4},{score:82,timestamp:Date.now()-12e4},{score:80,timestamp:Date.now()-6e4},{score:85,timestamp:Date.now()}]),t(18,Me={type:"improvement",primary:"良い進歩が見られます！",summary:"音程の認識精度が向上しています。特に完全5度とオクターブの習得度が高く、基本的な音感が身についてきています。",details:[{category:"strengths",text:"ユニゾンとオクターブの認識がほぼ完璧です"},{category:"strengths",text:"完全5度の安定性が優秀です"},{category:"improvements",text:"完全4度の練習をもう少し増やしましょう"},{category:"improvements",text:"長7度の認識精度を向上させましょう"},{category:"tips",text:"4度は「ソーファー」の音程です"},{category:"practice",text:"毎日15分の継続練習を心がけましょう"}],nextSteps:["完全4度の集中練習を行いましょう","連続チャレンジモードで実践練習を","1日15分の継続練習を心がけましょう"],motivation:"継続は力なり！あなたの相対音感は確実に向上しています！"}),t(20,ke={totalAttempts:32,successRate:68.8,averageScore:78,bestScore:85,sessionDuration:8,streakCount:4,fatigueLevel:"normal",mostDifficultInterval:"完全4度",mostSuccessfulInterval:"ユニゾン",averageResponseTime:2.1,sessionStart:Date.now()-48e4}),te.info("[RandomTraining] テスト採点結果生成完了")}function Gt(){if(!K||K.length===0){console.warn("[UnifiedScore] noteResultsForDisplay が空です");return}const a=K.filter(J=>J.accuracy!=="notMeasured").length,l=K.length,y=K.filter(J=>J.accuracy!=="notMeasured"&&typeof J.accuracy=="number").map(J=>J.accuracy),D=y.length>0?Math.round(y.reduce((J,be)=>J+be,0)/y.length):0,N=w||"Unknown",E=b||0,Z=K.map(J=>({name:J.name,note:J.note||J.name,frequency:J.targetFreq||J.expectedFrequency,detectedFrequency:J.detectedFreq,cents:J.cents,grade:Oe.evaluateNote(J.cents),targetFreq:J.targetFreq,diff:J.diff})),ee=p,W=(ee==null?void 0:ee.sessionHistory)||[],ve={timestamp:new Date,baseNote:N,baseFrequency:E,noteResults:Z,measuredNotes:a,accuracy:D,grade:Oe.evaluateSession(K)},Te=[...W,ve];t(21,ne={mode:"continuous",timestamp:new Date,duration:60,totalNotes:l,measuredNotes:a,averageAccuracy:D,baseNote:N,baseFrequency:E,noteResults:Z,distribution:Oe.calculateDistribution(K),sessionHistory:Te,unifiedGrade:S(Te)}),console.log("[UnifiedScore] 統合採点データ生成完了（完全版）:",ne),Ut()}async function Ut(){if(!K||K.length===0){console.warn("📊 [SessionStorage] 保存データなし");return}try{console.log("📊 [SessionStorage] セッション結果保存開始");const a=K.map(E=>({name:E.name,cents:E.cents,targetFreq:E.targetFreq||E.expectedFrequency,detectedFreq:E.detectedFreq,diff:E.diff,accuracy:typeof E.accuracy=="number"?E.accuracy:0})),l=Be?Math.round((Date.now()-Be)/1e3):60;await Sn(a,l,c,f)?(console.log("📊 [SessionStorage] セッション結果保存完了"),console.log("📊 [SessionStorage] 保存後の状況:",{currentSession:n,totalSessions:u.length,isCompleted:s,nextBaseNote:c,nextBaseName:f})):console.error("📊 [SessionStorage] セッション結果保存失敗")}catch(a){console.error("📊 [SessionStorage] セッション保存エラー:",a)}}async function Qt(){try{if(se){const a=u||[];for(const[y,D]of a.entries())if(D.noteResults&&D.noteResults.length>0){const N=D.baseFrequency||262;for(const E of D.noteResults)E.detectedFreq&&E.targetFreq&&await se.analyzePerformance({baseFreq:N,targetFreq:E.targetFreq,detectedFreq:E.detectedFreq,responseTime:2e3,volume:50,harmonicCorrection:null})}const l=se.generateDetailedReport();t(16,de={totalScore:l.totalScore||0,grade:l.grade||"C",componentScores:l.componentScores||{accuracy:0,speed:0,consistency:0}}),l.intervalAnalysis&&l.intervalAnalysis.masteryLevels?t(3,oe=Object.entries(l.intervalAnalysis.masteryLevels).map(([y,D])=>{var N;return{type:y,mastery:Math.round(D),attempts:((N=l.intervalAnalysis.attemptCounts)==null?void 0:N[y])||0,accuracy:Math.round(D*.9)}})):t(3,oe=Mt(K)),l.consistencyHistory&&Array.isArray(l.consistencyHistory)?t(17,he=l.consistencyHistory.map((y,D)=>({score:Math.round(y),timestamp:Date.now()-(l.consistencyHistory.length-D)*1e3}))):t(17,he=nt(K)),t(18,Me=rt(K)||l.feedback),console.log("🎯 [generateEnhancedScoringData] 技術分析結果生成を開始"),console.log("🎯 [generateEnhancedScoringData] results:",l),t(19,Ne=Xt(l)),console.log("🎯 [generateEnhancedScoringData] technicalFeedbackData結果:",Ne),t(20,ke={totalAttempts:l.totalAttempts||K.length,successRate:l.successRate||K.filter(y=>y.accuracy!=="notMeasured").length/K.length*100,averageScore:l.totalScore||(ne==null?void 0:ne.averageAccuracy)||0,bestScore:Math.max(l.totalScore||0,ke.bestScore||0),sessionDuration:Math.round(60),streakCount:l.streak||0,fatigueLevel:l.fatigueLevel||"normal",mostDifficultInterval:l.mostDifficultInterval||"未特定",mostSuccessfulInterval:l.mostSuccessfulInterval||"未特定",averageResponseTime:l.averageResponseTime||2.5,sessionStart:Date.now()-6e4})}else tt();console.log("[EnhancedScoring] 追加採点データ生成完了")}catch(a){console.error("[EnhancedScoring] データ生成エラー:",a),tt()}}function tt(){const a=K.filter(y=>y.accuracy!=="notMeasured"),l=(ne==null?void 0:ne.averageAccuracy)||0;t(16,de={totalScore:Math.round(l*.8),grade:l>=90?"A":l>=80?"B":l>=70?"C":"D",componentScores:{accuracy:l,speed:85,consistency:Math.max(60,l-10)}}),t(3,oe=Mt(K)),t(17,he=nt()),t(18,Me=rt(K)),t(20,ke={totalAttempts:K.length,successRate:a.length/K.length*100,averageScore:l,bestScore:l,sessionDuration:60,streakCount:0,fatigueLevel:"normal",mostDifficultInterval:"未分析",mostSuccessfulInterval:"未分析",averageResponseTime:2.5,sessionStart:Date.now()-6e4})}function nt(a){const l=(ne==null?void 0:ne.averageAccuracy)||70;return Array.from({length:8},(y,D)=>({score:Math.max(30,Math.min(100,l+(Math.random()-.5)*20)),timestamp:Date.now()-(8-D)*7500}))}function rt(a){const l=a.filter(Ve=>Ve.accuracy!=="notMeasured").length,y=(ne==null?void 0:ne.averageAccuracy)||0,D=8,N=u||[],E=N.length,Z={type:"info",categories:[{name:"音程精度",icon:"Target",score:y,message:`${y}%の精度で音程を捉えています`},{name:"測定成功率",icon:"Mic",score:Math.round(l/a.length*100),message:`${a.length}音中${l}音を正常に測定`}]};if(E<D)return Z;let ee,W,ve;const Te=(ne==null?void 0:ne.unifiedGrade)||"E",J=N.length;let be=0,fe=0,me=0;N.forEach(Ve=>{Ve.grade==="excellent"?be++:Ve.grade==="good"?fe++:Ve.grade==="pass"&&me++});const ge=J>0?Math.round(be/J*100):0,xe=J>0?Math.round((be+fe+me)/J*100):0,ye=J>0?Math.round((be+fe+me)/J*100):0;switch(Te){case"S":ee="excellent",W="音楽家レベルの相対音感を達成！",ve=`優秀率${ge}%超えの実力を証明されました。`;break;case"A":ee="excellent",W="エキスパートレベル到達！",ve=`優秀率${ge}%の安定した音感能力です。`;break;case"B":ee="improvement",W="プロフィシエント級達成！",ve=`良好率${xe}%の確実な進歩を示しています。`;break;case"C":ee="improvement",W="アドバンス級到達！",ve=`合格率${ye}%で着実に成長中です。`;break;case"D":ee="practice",W="継続練習で必ず上達！",ve=`現在の合格率${ye}%から目標70%へ向けて練習を続けましょう。`;break;case"E":default:ee="encouragement",W="E級ビギナー",ve="練習開始段階です。継続的な練習で必ず上達します。";break}return{...Z,type:ee,primary:W,summary:ve}}function Xt(a){var Te,J,be;if((u||[]).length<8||!a)return null;const N=a.improvements||[];(Te=a.detailed)!=null&&Te.statistics;const E=[];let Z=0,ee=0;if((J=a.detailed)!=null&&J.intervals){const fe=a.detailed.intervals;if(fe.totalAnalyses>0){let me=0,ge=0;for(const[xe,ye]of Object.entries(fe.masteryLevels))ye.attempts>0&&(me+=ye.averageAccuracy*ye.attempts,ge+=ye.attempts);Z=ge>0?me/ge:0}}if((be=a.detailed)!=null&&be.directions){const fe=a.detailed.directions;if(fe.totalAnalyses>0){let me=0,ge=0;for(const[xe,ye]of Object.entries(fe.masteryData))ye.attempts>0&&(me+=ye.averageAccuracy*ye.attempts,ge+=ye.attempts);ee=ge>0?me/ge:0}}E.push({category:"improvements",text:`音程精度: ${Math.round(Z)}%　（音の高さを捉える正確性　目標基準：70〜85%）`}),E.push({category:"improvements",text:`方向性: ${Math.round(ee)}%　（音程の上下判断の精度　目標基準：80〜90%）`});const W=N.map(fe=>({category:"tips",text:fe.message})),ve=N.flatMap(fe=>(fe.actions||[]).map(me=>({category:"practice",text:me})));return[...E,...W,...ve],{type:"info",primary:"詳細分析結果",summary:"音程精度・一貫性・方向性の総合分析",details:E}}un(async()=>{if(!(typeof localStorage<"u"?localStorage.getItem("mic-test-completed"):null)){console.log("🚫 [RandomTraining] マイクテスト未完了 - 準備画面表示"),Qe();return}console.log("📊 [SessionStorage] セッション管理初期化開始");try{if(await lt()){if(console.log("📊 [SessionStorage] セッション進行状況の読み込み完了"),console.log("📊 [SessionStorage] 現在のセッション:",n,"/ 8"),console.log("📊 [SessionStorage] 次の基音:",c,"(",f,")"),console.log("📊 [SessionStorage] 完了状況:",s?"8セッション完了":`残り${m}セッション`),s&&(console.log("🔄 [SessionStorage] 8セッション完了検出 - 新サイクル開始処理"),await je()?console.log("✅ [SessionStorage] 新サイクル開始完了 - セッション1/8から再開"):console.warn("⚠️ [SessionStorage] 新サイクル開始処理が失敗")),n>1&&!s){console.warn("🔄 [SessionStorage] セッション途中でのリロード検出 - セッション1から再開"),console.warn("🔄 [SessionStorage] 現在:",n,"セッション目 → ダイレクトアクセス誘導");const{SessionStorageManager:y}=await st(async()=>{const{SessionStorageManager:E}=await import("../chunks/COGgd1ld.js").then(Z=>Z.h);return{SessionStorageManager:E}},__vite__mapDeps([0,1,2,3,4,5]),import.meta.url),D=y.getInstance();typeof localStorage<"u"&&(localStorage.removeItem("random-training-progress"),localStorage.removeItem("random-training-progress-backup"));const{resetProgress:N}=await st(async()=>{const{resetProgress:E}=await import("../chunks/COGgd1ld.js").then(Z=>Z.j);return{resetProgress:E}},__vite__mapDeps([0,1,2,3,4,5]),import.meta.url);await N(),console.log("🔄 [SessionStorage] localStorage + ストア状態完全リセット完了"),Qe();return}}else console.log("📊 [SessionStorage] 新規セッション開始")}catch(l){console.error("📊 [SessionStorage] 初期化エラー:",l)}if(Bt(),Lt(),i.url.searchParams.get("from")==="microphone-test"){console.log("🎤 [RandomTraining] マイクテストページからの遷移を検出");const l=new URL(window.location);if(l.searchParams.delete("from"),window.history.replaceState({},"",l),t(1,C="granted"),t(0,_="setup"),console.log('🎤 [RandomTraining] microphoneState="granted", trainingPhase="setup" に設定'),!Re){console.log("🎤 [RandomTraining] AudioManagerリソース取得開始");try{const y=await Ee.initialize();We=y.audioContext,Re=y.mediaStream,Ye=y.sourceNode,console.log("🎤 [RandomTraining] AudioManagerリソース取得完了")}catch(y){console.warn("⚠️ AudioManagerリソース取得失敗（後で再試行）:",y)}}if(await new Promise(y=>setTimeout(y,300)),ae&&ae.getIsInitialized&&!ae.getIsInitialized())try{console.log("🎙️ [RandomTraining] PitchDetector初期化開始");const y=Ee.getStatus();console.log("🔍 [RandomTraining] AudioManager状態:",y),(!y.isInitialized||!y.mediaStreamActive)&&(console.log("🔄 [RandomTraining] AudioManager状態不良 - 再初期化実行"),await Ee.initialize()),await ae.initialize(),console.log("✅ [RandomTraining] PitchDetector初期化完了")}catch(y){console.warn("⚠️ PitchDetector初期化失敗:",y)}}else await new Promise(l=>setTimeout(l,100)),Qe()});function Jt(a){const{frequency:l,note:y,volume:D,rawVolume:N,clarity:E}=a.detail;let Z=l,ee=y;if(_==="guiding"&&R&&b>0&&l>0){const W=Kt(l);W&&(Z=W.frequency,ee=W.note)}t(14,re=Z),t(15,Se=ee),t(13,L=D),Wt(l),se&&l>0&&b>0&&zt(l,y)}function Kt(a){if(!a||a<=0||!R||!b||L<25)return null;const y=U-1;if(y<0||y>=v.length)return null;const D=Le(b,y);if(!D||D<=0)return null;const E=kt(a,D).correctedFrequency,Z=tr(E);return{frequency:Math.round(E),note:Z}}function Wt(a,l){if(!a||a<=0||!R)return;if(!b||b<=0){console.error(`❌ [採点エラー] 基音周波数が無効: ${b}Hz`),console.error(`❌ [採点エラー] 基音名: ${w}`),console.error(`❌ [採点エラー] activeStepIndex: ${U-1}`),console.error(`❌ [採点エラー] trainingPhase: ${_}`),console.error(`❌ [採点エラー] isGuideAnimationActive: ${R}`);return}if(L<25)return;const D=U-1;if(D<0||D>=v.length)return;D>=4&&te.debug(`[採点デバッグ] activeStepIndex=${D} (${v[D].name}), currentBaseFrequency=${b}Hz`);const N=Le(b,D);if(D>=0&&te.debug(`[音程計算修正版] ${v[D].name}: 期待周波数 ${N.toFixed(1)}Hz`),!N||N<=0||!isFinite(N)){console.error("❌ [採点エラー] 期待周波数計算エラー:"),console.error(`   基音周波数: ${b}Hz`),console.error(`   音階インデックス: ${D}`),console.error(`   期待周波数: ${N}Hz`);return}const E=kt(a,N),Z=E.correctedFrequency,ee=E.factor,W=Math.round(1200*Math.log2(Z/N));if((Math.abs(W)>200||ee!==1)&&(te.debug(`[プロトタイプ式補正] ${v[D].name}:`),console.warn(`   検出周波数: ${a.toFixed(1)}Hz`),console.warn(`   補正後周波数: ${Z.toFixed(1)}Hz`),console.warn(`   期待周波数: ${N.toFixed(1)}Hz`),console.warn(`   セント差: ${W}¢`),console.warn(`   補正係数: ${ee} (${E.description})`),console.warn(`   基音: ${w} (${b.toFixed(1)}Hz)`)),!isFinite(W)){console.error("❌ [採点エラー] セント計算エラー:"),console.error(`   検出周波数: ${a}Hz`),console.error(`   期待周波数: ${N}Hz`),console.error(`   セント差: ${W}`);return}const Te=Math.abs(W)<=50;if(L>=15){const fe=Math.max(0,Math.round(100-Math.abs(W))),me=X.findIndex(xe=>xe.stepIndex===D),ge={stepIndex:D,stepName:v[D].name,expectedFrequency:Math.round(N),detectedFrequency:Math.round(a),adjustedFrequency:Math.round(Z),centDifference:W,accuracy:fe,isCorrect:Te,correctionFactor:ee,correctionDescription:E.description,timestamp:Date.now()};me>=0?X[me]=ge:X.push(ge),X.length%4===0&&te.realtime(`採点進捗: ${X.length}/${v.length}ステップ完了`)}}async function Yt(){if(s){console.warn("🚫 [RestartSame] 8セッション完了状態では再挑戦不可 - 新サイクル開始が必要"),await je()?(console.log("✅ [RestartSame] 新サイクル開始完了 - セッション1/8から再開"),window.location.reload()):console.error("❌ [RestartSame] 新サイクル開始失敗");return}Ge(),t(0,_="setup"),I&&(clearTimeout(I),I=null),ae&&ae.resetDisplayState&&ae.resetDisplayState(),Xe(),console.log("🔄 [RestartSame] 同じ基音で再挑戦:",w,b+"Hz"),console.log("🔄 [RestartSame] 基音情報保持完了 - ユーザー操作待機")}async function Zt(){if(s){console.warn("🚫 [RestartDifferent] 8セッション完了状態では再挑戦不可 - 新サイクル開始が必要"),await je()?(console.log("✅ [RestartDifferent] 新サイクル開始完了 - セッション1/8から再開"),window.location.reload()):console.error("❌ [RestartDifferent] 新サイクル開始失敗");return}Ge(),t(0,_="setup"),I&&(clearTimeout(I),I=null),t(7,w=""),t(8,b=0),console.log("🔄 [restartDifferentBaseNote] 基音情報をリセットしました"),ae&&ae.resetDisplayState&&ae.resetDisplayState(),Xe()}function Xe(){U=0,R=!1,X=[],t(10,v=v.map(a=>({...a,state:"inactive",completed:!1})))}async function en(){console.log("🚀 [StartNewCycle] 8セッション完了後の最初から挑戦開始");try{await je()?(console.log("✅ [StartNewCycle] 新サイクル開始完了"),localStorage.getItem("mic-test-completed")?(console.log("✅ [StartNewCycle] マイクテスト完了フラグ確認 - リロードなしで状態リセット"),Ge(),await lt(),t(0,_="setup"),Xe(),Ze(),console.log("✅ [StartNewCycle] 状態リセット完了 - セッション1/8から再開")):window.location.reload()):(console.error("❌ [StartNewCycle] 新サイクル開始失敗"),ze())}catch(a){console.error("❌ [StartNewCycle] 新サイクル開始エラー:",a),ze()}}function tn(a){const{type:l}=a.detail;switch(l){case"same":Yt();break;case"different":Zt();break;case"restart":en();break;case"home":ze();break;default:console.warn("🚫 [ActionButtons] 未知のアクションタイプ:",l)}}function nn(){console.log("⚡ [ContinuousMode] 8セッション連続開始"),$t()}function rn(a){const{healthy:l,errors:y,details:D}=a.detail;t(2,M=l),t(6,q=y),l||(console.warn("⚠️ マイクの健康状態が悪化:",y),_==="guiding"&&(t(0,_="setup"),console.warn("🛑 マイク問題によりトレーニングを停止")))}fn(()=>{console.log("🔄 [RandomTraining] onDestroy - AudioManagerリソースは保持"),Ae&&(Ae.dispose(),t(32,Ae=null))});function sn(a){mn[a?"unshift":"push"](()=>{ae=a,t(22,ae)})}return o.$$.update=()=>{o.$$.dirty[0]&6|o.$$.dirty[1]&6,o.$$.dirty[0]&1,o.$$.dirty[0]&56&&r&&s&&r.sessionHistory&&(t(3,oe=er(r.sessionHistory)),console.log("🎵 [RandomTraining] intervalData生成完了:",oe.length,"件")),o.$$.dirty[0]&3&&_==="setup"&&C==="granted"&&Ge()},[_,C,M,oe,r,s,q,w,b,V,v,P,Q,L,re,Se,de,he,Me,Ne,ke,ne,ae,n,u,d,Ht,ze,Jt,tn,nn,rn,Ae,Fe,sn]}class hr extends on{constructor(e){super(),an(this,e,sr,Yn,cn,{},null,[-1,-1,-1,-1])}}export{hr as component,pr as universal};
