import{S as Ue,i as $e,s as qe,d as u,C as pe,m as he,o as me,b as M,D as ve,I as Le,h as w,E as be,k as P,F as _e,l as je,M as Be,c as a,y as r,K as ze,e as p,f as E,G as N,j as h,R as Ae,Q as Fe,L as He,a as de,T as fe,A as L,g as H,t as O,r as Ne,n as we}from"../chunks/BJp-dNlk.js";import"../chunks/IHki7fMi.js";import{p as Oe}from"../chunks/te9iU-xc.js";import{g as Ge,b as Re}from"../chunks/DglCqkVh.js";import{P as Ke,C as Qe}from"../chunks/DZHPMXgl.js";import{P as Ze,a as Je,b as We}from"../chunks/CxK6ScYN.js";const Xe=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global,{document:Se}=Xe;function Ye(n){let e,t="マイクのテストを開始します",c,s,i="マイクテスト開始ボタンを押してマイクの使用を許可してください",o,f;function y(l,m){if(l[0]==="pending")return lt;if(l[0]==="denied")return st;if(l[0]==="initial")return tt}let T=y(n),d=T&&T(n);return{c(){e=h("h3"),e.textContent=t,c=P(),s=h("p"),s.textContent=i,o=P(),d&&d.c(),f=Ne(),this.h()},l(l){e=p(l,"H3",{class:!0,"data-svelte-h":!0}),N(e)!=="svelte-gfi16f"&&(e.textContent=t),c=w(l),s=p(l,"P",{class:!0,"data-svelte-h":!0}),N(s)!=="svelte-1w19y1h"&&(s.textContent=i),o=w(l),d&&d.l(l),f=Ne(),this.h()},h(){r(e,"class","instructions-title svelte-1ctbylb"),r(s,"class","instructions-description svelte-1ctbylb")},m(l,m){M(l,e,m),M(l,c,m),M(l,s,m),M(l,o,m),d&&d.m(l,m),M(l,f,m)},p(l,m){T===(T=y(l))&&d?d.p(l,m):(d&&d.d(1),d=T&&T(l),d&&(d.c(),d.m(f.parentNode,f)))},d(l){l&&(u(e),u(c),u(s),u(o),u(f)),d&&d.d(l)}}}function et(n){let e,t="マイク準備完了",c,s,i="音量を調整してからトレーニングを開始してください",o,f,y,T,d,l,m,k,v,g,U,V,x,j,se="-20dB",Y,I,ee,z,le="+10dB",te,$,G=n[7]?"再生中...":"ド(C4)を再生",b,D,B,S,ne,Z=n[6].toFixed(1)+"",oe,ge,ye,q,R,Pe="0.1x",Te,A,Ce,K,De="3.0x",ie,Q,F,Ee="トレーニング開始",Me,ke;return{c(){e=h("h3"),e.textContent=t,c=P(),s=h("p"),s.textContent=i,o=P(),f=h("div"),y=h("span"),T=O(n[8]),d=P(),l=h("div"),m=h("div"),k=h("label"),v=O("基音音量: "),g=O(n[5]),U=O("dB"),V=P(),x=h("div"),j=h("span"),j.textContent=se,Y=P(),I=h("input"),ee=P(),z=h("span"),z.textContent=le,te=P(),$=h("button"),b=O(G),D=P(),B=h("div"),S=h("label"),ne=O("マイク感度: "),oe=O(Z),ge=O("x"),ye=P(),q=h("div"),R=h("span"),R.textContent=Pe,Te=P(),A=h("input"),Ce=P(),K=h("span"),K.textContent=De,ie=P(),Q=h("div"),F=h("button"),F.textContent=Ee,this.h()},l(_){e=p(_,"H3",{class:!0,"data-svelte-h":!0}),N(e)!=="svelte-11dam81"&&(e.textContent=t),c=w(_),s=p(_,"P",{class:!0,"data-svelte-h":!0}),N(s)!=="svelte-1pr7rqg"&&(s.textContent=i),o=w(_),f=p(_,"DIV",{class:!0});var C=E(f);y=p(C,"SPAN",{class:!0});var Ie=E(y);T=H(Ie,n[8]),Ie.forEach(u),C.forEach(u),d=w(_),l=p(_,"DIV",{class:!0});var ae=E(l);m=p(ae,"DIV",{class:!0});var J=E(m);k=p(J,"LABEL",{class:!0});var re=E(k);v=H(re,"基音音量: "),g=H(re,n[5]),U=H(re,"dB"),re.forEach(u),V=w(J),x=p(J,"DIV",{class:!0});var W=E(x);j=p(W,"SPAN",{class:!0,"data-svelte-h":!0}),N(j)!=="svelte-5u5ai6"&&(j.textContent=se),Y=w(W),I=p(W,"INPUT",{type:!0,min:!0,max:!0,step:!0,class:!0}),ee=w(W),z=p(W,"SPAN",{class:!0,"data-svelte-h":!0}),N(z)!=="svelte-ptz1f5"&&(z.textContent=le),W.forEach(u),te=w(J),$=p(J,"BUTTON",{class:!0});var xe=E($);b=H(xe,G),xe.forEach(u),J.forEach(u),D=w(ae),B=p(ae,"DIV",{class:!0});var ce=E(B);S=p(ce,"LABEL",{class:!0});var ue=E(S);ne=H(ue,"マイク感度: "),oe=H(ue,Z),ge=H(ue,"x"),ue.forEach(u),ye=w(ce),q=p(ce,"DIV",{class:!0});var X=E(q);R=p(X,"SPAN",{class:!0,"data-svelte-h":!0}),N(R)!=="svelte-1m4xt2o"&&(R.textContent=Pe),Te=w(X),A=p(X,"INPUT",{type:!0,min:!0,max:!0,step:!0,class:!0}),Ce=w(X),K=p(X,"SPAN",{class:!0,"data-svelte-h":!0}),N(K)!=="svelte-c9vjc8"&&(K.textContent=De),X.forEach(u),ce.forEach(u),ae.forEach(u),ie=w(_),Q=p(_,"DIV",{class:!0});var Ve=E(Q);F=p(Ve,"BUTTON",{class:!0,"data-svelte-h":!0}),N(F)!=="svelte-kae9rs"&&(F.textContent=Ee),Ve.forEach(u),this.h()},h(){r(e,"class","ready-title svelte-1ctbylb"),r(s,"class","ready-description svelte-1ctbylb"),r(y,"class","device-label svelte-1ctbylb"),r(f,"class","device-info svelte-1ctbylb"),r(k,"class","volume-label svelte-1ctbylb"),r(j,"class","slider-min svelte-1ctbylb"),r(I,"type","range"),r(I,"min","-20"),r(I,"max","10"),r(I,"step","1"),r(I,"class","volume-slider svelte-1ctbylb"),r(z,"class","slider-max svelte-1ctbylb"),r(x,"class","volume-slider-container svelte-1ctbylb"),r($,"class","base-tone-test-button svelte-1ctbylb"),$.disabled=n[7],r(m,"class","volume-control-section svelte-1ctbylb"),r(S,"class","volume-label svelte-1ctbylb"),r(R,"class","slider-min svelte-1ctbylb"),r(A,"type","range"),r(A,"min","0.1"),r(A,"max","3.0"),r(A,"step","0.1"),r(A,"class","volume-slider svelte-1ctbylb"),r(K,"class","slider-max svelte-1ctbylb"),r(q,"class","volume-slider-container svelte-1ctbylb"),r(B,"class","volume-control-section svelte-1ctbylb"),r(l,"class","volume-controls svelte-1ctbylb"),r(F,"class","training-start-button enabled svelte-1ctbylb"),r(Q,"class","training-start-button-area svelte-1ctbylb")},m(_,C){M(_,e,C),M(_,c,C),M(_,s,C),M(_,o,C),M(_,f,C),a(f,y),a(y,T),M(_,d,C),M(_,l,C),a(l,m),a(m,k),a(k,v),a(k,g),a(k,U),a(m,V),a(m,x),a(x,j),a(x,Y),a(x,I),fe(I,n[5]),a(x,ee),a(x,z),a(m,te),a(m,$),a($,b),a(l,D),a(l,B),a(B,S),a(S,ne),a(S,oe),a(S,ge),a(B,ye),a(B,q),a(q,R),a(q,Te),a(q,A),fe(A,n[6]),a(q,Ce),a(q,K),M(_,ie,C),M(_,Q,C),a(Q,F),Me||(ke=[L(I,"change",n[16]),L(I,"input",n[16]),L(I,"input",n[13]),L($,"click",n[14]),L(A,"change",n[17]),L(A,"input",n[17]),L(A,"input",n[15]),L(F,"click",n[10])],Me=!0)},p(_,C){C&256&&de(T,_[8]),C&32&&de(g,_[5]),C&32&&fe(I,_[5]),C&128&&G!==(G=_[7]?"再生中...":"ド(C4)を再生")&&de(b,G),C&128&&($.disabled=_[7]),C&64&&Z!==(Z=_[6].toFixed(1)+"")&&de(oe,Z),C&64&&fe(A,_[6])},d(_){_&&(u(e),u(c),u(s),u(o),u(f),u(d),u(l),u(ie),u(Q)),Me=!1,He(ke)}}}function tt(n){let e,t,c="マイクテストを開始",s,i;return{c(){e=h("div"),t=h("button"),t.textContent=c,this.h()},l(o){e=p(o,"DIV",{class:!0});var f=E(e);t=p(f,"BUTTON",{class:!0,"data-svelte-h":!0}),N(t)!=="svelte-caex95"&&(t.textContent=c),f.forEach(u),this.h()},h(){r(t,"class","mic-test-button start svelte-1ctbylb"),r(e,"class","mic-test-button-area svelte-1ctbylb")},m(o,f){M(o,e,f),a(e,t),s||(i=L(t,"click",n[9]),s=!0)},p:we,d(o){o&&u(e),s=!1,i()}}}function st(n){let e,t,c="マイク許可を再試行",s,i;return{c(){e=h("div"),t=h("button"),t.textContent=c,this.h()},l(o){e=p(o,"DIV",{class:!0});var f=E(e);t=p(f,"BUTTON",{class:!0,"data-svelte-h":!0}),N(t)!=="svelte-1p3n8nt"&&(t.textContent=c),f.forEach(u),this.h()},h(){r(t,"class","mic-test-button retry svelte-1ctbylb"),r(e,"class","mic-test-button-area svelte-1ctbylb")},m(o,f){M(o,e,f),a(e,t),s||(i=L(t,"click",n[9]),s=!0)},p:we,d(o){o&&u(e),s=!1,i()}}}function lt(n){let e,t="マイク準備中...";return{c(){e=h("p"),e.textContent=t,this.h()},l(c){e=p(c,"P",{class:!0,"data-svelte-h":!0}),N(e)!=="svelte-1vb5g92"&&(e.textContent=t),this.h()},h(){r(e,"class","status-text svelte-1ctbylb")},m(c,s){M(c,e,s)},p:we,d(c){c&&u(e)}}}function nt(n){let e;function t(i,o){return i[0]==="granted"?et:Ye}let c=t(n),s=c(n);return{c(){e=h("div"),s.c(),this.h()},l(i){e=p(i,"DIV",{class:!0});var o=E(e);s.l(o),o.forEach(u),this.h()},h(){r(e,"class","training-mode-content svelte-1ctbylb")},m(i,o){M(i,e,o),s.m(e,null)},p(i,o){c===(c=t(i))&&s?s.p(i,o):(s.d(1),s=c(i),s&&(s.c(),s.m(e,null)))},d(i){i&&u(e),s.d()}}}function ot(n){let e,t,c='<div class="mic-test-header svelte-1ctbylb"><div class="mic-icon svelte-1ctbylb"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" x2="12" y1="19" y2="22"></line><line x1="8" x2="16" y1="22" y2="22"></line></svg></div> <div><h1 class="mic-test-title svelte-1ctbylb">マイクテスト</h1> <p class="mic-test-description svelte-1ctbylb">音感トレーニングを始める前に、マイクの動作を確認します</p></div></div>',s,i,o,f,y,T,d,l,m;o=new Qe({props:{variant:"default",padding:"lg",$$slots:{default:[nt]},$$scope:{ctx:n}}}),y=new Ze({props:{frequency:n[2],note:n[3],volume:n[1],isMuted:n[0]!=="granted",muteMessage:"マイク許可後に開始"}});let k={isActive:n[0]==="granted",className:"pitch-detector-content",debugMode:!1};return l=new Je({props:k}),n[18](l),l.$on("pitchUpdate",n[11]),l.$on("stateChange",at),l.$on("error",n[12]),{c(){e=h("div"),t=h("div"),t.innerHTML=c,s=P(),i=h("div"),_e(o.$$.fragment),f=P(),_e(y.$$.fragment),T=P(),d=h("div"),_e(l.$$.fragment),this.h()},l(v){e=p(v,"DIV",{class:!0});var g=E(e);t=p(g,"DIV",{class:!0,"data-svelte-h":!0}),N(t)!=="svelte-4qcd63"&&(t.innerHTML=c),s=w(g),i=p(g,"DIV",{class:!0});var U=E(i);be(o.$$.fragment,U),U.forEach(u),f=w(g),be(y.$$.fragment,g),T=w(g),d=p(g,"DIV",{style:!0});var V=E(d);be(l.$$.fragment,V),V.forEach(u),g.forEach(u),this.h()},h(){r(t,"class","header svelte-1ctbylb"),r(i,"class","training-mode-info svelte-1ctbylb"),ze(d,"display","none"),r(e,"class","microphone-test svelte-1ctbylb")},m(v,g){M(v,e,g),a(e,t),a(e,s),a(e,i),ve(o,i,null),a(e,f),ve(y,e,null),a(e,T),a(e,d),ve(l,d,null),m=!0},p(v,g){const U={};g&67109345&&(U.$$scope={dirty:g,ctx:v}),o.$set(U);const V={};g&4&&(V.frequency=v[2]),g&8&&(V.note=v[3]),g&2&&(V.volume=v[1]),g&1&&(V.isMuted=v[0]!=="granted"),y.$set(V);const x={};g&1&&(x.isActive=v[0]==="granted"),l.$set(x)},i(v){m||(me(o.$$.fragment,v),me(y.$$.fragment,v),me(l.$$.fragment,v),m=!0)},o(v){he(o.$$.fragment,v),he(y.$$.fragment,v),he(l.$$.fragment,v),m=!1},d(v){v&&u(e),pe(o),pe(y),n[18](null),pe(l)}}}function it(n){let e,t,c;return t=new Ke({props:{showBackButton:!0,$$slots:{default:[ot]},$$scope:{ctx:n}}}),{c(){e=P(),_e(t.$$.fragment),this.h()},l(s){Le("svelte-8st1fo",Se.head).forEach(u),e=w(s),be(t.$$.fragment,s),this.h()},h(){Se.title="マイクテスト - 相対音感トレーニング"},m(s,i){M(s,e,i),ve(t,s,i),c=!0},p(s,[i]){const o={};i&67109375&&(o.$$scope={dirty:i,ctx:s}),t.$set(o)},i(s){c||(me(t.$$.fragment,s),c=!0)},o(s){he(t.$$.fragment,s),c=!1},d(s){s&&u(e),pe(t,s)}}}function at(n){}function rt(n,e,t){let c;je(n,Oe,b=>t(21,c=b));let s="random";Be(()=>{c.url.searchParams.has("mode")&&(s=c.url.searchParams.get("mode")||"random")});let i="initial",o=0,f=0,y="ーー",T=null,d=0,l=1,m=null,k=!1,v="";Be(()=>{const b=/iPhone/.test(navigator.userAgent);/iPad/.test(navigator.userAgent)?(t(8,v="iPad検出"),t(5,d=-6)):b?(t(8,v="iPhone検出"),t(5,d=-6)):(t(8,v="その他デバイス"),t(5,d=-6)),console.log(`🔍 [MicTest] デバイス情報: ${v}`,navigator.userAgent)});const g={random:{name:"ランダム基音モード",description:"10種類の基音からランダムに選択してトレーニング",color:"green",path:"/training/random"},continuous:{name:"連続チャレンジモード",description:"選択した回数だけ連続で実行し、総合評価を確認",color:"orange",path:"/training/continuous"},chromatic:{name:"12音階モード",description:"クロマチックスケールの上行・下行で完全制覇",color:"purple",path:"/training/chromatic"}},U=g[s]||g.random;async function V(){var b;t(0,i="pending");try{if(console.log("🎤 [MicTest] マイク許可リクエスト開始"),!((b=navigator.mediaDevices)!=null&&b.getUserMedia)){t(0,i="denied"),console.error("❌ [MicTest] getUserMediaがサポートされていません");return}const D=await We.initialize();if(console.log("✅ [MicTest] AudioManager リソース取得完了"),D.mediaStream&&D.audioContext)t(0,i="granted"),console.log("✅ [MicTest] マイク許可完了"),await le(),setTimeout(async()=>{T&&(console.log("🎙️ [MicTest] PitchDetector初期化開始"),await T.initialize(),console.log("✅ [MicTest] PitchDetector初期化完了"),console.log("🎯 [MicTest] PitchDetector isActiveリアクティブで自動検出開始"))},1e3);else throw new Error("リソース取得失敗")}catch(D){console.error("❌ [MicTest] マイク許可エラー:",D),t(0,i=((D==null?void 0:D.name)==="NotAllowedError","denied"))}}function x(){console.log("🚀 [MicTest] トレーニング開始 - ランダム基音モードへ遷移"),localStorage.setItem("mic-test-completed","true"),console.log("✅ [MicTest] マイクテスト完了フラグを保存"),Ge(`${Re}${U.path}?from=microphone-test`)}function j(b){const{frequency:D,note:B,volume:S,rawVolume:ne,clarity:Z}=b.detail;t(2,f=D),t(3,y=B),t(1,o=S)}function se(b){console.error("❌ [MicTest] PitchDetectorエラー:",b.detail);const{error:D,reason:B,recovery:S}=b.detail;B==="mediastream_ended"&&S==="restart_required"&&(console.log("🔄 [MicTest] MediaStream終了検出 - 自動復旧開始"),t(0,i="initial"),t(1,o=0),t(2,f=0),t(3,y="ーー"),console.log("⚠️ [MicTest] マイク再許可が必要です"))}async function Y(){try{if(console.log("🎹 [MicTest] 基音テスト初期化開始"),typeof window<"u"){if(!window.Tone){console.log("📦 [MicTest] Tone.js動的読み込み開始");const b=document.createElement("script");b.src="https://unpkg.com/tone@latest/build/Tone.js",document.head.appendChild(b),await new Promise((D,B)=>{b.onload=D,b.onerror=B}),console.log("✅ [MicTest] Tone.js読み込み完了")}await window.Tone.start(),m=new window.Tone.Sampler({urls:{C4:"C4.mp3"},baseUrl:"https://tonejs.github.io/audio/salamander/",release:1.5,onload:()=>{console.log("✅ [MicTest] 基音サンプラー読み込み完了")},onerror:b=>{console.error("❌ [MicTest] 基音サンプラー読み込みエラー:",b)}}).toDestination(),I()}else console.warn("⚠️ [MicTest] window未定義 - 基音テスト無効")}catch(b){console.error("❌ [MicTest] 基音テスト初期化エラー:",b)}}function I(){m&&(m.volume.value=d,console.log(`🔊 [MicTest] 基音音量設定: ${d}dB`))}async function ee(){if(!(!m||k))try{t(7,k=!0),console.log("🎵 [MicTest] 基音再生開始: C4"),await m.triggerAttackRelease("C4",2,window.Tone.now(),.7),setTimeout(()=>{t(7,k=!1),console.log("✅ [MicTest] 基音再生完了")},2e3)}catch(b){console.error("❌ [MicTest] 基音再生エラー:",b),t(7,k=!1)}}function z(){console.log(`🎤 [MicTest] マイク感度設定: ${l}x`)}async function le(){await Y()}function te(){d=Ae(this.value),t(5,d)}function $(){l=Ae(this.value),t(6,l)}function G(b){Fe[b?"unshift":"push"](()=>{T=b,t(4,T)})}return[i,o,f,y,T,d,l,k,v,V,x,j,se,I,ee,z,te,$,G]}class mt extends Ue{constructor(e){super(),$e(this,e,rt,it,qe,{})}}export{mt as component};
