const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["../chunks/DrUK7av6.js","../chunks/ChDCDHhu.js","../chunks/D6YF6ztN.js","../chunks/IHki7fMi.js","../chunks/DYrXUu6e.js","../assets/sessionStorage.BHSgymFr.css"])))=>i.map(i=>d[i]);
import{_ as rt}from"../chunks/C1FmrZbK.js";import{S as sn,i as rn,s as an,C as ie,m as P,o as F,D as ce,E as le,F as ue,l as be,M as on,Q as cn,d as D,p as we,q as ke,b as z,c as A,y as I,K as ze,e as T,f as x,G as ge,h as q,g as X,r as Ae,j as $,k as j,t as J,P as ln,a as $e,J as Ct,n as Tt}from"../chunks/ChDCDHhu.js";import{e as We}from"../chunks/D6YF6ztN.js";import"../chunks/IHki7fMi.js";import{b as Je,g as at}from"../chunks/DYrXUu6e.js";import{p as un}from"../chunks/CWNLdXLH.js";import{P as mn,C as xe}from"../chunks/DQaHVEr9.js";import{B as Ke}from"../chunks/Cx4dwUxr.js";import{l as ee,a as Fe,b as fn,P as dn,h as ot}from"../chunks/B6wEjQM2.js";import{l as it,f as Be,S as hn,g as ct,A as $t,M as gn,U as It,E as Oe,e as pn,u as yn,i as vn,d as Sn,r as Dn,b as bn,n as An,h as _n,t as Mn,j as wn}from"../chunks/DrUK7av6.js";const kn=!1,Cn=!1,ms=Object.freeze(Object.defineProperty({__proto__:null,prerender:Cn,ssr:kn},Symbol.toStringTag,{value:"Module"}));class Tn{constructor(){this.intervalTypes={unison:{name:"同度",semitones:0,importance:.8,description:"基音と同じ高さ",difficulty:"基本",commonErrors:["微細なピッチのずれ"]},minorSecond:{name:"短2度",semitones:1,importance:.9,description:"半音上",difficulty:"高",commonErrors:["長2度との混同","音程幅の過大評価"]},majorSecond:{name:"長2度",semitones:2,importance:1,description:"全音上（ドレ）",difficulty:"基本",commonErrors:["短2度との混同"]},minorThird:{name:"短3度",semitones:3,importance:1,description:"短調の3度（ドミ♭）",difficulty:"中",commonErrors:["長3度との混同"]},majorThird:{name:"長3度",semitones:4,importance:1,description:"長調の3度（ドミ）",difficulty:"基本",commonErrors:["短3度との混同","完全4度への誤認"]},perfectFourth:{name:"完全4度",semitones:5,importance:.9,description:"安定した協和音程（ドファ）",difficulty:"基本",commonErrors:["長3度・減5度との混同"]},tritone:{name:"減5度",semitones:6,importance:.7,description:"不安定な音程（ドファ#）",difficulty:"高",commonErrors:["完全4度・完全5度との混同"]},perfectFifth:{name:"完全5度",semitones:7,importance:.9,description:"最も安定した音程（ドソ）",difficulty:"基本",commonErrors:["減5度・長6度との混同"]},minorSixth:{name:"短6度",semitones:8,importance:.8,description:"短調的色彩（ドラ♭）",difficulty:"中",commonErrors:["長6度・完全5度との混同"]},majorSixth:{name:"長6度",semitones:9,importance:.8,description:"明るい響き（ドラ）",difficulty:"中",commonErrors:["短6度・短7度との混同"]},minorSeventh:{name:"短7度",semitones:10,importance:.7,description:"属7和音の7度（ドシ♭）",difficulty:"中",commonErrors:["長7度・長6度との混同"]},majorSeventh:{name:"長7度",semitones:11,importance:.7,description:"鋭い不協和音程（ドシ）",difficulty:"高",commonErrors:["短7度・8度との混同"]},octave:{name:"8度",semitones:12,importance:.9,description:"1オクターブ上（ドド）",difficulty:"基本",commonErrors:["HarmonicCorrectionによる倍音誤検出"]}},this.masteryData=new Map,this.analysisHistory=[],this.maxHistoryLength=100,this.debugMode=!1,this.initializeMasteryData(),this.log("🎵 IntervalAnalyzer初期化完了",{intervalCount:Object.keys(this.intervalTypes).length,masteryData:this.masteryData.size})}analyzeInterval(e,t,n){try{const s=this.calculateSemitones(e,t),r=this.identifyInterval(s),l=this.calculateSemitones(e,n),m=this.identifyInterval(l),c=this.calculateIntervalAccuracy(s,l);this.updateMastery(r.key,c);const a=this.getMastery(r.key),i={targetInterval:r,detectedInterval:m,targetSemitones:s,detectedSemitones:l,accuracy:c,mastery:a,masteryLevels:Object.fromEntries(this.masteryData),isCorrectInterval:r.key===m.key,feedback:this.generateIntervalFeedback(r,m,c),timestamp:Date.now()};return this.recordAnalysis(i),this.debugMode&&this.logAnalysisDetails(i),i}catch(s){return console.error("❌ [IntervalAnalyzer] 分析エラー:",s),this.createErrorResult(e,t,n)}}calculateSemitones(e,t){return!e||!t||e<=0||t<=0?0:(12*Math.log2(t/e)%12+12)%12}identifyInterval(e){let t=null,n=1/0;for(const[s,r]of Object.entries(this.intervalTypes)){const l=Math.abs(e-r.semitones);l<n&&(n=l,t={key:s,...r,distance:l})}return t}calculateIntervalAccuracy(e,t){const n=Math.abs(e-t),s=Math.max(0,100-n*50);return Math.min(100,s)}updateMastery(e,t){this.masteryData.has(e)||this.masteryData.set(e,{attempts:0,totalAccuracy:0,averageAccuracy:0,bestAccuracy:0,recentAttempts:[],lastAttempt:null,trend:"stable"});const n=this.masteryData.get(e);n.attempts++,n.totalAccuracy+=t,n.averageAccuracy=n.totalAccuracy/n.attempts,n.bestAccuracy=Math.max(n.bestAccuracy,t),n.lastAttempt=Date.now(),n.recentAttempts.push(t),n.recentAttempts.length>10&&n.recentAttempts.shift(),n.trend=this.calculateTrend(n.recentAttempts),this.masteryData.set(e,n)}getMastery(e){const t=this.masteryData.get(e);if(!t)return{attempts:0,averageAccuracy:0,bestAccuracy:0,level:"beginner",progress:0};const n=this.determineMasteryLevel(t.averageAccuracy,t.attempts),s=Math.min(100,t.averageAccuracy*t.attempts/500);return{...t,level:n,progress:Math.round(s)}}determineMasteryLevel(e,t){return t<3?"beginner":e>=90&&t>=10?"master":e>=80&&t>=7?"advanced":e>=70&&t>=5?"intermediate":e>=50?"novice":"beginner"}calculateTrend(e){if(e.length<3)return"stable";const t=e.slice(-3),n=e.slice(-6,-3);if(n.length===0)return"stable";const s=t.reduce((m,c)=>m+c,0)/t.length,r=n.reduce((m,c)=>m+c,0)/n.length,l=s-r;return l>5?"improving":l<-5?"declining":"stable"}generateIntervalFeedback(e,t,n){const s=e.key===t.key;if(s&&n>=90)return`🎯 ${e.name}を完璧に認識しました！`;if(s&&n>=70)return`✅ ${e.name}の認識は正しいです。精度を上げてみましょう。`;if(s)return`👍 ${e.name}を認識できています。もう少し正確に。`;const r=this.analyzeIntervalError(e,t);return`❌ ${e.name}ではなく${t.name}と認識されました。${r}`}analyzeIntervalError(e,t){const n=t.semitones-e.semitones;return Math.abs(n)===1?n>0?"少し高めに歌っています。":"少し低めに歌っています。":Math.abs(n)<=2?"音程幅の調整が必要です。":Math.abs(n)>=6?"オクターブ関係の可能性があります。":"音程の特徴を意識してみてください。"}getAllMasteryData(){const e={};for(const[t,n]of Object.entries(this.intervalTypes))e[t]={interval:n,mastery:this.getMastery(t)};return e}getWeakIntervals(e=3){return Object.entries(this.getAllMasteryData()).filter(([n,s])=>s.mastery.attempts>=2).sort((n,s)=>n[1].mastery.averageAccuracy-s[1].mastery.averageAccuracy).slice(0,e).map(([n,s])=>({key:n,name:s.interval.name,accuracy:s.mastery.averageAccuracy,attempts:s.mastery.attempts,improvement:this.generateImprovementTip(n,s)}))}getStrongIntervals(e=3){return Object.entries(this.getAllMasteryData()).filter(([n,s])=>s.mastery.attempts>=3).sort((n,s)=>s[1].mastery.averageAccuracy-n[1].mastery.averageAccuracy).slice(0,e).map(([n,s])=>({key:n,name:s.interval.name,accuracy:s.mastery.averageAccuracy,attempts:s.mastery.attempts,reason:this.generateStrengthReason(n,s)}))}generateImprovementTip(e,t){const n=t.interval;return t.mastery.trend==="improving"?`📈 改善中です！${n.description}の特徴を意識して練習を続けましょう。`:n.commonErrors.length>0?`💡 ${n.commonErrors[0]}に注意してください。`:`🎯 ${n.description}を意識して、ゆっくりと練習してみましょう。`}generateStrengthReason(e,t){const n=t.interval,s=t.mastery;return s.averageAccuracy>=95?`完璧な精度で${n.name}を認識できています！`:s.trend==="improving"?`${n.name}の理解が急速に向上しています。`:`${n.name}の認識が安定しています。`}initializeMasteryData(){}recordAnalysis(e){this.analysisHistory.push(e),this.analysisHistory.length>this.maxHistoryLength&&this.analysisHistory.shift()}createErrorResult(e,t,n){return{targetInterval:{name:"不明",key:"unknown"},detectedInterval:{name:"不明",key:"unknown"},accuracy:0,mastery:{level:"beginner",progress:0},masteryLevels:Object.fromEntries(this.masteryData),isCorrectInterval:!1,feedback:"音程分析でエラーが発生しました。",error:!0}}logAnalysisDetails(e){var t;console.group(`🎵 [IntervalAnalyzer] ${e.targetInterval.name}分析結果`),console.log("🎯 音程分析:",{目標:`${e.targetInterval.name} (${e.targetSemitones.toFixed(1)}セミトーン)`,検出:`${e.detectedInterval.name} (${e.detectedSemitones.toFixed(1)}セミトーン)`,正解:e.isCorrectInterval?"✅":"❌",精度:`${e.accuracy.toFixed(1)}%`}),console.log("📊 習得状況:",{レベル:e.mastery.level,試行回数:e.mastery.attempts,平均精度:`${((t=e.mastery.averageAccuracy)==null?void 0:t.toFixed(1))||0}%`,進捗:`${e.mastery.progress}%`,トレンド:e.mastery.trend}),console.log("💬 フィードバック:",e.feedback),console.groupEnd()}log(e,t=null){this.debugMode&&(t?console.log(`[IntervalAnalyzer] ${e}`,t):console.log(`[IntervalAnalyzer] ${e}`))}getStatistics(){return{totalAnalyses:this.analysisHistory.length,intervalTypes:Object.keys(this.intervalTypes).length,masteryLevels:Object.fromEntries(this.masteryData),sessionStartTime:this.sessionStartTime||Date.now()}}reset(){this.masteryData.clear(),this.analysisHistory=[],this.initializeMasteryData(),this.log("🔄 IntervalAnalyzer リセット完了")}}class $n{constructor(){this.directions={ascending:{name:"上行",icon:"↗️",description:"基音より高い音程",color:"#10b981",commonErrors:["オクターブ下認識（倍音効果）","音程幅の過小評価","目標音程の手前で停止"]},descending:{name:"下行",icon:"↘️",description:"基音より低い音程",color:"#3b82f6",commonErrors:["オクターブ上認識（倍音効果）","音程幅の過大評価","目標音程を通り越す"]},unison:{name:"同音",icon:"➡️",description:"基音と同じ高さ",color:"#6b7280",commonErrors:["微細なピッチずれ","倍音による誤認識"]}},this.directionMastery=new Map,this.analysisHistory=[],this.maxHistoryLength=50,this.debugMode=!1,this.thresholds={unison:.5,overshoot:1.5,significant:3},this.initializeDirectionMastery(),this.log("🧭 DirectionAnalyzer初期化完了",{directions:Object.keys(this.directions).length,thresholds:this.thresholds})}analyzeDirection(e,t,n){try{const s=this.determineDirection(e,t),r=this.calculateSemitones(e,t),l=this.determineDirection(e,n),m=this.calculateSemitones(e,n),c=s.key===l.key,a=this.analyzeOvershoot(r,m),i=this.calculateDirectionAccuracy(s.key,l.key,r,m);this.updateDirectionMastery(s.key,i,c);const h=this.getDirectionMastery(s.key),d={targetDirection:s,detectedDirection:l,targetSemitones:r,detectedSemitones:m,directionCorrect:c,accuracy:i,mastery:h,overshoot:a,feedback:this.generateDirectionFeedback(s,l,a,i),timestamp:Date.now()};return this.recordAnalysis(d),this.debugMode&&this.logAnalysisDetails(d),d}catch(s){return console.error("❌ [DirectionAnalyzer] 分析エラー:",s),this.createErrorResult(e,t,n)}}determineDirection(e,t){const n=this.calculateSemitones(e,t);return Math.abs(n)<=this.thresholds.unison?{key:"unison",...this.directions.unison}:n>0?{key:"ascending",...this.directions.ascending}:{key:"descending",...this.directions.descending}}calculateSemitones(e,t){return!e||!t||e<=0||t<=0?0:12*Math.log2(t/e)}analyzeOvershoot(e,t){const n=t-e,s=Math.abs(n);let r="accurate",l="none";return s>=this.thresholds.overshoot&&(n>0?r="overshoot":r="undershoot",s>=this.thresholds.significant?l="severe":l="moderate"),{type:r,severity:l,difference:n,absDifference:s,percentage:s/Math.abs(e)*100}}calculateDirectionAccuracy(e,t,n,s){if(e!==t)return Math.max(0,30-Math.abs(s-n)*5);const r=Math.abs(s-n),l=Math.max(0,100-r*25);return Math.min(100,l)}updateDirectionMastery(e,t,n){this.directionMastery.has(e)||this.directionMastery.set(e,{attempts:0,correctAttempts:0,totalAccuracy:0,averageAccuracy:0,bestAccuracy:0,successRate:0,recentAttempts:[],recentCorrects:[],lastAttempt:null,trend:"stable"});const s=this.directionMastery.get(e);s.attempts++,n&&s.correctAttempts++,s.totalAccuracy+=t,s.averageAccuracy=s.totalAccuracy/s.attempts,s.bestAccuracy=Math.max(s.bestAccuracy,t),s.successRate=s.correctAttempts/s.attempts*100,s.lastAttempt=Date.now(),s.recentAttempts.push(t),s.recentCorrects.push(n),s.recentAttempts.length>10&&(s.recentAttempts.shift(),s.recentCorrects.shift()),s.trend=this.calculateDirectionTrend(s.recentCorrects),this.directionMastery.set(e,s)}getDirectionMastery(e){const t=this.directionMastery.get(e);if(!t)return{attempts:0,successRate:0,averageAccuracy:0,level:"beginner",progress:0};const n=this.determineDirectionLevel(t.successRate,t.attempts),s=Math.min(100,t.successRate*t.attempts/500);return{...t,level:n,progress:Math.round(s)}}determineDirectionLevel(e,t){return t<3?"beginner":e>=95&&t>=10?"master":e>=85&&t>=7?"advanced":e>=75&&t>=5?"intermediate":e>=60?"novice":"beginner"}calculateDirectionTrend(e){if(e.length<5)return"stable";const t=e.slice(-3),n=e.slice(-6,-3);if(n.length===0)return"stable";const s=t.filter(Boolean).length/t.length,r=n.filter(Boolean).length/n.length,l=s-r;return l>.2?"improving":l<-.2?"declining":"stable"}generateDirectionFeedback(e,t,n,s){const r=e.key===t.key;return r&&s>=90?`🎯 ${e.name}の方向性が完璧です！`:r&&s>=70?`✅ ${e.name}の方向は正しいです。距離の調整をしてみましょう。`:r?n.type==="overshoot"?`👍 ${e.name}の方向は正しいですが、少し歌いすぎです。`:n.type==="undershoot"?`👍 ${e.name}の方向は正しいですが、もう少し大きく歌ってみてください。`:`👍 ${e.name}の方向は認識できています。`:e.key==="ascending"&&t.key==="descending"?"❌ 上行のつもりが下行になっています。基音より高く歌ってください。":e.key==="descending"&&t.key==="ascending"?"❌ 下行のつもりが上行になっています。基音より低く歌ってください。":e.key!=="unison"&&t.key==="unison"?`❌ 音程変化が小さすぎます。${e.name}により大きく歌ってください。`:`❌ ${e.name}ではなく${t.name}と認識されました。`}getAllDirectionMastery(){const e={};for(const[t,n]of Object.entries(this.directions))e[t]={direction:n,mastery:this.getDirectionMastery(t)};return e}getDirectionComparison(){const e=this.getDirectionMastery("ascending"),t=this.getDirectionMastery("descending");return{ascending:e,descending:t,comparison:{betterDirection:e.successRate>t.successRate?"ascending":"descending",difference:Math.abs(e.successRate-t.successRate),recommendation:this.generateDirectionRecommendation(e,t)}}}generateDirectionRecommendation(e,t){const n=e.successRate-t.successRate;return Math.abs(n)<10?"上行・下行ともにバランス良く習得できています。":n>10?"下行の練習を重点的に行うことをお勧めします。下向きの音程により意識を向けてみてください。":"上行の練習を重点的に行うことをお勧めします。上向きの音程により意識を向けてみてください。"}initializeDirectionMastery(){for(const e of Object.keys(this.directions))this.directionMastery.has(e)||this.directionMastery.set(e,{attempts:0,correctAttempts:0,totalAccuracy:0,averageAccuracy:0,bestAccuracy:0,successRate:0,recentAttempts:[],recentCorrects:[],lastAttempt:null,trend:"stable"})}recordAnalysis(e){this.analysisHistory.push(e),this.analysisHistory.length>this.maxHistoryLength&&this.analysisHistory.shift()}createErrorResult(e,t,n){return{targetDirection:{name:"不明",key:"unknown"},detectedDirection:{name:"不明",key:"unknown"},directionCorrect:!1,accuracy:0,mastery:{level:"beginner",progress:0},overshoot:{type:"unknown",severity:"none"},feedback:"方向性分析でエラーが発生しました。",error:!0}}logAnalysisDetails(e){var t;console.group(`🧭 [DirectionAnalyzer] ${e.targetDirection.name}分析結果`),console.log("🎯 方向性分析:",{目標:`${e.targetDirection.name} (${e.targetSemitones.toFixed(1)}セミトーン)`,検出:`${e.detectedDirection.name} (${e.detectedSemitones.toFixed(1)}セミトーン)`,正解:e.directionCorrect?"✅":"❌",精度:`${e.accuracy.toFixed(1)}%`}),console.log("📊 オーバーシュート分析:",{タイプ:e.overshoot.type,深刻度:e.overshoot.severity,差分:`${e.overshoot.difference.toFixed(1)}セミトーン`,誤差率:`${e.overshoot.percentage.toFixed(1)}%`}),console.log("📈 習得状況:",{レベル:e.mastery.level,成功率:`${((t=e.mastery.successRate)==null?void 0:t.toFixed(1))||0}%`,試行回数:e.mastery.attempts,トレンド:e.mastery.trend}),console.log("💬 フィードバック:",e.feedback),console.groupEnd()}log(e,t=null){this.debugMode&&(t?console.log(`[DirectionAnalyzer] ${e}`,t):console.log(`[DirectionAnalyzer] ${e}`))}getStatistics(){return{totalAnalyses:this.analysisHistory.length,directionTypes:Object.keys(this.directions).length,masteryData:Object.fromEntries(this.directionMastery),thresholds:this.thresholds}}reset(){this.directionMastery.clear(),this.analysisHistory=[],this.initializeDirectionMastery(),this.log("🔄 DirectionAnalyzer リセット完了")}}class In{constructor(e={}){this.config={windowSize:e.windowSize||5,maxHistory:e.maxHistory||100,stabilityThreshold:e.stabilityThreshold||25,trendWindowSize:e.trendWindowSize||10,fatigueDetectionWindow:e.fatigueDetectionWindow||15},this.consistencyData=new Map,this.stabilityHistory=[],this.sessionData={startTime:Date.now(),totalAttempts:0,overallConsistency:0,stabilityTrend:"stable",fatigueLevel:"fresh",concentrationLevel:"high"},this.debugMode=!1,this.log("📊 ConsistencyTracker初期化完了",{config:this.config,sessionStart:new Date(this.sessionData.startTime).toLocaleTimeString()})}recordAttempt(e,t,n,s){try{this.addAttemptData(e,t,n,s);const r=this.calculateIntervalConsistency(e);this.updateOverallConsistency();const l=this.analyzeStabilityTrend(),m=this.analyzeFatigue(),c={intervalType:e,intervalConsistency:r,overallConsistency:this.sessionData.overallConsistency,stabilityTrend:l,fatigueAnalysis:m,recommendations:this.generateConsistencyRecommendations(r,m),timestamp:Date.now()};return this.updateSessionData(c),this.debugMode&&this.logConsistencyDetails(c),c}catch(r){return console.error("❌ [ConsistencyTracker] 記録エラー:",r),this.createErrorResult(e)}}addAttemptData(e,t,n,s){this.consistencyData.has(e)||this.consistencyData.set(e,{attempts:[],statistics:{count:0,mean:0,standardDeviation:0,variance:0,range:0,consistencyScore:0},trend:"stable",lastUpdated:Date.now()});const r=this.consistencyData.get(e),l={centsDiff:t,accuracy:n,responseTime:s,timestamp:Date.now()};r.attempts.push(l),r.attempts.length>this.config.maxHistory&&r.attempts.shift(),this.updateStatistics(e),this.stabilityHistory.push({intervalType:e,centsDiff:Math.abs(t),accuracy:n,timestamp:Date.now()}),this.stabilityHistory.length>this.config.maxHistory&&this.stabilityHistory.shift(),this.sessionData.totalAttempts++}updateStatistics(e){const t=this.consistencyData.get(e),n=t.attempts;if(n.length===0)return;const s=n.map(h=>Math.abs(h.centsDiff)),r=s.length,l=s.reduce((h,d)=>h+d,0)/r,m=s.reduce((h,d)=>h+Math.pow(d-l,2),0)/r,c=Math.sqrt(m),a=Math.max(...s)-Math.min(...s),i=Math.max(0,100-c*2);t.statistics={count:r,mean:Math.round(l*10)/10,standardDeviation:Math.round(c*10)/10,variance:Math.round(m*10)/10,range:Math.round(a*10)/10,consistencyScore:Math.round(i*10)/10},t.trend=this.calculateIntervalTrend(n),t.lastUpdated=Date.now()}calculateIntervalConsistency(e){const t=this.consistencyData.get(e);if(!t||t.attempts.length<2)return{level:"insufficient_data",score:0,description:"データ不足",attempts:(t==null?void 0:t.attempts.length)||0};const n=t.statistics,s=this.determineConsistencyLevel(n.consistencyScore);return{intervalType:e,level:s,score:n.consistencyScore,statistics:n,trend:t.trend,description:this.getConsistencyDescription(s),attempts:n.count,recommendation:this.getIntervalRecommendation(e,n,t.trend)}}determineConsistencyLevel(e){return e>=90?"excellent":e>=75?"good":e>=60?"fair":e>=40?"poor":"very_poor"}getConsistencyDescription(e){return{excellent:"非常に安定した精度で認識できています",good:"安定した認識ができています",fair:"やや不安定ですが、改善の余地があります",poor:"不安定な認識です。練習を重ねましょう",very_poor:"非常に不安定です。基礎練習から始めましょう",insufficient_data:"データが不足しています"}[e]||"評価不能"}updateOverallConsistency(){if(this.stabilityHistory.length<5){this.sessionData.overallConsistency=0;return}const t=this.stabilityHistory.slice(-this.config.trendWindowSize).map(r=>r.centsDiff),n=t.reduce((r,l)=>r+l,0)/t.length,s=Math.sqrt(t.reduce((r,l)=>r+Math.pow(l-n,2),0)/t.length);this.sessionData.overallConsistency=Math.max(0,100-s*2)}analyzeStabilityTrend(){if(this.stabilityHistory.length<this.config.trendWindowSize)return{trend:"insufficient_data",direction:"stable",confidence:0,description:"データ不足"};const e=this.stabilityHistory.slice(-this.config.trendWindowSize),t=Math.floor(this.config.trendWindowSize/2),n=e.slice(0,t),s=e.slice(-t),r=n.reduce((d,p)=>d+p.centsDiff,0)/n.length,l=s.reduce((d,p)=>d+p.centsDiff,0)/s.length,m=r-l,c=m/r*100;let a,i,h;return Math.abs(c)<10?(a="stable",i="stable",h=.7):m>0?(a="improving",i="better",h=Math.min(.9,Math.abs(c)/20)):(a="declining",i="worse",h=Math.min(.9,Math.abs(c)/20)),this.sessionData.stabilityTrend=a,{trend:a,direction:i,confidence:Math.round(h*100)/100,improvement:Math.round(m*10)/10,improvementPercent:Math.round(c*10)/10,description:this.getTrendDescription(a,i)}}analyzeFatigue(){if(this.stabilityHistory.length<this.config.fatigueDetectionWindow)return{fatigueLevel:"unknown",concentrationLevel:"unknown",recommendation:"データ不足のため判定できません"};const e=this.stabilityHistory.slice(-this.config.fatigueDetectionWindow),n=(Date.now()-this.sessionData.startTime)/(1e3*60);let s="fresh";n>30&&(s="moderate"),n>60&&(s="tired"),n>90&&(s="exhausted");const r=e.map(p=>p.accuracy),l=r.reduce((p,y)=>p+y,0)/r.length,m=this.stabilityHistory.map(p=>p.accuracy),a=m.reduce((p,y)=>p+y,0)/m.length-l;let i="fresh";a>5&&(i="moderate"),a>10&&(i="tired"),a>20&&(i="exhausted");const h=this.combineFatigueFactors(s,i),d=this.evaluateConcentration(e);return this.sessionData.fatigueLevel=h,this.sessionData.concentrationLevel=d,{fatigueLevel:h,concentrationLevel:d,sessionMinutes:Math.round(n),accuracyDrop:Math.round(a*10)/10,recommendation:this.getFatigueRecommendation(h,d)}}combineFatigueFactors(e,t){const n=["fresh","moderate","tired","exhausted"],s=n.indexOf(e),r=n.indexOf(t),l=Math.max(s,r);return n[l]}evaluateConcentration(e){const t=e.map(s=>s.centsDiff),n=Math.sqrt(t.reduce((s,r)=>s+Math.pow(r-t.reduce((l,m)=>l+m,0)/t.length,2),0)/t.length);return n<=15?"high":n<=25?"medium":n<=40?"low":"very_low"}generateConsistencyRecommendations(e,t){const n=[];return(t.fatigueLevel==="tired"||t.fatigueLevel==="exhausted")&&n.push({type:"rest",priority:"high",message:"疲労が見られます。10-15分の休憩をお勧めします。",icon:"😴"}),(t.concentrationLevel==="low"||t.concentrationLevel==="very_low")&&n.push({type:"focus",priority:"medium",message:"集中力が低下しています。深呼吸をして、ゆっくりと練習してみてください。",icon:"🧘"}),(e.level==="poor"||e.level==="very_poor")&&n.push({type:"practice",priority:"medium",message:`${e.intervalType}の練習を重点的に行いましょう。ゆっくりと正確に歌うことを意識してください。`,icon:"🎯"}),e.trend==="improving"&&n.push({type:"encouragement",priority:"low",message:"改善が見られます！この調子で練習を続けてください。",icon:"📈"}),n}getIntervalRecommendation(e,t,n){return t.consistencyScore>=80?"安定した認識ができています。この精度を維持しましょう。":n==="improving"?"改善傾向にあります。継続して練習してください。":t.standardDeviation>30?"ばらつきが大きいです。ゆっくりと正確に歌うことを意識してください。":`${e}の特徴を意識して、一定の精度で歌えるよう練習しましょう。`}getTrendDescription(e,t){return{stable:"安定した精度を維持しています",improving:"精度が向上しています",declining:"精度が低下しています"}[e]||"傾向を分析中"}getFatigueRecommendation(e,t){return e==="exhausted"?"今日はここまでにして、十分な休息を取ることをお勧めします。":e==="tired"?"15-20分の休憩を取ってから練習を再開しましょう。":t==="very_low"?"集中力が低下しています。環境を整えて、短時間の集中練習を心がけましょう。":t==="low"?"深呼吸をして、一つ一つの音程に集中して練習してみてください。":"良い状態です。この調子で練習を続けてください。"}calculateIntervalTrend(e){if(e.length<6)return"stable";const t=e.slice(-3),n=e.slice(-6,-3),s=t.reduce((m,c)=>m+Math.abs(c.centsDiff),0)/t.length,l=n.reduce((m,c)=>m+Math.abs(c.centsDiff),0)/n.length-s;return l>5?"improving":l<-5?"declining":"stable"}updateSessionData(e){this.sessionData.overallConsistency=e.overallConsistency,this.sessionData.stabilityTrend=e.stabilityTrend.trend,this.sessionData.fatigueLevel=e.fatigueAnalysis.fatigueLevel,this.sessionData.concentrationLevel=e.fatigueAnalysis.concentrationLevel}createErrorResult(e){return{intervalType:e,intervalConsistency:{level:"error",score:0},overallConsistency:0,stabilityTrend:{trend:"error"},fatigueAnalysis:{fatigueLevel:"unknown"},recommendations:[],error:!0}}logConsistencyDetails(e){var t;console.group(`📊 [ConsistencyTracker] ${e.intervalType}一貫性分析`),console.log("🎯 音程一貫性:",{レベル:e.intervalConsistency.level,スコア:`${e.intervalConsistency.score}%`,標準偏差:`${((t=e.intervalConsistency.statistics)==null?void 0:t.standardDeviation)||0}セント`,試行回数:e.intervalConsistency.attempts}),console.log("📈 トレンド分析:",{全体傾向:e.stabilityTrend.trend,方向:e.stabilityTrend.direction,信頼度:`${(e.stabilityTrend.confidence*100).toFixed(0)}%`,改善度:`${e.stabilityTrend.improvement}セント`}),console.log("😴 疲労分析:",{疲労度:e.fatigueAnalysis.fatigueLevel,集中力:e.fatigueAnalysis.concentrationLevel,セッション時間:`${e.fatigueAnalysis.sessionMinutes}分`,精度低下:`${e.fatigueAnalysis.accuracyDrop}%`}),e.recommendations.length>0&&console.log("💡 推奨事項:",e.recommendations.map(n=>n.message)),console.groupEnd()}log(e,t=null){this.debugMode&&(t?console.log(`[ConsistencyTracker] ${e}`,t):console.log(`[ConsistencyTracker] ${e}`))}getAllConsistencyData(){const e={};for(const[t,n]of this.consistencyData.entries())e[t]={statistics:n.statistics,trend:n.trend,attempts:n.attempts.length,lastUpdated:n.lastUpdated};return{intervalData:e,sessionData:this.sessionData,overallStats:{totalAttempts:this.sessionData.totalAttempts,overallConsistency:this.sessionData.overallConsistency,sessionDuration:Date.now()-this.sessionData.startTime}}}getStatistics(){return{totalIntervalTypes:this.consistencyData.size,totalAttempts:this.sessionData.totalAttempts,sessionDuration:Date.now()-this.sessionData.startTime,overallConsistency:this.sessionData.overallConsistency,stabilityTrend:this.sessionData.stabilityTrend,fatigueLevel:this.sessionData.fatigueLevel}}reset(){this.consistencyData.clear(),this.stabilityHistory=[],this.sessionData={startTime:Date.now(),totalAttempts:0,overallConsistency:0,stabilityTrend:"stable",fatigueLevel:"fresh",concentrationLevel:"high"},this.log("🔄 ConsistencyTracker リセット完了")}}class En{constructor(e={}){var t,n,s,r,l,m,c,a,i,h,d;this.config={weights:{pitchAccuracy:((t=e.weights)==null?void 0:t.pitchAccuracy)||.4,recognitionSpeed:((n=e.weights)==null?void 0:n.recognitionSpeed)||.2,intervalMastery:((s=e.weights)==null?void 0:s.intervalMastery)||.2,directionAccuracy:((r=e.weights)==null?void 0:r.directionAccuracy)||.1,consistency:((l=e.weights)==null?void 0:l.consistency)||.1},speedThresholds:{excellent:((m=e.speedThresholds)==null?void 0:m.excellent)||1e3,good:((c=e.speedThresholds)==null?void 0:c.good)||2e3,fair:((a=e.speedThresholds)==null?void 0:a.fair)||3e3,poor:((i=e.speedThresholds)==null?void 0:i.poor)||5e3},harmonicCorrection:{enabled:((h=e.harmonicCorrection)==null?void 0:h.enabled)??!0,tolerance:((d=e.harmonicCorrection)==null?void 0:d.tolerance)||50},sessionTracking:e.sessionTracking??!0,maxHistorySize:e.maxHistorySize||100},this.intervalAnalyzer=new Tn,this.directionAnalyzer=new $n,this.consistencyTracker=new In,this.sessionData={startTime:Date.now(),totalAttempts:0,overallScore:0,performanceHistory:[],currentLevel:"beginner",achievements:new Set,lastAnalysis:null},this.performanceMetrics={averageSpeed:0,accuracyTrend:"stable",strengthAreas:[],improvementAreas:[],sessionProgress:0},this.debugMode=!1,this.log("🎯 EnhancedScoringEngine初期化完了",{weights:this.config.weights,analyzers:["IntervalAnalyzer","DirectionAnalyzer","ConsistencyTracker"]})}async analyzePerformance(e){try{const{baseFreq:t,targetFreq:n,detectedFreq:s,responseTime:r,volume:l=50,harmonicCorrection:m=null}=e,c=this.validateInputs(e);if(!c.valid)return this.createErrorResult(c.error);const a=this.applyHarmonicCorrection(s,m),i=await Promise.all([this.intervalAnalyzer.analyzeInterval(t,n,a),this.directionAnalyzer.analyzeDirection(t,n,a),this.consistencyTracker.recordAttempt(this.getIntervalType(t,n),this.calculateCentsDifference(n,a),this.calculateRawAccuracy(n,a),r)]),[h,d,p]=i,y=this.analyzeRecognitionSpeed(r),b=this.calculateIntegratedScore({intervalAnalysis:h,directionAnalysis:d,consistencyAnalysis:p,speedAnalysis:y,volume:l}),w=this.evaluateOverallPerformance(b),E=this.generateAdaptiveFeedback({intervalAnalysis:h,directionAnalysis:d,consistencyAnalysis:p,speedAnalysis:y,performanceEvaluation:w}),G=this.updateSessionData(b,w),v={timestamp:Date.now(),sessionAttempt:this.sessionData.totalAttempts,analyses:{interval:h,direction:d,consistency:p,speed:y},score:b,performance:w,feedback:E,session:G,metadata:{baseFreq:t,targetFreq:n,detectedFreq:s,correctedFreq:a,responseTime:r,volume:l,harmonicCorrectionApplied:!!m}};return this.recordAnalysisResult(v),this.debugMode&&this.logScoringDetails(v),v}catch(t){return console.error("❌ [EnhancedScoringEngine] 採点エラー:",t),this.createErrorResult("採点処理中にエラーが発生しました")}}validateInputs(e){const{baseFreq:t,targetFreq:n,detectedFreq:s,responseTime:r}=e;return!t||!n||!s?{valid:!1,error:"必要な周波数データが不足しています"}:t<=0||n<=0||s<=0?{valid:!1,error:"周波数は正の値である必要があります"}:r<0||r>3e4?{valid:!1,error:"反応時間が範囲外です"}:{valid:!0}}applyHarmonicCorrection(e,t){return!this.config.harmonicCorrection.enabled||!t?e:t.correctedFrequency&&Math.abs(t.correctedFrequency-e)<=this.config.harmonicCorrection.tolerance?(this.log("🔧 HarmonicCorrection適用",{original:e,corrected:t.correctedFrequency,correction:t.correction}),t.correctedFrequency):e}analyzeRecognitionSpeed(e){const{speedThresholds:t}=this.config;let n,s,r;return e<=t.excellent?(n="excellent",s=100,r="⚡ 素早い認識です！"):e<=t.good?(n="good",s=85,r="👍 良い反応速度です。"):e<=t.fair?(n="fair",s=70,r="📈 もう少し早く認識できると良いでしょう。"):e<=t.poor?(n="poor",s=50,r="🐌 ゆっくりと確実に認識しましょう。"):(n="very_poor",s=25,r="⏰ 時間をかけすぎています。練習を重ねましょう。"),{level:n,score:s,responseTime:e,feedback:r,comparison:this.compareToAverageSpeed(e)}}calculateIntegratedScore(e){const{weights:t}=this.config,{intervalAnalysis:n,directionAnalysis:s,consistencyAnalysis:r,speedAnalysis:l,volume:m}=e,c=n.accuracy||0,a=l.score||0,i=this.calculateMasteryScore(n.mastery),h=s.accuracy||0,d=r.overallConsistency||0,p=c*t.pitchAccuracy+a*t.recognitionSpeed+i*t.intervalMastery+h*t.directionAccuracy+d*t.consistency,y=this.calculateVolumeAdjustment(m),b=Math.min(100,p*y);return{total:Math.round(b*10)/10,components:{pitchAccuracy:Math.round(c*10)/10,recognitionSpeed:Math.round(a*10)/10,intervalMastery:Math.round(i*10)/10,directionAccuracy:Math.round(h*10)/10,consistency:Math.round(d*10)/10},weights:t,volumeAdjustment:Math.round(y*100)/100,grade:this.determineGrade(b)}}calculateMasteryScore(e){if(!e||e.attempts===0)return 0;const t=e.averageAccuracy||0,n=Math.min(20,e.attempts*2),s=e.trend==="improving"?10:0;return Math.min(100,t+n+s)}calculateVolumeAdjustment(e){return e<20?.8:e>80?.95:1}determineGrade(e){return e>=95?"S":e>=90?"A+":e>=85?"A":e>=80?"B+":e>=75?"B":e>=70?"C+":e>=65?"C":e>=60?"D+":e>=55?"D":"F"}evaluateOverallPerformance(e){const t=this.determinePerformanceLevel(e.total),n=this.identifyStrengths(e.components),s=this.identifyWeaknesses(e.components),r=this.calculateImprovement();return{level:t,score:e.total,grade:e.grade,strengths:n,weaknesses:s,improvement:r,recommendation:this.generatePerformanceRecommendation(t,n,s)}}determinePerformanceLevel(e){return e>=90?"excellent":e>=80?"good":e>=70?"average":e>=60?"below_average":"needs_improvement"}identifyStrengths(e){const t=[];return Object.entries(e).forEach(([n,s])=>{s>=85?t.push({area:n,score:s,level:"excellent"}):s>=75&&t.push({area:n,score:s,level:"good"})}),t.sort((n,s)=>s.score-n.score)}identifyWeaknesses(e){const t=[];return Object.entries(e).forEach(([n,s])=>{s<60&&t.push({area:n,score:s,severity:s<40?"high":"medium"})}),t.sort((n,s)=>n.score-s.score)}calculateImprovement(){const e=this.sessionData.performanceHistory;if(e.length<3)return{trend:"insufficient_data",change:0,description:"データ不足"};const t=e.slice(-3),n=e.slice(-6,-3);if(n.length===0)return{trend:"stable",change:0,description:"安定"};const s=t.reduce((a,i)=>a+i,0)/t.length,r=n.reduce((a,i)=>a+i,0)/n.length,l=s-r;let m,c;return l>5?(m="improving",c="向上中"):l<-5?(m="declining",c="低下中"):(m="stable",c="安定"),{trend:m,change:Math.round(l*10)/10,description:c}}generateAdaptiveFeedback(e){const{intervalAnalysis:t,directionAnalysis:n,consistencyAnalysis:s,speedAnalysis:r,performanceEvaluation:l}=e;return{primary:this.getPrimaryFeedback(l),detailed:{interval:t.feedback||"音程分析結果なし",direction:n.feedback||"方向性分析結果なし",consistency:this.getConsistencyFeedback(s),speed:r.feedback||"速度分析結果なし"},recommendations:this.generateRecommendations(e),encouragement:this.generateEncouragement(l),nextSteps:this.suggestNextSteps(l)}}getPrimaryFeedback(e){const{level:t,grade:n,score:s}=e;return{excellent:`🎯 素晴らしい！${n}評価（${s}点）です。`,good:`👍 良い結果です！${n}評価（${s}点）。`,average:`📈 平均的な結果です。${n}評価（${s}点）。`,below_average:`💪 練習を続けましょう。${n}評価（${s}点）。`,needs_improvement:`🎓 基礎から練習していきましょう。${n}評価（${s}点）。`}[t]||`結果: ${n}評価（${s}点）`}getConsistencyFeedback(e){if(e.recommendations&&e.recommendations.length>0)return e.recommendations[0].message;const t=e.overallConsistency||0;return t>=80?"🎯 一貫した精度を保っています。":t>=60?"📊 まずまずの安定性です。":"📈 一貫性の改善が必要です。"}generateRecommendations(e){const t=[];e.consistencyAnalysis.recommendations&&t.push(...e.consistencyAnalysis.recommendations);const{performanceEvaluation:n}=e;if(n.weaknesses.length>0){const s=n.weaknesses[0];t.push({type:"improvement",priority:"high",message:this.getImprovementSuggestion(s.area),icon:"🎯"})}return t}getImprovementSuggestion(e){return{pitchAccuracy:"音程の精度向上のため、ゆっくりと正確に歌う練習をしましょう。",recognitionSpeed:"反応速度向上のため、聞いた瞬間に歌う練習をしましょう。",intervalMastery:"苦手な音程を重点的に練習しましょう。",directionAccuracy:"上行・下行の方向性を意識して練習しましょう。",consistency:"一定の精度を保つため、集中力を高めて練習しましょう。"}[e]||"継続的な練習で改善していきましょう。"}generateEncouragement(e){if(e.improvement.trend==="improving")return"📈 確実に上達しています！この調子で続けましょう。";if(e.strengths.length>0){const t=e.strengths[0];return`⭐ ${this.getAreaName(t.area)}が得意ですね！`}return"🌟 練習を続けることで必ず上達します。頑張りましょう！"}suggestNextSteps(e){if(e.level==="excellent")return"🎓 上級レベルに到達しています。より複雑な音程に挑戦してみましょう。";if(e.weaknesses.length>0){const t=e.weaknesses[0];return`🎯 ${this.getAreaName(t.area)}の練習に重点を置きましょう。`}return"📚 基礎練習を継続し、全体的なレベルアップを目指しましょう。"}getAreaName(e){return{pitchAccuracy:"音程精度",recognitionSpeed:"認識速度",intervalMastery:"音程習得度",directionAccuracy:"方向性認識",consistency:"一貫性"}[e]||e}updateSessionData(e,t){return this.sessionData.totalAttempts++,this.sessionData.performanceHistory.push(e.total),this.sessionData.overallScore=this.calculateSessionAverage(),this.sessionData.currentLevel=t.level,this.sessionData.lastAnalysis=Date.now(),this.sessionData.performanceHistory.length>this.config.maxHistorySize&&this.sessionData.performanceHistory.shift(),this.updatePerformanceMetrics(e,t),this.checkAchievements(e,t),{attempt:this.sessionData.totalAttempts,sessionAverage:this.sessionData.overallScore,sessionDuration:Date.now()-this.sessionData.startTime,level:this.sessionData.currentLevel,newAchievements:Array.from(this.sessionData.achievements)}}calculateSessionAverage(){const e=this.sessionData.performanceHistory;return e.length===0?0:e.reduce((t,n)=>t+n,0)/e.length}updatePerformanceMetrics(e,t){e.components.recognitionSpeed>0&&(this.performanceMetrics.averageSpeed=(this.performanceMetrics.averageSpeed+e.components.recognitionSpeed)/2),this.performanceMetrics.accuracyTrend=t.improvement.trend,this.performanceMetrics.strengthAreas=t.strengths.map(n=>n.area),this.performanceMetrics.improvementAreas=t.weaknesses.map(n=>n.area),this.performanceMetrics.sessionProgress=Math.min(100,this.sessionData.totalAttempts/20*100)}checkAchievements(e,t){this.sessionData.totalAttempts===1&&this.sessionData.achievements.add("first_attempt"),e.total>=90&&!this.sessionData.achievements.has("high_score")&&this.sessionData.achievements.add("high_score"),e.total>=98&&!this.sessionData.achievements.has("perfect_score")&&this.sessionData.achievements.add("perfect_score"),this.sessionData.totalAttempts>=10&&!this.sessionData.achievements.has("persistent")&&this.sessionData.achievements.add("persistent"),t.improvement.trend==="improving"&&!this.sessionData.achievements.has("improving")&&this.sessionData.achievements.add("improving")}compareToAverageSpeed(e){const t=this.performanceMetrics.averageSpeed||2e3,n=e-t;return{sessionAverage:t,difference:n,comparison:n<-500?"much_faster":n<-200?"faster":n<200?"similar":n<500?"slower":"much_slower"}}getIntervalType(e,t){const s=(Math.round(12*Math.log2(t/e))%12+12)%12;return{0:"unison",1:"minorSecond",2:"majorSecond",3:"minorThird",4:"majorThird",5:"perfectFourth",6:"tritone",7:"perfectFifth",8:"minorSixth",9:"majorSixth",10:"minorSeventh",11:"majorSeventh"}[s]||"unknown"}calculateCentsDifference(e,t){return!e||!t?0:1200*Math.log2(t/e)}calculateRawAccuracy(e,t){const n=Math.abs(this.calculateCentsDifference(e,t));return Math.max(0,100-n)}recordAnalysisResult(e){this.sessionData.lastAnalysis=e}createErrorResult(e){return{timestamp:Date.now(),error:!0,message:e,score:{total:0,components:{pitchAccuracy:0,recognitionSpeed:0,intervalMastery:0,directionAccuracy:0,consistency:0},grade:"F"},performance:{level:"needs_improvement",strengths:[],weaknesses:[],improvement:{trend:"unknown",change:0}},feedback:{primary:"エラーが発生しました。もう一度お試しください。",detailed:{},recommendations:[],encouragement:"",nextSteps:""}}}logScoringDetails(e){console.group(`🎯 [EnhancedScoringEngine] 統合採点結果 #${e.sessionAttempt}`),console.log("📊 統合スコア:",{総合:`${e.score.total}点 (${e.score.grade})`,音程精度:`${e.score.components.pitchAccuracy}%`,認識速度:`${e.score.components.recognitionSpeed}%`,音程習得度:`${e.score.components.intervalMastery}%`,方向性精度:`${e.score.components.directionAccuracy}%`,一貫性:`${e.score.components.consistency}%`}),console.log("📈 パフォーマンス:",{レベル:e.performance.level,改善傾向:e.performance.improvement.trend,強み:e.performance.strengths.map(t=>t.area),弱点:e.performance.weaknesses.map(t=>t.area)}),console.log("💬 フィードバック:",{メイン:e.feedback.primary,推奨事項:e.feedback.recommendations.length}),console.log("📚 セッション:",{試行回数:e.session.attempt,平均点:e.session.sessionAverage.toFixed(1),継続時間:`${Math.round(e.session.sessionDuration/6e4)}分`}),console.groupEnd()}log(e,t=null){this.debugMode&&(t?console.log(`[EnhancedScoringEngine] ${e}`,t):console.log(`[EnhancedScoringEngine] ${e}`))}async processAttempt(e){return await this.analyzePerformance(e)}generateDetailedReport(){var h,d,p,y,b,w,E,G;const e=this.getStatistics(),t=this.sessionData,n={totalScore:t.overallScore,totalAttempts:t.totalAttempts,averageScore:t.totalAttempts>0?t.overallScore/t.totalAttempts:0,sessionDuration:Date.now()-t.startTime,level:t.currentLevel},s={intervals:e.analyzers.interval,directions:e.analyzers.direction,consistency:e.analyzers.consistency},r=this.generateImprovementSuggestions(),l={startTime:t.startTime,duration:Date.now()-t.startTime,attempts:t.totalAttempts,achievements:Array.from(t.achievements),performanceHistory:t.performanceHistory.slice(-10)},m={primary:r.length>0?r[0].message:"良好な演奏です！",detailed:r.map(v=>v.message),suggestions:r.map(v=>v.actions).flat()},c=[{label:"音程精度",value:Math.round(((h=e.analyzers.interval)==null?void 0:h.averageAccuracy)||0),weight:40},{label:"認識速度",value:Math.round(100-(e.averageResponseTime||5e3)/50),weight:20},{label:"音程習得",value:Math.round(((d=e.analyzers.interval)==null?void 0:d.masteryLevel)||0),weight:20},{label:"方向精度",value:Math.round(((p=e.analyzers.direction)==null?void 0:p.accuracy)||0),weight:10},{label:"一貫性",value:Math.round(((y=e.analyzers.consistency)==null?void 0:y.score)||0),weight:10}],a=c.reduce((v,g)=>v+g.value*g.weight/100,0);let i="C";return a>=90?i="S":a>=80?i="A":a>=70&&(i="B"),{timestamp:Date.now(),totalScore:Math.round(a),grade:i,componentScores:c,feedback:m,intervalAnalysis:{masteryLevels:((b=e.analyzers.interval)==null?void 0:b.intervalMastery)||{},attemptCounts:((w=e.analyzers.interval)==null?void 0:w.attemptCounts)||{},accuracyRates:((E=e.analyzers.interval)==null?void 0:E.accuracyRates)||{}},consistencyHistory:((G=e.analyzers.consistency)==null?void 0:G.recentScores)||[],overall:n,detailed:s,improvements:r,session:l,metadata:{version:"2.2.1-FIXED",engine:"EnhancedScoringEngine"}}}generatePerformanceRecommendation(e,t,n){const s=[];switch(e){case"excellent":s.push("素晴らしい演奏です！この精度を維持しながら、より難しい音程にチャレンジしてみましょう。");break;case"good":s.push("良好な精度です。安定した演奏を継続し、弱点分野の向上を図りましょう。");break;case"average":s.push("基本的な能力は身についています。継続的な練習で更なる向上が期待できます。");break;case"needs_improvement":s.push("基礎練習を重点的に行い、音程感覚の向上を図りましょう。");break;default:s.push("基本的な音程から段階的に練習を重ねて、音感を育てていきましょう。")}return n.includes("interval")&&s.push("音程の正確性向上のため、楽器での確認を併用した練習をお勧めします。"),n.includes("direction")&&s.push("音程の上行・下行判定の精度向上のため、音階練習を取り入れましょう。"),n.includes("consistency")&&s.push("安定した精度を保つため、集中力を維持した継続的な練習が効果的です。"),n.includes("speed")&&s.push("認識速度向上のため、短時間での集中的な判定練習を行いましょう。"),s.join(" ")}generateImprovementSuggestions(){const e=[],t=this.getStatistics();return t.analyzers.interval.averageAccuracy<70&&e.push({category:"interval",priority:"high",message:"音程の正確性向上が必要です。基本的な音程（完全5度、オクターブ）から練習を始めましょう。",actions:["基本音程の集中練習","楽器での確認","歌唱練習"]}),t.analyzers.direction.accuracy<80&&e.push({category:"direction",priority:"medium",message:"音程の上行・下行の判断精度を向上させましょう。",actions:["音階練習","聴音練習","インターバル識別"]}),t.analyzers.consistency.score<75&&e.push({category:"consistency",priority:"medium",message:"安定した精度を保つため、継続的な練習が効果的です。",actions:["定期的な練習","集中力向上","疲労管理"]}),e}getStatistics(){return{session:this.sessionData,performance:this.performanceMetrics,analyzers:{interval:this.intervalAnalyzer.getStatistics(),direction:this.directionAnalyzer.getStatistics(),consistency:this.consistencyTracker.getStatistics()},config:this.config}}updateConfig(e){this.config={...this.config,...e},this.log("⚙️ 設定更新完了",this.config)}reset(){this.intervalAnalyzer.reset(),this.directionAnalyzer.reset(),this.consistencyTracker.reset(),this.sessionData={startTime:Date.now(),totalAttempts:0,overallScore:0,performanceHistory:[],currentLevel:"beginner",achievements:new Set,lastAnalysis:null},this.performanceMetrics={averageSpeed:0,accuracyTrend:"stable",strengthAreas:[],improvementAreas:[],sessionProgress:0},this.log("🔄 EnhancedScoringEngine リセット完了")}}function lt(o,e,t){const n=o.slice();return n[96]=e[t],n[98]=t,n}function ut(o,e,t){const n=o.slice();return n[99]=e[t],n}function mt(o){var L,W,B;let e,t,n,s,r=(((L=o[23])==null?void 0:L.length)||0)+"",l,m,c,a,i,h=8-(((W=o[23])==null?void 0:W.length)||0)+"",d,p,y,b,w,E,G,v,g=Math.round((((B=o[23])==null?void 0:B.length)||0)/8*100)+"",k,H,_,te,U,V=o[0]==="results"&&ft(o);return{c(){e=$("div"),t=$("div"),n=$("div"),s=$("span"),l=J(r),m=J("/8"),c=j(),a=$("span"),i=J("残り "),d=J(h),p=J(" セッション"),y=j(),b=$("div"),w=$("div"),E=$("div"),G=j(),v=$("span"),k=J(g),H=J("%"),_=j(),V&&V.c(),te=Ae(),this.h()},l(N){e=T(N,"DIV",{class:!0});var se=x(e);t=T(se,"DIV",{class:!0});var Se=x(t);n=T(Se,"DIV",{class:!0});var re=x(n);s=T(re,"SPAN",{class:!0});var de=x(s);l=X(de,r),m=X(de,"/8"),de.forEach(D),c=q(re),a=T(re,"SPAN",{class:!0});var ae=x(a);i=X(ae,"残り "),d=X(ae,h),p=X(ae," セッション"),ae.forEach(D),re.forEach(D),y=q(Se),b=T(Se,"DIV",{class:!0});var pe=x(b);w=T(pe,"DIV",{class:!0});var Ce=x(w);E=T(Ce,"DIV",{class:!0,style:!0}),x(E).forEach(D),Ce.forEach(D),G=q(pe),v=T(pe,"SPAN",{class:!0});var Ie=x(v);k=X(Ie,g),H=X(Ie,"%"),Ie.forEach(D),pe.forEach(D),Se.forEach(D),se.forEach(D),_=q(N),V&&V.l(N),te=Ae(),this.h()},h(){var N;I(s,"class","completed-count svelte-1ktm6f3"),I(a,"class","remaining-text svelte-1ktm6f3"),I(n,"class","session-info svelte-1ktm6f3"),I(E,"class","progress-fill svelte-1ktm6f3"),ze(E,"width",(((N=o[23])==null?void 0:N.length)||0)/8*100+"%"),I(w,"class","progress-bar svelte-1ktm6f3"),I(v,"class","progress-text svelte-1ktm6f3"),I(b,"class","progress-section svelte-1ktm6f3"),I(t,"class","session-status svelte-1ktm6f3"),I(e,"class","session-progress svelte-1ktm6f3")},m(N,se){z(N,e,se),A(e,t),A(t,n),A(n,s),A(s,l),A(s,m),A(n,c),A(n,a),A(a,i),A(a,d),A(a,p),A(t,y),A(t,b),A(b,w),A(w,E),A(b,G),A(b,v),A(v,k),A(v,H),z(N,_,se),V&&V.m(N,se),z(N,te,se),U=!0},p(N,se){var Se,re,de,ae;(!U||se[0]&8388608)&&r!==(r=(((Se=N[23])==null?void 0:Se.length)||0)+"")&&$e(l,r),(!U||se[0]&8388608)&&h!==(h=8-(((re=N[23])==null?void 0:re.length)||0)+"")&&$e(d,h),(!U||se[0]&8388608)&&ze(E,"width",(((de=N[23])==null?void 0:de.length)||0)/8*100+"%"),(!U||se[0]&8388608)&&g!==(g=Math.round((((ae=N[23])==null?void 0:ae.length)||0)/8*100)+"")&&$e(k,g),N[0]==="results"?V?(V.p(N,se),se[0]&1&&F(V,1)):(V=ft(N),V.c(),F(V,1),V.m(te.parentNode,te)):V&&(we(),P(V,1,1,()=>{V=null}),ke())},i(N){U||(F(V),U=!0)},o(N){P(V),U=!1},d(N){N&&(D(e),D(_),D(te)),V&&V.d(N)}}}function ft(o){let e,t,n;return t=new $t({props:{isCompleted:o[5],position:"top"}}),t.$on("action",o[29]),{c(){e=$("div"),ue(t.$$.fragment),this.h()},l(s){e=T(s,"DIV",{class:!0});var r=x(e);le(t.$$.fragment,r),r.forEach(D),this.h()},h(){I(e,"class","top-action-buttons svelte-1ktm6f3")},m(s,r){z(s,e,r),ce(t,e,null),n=!0},p(s,r){const l={};r[0]&32&&(l.isCompleted=s[5]),t.$set(l)},i(s){n||(F(t.$$.fragment,s),n=!0)},o(s){P(t.$$.fragment,s),n=!1},d(s){s&&D(e),ie(t)}}}function Rn(o){let e,t;return e=new xe({props:{class:"error-card",$$slots:{default:[Nn]},$$scope:{ctx:o}}}),{c(){ue(e.$$.fragment)},l(n){le(e.$$.fragment,n)},m(n,s){ce(e,n,s),t=!0},p(n,s){const r={};s[3]&512&&(r.$$scope={dirty:s,ctx:n}),e.$set(r)},i(n){t||(F(e.$$.fragment,n),t=!0)},o(n){P(e.$$.fragment,n),t=!1},d(n){ie(e,n)}}}function Fn(o){let e,t,n,s,r,l,m,c={isActive:o[1]==="granted",trainingPhase:o[0],className:"pitch-detector-content",debugMode:!0,disableHarmonicCorrection:!1};t=new fn({props:c}),o[33](t),t.$on("pitchUpdate",o[28]),t.$on("stateChange",Yn),t.$on("error",Zn),t.$on("microphoneHealthChange",o[30]);let a=o[0]!=="results"&&dt(o),i=o[0]!=="results"&&yt(o),h=o[0]==="results"&&Dt(o);return{c(){e=$("div"),ue(t.$$.fragment),n=j(),a&&a.c(),s=j(),i&&i.c(),r=j(),h&&h.c(),l=Ae(),this.h()},l(d){e=T(d,"DIV",{style:!0});var p=x(e);le(t.$$.fragment,p),p.forEach(D),n=q(d),a&&a.l(d),s=q(d),i&&i.l(d),r=q(d),h&&h.l(d),l=Ae(),this.h()},h(){ze(e,"display","none")},m(d,p){z(d,e,p),ce(t,e,null),z(d,n,p),a&&a.m(d,p),z(d,s,p),i&&i.m(d,p),z(d,r,p),h&&h.m(d,p),z(d,l,p),m=!0},p(d,p){const y={};p[0]&2&&(y.isActive=d[1]==="granted"),p[0]&1&&(y.trainingPhase=d[0]),t.$set(y),d[0]!=="results"?a?(a.p(d,p),p[0]&1&&F(a,1)):(a=dt(d),a.c(),F(a,1),a.m(s.parentNode,s)):a&&(we(),P(a,1,1,()=>{a=null}),ke()),d[0]!=="results"?i?(i.p(d,p),p[0]&1&&F(i,1)):(i=yt(d),i.c(),F(i,1),i.m(r.parentNode,r)):i&&(we(),P(i,1,1,()=>{i=null}),ke()),d[0]==="results"?h?(h.p(d,p),p[0]&1&&F(h,1)):(h=Dt(d),h.c(),F(h,1),h.m(l.parentNode,l)):h&&(we(),P(h,1,1,()=>{h=null}),ke())},i(d){m||(F(t.$$.fragment,d),F(a),F(i),F(h),m=!0)},o(d){P(t.$$.fragment,d),P(a),P(i),P(h),m=!1},d(d){d&&(D(e),D(n),D(s),D(r),D(l)),o[33](null),ie(t),a&&a.d(d),i&&i.d(d),h&&h.d(d)}}}function zn(o){let e;return{c(){e=J("🎤 マイクテストページへ移動")},l(t){e=X(t,"🎤 マイクテストページへ移動")},m(t,n){z(t,e,n)},d(t){t&&D(e)}}}function Hn(o){let e;return{c(){e=J("🏠 ホームに戻る")},l(t){e=X(t,"🏠 ホームに戻る")},m(t,n){z(t,e,n)},d(t){t&&D(e)}}}function Nn(o){let e,t,n="🎤",s,r,l="マイクテストが必要です",m,c,a="ランダム基音トレーニングを開始する前に、マイクテストページで音声入力の確認をお願いします。",i,h,d='<p class="svelte-1ktm6f3">このページは<strong>マイクテスト完了後</strong>にご利用いただけます。</p> <p class="svelte-1ktm6f3">まずはマイクテストページで音声確認を行ってください。</p>',p,y,b,w,E,G;return b=new Ke({props:{variant:"primary",$$slots:{default:[zn]},$$scope:{ctx:o}}}),b.$on("click",o[26]),E=new Ke({props:{variant:"secondary",$$slots:{default:[Hn]},$$scope:{ctx:o}}}),E.$on("click",o[27]),{c(){e=$("div"),t=$("div"),t.textContent=n,s=j(),r=$("h3"),r.textContent=l,m=j(),c=$("p"),c.textContent=a,i=j(),h=$("div"),h.innerHTML=d,p=j(),y=$("div"),ue(b.$$.fragment),w=j(),ue(E.$$.fragment),this.h()},l(v){e=T(v,"DIV",{class:!0});var g=x(e);t=T(g,"DIV",{class:!0,"data-svelte-h":!0}),ge(t)!=="svelte-15rbx8n"&&(t.textContent=n),s=q(g),r=T(g,"H3",{class:!0,"data-svelte-h":!0}),ge(r)!=="svelte-17kvze2"&&(r.textContent=l),m=q(g),c=T(g,"P",{class:!0,"data-svelte-h":!0}),ge(c)!=="svelte-12s9olt"&&(c.textContent=a),i=q(g),h=T(g,"DIV",{class:!0,"data-svelte-h":!0}),ge(h)!=="svelte-13ge0u9"&&(h.innerHTML=d),p=q(g),y=T(g,"DIV",{class:!0});var k=x(y);le(b.$$.fragment,k),w=q(k),le(E.$$.fragment,k),k.forEach(D),g.forEach(D),this.h()},h(){I(t,"class","error-icon svelte-1ktm6f3"),I(r,"class","svelte-1ktm6f3"),I(c,"class","svelte-1ktm6f3"),I(h,"class","recommendation svelte-1ktm6f3"),I(y,"class","action-buttons"),I(e,"class","error-content svelte-1ktm6f3")},m(v,g){z(v,e,g),A(e,t),A(e,s),A(e,r),A(e,m),A(e,c),A(e,i),A(e,h),A(e,p),A(e,y),ce(b,y,null),A(y,w),ce(E,y,null),G=!0},p(v,g){const k={};g[3]&512&&(k.$$scope={dirty:g,ctx:v}),b.$set(k);const H={};g[3]&512&&(H.$$scope={dirty:g,ctx:v}),E.$set(H)},i(v){G||(F(b.$$.fragment,v),F(E.$$.fragment,v),G=!0)},o(v){P(b.$$.fragment,v),P(E.$$.fragment,v),G=!1},d(v){v&&D(e),ie(b),ie(E)}}}function dt(o){let e,t,n,s,r,l,m=!o[2]&&o[6].length>0&&ht(o);return n=new xe({props:{class:"main-card half-width",$$slots:{default:[Vn]},$$scope:{ctx:o}}}),r=new dn({props:{frequency:o[14],note:o[15],volume:o[13],isMuted:o[0]!=="guiding",muteMessage:"基音再生後に開始",className:"half-width",showGuidance:!1}}),{c(){m&&m.c(),e=j(),t=$("div"),ue(n.$$.fragment),s=j(),ue(r.$$.fragment),this.h()},l(c){m&&m.l(c),e=q(c),t=T(c,"DIV",{class:!0});var a=x(t);le(n.$$.fragment,a),s=q(a),le(r.$$.fragment,a),a.forEach(D),this.h()},h(){I(t,"class","side-by-side-container svelte-1ktm6f3")},m(c,a){m&&m.m(c,a),z(c,e,a),z(c,t,a),ce(n,t,null),A(t,s),ce(r,t,null),l=!0},p(c,a){!c[2]&&c[6].length>0?m?(m.p(c,a),a[0]&68&&F(m,1)):(m=ht(c),m.c(),F(m,1),m.m(e.parentNode,e)):m&&(we(),P(m,1,1,()=>{m=null}),ke());const i={};a[0]&7041|a[3]&512&&(i.$$scope={dirty:a,ctx:c}),n.$set(i);const h={};a[0]&16384&&(h.frequency=c[14]),a[0]&32768&&(h.note=c[15]),a[0]&8192&&(h.volume=c[13]),a[0]&1&&(h.isMuted=c[0]!=="guiding"),r.$set(h)},i(c){l||(F(m),F(n.$$.fragment,c),F(r.$$.fragment,c),l=!0)},o(c){P(m),P(n.$$.fragment,c),P(r.$$.fragment,c),l=!1},d(c){c&&(D(e),D(t)),m&&m.d(c),ie(n),ie(r)}}}function ht(o){let e,t;return e=new xe({props:{class:"warning-card",$$slots:{default:[Pn]},$$scope:{ctx:o}}}),{c(){ue(e.$$.fragment)},l(n){le(e.$$.fragment,n)},m(n,s){ce(e,n,s),t=!0},p(n,s){const r={};s[0]&64|s[3]&512&&(r.$$scope={dirty:s,ctx:n}),e.$set(r)},i(n){t||(F(e.$$.fragment,n),t=!0)},o(n){P(e.$$.fragment,n),t=!1},d(n){ie(e,n)}}}function gt(o){let e,t=o[99]+"",n;return{c(){e=$("li"),n=J(t),this.h()},l(s){e=T(s,"LI",{class:!0});var r=x(e);n=X(r,t),r.forEach(D),this.h()},h(){I(e,"class","svelte-1ktm6f3")},m(s,r){z(s,e,r),A(e,n)},p(s,r){r[0]&64&&t!==(t=s[99]+"")&&$e(n,t)},d(s){s&&D(e)}}}function Pn(o){let e,t='<h3 class="section-title svelte-1ktm6f3">⚠️ マイク接続に問題があります</h3>',n,s,r,l="マイクが正常に動作していません。以下の問題が検出されました：",m,c,a,i,h="<strong>解決方法:</strong> ページを再読み込みしてマイク許可を再度取得してください。",d=We(o[6]),p=[];for(let y=0;y<d.length;y+=1)p[y]=gt(ut(o,d,y));return{c(){e=$("div"),e.innerHTML=t,n=j(),s=$("div"),r=$("p"),r.textContent=l,m=j(),c=$("ul");for(let y=0;y<p.length;y+=1)p[y].c();a=j(),i=$("p"),i.innerHTML=h,this.h()},l(y){e=T(y,"DIV",{class:!0,"data-svelte-h":!0}),ge(e)!=="svelte-1mob8td"&&(e.innerHTML=t),n=q(y),s=T(y,"DIV",{class:!0});var b=x(s);r=T(b,"P",{class:!0,"data-svelte-h":!0}),ge(r)!=="svelte-171o2p0"&&(r.textContent=l),m=q(b),c=T(b,"UL",{class:!0});var w=x(c);for(let E=0;E<p.length;E+=1)p[E].l(w);w.forEach(D),a=q(b),i=T(b,"P",{class:!0,"data-svelte-h":!0}),ge(i)!=="svelte-1o4df0k"&&(i.innerHTML=h),b.forEach(D),this.h()},h(){I(e,"class","card-header svelte-1ktm6f3"),I(r,"class","warning-message svelte-1ktm6f3"),I(c,"class","error-list svelte-1ktm6f3"),I(i,"class","fix-instruction svelte-1ktm6f3"),I(s,"class","card-content svelte-1ktm6f3")},m(y,b){z(y,e,b),z(y,n,b),z(y,s,b),A(s,r),A(s,m),A(s,c);for(let w=0;w<p.length;w+=1)p[w]&&p[w].m(c,null);A(s,a),A(s,i)},p(y,b){if(b[0]&64){d=We(y[6]);let w;for(w=0;w<d.length;w+=1){const E=ut(y,d,w);p[w]?p[w].p(E,b):(p[w]=gt(E),p[w].c(),p[w].m(c,null))}for(;w<p.length;w+=1)p[w].d(1);p.length=d.length}},d(y){y&&(D(e),D(n),D(s)),Ct(p,y)}}}function Ln(o){let e;return{c(){e=J("🎹 ランダム基音再生")},l(t){e=X(t,"🎹 ランダム基音再生")},m(t,n){z(t,e,n)},p:Tt,d(t){t&&D(e)}}}function xn(o){let e,t,n;return{c(){e=J("🔄 "),t=J(o[7]),n=J(" 再生")},l(s){e=X(s,"🔄 "),t=X(s,o[7]),n=X(s," 再生")},m(s,r){z(s,e,r),z(s,t,r),z(s,n,r)},p(s,r){r[0]&128&&$e(t,s[7])},d(s){s&&(D(e),D(t),D(n))}}}function qn(o){let e;return{c(){e=J("🎵 再生中...")},l(t){e=X(t,"🎵 再生中...")},m(t,n){z(t,e,n)},p:Tt,d(t){t&&D(e)}}}function jn(o){let e;function t(r,l){return r[9]?qn:r[7]&&r[8]>0?xn:Ln}let n=t(o),s=n(o);return{c(){s.c(),e=Ae()},l(r){s.l(r),e=Ae()},m(r,l){s.m(r,l),z(r,e,l)},p(r,l){n===(n=t(r))&&s?s.p(r,l):(s.d(1),s=n(r),s&&(s.c(),s.m(e.parentNode,e)))},d(r){r&&D(e),s.d(r)}}}function pt(o){let e,t,n,s,r,l=o[8].toFixed(1)+"",m,c;return{c(){e=$("div"),t=J("現在の基音: "),n=$("strong"),s=J(o[7]),r=J(" ("),m=J(l),c=J("Hz)"),this.h()},l(a){e=T(a,"DIV",{class:!0});var i=x(e);t=X(i,"現在の基音: "),n=T(i,"STRONG",{});var h=x(n);s=X(h,o[7]),h.forEach(D),r=X(i," ("),m=X(i,l),c=X(i,"Hz)"),i.forEach(D),this.h()},h(){I(e,"class","base-note-info svelte-1ktm6f3")},m(a,i){z(a,e,i),A(e,t),A(e,n),A(n,s),A(e,r),A(e,m),A(e,c)},p(a,i){i[0]&128&&$e(s,a[7]),i[0]&256&&l!==(l=a[8].toFixed(1)+"")&&$e(m,l)},d(a){a&&D(e)}}}function Vn(o){let e,t='<h3 class="section-title svelte-1ktm6f3">🎹 基音再生</h3>',n,s,r,l,m,c,a,i="ガイド開始まで",h,d,p,y,b,w,E,G;r=new Ke({props:{variant:"primary",disabled:o[9]||o[0]==="guiding"||o[0]==="waiting",$$slots:{default:[jn]},$$scope:{ctx:o}}}),r.$on("click",o[25]);let v=o[7]&&pt(o);return w=new gn({props:{size:"20"}}),{c(){e=$("div"),e.innerHTML=t,n=j(),s=$("div"),ue(r.$$.fragment),l=j(),v&&v.c(),m=j(),c=$("div"),a=$("div"),a.textContent=i,h=j(),d=$("div"),p=$("div"),y=j(),b=$("div"),ue(w.$$.fragment),this.h()},l(g){e=T(g,"DIV",{class:!0,"data-svelte-h":!0}),ge(e)!=="svelte-o46h1v"&&(e.innerHTML=t),n=q(g),s=T(g,"DIV",{class:!0});var k=x(s);le(r.$$.fragment,k),l=q(k),v&&v.l(k),m=q(k),c=T(k,"DIV",{class:!0});var H=x(c);a=T(H,"DIV",{class:!0,"data-svelte-h":!0}),ge(a)!=="svelte-1dufnpv"&&(a.textContent=i),h=q(H),d=T(H,"DIV",{class:!0});var _=x(d);p=T(_,"DIV",{class:!0,style:!0}),x(p).forEach(D),y=q(_),b=T(_,"DIV",{class:!0});var te=x(b);le(w.$$.fragment,te),te.forEach(D),_.forEach(D),H.forEach(D),k.forEach(D),this.h()},h(){I(e,"class","card-header svelte-1ktm6f3"),I(a,"class","guide-start-label svelte-1ktm6f3"),I(p,"class","guide-progress-fill svelte-1ktm6f3"),ze(p,"width",o[11]+"%"),I(b,"class",E="guide-music-icon "+(o[12]?"glowing":"")+" svelte-1ktm6f3"),I(d,"class","guide-start-bar svelte-1ktm6f3"),I(c,"class","guide-start-bar-container svelte-1ktm6f3"),I(s,"class","card-content svelte-1ktm6f3")},m(g,k){z(g,e,k),z(g,n,k),z(g,s,k),ce(r,s,null),A(s,l),v&&v.m(s,null),A(s,m),A(s,c),A(c,a),A(c,h),A(c,d),A(d,p),A(d,y),A(d,b),ce(w,b,null),G=!0},p(g,k){const H={};k[0]&513&&(H.disabled=g[9]||g[0]==="guiding"||g[0]==="waiting"),k[0]&896|k[3]&512&&(H.$$scope={dirty:k,ctx:g}),r.$set(H),g[7]?v?v.p(g,k):(v=pt(g),v.c(),v.m(s,m)):v&&(v.d(1),v=null),(!G||k[0]&2048)&&ze(p,"width",g[11]+"%"),(!G||k[0]&4096&&E!==(E="guide-music-icon "+(g[12]?"glowing":"")+" svelte-1ktm6f3"))&&I(b,"class",E)},i(g){G||(F(r.$$.fragment,g),F(w.$$.fragment,g),G=!0)},o(g){P(r.$$.fragment,g),P(w.$$.fragment,g),G=!1},d(g){g&&(D(e),D(n),D(s)),ie(r),v&&v.d(),ie(w)}}}function yt(o){let e,t;return e=new xe({props:{class:"main-card",$$slots:{default:[Bn]},$$scope:{ctx:o}}}),{c(){ue(e.$$.fragment)},l(n){le(e.$$.fragment,n)},m(n,s){ce(e,n,s),t=!0},p(n,s){const r={};s[0]&1025|s[3]&512&&(r.$$scope={dirty:s,ctx:n}),e.$set(r)},i(n){t||(F(e.$$.fragment,n),t=!0)},o(n){P(e.$$.fragment,n),t=!1},d(n){ie(e,n)}}}function vt(o){let e,t=o[96].name+"",n,s,r;return{c(){e=$("div"),n=J(t),s=j(),this.h()},l(l){e=T(l,"DIV",{class:!0});var m=x(e);n=X(m,t),s=q(m),m.forEach(D),this.h()},h(){I(e,"class",r="scale-item "+o[96].state+" svelte-1ktm6f3")},m(l,m){z(l,e,m),A(e,n),A(e,s)},p(l,m){m[0]&1024&&t!==(t=l[96].name+"")&&$e(n,t),m[0]&1024&&r!==(r="scale-item "+l[96].state+" svelte-1ktm6f3")&&I(e,"class",r)},d(l){l&&D(e)}}}function St(o){let e,t="ガイドに合わせて <strong>ドレミファソラシド</strong> を歌ってください";return{c(){e=$("div"),e.innerHTML=t,this.h()},l(n){e=T(n,"DIV",{class:!0,"data-svelte-h":!0}),ge(e)!=="svelte-sgc3nk"&&(e.innerHTML=t),this.h()},h(){I(e,"class","guide-instruction svelte-1ktm6f3")},m(n,s){z(n,e,s)},d(n){n&&D(e)}}}function Bn(o){let e,t='<h3 class="section-title svelte-1ktm6f3">🎵 ドレミ音階ガイド</h3>',n,s,r,l,m=We(o[10]),c=[];for(let i=0;i<m.length;i+=1)c[i]=vt(lt(o,m,i));let a=o[0]==="guiding"&&St();return{c(){e=$("div"),e.innerHTML=t,n=j(),s=$("div"),r=$("div");for(let i=0;i<c.length;i+=1)c[i].c();l=j(),a&&a.c(),this.h()},l(i){e=T(i,"DIV",{class:!0,"data-svelte-h":!0}),ge(e)!=="svelte-z1jpw4"&&(e.innerHTML=t),n=q(i),s=T(i,"DIV",{class:!0});var h=x(s);r=T(h,"DIV",{class:!0});var d=x(r);for(let p=0;p<c.length;p+=1)c[p].l(d);d.forEach(D),l=q(h),a&&a.l(h),h.forEach(D),this.h()},h(){I(e,"class","card-header svelte-1ktm6f3"),I(r,"class","scale-guide svelte-1ktm6f3"),I(s,"class","card-content svelte-1ktm6f3")},m(i,h){z(i,e,h),z(i,n,h),z(i,s,h),A(s,r);for(let d=0;d<c.length;d+=1)c[d]&&c[d].m(r,null);A(s,l),a&&a.m(s,null)},p(i,h){if(h[0]&1024){m=We(i[10]);let d;for(d=0;d<m.length;d+=1){const p=lt(i,m,d);c[d]?c[d].p(p,h):(c[d]=vt(p),c[d].c(),c[d].m(r,null))}for(;d<c.length;d+=1)c[d].d(1);c.length=m.length}i[0]==="guiding"?a||(a=St(),a.c(),a.m(s,null)):a&&(a.d(1),a=null)},d(i){i&&(D(e),D(n),D(s)),Ct(c,i),a&&a.d()}}}function Dt(o){let e,t,n,s,r;const l=[Gn,On],m=[];function c(i,h){return i[4]&&i[5]?0:i[21]?1:-1}~(e=c(o))&&(t=m[e]=l[e](o));let a=o[0]==="results"&&bt(o);return{c(){t&&t.c(),n=j(),a&&a.c(),s=Ae()},l(i){t&&t.l(i),n=q(i),a&&a.l(i),s=Ae()},m(i,h){~e&&m[e].m(i,h),z(i,n,h),a&&a.m(i,h),z(i,s,h),r=!0},p(i,h){let d=e;e=c(i),e===d?~e&&m[e].p(i,h):(t&&(we(),P(m[d],1,1,()=>{m[d]=null}),ke()),~e?(t=m[e],t?t.p(i,h):(t=m[e]=l[e](i),t.c()),F(t,1),t.m(n.parentNode,n)):t=null),i[0]==="results"?a?(a.p(i,h),h[0]&1&&F(a,1)):(a=bt(i),a.c(),F(a,1),a.m(s.parentNode,s)):a&&(we(),P(a,1,1,()=>{a=null}),ke())},i(i){r||(F(t),F(a),r=!0)},o(i){P(t),P(a),r=!1},d(i){i&&(D(n),D(s)),~e&&m[e].d(i),a&&a.d(i)}}}function On(o){let e,t;return e=new It({props:{scoreData:o[21],showDetails:!1,className:"mb-6 iphone-no-margin",currentScoreData:o[16],intervalData:o[3],consistencyData:o[17],feedbackData:o[18],technicalFeedbackData:o[19],sessionStatistics:o[20]}}),{c(){ue(e.$$.fragment)},l(n){le(e.$$.fragment,n)},m(n,s){ce(e,n,s),t=!0},p(n,s){const r={};s[0]&2097152&&(r.scoreData=n[21]),s[0]&65536&&(r.currentScoreData=n[16]),s[0]&8&&(r.intervalData=n[3]),s[0]&131072&&(r.consistencyData=n[17]),s[0]&262144&&(r.feedbackData=n[18]),s[0]&524288&&(r.technicalFeedbackData=n[19]),s[0]&1048576&&(r.sessionStatistics=n[20]),e.$set(r)},i(n){t||(F(e.$$.fragment,n),t=!0)},o(n){P(e.$$.fragment,n),t=!1},d(n){ie(e,n)}}}function Gn(o){let e,t;return e=new It({props:{scoreData:o[4],showDetails:!1,className:"mb-6 iphone-no-margin",currentScoreData:o[16],intervalData:o[3],consistencyData:o[17],feedbackData:o[18],technicalFeedbackData:o[19],sessionStatistics:o[20]}}),{c(){ue(e.$$.fragment)},l(n){le(e.$$.fragment,n)},m(n,s){ce(e,n,s),t=!0},p(n,s){const r={};s[0]&16&&(r.scoreData=n[4]),s[0]&65536&&(r.currentScoreData=n[16]),s[0]&8&&(r.intervalData=n[3]),s[0]&131072&&(r.consistencyData=n[17]),s[0]&262144&&(r.feedbackData=n[18]),s[0]&524288&&(r.technicalFeedbackData=n[19]),s[0]&1048576&&(r.sessionStatistics=n[20]),e.$set(r)},i(n){t||(F(e.$$.fragment,n),t=!0)},o(n){P(e.$$.fragment,n),t=!1},d(n){ie(e,n)}}}function bt(o){let e,t;return e=new xe({props:{class:"main-card bottom-action-card",$$slots:{default:[Wn]},$$scope:{ctx:o}}}),{c(){ue(e.$$.fragment)},l(n){le(e.$$.fragment,n)},m(n,s){ce(e,n,s),t=!0},p(n,s){const r={};s[0]&32|s[3]&512&&(r.$$scope={dirty:s,ctx:n}),e.$set(r)},i(n){t||(F(e.$$.fragment,n),t=!0)},o(n){P(e.$$.fragment,n),t=!1},d(n){ie(e,n)}}}function Wn(o){let e,t,n;return t=new $t({props:{isCompleted:o[5],position:"bottom"}}),t.$on("action",o[29]),{c(){e=$("div"),ue(t.$$.fragment),this.h()},l(s){e=T(s,"DIV",{class:!0});var r=x(e);le(t.$$.fragment,r),r.forEach(D),this.h()},h(){I(e,"class","card-content svelte-1ktm6f3")},m(s,r){z(s,e,r),ce(t,e,null),n=!0},p(s,r){const l={};r[0]&32&&(l.isCompleted=s[5]),t.$set(l)},i(s){n||(F(t.$$.fragment,s),n=!0)},o(s){P(t.$$.fragment,s),n=!1},d(s){s&&D(e),ie(t)}}}function Un(o){let e,t,n="🎵 ランダム基音トレーニング",s,r,l="10種類の基音からランダムに選択してドレミファソラシドを練習",m,c,a,i,h,d,p,y,b,w,E,G,v,g,k,H,_=o[1]==="granted"&&!o[24]&&mt(o);const te=[Fn,Rn],U=[];function V(L,W){return L[1]==="granted"?0:1}return v=V(o),g=U[v]=te[v](o),{c(){e=$("div"),t=$("h1"),t.textContent=n,s=j(),r=$("p"),r.textContent=l,m=j(),_&&_.c(),c=j(),a=$("div"),i=J("📱 "),h=J(At),d=J(" | "),p=J(_t),y=$("br"),b=j(),w=$("small"),E=J(Mt),G=j(),g.c(),k=Ae(),this.h()},l(L){e=T(L,"DIV",{class:!0});var W=x(e);t=T(W,"H1",{class:!0,"data-svelte-h":!0}),ge(t)!=="svelte-1ptm9zr"&&(t.textContent=n),s=q(W),r=T(W,"P",{class:!0,"data-svelte-h":!0}),ge(r)!=="svelte-19nes7"&&(r.textContent=l),m=q(W),_&&_.l(W),c=q(W),a=T(W,"DIV",{class:!0});var B=x(a);i=X(B,"📱 "),h=X(B,At),d=X(B," | "),p=X(B,_t),y=T(B,"BR",{}),b=q(B),w=T(B,"SMALL",{style:!0});var N=x(w);E=X(N,Mt),N.forEach(D),B.forEach(D),W.forEach(D),G=q(L),g.l(L),k=Ae(),this.h()},h(){I(t,"class","page-title svelte-1ktm6f3"),I(r,"class","page-description svelte-1ktm6f3"),ze(w,"font-size","0.6rem"),I(a,"class","debug-info svelte-1ktm6f3"),I(e,"class","header-section svelte-1ktm6f3")},m(L,W){z(L,e,W),A(e,t),A(e,s),A(e,r),A(e,m),_&&_.m(e,null),A(e,c),A(e,a),A(a,i),A(a,h),A(a,d),A(a,p),A(a,y),A(a,b),A(a,w),A(w,E),z(L,G,W),U[v].m(L,W),z(L,k,W),H=!0},p(L,W){L[1]==="granted"&&!L[24]?_?(_.p(L,W),W[0]&16777218&&F(_,1)):(_=mt(L),_.c(),F(_,1),_.m(e,c)):_&&(we(),P(_,1,1,()=>{_=null}),ke());let B=v;v=V(L),v===B?U[v].p(L,W):(we(),P(U[B],1,1,()=>{U[B]=null}),ke(),g=U[v],g?g.p(L,W):(g=U[v]=te[v](L),g.c()),F(g,1),g.m(k.parentNode,k))},i(L){H||(F(_),F(g),H=!0)},o(L){P(_),P(g),H=!1},d(L){L&&(D(e),D(G),D(k)),_&&_.d(),U[v].d(L)}}}function Xn(o){let e,t;return e=new mn({props:{$$slots:{default:[Un]},$$scope:{ctx:o}}}),{c(){ue(e.$$.fragment)},l(n){le(e.$$.fragment,n)},m(n,s){ce(e,n,s),t=!0},p(n,s){const r={};s[0]&33554431|s[3]&512&&(r.$$scope={dirty:s,ctx:n}),e.$set(r)},i(n){t||(F(e.$$.fragment,n),t=!0)},o(n){P(e.$$.fragment,n),t=!1},d(n){ie(e,n)}}}const At="v2.3.1-ANIMATED",_t="07/29 04:15",Mt="🎬 評価分布アニメーション実装・UX向上";function Jn(){const o=/iPhone/.test(navigator.userAgent),e=/iPad/.test(navigator.userAgent),t=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document;return o||e||t?(console.log("🔊 [RandomTraining] iOS/iPadOS検出 - 音量35dB設定"),35):(console.log("🔊 [RandomTraining] PC検出 - 音量-6dB設定"),-6)}function wt(o){return[{scale:"ド",interval:"unison",intervalName:"ユニゾン"},{scale:"レ",interval:"major_second",intervalName:"長2度"},{scale:"ミ",interval:"major_third",intervalName:"長3度"},{scale:"ファ",interval:"perfect_fourth",intervalName:"完全4度"},{scale:"ソ",interval:"perfect_fifth",intervalName:"完全5度"},{scale:"ラ",interval:"major_sixth",intervalName:"長6度"},{scale:"シ",interval:"major_seventh",intervalName:"長7度"},{scale:"ド（高）",interval:"octave",intervalName:"オクターブ"}].map((t,n)=>{const s=o.find(r=>r.targetNote&&r.targetNote.includes(t.scale))||o[n];if(s&&s.accuracy!=="notMeasured"){const r=parseFloat(s.accuracy)||0,l=Math.round((100-r)*.5);return{type:t.interval,scale:t.scale,intervalName:t.intervalName,attempts:1,averageError:l,accuracy:r}}else return{type:t.interval,scale:t.scale,intervalName:t.intervalName,attempts:0,averageError:null,accuracy:0}})}function Kn(o){if(!o||!Array.isArray(o))return console.warn("⚠️ [RandomTraining] sessionHistory が無効です"),[];const e=[{type:"unison",scale:"ド",intervalName:"ユニゾン",noteIndex:0},{type:"major_second",scale:"レ",intervalName:"長2度",noteIndex:1},{type:"major_third",scale:"ミ",intervalName:"長3度",noteIndex:2},{type:"perfect_fourth",scale:"ファ",intervalName:"完全4度",noteIndex:3},{type:"perfect_fifth",scale:"ソ",intervalName:"完全5度",noteIndex:4},{type:"major_sixth",scale:"ラ",intervalName:"長6度",noteIndex:5},{type:"major_seventh",scale:"シ",intervalName:"長7度",noteIndex:6},{type:"octave",scale:"ド（高）",intervalName:"オクターブ",noteIndex:7}],t={};return e.forEach(n=>{t[n.type]={type:n.type,scale:n.scale,intervalName:n.intervalName,attempts:0,successCount:0,accuracySum:0,accuracyValues:[],errorValues:[]}}),o.forEach(n=>{!n.noteResults||!Array.isArray(n.noteResults)||n.noteResults.forEach((s,r)=>{if(r>=e.length)return;const l=e[r].type,m=t[l];if(m.attempts++,s.accuracy!=="notMeasured"&&typeof s.accuracy=="number"){m.accuracyValues.push(s.accuracy),m.accuracySum+=s.accuracy;const c=Math.round((100-s.accuracy)*.5);m.errorValues.push(c),s.accuracy>=70&&m.successCount++}})}),e.map(n=>{const s=t[n.type];if(s.attempts===0)return{type:n.type,scale:n.scale,intervalName:n.intervalName,attempts:0,averageError:null,accuracy:0};const r=s.accuracyValues.length>0?Math.round(s.accuracySum/s.accuracyValues.length):0,l=s.errorValues.length>0?Math.round(s.errorValues.reduce((c,a)=>c+a,0)/s.errorValues.length):null,m=s.accuracyValues.length>0?Math.round(s.successCount/s.accuracyValues.length*100):0;return{type:n.type,scale:n.scale,intervalName:n.intervalName,mastery:m,attempts:s.attempts,averageError:l,accuracy:r}})}function Qn(o){const e=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(o<=0)return"ーー";const n=Math.round(12*Math.log2(o/440)),s=(n+9+120)%12,r=Math.floor((n+9)/12)+4;return e[s]+r}function kt(o,e){const t=[{factor:4,freq:o*4,description:"2オクターブ上"},{factor:3,freq:o*3,description:"1.5オクターブ上"},{factor:2.5,freq:o*2.5,description:"1.3オクターブ上"},{factor:2,freq:o*2,description:"1オクターブ上"},{factor:1.5,freq:o*1.5,description:"0.5オクターブ上"},{factor:1,freq:o,description:"補正なし"},{factor:.75,freq:o*.75,description:"0.33オクターブ下"},{factor:.67,freq:o*.67,description:"0.5オクターブ下"},{factor:.5,freq:o*.5,description:"1オクターブ下"},{factor:.4,freq:o*.4,description:"1.3オクターブ下"},{factor:.33,freq:o*.33,description:"1.5オクターブ下"},{factor:.25,freq:o*.25,description:"2オクターブ下"}];let n=null,s=1/0;const r=e*.5,l=e*1.5,m=t.filter(c=>c.freq>=r&&c.freq<=l);for(const c of m){const a=Math.abs(c.freq-e);a<s&&(s=a,n=c)}if(!n)for(const c of t){const a=Math.abs(c.freq-e);a<s&&(s=a,n=c)}return n?{correctedFrequency:n.freq,factor:n.factor,description:n.description,error:s}:{correctedFrequency:o,factor:1,description:"補正なし（フォールバック）",error:Math.abs(o-e)}}function Ge(){try{"scrollTo"in window&&"behavior"in document.documentElement.style?window.scrollTo({top:0,behavior:"smooth"}):window.scrollTo(0,0),document.body&&(document.body.scrollTop=0),document.documentElement&&(document.documentElement.scrollTop=0),document.querySelectorAll("[data-scroll-container], .scroll-container, main").forEach(e=>{e.scrollTo?e.scrollTo(0,0):e.scrollTop=0})}catch(o){console.warn("スクロールエラー:",o);try{window.scroll(0,0)}catch(e){console.error("スクロール完全失敗:",e)}}}function Yn(o){}function Zn(o){console.error("❌ PitchDetectorエラー:",o.detail)}function es(o,e,t){let n,s,r,l,m,c,a,i,h,d;be(o,yn,u=>t(4,n=u)),be(o,vn,u=>t(5,s=u)),be(o,un,u=>t(52,r=u)),be(o,Sn,u=>t(53,l=u)),be(o,Dn,u=>t(54,m=u)),be(o,bn,u=>t(55,c=u)),be(o,An,u=>t(56,a=u)),be(o,_n,u=>t(23,i=u)),be(o,Mn,u=>t(57,h=u)),be(o,wn,u=>t(24,d=u));function p(u){return Oe.evaluateOverall(u)}let y="setup",b=typeof window<"u"?new URLSearchParams(window.location.search).get("from")==="microphone-test"?(ee.info("[RandomTraining] マイクテストページからの遷移を検出"),"granted"):(ee.info("[RandomTraining] ダイレクトアクセスを検出"),"checking"):"checking",w=!0,E=[];const G=["ド","レ","ミ","ファ","ソ","ラ","シ","ド（高）"];let v="",g=0,k=!1,H=0,_=G.map(u=>({name:u,state:"inactive",completed:!1})),te=null,U=!1,V=0,L=null,W=!1,B=[],N=0,se=0,Se="ーー",re=null,de={totalScore:0,grade:"C",componentScores:{pitchAccuracy:0,recognitionSpeed:0,intervalMastery:0,directionAccuracy:0,consistency:0}},ae=[],pe=[],Ce={},Ie={},Te={totalAttempts:0,successRate:0,averageScore:0,bestScore:0,sessionDuration:0,streakCount:0,fatigueLevel:"fresh",mostDifficultInterval:"-",mostSuccessfulInterval:"-",averageResponseTime:0,sessionStart:Date.now()},K=[],ne=null,_e=null,Re=!0,oe=null,Ee=null,Qe=null,Ye=null,qe=null;const He=[{note:"C4",name:"ド（中）",frequency:261.63,semitonesFromC:0},{note:"Db4",name:"ド#（中）",frequency:277.18,semitonesFromC:1},{note:"D4",name:"レ（中）",frequency:293.66,semitonesFromC:2},{note:"Eb4",name:"レ#（中）",frequency:311.13,semitonesFromC:3},{note:"E4",name:"ミ（中）",frequency:329.63,semitonesFromC:4},{note:"F4",name:"ファ（中）",frequency:349.23,semitonesFromC:5},{note:"Gb4",name:"ファ#（中）",frequency:369.99,semitonesFromC:6},{note:"Ab4",name:"ラb（中）",frequency:415.3,semitonesFromC:8},{note:"Bb3",name:"シb（低）",frequency:233.08,semitonesFromC:-2},{note:"B3",name:"シ（低）",frequency:246.94,semitonesFromC:-1}];async function Ne(){var u;t(1,b="checking");try{if(console.log("🎤 [RandomTraining] AudioManager経由でマイク許可確認開始"),!((u=navigator.mediaDevices)!=null&&u.getUserMedia)){t(1,b="error");return}const f=await Fe.initialize();Qe=f.audioContext,Ee=f.mediaStream,Ye=f.sourceNode,console.log("✅ [RandomTraining] AudioManager リソース取得完了"),t(1,b="granted"),t(0,y="setup"),setTimeout(async()=>{if(oe){ee.audio("[RandomTraining] PitchDetector初期化開始");const S=/iPhone/.test(navigator.userAgent),M=/iPad/.test(navigator.userAgent),C=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document;(M||C)&&(console.log("🔧 [RandomTraining] iPad検出 - マイク感度7.0x自動設定開始"),Fe.setSensitivity(7),console.log("✅ [RandomTraining] iPad マイク感度7.0x自動設定完了"));try{console.log("🎤 [RandomTraining] AudioManager再初期化開始（iPad対応）"),await Fe.initialize(),console.log("✅ [RandomTraining] AudioManager再初期化完了")}catch(R){console.warn("⚠️ AudioManager再初期化エラー:",R)}await oe.initialize(),ee.audio("[RandomTraining] PitchDetector初期化完了")}},200)}catch(f){ee.error("[RandomTraining] マイク許可エラー:",f),t(1,b=(f==null?void 0:f.name)==="NotAllowedError"?"denied":"error")}}function Ze(){const u=a,f=c,S=He.find(M=>M.note===u)||He.find(M=>M.name===f)||He[0];if(t(7,v=S.name),t(8,g=S.frequency),ee.info(`[BaseNote] 基音設定（localStorage連携）: ${v} = ${g}Hz`),ee.info(`[BaseNote] localStorage基音情報: note=${u}, name=${f}`),!g||g<=0)throw ee.error("[BaseNote] 基音周波数設定エラー:",S),new Error(`Invalid base frequency: ${g}`)}async function Et(){if(k||!_e||Re)return;if(b!=="granted"){console.log("🎤 [RandomTraining] マイク許可が必要です。許可取得を開始...");try{await Ne(),console.log("🎤 [RandomTraining] マイク許可取得完了")}catch(f){console.error("❌ マイク許可エラー:",f);return}}if(!Ee&&b==="granted"){console.log("🎤 [RandomTraining] AudioManagerリソース未初期化のため取得します");try{await Ne()}catch(f){console.error("❌ AudioManagerリソース初期化エラー:",f);return}}else Ee&&console.log("🎤 [RandomTraining] AudioManagerリソース既存のため再利用");t(9,k=!0),t(0,y="listening"),qe=Date.now(),Ze();const u=He.find(f=>f.name===v).note;_e.triggerAttackRelease(u,2,ct(),.7),setTimeout(()=>{t(9,k=!1),t(0,y="waiting"),setTimeout(()=>et(),500)},2e3)}async function Rt(){if(k||!_e||d||!v)return;if(b!=="granted"){console.log("🎤 [RandomTraining] マイク許可が必要です。許可取得を開始...");try{await Ne(),console.log("🎤 [RandomTraining] マイク許可取得完了")}catch(f){console.error("❌ マイク許可エラー:",f);return}}if(!Ee&&b==="granted"){console.log("🎤 [RandomTraining] AudioManagerリソース未初期化のため取得します");try{await Ne()}catch(f){console.error("❌ AudioManagerリソース初期化エラー:",f);return}}else Ee&&console.log("🎤 [RandomTraining] AudioManagerリソース既存のため再利用");if(t(9,k=!0),t(0,y="listening"),qe=Date.now(),typeof window<"u"&&window.Tone){const f=window.Tone.context||window.Tone.getContext();f&&f.state==="suspended"&&(console.log("🔄 [RandomTraining] AudioContext suspended検出 - 再開中..."),await f.resume(),console.log("✅ [RandomTraining] AudioContext再開完了"))}const u=He.find(f=>f.name===v).note;_e.triggerAttackRelease(u,2,ct(),.7),setTimeout(()=>{t(9,k=!1),t(0,y="waiting"),setTimeout(()=>et(),500)},2e3)}function Ft(){v&&g>0?Rt():Et(),zt()}function zt(){L&&clearInterval(L),t(11,V=0),t(12,W=!1),console.log("🎵 [GuideStartBar] ガイドスタートバー開始"),L=setInterval(()=>{t(11,V+=2.5),V>=100&&(t(11,V=100),t(12,W=!0),console.log("🎵 [GuideStartBar] ガイド開始タイミング！"),setTimeout(()=>{t(12,W=!1),t(11,V=0)},800),clearInterval(L),L=null)},50)}function je(u,f){const M=[0,2,4,5,7,9,11,12][f],C=u*Math.pow(2,M/12);return ee.debug(`[calculateExpectedFrequency] ${_[f].name}: 基音${u.toFixed(1)}Hz + ${M}半音 = ${C.toFixed(1)}Hz`),C}function Ht(u,f){return je(u,f)}function et(){t(0,y="guiding"),H=0,U=!0,B=[],console.log(`🎬 ガイド開始: ${v} (${g.toFixed(1)}Hz)`);function u(){if(H<_.length){H>0&&t(10,_[H-1].state="inactive",_),t(10,_[H].state="active",_);const f=Ht(g,H);ot.setScaleContext({baseFrequency:g,currentScale:_[H].name,targetFrequency:f}),console.log(`🎵 [Scale] 基音:${v}(${g.toFixed(0)}Hz) 現在:${_[H].name} 目標:${f.toFixed(0)}Hz`),H>=4&&console.log(`🔍 [デバッグ] Step ${H}: currentBaseFrequency=${g}, currentBaseNote='${v}'`),H++,te=setTimeout(()=>{u()},600)}else Nt()}u()}function Nt(){U=!1,console.log(`🏁 ガイド完了: ${B.length}/${_.length}ステップ評価`),_.length>0&&t(10,_[_.length-1].state="inactive",_),oe&&oe.stopDetection(),ot.clearContext(),Pt(),Vt(),K=G.map(u=>{const f=B.find(S=>S.stepName===u);return f?{name:f.stepName,cents:f.adjustedFrequency?Math.round(f.centDifference):null,targetFreq:f.expectedFrequency,detectedFreq:f.adjustedFrequency||null,diff:f.adjustedFrequency?f.adjustedFrequency-f.expectedFrequency:null,accuracy:f.accuracy}:{name:u,cents:null,targetFreq:null,detectedFreq:null,diff:null,accuracy:"notMeasured"}}),Ot(),Wt(),t(0,y="results")}function Pt(){let u=0,f=0;B.forEach((C,R)=>{C.isCorrect&&u++,f+=C.accuracy});const S=B.length>0?Math.round(f/B.length):0,M=Math.round(u/_.length*100);_.length,console.log(`🎯 結果: ${u}/${_.length}正解 (${M}%) 平均精度${S}%`),B.length>0&&[...B]}function Lt(){at(`${Je}/microphone-test`)}function Ve(){at(`${Je}/`)}async function xt(){try{t(32,Re=!0),t(31,_e=new hn({urls:{C4:"C4.mp3"},baseUrl:`${Je}/audio/piano/`,release:1.5,volume:Jn(),onload:()=>{t(32,Re=!1)},onerror:C=>{console.error("❌ Salamander Piano音源読み込みエラー:",C),t(32,Re=!1)}}).toDestination());const u=/iPhone/.test(navigator.userAgent),f=/iPad/.test(navigator.userAgent),S=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document,M=u||f||S;console.log(f?"🔍 [RandomTraining] iPad検出:":S?"🔍 [RandomTraining] iPadOS検出:":u?"🔍 [RandomTraining] iPhone検出:":"🔍 [RandomTraining] その他デバイス検出:",navigator.userAgent),console.log("🔊 [RandomTraining] 音量設定維持: 35dB")}catch(u){console.error("サンプラー初期化エラー:",u),t(32,Re=!1)}}async function Ue(){try{(await navigator.permissions.query({name:"microphone"})).state==="granted"?await Ne():t(1,b="denied")}catch{t(1,b="denied")}}function qt(){try{re=new En,ee.info("[RandomTraining] 採点エンジン初期化完了")}catch(u){ee.error("[RandomTraining] 採点エンジン初期化エラー:",u)}}function jt(u,f){if(!re||!U)return;const S=H-1;if(S<0||S>=_.length)return;const M=je(g,S),C={baseFrequency:g,targetFrequency:M,detectedFrequency:u,detectedNote:f,volume:N,timestamp:Date.now(),scaleIndex:S,scaleName:_[S].name};try{re.processAttempt(C)}catch(R){ee.error("[RandomTraining] 採点エンジンエラー:",R)}}function Vt(){if(!re){ee.error("[RandomTraining] 採点エンジンが初期化されていません"),Bt();return}try{const u=re.generateDetailedReport();t(16,de={totalScore:u.totalScore,grade:u.grade,componentScores:u.componentScores}),u.intervalAnalysis&&u.intervalAnalysis.masteryLevels?t(3,ae=Object.entries(u.intervalAnalysis.masteryLevels).map(([f,S])=>{var M,C;return{type:f,mastery:Math.round(S),attempts:((M=u.intervalAnalysis.attemptCounts)==null?void 0:M[f])||0,accuracy:((C=u.intervalAnalysis.accuracyRates)==null?void 0:C[f])||0}})):(console.warn("⚠️ [RandomTraining] intervalAnalysis.masteryLevels が未定義です"),t(3,ae=[])),u.consistencyHistory&&Array.isArray(u.consistencyHistory)?t(17,pe=u.consistencyHistory.map((f,S)=>({score:Math.round(f),timestamp:Date.now()-(u.consistencyHistory.length-S)*1e3}))):(console.warn("⚠️ [RandomTraining] consistencyHistory が未定義または配列ではありません"),t(17,pe=[])),t(18,Ce=u.feedback||{primary:"採点結果を生成中です...",detailed:[],suggestions:[]}),t(20,Te={totalAttempts:u.totalAttempts||0,successRate:u.successRate||0,averageScore:u.totalScore||0,bestScore:Math.max(u.totalScore||0,Te.bestScore||0),sessionDuration:Math.round((Date.now()-Te.sessionStart)/6e4)||0,streakCount:u.streak||0,fatigueLevel:u.fatigueLevel||"normal",mostDifficultInterval:u.mostDifficultInterval||"-",mostSuccessfulInterval:u.mostSuccessfulInterval||"-",averageResponseTime:u.averageResponseTime||0}),ee.info("[RandomTraining] 採点結果生成完了:",de)}catch(u){ee.error("[RandomTraining] 採点結果生成エラー:",u)}}function Bt(){ee.info("[RandomTraining] テストデータで採点結果を生成"),t(16,de={totalScore:78,grade:"B+",componentScores:{pitchAccuracy:82,recognitionSpeed:75,intervalMastery:80,directionAccuracy:85,consistency:70}}),t(3,ae=[{type:"unison",mastery:95,attempts:8,accuracy:98},{type:"major_second",mastery:82,attempts:8,accuracy:85},{type:"major_third",mastery:78,attempts:8,accuracy:80},{type:"perfect_fourth",mastery:65,attempts:8,accuracy:68},{type:"perfect_fifth",mastery:88,attempts:8,accuracy:90},{type:"major_sixth",mastery:72,attempts:8,accuracy:75},{type:"major_seventh",mastery:58,attempts:8,accuracy:62},{type:"octave",mastery:92,attempts:8,accuracy:94}]),t(17,pe=[{score:65,timestamp:Date.now()-42e4},{score:72,timestamp:Date.now()-36e4},{score:68,timestamp:Date.now()-3e5},{score:75,timestamp:Date.now()-24e4},{score:78,timestamp:Date.now()-18e4},{score:82,timestamp:Date.now()-12e4},{score:80,timestamp:Date.now()-6e4},{score:85,timestamp:Date.now()}]),t(18,Ce={type:"improvement",primary:"良い進歩が見られます！",summary:"音程の認識精度が向上しています。特に完全5度とオクターブの習得度が高く、基本的な音感が身についてきています。",details:[{category:"strengths",text:"ユニゾンとオクターブの認識がほぼ完璧です"},{category:"strengths",text:"完全5度の安定性が優秀です"},{category:"improvements",text:"完全4度の練習をもう少し増やしましょう"},{category:"improvements",text:"長7度の認識精度を向上させましょう"},{category:"tips",text:"4度は「ソーファー」の音程です"},{category:"practice",text:"毎日15分の継続練習を心がけましょう"}],nextSteps:["完全4度の集中練習を行いましょう","連続チャレンジモードで実践練習を","1日15分の継続練習を心がけましょう"],motivation:"継続は力なり！あなたの相対音感は確実に向上しています！"}),t(20,Te={totalAttempts:32,successRate:68.8,averageScore:78,bestScore:85,sessionDuration:8,streakCount:4,fatigueLevel:"normal",mostDifficultInterval:"完全4度",mostSuccessfulInterval:"ユニゾン",averageResponseTime:2.1,sessionStart:Date.now()-48e4}),ee.info("[RandomTraining] テスト採点結果生成完了")}function Ot(){if(!K||K.length===0){console.warn("[UnifiedScore] noteResultsForDisplay が空です");return}const u=K.filter(O=>O.accuracy!=="notMeasured").length,f=K.length,S=K.filter(O=>O.accuracy!=="notMeasured"&&typeof O.accuracy=="number").map(O=>O.accuracy),M=S.length>0?Math.round(S.reduce((O,De)=>O+De,0)/S.length):0,C=v||"Unknown",R=g||0,Y=K.map(O=>({name:O.name,note:O.note||O.name,frequency:O.targetFreq||O.expectedFrequency,detectedFrequency:O.detectedFreq,cents:O.cents,grade:Oe.evaluateNote(O.cents),targetFreq:O.targetFreq,diff:O.diff})),Z=h,Q=(Z==null?void 0:Z.sessionHistory)||[],ye={timestamp:new Date,baseNote:C,baseFrequency:R,noteResults:Y,measuredNotes:u,accuracy:M,grade:Oe.evaluateSession(K)},Me=[...Q,ye];t(21,ne={mode:"random",timestamp:new Date,duration:60,totalNotes:f,measuredNotes:u,averageAccuracy:M,baseNote:C,baseFrequency:R,noteResults:Y,distribution:Oe.calculateDistribution(K),sessionHistory:Me,unifiedGrade:p(Me)}),console.log("[UnifiedScore] 統合採点データ生成完了（完全版）:",ne),Gt()}async function Gt(){if(!K||K.length===0){console.warn("📊 [SessionStorage] 保存データなし");return}try{console.log("📊 [SessionStorage] セッション結果保存開始");const u=K.map(R=>({name:R.name,cents:R.cents,targetFreq:R.targetFreq||R.expectedFrequency,detectedFreq:R.detectedFreq,diff:R.diff,accuracy:typeof R.accuracy=="number"?R.accuracy:0})),f=qe?Math.round((Date.now()-qe)/1e3):60;await pn(u,f,a,c)?(console.log("📊 [SessionStorage] セッション結果保存完了"),console.log("📊 [SessionStorage] 保存後の状況:",{currentSession:l,totalSessions:i.length,isCompleted:s,nextBaseNote:a,nextBaseName:c})):console.error("📊 [SessionStorage] セッション結果保存失敗")}catch(u){console.error("📊 [SessionStorage] セッション保存エラー:",u)}}async function Wt(){try{if(re){const u=i||[];for(const[S,M]of u.entries())if(M.noteResults&&M.noteResults.length>0){const C=M.baseFrequency||262;for(const R of M.noteResults)R.detectedFreq&&R.targetFreq&&await re.analyzePerformance({baseFreq:C,targetFreq:R.targetFreq,detectedFreq:R.detectedFreq,responseTime:2e3,volume:50,harmonicCorrection:null})}const f=re.generateDetailedReport();t(16,de={totalScore:f.totalScore||0,grade:f.grade||"C",componentScores:f.componentScores||{accuracy:0,speed:0,consistency:0}}),f.intervalAnalysis&&f.intervalAnalysis.masteryLevels?t(3,ae=Object.entries(f.intervalAnalysis.masteryLevels).map(([S,M])=>{var C;return{type:S,mastery:Math.round(M),attempts:((C=f.intervalAnalysis.attemptCounts)==null?void 0:C[S])||0,accuracy:Math.round(M*.9)}})):t(3,ae=wt(K)),f.consistencyHistory&&Array.isArray(f.consistencyHistory)?t(17,pe=f.consistencyHistory.map((S,M)=>({score:Math.round(S),timestamp:Date.now()-(f.consistencyHistory.length-M)*1e3}))):t(17,pe=nt(K)),t(18,Ce=st(K)||f.feedback),console.log("🎯 [generateEnhancedScoringData] 技術分析結果生成を開始"),console.log("🎯 [generateEnhancedScoringData] results:",f),t(19,Ie=Ut(f)),console.log("🎯 [generateEnhancedScoringData] technicalFeedbackData結果:",Ie),t(20,Te={totalAttempts:f.totalAttempts||K.length,successRate:f.successRate||K.filter(S=>S.accuracy!=="notMeasured").length/K.length*100,averageScore:f.totalScore||(ne==null?void 0:ne.averageAccuracy)||0,bestScore:Math.max(f.totalScore||0,Te.bestScore||0),sessionDuration:Math.round(60),streakCount:f.streak||0,fatigueLevel:f.fatigueLevel||"normal",mostDifficultInterval:f.mostDifficultInterval||"未特定",mostSuccessfulInterval:f.mostSuccessfulInterval||"未特定",averageResponseTime:f.averageResponseTime||2.5,sessionStart:Date.now()-6e4})}else tt();console.log("[EnhancedScoring] 追加採点データ生成完了")}catch(u){console.error("[EnhancedScoring] データ生成エラー:",u),tt()}}function tt(){const u=K.filter(S=>S.accuracy!=="notMeasured"),f=(ne==null?void 0:ne.averageAccuracy)||0;t(16,de={totalScore:Math.round(f*.8),grade:f>=90?"A":f>=80?"B":f>=70?"C":"D",componentScores:{accuracy:f,speed:85,consistency:Math.max(60,f-10)}}),t(3,ae=wt(K)),t(17,pe=nt()),t(18,Ce=st(K)),t(20,Te={totalAttempts:K.length,successRate:u.length/K.length*100,averageScore:f,bestScore:f,sessionDuration:60,streakCount:0,fatigueLevel:"normal",mostDifficultInterval:"未分析",mostSuccessfulInterval:"未分析",averageResponseTime:2.5,sessionStart:Date.now()-6e4})}function nt(u){const f=(ne==null?void 0:ne.averageAccuracy)||70;return Array.from({length:8},(S,M)=>({score:Math.max(30,Math.min(100,f+(Math.random()-.5)*20)),timestamp:Date.now()-(8-M)*7500}))}function st(u){const f=u.filter(Le=>Le.accuracy!=="notMeasured").length,S=(ne==null?void 0:ne.averageAccuracy)||0,M=8,C=i||[],R=C.length,Y={type:"info",categories:[{name:"音程精度",icon:"Target",score:S,message:`${S}%の精度で音程を捉えています`},{name:"測定成功率",icon:"Mic",score:Math.round(f/u.length*100),message:`${u.length}音中${f}音を正常に測定`}]};if(R<M)return Y;let Z,Q,ye;const Me=(ne==null?void 0:ne.unifiedGrade)||"E",O=C.length;let De=0,me=0,fe=0;C.forEach(Le=>{Le.grade==="excellent"?De++:Le.grade==="good"?me++:Le.grade==="pass"&&fe++});const he=O>0?Math.round(De/O*100):0,Pe=O>0?Math.round((De+me+fe)/O*100):0,ve=O>0?Math.round((De+me+fe)/O*100):0;switch(Me){case"S":Z="excellent",Q="音楽家レベルの相対音感を達成！",ye=`優秀率${he}%超えの実力を証明されました。`;break;case"A":Z="excellent",Q="エキスパートレベル到達！",ye=`優秀率${he}%の安定した音感能力です。`;break;case"B":Z="improvement",Q="プロフィシエント級達成！",ye=`良好率${Pe}%の確実な進歩を示しています。`;break;case"C":Z="improvement",Q="アドバンス級到達！",ye=`合格率${ve}%で着実に成長中です。`;break;case"D":Z="practice",Q="継続練習で必ず上達！",ye=`現在の合格率${ve}%から目標70%へ向けて練習を続けましょう。`;break;case"E":default:Z="encouragement",Q="E級ビギナー",ye="練習開始段階です。継続的な練習で必ず上達します。";break}return{...Y,type:Z,primary:Q,summary:ye}}function Ut(u){var Me,O,De;if((i||[]).length<8||!u)return null;const C=u.improvements||[];(Me=u.detailed)!=null&&Me.statistics;const R=[];let Y=0,Z=0;if((O=u.detailed)!=null&&O.intervals){const me=u.detailed.intervals;if(me.totalAnalyses>0){let fe=0,he=0;for(const[Pe,ve]of Object.entries(me.masteryLevels))ve.attempts>0&&(fe+=ve.averageAccuracy*ve.attempts,he+=ve.attempts);Y=he>0?fe/he:0}}if((De=u.detailed)!=null&&De.directions){const me=u.detailed.directions;if(me.totalAnalyses>0){let fe=0,he=0;for(const[Pe,ve]of Object.entries(me.masteryData))ve.attempts>0&&(fe+=ve.averageAccuracy*ve.attempts,he+=ve.attempts);Z=he>0?fe/he:0}}R.push({category:"improvements",text:`音程精度: ${Math.round(Y)}%　（音の高さを捉える正確性　目標基準：70〜85%）`}),R.push({category:"improvements",text:`方向性: ${Math.round(Z)}%　（音程の上下判断の精度　目標基準：80〜90%）`});const Q=C.map(me=>({category:"tips",text:me.message})),ye=C.flatMap(me=>(me.actions||[]).map(fe=>({category:"practice",text:fe})));return[...R,...Q,...ye],{type:"info",primary:"詳細分析結果",summary:"音程精度・一貫性・方向性の総合分析",details:R}}on(async()=>{if(!(typeof localStorage<"u"?localStorage.getItem("mic-test-completed"):null)){console.log("🚫 [RandomTraining] マイクテスト未完了 - 準備画面表示"),Ue();return}console.log("📊 [SessionStorage] セッション管理初期化開始");try{if(await it()){if(console.log("📊 [SessionStorage] セッション進行状況の読み込み完了"),console.log("📊 [SessionStorage] 現在のセッション:",l,"/ 8"),console.log("📊 [SessionStorage] 次の基音:",a,"(",c,")"),console.log("📊 [SessionStorage] 完了状況:",s?"8セッション完了":`残り${m}セッション`),s&&(console.log("🔄 [SessionStorage] 8セッション完了検出 - 新サイクル開始処理"),await Be()?console.log("✅ [SessionStorage] 新サイクル開始完了 - セッション1/8から再開"):console.warn("⚠️ [SessionStorage] 新サイクル開始処理が失敗")),l>1&&!s){console.warn("🔄 [SessionStorage] セッション途中でのリロード検出 - セッション1から再開"),console.warn("🔄 [SessionStorage] 現在:",l,"セッション目 → ダイレクトアクセス誘導");const{SessionStorageManager:S}=await rt(async()=>{const{SessionStorageManager:R}=await import("../chunks/DrUK7av6.js").then(Y=>Y.k);return{SessionStorageManager:R}},__vite__mapDeps([0,1,2,3,4,5]),import.meta.url),M=S.getInstance();typeof localStorage<"u"&&(localStorage.removeItem("random-training-progress"),localStorage.removeItem("random-training-progress-backup"));const{resetProgress:C}=await rt(async()=>{const{resetProgress:R}=await import("../chunks/DrUK7av6.js").then(Y=>Y.m);return{resetProgress:R}},__vite__mapDeps([0,1,2,3,4,5]),import.meta.url);await C(),console.log("🔄 [SessionStorage] localStorage + ストア状態完全リセット完了"),Ue();return}}else console.log("📊 [SessionStorage] 新規セッション開始")}catch(f){console.error("📊 [SessionStorage] 初期化エラー:",f)}if(xt(),qt(),r.url.searchParams.get("from")==="microphone-test"){console.log("🎤 [RandomTraining] マイクテストページからの遷移を検出");const f=new URL(window.location);if(f.searchParams.delete("from"),window.history.replaceState({},"",f),t(1,b="granted"),t(0,y="setup"),console.log('🎤 [RandomTraining] microphoneState="granted", trainingPhase="setup" に設定'),!Ee){console.log("🎤 [RandomTraining] AudioManagerリソース取得開始");try{const S=await Fe.initialize();Qe=S.audioContext,Ee=S.mediaStream,Ye=S.sourceNode,console.log("🎤 [RandomTraining] AudioManagerリソース取得完了")}catch(S){console.warn("⚠️ AudioManagerリソース取得失敗（後で再試行）:",S)}}if(await new Promise(S=>setTimeout(S,300)),oe&&oe.getIsInitialized&&!oe.getIsInitialized())try{console.log("🎙️ [RandomTraining] PitchDetector初期化開始");const S=Fe.getStatus();console.log("🔍 [RandomTraining] AudioManager状態:",S),(!S.isInitialized||!S.mediaStreamActive)&&(console.log("🔄 [RandomTraining] AudioManager状態不良 - 再初期化実行"),await Fe.initialize()),await oe.initialize(),console.log("✅ [RandomTraining] PitchDetector初期化完了")}catch(S){console.warn("⚠️ PitchDetector初期化失敗:",S)}}else await new Promise(f=>setTimeout(f,100)),Ue()});function Xt(u){const{frequency:f,note:S,volume:M,rawVolume:C,clarity:R}=u.detail;let Y=f,Z=S;if(y==="guiding"&&U&&g>0&&f>0){const Q=Jt(f);Q&&(Y=Q.frequency,Z=Q.note)}t(14,se=Y),t(15,Se=Z),t(13,N=M),Kt(f),re&&f>0&&g>0&&jt(f,S)}function Jt(u){if(!u||u<=0||!U||!g||N<25)return null;const S=H-1;if(S<0||S>=_.length)return null;const M=je(g,S);if(!M||M<=0)return null;const R=kt(u,M).correctedFrequency,Y=Qn(R);return{frequency:Math.round(R),note:Y}}function Kt(u,f){if(!u||u<=0||!U)return;if(!g||g<=0){console.error(`❌ [採点エラー] 基音周波数が無効: ${g}Hz`),console.error(`❌ [採点エラー] 基音名: ${v}`),console.error(`❌ [採点エラー] activeStepIndex: ${H-1}`),console.error(`❌ [採点エラー] trainingPhase: ${y}`),console.error(`❌ [採点エラー] isGuideAnimationActive: ${U}`);return}if(N<25)return;const M=H-1;if(M<0||M>=_.length)return;M>=4&&ee.debug(`[採点デバッグ] activeStepIndex=${M} (${_[M].name}), currentBaseFrequency=${g}Hz`);const C=je(g,M);if(M>=0&&ee.debug(`[音程計算修正版] ${_[M].name}: 期待周波数 ${C.toFixed(1)}Hz`),!C||C<=0||!isFinite(C)){console.error("❌ [採点エラー] 期待周波数計算エラー:"),console.error(`   基音周波数: ${g}Hz`),console.error(`   音階インデックス: ${M}`),console.error(`   期待周波数: ${C}Hz`);return}const R=kt(u,C),Y=R.correctedFrequency,Z=R.factor,Q=Math.round(1200*Math.log2(Y/C));if((Math.abs(Q)>200||Z!==1)&&(ee.debug(`[プロトタイプ式補正] ${_[M].name}:`),console.warn(`   検出周波数: ${u.toFixed(1)}Hz`),console.warn(`   補正後周波数: ${Y.toFixed(1)}Hz`),console.warn(`   期待周波数: ${C.toFixed(1)}Hz`),console.warn(`   セント差: ${Q}¢`),console.warn(`   補正係数: ${Z} (${R.description})`),console.warn(`   基音: ${v} (${g.toFixed(1)}Hz)`)),!isFinite(Q)){console.error("❌ [採点エラー] セント計算エラー:"),console.error(`   検出周波数: ${u}Hz`),console.error(`   期待周波数: ${C}Hz`),console.error(`   セント差: ${Q}`);return}const Me=Math.abs(Q)<=50;if(N>=15){const me=Math.max(0,Math.round(100-Math.abs(Q))),fe=B.findIndex(Pe=>Pe.stepIndex===M),he={stepIndex:M,stepName:_[M].name,expectedFrequency:Math.round(C),detectedFrequency:Math.round(u),adjustedFrequency:Math.round(Y),centDifference:Q,accuracy:me,isCorrect:Me,correctionFactor:Z,correctionDescription:R.description,timestamp:Date.now()};fe>=0?B[fe]=he:B.push(he),B.length%4===0&&ee.realtime(`採点進捗: ${B.length}/${_.length}ステップ完了`)}}async function Qt(){if(s){console.warn("🚫 [RestartSame] 8セッション完了状態では再挑戦不可 - 新サイクル開始が必要"),await Be()?(console.log("✅ [RestartSame] 新サイクル開始完了 - セッション1/8から再開"),window.location.reload()):console.error("❌ [RestartSame] 新サイクル開始失敗");return}Ge(),t(0,y="setup"),te&&(clearTimeout(te),te=null),oe&&oe.resetDisplayState&&oe.resetDisplayState(),Xe(),console.log("🔄 [RestartSame] 同じ基音で再挑戦:",v,g+"Hz"),console.log("🔄 [RestartSame] 基音情報保持完了 - ユーザー操作待機")}async function Yt(){if(s){console.warn("🚫 [RestartDifferent] 8セッション完了状態では再挑戦不可 - 新サイクル開始が必要"),await Be()?(console.log("✅ [RestartDifferent] 新サイクル開始完了 - セッション1/8から再開"),window.location.reload()):console.error("❌ [RestartDifferent] 新サイクル開始失敗");return}Ge(),t(0,y="setup"),te&&(clearTimeout(te),te=null),t(7,v=""),t(8,g=0),console.log("🔄 [restartDifferentBaseNote] 基音情報をリセットしました"),oe&&oe.resetDisplayState&&oe.resetDisplayState(),Xe()}function Xe(){H=0,U=!1,B=[],t(10,_=_.map(u=>({...u,state:"inactive",completed:!1})))}async function Zt(){console.log("🚀 [StartNewCycle] 8セッション完了後の最初から挑戦開始");try{await Be()?(console.log("✅ [StartNewCycle] 新サイクル開始完了"),localStorage.getItem("mic-test-completed")?(console.log("✅ [StartNewCycle] マイクテスト完了フラグ確認 - リロードなしで状態リセット"),Ge(),await it(),t(0,y="setup"),Xe(),Ze(),console.log("✅ [StartNewCycle] 状態リセット完了 - セッション1/8から再開")):window.location.reload()):(console.error("❌ [StartNewCycle] 新サイクル開始失敗"),Ve())}catch(u){console.error("❌ [StartNewCycle] 新サイクル開始エラー:",u),Ve()}}function en(u){const{type:f}=u.detail;switch(f){case"same":Qt();break;case"different":Yt();break;case"restart":Zt();break;case"home":Ve();break;default:console.warn("🚫 [ActionButtons] 未知のアクションタイプ:",f)}}function tn(u){const{healthy:f,errors:S,details:M}=u.detail;t(2,w=f),t(6,E=S),f||(console.warn("⚠️ マイクの健康状態が悪化:",S),y==="guiding"&&(t(0,y="setup"),console.warn("🛑 マイク問題によりトレーニングを停止")))}cn(()=>{console.log("🔄 [RandomTraining] onDestroy - AudioManagerリソースは保持"),_e&&(_e.dispose(),t(31,_e=null))});function nn(u){ln[u?"unshift":"push"](()=>{oe=u,t(22,oe)})}return o.$$.update=()=>{o.$$.dirty[0]&6|o.$$.dirty[1]&3,o.$$.dirty[0]&1,o.$$.dirty[0]&56&&n&&s&&n.sessionHistory&&(t(3,ae=Kn(n.sessionHistory)),console.log("🎵 [RandomTraining] intervalData生成完了:",ae.length,"件")),o.$$.dirty[0]&3&&y==="setup"&&b==="granted"&&Ge()},[y,b,w,ae,n,s,E,v,g,k,_,V,W,N,se,Se,de,pe,Ce,Ie,Te,ne,oe,i,d,Ft,Lt,Ve,Xt,en,tn,_e,Re,nn]}class fs extends sn{constructor(e){super(),rn(this,e,es,Xn,an,{},null,[-1,-1,-1,-1])}}export{fs as component,ms as universal};
