import{S as qe,i as Le,s as je,d as u,C as pe,m as me,o as he,b as w,D as ve,I as Re,h as M,E as be,k as P,F as ge,l as ze,M as Se,c as a,y as r,K as Fe,e as m,f as D,G as S,j as h,R as Ne,Q as He,L as Oe,a as de,T as fe,A as L,g as F,t as H,r as Ue,n as xe}from"../chunks/BJp-dNlk.js";import"../chunks/IHki7fMi.js";import{p as Ge}from"../chunks/Cgmu0uzi.js";import{g as Ke,b as Qe}from"../chunks/BazZe_3_.js";import{P as Ze,C as Je}from"../chunks/DZHPMXgl.js";import{P as We,a as Xe,b as Me}from"../chunks/CSUAyeIy.js";const Ye=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global,{document:$e}=Ye;function et(l){let e,t="マイクのテストを開始します",c,s,i="マイクテスト開始ボタンを押してマイクの使用を許可してください",o,p;function y(n,v){if(n[0]==="pending")return lt;if(n[0]==="denied")return nt;if(n[0]==="initial")return st}let T=y(l),d=T&&T(l);return{c(){e=h("h3"),e.textContent=t,c=P(),s=h("p"),s.textContent=i,o=P(),d&&d.c(),p=Ue(),this.h()},l(n){e=m(n,"H3",{class:!0,"data-svelte-h":!0}),S(e)!=="svelte-gfi16f"&&(e.textContent=t),c=M(n),s=m(n,"P",{class:!0,"data-svelte-h":!0}),S(s)!=="svelte-1w19y1h"&&(s.textContent=i),o=M(n),d&&d.l(n),p=Ue(),this.h()},h(){r(e,"class","instructions-title svelte-1ctbylb"),r(s,"class","instructions-description svelte-1ctbylb")},m(n,v){w(n,e,v),w(n,c,v),w(n,s,v),w(n,o,v),d&&d.m(n,v),w(n,p,v)},p(n,v){T===(T=y(n))&&d?d.p(n,v):(d&&d.d(1),d=T&&T(n),d&&(d.c(),d.m(p.parentNode,p)))},d(n){n&&(u(e),u(c),u(s),u(o),u(p)),d&&d.d(n)}}}function tt(l){let e,t="マイク準備完了",c,s,i="音量を調整してからトレーニングを開始してください",o,p,y,T,d,n,v,E,b,_,U,A,I,j,se="-20dB",Y,k,ee,R,ne="+10dB",te,$,O=l[7]?"再生中...":"ド(C4)を再生",f,x,V,N,le,Z=l[6].toFixed(1)+"",oe,_e,ye,q,G,De="0.1x",Te,B,Ce,K,Ee="3.0x",ie,Q,z,ke="トレーニング開始",we,Ie;return{c(){e=h("h3"),e.textContent=t,c=P(),s=h("p"),s.textContent=i,o=P(),p=h("div"),y=h("span"),T=H(l[8]),d=P(),n=h("div"),v=h("div"),E=h("label"),b=H("基音音量: "),_=H(l[5]),U=H("dB"),A=P(),I=h("div"),j=h("span"),j.textContent=se,Y=P(),k=h("input"),ee=P(),R=h("span"),R.textContent=ne,te=P(),$=h("button"),f=H(O),x=P(),V=h("div"),N=h("label"),le=H("マイク感度: "),oe=H(Z),_e=H("x"),ye=P(),q=h("div"),G=h("span"),G.textContent=De,Te=P(),B=h("input"),Ce=P(),K=h("span"),K.textContent=Ee,ie=P(),Q=h("div"),z=h("button"),z.textContent=ke,this.h()},l(g){e=m(g,"H3",{class:!0,"data-svelte-h":!0}),S(e)!=="svelte-11dam81"&&(e.textContent=t),c=M(g),s=m(g,"P",{class:!0,"data-svelte-h":!0}),S(s)!=="svelte-1pr7rqg"&&(s.textContent=i),o=M(g),p=m(g,"DIV",{class:!0});var C=D(p);y=m(C,"SPAN",{class:!0});var Ae=D(y);T=F(Ae,l[8]),Ae.forEach(u),C.forEach(u),d=M(g),n=m(g,"DIV",{class:!0});var ae=D(n);v=m(ae,"DIV",{class:!0});var J=D(v);E=m(J,"LABEL",{class:!0});var re=D(E);b=F(re,"基音音量: "),_=F(re,l[5]),U=F(re,"dB"),re.forEach(u),A=M(J),I=m(J,"DIV",{class:!0});var W=D(I);j=m(W,"SPAN",{class:!0,"data-svelte-h":!0}),S(j)!=="svelte-5u5ai6"&&(j.textContent=se),Y=M(W),k=m(W,"INPUT",{type:!0,min:!0,max:!0,step:!0,class:!0}),ee=M(W),R=m(W,"SPAN",{class:!0,"data-svelte-h":!0}),S(R)!=="svelte-ptz1f5"&&(R.textContent=ne),W.forEach(u),te=M(J),$=m(J,"BUTTON",{class:!0});var Ve=D($);f=F(Ve,O),Ve.forEach(u),J.forEach(u),x=M(ae),V=m(ae,"DIV",{class:!0});var ce=D(V);N=m(ce,"LABEL",{class:!0});var ue=D(N);le=F(ue,"マイク感度: "),oe=F(ue,Z),_e=F(ue,"x"),ue.forEach(u),ye=M(ce),q=m(ce,"DIV",{class:!0});var X=D(q);G=m(X,"SPAN",{class:!0,"data-svelte-h":!0}),S(G)!=="svelte-1m4xt2o"&&(G.textContent=De),Te=M(X),B=m(X,"INPUT",{type:!0,min:!0,max:!0,step:!0,class:!0}),Ce=M(X),K=m(X,"SPAN",{class:!0,"data-svelte-h":!0}),S(K)!=="svelte-c9vjc8"&&(K.textContent=Ee),X.forEach(u),ce.forEach(u),ae.forEach(u),ie=M(g),Q=m(g,"DIV",{class:!0});var Be=D(Q);z=m(Be,"BUTTON",{class:!0,"data-svelte-h":!0}),S(z)!=="svelte-kae9rs"&&(z.textContent=ke),Be.forEach(u),this.h()},h(){r(e,"class","ready-title svelte-1ctbylb"),r(s,"class","ready-description svelte-1ctbylb"),r(y,"class","device-label svelte-1ctbylb"),r(p,"class","device-info svelte-1ctbylb"),r(E,"class","volume-label svelte-1ctbylb"),r(j,"class","slider-min svelte-1ctbylb"),r(k,"type","range"),r(k,"min","-20"),r(k,"max","10"),r(k,"step","1"),r(k,"class","volume-slider svelte-1ctbylb"),r(R,"class","slider-max svelte-1ctbylb"),r(I,"class","volume-slider-container svelte-1ctbylb"),r($,"class","base-tone-test-button svelte-1ctbylb"),$.disabled=l[7],r(v,"class","volume-control-section svelte-1ctbylb"),r(N,"class","volume-label svelte-1ctbylb"),r(G,"class","slider-min svelte-1ctbylb"),r(B,"type","range"),r(B,"min","0.1"),r(B,"max","3.0"),r(B,"step","0.1"),r(B,"class","volume-slider svelte-1ctbylb"),r(K,"class","slider-max svelte-1ctbylb"),r(q,"class","volume-slider-container svelte-1ctbylb"),r(V,"class","volume-control-section svelte-1ctbylb"),r(n,"class","volume-controls svelte-1ctbylb"),r(z,"class","training-start-button enabled svelte-1ctbylb"),r(Q,"class","training-start-button-area svelte-1ctbylb")},m(g,C){w(g,e,C),w(g,c,C),w(g,s,C),w(g,o,C),w(g,p,C),a(p,y),a(y,T),w(g,d,C),w(g,n,C),a(n,v),a(v,E),a(E,b),a(E,_),a(E,U),a(v,A),a(v,I),a(I,j),a(I,Y),a(I,k),fe(k,l[5]),a(I,ee),a(I,R),a(v,te),a(v,$),a($,f),a(n,x),a(n,V),a(V,N),a(N,le),a(N,oe),a(N,_e),a(V,ye),a(V,q),a(q,G),a(q,Te),a(q,B),fe(B,l[6]),a(q,Ce),a(q,K),w(g,ie,C),w(g,Q,C),a(Q,z),we||(Ie=[L(k,"change",l[16]),L(k,"input",l[16]),L(k,"input",l[13]),L($,"click",l[14]),L(B,"change",l[17]),L(B,"input",l[17]),L(B,"input",l[15]),L(z,"click",l[10])],we=!0)},p(g,C){C&256&&de(T,g[8]),C&32&&de(_,g[5]),C&32&&fe(k,g[5]),C&128&&O!==(O=g[7]?"再生中...":"ド(C4)を再生")&&de(f,O),C&128&&($.disabled=g[7]),C&64&&Z!==(Z=g[6].toFixed(1)+"")&&de(oe,Z),C&64&&fe(B,g[6])},d(g){g&&(u(e),u(c),u(s),u(o),u(p),u(d),u(n),u(ie),u(Q)),we=!1,Oe(Ie)}}}function st(l){let e,t,c="マイクテストを開始",s,i;return{c(){e=h("div"),t=h("button"),t.textContent=c,this.h()},l(o){e=m(o,"DIV",{class:!0});var p=D(e);t=m(p,"BUTTON",{class:!0,"data-svelte-h":!0}),S(t)!=="svelte-caex95"&&(t.textContent=c),p.forEach(u),this.h()},h(){r(t,"class","mic-test-button start svelte-1ctbylb"),r(e,"class","mic-test-button-area svelte-1ctbylb")},m(o,p){w(o,e,p),a(e,t),s||(i=L(t,"click",l[9]),s=!0)},p:xe,d(o){o&&u(e),s=!1,i()}}}function nt(l){let e,t,c="マイク許可を再試行",s,i;return{c(){e=h("div"),t=h("button"),t.textContent=c,this.h()},l(o){e=m(o,"DIV",{class:!0});var p=D(e);t=m(p,"BUTTON",{class:!0,"data-svelte-h":!0}),S(t)!=="svelte-1p3n8nt"&&(t.textContent=c),p.forEach(u),this.h()},h(){r(t,"class","mic-test-button retry svelte-1ctbylb"),r(e,"class","mic-test-button-area svelte-1ctbylb")},m(o,p){w(o,e,p),a(e,t),s||(i=L(t,"click",l[9]),s=!0)},p:xe,d(o){o&&u(e),s=!1,i()}}}function lt(l){let e,t="マイク準備中...";return{c(){e=h("p"),e.textContent=t,this.h()},l(c){e=m(c,"P",{class:!0,"data-svelte-h":!0}),S(e)!=="svelte-1vb5g92"&&(e.textContent=t),this.h()},h(){r(e,"class","status-text svelte-1ctbylb")},m(c,s){w(c,e,s)},p:xe,d(c){c&&u(e)}}}function ot(l){let e;function t(i,o){return i[0]==="granted"?tt:et}let c=t(l),s=c(l);return{c(){e=h("div"),s.c(),this.h()},l(i){e=m(i,"DIV",{class:!0});var o=D(e);s.l(o),o.forEach(u),this.h()},h(){r(e,"class","training-mode-content svelte-1ctbylb")},m(i,o){w(i,e,o),s.m(e,null)},p(i,o){c===(c=t(i))&&s?s.p(i,o):(s.d(1),s=c(i),s&&(s.c(),s.m(e,null)))},d(i){i&&u(e),s.d()}}}function it(l){let e,t,c='<div class="mic-test-header svelte-1ctbylb"><div class="mic-icon svelte-1ctbylb"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" x2="12" y1="19" y2="22"></line><line x1="8" x2="16" y1="22" y2="22"></line></svg></div> <div><h1 class="mic-test-title svelte-1ctbylb">マイクテスト</h1> <p class="mic-test-description svelte-1ctbylb">音感トレーニングを始める前に、マイクの動作を確認します</p></div></div>',s,i,o,p,y,T,d,n,v;o=new Je({props:{variant:"default",padding:"lg",$$slots:{default:[ot]},$$scope:{ctx:l}}}),y=new We({props:{frequency:l[2],note:l[3],volume:l[1],isMuted:l[0]!=="granted",muteMessage:"マイク許可後に開始"}});let E={isActive:l[0]==="granted",className:"pitch-detector-content",debugMode:!1};return n=new Xe({props:E}),l[18](n),n.$on("pitchUpdate",l[11]),n.$on("stateChange",rt),n.$on("error",l[12]),{c(){e=h("div"),t=h("div"),t.innerHTML=c,s=P(),i=h("div"),ge(o.$$.fragment),p=P(),ge(y.$$.fragment),T=P(),d=h("div"),ge(n.$$.fragment),this.h()},l(b){e=m(b,"DIV",{class:!0});var _=D(e);t=m(_,"DIV",{class:!0,"data-svelte-h":!0}),S(t)!=="svelte-4qcd63"&&(t.innerHTML=c),s=M(_),i=m(_,"DIV",{class:!0});var U=D(i);be(o.$$.fragment,U),U.forEach(u),p=M(_),be(y.$$.fragment,_),T=M(_),d=m(_,"DIV",{style:!0});var A=D(d);be(n.$$.fragment,A),A.forEach(u),_.forEach(u),this.h()},h(){r(t,"class","header svelte-1ctbylb"),r(i,"class","training-mode-info svelte-1ctbylb"),Fe(d,"display","none"),r(e,"class","microphone-test svelte-1ctbylb")},m(b,_){w(b,e,_),a(e,t),a(e,s),a(e,i),ve(o,i,null),a(e,p),ve(y,e,null),a(e,T),a(e,d),ve(n,d,null),v=!0},p(b,_){const U={};_&67109345&&(U.$$scope={dirty:_,ctx:b}),o.$set(U);const A={};_&4&&(A.frequency=b[2]),_&8&&(A.note=b[3]),_&2&&(A.volume=b[1]),_&1&&(A.isMuted=b[0]!=="granted"),y.$set(A);const I={};_&1&&(I.isActive=b[0]==="granted"),n.$set(I)},i(b){v||(he(o.$$.fragment,b),he(y.$$.fragment,b),he(n.$$.fragment,b),v=!0)},o(b){me(o.$$.fragment,b),me(y.$$.fragment,b),me(n.$$.fragment,b),v=!1},d(b){b&&u(e),pe(o),pe(y),l[18](null),pe(n)}}}function at(l){let e,t,c;return t=new Ze({props:{showBackButton:!0,$$slots:{default:[it]},$$scope:{ctx:l}}}),{c(){e=P(),ge(t.$$.fragment),this.h()},l(s){Re("svelte-8st1fo",$e.head).forEach(u),e=M(s),be(t.$$.fragment,s),this.h()},h(){$e.title="マイクテスト - 相対音感トレーニング"},m(s,i){w(s,e,i),ve(t,s,i),c=!0},p(s,[i]){const o={};i&67109375&&(o.$$scope={dirty:i,ctx:s}),t.$set(o)},i(s){c||(he(t.$$.fragment,s),c=!0)},o(s){me(t.$$.fragment,s),c=!1},d(s){s&&u(e),pe(t,s)}}}function rt(l){}async function Pe(){if(typeof window<"u"&&window.Tone){const l=window.Tone.context||window.Tone.getContext();if(l&&l.state==="suspended")return console.log("🔄 [MicTest] AudioContext suspended検出 - 再開中..."),await l.resume(),console.log("✅ [MicTest] AudioContext再開完了"),!0}return!1}function ct(l,e,t){let c;ze(l,Ge,f=>t(21,c=f));let s="random";Se(()=>{c.url.searchParams.has("mode")&&(s=c.url.searchParams.get("mode")||"random")});let i="initial",o=0,p=0,y="ーー",T=null,d=0,n=1,v=null,E=!1,b="";Se(()=>{const f=/iPhone/.test(navigator.userAgent);/iPad/.test(navigator.userAgent)?(t(8,b="iPad検出"),t(5,d=-6)):f?(t(8,b="iPhone検出"),t(5,d=-6)):(t(8,b="その他デバイス"),t(5,d=-6)),console.log(`🔍 [MicTest] デバイス情報: ${b}`,navigator.userAgent)});const _={random:{name:"ランダム基音モード",description:"10種類の基音からランダムに選択してトレーニング",color:"green",path:"/training/random"},continuous:{name:"連続チャレンジモード",description:"選択した回数だけ連続で実行し、総合評価を確認",color:"orange",path:"/training/continuous"},chromatic:{name:"12音階モード",description:"クロマチックスケールの上行・下行で完全制覇",color:"purple",path:"/training/chromatic"}},U=_[s]||_.random;async function A(){var f;t(0,i="pending");try{if(console.log("🎤 [MicTest] マイク許可リクエスト開始"),!((f=navigator.mediaDevices)!=null&&f.getUserMedia)){t(0,i="denied"),console.error("❌ [MicTest] getUserMediaがサポートされていません");return}const x=await Me.initialize();if(console.log("✅ [MicTest] AudioManager リソース取得完了"),x.mediaStream&&x.audioContext)t(0,i="granted"),console.log("✅ [MicTest] マイク許可完了"),await Pe(),await ne(),setTimeout(async()=>{T&&(console.log("🎙️ [MicTest] PitchDetector初期化開始"),await Pe(),await T.initialize(),console.log("✅ [MicTest] PitchDetector初期化完了"),console.log("🎯 [MicTest] PitchDetector isActiveリアクティブで自動検出開始"))},1e3);else throw new Error("リソース取得失敗")}catch(x){console.error("❌ [MicTest] マイク許可エラー:",x),t(0,i=((x==null?void 0:x.name)==="NotAllowedError","denied"))}}function I(){console.log("🚀 [MicTest] トレーニング開始 - ランダム基音モードへ遷移"),localStorage.setItem("mic-test-completed","true"),console.log("✅ [MicTest] マイクテスト完了フラグを保存"),Ke(`${Qe}${U.path}?from=microphone-test`)}function j(f){const{frequency:x,note:V,volume:N,rawVolume:le,clarity:Z}=f.detail;t(2,p=x),t(3,y=V),t(1,o=N)}function se(f){console.error("❌ [MicTest] PitchDetectorエラー:",f.detail);const{error:x,reason:V,recovery:N}=f.detail;V==="mediastream_ended"&&N==="restart_required"&&(console.log("🔄 [MicTest] MediaStream終了検出 - 自動復旧開始"),t(0,i="initial"),t(1,o=0),t(2,p=0),t(3,y="ーー"),console.log("⚠️ [MicTest] マイク再許可が必要です"))}async function Y(){try{if(console.log("🎹 [MicTest] 基音テスト初期化開始"),typeof window<"u"){if(!window.Tone){console.log("📦 [MicTest] Tone.js動的読み込み開始");const f=document.createElement("script");f.src="https://unpkg.com/tone@latest/build/Tone.js",document.head.appendChild(f),await new Promise((x,V)=>{f.onload=x,f.onerror=V}),console.log("✅ [MicTest] Tone.js読み込み完了")}await window.Tone.start(),v=new window.Tone.Sampler({urls:{C4:"C4.mp3"},baseUrl:"https://tonejs.github.io/audio/salamander/",release:1.5,onload:()=>{console.log("✅ [MicTest] 基音サンプラー読み込み完了")},onerror:f=>{console.error("❌ [MicTest] 基音サンプラー読み込みエラー:",f)}}).toDestination(),k()}else console.warn("⚠️ [MicTest] window未定義 - 基音テスト無効")}catch(f){console.error("❌ [MicTest] 基音テスト初期化エラー:",f)}}function k(){v&&(v.volume.value=d,console.log(`🔊 [MicTest] 基音音量設定: ${d}dB`))}async function ee(){if(!(!v||E))try{t(7,E=!0),console.log("🎵 [MicTest] 基音再生開始: C4"),await Pe()&&console.log("🔊 [MicTest] AudioContext再開後に基音再生実行"),await v.triggerAttackRelease("C4",2,window.Tone.now(),.7),setTimeout(()=>{t(7,E=!1),console.log("✅ [MicTest] 基音再生完了")},2e3)}catch(f){console.error("❌ [MicTest] 基音再生エラー:",f),t(7,E=!1)}}function R(){try{Me.setSensitivity(n),console.log(`🎤 [MicTest] マイク感度更新完了: ${n}x`)}catch(f){console.error("❌ [MicTest] マイク感度調整エラー:",f)}}async function ne(){await Y();try{t(6,n=Me.getSensitivity()),console.log(`🎤 [MicTest] 現在のマイク感度取得: ${n}x`)}catch(f){console.warn("⚠️ [MicTest] マイク感度取得エラー:",f)}}function te(){d=Ne(this.value),t(5,d)}function $(){n=Ne(this.value),t(6,n)}function O(f){He[f?"unshift":"push"](()=>{T=f,t(4,T)})}return[i,o,p,y,T,d,n,E,b,A,I,j,se,k,ee,R,te,$,O]}class vt extends qe{constructor(e){super(),Le(this,e,ct,at,je,{})}}export{vt as component};
