const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["../chunks/BBixbokH.js","../chunks/DXfV3yLF.js","../chunks/BnpKoSs-.js","../chunks/D0QH3NT1.js","../chunks/DC20lbjx.js","../assets/sessionStorage.2zs4CtXT.css"])))=>i.map(i=>d[i]);
import{_ as wn}from"../chunks/C1FmrZbK.js";import{S as Do,i as qo,d as $,s as wo,v as Ne,c as Ie,a as Co,H as Cn,V as kn,b as h,q as fe,r as Q,u as U,f as O,w as de,I as ko,m as Y,x as me,p as Z,y as ge,J as Fo,K as Ae,L as Te,g,z as T,h as F,M as Qe,j as R,k as V,A as ve,l as W,N as Le,o as M,t as J,e as De,Q as lt,n as Et,R as xn}from"../chunks/DXfV3yLF.js";import{g as Ro}from"../chunks/D0QH3NT1.js";import"../chunks/BnpKoSs-.js";import{b as it,g as vt}from"../chunks/DC20lbjx.js";import{p as _t}from"../chunks/BacvCNmF.js";import{P as Hn,B as ut,C as Je}from"../chunks/CrwomGmF.js";import{l as ie,a as We,h as St,P as Vn,b as zn,V as Mo}from"../chunks/BRZWrjh2.js";import{l as bt,s as tt,c as No,r as Io,a as Fn,u as Dt,b as Ao,d as qt,p as To,o as Eo,e as Po,f as wt,i as Ct,g as Bo,h as kt,n as Ft,j as Rt,k as Mt,t as Nt,E as Rn,m as nt,A as Jt,U as Kt,S as xo,F as Ho,C as Vo,I as zo,q as Lo,T as jo,P as Oo,M as Ln,v as Go,w as Uo,x as It}from"../chunks/BBixbokH.js";const Wo=!1,Jo=!1,cs=Object.freeze(Object.defineProperty({__proto__:null,prerender:Jo,ssr:Wo},Symbol.toStringTag,{value:"Module"})),{Object:Ko,console:Qo,document:Mn}=Ro,N="src/routes/training/continuous/+page.svelte";function Nn(r,t,e){const i=r.slice();return i[99]=t[e],i[101]=e,i}function In(r,t,e){const i=r.slice();return i[102]=t[e],i}function Pt(r){var x,j;let t,e,i,s,n,c,a,u,f,d,m=(((x=r[24])==null?void 0:x.length)||0)+"",v,q,p,y,b,z,w,I,X=Math.round((((j=r[24])==null?void 0:j.length)||0)/8*100)+"",P,L,B,_,ee,D=r[0]==="results"&&r[5]&&Bt(r);const C={c:function(){t=M("div"),e=M("div"),i=M("div"),s=M("span"),n=J("セッション "),c=J(r[23]),a=J("/8"),u=Z(),f=M("span"),d=J("完了済み "),v=J(m),q=J("セッション"),p=Z(),y=M("div"),b=M("div"),z=M("div"),w=Z(),I=M("span"),P=J(X),L=J("%"),B=Z(),D&&D.c(),_=Le(),this.h()},l:function(E){t=R(E,"DIV",{class:!0});var A=V(t);e=R(A,"DIV",{class:!0});var te=V(e);i=R(te,"DIV",{class:!0});var K=V(i);s=R(K,"SPAN",{class:!0});var ye=V(s);n=W(ye,"セッション "),c=W(ye,r[23]),a=W(ye,"/8"),ye.forEach(h),u=Y(K),f=R(K,"SPAN",{class:!0});var Se=V(f);d=W(Se,"完了済み "),v=W(Se,m),q=W(Se,"セッション"),Se.forEach(h),K.forEach(h),p=Y(te),y=R(te,"DIV",{class:!0});var Ee=V(y);b=R(Ee,"DIV",{class:!0});var je=V(b);z=R(je,"DIV",{class:!0,style:!0}),V(z).forEach(h),je.forEach(h),w=Y(Ee),I=R(Ee,"SPAN",{class:!0});var He=V(I);P=W(He,X),L=W(He,"%"),He.forEach(h),Ee.forEach(h),te.forEach(h),A.forEach(h),B=Y(E),D&&D.l(E),_=Le(),this.h()},h:function(){var E;T(s,"class","completed-count svelte-rt5px1"),F(s,N,2661,12,90533),T(f,"class","remaining-text svelte-rt5px1"),F(f,N,2662,12,90610),T(i,"class","session-info svelte-rt5px1"),F(i,N,2660,10,90494),T(z,"class","progress-fill svelte-rt5px1"),Qe(z,"width",(((E=r[24])==null?void 0:E.length)||0)/8*100+"%"),F(z,N,2666,14,90798),T(b,"class","progress-bar svelte-rt5px1"),F(b,N,2665,12,90757),T(I,"class","progress-text svelte-rt5px1"),F(I,N,2668,12,90924),T(y,"class","progress-section svelte-rt5px1"),F(y,N,2664,10,90714),T(e,"class","session-status svelte-rt5px1"),F(e,N,2659,8,90455),T(t,"class","session-progress svelte-rt5px1"),F(t,N,2658,6,90416)},m:function(E,A){O(E,t,A),g(t,e),g(e,i),g(i,s),g(s,n),g(s,c),g(s,a),g(i,u),g(i,f),g(f,d),g(f,v),g(f,q),g(e,p),g(e,y),g(y,b),g(b,z),g(y,w),g(y,I),g(I,P),g(I,L),O(E,B,A),D&&D.m(E,A),O(E,_,A),ee=!0},p:function(E,A){var te,K,ye;(!ee||A[0]&8388608)&&De(c,E[23]),(!ee||A[0]&16777216)&&m!==(m=(((te=E[24])==null?void 0:te.length)||0)+"")&&De(v,m),(!ee||A[0]&16777216)&&Qe(z,"width",(((K=E[24])==null?void 0:K.length)||0)/8*100+"%"),(!ee||A[0]&16777216)&&X!==(X=Math.round((((ye=E[24])==null?void 0:ye.length)||0)/8*100)+"")&&De(P,X),E[0]==="results"&&E[5]?D?(D.p(E,A),A[0]&33&&U(D,1)):(D=Bt(E),D.c(),U(D,1),D.m(_.parentNode,_)):D&&(Ae(),Q(D,1,1,()=>{D=null}),Te())},i:function(E){ee||(U(D),ee=!0)},o:function(E){Q(D),ee=!1},d:function(E){E&&(h(t),h(B),h(_)),D&&D.d(E)}};return $("SvelteRegisterBlock",{block:C,id:Pt.name,type:"if",source:"(2658:4) {#if microphoneState === 'granted' && !$isLoading}",ctx:r}),C}function Bt(r){let t,e,i;e=new Jt({props:{isCompleted:r[5],position:"top"},$$inline:!0}),e.$on("action",r[29]);const s={c:function(){t=M("div"),ge(e.$$.fragment),this.h()},l:function(c){t=R(c,"DIV",{class:!0});var a=V(t);me(e.$$.fragment,a),a.forEach(h),this.h()},h:function(){T(t,"class","top-action-buttons svelte-rt5px1"),F(t,N,2676,8,91181)},m:function(c,a){O(c,t,a),de(e,t,null),i=!0},p:function(c,a){const u={};a[0]&32&&(u.isCompleted=c[5]),e.$set(u)},i:function(c){i||(U(e.$$.fragment,c),i=!0)},o:function(c){Q(e.$$.fragment,c),i=!1},d:function(c){c&&h(t),fe(e)}};return $("SvelteRegisterBlock",{block:s,id:Bt.name,type:"if",source:"(2676:6) {#if trainingPhase === 'results' && $isCompleted}",ctx:r}),s}function jn(r){let t,e;t=new Je({props:{class:"error-card",$$slots:{default:[Wn]},$$scope:{ctx:r}},$$inline:!0});const i={c:function(){ge(t.$$.fragment)},l:function(n){me(t.$$.fragment,n)},m:function(n,c){de(t,n,c),e=!0},p:function(n,c){const a={};c[3]&4096&&(a.$$scope={dirty:c,ctx:n}),t.$set(a)},i:function(n){e||(U(t.$$.fragment,n),e=!0)},o:function(n){Q(t.$$.fragment,n),e=!1},d:function(n){fe(t,n)}};return $("SvelteRegisterBlock",{block:i,id:jn.name,type:"else",source:"(2924:2) {:else}",ctx:r}),i}function On(r){let t,e,i,s,n,c,a,u={isActive:r[1]==="granted",trainingPhase:r[0],className:"pitch-detector-content",debugMode:!0,disableHarmonicCorrection:!1};e=new zn({props:u,$$inline:!0}),r[35](e),e.$on("pitchUpdate",r[28]),e.$on("stateChange",go),e.$on("error",r[31]),e.$on("microphoneHealthChange",r[32]);let f=r[0]!=="results"&&xt(r),d=r[0]!=="results"&&Lt(r),m=r[0]==="results"&&Gt(r);const v={c:function(){t=M("div"),ge(e.$$.fragment),i=Z(),f&&f.c(),s=Z(),d&&d.c(),n=Z(),m&&m.c(),c=Le(),this.h()},l:function(p){t=R(p,"DIV",{style:!0});var y=V(t);me(e.$$.fragment,y),y.forEach(h),i=Y(p),f&&f.l(p),s=Y(p),d&&d.l(p),n=Y(p),m&&m.l(p),c=Le(),this.h()},h:function(){Qe(t,"display","none"),F(t,N,2695,4,91679)},m:function(p,y){O(p,t,y),de(e,t,null),O(p,i,y),f&&f.m(p,y),O(p,s,y),d&&d.m(p,y),O(p,n,y),m&&m.m(p,y),O(p,c,y),a=!0},p:function(p,y){const b={};y[0]&2&&(b.isActive=p[1]==="granted"),y[0]&1&&(b.trainingPhase=p[0]),e.$set(b),p[0]!=="results"?f?(f.p(p,y),y[0]&1&&U(f,1)):(f=xt(p),f.c(),U(f,1),f.m(s.parentNode,s)):f&&(Ae(),Q(f,1,1,()=>{f=null}),Te()),p[0]!=="results"?d?(d.p(p,y),y[0]&1&&U(d,1)):(d=Lt(p),d.c(),U(d,1),d.m(n.parentNode,n)):d&&(Ae(),Q(d,1,1,()=>{d=null}),Te()),p[0]==="results"?m?(m.p(p,y),y[0]&1&&U(m,1)):(m=Gt(p),m.c(),U(m,1),m.m(c.parentNode,c)):m&&(Ae(),Q(m,1,1,()=>{m=null}),Te())},i:function(p){a||(U(e.$$.fragment,p),U(f),U(d),U(m),a=!0)},o:function(p){Q(e.$$.fragment,p),Q(f),Q(d),Q(m),a=!1},d:function(p){p&&(h(t),h(i),h(s),h(n),h(c)),r[35](null),fe(e),f&&f.d(p),d&&d.d(p),m&&m.d(p)}};return $("SvelteRegisterBlock",{block:v,id:On.name,type:"if",source:"(2694:2) {#if microphoneState === 'granted'}",ctx:r}),v}function Gn(r){let t;const e={c:function(){t=J("🎤 マイクテストページへ移動")},l:function(s){t=W(s,"🎤 マイクテストページへ移動")},m:function(s,n){O(s,t,n)},d:function(s){s&&h(t)}};return $("SvelteRegisterBlock",{block:e,id:Gn.name,type:"slot",source:'(2938:10) <Button variant=\\"primary\\" on:click={goToMicrophoneTest}>',ctx:r}),e}function Un(r){let t;const e={c:function(){t=J("🏠 ホームに戻る")},l:function(s){t=W(s,"🏠 ホームに戻る")},m:function(s,n){O(s,t,n)},d:function(s){s&&h(t)}};return $("SvelteRegisterBlock",{block:e,id:Un.name,type:"slot",source:'(2941:10) <Button variant=\\"secondary\\" on:click={goHome}>',ctx:r}),e}function Wn(r){let t,e,i="🎤",s,n,c="マイクテストが必要です",a,u,f="連続チャレンジモードを開始する前に、マイクテストページで音声入力の確認をお願いします。",d,m,v,q,p,y="マイクテスト完了後",b,z,w,I="まずはマイクテストページで音声確認を行ってください。",X,P,L,B,_,ee;L=new ut({props:{variant:"primary",$$slots:{default:[Gn]},$$scope:{ctx:r}},$$inline:!0}),L.$on("click",r[26]),_=new ut({props:{variant:"secondary",$$slots:{default:[Un]},$$scope:{ctx:r}},$$inline:!0}),_.$on("click",r[27]);const D={c:function(){t=M("div"),e=M("div"),e.textContent=i,s=Z(),n=M("h3"),n.textContent=c,a=Z(),u=M("p"),u.textContent=f,d=Z(),m=M("div"),v=M("p"),q=J("このページは"),p=M("strong"),p.textContent=y,b=J("にご利用いただけます。"),z=Z(),w=M("p"),w.textContent=I,X=Z(),P=M("div"),ge(L.$$.fragment),B=Z(),ge(_.$$.fragment),this.h()},l:function(x){t=R(x,"DIV",{class:!0});var j=V(t);e=R(j,"DIV",{class:!0,"data-svelte-h":!0}),ve(e)!=="svelte-15rbx8n"&&(e.textContent=i),s=Y(j),n=R(j,"H3",{class:!0,"data-svelte-h":!0}),ve(n)!=="svelte-17kvze2"&&(n.textContent=c),a=Y(j),u=R(j,"P",{class:!0,"data-svelte-h":!0}),ve(u)!=="svelte-1t09god"&&(u.textContent=f),d=Y(j),m=R(j,"DIV",{class:!0});var oe=V(m);v=R(oe,"P",{class:!0});var E=V(v);q=W(E,"このページは"),p=R(E,"STRONG",{"data-svelte-h":!0}),ve(p)!=="svelte-1n3qsr6"&&(p.textContent=y),b=W(E,"にご利用いただけます。"),E.forEach(h),z=Y(oe),w=R(oe,"P",{class:!0,"data-svelte-h":!0}),ve(w)!=="svelte-v8nd09"&&(w.textContent=I),oe.forEach(h),X=Y(j),P=R(j,"DIV",{class:!0});var A=V(P);me(L.$$.fragment,A),B=Y(A),me(_.$$.fragment,A),A.forEach(h),j.forEach(h),this.h()},h:function(){T(e,"class","error-icon svelte-rt5px1"),F(e,N,2927,8,99864),T(n,"class","svelte-rt5px1"),F(n,N,2928,8,99905),T(u,"class","svelte-rt5px1"),F(u,N,2929,8,99934),F(p,N,2932,19,100050),T(v,"class","svelte-rt5px1"),F(v,N,2932,10,100041),T(w,"class","svelte-rt5px1"),F(w,N,2933,10,100102),T(m,"class","recommendation svelte-rt5px1"),F(m,N,2931,8,100002),T(P,"class","action-buttons"),F(P,N,2936,8,100168),T(t,"class","error-content svelte-rt5px1"),F(t,N,2926,6,99828)},m:function(x,j){O(x,t,j),g(t,e),g(t,s),g(t,n),g(t,a),g(t,u),g(t,d),g(t,m),g(m,v),g(v,q),g(v,p),g(v,b),g(m,z),g(m,w),g(t,X),g(t,P),de(L,P,null),g(P,B),de(_,P,null),ee=!0},p:function(x,j){const oe={};j[3]&4096&&(oe.$$scope={dirty:j,ctx:x}),L.$set(oe);const E={};j[3]&4096&&(E.$$scope={dirty:j,ctx:x}),_.$set(E)},i:function(x){ee||(U(L.$$.fragment,x),U(_.$$.fragment,x),ee=!0)},o:function(x){Q(L.$$.fragment,x),Q(_.$$.fragment,x),ee=!1},d:function(x){x&&h(t),fe(L),fe(_)}};return $("SvelteRegisterBlock",{block:D,id:Wn.name,type:"slot",source:'(2926:4) <Card class=\\"error-card\\">',ctx:r}),D}function xt(r){let t,e,i,s,n,c,a=!r[2]&&r[6].length>0&&Ht(r);i=new Je({props:{class:"main-card half-width",$$slots:{default:[to]},$$scope:{ctx:r}},$$inline:!0}),n=new Vn({props:{frequency:r[14],note:r[15],volume:r[13],isMuted:r[0]!=="guiding",muteMessage:"基音再生後に開始",className:"half-width",showGuidance:!1},$$inline:!0});const u={c:function(){a&&a.c(),t=Z(),e=M("div"),ge(i.$$.fragment),s=Z(),ge(n.$$.fragment),this.h()},l:function(d){a&&a.l(d),t=Y(d),e=R(d,"DIV",{class:!0});var m=V(e);me(i.$$.fragment,m),s=Y(m),me(n.$$.fragment,m),m.forEach(h),this.h()},h:function(){T(e,"class","side-by-side-container svelte-rt5px1"),F(e,N,2736,6,93105)},m:function(d,m){a&&a.m(d,m),O(d,t,m),O(d,e,m),de(i,e,null),g(e,s),de(n,e,null),c=!0},p:function(d,m){!d[2]&&d[6].length>0?a?(a.p(d,m),m[0]&68&&U(a,1)):(a=Ht(d),a.c(),U(a,1),a.m(t.parentNode,t)):a&&(Ae(),Q(a,1,1,()=>{a=null}),Te());const v={};m[0]&8395649|m[3]&4096&&(v.$$scope={dirty:m,ctx:d}),i.$set(v);const q={};m[0]&16384&&(q.frequency=d[14]),m[0]&32768&&(q.note=d[15]),m[0]&8192&&(q.volume=d[13]),m[0]&1&&(q.isMuted=d[0]!=="guiding"),n.$set(q)},i:function(d){c||(U(a),U(i.$$.fragment,d),U(n.$$.fragment,d),c=!0)},o:function(d){Q(a),Q(i.$$.fragment,d),Q(n.$$.fragment,d),c=!1},d:function(d){d&&(h(t),h(e)),a&&a.d(d),fe(i),fe(n)}};return $("SvelteRegisterBlock",{block:u,id:xt.name,type:"if",source:"(2714:4) {#if trainingPhase !== 'results'}",ctx:r}),u}function Ht(r){let t,e;t=new Je({props:{class:"warning-card",$$slots:{default:[Jn]},$$scope:{ctx:r}},$$inline:!0});const i={c:function(){ge(t.$$.fragment)},l:function(n){me(t.$$.fragment,n)},m:function(n,c){de(t,n,c),e=!0},p:function(n,c){const a={};c[0]&64|c[3]&4096&&(a.$$scope={dirty:c,ctx:n}),t.$set(a)},i:function(n){e||(U(t.$$.fragment,n),e=!0)},o:function(n){Q(t.$$.fragment,n),e=!1},d:function(n){fe(t,n)}};return $("SvelteRegisterBlock",{block:i,id:Ht.name,type:"if",source:"(2717:6) {#if !microphoneHealthy && microphoneErrors.length > 0}",ctx:r}),i}function Vt(r){let t,e=r[102]+"",i;const s={c:function(){t=M("li"),i=J(e),this.h()},l:function(c){t=R(c,"LI",{class:!0});var a=V(t);i=W(a,e),a.forEach(h),this.h()},h:function(){T(t,"class","svelte-rt5px1"),F(t,N,2725,16,92824)},m:function(c,a){O(c,t,a),g(t,i)},p:function(c,a){a[0]&64&&e!==(e=c[102]+"")&&De(i,e)},d:function(c){c&&h(t)}};return $("SvelteRegisterBlock",{block:s,id:Vt.name,type:"each",source:"(2725:14) {#each microphoneErrors as error}",ctx:r}),s}function Jn(r){let t,e,i="⚠️ マイク接続に問題があります",s,n,c,a="マイクが正常に動作していません。以下の問題が検出されました：",u,f,d,m,v,q="解決方法:",p,y=lt(r[6]),b=[];for(let w=0;w<y.length;w+=1)b[w]=Vt(In(r,y,w));const z={c:function(){t=M("div"),e=M("h3"),e.textContent=i,s=Z(),n=M("div"),c=M("p"),c.textContent=a,u=Z(),f=M("ul");for(let I=0;I<b.length;I+=1)b[I].c();d=Z(),m=M("p"),v=M("strong"),v.textContent=q,p=J(" ページを再読み込みしてマイク許可を再度取得してください。"),this.h()},l:function(I){t=R(I,"DIV",{class:!0});var X=V(t);e=R(X,"H3",{class:!0,"data-svelte-h":!0}),ve(e)!=="svelte-15qec5x"&&(e.textContent=i),X.forEach(h),s=Y(I),n=R(I,"DIV",{class:!0});var P=V(n);c=R(P,"P",{class:!0,"data-svelte-h":!0}),ve(c)!=="svelte-171o2p0"&&(c.textContent=a),u=Y(P),f=R(P,"UL",{class:!0});var L=V(f);for(let _=0;_<b.length;_+=1)b[_].l(L);L.forEach(h),d=Y(P),m=R(P,"P",{class:!0});var B=V(m);v=R(B,"STRONG",{"data-svelte-h":!0}),ve(v)!=="svelte-79o66n"&&(v.textContent=q),p=W(B," ページを再読み込みしてマイク許可を再度取得してください。"),B.forEach(h),P.forEach(h),this.h()},h:function(){T(e,"class","section-title svelte-rt5px1"),F(e,N,2719,12,92548),T(t,"class","card-header svelte-rt5px1"),F(t,N,2718,10,92510),T(c,"class","warning-message svelte-rt5px1"),F(c,N,2722,12,92662),T(f,"class","error-list svelte-rt5px1"),F(f,N,2723,12,92736),F(v,N,2729,14,92935),T(m,"class","fix-instruction svelte-rt5px1"),F(m,N,2728,12,92893),T(n,"class","card-content svelte-rt5px1"),F(n,N,2721,10,92623)},m:function(I,X){O(I,t,X),g(t,e),O(I,s,X),O(I,n,X),g(n,c),g(n,u),g(n,f);for(let P=0;P<b.length;P+=1)b[P]&&b[P].m(f,null);g(n,d),g(n,m),g(m,v),g(m,p)},p:function(I,X){if(X[0]&64){y=lt(I[6]);let P;for(P=0;P<y.length;P+=1){const L=In(I,y,P);b[P]?b[P].p(L,X):(b[P]=Vt(L),b[P].c(),b[P].m(f,null))}for(;P<b.length;P+=1)b[P].d(1);b.length=y.length}},d:function(I){I&&(h(t),h(s),h(n)),xn(b,I)}};return $("SvelteRegisterBlock",{block:z,id:Jn.name,type:"slot",source:'(2718:8) <Card class=\\"warning-card\\">',ctx:r}),z}function Kn(r){let t;function e(c,a){return c[9]?$n:c[0]==="guiding"?Zn:c[0]==="results"?Yn:Xn}let i=e(r),s=i(r);const n={c:function(){t=M("div"),s.c(),this.h()},l:function(a){t=R(a,"DIV",{class:!0});var u=V(t);s.l(u),u.forEach(h),this.h()},h:function(){T(t,"class","continuous-status svelte-rt5px1"),F(t,N,2753,14,93754)},m:function(a,u){O(a,t,u),s.m(t,null)},p:function(a,u){i===(i=e(a))&&s?s.p(a,u):(s.d(1),s=i(a),s&&(s.c(),s.m(t,null)))},i:Et,o:Et,d:function(a){a&&h(t),s.d()}};return $("SvelteRegisterBlock",{block:n,id:Kn.name,type:"else",source:"(2752:12) {:else}",ctx:r}),n}function Qn(r){let t,e;t=new ut({props:{variant:"primary",$$slots:{default:[eo]},$$scope:{ctx:r}},$$inline:!0}),t.$on("click",r[30]);const i={c:function(){ge(t.$$.fragment)},l:function(n){me(t.$$.fragment,n)},m:function(n,c){de(t,n,c),e=!0},p:function(n,c){const a={};c[3]&4096&&(a.$$scope={dirty:c,ctx:n}),t.$set(a)},i:function(n){e||(U(t.$$.fragment,n),e=!0)},o:function(n){Q(t.$$.fragment,n),e=!1},d:function(n){fe(t,n)}};return $("SvelteRegisterBlock",{block:i,id:Qn.name,type:"if",source:"(2745:12) {#if trainingPhase === 'setup' && !isPlaying && !($currentSessionId > 1)}",ctx:r}),i}function Xn(r){let t,e,i,s;const n={c:function(){t=M("div"),e=J("⚡ 連続モード進行中 ("),i=J(r[23]),s=J("/8)"),this.h()},l:function(a){t=R(a,"DIV",{class:!0});var u=V(t);e=W(u,"⚡ 連続モード進行中 ("),i=W(u,r[23]),s=W(u,"/8)"),u.forEach(h),this.h()},h:function(){T(t,"class","status-text svelte-rt5px1"),F(t,N,2767,18,94344)},m:function(a,u){O(a,t,u),g(t,e),g(t,i),g(t,s)},p:function(a,u){u[0]&8388608&&De(i,a[23])},d:function(a){a&&h(t)}};return $("SvelteRegisterBlock",{block:n,id:Xn.name,type:"else",source:"(2767:16) {:else}",ctx:r}),n}function Yn(r){let t,e,i,s;const n={c:function(){t=M("div"),e=J("✅ セッション "),i=J(r[23]),s=J("/8 完了"),this.h()},l:function(a){t=R(a,"DIV",{class:!0});var u=V(t);e=W(u,"✅ セッション "),i=W(u,r[23]),s=W(u,"/8 完了"),u.forEach(h),this.h()},h:function(){T(t,"class","status-text svelte-rt5px1"),F(t,N,2763,18,94198)},m:function(a,u){O(a,t,u),g(t,e),g(t,i),g(t,s)},p:function(a,u){u[0]&8388608&&De(i,a[23])},d:function(a){a&&h(t)}};return $("SvelteRegisterBlock",{block:n,id:Yn.name,type:"if",source:"(2763:54) ",ctx:r}),n}function Zn(r){let t,e,i,s;const n={c:function(){t=M("div"),e=J("🎤 セッション "),i=J(r[23]),s=J("/8: ドレミ発声中"),this.h()},l:function(a){t=R(a,"DIV",{class:!0});var u=V(t);e=W(u,"🎤 セッション "),i=W(u,r[23]),s=W(u,"/8: ドレミ発声中"),u.forEach(h),this.h()},h:function(){T(t,"class","status-text svelte-rt5px1"),F(t,N,2759,18,94015)},m:function(a,u){O(a,t,u),g(t,e),g(t,i),g(t,s)},p:function(a,u){u[0]&8388608&&De(i,a[23])},d:function(a){a&&h(t)}};return $("SvelteRegisterBlock",{block:n,id:Zn.name,type:"if",source:"(2759:54) ",ctx:r}),n}function $n(r){let t,e,i,s;const n={c:function(){t=M("div"),e=J("🎵 基音 "),i=J(r[23]),s=J("/8 再生中..."),this.h()},l:function(a){t=R(a,"DIV",{class:!0});var u=V(t);e=W(u,"🎵 基音 "),i=W(u,r[23]),s=W(u,"/8 再生中..."),u.forEach(h),this.h()},h:function(){T(t,"class","status-text svelte-rt5px1"),F(t,N,2755,18,93836)},m:function(a,u){O(a,t,u),g(t,e),g(t,i),g(t,s)},p:function(a,u){u[0]&8388608&&De(i,a[23])},d:function(a){a&&h(t)}};return $("SvelteRegisterBlock",{block:n,id:$n.name,type:"if",source:"(2755:16) {#if isPlaying}",ctx:r}),n}function eo(r){let t;const e={c:function(){t=J("⚡ 連続チャレンジ開始（8セッション）")},l:function(s){t=W(s,"⚡ 連続チャレンジ開始（8セッション）")},m:function(s,n){O(s,t,n)},d:function(s){s&&h(t)}};return $("SvelteRegisterBlock",{block:e,id:eo.name,type:"slot",source:'(2746:14) <Button                  variant=\\"primary\\"                 on:click={startContinuousMode}               >',ctx:r}),e}function zt(r){let t,e,i,s,n,c=(r[8]||0).toFixed(1)+"",a,u;const f={c:function(){t=M("div"),e=J("現在の基音: "),i=M("strong"),s=J(r[7]),n=J(" ("),a=J(c),u=J("Hz)"),this.h()},l:function(m){t=R(m,"DIV",{class:!0});var v=V(t);e=W(v,"現在の基音: "),i=R(v,"STRONG",{});var q=V(i);s=W(q,r[7]),q.forEach(h),n=W(v," ("),a=W(v,c),u=W(v,"Hz)"),v.forEach(h),this.h()},h:function(){F(i,N,2776,23,94624),T(t,"class","base-note-info svelte-rt5px1"),F(t,N,2775,14,94572)},m:function(m,v){O(m,t,v),g(t,e),g(t,i),g(i,s),g(t,n),g(t,a),g(t,u)},p:function(m,v){v[0]&128&&De(s,m[7]),v[0]&256&&c!==(c=(m[8]||0).toFixed(1)+"")&&De(a,c)},d:function(m){m&&h(t)}};return $("SvelteRegisterBlock",{block:f,id:zt.name,type:"if",source:"(2775:12) {#if currentBaseNote}",ctx:r}),f}function to(r){let t,e,i="🎹 基音再生",s,n,c,a,u,f,d,m,v="ガイド開始まで",q,p,y,b,z,w,I,X;const P=[Qn,Kn],L=[];function B(D,C){return D[0]==="setup"&&!D[9]&&!(D[23]>1)?0:1}c=B(r),a=L[c]=P[c](r);let _=r[7]&&zt(r);w=new Ln({props:{size:"20"},$$inline:!0});const ee={c:function(){t=M("div"),e=M("h3"),e.textContent=i,s=Z(),n=M("div"),a.c(),u=Z(),_&&_.c(),f=Z(),d=M("div"),m=M("div"),m.textContent=v,q=Z(),p=M("div"),y=M("div"),b=Z(),z=M("div"),ge(w.$$.fragment),this.h()},l:function(C){t=R(C,"DIV",{class:!0});var x=V(t);e=R(x,"H3",{class:!0,"data-svelte-h":!0}),ve(e)!=="svelte-syc53b"&&(e.textContent=i),x.forEach(h),s=Y(C),n=R(C,"DIV",{class:!0});var j=V(n);a.l(j),u=Y(j),_&&_.l(j),f=Y(j),d=R(j,"DIV",{class:!0});var oe=V(d);m=R(oe,"DIV",{class:!0,"data-svelte-h":!0}),ve(m)!=="svelte-1dufnpv"&&(m.textContent=v),q=Y(oe),p=R(oe,"DIV",{class:!0});var E=V(p);y=R(E,"DIV",{class:!0,style:!0}),V(y).forEach(h),b=Y(E),z=R(E,"DIV",{class:!0});var A=V(z);me(w.$$.fragment,A),A.forEach(h),E.forEach(h),oe.forEach(h),j.forEach(h),this.h()},h:function(){T(e,"class","section-title svelte-rt5px1"),F(e,N,2740,12,93269),T(t,"class","card-header svelte-rt5px1"),F(t,N,2739,10,93231),T(m,"class","guide-start-label svelte-rt5px1"),F(m,N,2782,14,94856),T(y,"class","guide-progress-fill svelte-rt5px1"),Qe(y,"width",r[11]+"%"),F(y,N,2784,16,94961),T(z,"class",I="guide-music-icon "+(r[12]?"glowing":"")+" svelte-rt5px1"),F(z,N,2788,16,95109),T(p,"class","guide-start-bar svelte-rt5px1"),F(p,N,2783,14,94915),T(d,"class","guide-start-bar-container svelte-rt5px1"),F(d,N,2781,12,94802),T(n,"class","card-content svelte-rt5px1"),F(n,N,2742,10,93335)},m:function(C,x){O(C,t,x),g(t,e),O(C,s,x),O(C,n,x),L[c].m(n,null),g(n,u),_&&_.m(n,null),g(n,f),g(n,d),g(d,m),g(d,q),g(d,p),g(p,y),g(p,b),g(p,z),de(w,z,null),X=!0},p:function(C,x){let j=c;c=B(C),c===j?L[c].p(C,x):(Ae(),Q(L[j],1,1,()=>{L[j]=null}),Te(),a=L[c],a?a.p(C,x):(a=L[c]=P[c](C),a.c()),U(a,1),a.m(n,u)),C[7]?_?_.p(C,x):(_=zt(C),_.c(),_.m(n,f)):_&&(_.d(1),_=null),(!X||x[0]&2048)&&Qe(y,"width",C[11]+"%"),(!X||x[0]&4096&&I!==(I="guide-music-icon "+(C[12]?"glowing":"")+" svelte-rt5px1"))&&T(z,"class",I)},i:function(C){X||(U(a),U(w.$$.fragment,C),X=!0)},o:function(C){Q(a),Q(w.$$.fragment,C),X=!1},d:function(C){C&&(h(t),h(s),h(n)),L[c].d(),_&&_.d(),fe(w)}};return $("SvelteRegisterBlock",{block:ee,id:to.name,type:"slot",source:'(2739:8) <Card class=\\"main-card half-width\\">',ctx:r}),ee}function Lt(r){let t,e;t=new Je({props:{class:"main-card",$$slots:{default:[no]},$$scope:{ctx:r}},$$inline:!0});const i={c:function(){ge(t.$$.fragment)},l:function(n){me(t.$$.fragment,n)},m:function(n,c){de(t,n,c),e=!0},p:function(n,c){const a={};c[0]&1025|c[3]&4096&&(a.$$scope={dirty:c,ctx:n}),t.$set(a)},i:function(n){e||(U(t.$$.fragment,n),e=!0)},o:function(n){Q(t.$$.fragment,n),e=!1},d:function(n){fe(t,n)}};return $("SvelteRegisterBlock",{block:i,id:Lt.name,type:"if",source:"(2811:4) {#if trainingPhase !== 'results'}",ctx:r}),i}function jt(r){let t,e=(r[99].name||`音階${r[101]+1}`)+"",i,s,n;const c={c:function(){t=M("div"),i=J(e),s=Z(),this.h()},l:function(u){t=R(u,"DIV",{class:!0});var f=V(t);i=W(f,e),s=Y(f),f.forEach(h),this.h()},h:function(){T(t,"class",n="scale-item "+(r[99].state||"inactive")+" svelte-rt5px1"),F(t,N,2819,14,96060)},m:function(u,f){O(u,t,f),g(t,i),g(t,s)},p:function(u,f){f[0]&1024&&e!==(e=(u[99].name||`音階${u[101]+1}`)+"")&&De(i,e),f[0]&1024&&n!==(n="scale-item "+(u[99].state||"inactive")+" svelte-rt5px1")&&T(t,"class",n)},d:function(u){u&&h(t)}};return $("SvelteRegisterBlock",{block:c,id:jt.name,type:"each",source:"(2819:12) {#each scaleSteps as step, index}",ctx:r}),c}function Ot(r){let t,e,i,s="ドレミファソラシド",n;const c={c:function(){t=M("div"),e=J("ガイドに合わせて "),i=M("strong"),i.textContent=s,n=J(" を歌ってください"),this.h()},l:function(u){t=R(u,"DIV",{class:!0});var f=V(t);e=W(f,"ガイドに合わせて "),i=R(f,"STRONG",{"data-svelte-h":!0}),ve(i)!=="svelte-1dipf74"&&(i.textContent=s),n=W(f," を歌ってください"),f.forEach(h),this.h()},h:function(){F(i,N,2828,23,96361),T(t,"class","guide-instruction svelte-rt5px1"),F(t,N,2827,12,96306)},m:function(u,f){O(u,t,f),g(t,e),g(t,i),g(t,n)},d:function(u){u&&h(t)}};return $("SvelteRegisterBlock",{block:c,id:Ot.name,type:"if",source:"(2827:10) {#if trainingPhase === 'guiding'}",ctx:r}),c}function no(r){let t,e,i="🎵 ドレミ音階ガイド",s,n,c,a,u=lt(r[10]),f=[];for(let v=0;v<u.length;v+=1)f[v]=jt(Nn(r,u,v));let d=r[0]==="guiding"&&Ot(r);const m={c:function(){t=M("div"),e=M("h3"),e.textContent=i,s=Z(),n=M("div"),c=M("div");for(let q=0;q<f.length;q+=1)f[q].c();a=Z(),d&&d.c(),this.h()},l:function(q){t=R(q,"DIV",{class:!0});var p=V(t);e=R(p,"H3",{class:!0,"data-svelte-h":!0}),ve(e)!=="svelte-1mor0as"&&(e.textContent=i),p.forEach(h),s=Y(q),n=R(q,"DIV",{class:!0});var y=V(n);c=R(y,"DIV",{class:!0});var b=V(c);for(let z=0;z<f.length;z+=1)f[z].l(b);b.forEach(h),a=Y(y),d&&d.l(y),y.forEach(h),this.h()},h:function(){T(e,"class","section-title svelte-rt5px1"),F(e,N,2814,10,95871),T(t,"class","card-header svelte-rt5px1"),F(t,N,2813,8,95835),T(c,"class","scale-guide svelte-rt5px1"),F(c,N,2817,10,95974),T(n,"class","card-content svelte-rt5px1"),F(n,N,2816,8,95937)},m:function(q,p){O(q,t,p),g(t,e),O(q,s,p),O(q,n,p),g(n,c);for(let y=0;y<f.length;y+=1)f[y]&&f[y].m(c,null);g(n,a),d&&d.m(n,null)},p:function(q,p){if(p[0]&1024){u=lt(q[10]);let y;for(y=0;y<u.length;y+=1){const b=Nn(q,u,y);f[y]?f[y].p(b,p):(f[y]=jt(b),f[y].c(),f[y].m(c,null))}for(;y<f.length;y+=1)f[y].d(1);f.length=u.length}q[0]==="guiding"?d||(d=Ot(q),d.c(),d.m(n,null)):d&&(d.d(1),d=null)},d:function(q){q&&(h(t),h(s),h(n)),xn(f,q),d&&d.d()}};return $("SvelteRegisterBlock",{block:m,id:no.name,type:"slot",source:'(2813:6) <Card class=\\"main-card\\">',ctx:r}),m}function Gt(r){let t,e,i,s,n,c,a;const u=[so,oo],f=[];function d(y,b){return y[4]&&y[5]?0:y[21]?1:-1}~(t=d(r))&&(e=f[t]=u[t](r));const m=[ao,ro],v=[];function q(y,b){return y[0]==="results"&&y[5]?0:y[0]==="results"&&!y[5]?1:-1}~(s=q(r))&&(n=v[s]=m[s](r));const p={c:function(){e&&e.c(),i=Z(),n&&n.c(),c=Le()},l:function(b){e&&e.l(b),i=Y(b),n&&n.l(b),c=Le()},m:function(b,z){~t&&f[t].m(b,z),O(b,i,z),~s&&v[s].m(b,z),O(b,c,z),a=!0},p:function(b,z){let w=t;t=d(b),t===w?~t&&f[t].p(b,z):(e&&(Ae(),Q(f[w],1,1,()=>{f[w]=null}),Te()),~t?(e=f[t],e?e.p(b,z):(e=f[t]=u[t](b),e.c()),U(e,1),e.m(i.parentNode,i)):e=null);let I=s;s=q(b),s===I?~s&&v[s].p(b,z):(n&&(Ae(),Q(v[I],1,1,()=>{v[I]=null}),Te()),~s?(n=v[s],n?n.p(b,z):(n=v[s]=m[s](b),n.c()),U(n,1),n.m(c.parentNode,c)):n=null)},i:function(b){a||(U(e),U(n),a=!0)},o:function(b){Q(e),Q(n),a=!1},d:function(b){b&&(h(i),h(c)),~t&&f[t].d(b),~s&&v[s].d(b)}};return $("SvelteRegisterBlock",{block:p,id:Gt.name,type:"if",source:"(2839:4) {#if trainingPhase === 'results'}",ctx:r}),p}function oo(r){var a,u;let t=console.log("🔍 [ContinuousMode] CurrentUnifiedScoreData structure:",{sessionHistoryLength:((a=r[21].sessionHistory)==null?void 0:a.length)||0,sessionHistory:((u=r[21].sessionHistory)==null?void 0:u.map(Bn))||[]})+"",e,i,s,n;s=new Kt({props:{scoreData:r[21],showDetails:!1,className:"mb-6 iphone-no-margin",currentScoreData:r[16],intervalData:r[3],consistencyData:r[17],feedbackData:r[18],technicalFeedbackData:r[19],sessionStatistics:r[20]},$$inline:!0});const c={c:function(){e=J(t),i=Z(),ge(s.$$.fragment)},l:function(d){e=W(d,t),i=Y(d),me(s.$$.fragment,d)},m:function(d,m){O(d,e,m),O(d,i,m),de(s,d,m),n=!0},p:function(d,m){var q,p;(!n||m[0]&2097152)&&t!==(t=console.log("🔍 [ContinuousMode] CurrentUnifiedScoreData structure:",{sessionHistoryLength:((q=d[21].sessionHistory)==null?void 0:q.length)||0,sessionHistory:((p=d[21].sessionHistory)==null?void 0:p.map(Bn))||[]})+"")&&De(e,t);const v={};m[0]&2097152&&(v.scoreData=d[21]),m[0]&65536&&(v.currentScoreData=d[16]),m[0]&8&&(v.intervalData=d[3]),m[0]&131072&&(v.consistencyData=d[17]),m[0]&262144&&(v.feedbackData=d[18]),m[0]&524288&&(v.technicalFeedbackData=d[19]),m[0]&1048576&&(v.sessionStatistics=d[20]),s.$set(v)},i:function(d){n||(U(s.$$.fragment,d),n=!0)},o:function(d){Q(s.$$.fragment,d),n=!1},d:function(d){d&&(h(e),h(i)),fe(s,d)}};return $("SvelteRegisterBlock",{block:c,id:oo.name,type:"if",source:"(2867:40) ",ctx:r}),c}function so(r){let t,e,i,s=r[4]&&Ut(r);e=new Kt({props:{scoreData:r[4],showDetails:!1,className:"mb-6 iphone-no-margin",currentScoreData:r[16],intervalData:r[3],consistencyData:r[17],feedbackData:r[18],technicalFeedbackData:r[19],sessionStatistics:r[20]},$$inline:!0});const n={c:function(){s&&s.c(),t=Z(),ge(e.$$.fragment)},l:function(a){s&&s.l(a),t=Y(a),me(e.$$.fragment,a)},m:function(a,u){s&&s.m(a,u),O(a,t,u),de(e,a,u),i=!0},p:function(a,u){a[4]?s?s.p(a,u):(s=Ut(a),s.c(),s.m(t.parentNode,t)):s&&(s.d(1),s=null);const f={};u[0]&16&&(f.scoreData=a[4]),u[0]&65536&&(f.currentScoreData=a[16]),u[0]&8&&(f.intervalData=a[3]),u[0]&131072&&(f.consistencyData=a[17]),u[0]&262144&&(f.feedbackData=a[18]),u[0]&524288&&(f.technicalFeedbackData=a[19]),u[0]&1048576&&(f.sessionStatistics=a[20]),e.$set(f)},i:function(a){i||(U(e.$$.fragment,a),i=!0)},o:function(a){Q(e.$$.fragment,a),i=!1},d:function(a){a&&h(t),s&&s.d(a),fe(e,a)}};return $("SvelteRegisterBlock",{block:n,id:so.name,type:"if",source:"(2841:6) {#if $unifiedScoreData && $isCompleted}",ctx:r}),n}function Ut(r){var s,n;let t=console.log("🔍 [ContinuousMode] UnifiedScoreData structure:",{sessionHistoryLength:((s=r[4].sessionHistory)==null?void 0:s.length)||0,sessionHistory:((n=r[4].sessionHistory)==null?void 0:n.map(Pn))||[]})+"",e;const i={c:function(){e=J(t)},l:function(a){e=W(a,t)},m:function(a,u){O(a,e,u)},p:function(a,u){var f,d;u[0]&16&&t!==(t=console.log("🔍 [ContinuousMode] UnifiedScoreData structure:",{sessionHistoryLength:((f=a[4].sessionHistory)==null?void 0:f.length)||0,sessionHistory:((d=a[4].sessionHistory)==null?void 0:d.map(Pn))||[]})+"")&&De(e,t)},d:function(a){a&&h(e)}};return $("SvelteRegisterBlock",{block:i,id:Ut.name,type:"if",source:"(2843:8) {#if $unifiedScoreData}",ctx:r}),i}function ro(r){let t,e;t=new Je({props:{class:"main-card bottom-action-card",$$slots:{default:[co]},$$scope:{ctx:r}},$$inline:!0});const i={c:function(){ge(t.$$.fragment)},l:function(n){me(t.$$.fragment,n)},m:function(n,c){de(t,n,c),e=!0},p:function(n,c){const a={};c[3]&4096&&(a.$$scope={dirty:c,ctx:n}),t.$set(a)},i:function(n){e||(U(t.$$.fragment,n),e=!0)},o:function(n){Q(t.$$.fragment,n),e=!1},d:function(n){fe(t,n)}};return $("SvelteRegisterBlock",{block:i,id:ro.name,type:"if",source:"(2907:61) ",ctx:r}),i}function ao(r){let t,e;t=new Je({props:{class:"main-card bottom-action-card",$$slots:{default:[io]},$$scope:{ctx:r}},$$inline:!0});const i={c:function(){ge(t.$$.fragment)},l:function(n){me(t.$$.fragment,n)},m:function(n,c){de(t,n,c),e=!0},p:function(n,c){const a={};c[0]&32|c[3]&4096&&(a.$$scope={dirty:c,ctx:n}),t.$set(a)},i:function(n){e||(U(t.$$.fragment,n),e=!0)},o:function(n){Q(t.$$.fragment,n),e=!1},d:function(n){fe(t,n)}};return $("SvelteRegisterBlock",{block:i,id:ao.name,type:"if",source:"(2896:6) {#if trainingPhase === 'results' && $isCompleted}",ctx:r}),i}function co(r){let t,e,i,s,n,c,a="次のセッションを準備中...";const u={c:function(){t=M("div"),e=M("div"),i=M("div"),s=M("div"),n=Z(),c=M("span"),c.textContent=a,this.h()},l:function(d){t=R(d,"DIV",{class:!0});var m=V(t);e=R(m,"DIV",{class:!0});var v=V(e);i=R(v,"DIV",{class:!0});var q=V(i);s=R(q,"DIV",{class:!0}),V(s).forEach(h),n=Y(q),c=R(q,"SPAN",{"data-svelte-h":!0}),ve(c)!=="svelte-11jhwau"&&(c.textContent=a),q.forEach(h),v.forEach(h),m.forEach(h),this.h()},h:function(){T(s,"class","spinner"),F(s,N,2912,16,99527),F(c,N,2913,16,99571),T(i,"class","auto-progress-indicator"),F(i,N,2911,14,99473),T(e,"class","continuous-mode-message"),F(e,N,2910,12,99421),T(t,"class","card-content svelte-rt5px1"),F(t,N,2909,10,99382)},m:function(d,m){O(d,t,m),g(t,e),g(e,i),g(i,s),g(i,n),g(i,c)},p:Et,d:function(d){d&&h(t)}};return $("SvelteRegisterBlock",{block:u,id:co.name,type:"slot",source:'(2909:8) <Card class=\\"main-card bottom-action-card\\">',ctx:r}),u}function io(r){let t,e,i;e=new Jt({props:{isCompleted:r[5],position:"bottom"},$$inline:!0}),e.$on("action",r[29]);const s={c:function(){t=M("div"),ge(e.$$.fragment),this.h()},l:function(c){t=R(c,"DIV",{class:!0});var a=V(t);me(e.$$.fragment,a),a.forEach(h),this.h()},h:function(){T(t,"class","card-content svelte-rt5px1"),F(t,N,2897,10,98940)},m:function(c,a){O(c,t,a),de(e,t,null),i=!0},p:function(c,a){const u={};a[0]&32&&(u.isCompleted=c[5]),e.$set(u)},i:function(c){i||(U(e.$$.fragment,c),i=!0)},o:function(c){Q(e.$$.fragment,c),i=!1},d:function(c){c&&h(t),fe(e)}};return $("SvelteRegisterBlock",{block:s,id:io.name,type:"slot",source:'(2897:8) <Card class=\\"main-card bottom-action-card\\">',ctx:r}),s}function lo(r){let t,e,i="⚡ 連続チャレンジモード",s,n,c="中級者向け：8セッション連続で基音が自動再生される集中トレーニング",a,u,f,d,m=uo+"",v,q,p=fo+"",y,b,z,w,I=mo+"",X,P,L,B,_,ee,D=r[1]==="granted"&&!r[25]&&Pt(r);const C=[On,jn],x=[];function j(E,A){return E[1]==="granted"?0:1}L=j(r),B=x[L]=C[L](r);const oe={c:function(){t=M("div"),e=M("h1"),e.textContent=i,s=Z(),n=M("p"),n.textContent=c,a=Z(),D&&D.c(),u=Z(),f=M("div"),d=J("📱 "),v=J(m),q=J(" | "),y=J(p),b=M("br"),z=Z(),w=M("small"),X=J(I),P=Z(),B.c(),_=Le(),this.h()},l:function(A){t=R(A,"DIV",{class:!0});var te=V(t);e=R(te,"H1",{class:!0,"data-svelte-h":!0}),ve(e)!=="svelte-1nub9gt"&&(e.textContent=i),s=Y(te),n=R(te,"P",{class:!0,"data-svelte-h":!0}),ve(n)!=="svelte-gneggn"&&(n.textContent=c),a=Y(te),D&&D.l(te),u=Y(te),f=R(te,"DIV",{class:!0});var K=V(f);d=W(K,"📱 "),v=W(K,m),q=W(K," | "),y=W(K,p),b=R(K,"BR",{}),z=Y(K),w=R(K,"SMALL",{style:!0});var ye=V(w);X=W(ye,I),ye.forEach(h),K.forEach(h),te.forEach(h),P=Y(A),B.l(A),_=Le(),this.h()},h:function(){T(e,"class","page-title svelte-rt5px1"),F(e,N,2652,4,90211),T(n,"class","page-description svelte-rt5px1"),F(n,N,2653,4,90256),F(b,N,2687,54,91492),Qe(w,"font-size","0.6rem"),F(w,N,2688,6,91504),T(f,"class","debug-info svelte-rt5px1"),F(f,N,2686,4,91413),T(t,"class","header-section svelte-rt5px1"),F(t,N,2651,2,90178)},m:function(A,te){O(A,t,te),g(t,e),g(t,s),g(t,n),g(t,a),D&&D.m(t,null),g(t,u),g(t,f),g(f,d),g(f,v),g(f,q),g(f,y),g(f,b),g(f,z),g(f,w),g(w,X),O(A,P,te),x[L].m(A,te),O(A,_,te),ee=!0},p:function(A,te){A[1]==="granted"&&!A[25]?D?(D.p(A,te),te[0]&33554434&&U(D,1)):(D=Pt(A),D.c(),U(D,1),D.m(t,u)):D&&(Ae(),Q(D,1,1,()=>{D=null}),Te());let K=L;L=j(A),L===K?x[L].p(A,te):(Ae(),Q(x[K],1,1,()=>{x[K]=null}),Te(),B=x[L],B?B.p(A,te):(B=x[L]=C[L](A),B.c()),U(B,1),B.m(_.parentNode,_))},i:function(A){ee||(U(D),U(B),ee=!0)},o:function(A){Q(D),Q(B),ee=!1},d:function(A){A&&(h(t),h(P),h(_)),D&&D.d(),x[L].d(A)}};return $("SvelteRegisterBlock",{block:oe,id:lo.name,type:"slot",source:"(2648:0) <PageLayout>",ctx:r}),oe}function Wt(r){let t,e,i;e=new Hn({props:{$$slots:{default:[lo]},$$scope:{ctx:r}},$$inline:!0});const s={c:function(){t=Z(),ge(e.$$.fragment),this.h()},l:function(c){ko("svelte-13kpo59",Mn.head).forEach(h),t=Y(c),me(e.$$.fragment,c),this.h()},h:function(){Mn.title="連続チャレンジモード - 相対音感トレーニング"},m:function(c,a){O(c,t,a),de(e,c,a),i=!0},p:function(c,a){const u={};a[0]&67108863|a[3]&4096&&(u.$$scope={dirty:a,ctx:c}),e.$set(u)},i:function(c){i||(U(e.$$.fragment,c),i=!0)},o:function(c){Q(e.$$.fragment,c),i=!1},d:function(c){c&&h(t),fe(e,c)}};return $("SvelteRegisterBlock",{block:s,id:Wt.name,type:"component",source:"",ctx:r}),s}const uo="v2.3.1-ANIMATED",fo="07/29 04:15",mo="🎬 評価分布アニメーション実装・UX向上";function An(){const r=/iPhone/.test(navigator.userAgent),t=/iPad/.test(navigator.userAgent),e=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document;return r||t||e?(console.log("🔊 [RandomTraining] iOS/iPadOS検出 - 音量35dB設定"),35):(console.log("🔊 [RandomTraining] PC検出 - 音量-6dB設定"),-6)}function Xo(){return{mode:"continuous",timestamp:new Date,duration:480,totalNotes:64,measuredNotes:59,averageAccuracy:79,baseNote:"C5",baseFrequency:523.25,sessionHistory:[{grade:"excellent",accuracy:92,baseNote:"C4",baseFrequency:261.63,timestamp:new Date(Date.now()-7*6e4),measuredNotes:8,noteResults:[{name:"ド",note:"ド",frequency:262,detectedFrequency:264,cents:13,grade:"excellent"},{name:"レ",note:"レ",frequency:294,detectedFrequency:291,cents:-18,grade:"good"},{name:"ミ",note:"ミ",frequency:330,detectedFrequency:335,cents:26,grade:"pass"},{name:"ファ",note:"ファ",frequency:349,detectedFrequency:346,cents:-15,grade:"excellent"},{name:"ソ",note:"ソ",frequency:392,detectedFrequency:388,cents:-18,grade:"good"},{name:"ラ",note:"ラ",frequency:440,detectedFrequency:444,cents:16,grade:"good"},{name:"シ",note:"シ",frequency:494,detectedFrequency:499,cents:17,grade:"good"},{name:"ド（高）",note:"ド（高）",frequency:523,detectedFrequency:520,cents:-10,grade:"excellent"}]},{grade:"good",accuracy:78,baseNote:"D4",baseFrequency:293.66,timestamp:new Date(Date.now()-6*6e4),measuredNotes:7,noteResults:[{name:"ド",note:"ド",frequency:294,detectedFrequency:290,cents:-23,grade:"good"},{name:"レ",note:"レ",frequency:330,detectedFrequency:340,cents:53,grade:"needWork"},{name:"ミ",note:"ミ",frequency:370,detectedFrequency:375,cents:23,grade:"good"},{name:"ファ",note:"ファ",frequency:392,detectedFrequency:385,cents:-31,grade:"pass"},{name:"ソ",note:"ソ",frequency:440,detectedFrequency:432,cents:-31,grade:"pass"},{name:"ラ",note:"ラ",frequency:494,detectedFrequency:510,cents:56,grade:"needWork"},{name:"シ",note:"シ",frequency:554,detectedFrequency:null,cents:null,grade:"notMeasured"},{name:"ド（高）",note:"ド（高）",frequency:587,detectedFrequency:580,cents:-21,grade:"good"}]},{grade:"excellent",accuracy:95,baseNote:"E4",baseFrequency:329.63,timestamp:new Date(Date.now()-5*6e4),measuredNotes:8,noteResults:[{name:"ド",note:"ド",frequency:330,detectedFrequency:332,cents:10,grade:"excellent"},{name:"レ",note:"レ",frequency:370,detectedFrequency:368,cents:-9,grade:"excellent"},{name:"ミ",note:"ミ",frequency:415,detectedFrequency:418,cents:12,grade:"excellent"},{name:"ファ",note:"ファ",frequency:440,detectedFrequency:436,cents:-16,grade:"good"},{name:"ソ",note:"ソ",frequency:494,detectedFrequency:497,cents:11,grade:"excellent"},{name:"ラ",note:"ラ",frequency:554,detectedFrequency:551,cents:-9,grade:"excellent"},{name:"シ",note:"シ",frequency:622,detectedFrequency:625,cents:8,grade:"excellent"},{name:"ド（高）",note:"ド（高）",frequency:659,detectedFrequency:655,cents:-10,grade:"excellent"}]},{grade:"needWork",accuracy:45,baseNote:"F4",baseFrequency:349.23,timestamp:new Date(Date.now()-4*6e4),measuredNotes:6,noteResults:[{name:"ド",note:"ド",frequency:349,detectedFrequency:345,cents:-20,grade:"good"},{name:"レ",note:"レ",frequency:392,detectedFrequency:420,cents:124,grade:"needWork"},{name:"ミ",note:"ミ",frequency:440,detectedFrequency:435,cents:-20,grade:"good"},{name:"ファ",note:"ファ",frequency:466,detectedFrequency:520,cents:195,grade:"needWork"},{name:"ソ",note:"ソ",frequency:523,detectedFrequency:410,cents:-455,grade:"needWork"},{name:"ラ",note:"ラ",frequency:587,detectedFrequency:null,cents:null,grade:"notMeasured"},{name:"シ",note:"シ",frequency:659,detectedFrequency:650,cents:-24,grade:"good"},{name:"ド（高）",note:"ド（高）",frequency:698,detectedFrequency:null,cents:null,grade:"notMeasured"}]},{grade:"good",accuracy:85,baseNote:"G4",baseFrequency:392,timestamp:new Date(Date.now()-3*6e4),measuredNotes:8,noteResults:[{name:"ド",note:"ド",frequency:392,detectedFrequency:395,cents:13,grade:"excellent"},{name:"レ",note:"レ",frequency:440,detectedFrequency:438,cents:-8,grade:"excellent"},{name:"ミ",note:"ミ",frequency:494,detectedFrequency:500,cents:21,grade:"good"},{name:"ファ",note:"ファ",frequency:523,detectedFrequency:520,cents:-10,grade:"excellent"},{name:"ソ",note:"ソ",frequency:587,detectedFrequency:595,cents:24,grade:"good"},{name:"ラ",note:"ラ",frequency:659,detectedFrequency:665,cents:16,grade:"good"},{name:"シ",note:"シ",frequency:740,detectedFrequency:755,cents:35,grade:"pass"},{name:"ド（高）",note:"ド（高）",frequency:784,detectedFrequency:780,cents:-9,grade:"excellent"}]},{grade:"excellent",accuracy:94,baseNote:"A4",baseFrequency:440,timestamp:new Date(Date.now()-2*6e4),measuredNotes:8,noteResults:[{name:"ド",note:"ド",frequency:440,detectedFrequency:442,cents:8,grade:"excellent"},{name:"レ",note:"レ",frequency:494,detectedFrequency:492,cents:-7,grade:"excellent"},{name:"ミ",note:"ミ",frequency:554,detectedFrequency:558,cents:12,grade:"excellent"},{name:"ファ",note:"ファ",frequency:587,detectedFrequency:585,cents:-6,grade:"excellent"},{name:"ソ",note:"ソ",frequency:659,detectedFrequency:665,cents:16,grade:"good"},{name:"ラ",note:"ラ",frequency:740,detectedFrequency:738,cents:-5,grade:"excellent"},{name:"シ",note:"シ",frequency:831,detectedFrequency:840,cents:19,grade:"good"},{name:"ド（高）",note:"ド（高）",frequency:880,detectedFrequency:882,cents:4,grade:"excellent"}]},{grade:"pass",accuracy:68,baseNote:"Bb4",baseFrequency:466.16,timestamp:new Date(Date.now()-1*6e4),measuredNotes:7,noteResults:[{name:"ド",note:"ド",frequency:466,detectedFrequency:470,cents:15,grade:"excellent"},{name:"レ",note:"レ",frequency:523,detectedFrequency:535,cents:39,grade:"pass"},{name:"ミ",note:"ミ",frequency:587,detectedFrequency:600,cents:38,grade:"pass"},{name:"ファ",note:"ファ",frequency:622,detectedFrequency:615,cents:-19,grade:"good"},{name:"ソ",note:"ソ",frequency:698,detectedFrequency:720,cents:54,grade:"needWork"},{name:"ラ",note:"ラ",frequency:784,detectedFrequency:null,cents:null,grade:"notMeasured"},{name:"シ",note:"シ",frequency:880,detectedFrequency:895,cents:29,grade:"pass"},{name:"ド（高）",note:"ド（高）",frequency:932,detectedFrequency:925,cents:-13,grade:"excellent"}]},{grade:"good",accuracy:82,baseNote:"C5",baseFrequency:523.25,timestamp:new Date,measuredNotes:8,noteResults:[{name:"ド",note:"ド",frequency:523,detectedFrequency:526,cents:10,grade:"excellent"},{name:"レ",note:"レ",frequency:587,detectedFrequency:584,cents:-9,grade:"excellent"},{name:"ミ",note:"ミ",frequency:659,detectedFrequency:665,cents:16,grade:"good"},{name:"ファ",note:"ファ",frequency:698,detectedFrequency:692,cents:-15,grade:"excellent"},{name:"ソ",note:"ソ",frequency:784,detectedFrequency:795,cents:24,grade:"good"},{name:"ラ",note:"ラ",frequency:880,detectedFrequency:890,cents:19,grade:"good"},{name:"シ",note:"シ",frequency:988,detectedFrequency:1010,cents:38,grade:"pass"},{name:"ド（高）",note:"ド（高）",frequency:1047,detectedFrequency:1042,cents:-8,grade:"excellent"}]}]}}function At(r){return[{scale:"ド",interval:"unison",intervalName:"ユニゾン"},{scale:"レ",interval:"major_second",intervalName:"長2度"},{scale:"ミ",interval:"major_third",intervalName:"長3度"},{scale:"ファ",interval:"perfect_fourth",intervalName:"完全4度"},{scale:"ソ",interval:"perfect_fifth",intervalName:"完全5度"},{scale:"ラ",interval:"major_sixth",intervalName:"長6度"},{scale:"シ",interval:"major_seventh",intervalName:"長7度"},{scale:"ド（高）",interval:"octave",intervalName:"オクターブ"}].map((e,i)=>{const s=r.find(n=>n.targetNote&&n.targetNote.includes(e.scale))||r[i];if(s&&s.accuracy!=="notMeasured"){const n=parseFloat(s.accuracy)||0,c=Math.round((100-n)*.5);return{type:e.interval,scale:e.scale,intervalName:e.intervalName,attempts:1,averageError:c,accuracy:n}}else return{type:e.interval,scale:e.scale,intervalName:e.intervalName,attempts:0,averageError:null,accuracy:0}})}function Tn(r){if(!r||!Array.isArray(r))return console.warn("⚠️ [RandomTraining] sessionHistory が無効です"),[];const t=[{type:"unison",scale:"ド",intervalName:"ユニゾン",noteIndex:0},{type:"major_second",scale:"レ",intervalName:"長2度",noteIndex:1},{type:"major_third",scale:"ミ",intervalName:"長3度",noteIndex:2},{type:"perfect_fourth",scale:"ファ",intervalName:"完全4度",noteIndex:3},{type:"perfect_fifth",scale:"ソ",intervalName:"完全5度",noteIndex:4},{type:"major_sixth",scale:"ラ",intervalName:"長6度",noteIndex:5},{type:"major_seventh",scale:"シ",intervalName:"長7度",noteIndex:6},{type:"octave",scale:"ド（高）",intervalName:"オクターブ",noteIndex:7}],e={};return t.forEach(i=>{e[i.type]={type:i.type,scale:i.scale,intervalName:i.intervalName,attempts:0,successCount:0,accuracySum:0,accuracyValues:[],errorValues:[]}}),r.forEach(i=>{!i.noteResults||!Array.isArray(i.noteResults)||i.noteResults.forEach((s,n)=>{if(n>=t.length)return;const c=t[n].type,a=e[c];if(a.attempts++,s.accuracy!=="notMeasured"&&typeof s.accuracy=="number"){a.accuracyValues.push(s.accuracy),a.accuracySum+=s.accuracy;const u=Math.round((100-s.accuracy)*.5);a.errorValues.push(u),s.accuracy>=70&&a.successCount++}})}),t.map(i=>{const s=e[i.type];if(s.attempts===0)return{type:i.type,scale:i.scale,intervalName:i.intervalName,attempts:0,averageError:null,accuracy:0};const n=s.accuracyValues.length>0?Math.round(s.accuracySum/s.accuracyValues.length):0,c=s.errorValues.length>0?Math.round(s.errorValues.reduce((u,f)=>u+f,0)/s.errorValues.length):null,a=s.accuracyValues.length>0?Math.round(s.successCount/s.accuracyValues.length*100):0;return{type:i.type,scale:i.scale,intervalName:i.intervalName,mastery:a,attempts:s.attempts,averageError:c,accuracy:n}})}function En(r){const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];if(r<=0)return"ーー";const i=Math.round(12*Math.log2(r/440)),s=(i+9+120)%12,n=Math.floor((i+9)/12)+4;return t[s]+n}function Tt(r,t){const e=[{factor:4,freq:r*4,description:"2オクターブ上"},{factor:3,freq:r*3,description:"1.5オクターブ上"},{factor:2.5,freq:r*2.5,description:"1.3オクターブ上"},{factor:2,freq:r*2,description:"1オクターブ上"},{factor:1.5,freq:r*1.5,description:"0.5オクターブ上"},{factor:1,freq:r,description:"補正なし"},{factor:.75,freq:r*.75,description:"0.33オクターブ下"},{factor:.67,freq:r*.67,description:"0.5オクターブ下"},{factor:.5,freq:r*.5,description:"1オクターブ下"},{factor:.4,freq:r*.4,description:"1.3オクターブ下"},{factor:.33,freq:r*.33,description:"1.5オクターブ下"},{factor:.25,freq:r*.25,description:"2オクターブ下"}];let i=null,s=1/0;const n=t*.5,c=t*1.5,a=e.filter(u=>u.freq>=n&&u.freq<=c);for(const u of a){const f=Math.abs(u.freq-t);f<s&&(s=f,i=u)}if(!i)for(const u of e){const f=Math.abs(u.freq-t);f<s&&(s=f,i=u)}return i?{correctedFrequency:i.freq,factor:i.factor,description:i.description,error:s}:{correctedFrequency:r,factor:1,description:"補正なし（フォールバック）",error:Math.abs(r-t)}}function ot(){try{"scrollTo"in window&&"behavior"in document.documentElement.style?window.scrollTo({top:0,behavior:"smooth"}):window.scrollTo(0,0),document.body&&(document.body.scrollTop=0),document.documentElement&&(document.documentElement.scrollTop=0),document.querySelectorAll("[data-scroll-container], .scroll-container, main").forEach(t=>{t.scrollTo?t.scrollTo(0,0):t.scrollTop=0})}catch(r){console.warn("スクロールエラー:",r);try{window.scroll(0,0)}catch(t){console.error("スクロール完全失敗:",t)}}}function go(r){}const Pn=(r,t)=>{var e;return{index:t,sessionId:r.sessionId,baseNote:r.baseNote,hasNoteResults:!!r.noteResults,noteResultsLength:((e=r.noteResults)==null?void 0:e.length)||0,accuracy:r.accuracy}},Bn=(r,t)=>{var e;return{index:t,sessionId:r.sessionId,baseNote:r.baseNote,hasNoteResults:!!r.noteResults,noteResultsLength:((e=r.noteResults)==null?void 0:e.length)||0,accuracy:r.accuracy}};function Yo(r,t,e){let i,s,n,c,a,u,f,d,m,v,q,p;Ne(Mt,"currentSessionId"),Ie(r,Mt,o=>e(23,n=o)),Ne(Dt,"unifiedScoreData"),Ie(r,Dt,o=>e(4,c=o)),Ne(Ct,"isCompleted"),Ie(r,Ct,o=>e(5,a=o)),Ne(_t,"page"),Ie(r,_t,o=>e(54,u=o)),Ne(qt,"remainingSessions"),Ie(r,qt,o=>e(55,f=o)),Ne(Ft,"nextBaseName"),Ie(r,Ft,o=>e(56,d=o)),Ne(Rt,"nextBaseNote"),Ie(r,Rt,o=>e(57,m=o)),Ne(wt,"sessionHistory"),Ie(r,wt,o=>e(24,v=o)),Ne(Nt,"trainingProgress"),Ie(r,Nt,o=>e(58,q=o)),Ne(kt,"isLoading"),Ie(r,kt,o=>e(25,p=o));let{$$slots:y={},$$scope:b}=t;Co("Page",y,[]);function z(o){return nt.evaluateOverall(o)}let w="setup",I=typeof window<"u"?new URLSearchParams(window.location.search).get("from")==="microphone-test"?(ie.info("[RandomTraining] マイクテストページからの遷移を検出"),"granted"):(ie.info("[RandomTraining] ダイレクトアクセスを検出"),"checking"):"checking",X=!0,P=[];const L=["ド","レ","ミ","ファ","ソ","ラ","シ","ド（高）"];let B="",_=0,ee=!1,D=0,C=L.map(o=>({name:o,state:"inactive",completed:!1})),x=null,j=!1,oe=0,E=!1,A=null,te=!1,K=[],ye=[],Se=0,Ee=0,je="ーー",He=0,Ve={correctCount:0,totalCount:8,averageAccuracy:0,averageTime:0,isCompleted:!1},Ce=null,ze={totalScore:0,grade:"C",componentScores:{pitchAccuracy:0,recognitionSpeed:0,intervalMastery:0,directionAccuracy:0,consistency:0}},ke=[],Pe=[],Oe={},Xe={},Fe={totalAttempts:0,successRate:0,averageScore:0,bestScore:0,sessionDuration:0,streakCount:0,fatigueLevel:"fresh",mostDifficultInterval:"-",mostSuccessfulInterval:"-",averageResponseTime:0,sessionStart:Date.now()},ft="intervals",ae=[],ue=null,he=null,Re=!0,ne=null,Be=null,st=null,rt=null,Ke=null;const Ge=[{note:"C4",name:"ド（中）",frequency:261.63,semitonesFromC:0},{note:"Db4",name:"ド#（中）",frequency:277.18,semitonesFromC:1},{note:"D4",name:"レ（中）",frequency:293.66,semitonesFromC:2},{note:"Eb4",name:"レ#（中）",frequency:311.13,semitonesFromC:3},{note:"E4",name:"ミ（中）",frequency:329.63,semitonesFromC:4},{note:"F4",name:"ファ（中）",frequency:349.23,semitonesFromC:5},{note:"Gb4",name:"ファ#（中）",frequency:369.99,semitonesFromC:6},{note:"Ab4",name:"ラb（中）",frequency:415.3,semitonesFromC:8},{note:"Bb3",name:"シb（低）",frequency:233.08,semitonesFromC:-2},{note:"B3",name:"シ（低）",frequency:246.94,semitonesFromC:-1}];async function Ue(){var o;e(1,I="checking");try{if(console.log("🎤 [RandomTraining] AudioManager経由でマイク許可確認開始"),!((o=navigator.mediaDevices)!=null&&o.getUserMedia)){e(1,I="error");return}const l=await We.initialize();st=l.audioContext,Be=l.mediaStream,rt=l.sourceNode,console.log("✅ [RandomTraining] AudioManager リソース取得完了"),e(1,I="granted"),e(0,w="setup"),setTimeout(async()=>{if(ne){ie.audio("[RandomTraining] PitchDetector初期化開始");const S=/iPhone/.test(navigator.userAgent),k=/iPad/.test(navigator.userAgent),H=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document;(k||H)&&(console.log("🔧 [RandomTraining] iPad検出 - マイク感度7.0x自動設定開始"),We.setSensitivity(7),console.log("✅ [RandomTraining] iPad マイク感度7.0x自動設定完了"));try{console.log("🎤 [RandomTraining] AudioManager再初期化開始（iPad対応）"),await We.initialize(),console.log("✅ [RandomTraining] AudioManager再初期化完了")}catch(G){console.warn("⚠️ AudioManager再初期化エラー:",G)}await ne.initialize(),ie.audio("[RandomTraining] PitchDetector初期化完了")}},200)}catch(l){ie.error("[RandomTraining] マイク許可エラー:",l),e(1,I=(l==null?void 0:l.name)==="NotAllowedError"?"denied":"error")}}function dt(){const o=m,l=d,S=Ge.find(k=>k.note===o)||Ge.find(k=>k.name===l)||Ge[0];if(e(7,B=S.name),e(8,_=S.frequency),ie.info(`[BaseNote] 基音設定（localStorage連携）: ${B} = ${_}Hz`),ie.info(`[BaseNote] localStorage基音情報: note=${o}, name=${l}`),!_||_<=0)throw ie.error("[BaseNote] 基音周波数設定エラー:",S),new Error(`Invalid base frequency: ${_}`)}async function Qt(){if(ee||!he||Re)return;if(I!=="granted"){console.log("🎤 [RandomTraining] マイク許可が必要です。許可取得を開始...");try{await Ue(),console.log("🎤 [RandomTraining] マイク許可取得完了")}catch(l){console.error("❌ マイク許可エラー:",l);return}}if(!Be&&I==="granted"){console.log("🎤 [RandomTraining] AudioManagerリソース未初期化のため取得します");try{await Ue()}catch(l){console.error("❌ AudioManagerリソース初期化エラー:",l);return}}else Be&&console.log("🎤 [RandomTraining] AudioManagerリソース既存のため再利用");e(9,ee=!0),e(0,w="listening"),Ke=Date.now(),dt();const o=Ge.find(l=>l.name===B).note;he.triggerAttackRelease(o,2,It(),.7),setTimeout(()=>{e(9,ee=!1),e(0,w="waiting"),setTimeout(()=>gt(),500)},2e3)}async function Xt(){if(ee||!he||p||!B)return;if(I!=="granted"){console.log("🎤 [RandomTraining] マイク許可が必要です。許可取得を開始...");try{await Ue(),console.log("🎤 [RandomTraining] マイク許可取得完了")}catch(l){console.error("❌ マイク許可エラー:",l);return}}if(!Be&&I==="granted"){console.log("🎤 [RandomTraining] AudioManagerリソース未初期化のため取得します");try{await Ue()}catch(l){console.error("❌ AudioManagerリソース初期化エラー:",l);return}}else Be&&console.log("🎤 [RandomTraining] AudioManagerリソース既存のため再利用");if(e(9,ee=!0),e(0,w="listening"),Ke=Date.now(),typeof window<"u"&&window.Tone){const l=window.Tone.context||window.Tone.getContext();l&&l.state==="suspended"&&(console.log("🔄 [RandomTraining] AudioContext suspended検出 - 再開中..."),await l.resume(),console.log("✅ [RandomTraining] AudioContext再開完了"))}const o=Ge.find(l=>l.name===B).note;he.triggerAttackRelease(o,2,It(),.7),setTimeout(()=>{e(9,ee=!1),e(0,w="waiting"),setTimeout(()=>gt(),500)},2e3)}async function yo(){if(ee||!he||p||!B){console.log("🔄 [BaseNoteOnly] 再生条件未満: isPlaying:",ee,"sampler:",!!he,"isLoading:",p,"currentBaseNote:",B);return}if(console.log("🎵 [BaseNoteOnly] 基音のみ再生開始:",B),typeof window<"u"&&window.Tone){const l=window.Tone.context||window.Tone.getContext();l&&l.state==="suspended"&&(console.log("🔄 [BaseNoteOnly] AudioContext suspended検出 - 再開中..."),await l.resume(),console.log("✅ [BaseNoteOnly] AudioContext再開完了"))}const o=Ge.find(l=>l.name===B).note;he.triggerAttackRelease(o,1.5,It(),.7),console.log("🎵 [BaseNoteOnly] 基音再生完了:",o)}function mt(){B&&_>0?Xt():Qt(),Yt()}function Yt(){A&&clearInterval(A),e(11,oe=0),E=!0,e(12,te=!1),console.log("🎵 [GuideStartBar] ガイドスタートバー開始"),A=setInterval(()=>{e(11,oe+=2.5),oe>=100&&(e(11,oe=100),e(12,te=!0),console.log("🎵 [GuideStartBar] ガイド開始タイミング！"),setTimeout(()=>{E=!1,e(12,te=!1),e(11,oe=0)},800),clearInterval(A),A=null)},50)}function ho(){A&&(clearInterval(A),A=null),E=!1,e(12,te=!1),e(11,oe=0)}function Ye(o,l){const k=[0,2,4,5,7,9,11,12][l],H=o*Math.pow(2,k/12);return ie.debug(`[calculateExpectedFrequency] ${C[l].name}: 基音${o.toFixed(1)}Hz + ${k}半音 = ${H.toFixed(1)}Hz`),H}function Zt(o,l){return Ye(o,l)}function gt(){e(0,w="guiding"),D=0,j=!0,K=[],console.log(`🎬 ガイド開始: ${B} (${_.toFixed(1)}Hz)`);function o(){if(D<C.length){D>0&&e(10,C[D-1].state="inactive",C),e(10,C[D].state="active",C);const l=Zt(_,D);St.setScaleContext({baseFrequency:_,currentScale:C[D].name,targetFrequency:l}),console.log(`🎵 [Scale] 基音:${B}(${_.toFixed(0)}Hz) 現在:${C[D].name} 目標:${l.toFixed(0)}Hz`),D>=4&&console.log(`🔍 [デバッグ] Step ${D}: currentBaseFrequency=${_}, currentBaseNote='${B}'`),D++,x=setTimeout(()=>{o()},600)}else $t()}o()}function $t(){j=!1,console.log(`🏁 ガイド完了: ${K.length}/${C.length}ステップ評価`),C.length>0&&e(10,C[C.length-1].state="inactive",C),ne&&ne.stopDetection(),St.clearContext(),en(),rn(),yn(),ae=L.map(o=>{const l=K.find(S=>S.stepName===o);return l?{name:l.stepName,cents:l.adjustedFrequency?Math.round(l.centDifference):null,targetFreq:l.expectedFrequency,detectedFreq:l.adjustedFrequency||null,diff:l.adjustedFrequency?l.adjustedFrequency-l.expectedFrequency:null,accuracy:l.accuracy}:{name:o,cents:null,targetFreq:null,detectedFreq:null,diff:null,accuracy:"notMeasured"}}),cn(),un(),e(0,w="results")}function en(){let o=0,l=0;K.forEach((H,G)=>{H.isCorrect&&o++,l+=H.accuracy});const S=K.length>0?Math.round(l/K.length):0,k=Math.round(o/C.length*100);Ve={correctCount:o,totalCount:C.length,averageAccuracy:S,averageTime:0,isCompleted:!0},console.log(`🎯 結果: ${o}/${C.length}正解 (${k}%) 平均精度${S}%`),K.length>0&&(ye=[...K])}function po(){switch(w){case"setup":return Re||!he?"🎵 音源読み込み中...":"🎤 マイク準備完了 - トレーニング開始可能";case"listening":return"🎵 基音再生中...";case"waiting":return"⏳ 間もなく開始...";case"guiding":return"🎙️ ガイドに合わせてドレミファソラシドを歌ってください";case"results":return"🎉 採点結果";default:return"🔄 準備中..."}}function vo(){return K.length>0?K:ye.length>0?ye:[]}function tn(){vt(`${it}/microphone-test`)}function Ze(){vt(`${it}/`)}async function nn(){try{e(34,Re=!0),e(33,he=new Uo({urls:{C4:"C4.mp3"},baseUrl:`${it}/audio/piano/`,release:1.5,volume:An(),onload:()=>{e(34,Re=!1)},onerror:H=>{console.error("❌ Salamander Piano音源読み込みエラー:",H),e(34,Re=!1)}}).toDestination());const o=/iPhone/.test(navigator.userAgent),l=/iPad/.test(navigator.userAgent),S=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document,k=o||l||S;console.log(l?"🔍 [RandomTraining] iPad検出:":S?"🔍 [RandomTraining] iPadOS検出:":o?"🔍 [RandomTraining] iPhone検出:":"🔍 [RandomTraining] その他デバイス検出:",navigator.userAgent),console.log("🔊 [RandomTraining] 音量設定維持: 35dB")}catch(o){console.error("サンプラー初期化エラー:",o),e(34,Re=!1)}}async function at(){try{(await navigator.permissions.query({name:"microphone"})).state==="granted"?await Ue():e(1,I="denied")}catch{e(1,I="denied")}}function on(){try{Ce=new Rn,ie.info("[RandomTraining] 採点エンジン初期化完了")}catch(o){ie.error("[RandomTraining] 採点エンジン初期化エラー:",o)}}function sn(o,l){if(!Ce||!j)return;const S=D-1;if(S<0||S>=C.length)return;const k=Ye(_,S),H={baseFrequency:_,targetFrequency:k,detectedFrequency:o,detectedNote:l,volume:Se,timestamp:Date.now(),scaleIndex:S,scaleName:C[S].name};try{Ce.processAttempt(H)}catch(G){ie.error("[RandomTraining] 採点エンジンエラー:",G)}}function rn(){if(!Ce){ie.error("[RandomTraining] 採点エンジンが初期化されていません"),an();return}try{const o=Ce.generateDetailedReport();e(16,ze={totalScore:o.totalScore,grade:o.grade,componentScores:o.componentScores}),o.intervalAnalysis&&o.intervalAnalysis.masteryLevels?e(3,ke=Object.entries(o.intervalAnalysis.masteryLevels).map(([l,S])=>{var k,H;return{type:l,mastery:Math.round(S),attempts:((k=o.intervalAnalysis.attemptCounts)==null?void 0:k[l])||0,accuracy:((H=o.intervalAnalysis.accuracyRates)==null?void 0:H[l])||0}})):(console.warn("⚠️ [RandomTraining] intervalAnalysis.masteryLevels が未定義です"),e(3,ke=[])),o.consistencyHistory&&Array.isArray(o.consistencyHistory)?e(17,Pe=o.consistencyHistory.map((l,S)=>({score:Math.round(l),timestamp:Date.now()-(o.consistencyHistory.length-S)*1e3}))):(console.warn("⚠️ [RandomTraining] consistencyHistory が未定義または配列ではありません"),e(17,Pe=[])),e(18,Oe=o.feedback||{primary:"採点結果を生成中です...",detailed:[],suggestions:[]}),e(20,Fe={totalAttempts:o.totalAttempts||0,successRate:o.successRate||0,averageScore:o.totalScore||0,bestScore:Math.max(o.totalScore||0,Fe.bestScore||0),sessionDuration:Math.round((Date.now()-Fe.sessionStart)/6e4)||0,streakCount:o.streak||0,fatigueLevel:o.fatigueLevel||"normal",mostDifficultInterval:o.mostDifficultInterval||"-",mostSuccessfulInterval:o.mostSuccessfulInterval||"-",averageResponseTime:o.averageResponseTime||0}),ie.info("[RandomTraining] 採点結果生成完了:",ze)}catch(o){ie.error("[RandomTraining] 採点結果生成エラー:",o)}}function an(){ie.info("[RandomTraining] テストデータで採点結果を生成"),e(16,ze={totalScore:78,grade:"B+",componentScores:{pitchAccuracy:82,recognitionSpeed:75,intervalMastery:80,directionAccuracy:85,consistency:70}}),e(3,ke=[{type:"unison",mastery:95,attempts:8,accuracy:98},{type:"major_second",mastery:82,attempts:8,accuracy:85},{type:"major_third",mastery:78,attempts:8,accuracy:80},{type:"perfect_fourth",mastery:65,attempts:8,accuracy:68},{type:"perfect_fifth",mastery:88,attempts:8,accuracy:90},{type:"major_sixth",mastery:72,attempts:8,accuracy:75},{type:"major_seventh",mastery:58,attempts:8,accuracy:62},{type:"octave",mastery:92,attempts:8,accuracy:94}]),e(17,Pe=[{score:65,timestamp:Date.now()-42e4},{score:72,timestamp:Date.now()-36e4},{score:68,timestamp:Date.now()-3e5},{score:75,timestamp:Date.now()-24e4},{score:78,timestamp:Date.now()-18e4},{score:82,timestamp:Date.now()-12e4},{score:80,timestamp:Date.now()-6e4},{score:85,timestamp:Date.now()}]),e(18,Oe={type:"improvement",primary:"良い進歩が見られます！",summary:"音程の認識精度が向上しています。特に完全5度とオクターブの習得度が高く、基本的な音感が身についてきています。",details:[{category:"strengths",text:"ユニゾンとオクターブの認識がほぼ完璧です"},{category:"strengths",text:"完全5度の安定性が優秀です"},{category:"improvements",text:"完全4度の練習をもう少し増やしましょう"},{category:"improvements",text:"長7度の認識精度を向上させましょう"},{category:"tips",text:"4度は「ソーファー」の音程です"},{category:"practice",text:"毎日15分の継続練習を心がけましょう"}],nextSteps:["完全4度の集中練習を行いましょう","連続チャレンジモードで実践練習を","1日15分の継続練習を心がけましょう"],motivation:"継続は力なり！あなたの相対音感は確実に向上しています！"}),e(20,Fe={totalAttempts:32,successRate:68.8,averageScore:78,bestScore:85,sessionDuration:8,streakCount:4,fatigueLevel:"normal",mostDifficultInterval:"完全4度",mostSuccessfulInterval:"ユニゾン",averageResponseTime:2.1,sessionStart:Date.now()-48e4}),ie.info("[RandomTraining] テスト採点結果生成完了")}function _o(o){ft=o}function cn(){if(!ae||ae.length===0){console.warn("[UnifiedScore] noteResultsForDisplay が空です");return}const o=ae.filter(se=>se.accuracy!=="notMeasured").length,l=ae.length,S=ae.filter(se=>se.accuracy!=="notMeasured"&&typeof se.accuracy=="number").map(se=>se.accuracy),k=S.length>0?Math.round(S.reduce((se,Me)=>se+Me,0)/S.length):0,H=B||"Unknown",G=_||0,ce=ae.map(se=>({name:se.name,note:se.note||se.name,frequency:se.targetFreq||se.expectedFrequency,detectedFrequency:se.detectedFreq,cents:se.cents,grade:nt.evaluateNote(se.cents),targetFreq:se.targetFreq,diff:se.diff})),le=q,re=(le==null?void 0:le.sessionHistory)||[],qe={timestamp:new Date,baseNote:H,baseFrequency:G,noteResults:ce,measuredNotes:o,accuracy:k,grade:nt.evaluateSession(ae)},xe=[...re,qe];e(21,ue={mode:"continuous",timestamp:new Date,duration:60,totalNotes:l,measuredNotes:o,averageAccuracy:k,baseNote:H,baseFrequency:G,noteResults:ce,distribution:nt.calculateDistribution(ae),sessionHistory:xe,unifiedGrade:z(xe)}),console.log("[UnifiedScore] 統合採点データ生成完了（完全版）:",ue),ln()}async function ln(){if(!ae||ae.length===0){console.warn("📊 [SessionStorage] 保存データなし");return}try{console.log("📊 [SessionStorage] セッション結果保存開始");const o=ae.map(G=>({name:G.name,cents:G.cents,targetFreq:G.targetFreq||G.expectedFrequency,detectedFreq:G.detectedFreq,diff:G.diff,accuracy:typeof G.accuracy=="number"?G.accuracy:0})),l=Ke?Math.round((Date.now()-Ke)/1e3):60;await Fn(o,l,m,d)?(console.log("📊 [SessionStorage] セッション結果保存完了"),console.log("📊 [SessionStorage] 保存後の状況:",{currentSession:n,totalSessions:v.length,isCompleted:a,nextBaseNote:m,nextBaseName:d})):console.error("📊 [SessionStorage] セッション結果保存失敗")}catch(o){console.error("📊 [SessionStorage] セッション保存エラー:",o)}}async function un(){try{if(Ce){const o=v||[];for(const[S,k]of o.entries())if(k.noteResults&&k.noteResults.length>0){const H=k.baseFrequency||262;for(const G of k.noteResults)G.detectedFreq&&G.targetFreq&&await Ce.analyzePerformance({baseFreq:H,targetFreq:G.targetFreq,detectedFreq:G.detectedFreq,responseTime:2e3,volume:50,harmonicCorrection:null})}const l=Ce.generateDetailedReport();e(16,ze={totalScore:l.totalScore||0,grade:l.grade||"C",componentScores:l.componentScores||{accuracy:0,speed:0,consistency:0}}),l.intervalAnalysis&&l.intervalAnalysis.masteryLevels?e(3,ke=Object.entries(l.intervalAnalysis.masteryLevels).map(([S,k])=>{var H;return{type:S,mastery:Math.round(k),attempts:((H=l.intervalAnalysis.attemptCounts)==null?void 0:H[S])||0,accuracy:Math.round(k*.9)}})):e(3,ke=At(ae)),l.consistencyHistory&&Array.isArray(l.consistencyHistory)?e(17,Pe=l.consistencyHistory.map((S,k)=>({score:Math.round(S),timestamp:Date.now()-(l.consistencyHistory.length-k)*1e3}))):e(17,Pe=ht(ae)),e(18,Oe=pt(ae)||l.feedback),console.log("🎯 [generateEnhancedScoringData] 技術分析結果生成を開始"),console.log("🎯 [generateEnhancedScoringData] results:",l),e(19,Xe=fn(l)),console.log("🎯 [generateEnhancedScoringData] technicalFeedbackData結果:",Xe),e(20,Fe={totalAttempts:l.totalAttempts||ae.length,successRate:l.successRate||ae.filter(S=>S.accuracy!=="notMeasured").length/ae.length*100,averageScore:l.totalScore||(ue==null?void 0:ue.averageAccuracy)||0,bestScore:Math.max(l.totalScore||0,Fe.bestScore||0),sessionDuration:Math.round(60),streakCount:l.streak||0,fatigueLevel:l.fatigueLevel||"normal",mostDifficultInterval:l.mostDifficultInterval||"未特定",mostSuccessfulInterval:l.mostSuccessfulInterval||"未特定",averageResponseTime:l.averageResponseTime||2.5,sessionStart:Date.now()-6e4})}else yt();console.log("[EnhancedScoring] 追加採点データ生成完了")}catch(o){console.error("[EnhancedScoring] データ生成エラー:",o),yt()}}function yt(){const o=ae.filter(S=>S.accuracy!=="notMeasured"),l=(ue==null?void 0:ue.averageAccuracy)||0;e(16,ze={totalScore:Math.round(l*.8),grade:l>=90?"A":l>=80?"B":l>=70?"C":"D",componentScores:{accuracy:l,speed:85,consistency:Math.max(60,l-10)}}),e(3,ke=At(ae)),e(17,Pe=ht()),e(18,Oe=pt(ae)),e(20,Fe={totalAttempts:ae.length,successRate:o.length/ae.length*100,averageScore:l,bestScore:l,sessionDuration:60,streakCount:0,fatigueLevel:"normal",mostDifficultInterval:"未分析",mostSuccessfulInterval:"未分析",averageResponseTime:2.5,sessionStart:Date.now()-6e4})}function ht(o){const l=(ue==null?void 0:ue.averageAccuracy)||70;return Array.from({length:8},(S,k)=>({score:Math.max(30,Math.min(100,l+(Math.random()-.5)*20)),timestamp:Date.now()-(8-k)*7500}))}function pt(o){const l=o.filter(et=>et.accuracy!=="notMeasured").length,S=(ue==null?void 0:ue.averageAccuracy)||0,k=8,H=v||[],G=H.length,ce={type:"info",categories:[{name:"音程精度",icon:"Target",score:S,message:`${S}%の精度で音程を捉えています`},{name:"測定成功率",icon:"Mic",score:Math.round(l/o.length*100),message:`${o.length}音中${l}音を正常に測定`}]};if(G<k)return ce;let le,re,qe;const xe=(ue==null?void 0:ue.unifiedGrade)||"E",se=H.length;let Me=0,pe=0,_e=0;H.forEach(et=>{et.grade==="excellent"?Me++:et.grade==="good"?pe++:et.grade==="pass"&&_e++});const be=se>0?Math.round(Me/se*100):0,$e=se>0?Math.round((Me+pe+_e)/se*100):0,we=se>0?Math.round((Me+pe+_e)/se*100):0;switch(xe){case"S":le="excellent",re="音楽家レベルの相対音感を達成！",qe=`優秀率${be}%超えの実力を証明されました。`;break;case"A":le="excellent",re="エキスパートレベル到達！",qe=`優秀率${be}%の安定した音感能力です。`;break;case"B":le="improvement",re="プロフィシエント級達成！",qe=`良好率${$e}%の確実な進歩を示しています。`;break;case"C":le="improvement",re="アドバンス級到達！",qe=`合格率${we}%で着実に成長中です。`;break;case"D":le="practice",re="継続練習で必ず上達！",qe=`現在の合格率${we}%から目標70%へ向けて練習を続けましょう。`;break;case"E":default:le="encouragement",re="E級ビギナー",qe="練習開始段階です。継続的な練習で必ず上達します。";break}return{...ce,type:le,primary:re,summary:qe}}function fn(o){var xe,se,Me;if((v||[]).length<8||!o)return null;const H=o.improvements||[];(xe=o.detailed)!=null&&xe.statistics;const G=[];let ce=0,le=0;if((se=o.detailed)!=null&&se.intervals){const pe=o.detailed.intervals;if(pe.totalAnalyses>0){let _e=0,be=0;for(const[$e,we]of Object.entries(pe.masteryLevels))we.attempts>0&&(_e+=we.averageAccuracy*we.attempts,be+=we.attempts);ce=be>0?_e/be:0}}if((Me=o.detailed)!=null&&Me.directions){const pe=o.detailed.directions;if(pe.totalAnalyses>0){let _e=0,be=0;for(const[$e,we]of Object.entries(pe.masteryData))we.attempts>0&&(_e+=we.averageAccuracy*we.attempts,be+=we.attempts);le=be>0?_e/be:0}}G.push({category:"improvements",text:`音程精度: ${Math.round(ce)}%　（音の高さを捉える正確性　目標基準：70〜85%）`}),G.push({category:"improvements",text:`方向性: ${Math.round(le)}%　（音程の上下判断の精度　目標基準：80〜90%）`});const re=H.map(pe=>({category:"tips",text:pe.message})),qe=H.flatMap(pe=>(pe.actions||[]).map(_e=>({category:"practice",text:_e})));return[...G,...re,...qe],{type:"info",primary:"詳細分析結果",summary:"音程精度・一貫性・方向性の総合分析",details:G}}Cn(async()=>{if(!(typeof localStorage<"u"?localStorage.getItem("mic-test-completed"):null)){console.log("🚫 [RandomTraining] マイクテスト未完了 - 準備画面表示"),at();return}console.log("📊 [SessionStorage] セッション管理初期化開始");try{if(await bt()){if(console.log("📊 [SessionStorage] セッション進行状況の読み込み完了"),console.log("📊 [SessionStorage] 現在のセッション:",n,"/ 8"),console.log("📊 [SessionStorage] 次の基音:",m,"(",d,")"),console.log("📊 [SessionStorage] 完了状況:",a?"8セッション完了":`残り${f}セッション`),a&&(console.log("🔄 [SessionStorage] 8セッション完了検出 - 新サイクル開始処理"),await tt()?console.log("✅ [SessionStorage] 新サイクル開始完了 - セッション1/8から再開"):console.warn("⚠️ [SessionStorage] 新サイクル開始処理が失敗")),n>1&&!a){console.warn("🔄 [SessionStorage] セッション途中でのリロード検出 - セッション1から再開"),console.warn("🔄 [SessionStorage] 現在:",n,"セッション目 → ダイレクトアクセス誘導");const{SessionStorageManager:S}=await wn(async()=>{const{SessionStorageManager:G}=await import("../chunks/BBixbokH.js").then(ce=>ce.y);return{SessionStorageManager:G}},__vite__mapDeps([0,1,2,3,4,5]),import.meta.url),k=S.getInstance();typeof localStorage<"u"&&(localStorage.removeItem("random-training-progress"),localStorage.removeItem("random-training-progress-backup"));const{resetProgress:H}=await wn(async()=>{const{resetProgress:G}=await import("../chunks/BBixbokH.js").then(ce=>ce.z);return{resetProgress:G}},__vite__mapDeps([0,1,2,3,4,5]),import.meta.url);await H(),console.log("🔄 [SessionStorage] localStorage + ストア状態完全リセット完了"),at();return}}else console.log("📊 [SessionStorage] 新規セッション開始")}catch(l){console.error("📊 [SessionStorage] 初期化エラー:",l)}if(nn(),on(),u.url.searchParams.get("from")==="microphone-test"){console.log("🎤 [RandomTraining] マイクテストページからの遷移を検出");const l=new URL(window.location);if(l.searchParams.delete("from"),window.history.replaceState({},"",l),e(1,I="granted"),e(0,w="setup"),console.log('🎤 [RandomTraining] microphoneState="granted", trainingPhase="setup" に設定'),!Be){console.log("🎤 [RandomTraining] AudioManagerリソース取得開始");try{const S=await We.initialize();st=S.audioContext,Be=S.mediaStream,rt=S.sourceNode,console.log("🎤 [RandomTraining] AudioManagerリソース取得完了")}catch(S){console.warn("⚠️ AudioManagerリソース取得失敗（後で再試行）:",S)}}if(await new Promise(S=>setTimeout(S,500)),ne)try{if(console.log("🎙️ [ContinuousMode] PitchDetector初期化開始"),typeof ne.getIsInitialized=="function"){const S=ne.getIsInitialized();if(console.log("🔍 [ContinuousMode] PitchDetector初期化状態:",S),S)console.log("✅ [ContinuousMode] PitchDetectorは既に初期化済み");else{const k=We.getStatus();console.log("🔍 [ContinuousMode] AudioManager状態:",k),(!k.isInitialized||!k.mediaStreamActive)&&(console.log("🔄 [ContinuousMode] AudioManager再初期化実行"),await We.initialize()),await ne.initialize(),console.log("✅ [ContinuousMode] PitchDetector初期化完了")}}else console.error("❌ [ContinuousMode] getIsInitializedメソッドが利用できません"),await ne.initialize()}catch(S){console.error("❌ [ContinuousMode] PitchDetector初期化エラー:",S),await new Promise(k=>setTimeout(k,1e3));try{await ne.initialize(),console.log("✅ [ContinuousMode] PitchDetector初期化再試行成功")}catch(k){console.error("❌ [ContinuousMode] PitchDetector初期化再試行も失敗:",k)}}else console.warn("⚠️ [ContinuousMode] PitchDetectorコンポーネントが存在しません")}else await new Promise(l=>setTimeout(l,100)),at()});function dn(o){try{if(!o||!o.detail){console.warn("⚠️ [ContinuousMode] handlePitchUpdate: event.detail が undefined");return}const{frequency:l,note:S,volume:k,rawVolume:H,clarity:G}=o.detail;let ce=l,le=S;if(w==="guiding"&&j&&_>0&&l>0){const re=mn(l);re&&(ce=re.frequency,le=re.note)}e(14,Ee=ce),e(15,je=le),e(13,Se=k),_>0&&ce>0?He=Math.round(1200*Math.log2(ce/_)):He=0;try{gn(l,S)}catch(re){console.error("❌ [ContinuousMode] evaluateScaleStep エラー:",re)}try{Ce&&l>0&&_>0&&sn(l,S)}catch(re){console.error("❌ [ContinuousMode] updateScoringEngine エラー:",re)}}catch(l){console.error("❌ [ContinuousMode] handlePitchUpdate エラー:",{error:l.message,stack:l.stack,eventDetail:o==null?void 0:o.detail,trainingPhase:w,currentSessionId:n})}}function mn(o){if(!o||o<=0||!j||!_||Se<25)return null;const S=D-1;if(S<0||S>=C.length)return null;const k=Ye(_,S);if(!k||k<=0)return null;const G=Tt(o,k).correctedFrequency,ce=En(G);return{frequency:Math.round(G),note:ce}}function gn(o,l){if(!o||o<=0||!j)return;if(!_||_<=0){console.error(`❌ [採点エラー] 基音周波数が無効: ${_}Hz`),console.error(`❌ [採点エラー] 基音名: ${B}`),console.error(`❌ [採点エラー] activeStepIndex: ${D-1}`),console.error(`❌ [採点エラー] trainingPhase: ${w}`),console.error(`❌ [採点エラー] isGuideAnimationActive: ${j}`);return}if(Se<25)return;const k=D-1;if(k<0||k>=C.length)return;k>=4&&ie.debug(`[採点デバッグ] activeStepIndex=${k} (${C[k].name}), currentBaseFrequency=${_}Hz`);const H=Ye(_,k);if(k>=0&&ie.debug(`[音程計算修正版] ${C[k].name}: 期待周波数 ${H.toFixed(1)}Hz`),!H||H<=0||!isFinite(H)){console.error("❌ [採点エラー] 期待周波数計算エラー:"),console.error(`   基音周波数: ${_}Hz`),console.error(`   音階インデックス: ${k}`),console.error(`   期待周波数: ${H}Hz`);return}const G=Tt(o,H),ce=G.correctedFrequency,le=G.factor,re=Math.round(1200*Math.log2(ce/H));if((Math.abs(re)>200||le!==1)&&(ie.debug(`[プロトタイプ式補正] ${C[k].name}:`),console.warn(`   検出周波数: ${o.toFixed(1)}Hz`),console.warn(`   補正後周波数: ${ce.toFixed(1)}Hz`),console.warn(`   期待周波数: ${H.toFixed(1)}Hz`),console.warn(`   セント差: ${re}¢`),console.warn(`   補正係数: ${le} (${G.description})`),console.warn(`   基音: ${B} (${_.toFixed(1)}Hz)`)),!isFinite(re)){console.error("❌ [採点エラー] セント計算エラー:"),console.error(`   検出周波数: ${o}Hz`),console.error(`   期待周波数: ${H}Hz`),console.error(`   セント差: ${re}`);return}const xe=Math.abs(re)<=50;if(Se>=15){const pe=Math.max(0,Math.round(100-Math.abs(re))),_e=K.findIndex($e=>$e.stepIndex===k),be={stepIndex:k,stepName:C[k].name,expectedFrequency:Math.round(H),detectedFrequency:Math.round(o),adjustedFrequency:Math.round(ce),centDifference:re,accuracy:pe,isCorrect:xe,correctionFactor:le,correctionDescription:G.description,timestamp:Date.now()};_e>=0?K[_e]=be:K.push(be),K.length%4===0&&ie.realtime(`採点進捗: ${K.length}/${C.length}ステップ完了`)}}function yn(){e(0,w="results"),Ve.isCompleted=!0,Ve.averageAccuracy=Math.round(Ve.correctCount/Ve.totalCount*100),ne&&ne.stopDetection(),bn()}async function hn(){if(a){console.warn("🚫 [RestartSame] 8セッション完了状態では再挑戦不可 - 新サイクル開始が必要"),await tt()?(console.log("✅ [RestartSame] 新サイクル開始完了 - セッション1/8から再開"),window.location.reload()):console.error("❌ [RestartSame] 新サイクル開始失敗");return}ot(),e(0,w="setup"),x&&(clearTimeout(x),x=null),ne&&ne.resetDisplayState&&ne.resetDisplayState(),ct(),console.log("🔄 [RestartSame] 同じ基音で再挑戦:",B,_+"Hz"),console.log("🔄 [RestartSame] 基音情報保持完了 - ユーザー操作待機")}async function pn(){if(a){console.warn("🚫 [RestartDifferent] 8セッション完了状態では再挑戦不可 - 新サイクル開始が必要"),await tt()?(console.log("✅ [RestartDifferent] 新サイクル開始完了 - セッション1/8から再開"),window.location.reload()):console.error("❌ [RestartDifferent] 新サイクル開始失敗");return}ot(),e(0,w="setup"),x&&(clearTimeout(x),x=null),e(7,B=""),e(8,_=0),console.log("🔄 [restartDifferentBaseNote] 基音情報をリセットしました"),ne&&ne.resetDisplayState&&ne.resetDisplayState(),ct()}function ct(){D=0,j=!1,K=[],e(10,C=C.map(o=>({...o,state:"inactive",completed:!1})))}async function vn(){console.log("🚀 [StartNewCycle] 8セッション完了後の最初から挑戦開始");try{await tt()?(console.log("✅ [StartNewCycle] 新サイクル開始完了"),localStorage.getItem("mic-test-completed")?(console.log("✅ [StartNewCycle] マイクテスト完了フラグ確認 - リロードなしで状態リセット"),ot(),await bt(),e(0,w="setup"),ct(),dt(),console.log("✅ [StartNewCycle] 状態リセット完了 - セッション1/8から再開")):window.location.reload()):(console.error("❌ [StartNewCycle] 新サイクル開始失敗"),Ze())}catch(o){console.error("❌ [StartNewCycle] 新サイクル開始エラー:",o),Ze()}}function _n(o){const{type:l}=o.detail;switch(l){case"same":hn();break;case"different":pn();break;case"restart":vn();break;case"home":Ze();break;default:console.warn("🚫 [ActionButtons] 未知のアクションタイプ:",l)}}function Sn(){console.log("⚡ [ContinuousMode] 8セッション連続開始"),mt()}function bn(){console.log("✅ [ContinuousMode] セッション完了:",n),n<8?setTimeout(()=>{if(console.log("🔄 [ContinuousMode] 次セッション自動開始準備:",n+1),e(0,w="setup"),Ve={isCompleted:!1,correctCount:0,totalCount:0,averageAccuracy:0},e(9,ee=!1),ne)try{if(ne.getState){const o=ne.getState();console.log("🔍 [ContinuousMode] PitchDetector状態:",o),o.isInitialized&&o.componentState==="ready"?(console.log("🎤 [ContinuousMode] 音程検出再開"),ne.startDetection()):o.componentState==="detecting"?console.log("🔄 [ContinuousMode] 音程検出は既にアクティブ状態 - スキップ"):console.log("⚠️ [ContinuousMode] PitchDetector状態不正 - 音程検出再開をスキップ:",o.componentState)}else console.log("⚠️ [ContinuousMode] getState()メソッド未対応 - フォールバック処理"),ne.getIsInitialized&&ne.getIsInitialized()&&ne.startDetection()}catch(o){console.warn("⚠️ [ContinuousMode] 音程検出再開失敗:",o.message)}console.log("🎵 [ContinuousMode] 次の基音自動再生開始"),mt()},5e3):(console.log("🎉 [ContinuousMode] 8セッション完了！"),setTimeout(()=>{console.log("🏆 [ContinuousMode] 総合評価画面表示完了")},1e3))}function Dn(o){var G;const{error:l,context:S,reason:k,recovery:H}=o.detail;if(S==="initialization"||l!=null&&l.message&&l.message.includes("getIsInitialized")){console.error("❌ [ContinuousMode] PitchDetector初期化エラー詳細:",{error:(l==null?void 0:l.message)||l,stack:l==null?void 0:l.stack,context:S,componentExists:!!ne,hasGetIsInitialized:typeof(ne==null?void 0:ne.getIsInitialized)=="function",trainingPhase:w,currentSessionId:n});return}if(console.error("❌ [ContinuousMode] PitchDetectorエラー詳細:",{error:(l==null?void 0:l.message)||l,stack:l==null?void 0:l.stack,context:S,reason:k,recovery:H,trainingPhase:w,currentSessionId:n}),k==="mediastream_ended"&&H==="restart_required"&&(console.log("⚡ [ContinuousMode] MediaStream終了検出 - 自動復旧を試行"),setTimeout(async()=>{try{await Ue()}catch(ce){console.error("❌ [ContinuousMode] 自動復旧失敗:",ce)}},1e3)),S==="start-detection"&&((G=l==null?void 0:l.message)!=null&&G.includes("component state is detecting"))){console.log("🔄 [ContinuousMode] 音程検出は既にアクティブ状態です（正常）");return}}function qn(o){const{healthy:l,errors:S,details:k}=o.detail;e(2,X=l),e(6,P=S),l||(console.warn("⚠️ マイクの健康状態が悪化:",S),w==="guiding"&&(e(0,w="setup"),console.warn("🛑 マイク問題によりトレーニングを停止")))}kn(()=>{console.log("🔄 [RandomTraining] onDestroy - AudioManagerリソースは保持"),he&&(he.dispose(),e(33,he=null))});const So=[];Ko.keys(t).forEach(o=>{!~So.indexOf(o)&&o.slice(0,2)!=="$$"&&o!=="slot"&&Qo.warn(`<Page> was created with unknown prop '${o}'`)});function bo(o){Fo[o?"unshift":"push"](()=>{ne=o,e(22,ne)})}return r.$capture_state=()=>({onMount:Cn,onDestroy:kn,goto:vt,base:it,page:_t,ChevronRight:Go,Music:Ln,Card:Je,Button:ut,VolumeBar:Mo,PitchDisplay:Oo,PitchDetector:zn,PitchDetectionDisplay:Vn,PageLayout:Hn,Tone:jo,audioManager:We,harmonicCorrection:St,logger:ie,ScoreResultPanel:Lo,IntervalProgressTracker:zo,ConsistencyGraph:Vo,FeedbackDisplay:Ho,SessionStatistics:xo,UnifiedScoreResultFixed:Kt,ActionButtons:Jt,EvaluationEngine:nt,EnhancedScoringEngine:Rn,trainingProgress:Nt,currentSessionId:Mt,nextBaseNote:Rt,nextBaseName:Ft,isLoading:kt,storageError:Bo,isCompleted:Ct,sessionHistory:wt,overallGrade:Po,overallAccuracy:Eo,progressPercentage:To,remainingSessions:qt,latestSessionResult:Ao,unifiedScoreData:Dt,loadProgress:bt,saveSessionResult:Fn,resetProgress:Io,createNewProgress:No,startNewCycleIfCompleted:tt,getVolumeForDevice:An,calculateUnifiedGrade:z,generateTestUnifiedScoreData:Xo,trainingPhase:w,microphoneState:I,microphoneHealthy:X,microphoneErrors:P,buildVersion:uo,buildTimestamp:fo,updateStatus:mo,SCALE_NAMES:L,currentBaseNote:B,currentBaseFrequency:_,isPlaying:ee,currentScaleIndex:D,scaleSteps:C,guideAnimationTimer:x,isGuideAnimationActive:j,guideStartProgress:oe,isGuideStartBarActive:E,guideStartTimer:A,musicIconGlowing:te,scaleEvaluations:K,previousEvaluations:ye,currentVolume:Se,currentFrequency:Ee,detectedNote:je,pitchDifference:He,sessionResults:Ve,scoringEngine:Ce,currentScoreData:ze,intervalData:ke,consistencyData:Pe,feedbackData:Oe,technicalFeedbackData:Xe,sessionStatistics:Fe,activeTab:ft,noteResultsForDisplay:ae,currentUnifiedScoreData:ue,sampler:he,isSamplerLoading:Re,pitchDetectorComponent:ne,mediaStream:Be,audioContext:st,sourceNode:rt,sessionStartTime:Ke,baseNotes:Ge,checkMicrophonePermission:Ue,selectRandomBaseNote:dt,playRandomBaseNote:Qt,playCurrentBaseNote:Xt,playBaseNoteOnly:yo,playBaseNote:mt,startGuideStartBar:Yt,cleanupGuideStartBar:ho,calculateExpectedFrequency:Ye,calculateTargetFrequency:Zt,startGuideAnimation:gt,finishGuideAnimation:$t,calculateFinalResults:en,getStatusMessage:po,getDisplayEvaluations:vo,goToMicrophoneTest:tn,goHome:Ze,initializeSampler:nn,checkExistingMicrophonePermission:at,initializeScoringEngine:on,updateScoringEngine:sn,generateFinalScoring:rn,generateTestScoreData:an,switchTab:_o,generateUnifiedScoreData:cn,saveSessionToStorage:ln,generateEnhancedScoringData:un,generateFallbackEnhancedData:yt,generateIntervalDataFromResults:At,generateIntervalDataFromSessionHistory:Tn,generateConsistencyDataFromResults:ht,generateFeedbackFromResults:pt,generateTechnicalFeedbackFromEnhancedEngine:fn,handlePitchUpdate:dn,getEvaluationCorrectedFrequency:mn,frequencyToNote:En,multiStageOctaveCorrection:Tt,evaluateScaleStep:gn,completeSession:yn,restartSameBaseNote:hn,restartDifferentBaseNote:pn,scrollToTop:ot,resetSessionState:ct,startNewCycle:vn,handleActionButtonClick:_n,startContinuousMode:Sn,handleSessionComplete:bn,handlePitchDetectorStateChange:go,handlePitchDetectorError:Dn,handleMicrophoneHealthChange:qn,canRestartSession:s,canStartTraining:i,$currentSessionId:n,$unifiedScoreData:c,$isCompleted:a,$page:u,$remainingSessions:f,$nextBaseName:d,$nextBaseNote:m,$sessionHistory:v,$trainingProgress:q,$isLoading:p}),r.$inject_state=o=>{"trainingPhase"in o&&e(0,w=o.trainingPhase),"microphoneState"in o&&e(1,I=o.microphoneState),"microphoneHealthy"in o&&e(2,X=o.microphoneHealthy),"microphoneErrors"in o&&e(6,P=o.microphoneErrors),"currentBaseNote"in o&&e(7,B=o.currentBaseNote),"currentBaseFrequency"in o&&e(8,_=o.currentBaseFrequency),"isPlaying"in o&&e(9,ee=o.isPlaying),"currentScaleIndex"in o&&(D=o.currentScaleIndex),"scaleSteps"in o&&e(10,C=o.scaleSteps),"guideAnimationTimer"in o&&(x=o.guideAnimationTimer),"isGuideAnimationActive"in o&&(j=o.isGuideAnimationActive),"guideStartProgress"in o&&e(11,oe=o.guideStartProgress),"isGuideStartBarActive"in o&&(E=o.isGuideStartBarActive),"guideStartTimer"in o&&(A=o.guideStartTimer),"musicIconGlowing"in o&&e(12,te=o.musicIconGlowing),"scaleEvaluations"in o&&(K=o.scaleEvaluations),"previousEvaluations"in o&&(ye=o.previousEvaluations),"currentVolume"in o&&e(13,Se=o.currentVolume),"currentFrequency"in o&&e(14,Ee=o.currentFrequency),"detectedNote"in o&&e(15,je=o.detectedNote),"pitchDifference"in o&&(He=o.pitchDifference),"sessionResults"in o&&(Ve=o.sessionResults),"scoringEngine"in o&&(Ce=o.scoringEngine),"currentScoreData"in o&&e(16,ze=o.currentScoreData),"intervalData"in o&&e(3,ke=o.intervalData),"consistencyData"in o&&e(17,Pe=o.consistencyData),"feedbackData"in o&&e(18,Oe=o.feedbackData),"technicalFeedbackData"in o&&e(19,Xe=o.technicalFeedbackData),"sessionStatistics"in o&&e(20,Fe=o.sessionStatistics),"activeTab"in o&&(ft=o.activeTab),"noteResultsForDisplay"in o&&(ae=o.noteResultsForDisplay),"currentUnifiedScoreData"in o&&e(21,ue=o.currentUnifiedScoreData),"sampler"in o&&e(33,he=o.sampler),"isSamplerLoading"in o&&e(34,Re=o.isSamplerLoading),"pitchDetectorComponent"in o&&e(22,ne=o.pitchDetectorComponent),"mediaStream"in o&&(Be=o.mediaStream),"audioContext"in o&&(st=o.audioContext),"sourceNode"in o&&(rt=o.sourceNode),"sessionStartTime"in o&&(Ke=o.sessionStartTime),"canRestartSession"in o&&(s=o.canRestartSession),"canStartTraining"in o&&(i=o.canStartTraining)},t&&"$$inject"in t&&r.$inject_state(t.$$inject),r.$$.update=()=>{r.$$.dirty[0]&6|r.$$.dirty[1]&12&&(i=I==="granted"&&!Re&&he&&X),r.$$.dirty[0]&1&&(s=w==="results"),r.$$.dirty[0]&56&&c&&a&&c.sessionHistory&&(e(3,ke=Tn(c.sessionHistory)),console.log("🎵 [RandomTraining] intervalData生成完了:",ke.length,"件")),r.$$.dirty[0]&3&&w==="setup"&&I==="granted"&&ot()},[w,I,X,ke,c,a,P,B,_,ee,C,oe,te,Se,Ee,je,ze,Pe,Oe,Xe,Fe,ue,ne,n,v,p,tn,Ze,dn,_n,Sn,Dn,qn,he,Re,bo]}class is extends Do{constructor(t){super(t),qo(this,t,Yo,Wt,wo,{},null,[-1,-1,-1,-1]),$("SvelteRegisterComponent",{component:this,tagName:"Page",options:t,id:Wt.name})}}export{is as component,cs as universal};
