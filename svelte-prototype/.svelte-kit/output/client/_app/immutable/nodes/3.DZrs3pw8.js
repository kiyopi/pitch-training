import{S as Re,i as ze,s as Fe,d as f,C as me,m as _e,o as ge,b as M,D as be,I as Ge,h as y,E as ke,k as P,F as Te,l as Ke,M as qe,c as a,y as d,K as Qe,e as _,f as E,G as V,j as g,R as Le,Q as Ze,L as He,a as ae,T as ve,A as q,g as H,t as R,r as Oe,n as Ee}from"../chunks/BJp-dNlk.js";import"../chunks/IHki7fMi.js";import{p as Je}from"../chunks/lh8Ns3Eu.js";import{g as We,b as Xe}from"../chunks/FFgCOraB.js";import{P as Ye,C as et}from"../chunks/DZHPMXgl.js";import{P as tt,a as st,b as De}from"../chunks/CieYLojM.js";const nt=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global,{document:je}=nt;function lt(n){let e,t="マイクのテストを開始します",u,s,r="マイクテスト開始ボタンを押してマイクの使用を許可してください",l,h;function k(o,b){if(o[0]==="pending")return at;if(o[0]==="denied")return rt;if(o[0]==="initial")return it}let T=k(n),i=T&&T(n);return{c(){e=g("h3"),e.textContent=t,u=P(),s=g("p"),s.textContent=r,l=P(),i&&i.c(),h=Oe(),this.h()},l(o){e=_(o,"H3",{class:!0,"data-svelte-h":!0}),V(e)!=="svelte-gfi16f"&&(e.textContent=t),u=y(o),s=_(o,"P",{class:!0,"data-svelte-h":!0}),V(s)!=="svelte-1w19y1h"&&(s.textContent=r),l=y(o),i&&i.l(o),h=Oe(),this.h()},h(){d(e,"class","instructions-title svelte-uhkflr"),d(s,"class","instructions-description svelte-uhkflr")},m(o,b){M(o,e,b),M(o,u,b),M(o,s,b),M(o,l,b),i&&i.m(o,b),M(o,h,b)},p(o,b){T===(T=k(o))&&i?i.p(o,b):(i&&i.d(1),i=T&&T(o),i&&(i.c(),i.m(h.parentNode,h)))},d(o){o&&(f(e),f(u),f(s),f(l),f(h)),i&&i.d(o)}}}function ot(n){let e,t="マイク準備完了",u,s,r="音量を調整してからトレーニングを開始してください",l,h,k,T,i,o=n[8].includes("iPad")||n[8].includes("その他"),b,D,c,p,N,x,z,le,U,j,X="-20dB",oe,I,G,$,ce="+10dB",ie,L,K=n[7]?"再生中...":"ド(C4)を再生",Y,m,w,A,Q,ee=n[6].toFixed(1)+"",re,Ce,we,O,Z,Ie="0.1x",Me,S,ye,J,Ae="10.0x",ue,W,F,Be="トレーニング開始",Pe,Ve,B=o&&$e(n);return{c(){e=g("h3"),e.textContent=t,u=P(),s=g("p"),s.textContent=r,l=P(),h=g("div"),k=g("span"),T=R(n[8]),i=P(),B&&B.c(),b=P(),D=g("div"),c=g("div"),p=g("label"),N=R("基音音量: "),x=R(n[5]),z=R("dB"),le=P(),U=g("div"),j=g("span"),j.textContent=X,oe=P(),I=g("input"),G=P(),$=g("span"),$.textContent=ce,ie=P(),L=g("button"),Y=R(K),m=P(),w=g("div"),A=g("label"),Q=R("マイク感度: "),re=R(ee),Ce=R("x"),we=P(),O=g("div"),Z=g("span"),Z.textContent=Ie,Me=P(),S=g("input"),ye=P(),J=g("span"),J.textContent=Ae,ue=P(),W=g("div"),F=g("button"),F.textContent=Be,this.h()},l(v){e=_(v,"H3",{class:!0,"data-svelte-h":!0}),V(e)!=="svelte-11dam81"&&(e.textContent=t),u=y(v),s=_(v,"P",{class:!0,"data-svelte-h":!0}),V(s)!=="svelte-1pr7rqg"&&(s.textContent=r),l=y(v),h=_(v,"DIV",{class:!0});var C=E(h);k=_(C,"SPAN",{class:!0});var Ne=E(k);T=H(Ne,n[8]),Ne.forEach(f),C.forEach(f),i=y(v),B&&B.l(v),b=y(v),D=_(v,"DIV",{class:!0});var de=E(D);c=_(de,"DIV",{class:!0});var te=E(c);p=_(te,"LABEL",{class:!0});var fe=E(p);N=H(fe,"基音音量: "),x=H(fe,n[5]),z=H(fe,"dB"),fe.forEach(f),le=y(te),U=_(te,"DIV",{class:!0});var se=E(U);j=_(se,"SPAN",{class:!0,"data-svelte-h":!0}),V(j)!=="svelte-5u5ai6"&&(j.textContent=X),oe=y(se),I=_(se,"INPUT",{type:!0,min:!0,max:!0,step:!0,class:!0}),G=y(se),$=_(se,"SPAN",{class:!0,"data-svelte-h":!0}),V($)!=="svelte-ptz1f5"&&($.textContent=ce),se.forEach(f),ie=y(te),L=_(te,"BUTTON",{class:!0});var Se=E(L);Y=H(Se,K),Se.forEach(f),te.forEach(f),m=y(de),w=_(de,"DIV",{class:!0});var he=E(w);A=_(he,"LABEL",{class:!0});var pe=E(A);Q=H(pe,"マイク感度: "),re=H(pe,ee),Ce=H(pe,"x"),pe.forEach(f),we=y(he),O=_(he,"DIV",{class:!0});var ne=E(O);Z=_(ne,"SPAN",{class:!0,"data-svelte-h":!0}),V(Z)!=="svelte-1m4xt2o"&&(Z.textContent=Ie),Me=y(ne),S=_(ne,"INPUT",{type:!0,min:!0,max:!0,step:!0,class:!0}),ye=y(ne),J=_(ne,"SPAN",{class:!0,"data-svelte-h":!0}),V(J)!=="svelte-1jlarki"&&(J.textContent=Ae),ne.forEach(f),he.forEach(f),de.forEach(f),ue=y(v),W=_(v,"DIV",{class:!0});var Ue=E(W);F=_(Ue,"BUTTON",{class:!0,"data-svelte-h":!0}),V(F)!=="svelte-kae9rs"&&(F.textContent=Be),Ue.forEach(f),this.h()},h(){d(e,"class","ready-title svelte-uhkflr"),d(s,"class","ready-description svelte-uhkflr"),d(k,"class","device-label svelte-uhkflr"),d(h,"class","device-info svelte-uhkflr"),d(p,"class","volume-label svelte-uhkflr"),d(j,"class","slider-min svelte-uhkflr"),d(I,"type","range"),d(I,"min","-20"),d(I,"max","10"),d(I,"step","1"),d(I,"class","volume-slider svelte-uhkflr"),d($,"class","slider-max svelte-uhkflr"),d(U,"class","volume-slider-container svelte-uhkflr"),d(L,"class","base-tone-test-button svelte-uhkflr"),L.disabled=n[7],d(c,"class","volume-control-section svelte-uhkflr"),d(A,"class","volume-label svelte-uhkflr"),d(Z,"class","slider-min svelte-uhkflr"),d(S,"type","range"),d(S,"min","0.1"),d(S,"max","10.0"),d(S,"step","0.1"),d(S,"class","volume-slider svelte-uhkflr"),d(J,"class","slider-max svelte-uhkflr"),d(O,"class","volume-slider-container svelte-uhkflr"),d(w,"class","volume-control-section svelte-uhkflr"),d(D,"class","volume-controls svelte-uhkflr"),d(F,"class","training-start-button enabled svelte-uhkflr"),d(W,"class","training-start-button-area svelte-uhkflr")},m(v,C){M(v,e,C),M(v,u,C),M(v,s,C),M(v,l,C),M(v,h,C),a(h,k),a(k,T),M(v,i,C),B&&B.m(v,C),M(v,b,C),M(v,D,C),a(D,c),a(c,p),a(p,N),a(p,x),a(p,z),a(c,le),a(c,U),a(U,j),a(U,oe),a(U,I),ve(I,n[5]),a(U,G),a(U,$),a(c,ie),a(c,L),a(L,Y),a(D,m),a(D,w),a(w,A),a(A,Q),a(A,re),a(A,Ce),a(w,we),a(w,O),a(O,Z),a(O,Me),a(O,S),ve(S,n[6]),a(O,ye),a(O,J),M(v,ue,C),M(v,W,C),a(W,F),Pe||(Ve=[q(I,"change",n[19]),q(I,"input",n[19]),q(I,"input",n[13]),q(L,"click",n[14]),q(S,"change",n[20]),q(S,"input",n[20]),q(S,"input",n[15]),q(F,"click",n[10])],Pe=!0)},p(v,C){C&256&&ae(T,v[8]),C&256&&(o=v[8].includes("iPad")||v[8].includes("その他")),o?B?B.p(v,C):(B=$e(v),B.c(),B.m(b.parentNode,b)):B&&(B.d(1),B=null),C&32&&ae(x,v[5]),C&32&&ve(I,v[5]),C&128&&K!==(K=v[7]?"再生中...":"ド(C4)を再生")&&ae(Y,K),C&128&&(L.disabled=v[7]),C&64&&ee!==(ee=v[6].toFixed(1)+"")&&ae(re,ee),C&64&&ve(S,v[6])},d(v){v&&(f(e),f(u),f(s),f(l),f(h),f(i),f(b),f(D),f(ue),f(W)),B&&B.d(v),Pe=!1,He(Ve)}}}function it(n){let e,t,u="マイクテストを開始",s,r;return{c(){e=g("div"),t=g("button"),t.textContent=u,this.h()},l(l){e=_(l,"DIV",{class:!0});var h=E(e);t=_(h,"BUTTON",{class:!0,"data-svelte-h":!0}),V(t)!=="svelte-caex95"&&(t.textContent=u),h.forEach(f),this.h()},h(){d(t,"class","mic-test-button start svelte-uhkflr"),d(e,"class","mic-test-button-area svelte-uhkflr")},m(l,h){M(l,e,h),a(e,t),s||(r=q(t,"click",n[9]),s=!0)},p:Ee,d(l){l&&f(e),s=!1,r()}}}function rt(n){let e,t,u="マイク許可を再試行",s,r;return{c(){e=g("div"),t=g("button"),t.textContent=u,this.h()},l(l){e=_(l,"DIV",{class:!0});var h=E(e);t=_(h,"BUTTON",{class:!0,"data-svelte-h":!0}),V(t)!=="svelte-1p3n8nt"&&(t.textContent=u),h.forEach(f),this.h()},h(){d(t,"class","mic-test-button retry svelte-uhkflr"),d(e,"class","mic-test-button-area svelte-uhkflr")},m(l,h){M(l,e,h),a(e,t),s||(r=q(t,"click",n[9]),s=!0)},p:Ee,d(l){l&&f(e),s=!1,r()}}}function at(n){let e,t="マイク準備中...";return{c(){e=g("p"),e.textContent=t,this.h()},l(u){e=_(u,"P",{class:!0,"data-svelte-h":!0}),V(e)!=="svelte-1vb5g92"&&(e.textContent=t),this.h()},h(){d(e,"class","status-text svelte-uhkflr")},m(u,s){M(u,e,s)},p:Ee,d(u){u&&f(e)}}}function $e(n){let e,t,u=n[8].includes("iPad")?"iPad専用設定":"高感度設定（テスト用）",s,r,l,h,k="高感度設定",T,i,o="超高感度設定",b,D;return{c(){e=g("div"),t=g("h4"),s=R(u),r=P(),l=g("div"),h=g("button"),h.textContent=k,T=P(),i=g("button"),i.textContent=o,this.h()},l(c){e=_(c,"DIV",{class:!0});var p=E(e);t=_(p,"H4",{class:!0});var N=E(t);s=H(N,u),N.forEach(f),r=y(p),l=_(p,"DIV",{class:!0});var x=E(l);h=_(x,"BUTTON",{class:!0,"data-svelte-h":!0}),V(h)!=="svelte-1skmm1s"&&(h.textContent=k),T=y(x),i=_(x,"BUTTON",{class:!0,"data-svelte-h":!0}),V(i)!=="svelte-1lgelbb"&&(i.textContent=o),x.forEach(f),p.forEach(f),this.h()},h(){d(t,"class","preset-title svelte-uhkflr"),d(h,"class","preset-button svelte-uhkflr"),d(i,"class","preset-button svelte-uhkflr"),d(l,"class","preset-buttons svelte-uhkflr"),d(e,"class","preset-section svelte-uhkflr")},m(c,p){M(c,e,p),a(e,t),a(t,s),a(e,r),a(e,l),a(l,h),a(l,T),a(l,i),b||(D=[q(h,"click",n[17]),q(i,"click",n[18])],b=!0)},p(c,p){p&256&&u!==(u=c[8].includes("iPad")?"iPad専用設定":"高感度設定（テスト用）")&&ae(s,u)},d(c){c&&f(e),b=!1,He(D)}}}function ct(n){let e;function t(r,l){return r[0]==="granted"?ot:lt}let u=t(n),s=u(n);return{c(){e=g("div"),s.c(),this.h()},l(r){e=_(r,"DIV",{class:!0});var l=E(e);s.l(l),l.forEach(f),this.h()},h(){d(e,"class","training-mode-content svelte-uhkflr")},m(r,l){M(r,e,l),s.m(e,null)},p(r,l){u===(u=t(r))&&s?s.p(r,l):(s.d(1),s=u(r),s&&(s.c(),s.m(e,null)))},d(r){r&&f(e),s.d()}}}function ut(n){let e,t,u='<div class="mic-test-header svelte-uhkflr"><div class="mic-icon svelte-uhkflr"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" x2="12" y1="19" y2="22"></line><line x1="8" x2="16" y1="22" y2="22"></line></svg></div> <div><h1 class="mic-test-title svelte-uhkflr">マイクテスト</h1> <p class="mic-test-description svelte-uhkflr">音感トレーニングを始める前に、マイクの動作を確認します</p></div></div>',s,r,l,h,k,T,i,o,b;l=new et({props:{variant:"default",padding:"lg",$$slots:{default:[ct]},$$scope:{ctx:n}}}),k=new tt({props:{frequency:n[2],note:n[3],volume:n[1],isMuted:n[0]!=="granted",muteMessage:"マイク許可後に開始"}});let D={isActive:n[0]==="granted",className:"pitch-detector-content",debugMode:!1};return o=new st({props:D}),n[21](o),o.$on("pitchUpdate",n[11]),o.$on("stateChange",ft),o.$on("error",n[12]),{c(){e=g("div"),t=g("div"),t.innerHTML=u,s=P(),r=g("div"),Te(l.$$.fragment),h=P(),Te(k.$$.fragment),T=P(),i=g("div"),Te(o.$$.fragment),this.h()},l(c){e=_(c,"DIV",{class:!0});var p=E(e);t=_(p,"DIV",{class:!0,"data-svelte-h":!0}),V(t)!=="svelte-4qcd63"&&(t.innerHTML=u),s=y(p),r=_(p,"DIV",{class:!0});var N=E(r);ke(l.$$.fragment,N),N.forEach(f),h=y(p),ke(k.$$.fragment,p),T=y(p),i=_(p,"DIV",{style:!0});var x=E(i);ke(o.$$.fragment,x),x.forEach(f),p.forEach(f),this.h()},h(){d(t,"class","header svelte-uhkflr"),d(r,"class","training-mode-info svelte-uhkflr"),Qe(i,"display","none"),d(e,"class","microphone-test svelte-uhkflr")},m(c,p){M(c,e,p),a(e,t),a(e,s),a(e,r),be(l,r,null),a(e,h),be(k,e,null),a(e,T),a(e,i),be(o,i,null),b=!0},p(c,p){const N={};p&536871393&&(N.$$scope={dirty:p,ctx:c}),l.$set(N);const x={};p&4&&(x.frequency=c[2]),p&8&&(x.note=c[3]),p&2&&(x.volume=c[1]),p&1&&(x.isMuted=c[0]!=="granted"),k.$set(x);const z={};p&1&&(z.isActive=c[0]==="granted"),o.$set(z)},i(c){b||(ge(l.$$.fragment,c),ge(k.$$.fragment,c),ge(o.$$.fragment,c),b=!0)},o(c){_e(l.$$.fragment,c),_e(k.$$.fragment,c),_e(o.$$.fragment,c),b=!1},d(c){c&&f(e),me(l),me(k),n[21](null),me(o)}}}function dt(n){let e,t,u;return t=new Ye({props:{showBackButton:!0,$$slots:{default:[ut]},$$scope:{ctx:n}}}),{c(){e=P(),Te(t.$$.fragment),this.h()},l(s){Ge("svelte-8st1fo",je.head).forEach(f),e=y(s),ke(t.$$.fragment,s),this.h()},h(){je.title="マイクテスト - 相対音感トレーニング"},m(s,r){M(s,e,r),be(t,s,r),u=!0},p(s,[r]){const l={};r&536871423&&(l.$$scope={dirty:r,ctx:s}),t.$set(l)},i(s){u||(ge(t.$$.fragment,s),u=!0)},o(s){_e(t.$$.fragment,s),u=!1},d(s){s&&f(e),me(t,s)}}}function ft(n){}async function xe(){if(typeof window<"u"&&window.Tone){const n=window.Tone.context||window.Tone.getContext();if(n&&n.state==="suspended")return console.log("🔄 [MicTest] AudioContext suspended検出 - 再開中..."),await n.resume(),console.log("✅ [MicTest] AudioContext再開完了"),!0}return!1}function ht(n,e,t){let u;Ke(n,Je,m=>t(24,u=m));let s="random";qe(()=>{u.url.searchParams.has("mode")&&(s=u.url.searchParams.get("mode")||"random")});let r="initial",l=0,h=0,k="ーー",T=null,i=0,o=1,b=null,D=!1,c="";qe(()=>{const m=/iPhone/.test(navigator.userAgent),w=/iPad/.test(navigator.userAgent),A=/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document;w||A?(t(8,c="iPad検出"),t(5,i=-6)):m?(t(8,c="iPhone検出"),t(5,i=-6)):(t(8,c="その他デバイス"),t(5,i=-6)),console.log(`🔍 [MicTest] デバイス情報: ${c}`,navigator.userAgent),console.log(`🔍 [MicTest] タッチサポート: ${"ontouchend"in document}`)});const p={random:{name:"ランダム基音モード",description:"10種類の基音からランダムに選択してトレーニング",color:"green",path:"/training/random"},continuous:{name:"連続チャレンジモード",description:"選択した回数だけ連続で実行し、総合評価を確認",color:"orange",path:"/training/continuous"},chromatic:{name:"12音階モード",description:"クロマチックスケールの上行・下行で完全制覇",color:"purple",path:"/training/chromatic"}},N=p[s]||p.random;async function x(){var m;t(0,r="pending");try{if(console.log("🎤 [MicTest] マイク許可リクエスト開始"),!((m=navigator.mediaDevices)!=null&&m.getUserMedia)){t(0,r="denied"),console.error("❌ [MicTest] getUserMediaがサポートされていません");return}const w=await De.initialize();if(console.log("✅ [MicTest] AudioManager リソース取得完了"),w.mediaStream&&w.audioContext)t(0,r="granted"),console.log("✅ [MicTest] マイク許可完了"),await xe(),await $(),setTimeout(async()=>{T&&(console.log("🎙️ [MicTest] PitchDetector初期化開始"),await xe(),await T.initialize(),console.log("✅ [MicTest] PitchDetector初期化完了"),console.log("🎯 [MicTest] PitchDetector isActiveリアクティブで自動検出開始"))},1e3);else throw new Error("リソース取得失敗")}catch(w){console.error("❌ [MicTest] マイク許可エラー:",w),t(0,r=((w==null?void 0:w.name)==="NotAllowedError","denied"))}}function z(){console.log("🚀 [MicTest] トレーニング開始 - ランダム基音モードへ遷移"),localStorage.setItem("mic-test-completed","true"),console.log("✅ [MicTest] マイクテスト完了フラグを保存"),We(`${Xe}${N.path}?from=microphone-test`)}function le(m){const{frequency:w,note:A,volume:Q,rawVolume:ee,clarity:re}=m.detail;t(2,h=w),t(3,k=A),t(1,l=Q)}function U(m){console.error("❌ [MicTest] PitchDetectorエラー:",m.detail);const{error:w,reason:A,recovery:Q}=m.detail;A==="mediastream_ended"&&Q==="restart_required"&&(console.log("🔄 [MicTest] MediaStream終了検出 - 自動復旧開始"),t(0,r="initial"),t(1,l=0),t(2,h=0),t(3,k="ーー"),console.log("⚠️ [MicTest] マイク再許可が必要です"))}async function j(){try{if(console.log("🎹 [MicTest] 基音テスト初期化開始"),typeof window<"u"){if(!window.Tone){console.log("📦 [MicTest] Tone.js動的読み込み開始");const m=document.createElement("script");m.src="https://unpkg.com/tone@latest/build/Tone.js",document.head.appendChild(m),await new Promise((w,A)=>{m.onload=w,m.onerror=A}),console.log("✅ [MicTest] Tone.js読み込み完了")}await window.Tone.start(),b=new window.Tone.Sampler({urls:{C4:"C4.mp3"},baseUrl:"https://tonejs.github.io/audio/salamander/",release:1.5,onload:()=>{console.log("✅ [MicTest] 基音サンプラー読み込み完了")},onerror:m=>{console.error("❌ [MicTest] 基音サンプラー読み込みエラー:",m)}}).toDestination(),X()}else console.warn("⚠️ [MicTest] window未定義 - 基音テスト無効")}catch(m){console.error("❌ [MicTest] 基音テスト初期化エラー:",m)}}function X(){b&&(b.volume.value=i,console.log(`🔊 [MicTest] 基音音量設定: ${i}dB`))}async function oe(){if(!(!b||D))try{t(7,D=!0),console.log("🎵 [MicTest] 基音再生開始: C4"),await xe()&&console.log("🔊 [MicTest] AudioContext再開後に基音再生実行"),await b.triggerAttackRelease("C4",2,window.Tone.now(),.7),setTimeout(()=>{t(7,D=!1),console.log("✅ [MicTest] 基音再生完了")},2e3)}catch(m){console.error("❌ [MicTest] 基音再生エラー:",m),t(7,D=!1)}}function I(){try{De.setSensitivity(o),console.log(`🎤 [MicTest] マイク感度更新完了: ${o}x`)}catch(m){console.error("❌ [MicTest] マイク感度調整エラー:",m)}}function G(m){switch(m){case"ipad-high":t(5,i=5),t(6,o=5);break;case"ipad-extreme":t(5,i=10),t(6,o=10);break;default:return}X(),I(),console.log(`🎯 [MicTest] ${m} プリセット適用: 基音${i}dB, マイク${o}x`)}async function $(){await j();try{t(6,o=De.getSensitivity()),console.log(`🎤 [MicTest] 現在のマイク感度取得: ${o}x`)}catch(m){console.warn("⚠️ [MicTest] マイク感度取得エラー:",m)}}const ce=()=>G("ipad-high"),ie=()=>G("ipad-extreme");function L(){i=Le(this.value),t(5,i)}function K(){o=Le(this.value),t(6,o)}function Y(m){Ze[m?"unshift":"push"](()=>{T=m,t(4,T)})}return[r,l,h,k,T,i,o,D,c,x,z,le,U,X,oe,I,G,ce,ie,L,K,Y]}class kt extends Re{constructor(e){super(),ze(this,e,ht,dt,Fe,{})}}export{kt as component};
