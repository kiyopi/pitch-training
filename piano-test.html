<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ”ã‚¢ãƒéŸ³ãƒ†ã‚¹ãƒˆ - ãƒã‚¤ã‚¯è¨±å¯ç¢ºèª</title>
    <script src="https://unpkg.com/tone@15.1.22/build/Tone.js"></script>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }
        h1 {
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .status {
            font-size: 1.2em;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .button {
            font-size: 1.5em;
            padding: 15px 30px;
            margin: 10px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .primary {
            background: linear-gradient(45deg, #FF6B6B, #FF8E8E);
            box-shadow: 0 4px 15px rgba(255,107,107,0.3);
        }
        .primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,107,107,0.4);
        }
        .secondary {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            box-shadow: 0 4px 15px rgba(78,205,196,0.3);
        }
        .secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(78,205,196,0.4);
        }
        .info {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }
        .log {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 0.9em;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }
        .timestamp {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.8em;
            color: #4ECDC4;
        }
    </style>
</head>
<body>
    <div class="timestamp" id="timestamp">ğŸ• --:--:--</div>
    
    <div class="container">
        <h1>ğŸ¹ ãƒ”ã‚¢ãƒéŸ³ãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="status" id="status">
            ğŸ“± ãƒã‚¤ã‚¯è¨±å¯ã¨ãƒ”ã‚¢ãƒéŸ³æºã®å‹•ä½œç¢ºèª
        </div>

        <button class="button primary" onclick="requestMicAndPlayPiano()">
            ğŸ¤ ãƒã‚¤ã‚¯è¨±å¯ & ãƒ”ã‚¢ãƒéŸ³å†ç”Ÿ
        </button>
        
        <button class="button secondary" onclick="playPianoOnly()">
            ğŸ¹ ãƒ”ã‚¢ãƒéŸ³ã®ã¿å†ç”Ÿ
        </button>

        <div class="info">
            <h3>ğŸ¯ ãƒ†ã‚¹ãƒˆå†…å®¹</h3>
            <ul>
                <li>ãƒã‚¤ã‚¯è¨±å¯ã®å–å¾—</li>
                <li>Salamander Grand PianoéŸ³æºã®èª­ã¿è¾¼ã¿</li>
                <li>åŸºéŸ³ï¼ˆBb3-Ab4ï¼‰ã®ãƒ©ãƒ³ãƒ€ãƒ å†ç”Ÿ</li>
                <li>2.5ç§’é–“ã®ãƒ”ã‚¢ãƒéŸ³å†ç”Ÿ</li>
            </ul>
        </div>

        <div class="log" id="log"></div>
    </div>

    <script>
        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ›´æ–°
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('timestamp').textContent = 
                `ğŸ• ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
        }
        setInterval(updateTimestamp, 1000);
        updateTimestamp();

        // ãƒ­ã‚°å‡ºåŠ›
        function log(message) {
            const logDiv = document.getElementById('log');
            const now = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${now}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            log(`ğŸ“Š ${message}`);
        }

        // åŸºéŸ³ãƒ‡ãƒ¼ã‚¿ï¼ˆfull-scale-training.jsã¨åŒã˜ï¼‰
        const baseTones = [
            { name: 'Bb3', note: 'ã‚·â™­3', frequency: 233.08, tonejs: 'Bb3' },
            { name: 'C4',  note: 'ãƒ‰4',   frequency: 261.63, tonejs: 'C4' },
            { name: 'Db4', note: 'ãƒ¬â™­4', frequency: 277.18, tonejs: 'Db4' },
            { name: 'D4',  note: 'ãƒ¬4',   frequency: 293.66, tonejs: 'D4' },
            { name: 'Eb4', note: 'ãƒŸâ™­4', frequency: 311.13, tonejs: 'Eb4' },
            { name: 'E4',  note: 'ãƒŸ4',   frequency: 329.63, tonejs: 'E4' },
            { name: 'F4',  note: 'ãƒ•ã‚¡4', frequency: 349.23, tonejs: 'F4' },
            { name: 'Gb4', note: 'ã‚½â™­4', frequency: 369.99, tonejs: 'Gb4' },
            { name: 'G4',  note: 'ã‚½4',   frequency: 392.00, tonejs: 'G4' },
            { name: 'Ab4', note: 'ãƒ©â™­4', frequency: 415.30, tonejs: 'Ab4' }
        ];

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let sampler = null;
        let micStream = null;

        // Salamander Grand PianoéŸ³æºåˆæœŸåŒ–
        async function initializePiano() {
            try {
                log('ğŸ¹ Salamander Grand PianoéŸ³æºåˆæœŸåŒ–é–‹å§‹...');
                
                // æœ€å°é™ã®ã‚µãƒ³ãƒ—ãƒ«æ•°ã§Samplerã‚’ä½œæˆ
                sampler = new Tone.Sampler({
                    urls: {
                        "C4": "C4.mp3",
                        "D#4": "Ds4.mp3",
                        "F#4": "Fs4.mp3",
                        "A4": "A4.mp3"
                    },
                    baseUrl: "https://tonejs.github.io/audio/salamander/",
                    volume: 6, // +6dB
                    attack: 0.01,
                    decay: 0.1,
                    sustain: 0.8,
                    release: 0.5
                }).toDestination();

                // éŸ³æºèª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
                await Tone.loaded();
                log('âœ… Salamander Grand PianoéŸ³æºåˆæœŸåŒ–å®Œäº†');
                return true;
            } catch (error) {
                log(`âŒ ãƒ”ã‚¢ãƒéŸ³æºåˆæœŸåŒ–å¤±æ•—: ${error.message}`);
                return false;
            }
        }

        // ãƒã‚¤ã‚¯è¨±å¯å–å¾—
        async function requestMicrophone() {
            try {
                log('ğŸ¤ ãƒã‚¤ã‚¯è¨±å¯è¦æ±‚é–‹å§‹...');
                updateStatus('ğŸ¤ ãƒã‚¤ã‚¯è¨±å¯ã‚’è¦æ±‚ä¸­...');
                
                micStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true 
                });
                
                log('âœ… ãƒã‚¤ã‚¯è¨±å¯å–å¾—æˆåŠŸ');
                updateStatus('âœ… ãƒã‚¤ã‚¯è¨±å¯OK');
                return true;
            } catch (error) {
                log(`âŒ ãƒã‚¤ã‚¯è¨±å¯å–å¾—å¤±æ•—: ${error.message}`);
                updateStatus('âŒ ãƒã‚¤ã‚¯è¨±å¯å¤±æ•—');
                return false;
            }
        }

        // ãƒ”ã‚¢ãƒéŸ³å†ç”Ÿ
        async function playPiano() {
            try {
                if (!sampler) {
                    throw new Error('ãƒ”ã‚¢ãƒéŸ³æºãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                // AudioContexté–‹å§‹
                if (Tone.context.state !== 'running') {
                    await Tone.start();
                    log('ğŸ”Š AudioContexté–‹å§‹');
                }

                // ãƒ©ãƒ³ãƒ€ãƒ åŸºéŸ³é¸æŠ
                const randomIndex = Math.floor(Math.random() * baseTones.length);
                const baseTone = baseTones[randomIndex];
                
                log(`ğŸµ åŸºéŸ³é¸æŠ: ${baseTone.note} (${baseTone.frequency}Hz)`);
                updateStatus(`ğŸµ ${baseTone.note} ã‚’å†ç”Ÿä¸­...`);

                // 2.5ç§’ã®ãƒ”ã‚¢ãƒéŸ³å†ç”Ÿ
                const noteString = baseTone.tonejs;
                
                // 0.0ç§’: ã‚¢ã‚¿ãƒƒã‚¯é–‹å§‹
                sampler.triggerAttack(noteString, undefined, 0.8);
                log(`ğŸ¹ ãƒ”ã‚¢ãƒéŸ³é–‹å§‹: ${noteString}`);
                
                // 2.0ç§’: ãƒªãƒªãƒ¼ã‚¹é–‹å§‹
                setTimeout(() => {
                    sampler.triggerRelease(noteString);
                    log(`ğŸ¹ ãƒ”ã‚¢ãƒéŸ³ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ: ${noteString}`);
                }, 2000);
                
                // 2.5ç§’: å®Œäº†
                setTimeout(() => {
                    log(`ğŸ¹ ãƒ”ã‚¢ãƒéŸ³å†ç”Ÿå®Œäº†: ${noteString}`);
                    updateStatus('âœ… ãƒ”ã‚¢ãƒéŸ³å†ç”Ÿå®Œäº†');
                }, 2500);

                return true;
            } catch (error) {
                log(`âŒ ãƒ”ã‚¢ãƒéŸ³å†ç”Ÿå¤±æ•—: ${error.message}`);
                updateStatus('âŒ ãƒ”ã‚¢ãƒéŸ³å†ç”Ÿå¤±æ•—');
                return false;
            }
        }

        // ãƒã‚¤ã‚¯è¨±å¯ & ãƒ”ã‚¢ãƒéŸ³å†ç”Ÿ
        async function requestMicAndPlayPiano() {
            log('ğŸš€ ãƒã‚¤ã‚¯è¨±å¯ & ãƒ”ã‚¢ãƒéŸ³ãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            // 1. ãƒã‚¤ã‚¯è¨±å¯
            const micOk = await requestMicrophone();
            if (!micOk) return;
            
            // 2. ãƒ”ã‚¢ãƒéŸ³æºåˆæœŸåŒ–
            const pianoOk = await initializePiano();
            if (!pianoOk) return;
            
            // 3. ãƒ”ã‚¢ãƒéŸ³å†ç”Ÿ
            await playPiano();
        }

        // ãƒ”ã‚¢ãƒéŸ³ã®ã¿å†ç”Ÿ
        async function playPianoOnly() {
            log('ğŸ¹ ãƒ”ã‚¢ãƒéŸ³ã®ã¿ãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            // 1. ãƒ”ã‚¢ãƒéŸ³æºåˆæœŸåŒ–
            const pianoOk = await initializePiano();
            if (!pianoOk) return;
            
            // 2. ãƒ”ã‚¢ãƒéŸ³å†ç”Ÿ
            await playPiano();
        }

        // åˆæœŸåŒ–
        window.addEventListener('load', () => {
            log('ğŸ¯ ãƒ”ã‚¢ãƒéŸ³ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            updateStatus('ğŸ“± ãƒã‚¤ã‚¯è¨±å¯ã¨ãƒ”ã‚¢ãƒéŸ³æºã®å‹•ä½œç¢ºèª');
        });
    </script>
</body>
</html>