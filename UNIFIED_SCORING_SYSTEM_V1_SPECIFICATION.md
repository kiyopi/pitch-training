# UNIFIED_SCORING_SYSTEM_V1_SPECIFICATION.md
# 統合採点システム v1.0 仕様書

**作成日**: 2025-07-29  
**ステータス**: 実装済み（修正が必要）  
**対象ブランチ**: random-training-tonejs-fixed-001  

## 📋 概要

相対音感トレーニングアプリの3モード（ランダム、連続、12音階）共通の統合採点システムv1.0の仕様書。

## 🎯 目的

- 3モード統一の採点結果表示
- セッション履歴の可視化
- SNS共有機能の提供
- 完走時の達成感向上

## 📊 評価システム仕様

### **⚠️ 重要な問題発見**
**実装中に評価システムの不整合が発覚：**

#### **既存の正しいシステム（RandomModeScoreResult）**
```
🏆 優秀: ±15¢以内 (黄色/金色)
⭐ 良好: ±25¢以内 (緑色)
👍 合格: ±40¢以内 (青色)
😞 要練習: ±41¢以上 (赤色)
🚫 測定不可: 音声未検出 (灰色)
```

#### **間違って実装したシステム（UnifiedScoreResult）**
```
S級マスター, A級エキスパート, B級プロフィシエント,
C級アドバンス, D級ビギナー, E級スターター
```

## 🔧 実装されたコンポーネント

### **1. UnifiedScoreResult.svelte**
- **ファイルパス**: `/src/lib/components/scoring/UnifiedScoreResult.svelte`
- **サイズ**: 540行
- **機能**: 
  - 総合評価表示（❌ 間違ったS-E級システム）
  - セッション履歴バー表示
  - モード別サマリー表示
  - SNS共有ボタン統合

### **2. SNSShareButtons.svelte**
- **ファイルパス**: `/src/lib/components/scoring/SNSShareButtons.svelte`  
- **サイズ**: 264行
- **機能**:
  - Canvas画像生成
  - Twitter共有
  - ネイティブ共有API
  - 画像ダウンロード
  - URLコピー

## 🎨 セッション履歴バー仕様

### **正しい設計（目標）**
```
┌─────────┐
│    1    │ ← セッション番号
│  🏆優秀  │ ← 1セッション（8音練習）の総合評価
│   C4    │ ← 基音
└─────────┘
```

### **現在の間違った実装**
```
┌─────────┐
│    1    │ ← セッション番号  
│    A    │ ← A級エキスパート（間違ったシステム）
│   C4    │ ← 基音
└─────────┘
```

## 📱 モード別仕様

### **ランダムモード**
- **セッション数**: 8セッション固定
- **各セッション**: 異なる基音でドレミファソラシド（8音）を練習
- **表示内容**: セッション番号、総合評価、基音

### **連続モード**  
- **セッション数**: 8セッション固定
- **各セッション**: 異なる基音でドレミファソラシド（8音）を練習
- **表示内容**: セッション番号、総合評価、基音

### **12音階モード**
- **セッション数**: 12セッション固定
- **各セッション**: 各半音階での練習
- **表示内容**: セッション番号、総合評価、対象半音階
- **レイアウト**: 6×2グリッド表示（モバイルは4×3）

## 🎊 SNS共有機能仕様

### **解禁条件**
- **ランダム/連続**: 8セッション完走時
- **12音階**: 12セッション完走時

### **共有画像仕様** 
- **サイズ**: 800×600px
- **内容**: 
  - タイトル「🎵 相対音感トレーニング結果」
  - グレード表示（大きく）
  - モード名
  - 統計情報（精度、測定率、完走セッション数）
  - セッション履歴バー（視覚的）
  - URL（フッター）

### **共有ボタン**
- ネイティブ共有/Twitter
- 画像ダウンロード  
- URLコピー

## 🧪 テスト実装

### **テストデータ生成関数**
```javascript
function generateTestUnifiedScoreData() {
  return {
    mode: 'random',
    sessionHistory: [
      { grade: 'A', accuracy: 87, baseNote: 'C4' },
      // ... 8セッション分
    ]
  };
}
```

### **デバッグ表示**
- **場所**: ランダムモードページのデバッグセクション
- **ボタン**: 「🚀 v1.0統合採点結果」
- **表示**: テストデータでの結果表示

## ❌ 発見された問題

### **1. 評価システム不整合**
- **問題**: S-E級システム vs 4段階評価システム
- **影響**: ユーザー混乱、既存実装との矛盾
- **対応**: UnifiedScoreResultを4段階評価に修正必要

### **2. セッション評価の意味**
- **問題**: 1セッションでのグレード判定基準が不明確
- **正解**: 1セッション = 8音練習の総合評価（🏆優秀など）

## 🔄 必要な修正作業

### **緊急修正項目**
1. **UnifiedScoreResult評価システム修正**
   - S-E級 → 4段階評価（優秀/良好/合格/要練習）
   - セッションバー表示修正
   - 色システム統一

2. **評価ロジック統一**
   - RandomModeScoreResultの評価ロジックを流用
   - グレード計算関数の修正

3. **テストデータ修正**
   - grade: 'A' → grade: 'excellent'
   - 正しい評価システムでのテストデータ生成

## 📁 関連ファイル

### **実装済みファイル**
- `/src/lib/components/scoring/UnifiedScoreResult.svelte` (修正必要)
- `/src/lib/components/scoring/SNSShareButtons.svelte` (完成)
- `/src/routes/training/random/+page.svelte` (テスト実装済み)

### **参考ファイル**
- `/src/lib/components/scoring/RandomModeScoreResult.svelte` (正しい実装)

## 🚀 デプロイ状況

- **コミット**: 15b394f
- **ブランチ**: random-training-tonejs-fixed-001
- **ビルド**: ✅ 成功
- **GitHub Pages**: 更新済み

## 📝 学習事項

### **重要な教訓**
1. **既存実装の確認必須**: 新しいシステム実装前に既存の評価システムを必ず確認
2. **仕様統一の重要性**: 同一アプリ内での評価システム統一は必須
3. **段階的実装**: 大きな変更時は既存システムとの整合性を段階的に確認

### **今後の注意点**
- 新機能実装時は既存コンポーネントとの整合性を最優先で確認
- 評価システムのような核となる部分は慎重に設計
- テストデータも正しいシステムに合わせて作成

---

**次回作業**: UnifiedScoreResultの評価システムを4段階評価に修正し、RandomModeScoreResultとの統一を図る。