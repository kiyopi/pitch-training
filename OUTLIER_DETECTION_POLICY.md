# 外れ値検出システム運用方針

**作成日**: 2025-08-02  
**最終更新**: 2025-08-02  
**ステータス**: 一時停止中（技術的ブレ検証待ち）

## 📋 外れ値検出システム概要

### 🎯 **目的**
相対音感トレーニングにおいて、真の音程能力を正確に測定するため、技術的誤差と実際の音程外れを区別する高精度な評価システムを提供する。

### 🔬 **技術的背景**
- **相対音感の特性**: 音程の相対的関係を正確に捉える能力
- **外れ値の意味**: 明らかに意図した音程から大きく外れた発声（±50¢以上）
- **技術的制約**: Web Audio API の精度限界（±15-50¢の技術的ブレ）

## 🚨 **現在の状況: 一時停止**

### **停止理由**
1. **技術的ブレの予想以上の影響**
   - Web Audio API での ±15-30¢（通常）〜 ±50¢（最悪時）の技術的変動
   - 実際の発声テストで技術的制約による誤検出を確認
   - 真の音程能力と技術的誤差の区別が困難

2. **公正性への懸念**
   - ユーザーの実際の音程能力ではなく技術的制約による減点
   - 継続的なトレーニングモチベーションへの悪影響
   - 正確でない評価による学習効果の阻害

### **停止実装詳細 (コミット: 8292de7)**
```javascript
// RandomModeScoreResult.svelte での変更

// 外れ値ペナルティ表示 (Line 148-154) - コメントアウト
<!--
{#if outlierPenalty > 0}
  <div class="outlier-penalty">
    外れ値ペナルティ: -{outlierPenalty}点
  </div>
{/if}
-->

// 外れ値検出セクション (Line 278-298) - コメントアウト
<!-- 外れ値検出セクション一時非表示
{#if outlierNotes.length > 0}
  ...外れ値表示ロジック...
{/if}
-->

// スコア計算からペナルティ除外 (Line 113)
displayScore.set(baseScore); // - penalty 削除
```

## 🔄 **再実装に向けた技術的要件**

### **Phase 1: 技術的ブレの定量化**
#### **調査項目**
1. **環境別精度測定**
   - iPhone Safari、Android Chrome、PC各ブラウザでの精度差
   - マイクデバイス種類による影響度測定
   - ネットワーク遅延・CPU負荷による影響度

2. **統計的データ収集**
   - 同一音程での複数回測定による技術的ブレ範囲の特定
   - 音程別（ド〜シ）での技術的誤差の傾向分析
   - 時間経過による精度変動の測定

#### **目標精度基準**
- **技術的ブレ**: ±15¢以内に収束（理想）
- **許容範囲**: ±25¢以内での安定動作
- **外れ値閾値**: 技術的ブレ + 安全マージン（±75¢以上を真の外れ値と判定）

### **Phase 2: 統計的手法による外れ値検出**
#### **アルゴリズム設計**
1. **移動平均による基準値算出**
   - 直近3〜5音程の平均誤差を基準として使用
   - 個人の発声傾向を考慮した動的閾値設定

2. **信頼区間による異常検知**
   - 95%信頼区間を超える値を外れ値候補として抽出
   - 連続する外れ値の検出による偶発的誤差の除外

3. **適応的閾値システム**
   - ユーザーの音程精度レベルに応じた動的閾値調整
   - 初心者には寛容、上級者には厳格な基準を適用

### **Phase 3: 堅牢な評価システム構築**
#### **実装要件**
1. **技術的ブレ耐性**
   - 技術的誤差を考慮した評価アルゴリズム
   - 複数回測定による信頼性向上

2. **透明性のある評価基準**
   - 外れ値判定理由の明確な表示
   - 技術的制約と実際の音程能力の区別表示

3. **学習促進型フィードバック**
   - 建設的な改善提案を含む評価表示
   - 技術的問題による減点を排除した純粋な音程評価

## 📊 **代替評価手法（現在実装中）**

### **基本スコアのみの評価**
- **計算方法**: 正確度による基本点数のみ（ペナルティなし）
- **評価基準**: 
  - 優秀: ±15¢以内
  - 良好: ±25¢以内
  - 合格: ±40¢以内
  - 要練習: ±41¢以上

### **技術的ブレを考慮した評価表示**
```
表示例:
ド（262Hz）あなた: 275Hz (+13Hz) +81¢ → 合格
※技術的な測定誤差（±15-30¢程度）を考慮した評価です
```

## 🎯 **今後の開発ロードマップ**

### **短期目標（1-2週間）**
- [ ] 外れ値機能なしでの安定運用
- [ ] ユーザーフィードバックの収集
- [ ] 現在の評価システムの精度検証

### **中期目標（1-2ヶ月）**
- [ ] 技術的ブレの体系的調査実施
- [ ] 複数環境での精度データ収集
- [ ] 統計的外れ値検出アルゴリズムの設計

### **長期目標（3-6ヶ月）**
- [ ] 堅牢な外れ値検出システムの実装
- [ ] 技術的ブレ耐性を持つ評価システム構築
- [ ] 学術的価値のある音程測定精度の実現

## 🔬 **検証プロトコル**

### **技術的ブレ測定実験**
1. **同一音程での連続測定**（各音程30回以上）
2. **環境変更による精度比較**（デバイス、ブラウザ、時間帯）
3. **基準音源との比較測定**（楽器音での精度確認）

### **外れ値検出精度実験**
1. **意図的な外れ値生成**（±50¢、±75¢、±100¢のテストケース）
2. **技術的ブレとの区別精度測定**
3. **False Positive/Negative率の算出**

## 📚 **関連ドキュメント**

- `WORK_LOG_UPDATE.md`: 実装変更の詳細記録
- `PITCHY_SPECS.md`: 音程検出技術仕様
- `RANDOM_TRAINING_UNIFIED_SPECIFICATION.md`: 統合評価システム仕様
- `TRAINING_MODES_COMMON_SPECIFICATION.md`: 評価基準共通仕様

## 💡 **設計哲学**

### **公正性優先の原則**
技術的制約によるユーザー体験の悪化を避け、純粋な相対音感能力の向上に集中できる評価環境を提供する。

### **透明性の原則**
評価基準と技術的制約を明確に分離し、ユーザーが自身の実際の能力を正確に把握できる情報を提供する。

### **学習促進の原則**
減点主義ではなく、建設的なフィードバックによる継続的な学習モチベーションの維持を最優先とする。

---

**このドキュメントは外れ値検出システムの再実装時に重要な指針となります。**