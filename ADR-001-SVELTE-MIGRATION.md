# ADR-001: Next.jsからSvelteへの移行

**日付**: 2025-01-25  
**ステータス**: 提案中  
**決定者**: Claude + ユーザー  
**関連文書**: SVELTE_MIGRATION_CHARTER.md, SVELTE_MIGRATION_PLAN.md

## 📝 概要
相対音感トレーニングアプリのフレームワークをNext.js/ReactからSvelte/SvelteKitへ移行する技術決定。

## 🎯 コンテキスト

### **現在の状況**
- **フレームワーク**: Next.js 15.4.1 + React + TypeScript
- **音響処理**: Web Audio API + Pitchy + Tone.js
- **デプロイ**: GitHub Pages + GitHub Actions
- **スタイリング**: インラインスタイル（shadcn/ui失敗後）

### **発生している問題**
1. **パフォーマンス問題**
   - 音量バー更新時のフレームドロップ（~30fps）
   - Virtual DOMによる音響処理への影響
   - リアルタイム更新での遅延

2. **スタイリング問題**
   - shadcn/uiがプロダクション環境で動作しない
   - CSS変数システムの不安定性
   - 全ページでインラインスタイル化を強いられた

3. **開発複雑性**
   - ReactとDOM直接操作の競合
   - 各ページで異なる実装パターン
   - メンテナンス性の著しい低下

4. **アーキテクチャ矛盾**
   - Reactの設計思想と音響処理の要求の不整合
   - コンポーネント志向と命令的DOM操作の衝突

## 🚀 決定内容
**Next.js/ReactからSvelte/SvelteKitへの完全移行を実施する**

## 🎯 理由

### **Svelteの技術的優位性**

#### **1. コンパイル時最適化**
- **Virtual DOMなし**: ランタイムオーバーヘッドの完全排除
- **バンドルサイズ**: 50%以上の削減期待（200KB → <100KB）
- **パフォーマンス**: 音響処理に最適な軽量ランタイム

#### **2. DOM操作の自然性**
```svelte
<!-- Svelte: 自然なDOM操作 -->
<div bind:this={volumeBar} />
<script>
  $: if (volumeBar) {
    volumeBar.style.width = `${volume}%`; // 直接的で明快
  }
</script>
```

```jsx
<!-- React: 複雑で間接的 -->
const volumeRef = useRef(null);
useEffect(() => {
  if (volumeRef.current) {
    volumeRef.current.style.width = `${volume}%`; // 間接的で複雑
  }
}, [volume]);
```

#### **3. スタイリングの確実性**
```svelte
<!-- スコープドスタイル（確実に動作） -->
<style>
  .volume-bar {
    background: #059669;
  }
</style>
```

#### **4. 開発体験の向上**
- **リアクティビティ**: `let count = 0; count++` の自然さ
- **テンプレート**: より直感的なHTML拡張
- **学習曲線**: Reactより緩やか

### **音響アプリケーションとの親和性**

#### **Web Audio APIとの統合**
```svelte
<script>
  import { onMount } from 'svelte';
  
  onMount(() => {
    const audioContext = new AudioContext();
    const analyser = audioContext.createAnalyser();
    // 直接的で自然な統合
  });
</script>
```

#### **高頻度更新の最適化**
- Virtual DOMによる遅延なし
- 音量バー等のリアルタイム更新が滑らか
- 60fps維持が容易

## 📊 期待される成果

### **定量的改善**
| 項目 | 現在 | 目標 | 改善率 |
|------|------|------|--------|
| バンドルサイズ | ~200KB | <100KB | 50%以上 |
| 音量バー更新 | ~30fps | 60fps | 2倍 |
| 初回読み込み | ~2s | <1s | 50%以上 |
| メモリ使用量 | ~15MB | <10MB | 33%以上 |

### **定性的改善**
- **統一性**: 全ページで一貫した実装パターン
- **保守性**: よりシンプルで理解しやすいコード
- **安定性**: 確実に動作するスタイリングシステム
- **開発速度**: より高速で直感的な開発体験

## ⚠️ 考慮すべきリスク

### **技術的リスク**
1. **エコシステム**: Reactよりもライブラリやツールが少ない
2. **学習コスト**: 新しいフレームワークへの適応時間
3. **移行期間**: 一時的な開発停止

### **リスク軽減策**
1. **段階的移行**: プロトタイプでの十分な検証
2. **明確な判断基準**: GO/NO-GO判断の定量的基準設定
3. **ロールバック計画**: 問題発生時の即座の復帰手順

## 🚦 判断基準

### **GO条件（すべて満たす必要）**
- [ ] 音量バー更新が60fps維持
- [ ] バンドルサイズ50%以上削減
- [ ] 開発体験の向上を実感
- [ ] スタイリング問題の完全解決

### **NO-GO条件（1つでも該当したら中止）**
- [ ] パフォーマンスがNext.js版を下回る
- [ ] 必要な機能が実装困難
- [ ] 開発の複雑性が増加

## 📅 実装計画

### **Phase 1: プロトタイプ検証（2025-01-25 〜 2025-02-01）**
1. Svelteプロジェクト初期化
2. マイクテストページの移植
3. パフォーマンス測定・比較

### **Phase 2: GO/NO-GO判断（2025-02-01 〜 2025-02-03）**
1. 判断基準との照合
2. 移行決定 or 中止決定

### **Phase 3: 本格移行（GO判断の場合のみ）**
1. 全ページの段階的移行
2. デザインシステムの確立
3. テスト・最適化

## 🔄 代替案

### **代替案1: Next.js継続 + 改善**
- **メリット**: フレームワーク変更なし
- **デメリット**: 根本的問題の未解決
- **判断**: 根本解決にならないため不採用

### **代替案2: Vue.js移行**
- **メリット**: テンプレート志向、DOM操作が容易
- **デメリット**: Svelteほどの軽量性なし
- **判断**: Svelteがより適切と判断

## 📋 成功の指標

### **技術的成功**
- すべての定量的基準をクリア
- 安定した動作の確認
- コード品質の向上

### **ビジネス的成功**
- ユーザー体験の向上
- 開発効率の改善
- 長期的な保守性確保

## 🔗 関連決定

この決定により、以下の関連決定も必要：
- ADR-002: デザインシステムの確立
- ブランチ戦略の見直し
- CI/CDパイプラインの更新

---

**この決定は、アプリケーションの長期的な成功と持続可能性を確保するための重要な技術選択です。**