# ランダムトレーニングページ レイアウト仕様書

## 📋 概要

ランダム基音トレーニングページの完全なレイアウト仕様とマイク許可フロー対応設計。

**作成日**: 2025-01-24  
**対象ファイル**: `/src/app/training/random/page.tsx`  
**設計方針**: 縦積みシンプル設計 + マイク状態別レンダリング

---

## 🎤 マイク許可フロー設計

### **基本フロー**
```
ホームページ → マイクテストページ → ランダムトレーニングページ
     ↓              ↓                    ↓
   選択モード      マイク許可取得        許可済み前提
```

### **想定される3つのアクセスパターン**

1. **正常フロー**: マイクテストページ経由（マイク許可済み）
2. **直接アクセス**: URL直接入力・ブックマーク（マイク未許可）
3. **エラー状態**: 許可失効・デバイス問題（マイク利用不可）

---

## 🎨 レイアウト設計

### **パターン 1: マイク許可済み（通常フロー）**

```
┌─────────────────────────────────────┐
│ 🎤 マイク準備完了                    │ ← 簡潔な状態表示
├─────────────────────────────────────┤
│     [ランダム基音再生ボタン]          │
│     基音: ミ4 (329.6Hz)             │ ← 再生後に表示
├─────────────────────────────────────┤
│ 🎵 ドレミファソラシド ガイド           │
│ [ド][レ][ミ][ファ][ソ][ラ][シ][ド]    │ ← ハイライトアニメーション
├─────────────────────────────────────┤
│ 🎵 現在: ド (+0) ✅ 誤差: 12セント    │ ← リアルタイム相対音程表示
├─────────────────────────────────────┤
│ 🎉 オクターブ完了！結果               │ ← 完了時のみ表示
│ 正解率: 7/8 (87.5%)                │
│ 平均誤差: 15セント                   │
└─────────────────────────────────────┘
```

### **パターン 2: マイク未許可（直接アクセス）**

```
┌─────────────────────────────────────┐
│ ⚠️ マイクアクセスが必要です            │
├─────────────────────────────────────┤
│ このトレーニングには音声入力が必要です  │
│                                     │
│ 推奨: マイクテストページで音声確認後   │
│       ご利用ください                  │
│                                     │
│ [マイクテストページに移動]             │ ← 推奨ルート
│ [直接マイク許可を取得]                │ ← 上級者向け
└─────────────────────────────────────┘
```

### **パターン 3: マイクエラー（許可失効等）**

```
┌─────────────────────────────────────┐
│ 🔇 マイクアクセスに問題があります       │
├─────────────────────────────────────┤
│ 考えられる原因:                      │
│ • マイク許可が取り消された            │
│ • マイクデバイスが利用できない         │
│ • ブラウザの設定変更                  │
│                                     │
│ [マイクテストページで確認]             │ ← 診断ページ
│ [再度マイク許可を取得]                │ ← 再試行
│ [トラブルシューティング]              │ ← ヘルプページ
└─────────────────────────────────────┘
```

---

## 🔧 技術実装仕様

### **状態管理**

```typescript
// マイク状態管理
type MicrophoneState = 'granted' | 'denied' | 'prompt' | 'error' | 'checking';

const [micState, setMicState] = useState<MicrophoneState>('checking');
const [micError, setMicError] = useState<string | null>(null);
```

### **初期化フロー**

```typescript
useEffect(() => {
  checkMicrophonePermission()
    .then(state => setMicState(state))
    .catch(error => {
      setMicState('error');
      setMicError(error.message);
    });
}, []);
```

### **レンダリング分岐**

```typescript
const renderContent = () => {
  switch (micState) {
    case 'granted':
      return <TrainingInterface />;
    case 'denied':
    case 'prompt':
      return <MicrophonePermissionRequired />;
    case 'error':
      return <MicrophoneErrorRecovery error={micError} />;
    case 'checking':
      return <LoadingState />;
    default:
      return <UnknownState />;
  }
};
```

---

## 🎯 コンポーネント構成

### **メンコンポーネント: RandomTrainingPage**
- マイク状態検出
- 状態別レンダリング制御
- エラーハンドリング

### **子コンポーネント**

1. **TrainingInterface** (メイン機能)
   - BaseTonePlayer (基音再生)
   - ScaleGuide (ドレミファソラシドガイド)
   - PitchDetector (音程検出)
   - ResultsDisplay (結果表示)

2. **MicrophonePermissionRequired** (許可要求)
   - 状況説明
   - 導線ボタン群
   - フォールバック選択肢

3. **MicrophoneErrorRecovery** (エラー回復)
   - エラー内容表示
   - 回復手段提示
   - 代替案提示

4. **LoadingState** (ローディング)
   - チェック中表示
   - プログレス表示

---

## 📱 レスポンシブ対応

### **PC表示**
- 最大幅: 800px
- 中央寄せレイアウト
- 余白確保

### **iPhone表示**
- 全幅利用
- 縦スクロール最適化
- タッチ操作考慮

### **共通ルール**
- 最小タップサイズ: 44px
- 読みやすいフォントサイズ
- 十分なコントラスト

---

## 🎵 音響処理連携

### **統一音響処理モジュール使用**
- UnifiedAudioProcessor クラス
- 既存の高精度音程検出
- 3段階ノイズフィルタリング

### **DOM直接操作**
- React Error #418回避
- スムーズアニメーション
- パフォーマンス最適化

---

## 🚀 実装手順

### **Phase 1: 基盤構築**
1. マイク状態検出システム
2. 状態別レンダリング実装
3. 基本レイアウト構築

### **Phase 2: 機能実装**
1. 基音再生システム
2. ガイドアニメーション
3. 音程検出連携

### **Phase 3: 統合・最適化**
1. エラーハンドリング
2. パフォーマンス調整
3. レスポンシブ調整

---

## ✅ 品質基準

- ✅ iPhone Safari完全対応
- ✅ React Error完全排除
- ✅ マイク許可フロー完全対応
- ✅ 音響処理高精度維持
- ✅ ユーザビリティ最優先

---

**この仕様書に基づき、シンプルで堅牢なランダムトレーニングページを再実装します。**